<!DOCTYPE html>

<html lang="en">
<head><meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>spiral_compiler.dib</title><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.1.10/require.min.js"></script>
<style type="text/css">
    pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.highlight .hll { background-color: var(--jp-cell-editor-active-background) }
.highlight { background: var(--jp-cell-editor-background); color: var(--jp-mirror-editor-variable-color) }
.highlight .c { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment */
.highlight .err { color: var(--jp-mirror-editor-error-color) } /* Error */
.highlight .k { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword */
.highlight .o { color: var(--jp-mirror-editor-operator-color); font-weight: bold } /* Operator */
.highlight .p { color: var(--jp-mirror-editor-punctuation-color) } /* Punctuation */
.highlight .ch { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Hashbang */
.highlight .cm { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Multiline */
.highlight .cp { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Preproc */
.highlight .cpf { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.PreprocFile */
.highlight .c1 { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Single */
.highlight .cs { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Special */
.highlight .kc { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Pseudo */
.highlight .kr { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Type */
.highlight .m { color: var(--jp-mirror-editor-number-color) } /* Literal.Number */
.highlight .s { color: var(--jp-mirror-editor-string-color) } /* Literal.String */
.highlight .ow { color: var(--jp-mirror-editor-operator-color); font-weight: bold } /* Operator.Word */
.highlight .pm { color: var(--jp-mirror-editor-punctuation-color) } /* Punctuation.Marker */
.highlight .w { color: var(--jp-mirror-editor-variable-color) } /* Text.Whitespace */
.highlight .mb { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Bin */
.highlight .mf { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Float */
.highlight .mh { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Hex */
.highlight .mi { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Integer */
.highlight .mo { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Oct */
.highlight .sa { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Affix */
.highlight .sb { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Backtick */
.highlight .sc { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Char */
.highlight .dl { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Delimiter */
.highlight .sd { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Doc */
.highlight .s2 { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Double */
.highlight .se { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Escape */
.highlight .sh { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Heredoc */
.highlight .si { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Interpol */
.highlight .sx { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Other */
.highlight .sr { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Regex */
.highlight .s1 { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Single */
.highlight .ss { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Symbol */
.highlight .il { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Integer.Long */
  </style>
<style type="text/css">
/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*
 * Mozilla scrollbar styling
 */

/* use standard opaque scrollbars for most nodes */
[data-jp-theme-scrollbars='true'] {
  scrollbar-color: rgb(var(--jp-scrollbar-thumb-color))
    var(--jp-scrollbar-background-color);
}

/* for code nodes, use a transparent style of scrollbar. These selectors
 * will match lower in the tree, and so will override the above */
[data-jp-theme-scrollbars='true'] .CodeMirror-hscrollbar,
[data-jp-theme-scrollbars='true'] .CodeMirror-vscrollbar {
  scrollbar-color: rgba(var(--jp-scrollbar-thumb-color), 0.5) transparent;
}

/* tiny scrollbar */

.jp-scrollbar-tiny {
  scrollbar-color: rgba(var(--jp-scrollbar-thumb-color), 0.5) transparent;
  scrollbar-width: thin;
}

/* tiny scrollbar */

.jp-scrollbar-tiny::-webkit-scrollbar,
.jp-scrollbar-tiny::-webkit-scrollbar-corner {
  background-color: transparent;
  height: 4px;
  width: 4px;
}

.jp-scrollbar-tiny::-webkit-scrollbar-thumb {
  background: rgba(var(--jp-scrollbar-thumb-color), 0.5);
}

.jp-scrollbar-tiny::-webkit-scrollbar-track:horizontal {
  border-left: 0 solid transparent;
  border-right: 0 solid transparent;
}

.jp-scrollbar-tiny::-webkit-scrollbar-track:vertical {
  border-top: 0 solid transparent;
  border-bottom: 0 solid transparent;
}

/*
 * Lumino
 */

.lm-ScrollBar[data-orientation='horizontal'] {
  min-height: 16px;
  max-height: 16px;
  min-width: 45px;
  border-top: 1px solid #a0a0a0;
}

.lm-ScrollBar[data-orientation='vertical'] {
  min-width: 16px;
  max-width: 16px;
  min-height: 45px;
  border-left: 1px solid #a0a0a0;
}

.lm-ScrollBar-button {
  background-color: #f0f0f0;
  background-position: center center;
  min-height: 15px;
  max-height: 15px;
  min-width: 15px;
  max-width: 15px;
}

.lm-ScrollBar-button:hover {
  background-color: #dadada;
}

.lm-ScrollBar-button.lm-mod-active {
  background-color: #cdcdcd;
}

.lm-ScrollBar-track {
  background: #f0f0f0;
}

.lm-ScrollBar-thumb {
  background: #cdcdcd;
}

.lm-ScrollBar-thumb:hover {
  background: #bababa;
}

.lm-ScrollBar-thumb.lm-mod-active {
  background: #a0a0a0;
}

.lm-ScrollBar[data-orientation='horizontal'] .lm-ScrollBar-thumb {
  height: 100%;
  min-width: 15px;
  border-left: 1px solid #a0a0a0;
  border-right: 1px solid #a0a0a0;
}

.lm-ScrollBar[data-orientation='vertical'] .lm-ScrollBar-thumb {
  width: 100%;
  min-height: 15px;
  border-top: 1px solid #a0a0a0;
  border-bottom: 1px solid #a0a0a0;
}

.lm-ScrollBar[data-orientation='horizontal']
  .lm-ScrollBar-button[data-action='decrement'] {
  background-image: var(--jp-icon-caret-left);
  background-size: 17px;
}

.lm-ScrollBar[data-orientation='horizontal']
  .lm-ScrollBar-button[data-action='increment'] {
  background-image: var(--jp-icon-caret-right);
  background-size: 17px;
}

.lm-ScrollBar[data-orientation='vertical']
  .lm-ScrollBar-button[data-action='decrement'] {
  background-image: var(--jp-icon-caret-up);
  background-size: 17px;
}

.lm-ScrollBar[data-orientation='vertical']
  .lm-ScrollBar-button[data-action='increment'] {
  background-image: var(--jp-icon-caret-down);
  background-size: 17px;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Copyright (c) 2014-2017, PhosphorJS Contributors
|
| Distributed under the terms of the BSD 3-Clause License.
|
| The full license is in the file LICENSE, distributed with this software.
|----------------------------------------------------------------------------*/

.lm-Widget {
  box-sizing: border-box;
  position: relative;
  overflow: hidden;
}

.lm-Widget.lm-mod-hidden {
  display: none !important;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

.lm-AccordionPanel[data-orientation='horizontal'] > .lm-AccordionPanel-title {
  /* Title is rotated for horizontal accordion panel using CSS */
  display: block;
  transform-origin: top left;
  transform: rotate(-90deg) translate(-100%);
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Copyright (c) 2014-2017, PhosphorJS Contributors
|
| Distributed under the terms of the BSD 3-Clause License.
|
| The full license is in the file LICENSE, distributed with this software.
|----------------------------------------------------------------------------*/

.lm-CommandPalette {
  display: flex;
  flex-direction: column;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.lm-CommandPalette-search {
  flex: 0 0 auto;
}

.lm-CommandPalette-content {
  flex: 1 1 auto;
  margin: 0;
  padding: 0;
  min-height: 0;
  overflow: auto;
  list-style-type: none;
}

.lm-CommandPalette-header {
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}

.lm-CommandPalette-item {
  display: flex;
  flex-direction: row;
}

.lm-CommandPalette-itemIcon {
  flex: 0 0 auto;
}

.lm-CommandPalette-itemContent {
  flex: 1 1 auto;
  overflow: hidden;
}

.lm-CommandPalette-itemShortcut {
  flex: 0 0 auto;
}

.lm-CommandPalette-itemLabel {
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}

.lm-close-icon {
  border: 1px solid transparent;
  background-color: transparent;
  position: absolute;
  z-index: 1;
  right: 3%;
  top: 0;
  bottom: 0;
  margin: auto;
  padding: 7px 0;
  display: none;
  vertical-align: middle;
  outline: 0;
  cursor: pointer;
}
.lm-close-icon:after {
  content: 'X';
  display: block;
  width: 15px;
  height: 15px;
  text-align: center;
  color: #000;
  font-weight: normal;
  font-size: 12px;
  cursor: pointer;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Copyright (c) 2014-2017, PhosphorJS Contributors
|
| Distributed under the terms of the BSD 3-Clause License.
|
| The full license is in the file LICENSE, distributed with this software.
|----------------------------------------------------------------------------*/

.lm-DockPanel {
  z-index: 0;
}

.lm-DockPanel-widget {
  z-index: 0;
}

.lm-DockPanel-tabBar {
  z-index: 1;
}

.lm-DockPanel-handle {
  z-index: 2;
}

.lm-DockPanel-handle.lm-mod-hidden {
  display: none !important;
}

.lm-DockPanel-handle:after {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  content: '';
}

.lm-DockPanel-handle[data-orientation='horizontal'] {
  cursor: ew-resize;
}

.lm-DockPanel-handle[data-orientation='vertical'] {
  cursor: ns-resize;
}

.lm-DockPanel-handle[data-orientation='horizontal']:after {
  left: 50%;
  min-width: 8px;
  transform: translateX(-50%);
}

.lm-DockPanel-handle[data-orientation='vertical']:after {
  top: 50%;
  min-height: 8px;
  transform: translateY(-50%);
}

.lm-DockPanel-overlay {
  z-index: 3;
  box-sizing: border-box;
  pointer-events: none;
}

.lm-DockPanel-overlay.lm-mod-hidden {
  display: none !important;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Copyright (c) 2014-2017, PhosphorJS Contributors
|
| Distributed under the terms of the BSD 3-Clause License.
|
| The full license is in the file LICENSE, distributed with this software.
|----------------------------------------------------------------------------*/

.lm-Menu {
  z-index: 10000;
  position: absolute;
  white-space: nowrap;
  overflow-x: hidden;
  overflow-y: auto;
  outline: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.lm-Menu-content {
  margin: 0;
  padding: 0;
  display: table;
  list-style-type: none;
}

.lm-Menu-item {
  display: table-row;
}

.lm-Menu-item.lm-mod-hidden,
.lm-Menu-item.lm-mod-collapsed {
  display: none !important;
}

.lm-Menu-itemIcon,
.lm-Menu-itemSubmenuIcon {
  display: table-cell;
  text-align: center;
}

.lm-Menu-itemLabel {
  display: table-cell;
  text-align: left;
}

.lm-Menu-itemShortcut {
  display: table-cell;
  text-align: right;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Copyright (c) 2014-2017, PhosphorJS Contributors
|
| Distributed under the terms of the BSD 3-Clause License.
|
| The full license is in the file LICENSE, distributed with this software.
|----------------------------------------------------------------------------*/

.lm-MenuBar {
  outline: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.lm-MenuBar-content {
  margin: 0;
  padding: 0;
  display: flex;
  flex-direction: row;
  list-style-type: none;
}

.lm-MenuBar-item {
  box-sizing: border-box;
}

.lm-MenuBar-itemIcon,
.lm-MenuBar-itemLabel {
  display: inline-block;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Copyright (c) 2014-2017, PhosphorJS Contributors
|
| Distributed under the terms of the BSD 3-Clause License.
|
| The full license is in the file LICENSE, distributed with this software.
|----------------------------------------------------------------------------*/

.lm-ScrollBar {
  display: flex;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.lm-ScrollBar[data-orientation='horizontal'] {
  flex-direction: row;
}

.lm-ScrollBar[data-orientation='vertical'] {
  flex-direction: column;
}

.lm-ScrollBar-button {
  box-sizing: border-box;
  flex: 0 0 auto;
}

.lm-ScrollBar-track {
  box-sizing: border-box;
  position: relative;
  overflow: hidden;
  flex: 1 1 auto;
}

.lm-ScrollBar-thumb {
  box-sizing: border-box;
  position: absolute;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Copyright (c) 2014-2017, PhosphorJS Contributors
|
| Distributed under the terms of the BSD 3-Clause License.
|
| The full license is in the file LICENSE, distributed with this software.
|----------------------------------------------------------------------------*/

.lm-SplitPanel-child {
  z-index: 0;
}

.lm-SplitPanel-handle {
  z-index: 1;
}

.lm-SplitPanel-handle.lm-mod-hidden {
  display: none !important;
}

.lm-SplitPanel-handle:after {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  content: '';
}

.lm-SplitPanel[data-orientation='horizontal'] > .lm-SplitPanel-handle {
  cursor: ew-resize;
}

.lm-SplitPanel[data-orientation='vertical'] > .lm-SplitPanel-handle {
  cursor: ns-resize;
}

.lm-SplitPanel[data-orientation='horizontal'] > .lm-SplitPanel-handle:after {
  left: 50%;
  min-width: 8px;
  transform: translateX(-50%);
}

.lm-SplitPanel[data-orientation='vertical'] > .lm-SplitPanel-handle:after {
  top: 50%;
  min-height: 8px;
  transform: translateY(-50%);
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Copyright (c) 2014-2017, PhosphorJS Contributors
|
| Distributed under the terms of the BSD 3-Clause License.
|
| The full license is in the file LICENSE, distributed with this software.
|----------------------------------------------------------------------------*/

.lm-TabBar {
  display: flex;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.lm-TabBar[data-orientation='horizontal'] {
  flex-direction: row;
  align-items: flex-end;
}

.lm-TabBar[data-orientation='vertical'] {
  flex-direction: column;
  align-items: flex-end;
}

.lm-TabBar-content {
  margin: 0;
  padding: 0;
  display: flex;
  flex: 1 1 auto;
  list-style-type: none;
}

.lm-TabBar[data-orientation='horizontal'] > .lm-TabBar-content {
  flex-direction: row;
}

.lm-TabBar[data-orientation='vertical'] > .lm-TabBar-content {
  flex-direction: column;
}

.lm-TabBar-tab {
  display: flex;
  flex-direction: row;
  box-sizing: border-box;
  overflow: hidden;
  touch-action: none; /* Disable native Drag/Drop */
}

.lm-TabBar-tabIcon,
.lm-TabBar-tabCloseIcon {
  flex: 0 0 auto;
}

.lm-TabBar-tabLabel {
  flex: 1 1 auto;
  overflow: hidden;
  white-space: nowrap;
}

.lm-TabBar-tabInput {
  user-select: all;
  width: 100%;
  box-sizing: border-box;
}

.lm-TabBar-tab.lm-mod-hidden {
  display: none !important;
}

.lm-TabBar-addButton.lm-mod-hidden {
  display: none !important;
}

.lm-TabBar.lm-mod-dragging .lm-TabBar-tab {
  position: relative;
}

.lm-TabBar.lm-mod-dragging[data-orientation='horizontal'] .lm-TabBar-tab {
  left: 0;
  transition: left 150ms ease;
}

.lm-TabBar.lm-mod-dragging[data-orientation='vertical'] .lm-TabBar-tab {
  top: 0;
  transition: top 150ms ease;
}

.lm-TabBar.lm-mod-dragging .lm-TabBar-tab.lm-mod-dragging {
  transition: none;
}

.lm-TabBar-tabLabel .lm-TabBar-tabInput {
  user-select: all;
  width: 100%;
  box-sizing: border-box;
  background: inherit;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Copyright (c) 2014-2017, PhosphorJS Contributors
|
| Distributed under the terms of the BSD 3-Clause License.
|
| The full license is in the file LICENSE, distributed with this software.
|----------------------------------------------------------------------------*/

.lm-TabPanel-tabBar {
  z-index: 1;
}

.lm-TabPanel-stackedPanel {
  z-index: 0;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Copyright (c) 2014-2017, PhosphorJS Contributors
|
| Distributed under the terms of the BSD 3-Clause License.
|
| The full license is in the file LICENSE, distributed with this software.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.jp-Collapse {
  display: flex;
  flex-direction: column;
  align-items: stretch;
}

.jp-Collapse-header {
  padding: 1px 12px;
  background-color: var(--jp-layout-color1);
  border-bottom: solid var(--jp-border-width) var(--jp-border-color2);
  color: var(--jp-ui-font-color1);
  cursor: pointer;
  display: flex;
  align-items: center;
  font-size: var(--jp-ui-font-size0);
  font-weight: 600;
  text-transform: uppercase;
  user-select: none;
}

.jp-Collapser-icon {
  height: 16px;
}

.jp-Collapse-header-collapsed .jp-Collapser-icon {
  transform: rotate(-90deg);
  margin: auto 0;
}

.jp-Collapser-title {
  line-height: 25px;
}

.jp-Collapse-contents {
  padding: 0 12px;
  background-color: var(--jp-layout-color1);
  color: var(--jp-ui-font-color1);
  overflow: auto;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/* This file was auto-generated by ensureUiComponents() in @jupyterlab/buildutils */

/**
 * (DEPRECATED) Support for consuming icons as CSS background images
 */

/* Icons urls */

:root {
  --jp-icon-add-above: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTQiIGhlaWdodD0iMTQiIHZpZXdCb3g9IjAgMCAxNCAxNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGcgY2xpcC1wYXRoPSJ1cmwoI2NsaXAwXzEzN18xOTQ5MikiPgo8cGF0aCBjbGFzcz0ianAtaWNvbjMiIGQ9Ik00Ljc1IDQuOTMwNjZINi42MjVWNi44MDU2NkM2LjYyNSA3LjAxMTkxIDYuNzkzNzUgNy4xODA2NiA3IDcuMTgwNjZDNy4yMDYyNSA3LjE4MDY2IDcuMzc1IDcuMDExOTEgNy4zNzUgNi44MDU2NlY0LjkzMDY2SDkuMjVDOS40NTYyNSA0LjkzMDY2IDkuNjI1IDQuNzYxOTEgOS42MjUgNC41NTU2NkM5LjYyNSA0LjM0OTQxIDkuNDU2MjUgNC4xODA2NiA5LjI1IDQuMTgwNjZINy4zNzVWMi4zMDU2NkM3LjM3NSAyLjA5OTQxIDcuMjA2MjUgMS45MzA2NiA3IDEuOTMwNjZDNi43OTM3NSAxLjkzMDY2IDYuNjI1IDIuMDk5NDEgNi42MjUgMi4zMDU2NlY0LjE4MDY2SDQuNzVDNC41NDM3NSA0LjE4MDY2IDQuMzc1IDQuMzQ5NDEgNC4zNzUgNC41NTU2NkM0LjM3NSA0Ljc2MTkxIDQuNTQzNzUgNC45MzA2NiA0Ljc1IDQuOTMwNjZaIiBmaWxsPSIjNjE2MTYxIiBzdHJva2U9IiM2MTYxNjEiIHN0cm9rZS13aWR0aD0iMC43Ii8+CjwvZz4KPHBhdGggY2xhc3M9ImpwLWljb24zIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGNsaXAtcnVsZT0iZXZlbm9kZCIgZD0iTTExLjUgOS41VjExLjVMMi41IDExLjVWOS41TDExLjUgOS41Wk0xMiA4QzEyLjU1MjMgOCAxMyA4LjQ0NzcyIDEzIDlWMTJDMTMgMTIuNTUyMyAxMi41NTIzIDEzIDEyIDEzTDIgMTNDMS40NDc3MiAxMyAxIDEyLjU1MjMgMSAxMlY5QzEgOC40NDc3MiAxLjQ0NzcxIDggMiA4TDEyIDhaIiBmaWxsPSIjNjE2MTYxIi8+CjxkZWZzPgo8Y2xpcFBhdGggaWQ9ImNsaXAwXzEzN18xOTQ5MiI+CjxyZWN0IGNsYXNzPSJqcC1pY29uMyIgd2lkdGg9IjYiIGhlaWdodD0iNiIgZmlsbD0id2hpdGUiIHRyYW5zZm9ybT0ibWF0cml4KC0xIDAgMCAxIDEwIDEuNTU1NjYpIi8+CjwvY2xpcFBhdGg+CjwvZGVmcz4KPC9zdmc+Cg==);
  --jp-icon-add-below: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTQiIGhlaWdodD0iMTQiIHZpZXdCb3g9IjAgMCAxNCAxNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGcgY2xpcC1wYXRoPSJ1cmwoI2NsaXAwXzEzN18xOTQ5OCkiPgo8cGF0aCBjbGFzcz0ianAtaWNvbjMiIGQ9Ik05LjI1IDEwLjA2OTNMNy4zNzUgMTAuMDY5M0w3LjM3NSA4LjE5NDM0QzcuMzc1IDcuOTg4MDkgNy4yMDYyNSA3LjgxOTM0IDcgNy44MTkzNEM2Ljc5Mzc1IDcuODE5MzQgNi42MjUgNy45ODgwOSA2LjYyNSA4LjE5NDM0TDYuNjI1IDEwLjA2OTNMNC43NSAxMC4wNjkzQzQuNTQzNzUgMTAuMDY5MyA0LjM3NSAxMC4yMzgxIDQuMzc1IDEwLjQ0NDNDNC4zNzUgMTAuNjUwNiA0LjU0Mzc1IDEwLjgxOTMgNC43NSAxMC44MTkzTDYuNjI1IDEwLjgxOTNMNi42MjUgMTIuNjk0M0M2LjYyNSAxMi45MDA2IDYuNzkzNzUgMTMuMDY5MyA3IDEzLjA2OTNDNy4yMDYyNSAxMy4wNjkzIDcuMzc1IDEyLjkwMDYgNy4zNzUgMTIuNjk0M0w3LjM3NSAxMC44MTkzTDkuMjUgMTAuODE5M0M5LjQ1NjI1IDEwLjgxOTMgOS42MjUgMTAuNjUwNiA5LjYyNSAxMC40NDQzQzkuNjI1IDEwLjIzODEgOS40NTYyNSAxMC4wNjkzIDkuMjUgMTAuMDY5M1oiIGZpbGw9IiM2MTYxNjEiIHN0cm9rZT0iIzYxNjE2MSIgc3Ryb2tlLXdpZHRoPSIwLjciLz4KPC9nPgo8cGF0aCBjbGFzcz0ianAtaWNvbjMiIGZpbGwtcnVsZT0iZXZlbm9kZCIgY2xpcC1ydWxlPSJldmVub2RkIiBkPSJNMi41IDUuNUwyLjUgMy41TDExLjUgMy41TDExLjUgNS41TDIuNSA1LjVaTTIgN0MxLjQ0NzcyIDcgMSA2LjU1MjI4IDEgNkwxIDNDMSAyLjQ0NzcyIDEuNDQ3NzIgMiAyIDJMMTIgMkMxMi41NTIzIDIgMTMgMi40NDc3MiAxMyAzTDEzIDZDMTMgNi41NTIyOSAxMi41NTIzIDcgMTIgN0wyIDdaIiBmaWxsPSIjNjE2MTYxIi8+CjxkZWZzPgo8Y2xpcFBhdGggaWQ9ImNsaXAwXzEzN18xOTQ5OCI+CjxyZWN0IGNsYXNzPSJqcC1pY29uMyIgd2lkdGg9IjYiIGhlaWdodD0iNiIgZmlsbD0id2hpdGUiIHRyYW5zZm9ybT0ibWF0cml4KDEgMS43NDg0NmUtMDcgMS43NDg0NmUtMDcgLTEgNCAxMy40NDQzKSIvPgo8L2NsaXBQYXRoPgo8L2RlZnM+Cjwvc3ZnPgo=);
  --jp-icon-add: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTE5IDEzaC02djZoLTJ2LTZINXYtMmg2VjVoMnY2aDZ2MnoiLz4KICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-bell: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDE2IDE2IiB2ZXJzaW9uPSIxLjEiPgogICA8cGF0aCBjbGFzcz0ianAtaWNvbjIganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjMzMzMzMzIgogICAgICBkPSJtOCAwLjI5Yy0xLjQgMC0yLjcgMC43My0zLjYgMS44LTEuMiAxLjUtMS40IDMuNC0xLjUgNS4yLTAuMTggMi4yLTAuNDQgNC0yLjMgNS4zbDAuMjggMS4zaDVjMC4wMjYgMC42NiAwLjMyIDEuMSAwLjcxIDEuNSAwLjg0IDAuNjEgMiAwLjYxIDIuOCAwIDAuNTItMC40IDAuNi0xIDAuNzEtMS41aDVsMC4yOC0xLjNjLTEuOS0wLjk3LTIuMi0zLjMtMi4zLTUuMy0wLjEzLTEuOC0wLjI2LTMuNy0xLjUtNS4yLTAuODUtMS0yLjItMS44LTMuNi0xLjh6bTAgMS40YzAuODggMCAxLjkgMC41NSAyLjUgMS4zIDAuODggMS4xIDEuMSAyLjcgMS4yIDQuNCAwLjEzIDEuNyAwLjIzIDMuNiAxLjMgNS4yaC0xMGMxLjEtMS42IDEuMi0zLjQgMS4zLTUuMiAwLjEzLTEuNyAwLjMtMy4zIDEuMi00LjQgMC41OS0wLjcyIDEuNi0xLjMgMi41LTEuM3ptLTAuNzQgMTJoMS41Yy0wLjAwMTUgMC4yOCAwLjAxNSAwLjc5LTAuNzQgMC43OS0wLjczIDAuMDAxNi0wLjcyLTAuNTMtMC43NC0wLjc5eiIgLz4KPC9zdmc+Cg==);
  --jp-icon-bug-dot: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgIDxnIGNsYXNzPSJqcC1pY29uMyBqcC1pY29uLXNlbGVjdGFibGUiIGZpbGw9IiM2MTYxNjEiPgogICAgICAgIDxwYXRoIGZpbGwtcnVsZT0iZXZlbm9kZCIgY2xpcC1ydWxlPSJldmVub2RkIiBkPSJNMTcuMTkgOEgyMFYxMEgxNy45MUMxNy45NiAxMC4zMyAxOCAxMC42NiAxOCAxMVYxMkgyMFYxNEgxOC41SDE4VjE0LjAyNzVDMTUuNzUgMTQuMjc2MiAxNCAxNi4xODM3IDE0IDE4LjVDMTQgMTkuMjA4IDE0LjE2MzUgMTkuODc3OSAxNC40NTQ5IDIwLjQ3MzlDMTMuNzA2MyAyMC44MTE3IDEyLjg3NTcgMjEgMTIgMjFDOS43OCAyMSA3Ljg1IDE5Ljc5IDYuODEgMThINFYxNkg2LjA5QzYuMDQgMTUuNjcgNiAxNS4zNCA2IDE1VjE0SDRWMTJINlYxMUM2IDEwLjY2IDYuMDQgMTAuMzMgNi4wOSAxMEg0VjhINi44MUM3LjI2IDcuMjIgNy44OCA2LjU1IDguNjIgNi4wNEw3IDQuNDFMOC40MSAzTDEwLjU5IDUuMTdDMTEuMDQgNS4wNiAxMS41MSA1IDEyIDVDMTIuNDkgNSAxMi45NiA1LjA2IDEzLjQyIDUuMTdMMTUuNTkgM0wxNyA0LjQxTDE1LjM3IDYuMDRDMTYuMTIgNi41NSAxNi43NCA3LjIyIDE3LjE5IDhaTTEwIDE2SDE0VjE0SDEwVjE2Wk0xMCAxMkgxNFYxMEgxMFYxMloiIGZpbGw9IiM2MTYxNjEiLz4KICAgICAgICA8cGF0aCBkPSJNMjIgMTguNUMyMiAyMC40MzMgMjAuNDMzIDIyIDE4LjUgMjJDMTYuNTY3IDIyIDE1IDIwLjQzMyAxNSAxOC41QzE1IDE2LjU2NyAxNi41NjcgMTUgMTguNSAxNUMyMC40MzMgMTUgMjIgMTYuNTY3IDIyIDE4LjVaIiBmaWxsPSIjNjE2MTYxIi8+CiAgICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-bug: url(data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIxNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbjMganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjNjE2MTYxIj4KICAgIDxwYXRoIGQ9Ik0yMCA4aC0yLjgxYy0uNDUtLjc4LTEuMDctMS40NS0xLjgyLTEuOTZMMTcgNC40MSAxNS41OSAzbC0yLjE3IDIuMTdDMTIuOTYgNS4wNiAxMi40OSA1IDEyIDVjLS40OSAwLS45Ni4wNi0xLjQxLjE3TDguNDEgMyA3IDQuNDFsMS42MiAxLjYzQzcuODggNi41NSA3LjI2IDcuMjIgNi44MSA4SDR2MmgyLjA5Yy0uMDUuMzMtLjA5LjY2LS4wOSAxdjFINHYyaDJ2MWMwIC4zNC4wNC42Ny4wOSAxSDR2MmgyLjgxYzEuMDQgMS43OSAyLjk3IDMgNS4xOSAzczQuMTUtMS4yMSA1LjE5LTNIMjB2LTJoLTIuMDljLjA1LS4zMy4wOS0uNjYuMDktMXYtMWgydi0yaC0ydi0xYzAtLjM0LS4wNC0uNjctLjA5LTFIMjBWOHptLTYgOGgtNHYtMmg0djJ6bTAtNGgtNHYtMmg0djJ6Ii8+CiAgPC9nPgo8L3N2Zz4K);
  --jp-icon-build: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIHZpZXdCb3g9IjAgMCAyNCAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTE0LjkgMTcuNDVDMTYuMjUgMTcuNDUgMTcuMzUgMTYuMzUgMTcuMzUgMTVDMTcuMzUgMTMuNjUgMTYuMjUgMTIuNTUgMTQuOSAxMi41NUMxMy41NCAxMi41NSAxMi40NSAxMy42NSAxMi40NSAxNUMxMi40NSAxNi4zNSAxMy41NCAxNy40NSAxNC45IDE3LjQ1Wk0yMC4xIDE1LjY4TDIxLjU4IDE2Ljg0QzIxLjcxIDE2Ljk1IDIxLjc1IDE3LjEzIDIxLjY2IDE3LjI5TDIwLjI2IDE5LjcxQzIwLjE3IDE5Ljg2IDIwIDE5LjkyIDE5LjgzIDE5Ljg2TDE4LjA5IDE5LjE2QzE3LjczIDE5LjQ0IDE3LjMzIDE5LjY3IDE2LjkxIDE5Ljg1TDE2LjY0IDIxLjdDMTYuNjIgMjEuODcgMTYuNDcgMjIgMTYuMyAyMkgxMy41QzEzLjMyIDIyIDEzLjE4IDIxLjg3IDEzLjE1IDIxLjdMMTIuODkgMTkuODVDMTIuNDYgMTkuNjcgMTIuMDcgMTkuNDQgMTEuNzEgMTkuMTZMOS45NjAwMiAxOS44NkM5LjgxMDAyIDE5LjkyIDkuNjIwMDIgMTkuODYgOS41NDAwMiAxOS43MUw4LjE0MDAyIDE3LjI5QzguMDUwMDIgMTcuMTMgOC4wOTAwMiAxNi45NSA4LjIyMDAyIDE2Ljg0TDkuNzAwMDIgMTUuNjhMOS42NTAwMSAxNUw5LjcwMDAyIDE0LjMxTDguMjIwMDIgMTMuMTZDOC4wOTAwMiAxMy4wNSA4LjA1MDAyIDEyLjg2IDguMTQwMDIgMTIuNzFMOS41NDAwMiAxMC4yOUM5LjYyMDAyIDEwLjEzIDkuODEwMDIgMTAuMDcgOS45NjAwMiAxMC4xM0wxMS43MSAxMC44NEMxMi4wNyAxMC41NiAxMi40NiAxMC4zMiAxMi44OSAxMC4xNUwxMy4xNSA4LjI4OTk4QzEzLjE4IDguMTI5OTggMTMuMzIgNy45OTk5OCAxMy41IDcuOTk5OThIMTYuM0MxNi40NyA3Ljk5OTk4IDE2LjYyIDguMTI5OTggMTYuNjQgOC4yODk5OEwxNi45MSAxMC4xNUMxNy4zMyAxMC4zMiAxNy43MyAxMC41NiAxOC4wOSAxMC44NEwxOS44MyAxMC4xM0MyMCAxMC4wNyAyMC4xNyAxMC4xMyAyMC4yNiAxMC4yOUwyMS42NiAxMi43MUMyMS43NSAxMi44NiAyMS43MSAxMy4wNSAyMS41OCAxMy4xNkwyMC4xIDE0LjMxTDIwLjE1IDE1TDIwLjEgMTUuNjhaIi8+CiAgICA8cGF0aCBkPSJNNy4zMjk2NiA3LjQ0NDU0QzguMDgzMSA3LjAwOTU0IDguMzM5MzIgNi4wNTMzMiA3LjkwNDMyIDUuMjk5ODhDNy40NjkzMiA0LjU0NjQzIDYuNTA4MSA0LjI4MTU2IDUuNzU0NjYgNC43MTY1NkM1LjM5MTc2IDQuOTI2MDggNS4xMjY5NSA1LjI3MTE4IDUuMDE4NDkgNS42NzU5NEM0LjkxMDA0IDYuMDgwNzEgNC45NjY4MiA2LjUxMTk4IDUuMTc2MzQgNi44NzQ4OEM1LjYxMTM0IDcuNjI4MzIgNi41NzYyMiA3Ljg3OTU0IDcuMzI5NjYgNy40NDQ1NFpNOS42NTcxOCA0Ljc5NTkzTDEwLjg2NzIgNC45NTE3OUMxMC45NjI4IDQuOTc3NDEgMTEuMDQwMiA1LjA3MTMzIDExLjAzODIgNS4xODc5M0wxMS4wMzg4IDYuOTg4OTNDMTEuMDQ1NSA3LjEwMDU0IDEwLjk2MTYgNy4xOTUxOCAxMC44NTUgNy4yMTA1NEw5LjY2MDAxIDcuMzgwODNMOS4yMzkxNSA4LjEzMTg4TDkuNjY5NjEgOS4yNTc0NUM5LjcwNzI5IDkuMzYyNzEgOS42NjkzNCA5LjQ3Njk5IDkuNTc0MDggOS41MzE5OUw4LjAxNTIzIDEwLjQzMkM3LjkxMTMxIDEwLjQ5MiA3Ljc5MzM3IDEwLjQ2NzcgNy43MjEwNSAxMC4zODI0TDYuOTg3NDggOS40MzE4OEw2LjEwOTMxIDkuNDMwODNMNS4zNDcwNCAxMC4zOTA1QzUuMjg5MDkgMTAuNDcwMiA1LjE3MzgzIDEwLjQ5MDUgNS4wNzE4NyAxMC40MzM5TDMuNTEyNDUgOS41MzI5M0MzLjQxMDQ5IDkuNDc2MzMgMy4zNzY0NyA5LjM1NzQxIDMuNDEwNzUgOS4yNTY3OUwzLjg2MzQ3IDguMTQwOTNMMy42MTc0OSA3Ljc3NDg4TDMuNDIzNDcgNy4zNzg4M0wyLjIzMDc1IDcuMjEyOTdDMi4xMjY0NyA3LjE5MjM1IDIuMDQwNDkgNy4xMDM0MiAyLjA0MjQ1IDYuOTg2ODJMMi4wNDE4NyA1LjE4NTgyQzIuMDQzODMgNS4wNjkyMiAyLjExOTA5IDQuOTc5NTggMi4yMTcwNCA0Ljk2OTIyTDMuNDIwNjUgNC43OTM5M0wzLjg2NzQ5IDQuMDI3ODhMMy40MTEwNSAyLjkxNzMxQzMuMzczMzcgMi44MTIwNCAzLjQxMTMxIDIuNjk3NzYgMy41MTUyMyAyLjYzNzc2TDUuMDc0MDggMS43Mzc3NkM1LjE2OTM0IDEuNjgyNzYgNS4yODcyOSAxLjcwNzA0IDUuMzU5NjEgMS43OTIzMUw2LjExOTE1IDIuNzI3ODhMNi45ODAwMSAyLjczODkzTDcuNzI0OTYgMS43ODkyMkM3Ljc5MTU2IDEuNzA0NTggNy45MTU0OCAxLjY3OTIyIDguMDA4NzkgMS43NDA4Mkw5LjU2ODIxIDIuNjQxODJDOS42NzAxNyAyLjY5ODQyIDkuNzEyODUgMi44MTIzNCA5LjY4NzIzIDIuOTA3OTdMOS4yMTcxOCA0LjAzMzgzTDkuNDYzMTYgNC4zOTk4OEw5LjY1NzE4IDQuNzk1OTNaIi8+CiAgPC9nPgo8L3N2Zz4K);
  --jp-icon-caret-down-empty-thin: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIwIDIwIj4KCTxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSIgc2hhcGUtcmVuZGVyaW5nPSJnZW9tZXRyaWNQcmVjaXNpb24iPgoJCTxwb2x5Z29uIGNsYXNzPSJzdDEiIHBvaW50cz0iOS45LDEzLjYgMy42LDcuNCA0LjQsNi42IDkuOSwxMi4yIDE1LjQsNi43IDE2LjEsNy40ICIvPgoJPC9nPgo8L3N2Zz4K);
  --jp-icon-caret-down-empty: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDE4IDE4Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiIHNoYXBlLXJlbmRlcmluZz0iZ2VvbWV0cmljUHJlY2lzaW9uIj4KICAgIDxwYXRoIGQ9Ik01LjIsNS45TDksOS43bDMuOC0zLjhsMS4yLDEuMmwtNC45LDVsLTQuOS01TDUuMiw1Ljl6Ii8+CiAgPC9nPgo8L3N2Zz4K);
  --jp-icon-caret-down: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDE4IDE4Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiIHNoYXBlLXJlbmRlcmluZz0iZ2VvbWV0cmljUHJlY2lzaW9uIj4KICAgIDxwYXRoIGQ9Ik01LjIsNy41TDksMTEuMmwzLjgtMy44SDUuMnoiLz4KICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-caret-left: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDE4IDE4Ij4KCTxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSIgc2hhcGUtcmVuZGVyaW5nPSJnZW9tZXRyaWNQcmVjaXNpb24iPgoJCTxwYXRoIGQ9Ik0xMC44LDEyLjhMNy4xLDlsMy44LTMuOGwwLDcuNkgxMC44eiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-caret-right: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDE4IDE4Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiIHNoYXBlLXJlbmRlcmluZz0iZ2VvbWV0cmljUHJlY2lzaW9uIj4KICAgIDxwYXRoIGQ9Ik03LjIsNS4yTDEwLjksOWwtMy44LDMuOFY1LjJINy4yeiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-caret-up-empty-thin: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIwIDIwIj4KCTxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSIgc2hhcGUtcmVuZGVyaW5nPSJnZW9tZXRyaWNQcmVjaXNpb24iPgoJCTxwb2x5Z29uIGNsYXNzPSJzdDEiIHBvaW50cz0iMTUuNCwxMy4zIDkuOSw3LjcgNC40LDEzLjIgMy42LDEyLjUgOS45LDYuMyAxNi4xLDEyLjYgIi8+Cgk8L2c+Cjwvc3ZnPgo=);
  --jp-icon-caret-up: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDE4IDE4Ij4KCTxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSIgc2hhcGUtcmVuZGVyaW5nPSJnZW9tZXRyaWNQcmVjaXNpb24iPgoJCTxwYXRoIGQ9Ik01LjIsMTAuNUw5LDYuOGwzLjgsMy44SDUuMnoiLz4KICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-case-sensitive: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIwIDIwIj4KICA8ZyBjbGFzcz0ianAtaWNvbjIiIGZpbGw9IiM0MTQxNDEiPgogICAgPHJlY3QgeD0iMiIgeT0iMiIgd2lkdGg9IjE2IiBoZWlnaHQ9IjE2Ii8+CiAgPC9nPgogIDxnIGNsYXNzPSJqcC1pY29uLWFjY2VudDIiIGZpbGw9IiNGRkYiPgogICAgPHBhdGggZD0iTTcuNiw4aDAuOWwzLjUsOGgtMS4xTDEwLDE0SDZsLTAuOSwySDRMNy42LDh6IE04LDkuMUw2LjQsMTNoMy4yTDgsOS4xeiIvPgogICAgPHBhdGggZD0iTTE2LjYsOS44Yy0wLjIsMC4xLTAuNCwwLjEtMC43LDAuMWMtMC4yLDAtMC40LTAuMS0wLjYtMC4yYy0wLjEtMC4xLTAuMi0wLjQtMC4yLTAuNyBjLTAuMywwLjMtMC42LDAuNS0wLjksMC43Yy0wLjMsMC4xLTAuNywwLjItMS4xLDAuMmMtMC4zLDAtMC41LDAtMC43LTAuMWMtMC4yLTAuMS0wLjQtMC4yLTAuNi0wLjNjLTAuMi0wLjEtMC4zLTAuMy0wLjQtMC41IGMtMC4xLTAuMi0wLjEtMC40LTAuMS0wLjdjMC0wLjMsMC4xLTAuNiwwLjItMC44YzAuMS0wLjIsMC4zLTAuNCwwLjQtMC41QzEyLDcsMTIuMiw2LjksMTIuNSw2LjhjMC4yLTAuMSwwLjUtMC4xLDAuNy0wLjIgYzAuMy0wLjEsMC41LTAuMSwwLjctMC4xYzAuMiwwLDAuNC0wLjEsMC42LTAuMWMwLjIsMCwwLjMtMC4xLDAuNC0wLjJjMC4xLTAuMSwwLjItMC4yLDAuMi0wLjRjMC0xLTEuMS0xLTEuMy0xIGMtMC40LDAtMS40LDAtMS40LDEuMmgtMC45YzAtMC40LDAuMS0wLjcsMC4yLTFjMC4xLTAuMiwwLjMtMC40LDAuNS0wLjZjMC4yLTAuMiwwLjUtMC4zLDAuOC0wLjNDMTMuMyw0LDEzLjYsNCwxMy45LDQgYzAuMywwLDAuNSwwLDAuOCwwLjFjMC4zLDAsMC41LDAuMSwwLjcsMC4yYzAuMiwwLjEsMC40LDAuMywwLjUsMC41QzE2LDUsMTYsNS4yLDE2LDUuNnYyLjljMCwwLjIsMCwwLjQsMCwwLjUgYzAsMC4xLDAuMSwwLjIsMC4zLDAuMmMwLjEsMCwwLjIsMCwwLjMsMFY5Ljh6IE0xNS4yLDYuOWMtMS4yLDAuNi0zLjEsMC4yLTMuMSwxLjRjMCwxLjQsMy4xLDEsMy4xLTAuNVY2Ljl6Ii8+CiAgPC9nPgo8L3N2Zz4K);
  --jp-icon-check: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjNjE2MTYxIj4KICAgIDxwYXRoIGQ9Ik05IDE2LjE3TDQuODMgMTJsLTEuNDIgMS40MUw5IDE5IDIxIDdsLTEuNDEtMS40MXoiLz4KICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-circle-empty: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTEyIDJDNi40NyAyIDIgNi40NyAyIDEyczQuNDcgMTAgMTAgMTAgMTAtNC40NyAxMC0xMFMxNy41MyAyIDEyIDJ6bTAgMThjLTQuNDEgMC04LTMuNTktOC04czMuNTktOCA4LTggOCAzLjU5IDggOC0zLjU5IDgtOCA4eiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-circle: url(data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMTggMTgiIHdpZHRoPSIxNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPGNpcmNsZSBjeD0iOSIgY3k9IjkiIHI9IjgiLz4KICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-clear: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8bWFzayBpZD0iZG9udXRIb2xlIj4KICAgIDxyZWN0IHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgZmlsbD0id2hpdGUiIC8+CiAgICA8Y2lyY2xlIGN4PSIxMiIgY3k9IjEyIiByPSI4IiBmaWxsPSJibGFjayIvPgogIDwvbWFzaz4KCiAgPGcgY2xhc3M9ImpwLWljb24zIiBmaWxsPSIjNjE2MTYxIj4KICAgIDxyZWN0IGhlaWdodD0iMTgiIHdpZHRoPSIyIiB4PSIxMSIgeT0iMyIgdHJhbnNmb3JtPSJyb3RhdGUoMzE1LCAxMiwgMTIpIi8+CiAgICA8Y2lyY2xlIGN4PSIxMiIgY3k9IjEyIiByPSIxMCIgbWFzaz0idXJsKCNkb251dEhvbGUpIi8+CiAgPC9nPgo8L3N2Zz4K);
  --jp-icon-close: url(data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIxNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbi1ub25lIGpwLWljb24tc2VsZWN0YWJsZS1pbnZlcnNlIGpwLWljb24zLWhvdmVyIiBmaWxsPSJub25lIj4KICAgIDxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjExIi8+CiAgPC9nPgoKICA8ZyBjbGFzcz0ianAtaWNvbjMganAtaWNvbi1zZWxlY3RhYmxlIGpwLWljb24tYWNjZW50Mi1ob3ZlciIgZmlsbD0iIzYxNjE2MSI+CiAgICA8cGF0aCBkPSJNMTkgNi40MUwxNy41OSA1IDEyIDEwLjU5IDYuNDEgNSA1IDYuNDEgMTAuNTkgMTIgNSAxNy41OSA2LjQxIDE5IDEyIDEzLjQxIDE3LjU5IDE5IDE5IDE3LjU5IDEzLjQxIDEyeiIvPgogIDwvZz4KCiAgPGcgY2xhc3M9ImpwLWljb24tbm9uZSBqcC1pY29uLWJ1c3kiIGZpbGw9Im5vbmUiPgogICAgPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iNyIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-code-check: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjNjE2MTYxIiBzaGFwZS1yZW5kZXJpbmc9Imdlb21ldHJpY1ByZWNpc2lvbiI+CiAgICA8cGF0aCBkPSJNNi41OSwzLjQxTDIsOEw2LjU5LDEyLjZMOCwxMS4xOEw0LjgyLDhMOCw0LjgyTDYuNTksMy40MU0xMi40MSwzLjQxTDExLDQuODJMMTQuMTgsOEwxMSwxMS4xOEwxMi40MSwxMi42TDE3LDhMMTIuNDEsMy40MU0yMS41OSwxMS41OUwxMy41LDE5LjY4TDkuODMsMTZMOC40MiwxNy40MUwxMy41LDIyLjVMMjMsMTNMMjEuNTksMTEuNTlaIiAvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-code: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjIiIGhlaWdodD0iMjIiIHZpZXdCb3g9IjAgMCAyOCAyOCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KCTxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSI+CgkJPHBhdGggZD0iTTExLjQgMTguNkw2LjggMTRMMTEuNCA5LjRMMTAgOEw0IDE0TDEwIDIwTDExLjQgMTguNlpNMTYuNiAxOC42TDIxLjIgMTRMMTYuNiA5LjRMMTggOEwyNCAxNEwxOCAyMEwxNi42IDE4LjZWMTguNloiLz4KCTwvZz4KPC9zdmc+Cg==);
  --jp-icon-collapse-all: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICAgIDxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSI+CiAgICAgICAgPHBhdGgKICAgICAgICAgICAgZD0iTTggMmMxIDAgMTEgMCAxMiAwczIgMSAyIDJjMCAxIDAgMTEgMCAxMnMwIDItMiAyQzIwIDE0IDIwIDQgMjAgNFMxMCA0IDYgNGMwLTIgMS0yIDItMnoiIC8+CiAgICAgICAgPHBhdGgKICAgICAgICAgICAgZD0iTTE4IDhjMC0xLTEtMi0yLTJTNSA2IDQgNnMtMiAxLTIgMmMwIDEgMCAxMSAwIDEyczEgMiAyIDJjMSAwIDExIDAgMTIgMHMyLTEgMi0yYzAtMSAwLTExIDAtMTJ6bS0yIDB2MTJINFY4eiIgLz4KICAgICAgICA8cGF0aCBkPSJNNiAxM3YyaDh2LTJ6IiAvPgogICAgPC9nPgo8L3N2Zz4K);
  --jp-icon-console: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIwMCAyMDAiPgogIDxnIGNsYXNzPSJqcC1jb25zb2xlLWljb24tYmFja2dyb3VuZC1jb2xvciBqcC1pY29uLXNlbGVjdGFibGUiIGZpbGw9IiMwMjg4RDEiPgogICAgPHBhdGggZD0iTTIwIDE5LjhoMTYwdjE1OS45SDIweiIvPgogIDwvZz4KICA8ZyBjbGFzcz0ianAtY29uc29sZS1pY29uLWNvbG9yIGpwLWljb24tc2VsZWN0YWJsZS1pbnZlcnNlIiBmaWxsPSIjZmZmIj4KICAgIDxwYXRoIGQ9Ik0xMDUgMTI3LjNoNDB2MTIuOGgtNDB6TTUxLjEgNzdMNzQgOTkuOWwtMjMuMyAyMy4zIDEwLjUgMTAuNSAyMy4zLTIzLjNMOTUgOTkuOSA4NC41IDg5LjQgNjEuNiA2Ni41eiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-copy: url(data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMTggMTgiIHdpZHRoPSIxNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTExLjksMUgzLjJDMi40LDEsMS43LDEuNywxLjcsMi41djEwLjJoMS41VjIuNWg4LjdWMXogTTE0LjEsMy45aC04Yy0wLjgsMC0xLjUsMC43LTEuNSwxLjV2MTAuMmMwLDAuOCwwLjcsMS41LDEuNSwxLjVoOCBjMC44LDAsMS41LTAuNywxLjUtMS41VjUuNEMxNS41LDQuNiwxNC45LDMuOSwxNC4xLDMuOXogTTE0LjEsMTUuNWgtOFY1LjRoOFYxNS41eiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-copyright: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGVuYWJsZS1iYWNrZ3JvdW5kPSJuZXcgMCAwIDI0IDI0IiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNCI+CiAgPGcgY2xhc3M9ImpwLWljb24zIiBmaWxsPSIjNjE2MTYxIj4KICAgIDxwYXRoIGQ9Ik0xMS44OCw5LjE0YzEuMjgsMC4wNiwxLjYxLDEuMTUsMS42MywxLjY2aDEuNzljLTAuMDgtMS45OC0xLjQ5LTMuMTktMy40NS0zLjE5QzkuNjQsNy42MSw4LDksOCwxMi4xNCBjMCwxLjk0LDAuOTMsNC4yNCwzLjg0LDQuMjRjMi4yMiwwLDMuNDEtMS42NSwzLjQ0LTIuOTVoLTEuNzljLTAuMDMsMC41OS0wLjQ1LDEuMzgtMS42MywxLjQ0QzEwLjU1LDE0LjgzLDEwLDEzLjgxLDEwLDEyLjE0IEMxMCw5LjI1LDExLjI4LDkuMTYsMTEuODgsOS4xNHogTTEyLDJDNi40OCwyLDIsNi40OCwyLDEyczQuNDgsMTAsMTAsMTBzMTAtNC40OCwxMC0xMFMxNy41MiwyLDEyLDJ6IE0xMiwyMGMtNC40MSwwLTgtMy41OS04LTggczMuNTktOCw4LThzOCwzLjU5LDgsOFMxNi40MSwyMCwxMiwyMHoiLz4KICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-cut: url(data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIxNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTkuNjQgNy42NGMuMjMtLjUuMzYtMS4wNS4zNi0xLjY0IDAtMi4yMS0xLjc5LTQtNC00UzIgMy43OSAyIDZzMS43OSA0IDQgNGMuNTkgMCAxLjE0LS4xMyAxLjY0LS4zNkwxMCAxMmwtMi4zNiAyLjM2QzcuMTQgMTQuMTMgNi41OSAxNCA2IDE0Yy0yLjIxIDAtNCAxLjc5LTQgNHMxLjc5IDQgNCA0IDQtMS43OSA0LTRjMC0uNTktLjEzLTEuMTQtLjM2LTEuNjRMMTIgMTRsNyA3aDN2LTFMOS42NCA3LjY0ek02IDhjLTEuMSAwLTItLjg5LTItMnMuOS0yIDItMiAyIC44OSAyIDItLjkgMi0yIDJ6bTAgMTJjLTEuMSAwLTItLjg5LTItMnMuOS0yIDItMiAyIC44OSAyIDItLjkgMi0yIDJ6bTYtNy41Yy0uMjggMC0uNS0uMjItLjUtLjVzLjIyLS41LjUtLjUuNS4yMi41LjUtLjIyLjUtLjUuNXpNMTkgM2wtNiA2IDIgMiA3LTdWM3oiLz4KICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-delete: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjE2cHgiIGhlaWdodD0iMTZweCI+CiAgICA8cGF0aCBkPSJNMCAwaDI0djI0SDB6IiBmaWxsPSJub25lIiAvPgogICAgPHBhdGggY2xhc3M9ImpwLWljb24zIiBmaWxsPSIjNjI2MjYyIiBkPSJNNiAxOWMwIDEuMS45IDIgMiAyaDhjMS4xIDAgMi0uOSAyLTJWN0g2djEyek0xOSA0aC0zLjVsLTEtMWgtNWwtMSAxSDV2MmgxNFY0eiIgLz4KPC9zdmc+Cg==);
  --jp-icon-download: url(data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIxNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTE5IDloLTRWM0g5djZINWw3IDcgNy03ek01IDE4djJoMTR2LTJINXoiLz4KICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-duplicate: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTQiIGhlaWdodD0iMTQiIHZpZXdCb3g9IjAgMCAxNCAxNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggY2xhc3M9ImpwLWljb24zIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGNsaXAtcnVsZT0iZXZlbm9kZCIgZD0iTTIuNzk5OTggMC44NzVIOC44OTU4MkM5LjIwMDYxIDAuODc1IDkuNDQ5OTggMS4xMzkxNCA5LjQ0OTk4IDEuNDYxOThDOS40NDk5OCAxLjc4NDgyIDkuMjAwNjEgMi4wNDg5NiA4Ljg5NTgyIDIuMDQ4OTZIMy4zNTQxNUMzLjA0OTM2IDIuMDQ4OTYgMi43OTk5OCAyLjMxMzEgMi43OTk5OCAyLjYzNTk0VjkuNjc5NjlDMi43OTk5OCAxMC4wMDI1IDIuNTUwNjEgMTAuMjY2NyAyLjI0NTgyIDEwLjI2NjdDMS45NDEwMyAxMC4yNjY3IDEuNjkxNjUgMTAuMDAyNSAxLjY5MTY1IDkuNjc5NjlWMi4wNDg5NkMxLjY5MTY1IDEuNDAzMjggMi4xOTA0IDAuODc1IDIuNzk5OTggMC44NzVaTTUuMzY2NjUgMTEuOVY0LjU1SDExLjA4MzNWMTEuOUg1LjM2NjY1Wk00LjE0MTY1IDQuMTQxNjdDNC4xNDE2NSAzLjY5MDYzIDQuNTA3MjggMy4zMjUgNC45NTgzMiAzLjMyNUgxMS40OTE3QzExLjk0MjcgMy4zMjUgMTIuMzA4MyAzLjY5MDYzIDEyLjMwODMgNC4xNDE2N1YxMi4zMDgzQzEyLjMwODMgMTIuNzU5NCAxMS45NDI3IDEzLjEyNSAxMS40OTE3IDEzLjEyNUg0Ljk1ODMyQzQuNTA3MjggMTMuMTI1IDQuMTQxNjUgMTIuNzU5NCA0LjE0MTY1IDEyLjMwODNWNC4xNDE2N1oiIGZpbGw9IiM2MTYxNjEiLz4KPHBhdGggY2xhc3M9ImpwLWljb24zIiBkPSJNOS40MzU3NCA4LjI2NTA3SDguMzY0MzFWOS4zMzY1QzguMzY0MzEgOS40NTQzNSA4LjI2Nzg4IDkuNTUwNzggOC4xNTAwMiA5LjU1MDc4QzguMDMyMTcgOS41NTA3OCA3LjkzNTc0IDkuNDU0MzUgNy45MzU3NCA5LjMzNjVWOC4yNjUwN0g2Ljg2NDMxQzYuNzQ2NDUgOC4yNjUwNyA2LjY1MDAyIDguMTY4NjQgNi42NTAwMiA4LjA1MDc4QzYuNjUwMDIgNy45MzI5MiA2Ljc0NjQ1IDcuODM2NSA2Ljg2NDMxIDcuODM2NUg3LjkzNTc0VjYuNzY1MDdDNy45MzU3NCA2LjY0NzIxIDguMDMyMTcgNi41NTA3OCA4LjE1MDAyIDYuNTUwNzhDOC4yNjc4OCA2LjU1MDc4IDguMzY0MzEgNi42NDcyMSA4LjM2NDMxIDYuNzY1MDdWNy44MzY1SDkuNDM1NzRDOS41NTM2IDcuODM2NSA5LjY1MDAyIDcuOTMyOTIgOS42NTAwMiA4LjA1MDc4QzkuNjUwMDIgOC4xNjg2NCA5LjU1MzYgOC4yNjUwNyA5LjQzNTc0IDguMjY1MDdaIiBmaWxsPSIjNjE2MTYxIiBzdHJva2U9IiM2MTYxNjEiIHN0cm9rZS13aWR0aD0iMC41Ii8+Cjwvc3ZnPgo=);
  --jp-icon-edit: url(data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIxNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTMgMTcuMjVWMjFoMy43NUwxNy44MSA5Ljk0bC0zLjc1LTMuNzVMMyAxNy4yNXpNMjAuNzEgNy4wNGMuMzktLjM5LjM5LTEuMDIgMC0xLjQxbC0yLjM0LTIuMzRjLS4zOS0uMzktMS4wMi0uMzktMS40MSAwbC0xLjgzIDEuODMgMy43NSAzLjc1IDEuODMtMS44M3oiLz4KICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-ellipses: url(data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIxNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPGNpcmNsZSBjeD0iNSIgY3k9IjEyIiByPSIyIi8+CiAgICA8Y2lyY2xlIGN4PSIxMiIgY3k9IjEyIiByPSIyIi8+CiAgICA8Y2lyY2xlIGN4PSIxOSIgY3k9IjEyIiByPSIyIi8+CiAgPC9nPgo8L3N2Zz4K);
  --jp-icon-error: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KPGcgY2xhc3M9ImpwLWljb24zIiBmaWxsPSIjNjE2MTYxIj48Y2lyY2xlIGN4PSIxMiIgY3k9IjE5IiByPSIyIi8+PHBhdGggZD0iTTEwIDNoNHYxMmgtNHoiLz48L2c+CjxwYXRoIGZpbGw9Im5vbmUiIGQ9Ik0wIDBoMjR2MjRIMHoiLz4KPC9zdmc+Cg==);
  --jp-icon-expand-all: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICAgIDxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSI+CiAgICAgICAgPHBhdGgKICAgICAgICAgICAgZD0iTTggMmMxIDAgMTEgMCAxMiAwczIgMSAyIDJjMCAxIDAgMTEgMCAxMnMwIDItMiAyQzIwIDE0IDIwIDQgMjAgNFMxMCA0IDYgNGMwLTIgMS0yIDItMnoiIC8+CiAgICAgICAgPHBhdGgKICAgICAgICAgICAgZD0iTTE4IDhjMC0xLTEtMi0yLTJTNSA2IDQgNnMtMiAxLTIgMmMwIDEgMCAxMSAwIDEyczEgMiAyIDJjMSAwIDExIDAgMTIgMHMyLTEgMi0yYzAtMSAwLTExIDAtMTJ6bS0yIDB2MTJINFY4eiIgLz4KICAgICAgICA8cGF0aCBkPSJNMTEgMTBIOXYzSDZ2MmgzdjNoMnYtM2gzdi0yaC0zeiIgLz4KICAgIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-extension: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTIwLjUgMTFIMTlWN2MwLTEuMS0uOS0yLTItMmgtNFYzLjVDMTMgMi4xMiAxMS44OCAxIDEwLjUgMVM4IDIuMTIgOCAzLjVWNUg0Yy0xLjEgMC0xLjk5LjktMS45OSAydjMuOEgzLjVjMS40OSAwIDIuNyAxLjIxIDIuNyAyLjdzLTEuMjEgMi43LTIuNyAyLjdIMlYyMGMwIDEuMS45IDIgMiAyaDMuOHYtMS41YzAtMS40OSAxLjIxLTIuNyAyLjctMi43IDEuNDkgMCAyLjcgMS4yMSAyLjcgMi43VjIySDE3YzEuMSAwIDItLjkgMi0ydi00aDEuNWMxLjM4IDAgMi41LTEuMTIgMi41LTIuNVMyMS44OCAxMSAyMC41IDExeiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-fast-forward: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICAgIDxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSI+CiAgICAgICAgPHBhdGggZD0iTTQgMThsOC41LTZMNCA2djEyem05LTEydjEybDguNS02TDEzIDZ6Ii8+CiAgICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-file-upload: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTkgMTZoNnYtNmg0bC03LTctNyA3aDR6bS00IDJoMTR2Mkg1eiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-file: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIyIDIyIj4KICA8cGF0aCBjbGFzcz0ianAtaWNvbjMganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjNjE2MTYxIiBkPSJNMTkuMyA4LjJsLTUuNS01LjVjLS4zLS4zLS43LS41LTEuMi0uNUgzLjljLS44LjEtMS42LjktMS42IDEuOHYxNC4xYzAgLjkuNyAxLjYgMS42IDEuNmgxNC4yYy45IDAgMS42LS43IDEuNi0xLjZWOS40Yy4xLS41LS4xLS45LS40LTEuMnptLTUuOC0zLjNsMy40IDMuNmgtMy40VjQuOXptMy45IDEyLjdINC43Yy0uMSAwLS4yIDAtLjItLjJWNC43YzAtLjIuMS0uMy4yLS4zaDcuMnY0LjRzMCAuOC4zIDEuMWMuMy4zIDEuMS4zIDEuMS4zaDQuM3Y3LjJzLS4xLjItLjIuMnoiLz4KPC9zdmc+Cg==);
  --jp-icon-filter-dot: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiNGRkYiPgogICAgPHBhdGggZD0iTTE0LDEyVjE5Ljg4QzE0LjA0LDIwLjE4IDEzLjk0LDIwLjUgMTMuNzEsMjAuNzFDMTMuMzIsMjEuMSAxMi42OSwyMS4xIDEyLjMsMjAuNzFMMTAuMjksMTguN0MxMC4wNiwxOC40NyA5Ljk2LDE4LjE2IDEwLDE3Ljg3VjEySDkuOTdMNC4yMSw0LjYyQzMuODcsNC4xOSAzLjk1LDMuNTYgNC4zOCwzLjIyQzQuNTcsMy4wOCA0Ljc4LDMgNSwzVjNIMTlWM0MxOS4yMiwzIDE5LjQzLDMuMDggMTkuNjIsMy4yMkMyMC4wNSwzLjU2IDIwLjEzLDQuMTkgMTkuNzksNC42MkwxNC4wMywxMkgxNFoiIC8+CiAgPC9nPgogIDxnIGNsYXNzPSJqcC1pY29uLWRvdCIgZmlsbD0iI0ZGRiI+CiAgICA8Y2lyY2xlIGN4PSIxOCIgY3k9IjE3IiByPSIzIj48L2NpcmNsZT4KICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-filter-list: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTEwIDE4aDR2LTJoLTR2MnpNMyA2djJoMThWNkgzem0zIDdoMTJ2LTJINnYyeiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-filter: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiNGRkYiPgogICAgPHBhdGggZD0iTTE0LDEyVjE5Ljg4QzE0LjA0LDIwLjE4IDEzLjk0LDIwLjUgMTMuNzEsMjAuNzFDMTMuMzIsMjEuMSAxMi42OSwyMS4xIDEyLjMsMjAuNzFMMTAuMjksMTguN0MxMC4wNiwxOC40NyA5Ljk2LDE4LjE2IDEwLDE3Ljg3VjEySDkuOTdMNC4yMSw0LjYyQzMuODcsNC4xOSAzLjk1LDMuNTYgNC4zOCwzLjIyQzQuNTcsMy4wOCA0Ljc4LDMgNSwzVjNIMTlWM0MxOS4yMiwzIDE5LjQzLDMuMDggMTkuNjIsMy4yMkMyMC4wNSwzLjU2IDIwLjEzLDQuMTkgMTkuNzksNC42MkwxNC4wMywxMkgxNFoiIC8+CiAgPC9nPgo8L3N2Zz4K);
  --jp-icon-folder-favorite: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjRweCIgdmlld0JveD0iMCAwIDI0IDI0IiB3aWR0aD0iMjRweCIgZmlsbD0iIzAwMDAwMCI+CiAgPHBhdGggZD0iTTAgMGgyNHYyNEgwVjB6IiBmaWxsPSJub25lIi8+PHBhdGggY2xhc3M9ImpwLWljb24zIGpwLWljb24tc2VsZWN0YWJsZSIgZmlsbD0iIzYxNjE2MSIgZD0iTTIwIDZoLThsLTItMkg0Yy0xLjEgMC0yIC45LTIgMnYxMmMwIDEuMS45IDIgMiAyaDE2YzEuMSAwIDItLjkgMi0yVjhjMC0xLjEtLjktMi0yLTJ6bS0yLjA2IDExTDE1IDE1LjI4IDEyLjA2IDE3bC43OC0zLjMzLTIuNTktMi4yNCAzLjQxLS4yOUwxNSA4bDEuMzQgMy4xNCAzLjQxLjI5LTIuNTkgMi4yNC43OCAzLjMzeiIvPgo8L3N2Zz4K);
  --jp-icon-folder: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8cGF0aCBjbGFzcz0ianAtaWNvbjMganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjNjE2MTYxIiBkPSJNMTAgNEg0Yy0xLjEgMC0xLjk5LjktMS45OSAyTDIgMThjMCAxLjEuOSAyIDIgMmgxNmMxLjEgMCAyLS45IDItMlY4YzAtMS4xLS45LTItMi0yaC04bC0yLTJ6Ii8+Cjwvc3ZnPgo=);
  --jp-icon-home: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjRweCIgdmlld0JveD0iMCAwIDI0IDI0IiB3aWR0aD0iMjRweCIgZmlsbD0iIzAwMDAwMCI+CiAgPHBhdGggZD0iTTAgMGgyNHYyNEgweiIgZmlsbD0ibm9uZSIvPjxwYXRoIGNsYXNzPSJqcC1pY29uMyBqcC1pY29uLXNlbGVjdGFibGUiIGZpbGw9IiM2MTYxNjEiIGQ9Ik0xMCAyMHYtNmg0djZoNXYtOGgzTDEyIDMgMiAxMmgzdjh6Ii8+Cjwvc3ZnPgo=);
  --jp-icon-html5: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDUxMiA1MTIiPgogIDxwYXRoIGNsYXNzPSJqcC1pY29uMCBqcC1pY29uLXNlbGVjdGFibGUiIGZpbGw9IiMwMDAiIGQ9Ik0xMDguNCAwaDIzdjIyLjhoMjEuMlYwaDIzdjY5aC0yM1Y0NmgtMjF2MjNoLTIzLjJNMjA2IDIzaC0yMC4zVjBoNjMuN3YyM0gyMjl2NDZoLTIzbTUzLjUtNjloMjQuMWwxNC44IDI0LjNMMzEzLjIgMGgyNC4xdjY5aC0yM1YzNC44bC0xNi4xIDI0LjgtMTYuMS0yNC44VjY5aC0yMi42bTg5LjItNjloMjN2NDYuMmgzMi42VjY5aC01NS42Ii8+CiAgPHBhdGggY2xhc3M9ImpwLWljb24tc2VsZWN0YWJsZSIgZmlsbD0iI2U0NGQyNiIgZD0iTTEwNy42IDQ3MWwtMzMtMzcwLjRoMzYyLjhsLTMzIDM3MC4yTDI1NS43IDUxMiIvPgogIDxwYXRoIGNsYXNzPSJqcC1pY29uLXNlbGVjdGFibGUiIGZpbGw9IiNmMTY1MjkiIGQ9Ik0yNTYgNDgwLjVWMTMxaDE0OC4zTDM3NiA0NDciLz4KICA8cGF0aCBjbGFzcz0ianAtaWNvbi1zZWxlY3RhYmxlLWludmVyc2UiIGZpbGw9IiNlYmViZWIiIGQ9Ik0xNDIgMTc2LjNoMTE0djQ1LjRoLTY0LjJsNC4yIDQ2LjVoNjB2NDUuM0gxNTQuNG0yIDIyLjhIMjAybDMuMiAzNi4zIDUwLjggMTMuNnY0Ny40bC05My4yLTI2Ii8+CiAgPHBhdGggY2xhc3M9ImpwLWljb24tc2VsZWN0YWJsZS1pbnZlcnNlIiBmaWxsPSIjZmZmIiBkPSJNMzY5LjYgMTc2LjNIMjU1Ljh2NDUuNGgxMDkuNm0tNC4xIDQ2LjVIMjU1Ljh2NDUuNGg1NmwtNS4zIDU5LTUwLjcgMTMuNnY0Ny4ybDkzLTI1LjgiLz4KPC9zdmc+Cg==);
  --jp-icon-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIyIDIyIj4KICA8cGF0aCBjbGFzcz0ianAtaWNvbi1icmFuZDQganAtaWNvbi1zZWxlY3RhYmxlLWludmVyc2UiIGZpbGw9IiNGRkYiIGQ9Ik0yLjIgMi4yaDE3LjV2MTcuNUgyLjJ6Ii8+CiAgPHBhdGggY2xhc3M9ImpwLWljb24tYnJhbmQwIGpwLWljb24tc2VsZWN0YWJsZSIgZmlsbD0iIzNGNTFCNSIgZD0iTTIuMiAyLjJ2MTcuNWgxNy41bC4xLTE3LjVIMi4yem0xMi4xIDIuMmMxLjIgMCAyLjIgMSAyLjIgMi4ycy0xIDIuMi0yLjIgMi4yLTIuMi0xLTIuMi0yLjIgMS0yLjIgMi4yLTIuMnpNNC40IDE3LjZsMy4zLTguOCAzLjMgNi42IDIuMi0zLjIgNC40IDUuNEg0LjR6Ii8+Cjwvc3ZnPgo=);
  --jp-icon-info: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDUwLjk3OCA1MC45NzgiPgoJPGcgY2xhc3M9ImpwLWljb24zIiBmaWxsPSIjNjE2MTYxIj4KCQk8cGF0aCBkPSJNNDMuNTIsNy40NThDMzguNzExLDIuNjQ4LDMyLjMwNywwLDI1LjQ4OSwwQzE4LjY3LDAsMTIuMjY2LDIuNjQ4LDcuNDU4LDcuNDU4CgkJCWMtOS45NDMsOS45NDEtOS45NDMsMjYuMTE5LDAsMzYuMDYyYzQuODA5LDQuODA5LDExLjIxMiw3LjQ1NiwxOC4wMzEsNy40NThjMCwwLDAuMDAxLDAsMC4wMDIsMAoJCQljNi44MTYsMCwxMy4yMjEtMi42NDgsMTguMDI5LTcuNDU4YzQuODA5LTQuODA5LDcuNDU3LTExLjIxMiw3LjQ1Ny0xOC4wM0M1MC45NzcsMTguNjcsNDguMzI4LDEyLjI2Niw0My41Miw3LjQ1OHoKCQkJIE00Mi4xMDYsNDIuMTA1Yy00LjQzMiw0LjQzMS0xMC4zMzIsNi44NzItMTYuNjE1LDYuODcyaC0wLjAwMmMtNi4yODUtMC4wMDEtMTIuMTg3LTIuNDQxLTE2LjYxNy02Ljg3MgoJCQljLTkuMTYyLTkuMTYzLTkuMTYyLTI0LjA3MSwwLTMzLjIzM0MxMy4zMDMsNC40NCwxOS4yMDQsMiwyNS40ODksMmM2LjI4NCwwLDEyLjE4NiwyLjQ0LDE2LjYxNyw2Ljg3MgoJCQljNC40MzEsNC40MzEsNi44NzEsMTAuMzMyLDYuODcxLDE2LjYxN0M0OC45NzcsMzEuNzcyLDQ2LjUzNiwzNy42NzUsNDIuMTA2LDQyLjEwNXoiLz4KCQk8cGF0aCBkPSJNMjMuNTc4LDMyLjIxOGMtMC4wMjMtMS43MzQsMC4xNDMtMy4wNTksMC40OTYtMy45NzJjMC4zNTMtMC45MTMsMS4xMS0xLjk5NywyLjI3Mi0zLjI1MwoJCQljMC40NjgtMC41MzYsMC45MjMtMS4wNjIsMS4zNjctMS41NzVjMC42MjYtMC43NTMsMS4xMDQtMS40NzgsMS40MzYtMi4xNzVjMC4zMzEtMC43MDcsMC40OTUtMS41NDEsMC40OTUtMi41CgkJCWMwLTEuMDk2LTAuMjYtMi4wODgtMC43NzktMi45NzljLTAuNTY1LTAuODc5LTEuNTAxLTEuMzM2LTIuODA2LTEuMzY5Yy0xLjgwMiwwLjA1Ny0yLjk4NSwwLjY2Ny0zLjU1LDEuODMyCgkJCWMtMC4zMDEsMC41MzUtMC41MDMsMS4xNDEtMC42MDcsMS44MTRjLTAuMTM5LDAuNzA3LTAuMjA3LDEuNDMyLTAuMjA3LDIuMTc0aC0yLjkzN2MtMC4wOTEtMi4yMDgsMC40MDctNC4xMTQsMS40OTMtNS43MTkKCQkJYzEuMDYyLTEuNjQsMi44NTUtMi40ODEsNS4zNzgtMi41MjdjMi4xNiwwLjAyMywzLjg3NCwwLjYwOCw1LjE0MSwxLjc1OGMxLjI3OCwxLjE2LDEuOTI5LDIuNzY0LDEuOTUsNC44MTEKCQkJYzAsMS4xNDItMC4xMzcsMi4xMTEtMC40MSwyLjkxMWMtMC4zMDksMC44NDUtMC43MzEsMS41OTMtMS4yNjgsMi4yNDNjLTAuNDkyLDAuNjUtMS4wNjgsMS4zMTgtMS43MywyLjAwMgoJCQljLTAuNjUsMC42OTctMS4zMTMsMS40NzktMS45ODcsMi4zNDZjLTAuMjM5LDAuMzc3LTAuNDI5LDAuNzc3LTAuNTY1LDEuMTk5Yy0wLjE2LDAuOTU5LTAuMjE3LDEuOTUxLTAuMTcxLDIuOTc5CgkJCUMyNi41ODksMzIuMjE4LDIzLjU3OCwzMi4yMTgsMjMuNTc4LDMyLjIxOHogTTIzLjU3OCwzOC4yMnYtMy40ODRoMy4wNzZ2My40ODRIMjMuNTc4eiIvPgoJPC9nPgo8L3N2Zz4K);
  --jp-icon-inspector: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8cGF0aCBjbGFzcz0ianAtaW5zcGVjdG9yLWljb24tY29sb3IganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjNjE2MTYxIiBkPSJNMjAgNEg0Yy0xLjEgMC0xLjk5LjktMS45OSAyTDIgMThjMCAxLjEuOSAyIDIgMmgxNmMxLjEgMCAyLS45IDItMlY2YzAtMS4xLS45LTItMi0yem0tNSAxNEg0di00aDExdjR6bTAtNUg0VjloMTF2NHptNSA1aC00VjloNHY5eiIvPgo8L3N2Zz4K);
  --jp-icon-json: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIyIDIyIj4KICA8ZyBjbGFzcz0ianAtanNvbi1pY29uLWNvbG9yIGpwLWljb24tc2VsZWN0YWJsZSIgZmlsbD0iI0Y5QTgyNSI+CiAgICA8cGF0aCBkPSJNMjAuMiAxMS44Yy0xLjYgMC0xLjcuNS0xLjcgMSAwIC40LjEuOS4xIDEuMy4xLjUuMS45LjEgMS4zIDAgMS43LTEuNCAyLjMtMy41IDIuM2gtLjl2LTEuOWguNWMxLjEgMCAxLjQgMCAxLjQtLjggMC0uMyAwLS42LS4xLTEgMC0uNC0uMS0uOC0uMS0xLjIgMC0xLjMgMC0xLjggMS4zLTItMS4zLS4yLTEuMy0uNy0xLjMtMiAwLS40LjEtLjguMS0xLjIuMS0uNC4xLS43LjEtMSAwLS44LS40LS43LTEuNC0uOGgtLjVWNC4xaC45YzIuMiAwIDMuNS43IDMuNSAyLjMgMCAuNC0uMS45LS4xIDEuMy0uMS41LS4xLjktLjEgMS4zIDAgLjUuMiAxIDEuNyAxdjEuOHpNMS44IDEwLjFjMS42IDAgMS43LS41IDEuNy0xIDAtLjQtLjEtLjktLjEtMS4zLS4xLS41LS4xLS45LS4xLTEuMyAwLTEuNiAxLjQtMi4zIDMuNS0yLjNoLjl2MS45aC0uNWMtMSAwLTEuNCAwLTEuNC44IDAgLjMgMCAuNi4xIDEgMCAuMi4xLjYuMSAxIDAgMS4zIDAgMS44LTEuMyAyQzYgMTEuMiA2IDExLjcgNiAxM2MwIC40LS4xLjgtLjEgMS4yLS4xLjMtLjEuNy0uMSAxIDAgLjguMy44IDEuNC44aC41djEuOWgtLjljLTIuMSAwLTMuNS0uNi0zLjUtMi4zIDAtLjQuMS0uOS4xLTEuMy4xLS41LjEtLjkuMS0xLjMgMC0uNS0uMi0xLTEuNy0xdi0xLjl6Ii8+CiAgICA8Y2lyY2xlIGN4PSIxMSIgY3k9IjEzLjgiIHI9IjIuMSIvPgogICAgPGNpcmNsZSBjeD0iMTEiIGN5PSI4LjIiIHI9IjIuMSIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-julia: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDMyNSAzMDAiPgogIDxnIGNsYXNzPSJqcC1icmFuZDAganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjY2IzYzMzIj4KICAgIDxwYXRoIGQ9Ik0gMTUwLjg5ODQzOCAyMjUgQyAxNTAuODk4NDM4IDI2Ni40MjE4NzUgMTE3LjMyMDMxMiAzMDAgNzUuODk4NDM4IDMwMCBDIDM0LjQ3NjU2MiAzMDAgMC44OTg0MzggMjY2LjQyMTg3NSAwLjg5ODQzOCAyMjUgQyAwLjg5ODQzOCAxODMuNTc4MTI1IDM0LjQ3NjU2MiAxNTAgNzUuODk4NDM4IDE1MCBDIDExNy4zMjAzMTIgMTUwIDE1MC44OTg0MzggMTgzLjU3ODEyNSAxNTAuODk4NDM4IDIyNSIvPgogIDwvZz4KICA8ZyBjbGFzcz0ianAtYnJhbmQwIGpwLWljb24tc2VsZWN0YWJsZSIgZmlsbD0iIzM4OTgyNiI+CiAgICA8cGF0aCBkPSJNIDIzNy41IDc1IEMgMjM3LjUgMTE2LjQyMTg3NSAyMDMuOTIxODc1IDE1MCAxNjIuNSAxNTAgQyAxMjEuMDc4MTI1IDE1MCA4Ny41IDExNi40MjE4NzUgODcuNSA3NSBDIDg3LjUgMzMuNTc4MTI1IDEyMS4wNzgxMjUgMCAxNjIuNSAwIEMgMjAzLjkyMTg3NSAwIDIzNy41IDMzLjU3ODEyNSAyMzcuNSA3NSIvPgogIDwvZz4KICA8ZyBjbGFzcz0ianAtYnJhbmQwIGpwLWljb24tc2VsZWN0YWJsZSIgZmlsbD0iIzk1NThiMiI+CiAgICA8cGF0aCBkPSJNIDMyNC4xMDE1NjIgMjI1IEMgMzI0LjEwMTU2MiAyNjYuNDIxODc1IDI5MC41MjM0MzggMzAwIDI0OS4xMDE1NjIgMzAwIEMgMjA3LjY3OTY4OCAzMDAgMTc0LjEwMTU2MiAyNjYuNDIxODc1IDE3NC4xMDE1NjIgMjI1IEMgMTc0LjEwMTU2MiAxODMuNTc4MTI1IDIwNy42Nzk2ODggMTUwIDI0OS4xMDE1NjIgMTUwIEMgMjkwLjUyMzQzOCAxNTAgMzI0LjEwMTU2MiAxODMuNTc4MTI1IDMyNC4xMDE1NjIgMjI1Ii8+CiAgPC9nPgo8L3N2Zz4K);
  --jp-icon-jupyter-favicon: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUyIiBoZWlnaHQ9IjE2NSIgdmlld0JveD0iMCAwIDE1MiAxNjUiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgPGcgY2xhc3M9ImpwLWp1cHl0ZXItaWNvbi1jb2xvciIgZmlsbD0iI0YzNzcyNiI+CiAgICA8cGF0aCB0cmFuc2Zvcm09InRyYW5zbGF0ZSgwLjA3ODk0NywgMTEwLjU4MjkyNykiIGQ9Ik03NS45NDIyODQyLDI5LjU4MDQ1NjEgQzQzLjMwMjM5NDcsMjkuNTgwNDU2MSAxNC43OTY3ODMyLDE3LjY1MzQ2MzQgMCwwIEM1LjUxMDgzMjExLDE1Ljg0MDY4MjkgMTUuNzgxNTM4OSwyOS41NjY3NzMyIDI5LjM5MDQ5NDcsMzkuMjc4NDE3MSBDNDIuOTk5Nyw0OC45ODk4NTM3IDU5LjI3MzcsNTQuMjA2NzgwNSA3NS45NjA1Nzg5LDU0LjIwNjc4MDUgQzkyLjY0NzQ1NzksNTQuMjA2NzgwNSAxMDguOTIxNDU4LDQ4Ljk4OTg1MzcgMTIyLjUzMDY2MywzOS4yNzg0MTcxIEMxMzYuMTM5NDUzLDI5LjU2Njc3MzIgMTQ2LjQxMDI4NCwxNS44NDA2ODI5IDE1MS45MjExNTgsMCBDMTM3LjA4Nzg2OCwxNy42NTM0NjM0IDEwOC41ODI1ODksMjkuNTgwNDU2MSA3NS45NDIyODQyLDI5LjU4MDQ1NjEgTDc1Ljk0MjI4NDIsMjkuNTgwNDU2MSBaIiAvPgogICAgPHBhdGggdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMC4wMzczNjgsIDAuNzA0ODc4KSIgZD0iTTc1Ljk3ODQ1NzksMjQuNjI2NDA3MyBDMTA4LjYxODc2MywyNC42MjY0MDczIDEzNy4xMjQ0NTgsMzYuNTUzNDQxNSAxNTEuOTIxMTU4LDU0LjIwNjc4MDUgQzE0Ni40MTAyODQsMzguMzY2MjIyIDEzNi4xMzk0NTMsMjQuNjQwMTMxNyAxMjIuNTMwNjYzLDE0LjkyODQ4NzggQzEwOC45MjE0NTgsNS4yMTY4NDM5IDkyLjY0NzQ1NzksMCA3NS45NjA1Nzg5LDAgQzU5LjI3MzcsMCA0Mi45OTk3LDUuMjE2ODQzOSAyOS4zOTA0OTQ3LDE0LjkyODQ4NzggQzE1Ljc4MTUzODksMjQuNjQwMTMxNyA1LjUxMDgzMjExLDM4LjM2NjIyMiAwLDU0LjIwNjc4MDUgQzE0LjgzMzA4MTYsMzYuNTg5OTI5MyA0My4zMzg1Njg0LDI0LjYyNjQwNzMgNzUuOTc4NDU3OSwyNC42MjY0MDczIEw3NS45Nzg0NTc5LDI0LjYyNjQwNzMgWiIgLz4KICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-jupyter: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzkiIGhlaWdodD0iNTEiIHZpZXdCb3g9IjAgMCAzOSA1MSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMTYzOCAtMjI4MSkiPgogICAgIDxnIGNsYXNzPSJqcC1qdXB5dGVyLWljb24tY29sb3IiIGZpbGw9IiNGMzc3MjYiPgogICAgICA8cGF0aCB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxNjM5Ljc0IDIzMTEuOTgpIiBkPSJNIDE4LjI2NDYgNy4xMzQxMUMgMTAuNDE0NSA3LjEzNDExIDMuNTU4NzIgNC4yNTc2IDAgMEMgMS4zMjUzOSAzLjgyMDQgMy43OTU1NiA3LjEzMDgxIDcuMDY4NiA5LjQ3MzAzQyAxMC4zNDE3IDExLjgxNTIgMTQuMjU1NyAxMy4wNzM0IDE4LjI2OSAxMy4wNzM0QyAyMi4yODIzIDEzLjA3MzQgMjYuMTk2MyAxMS44MTUyIDI5LjQ2OTQgOS40NzMwM0MgMzIuNzQyNCA3LjEzMDgxIDM1LjIxMjYgMy44MjA0IDM2LjUzOCAwQyAzMi45NzA1IDQuMjU3NiAyNi4xMTQ4IDcuMTM0MTEgMTguMjY0NiA3LjEzNDExWiIvPgogICAgICA8cGF0aCB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxNjM5LjczIDIyODUuNDgpIiBkPSJNIDE4LjI3MzMgNS45MzkzMUMgMjYuMTIzNSA1LjkzOTMxIDMyLjk3OTMgOC44MTU4MyAzNi41MzggMTMuMDczNEMgMzUuMjEyNiA5LjI1MzAzIDMyLjc0MjQgNS45NDI2MiAyOS40Njk0IDMuNjAwNEMgMjYuMTk2MyAxLjI1ODE4IDIyLjI4MjMgMCAxOC4yNjkgMEMgMTQuMjU1NyAwIDEwLjM0MTcgMS4yNTgxOCA3LjA2ODYgMy42MDA0QyAzLjc5NTU2IDUuOTQyNjIgMS4zMjUzOSA5LjI1MzAzIDAgMTMuMDczNEMgMy41Njc0NSA4LjgyNDYzIDEwLjQyMzIgNS45MzkzMSAxOC4yNzMzIDUuOTM5MzFaIi8+CiAgICA8L2c+CiAgICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgICA8cGF0aCB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxNjY5LjMgMjI4MS4zMSkiIGQ9Ik0gNS44OTM1MyAyLjg0NEMgNS45MTg4OSAzLjQzMTY1IDUuNzcwODUgNC4wMTM2NyA1LjQ2ODE1IDQuNTE2NDVDIDUuMTY1NDUgNS4wMTkyMiA0LjcyMTY4IDUuNDIwMTUgNC4xOTI5OSA1LjY2ODUxQyAzLjY2NDMgNS45MTY4OCAzLjA3NDQ0IDYuMDAxNTEgMi40OTgwNSA1LjkxMTcxQyAxLjkyMTY2IDUuODIxOSAxLjM4NDYzIDUuNTYxNyAwLjk1NDg5OCA1LjE2NDAxQyAwLjUyNTE3IDQuNzY2MzMgMC4yMjIwNTYgNC4yNDkwMyAwLjA4MzkwMzcgMy42Nzc1N0MgLTAuMDU0MjQ4MyAzLjEwNjExIC0wLjAyMTIzIDIuNTA2MTcgMC4xNzg3ODEgMS45NTM2NEMgMC4zNzg3OTMgMS40MDExIDAuNzM2ODA5IDAuOTIwODE3IDEuMjA3NTQgMC41NzM1MzhDIDEuNjc4MjYgMC4yMjYyNTkgMi4yNDA1NSAwLjAyNzU5MTkgMi44MjMyNiAwLjAwMjY3MjI5QyAzLjYwMzg5IC0wLjAzMDcxMTUgNC4zNjU3MyAwLjI0OTc4OSA0Ljk0MTQyIDAuNzgyNTUxQyA1LjUxNzExIDEuMzE1MzEgNS44NTk1NiAyLjA1Njc2IDUuODkzNTMgMi44NDRaIi8+CiAgICAgIDxwYXRoIHRyYW5zZm9ybT0idHJhbnNsYXRlKDE2MzkuOCAyMzIzLjgxKSIgZD0iTSA3LjQyNzg5IDMuNTgzMzhDIDcuNDYwMDggNC4zMjQzIDcuMjczNTUgNS4wNTgxOSA2Ljg5MTkzIDUuNjkyMTNDIDYuNTEwMzEgNi4zMjYwNyA1Ljk1MDc1IDYuODMxNTYgNS4yODQxMSA3LjE0NDZDIDQuNjE3NDcgNy40NTc2MyAzLjg3MzcxIDcuNTY0MTQgMy4xNDcwMiA3LjQ1MDYzQyAyLjQyMDMyIDcuMzM3MTIgMS43NDMzNiA3LjAwODcgMS4yMDE4NCA2LjUwNjk1QyAwLjY2MDMyOCA2LjAwNTIgMC4yNzg2MSA1LjM1MjY4IDAuMTA1MDE3IDQuNjMyMDJDIC0wLjA2ODU3NTcgMy45MTEzNSAtMC4wMjYyMzYxIDMuMTU0OTQgMC4yMjY2NzUgMi40NTg1NkMgMC40Nzk1ODcgMS43NjIxNyAwLjkzMTY5NyAxLjE1NzEzIDEuNTI1NzYgMC43MjAwMzNDIDIuMTE5ODMgMC4yODI5MzUgMi44MjkxNCAwLjAzMzQzOTUgMy41NjM4OSAwLjAwMzEzMzQ0QyA0LjU0NjY3IC0wLjAzNzQwMzMgNS41MDUyOSAwLjMxNjcwNiA2LjIyOTYxIDAuOTg3ODM1QyA2Ljk1MzkzIDEuNjU4OTYgNy4zODQ4NCAyLjU5MjM1IDcuNDI3ODkgMy41ODMzOEwgNy40Mjc4OSAzLjU4MzM4WiIvPgogICAgICA8cGF0aCB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxNjM4LjM2IDIyODYuMDYpIiBkPSJNIDIuMjc0NzEgNC4zOTYyOUMgMS44NDM2MyA0LjQxNTA4IDEuNDE2NzEgNC4zMDQ0NSAxLjA0Nzk5IDQuMDc4NDNDIDAuNjc5MjY4IDMuODUyNCAwLjM4NTMyOCAzLjUyMTE0IDAuMjAzMzcxIDMuMTI2NTZDIDAuMDIxNDEzNiAyLjczMTk4IC0wLjA0MDM3OTggMi4yOTE4MyAwLjAyNTgxMTYgMS44NjE4MUMgMC4wOTIwMDMxIDEuNDMxOCAwLjI4MzIwNCAxLjAzMTI2IDAuNTc1MjEzIDAuNzEwODgzQyAwLjg2NzIyMiAwLjM5MDUxIDEuMjQ2OTEgMC4xNjQ3MDggMS42NjYyMiAwLjA2MjA1OTJDIDIuMDg1NTMgLTAuMDQwNTg5NyAyLjUyNTYxIC0wLjAxNTQ3MTQgMi45MzA3NiAwLjEzNDIzNUMgMy4zMzU5MSAwLjI4Mzk0MSAzLjY4NzkyIDAuNTUxNTA1IDMuOTQyMjIgMC45MDMwNkMgNC4xOTY1MiAxLjI1NDYyIDQuMzQxNjkgMS42NzQzNiA0LjM1OTM1IDIuMTA5MTZDIDQuMzgyOTkgMi42OTEwNyA0LjE3Njc4IDMuMjU4NjkgMy43ODU5NyAzLjY4NzQ2QyAzLjM5NTE2IDQuMTE2MjQgMi44NTE2NiA0LjM3MTE2IDIuMjc0NzEgNC4zOTYyOUwgMi4yNzQ3MSA0LjM5NjI5WiIvPgogICAgPC9nPgogIDwvZz4+Cjwvc3ZnPgo=);
  --jp-icon-jupyterlab-wordmark: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIHZpZXdCb3g9IjAgMCAxODYwLjggNDc1Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjIiIGZpbGw9IiM0RTRFNEUiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDQ4MC4xMzY0MDEsIDY0LjI3MTQ5MykiPgogICAgPGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMC4wMDAwMDAsIDU4Ljg3NTU2NikiPgogICAgICA8ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgwLjA4NzYwMywgMC4xNDAyOTQpIj4KICAgICAgICA8cGF0aCBkPSJNLTQyNi45LDE2OS44YzAsNDguNy0zLjcsNjQuNy0xMy42LDc2LjRjLTEwLjgsMTAtMjUsMTUuNS0zOS43LDE1LjVsMy43LDI5IGMyMi44LDAuMyw0NC44LTcuOSw2MS45LTIzLjFjMTcuOC0xOC41LDI0LTQ0LjEsMjQtODMuM1YwSC00Mjd2MTcwLjFMLTQyNi45LDE2OS44TC00MjYuOSwxNjkuOHoiLz4KICAgICAgPC9nPgogICAgPC9nPgogICAgPGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTU1LjA0NTI5NiwgNTYuODM3MTA0KSI+CiAgICAgIDxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDEuNTYyNDUzLCAxLjc5OTg0MikiPgogICAgICAgIDxwYXRoIGQ9Ik0tMzEyLDE0OGMwLDIxLDAsMzkuNSwxLjcsNTUuNGgtMzEuOGwtMi4xLTMzLjNoLTAuOGMtNi43LDExLjYtMTYuNCwyMS4zLTI4LDI3LjkgYy0xMS42LDYuNi0yNC44LDEwLTM4LjIsOS44Yy0zMS40LDAtNjktMTcuNy02OS04OVYwaDM2LjR2MTEyLjdjMCwzOC43LDExLjYsNjQuNyw0NC42LDY0LjdjMTAuMy0wLjIsMjAuNC0zLjUsMjguOS05LjQgYzguNS01LjksMTUuMS0xNC4zLDE4LjktMjMuOWMyLjItNi4xLDMuMy0xMi41LDMuMy0xOC45VjAuMmgzNi40VjE0OEgtMzEyTC0zMTIsMTQ4eiIvPgogICAgICA8L2c+CiAgICA8L2c+CiAgICA8ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgzOTAuMDEzMzIyLCA1My40Nzk2MzgpIj4KICAgICAgPGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMS43MDY0NTgsIDAuMjMxNDI1KSI+CiAgICAgICAgPHBhdGggZD0iTS00NzguNiw3MS40YzAtMjYtMC44LTQ3LTEuNy02Ni43aDMyLjdsMS43LDM0LjhoMC44YzcuMS0xMi41LDE3LjUtMjIuOCwzMC4xLTI5LjcgYzEyLjUtNywyNi43LTEwLjMsNDEtOS44YzQ4LjMsMCw4NC43LDQxLjcsODQuNywxMDMuM2MwLDczLjEtNDMuNywxMDkuMi05MSwxMDkuMmMtMTIuMSwwLjUtMjQuMi0yLjItMzUtNy44IGMtMTAuOC01LjYtMTkuOS0xMy45LTI2LjYtMjQuMmgtMC44VjI5MWgtMzZ2LTIyMEwtNDc4LjYsNzEuNEwtNDc4LjYsNzEuNHogTS00NDIuNiwxMjUuNmMwLjEsNS4xLDAuNiwxMC4xLDEuNywxNS4xIGMzLDEyLjMsOS45LDIzLjMsMTkuOCwzMS4xYzkuOSw3LjgsMjIuMSwxMi4xLDM0LjcsMTIuMWMzOC41LDAsNjAuNy0zMS45LDYwLjctNzguNWMwLTQwLjctMjEuMS03NS42LTU5LjUtNzUuNiBjLTEyLjksMC40LTI1LjMsNS4xLTM1LjMsMTMuNGMtOS45LDguMy0xNi45LDE5LjctMTkuNiwzMi40Yy0xLjUsNC45LTIuMywxMC0yLjUsMTUuMVYxMjUuNkwtNDQyLjYsMTI1LjZMLTQ0Mi42LDEyNS42eiIvPgogICAgICA8L2c+CiAgICA8L2c+CiAgICA8ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSg2MDYuNzQwNzI2LCA1Ni44MzcxMDQpIj4KICAgICAgPGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMC43NTEyMjYsIDEuOTg5Mjk5KSI+CiAgICAgICAgPHBhdGggZD0iTS00NDAuOCwwbDQzLjcsMTIwLjFjNC41LDEzLjQsOS41LDI5LjQsMTIuOCw0MS43aDAuOGMzLjctMTIuMiw3LjktMjcuNywxMi44LTQyLjQgbDM5LjctMTE5LjJoMzguNUwtMzQ2LjksMTQ1Yy0yNiw2OS43LTQzLjcsMTA1LjQtNjguNiwxMjcuMmMtMTIuNSwxMS43LTI3LjksMjAtNDQuNiwyMy45bC05LjEtMzEuMSBjMTEuNy0zLjksMjIuNS0xMC4xLDMxLjgtMTguMWMxMy4yLTExLjEsMjMuNy0yNS4yLDMwLjYtNDEuMmMxLjUtMi44LDIuNS01LjcsMi45LTguOGMtMC4zLTMuMy0xLjItNi42LTIuNS05LjdMLTQ4MC4yLDAuMSBoMzkuN0wtNDQwLjgsMEwtNDQwLjgsMHoiLz4KICAgICAgPC9nPgogICAgPC9nPgogICAgPGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoODIyLjc0ODEwNCwgMC4wMDAwMDApIj4KICAgICAgPGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMS40NjQwNTAsIDAuMzc4OTE0KSI+CiAgICAgICAgPHBhdGggZD0iTS00MTMuNywwdjU4LjNoNTJ2MjguMmgtNTJWMTk2YzAsMjUsNywzOS41LDI3LjMsMzkuNWM3LjEsMC4xLDE0LjItMC43LDIxLjEtMi41IGwxLjcsMjcuN2MtMTAuMywzLjctMjEuMyw1LjQtMzIuMiw1Yy03LjMsMC40LTE0LjYtMC43LTIxLjMtMy40Yy02LjgtMi43LTEyLjktNi44LTE3LjktMTIuMWMtMTAuMy0xMC45LTE0LjEtMjktMTQuMS01Mi45IFY4Ni41aC0zMVY1OC4zaDMxVjkuNkwtNDEzLjcsMEwtNDEzLjcsMHoiLz4KICAgICAgPC9nPgogICAgPC9nPgogICAgPGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoOTc0LjQzMzI4NiwgNTMuNDc5NjM4KSI+CiAgICAgIDxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDAuOTkwMDM0LCAwLjYxMDMzOSkiPgogICAgICAgIDxwYXRoIGQ9Ik0tNDQ1LjgsMTEzYzAuOCw1MCwzMi4yLDcwLjYsNjguNiw3MC42YzE5LDAuNiwzNy45LTMsNTUuMy0xMC41bDYuMiwyNi40IGMtMjAuOSw4LjktNDMuNSwxMy4xLTY2LjIsMTIuNmMtNjEuNSwwLTk4LjMtNDEuMi05OC4zLTEwMi41Qy00ODAuMiw0OC4yLTQ0NC43LDAtMzg2LjUsMGM2NS4yLDAsODIuNyw1OC4zLDgyLjcsOTUuNyBjLTAuMSw1LjgtMC41LDExLjUtMS4yLDE3LjJoLTE0MC42SC00NDUuOEwtNDQ1LjgsMTEzeiBNLTMzOS4yLDg2LjZjMC40LTIzLjUtOS41LTYwLjEtNTAuNC02MC4xIGMtMzYuOCwwLTUyLjgsMzQuNC01NS43LDYwLjFILTMzOS4yTC0zMzkuMiw4Ni42TC0zMzkuMiw4Ni42eiIvPgogICAgICA8L2c+CiAgICA8L2c+CiAgICA8ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMjAxLjk2MTA1OCwgNTMuNDc5NjM4KSI+CiAgICAgIDxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDEuMTc5NjQwLCAwLjcwNTA2OCkiPgogICAgICAgIDxwYXRoIGQ9Ik0tNDc4LjYsNjhjMC0yMy45LTAuNC00NC41LTEuNy02My40aDMxLjhsMS4yLDM5LjloMS43YzkuMS0yNy4zLDMxLTQ0LjUsNTUuMy00NC41IGMzLjUtMC4xLDcsMC40LDEwLjMsMS4ydjM0LjhjLTQuMS0wLjktOC4yLTEuMy0xMi40LTEuMmMtMjUuNiwwLTQzLjcsMTkuNy00OC43LDQ3LjRjLTEsNS43LTEuNiwxMS41LTEuNywxNy4ydjEwOC4zaC0zNlY2OCBMLTQ3OC42LDY4eiIvPgogICAgICA8L2c+CiAgICA8L2c+CiAgPC9nPgoKICA8ZyBjbGFzcz0ianAtaWNvbi13YXJuMCIgZmlsbD0iI0YzNzcyNiI+CiAgICA8cGF0aCBkPSJNMTM1Mi4zLDMyNi4yaDM3VjI4aC0zN1YzMjYuMnogTTE2MDQuOCwzMjYuMmMtMi41LTEzLjktMy40LTMxLjEtMy40LTQ4Ljd2LTc2IGMwLTQwLjctMTUuMS04My4xLTc3LjMtODMuMWMtMjUuNiwwLTUwLDcuMS02Ni44LDE4LjFsOC40LDI0LjRjMTQuMy05LjIsMzQtMTUuMSw1My0xNS4xYzQxLjYsMCw0Ni4yLDMwLjIsNDYuMiw0N3Y0LjIgYy03OC42LTAuNC0xMjIuMywyNi41LTEyMi4zLDc1LjZjMCwyOS40LDIxLDU4LjQsNjIuMiw1OC40YzI5LDAsNTAuOS0xNC4zLDYyLjItMzAuMmgxLjNsMi45LDI1LjZIMTYwNC44eiBNMTU2NS43LDI1Ny43IGMwLDMuOC0wLjgsOC0yLjEsMTEuOGMtNS45LDE3LjItMjIuNywzNC00OS4yLDM0Yy0xOC45LDAtMzQuOS0xMS4zLTM0LjktMzUuM2MwLTM5LjUsNDUuOC00Ni42LDg2LjItNDUuOFYyNTcuN3ogTTE2OTguNSwzMjYuMiBsMS43LTMzLjZoMS4zYzE1LjEsMjYuOSwzOC43LDM4LjIsNjguMSwzOC4yYzQ1LjQsMCw5MS4yLTM2LjEsOTEuMi0xMDguOGMwLjQtNjEuNy0zNS4zLTEwMy43LTg1LjctMTAzLjcgYy0zMi44LDAtNTYuMywxNC43LTY5LjMsMzcuNGgtMC44VjI4aC0zNi42djI0NS43YzAsMTguMS0wLjgsMzguNi0xLjcsNTIuNUgxNjk4LjV6IE0xNzA0LjgsMjA4LjJjMC01LjksMS4zLTEwLjksMi4xLTE1LjEgYzcuNi0yOC4xLDMxLjEtNDUuNCw1Ni4zLTQ1LjRjMzkuNSwwLDYwLjUsMzQuOSw2MC41LDc1LjZjMCw0Ni42LTIzLjEsNzguMS02MS44LDc4LjFjLTI2LjksMC00OC4zLTE3LjYtNTUuNS00My4zIGMtMC44LTQuMi0xLjctOC44LTEuNy0xMy40VjIwOC4yeiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-kernel: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICAgIDxwYXRoIGNsYXNzPSJqcC1pY29uMiIgZmlsbD0iIzYxNjE2MSIgZD0iTTE1IDlIOXY2aDZWOXptLTIgNGgtMnYtMmgydjJ6bTgtMlY5aC0yVjdjMC0xLjEtLjktMi0yLTJoLTJWM2gtMnYyaC0yVjNIOXYySDdjLTEuMSAwLTIgLjktMiAydjJIM3YyaDJ2MkgzdjJoMnYyYzAgMS4xLjkgMiAyIDJoMnYyaDJ2LTJoMnYyaDJ2LTJoMmMxLjEgMCAyLS45IDItMnYtMmgydi0yaC0ydi0yaDJ6bS00IDZIN1Y3aDEwdjEweiIvPgo8L3N2Zz4K);
  --jp-icon-keyboard: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8cGF0aCBjbGFzcz0ianAtaWNvbjMganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjNjE2MTYxIiBkPSJNMjAgNUg0Yy0xLjEgMC0xLjk5LjktMS45OSAyTDIgMTdjMCAxLjEuOSAyIDIgMmgxNmMxLjEgMCAyLS45IDItMlY3YzAtMS4xLS45LTItMi0yem0tOSAzaDJ2MmgtMlY4em0wIDNoMnYyaC0ydi0yek04IDhoMnYySDhWOHptMCAzaDJ2Mkg4di0yem0tMSAySDV2LTJoMnYyem0wLTNINVY4aDJ2MnptOSA3SDh2LTJoOHYyem0wLTRoLTJ2LTJoMnYyem0wLTNoLTJWOGgydjJ6bTMgM2gtMnYtMmgydjJ6bTAtM2gtMlY4aDJ2MnoiLz4KPC9zdmc+Cg==);
  --jp-icon-launch: url(data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMzIgMzIiIHdpZHRoPSIzMiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbjMganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjNjE2MTYxIj4KICAgIDxwYXRoIGQ9Ik0yNiwyOEg2YTIuMDAyNywyLjAwMjcsMCwwLDEtMi0yVjZBMi4wMDI3LDIuMDAyNywwLDAsMSw2LDRIMTZWNkg2VjI2SDI2VjE2aDJWMjZBMi4wMDI3LDIuMDAyNywwLDAsMSwyNiwyOFoiLz4KICAgIDxwb2x5Z29uIHBvaW50cz0iMjAgMiAyMCA0IDI2LjU4NiA0IDE4IDEyLjU4NiAxOS40MTQgMTQgMjggNS40MTQgMjggMTIgMzAgMTIgMzAgMiAyMCAyIi8+CiAgPC9nPgo8L3N2Zz4K);
  --jp-icon-launcher: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8cGF0aCBjbGFzcz0ianAtaWNvbjMganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjNjE2MTYxIiBkPSJNMTkgMTlINVY1aDdWM0g1YTIgMiAwIDAwLTIgMnYxNGEyIDIgMCAwMDIgMmgxNGMxLjEgMCAyLS45IDItMnYtN2gtMnY3ek0xNCAzdjJoMy41OWwtOS44MyA5LjgzIDEuNDEgMS40MUwxOSA2LjQxVjEwaDJWM2gtN3oiLz4KPC9zdmc+Cg==);
  --jp-icon-line-form: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICAgIDxwYXRoIGZpbGw9IndoaXRlIiBkPSJNNS44OCA0LjEyTDEzLjc2IDEybC03Ljg4IDcuODhMOCAyMmwxMC0xMEw4IDJ6Ii8+Cjwvc3ZnPgo=);
  --jp-icon-link: url(data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIxNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTMuOSAxMmMwLTEuNzEgMS4zOS0zLjEgMy4xLTMuMWg0VjdIN2MtMi43NiAwLTUgMi4yNC01IDVzMi4yNCA1IDUgNWg0di0xLjlIN2MtMS43MSAwLTMuMS0xLjM5LTMuMS0zLjF6TTggMTNoOHYtMkg4djJ6bTktNmgtNHYxLjloNGMxLjcxIDAgMy4xIDEuMzkgMy4xIDMuMXMtMS4zOSAzLjEtMy4xIDMuMWgtNFYxN2g0YzIuNzYgMCA1LTIuMjQgNS01cy0yLjI0LTUtNS01eiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-list: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICAgIDxwYXRoIGNsYXNzPSJqcC1pY29uMiBqcC1pY29uLXNlbGVjdGFibGUiIGZpbGw9IiM2MTYxNjEiIGQ9Ik0xOSA1djE0SDVWNWgxNG0xLjEtMkgzLjljLS41IDAtLjkuNC0uOS45djE2LjJjMCAuNC40LjkuOS45aDE2LjJjLjQgMCAuOS0uNS45LS45VjMuOWMwLS41LS41LS45LS45LS45ek0xMSA3aDZ2MmgtNlY3em0wIDRoNnYyaC02di0yem0wIDRoNnYyaC02ek03IDdoMnYySDd6bTAgNGgydjJIN3ptMCA0aDJ2Mkg3eiIvPgo8L3N2Zz4K);
  --jp-icon-markdown: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIyIDIyIj4KICA8cGF0aCBjbGFzcz0ianAtaWNvbi1jb250cmFzdDAganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjN0IxRkEyIiBkPSJNNSAxNC45aDEybC02LjEgNnptOS40LTYuOGMwLTEuMy0uMS0yLjktLjEtNC41LS40IDEuNC0uOSAyLjktMS4zIDQuM2wtMS4zIDQuM2gtMkw4LjUgNy45Yy0uNC0xLjMtLjctMi45LTEtNC4zLS4xIDEuNi0uMSAzLjItLjIgNC42TDcgMTIuNEg0LjhsLjctMTFoMy4zTDEwIDVjLjQgMS4yLjcgMi43IDEgMy45LjMtMS4yLjctMi42IDEtMy45bDEuMi0zLjdoMy4zbC42IDExaC0yLjRsLS4zLTQuMnoiLz4KPC9zdmc+Cg==);
  --jp-icon-move-down: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTQiIGhlaWdodD0iMTQiIHZpZXdCb3g9IjAgMCAxNCAxNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggY2xhc3M9ImpwLWljb24zIiBkPSJNMTIuNDcxIDcuNTI4OTlDMTIuNzYzMiA3LjIzNjg0IDEyLjc2MzIgNi43NjMxNiAxMi40NzEgNi40NzEwMVY2LjQ3MTAxQzEyLjE3OSA2LjE3OTA1IDExLjcwNTcgNi4xNzg4NCAxMS40MTM1IDYuNDcwNTRMNy43NSAxMC4xMjc1VjEuNzVDNy43NSAxLjMzNTc5IDcuNDE0MjEgMSA3IDFWMUM2LjU4NTc5IDEgNi4yNSAxLjMzNTc5IDYuMjUgMS43NVYxMC4xMjc1TDIuNTk3MjYgNi40NjgyMkMyLjMwMzM4IDYuMTczODEgMS44MjY0MSA2LjE3MzU5IDEuNTMyMjYgNi40Njc3NFY2LjQ2Nzc0QzEuMjM4MyA2Ljc2MTcgMS4yMzgzIDcuMjM4MyAxLjUzMjI2IDcuNTMyMjZMNi4yOTI4OSAxMi4yOTI5QzYuNjgzNDIgMTIuNjgzNCA3LjMxNjU4IDEyLjY4MzQgNy43MDcxMSAxMi4yOTI5TDEyLjQ3MSA3LjUyODk5WiIgZmlsbD0iIzYxNjE2MSIvPgo8L3N2Zz4K);
  --jp-icon-move-up: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTQiIGhlaWdodD0iMTQiIHZpZXdCb3g9IjAgMCAxNCAxNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggY2xhc3M9ImpwLWljb24zIiBkPSJNMS41Mjg5OSA2LjQ3MTAxQzEuMjM2ODQgNi43NjMxNiAxLjIzNjg0IDcuMjM2ODQgMS41Mjg5OSA3LjUyODk5VjcuNTI4OTlDMS44MjA5NSA3LjgyMDk1IDIuMjk0MjYgNy44MjExNiAyLjU4NjQ5IDcuNTI5NDZMNi4yNSAzLjg3MjVWMTIuMjVDNi4yNSAxMi42NjQyIDYuNTg1NzkgMTMgNyAxM1YxM0M3LjQxNDIxIDEzIDcuNzUgMTIuNjY0MiA3Ljc1IDEyLjI1VjMuODcyNUwxMS40MDI3IDcuNTMxNzhDMTEuNjk2NiA3LjgyNjE5IDEyLjE3MzYgNy44MjY0MSAxMi40Njc3IDcuNTMyMjZWNy41MzIyNkMxMi43NjE3IDcuMjM4MyAxMi43NjE3IDYuNzYxNyAxMi40Njc3IDYuNDY3NzRMNy43MDcxMSAxLjcwNzExQzcuMzE2NTggMS4zMTY1OCA2LjY4MzQyIDEuMzE2NTggNi4yOTI4OSAxLjcwNzExTDEuNTI4OTkgNi40NzEwMVoiIGZpbGw9IiM2MTYxNjEiLz4KPC9zdmc+Cg==);
  --jp-icon-new-folder: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTIwIDZoLThsLTItMkg0Yy0xLjExIDAtMS45OS44OS0xLjk5IDJMMiAxOGMwIDEuMTEuODkgMiAyIDJoMTZjMS4xMSAwIDItLjg5IDItMlY4YzAtMS4xMS0uODktMi0yLTJ6bS0xIDhoLTN2M2gtMnYtM2gtM3YtMmgzVjloMnYzaDN2MnoiLz4KICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-not-trusted: url(data:image/svg+xml;base64,PHN2ZyBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI1IDI1Ij4KICAgIDxwYXRoIGNsYXNzPSJqcC1pY29uMiIgc3Ryb2tlPSIjMzMzMzMzIiBzdHJva2Utd2lkdGg9IjIiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDMgMykiIGQ9Ik0xLjg2MDk0IDExLjQ0MDlDMC44MjY0NDggOC43NzAyNyAwLjg2Mzc3OSA2LjA1NzY0IDEuMjQ5MDcgNC4xOTkzMkMyLjQ4MjA2IDMuOTMzNDcgNC4wODA2OCAzLjQwMzQ3IDUuNjAxMDIgMi44NDQ5QzcuMjM1NDkgMi4yNDQ0IDguODU2NjYgMS41ODE1IDkuOTg3NiAxLjA5NTM5QzExLjA1OTcgMS41ODM0MSAxMi42MDk0IDIuMjQ0NCAxNC4yMTggMi44NDMzOUMxNS43NTAzIDMuNDEzOTQgMTcuMzk5NSAzLjk1MjU4IDE4Ljc1MzkgNC4yMTM4NUMxOS4xMzY0IDYuMDcxNzcgMTkuMTcwOSA4Ljc3NzIyIDE4LjEzOSAxMS40NDA5QzE3LjAzMDMgMTQuMzAzMiAxNC42NjY4IDE3LjE4NDQgOS45OTk5OSAxOC45MzU0QzUuMzMzMTkgMTcuMTg0NCAyLjk2OTY4IDE0LjMwMzIgMS44NjA5NCAxMS40NDA5WiIvPgogICAgPHBhdGggY2xhc3M9ImpwLWljb24yIiBzdHJva2U9IiMzMzMzMzMiIHN0cm9rZS13aWR0aD0iMiIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoOS4zMTU5MiA5LjMyMDMxKSIgZD0iTTcuMzY4NDIgMEwwIDcuMzY0NzkiLz4KICAgIDxwYXRoIGNsYXNzPSJqcC1pY29uMiIgc3Ryb2tlPSIjMzMzMzMzIiBzdHJva2Utd2lkdGg9IjIiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDkuMzE1OTIgMTYuNjgzNikgc2NhbGUoMSAtMSkiIGQ9Ik03LjM2ODQyIDBMMCA3LjM2NDc5Ii8+Cjwvc3ZnPgo=);
  --jp-icon-notebook: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIyIDIyIj4KICA8ZyBjbGFzcz0ianAtbm90ZWJvb2staWNvbi1jb2xvciBqcC1pY29uLXNlbGVjdGFibGUiIGZpbGw9IiNFRjZDMDAiPgogICAgPHBhdGggZD0iTTE4LjcgMy4zdjE1LjRIMy4zVjMuM2gxNS40bTEuNS0xLjVIMS44djE4LjNoMTguM2wuMS0xOC4zeiIvPgogICAgPHBhdGggZD0iTTE2LjUgMTYuNWwtNS40LTQuMy01LjYgNC4zdi0xMWgxMXoiLz4KICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-numbering: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjIiIGhlaWdodD0iMjIiIHZpZXdCb3g9IjAgMCAyOCAyOCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KCTxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSI+CgkJPHBhdGggZD0iTTQgMTlINlYxOS41SDVWMjAuNUg2VjIxSDRWMjJIN1YxOEg0VjE5Wk01IDEwSDZWNkg0VjdINVYxMFpNNCAxM0g1LjhMNCAxNS4xVjE2SDdWMTVINS4yTDcgMTIuOVYxMkg0VjEzWk05IDdWOUgyM1Y3SDlaTTkgMjFIMjNWMTlIOVYyMVpNOSAxNUgyM1YxM0g5VjE1WiIvPgoJPC9nPgo8L3N2Zz4K);
  --jp-icon-offline-bolt: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjE2Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTEyIDIuMDJjLTUuNTEgMC05Ljk4IDQuNDctOS45OCA5Ljk4czQuNDcgOS45OCA5Ljk4IDkuOTggOS45OC00LjQ3IDkuOTgtOS45OFMxNy41MSAyLjAyIDEyIDIuMDJ6TTExLjQ4IDIwdi02LjI2SDhMMTMgNHY2LjI2aDMuMzVMMTEuNDggMjB6Ii8+CiAgPC9nPgo8L3N2Zz4K);
  --jp-icon-palette: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTE4IDEzVjIwSDRWNkg5LjAyQzkuMDcgNS4yOSA5LjI0IDQuNjIgOS41IDRINEMyLjkgNCAyIDQuOSAyIDZWMjBDMiAyMS4xIDIuOSAyMiA0IDIySDE4QzE5LjEgMjIgMjAgMjEuMSAyMCAyMFYxNUwxOCAxM1pNMTkuMyA4Ljg5QzE5Ljc0IDguMTkgMjAgNy4zOCAyMCA2LjVDMjAgNC4wMSAxNy45OSAyIDE1LjUgMkMxMy4wMSAyIDExIDQuMDEgMTEgNi41QzExIDguOTkgMTMuMDEgMTEgMTUuNDkgMTFDMTYuMzcgMTEgMTcuMTkgMTAuNzQgMTcuODggMTAuM0wyMSAxMy40MkwyMi40MiAxMkwxOS4zIDguODlaTTE1LjUgOUMxNC4xMiA5IDEzIDcuODggMTMgNi41QzEzIDUuMTIgMTQuMTIgNCAxNS41IDRDMTYuODggNCAxOCA1LjEyIDE4IDYuNUMxOCA3Ljg4IDE2Ljg4IDkgMTUuNSA5WiIvPgogICAgPHBhdGggZmlsbC1ydWxlPSJldmVub2RkIiBjbGlwLXJ1bGU9ImV2ZW5vZGQiIGQ9Ik00IDZIOS4wMTg5NEM5LjAwNjM5IDYuMTY1MDIgOSA2LjMzMTc2IDkgNi41QzkgOC44MTU3NyAxMC4yMTEgMTAuODQ4NyAxMi4wMzQzIDEySDlWMTRIMTZWMTIuOTgxMUMxNi41NzAzIDEyLjkzNzcgMTcuMTIgMTIuODIwNyAxNy42Mzk2IDEyLjYzOTZMMTggMTNWMjBINFY2Wk04IDhINlYxMEg4VjhaTTYgMTJIOFYxNEg2VjEyWk04IDE2SDZWMThIOFYxNlpNOSAxNkgxNlYxOEg5VjE2WiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-paste: url(data:image/svg+xml;base64,PHN2ZyBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgIDxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSI+CiAgICAgICAgPHBhdGggZD0iTTE5IDJoLTQuMThDMTQuNC44NCAxMy4zIDAgMTIgMGMtMS4zIDAtMi40Ljg0LTIuODIgMkg1Yy0xLjEgMC0yIC45LTIgMnYxNmMwIDEuMS45IDIgMiAyaDE0YzEuMSAwIDItLjkgMi0yVjRjMC0xLjEtLjktMi0yLTJ6bS03IDBjLjU1IDAgMSAuNDUgMSAxcy0uNDUgMS0xIDEtMS0uNDUtMS0xIC40NS0xIDEtMXptNyAxOEg1VjRoMnYzaDEwVjRoMnYxNnoiLz4KICAgIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-pdf: url(data:image/svg+xml;base64,PHN2ZwogICB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMiAyMiIgd2lkdGg9IjE2Ij4KICAgIDxwYXRoIHRyYW5zZm9ybT0icm90YXRlKDQ1KSIgY2xhc3M9ImpwLWljb24tc2VsZWN0YWJsZSIgZmlsbD0iI0ZGMkEyQSIKICAgICAgIGQ9Im0gMjIuMzQ0MzY5LC0zLjAxNjM2NDIgaCA1LjYzODYwNCB2IDEuNTc5MjQzMyBoIC0zLjU0OTIyNyB2IDEuNTA4NjkyOTkgaCAzLjMzNzU3NiBWIDEuNjUwODE1NCBoIC0zLjMzNzU3NiB2IDMuNDM1MjYxMyBoIC0yLjA4OTM3NyB6IG0gLTcuMTM2NDQ0LDEuNTc5MjQzMyB2IDQuOTQzOTU0MyBoIDAuNzQ4OTIgcSAxLjI4MDc2MSwwIDEuOTUzNzAzLC0wLjYzNDk1MzUgMC42NzgzNjksLTAuNjM0OTUzNSAwLjY3ODM2OSwtMS44NDUxNjQxIDAsLTEuMjA0NzgzNTUgLTAuNjcyOTQyLC0xLjgzNDMxMDExIC0wLjY3Mjk0MiwtMC42Mjk1MjY1OSAtMS45NTkxMywtMC42Mjk1MjY1OSB6IG0gLTIuMDg5Mzc3LC0xLjU3OTI0MzMgaCAyLjIwMzM0MyBxIDEuODQ1MTY0LDAgMi43NDYwMzksMC4yNjU5MjA3IDAuOTA2MzAxLDAuMjYwNDkzNyAxLjU1MjEwOCwwLjg5MDAyMDMgMC41Njk4MywwLjU0ODEyMjMgMC44NDY2MDUsMS4yNjQ0ODAwNiAwLjI3Njc3NCwwLjcxNjM1NzgxIDAuMjc2Nzc0LDEuNjIyNjU4OTQgMCwwLjkxNzE1NTEgLTAuMjc2Nzc0LDEuNjM4OTM5OSAtMC4yNzY3NzUsMC43MTYzNTc4IC0wLjg0NjYwNSwxLjI2NDQ4IC0wLjY1MTIzNCwwLjYyOTUyNjYgLTEuNTYyOTYyLDAuODk1NDQ3MyAtMC45MTE3MjgsMC4yNjA0OTM3IC0yLjczNTE4NSwwLjI2MDQ5MzcgaCAtMi4yMDMzNDMgeiBtIC04LjE0NTg1NjUsMCBoIDMuNDY3ODIzIHEgMS41NDY2ODE2LDAgMi4zNzE1Nzg1LDAuNjg5MjIzIDAuODMwMzI0LDAuNjgzNzk2MSAwLjgzMDMyNCwxLjk1MzcwMzE0IDAsMS4yNzUzMzM5NyAtMC44MzAzMjQsMS45NjQ1NTcwNiBRIDkuOTg3MTk2MSwyLjI3NDkxNSA4LjQ0MDUxNDUsMi4yNzQ5MTUgSCA3LjA2MjA2ODQgViA1LjA4NjA3NjcgSCA0Ljk3MjY5MTUgWiBtIDIuMDg5Mzc2OSwxLjUxNDExOTkgdiAyLjI2MzAzOTQzIGggMS4xNTU5NDEgcSAwLjYwNzgxODgsMCAwLjkzODg2MjksLTAuMjkzMDU1NDcgMC4zMzEwNDQxLC0wLjI5ODQ4MjQxIDAuMzMxMDQ0MSwtMC44NDExNzc3MiAwLC0wLjU0MjY5NTMxIC0wLjMzMTA0NDEsLTAuODM1NzUwNzQgLTAuMzMxMDQ0MSwtMC4yOTMwNTU1IC0wLjkzODg2MjksLTAuMjkzMDU1NSB6IgovPgo8L3N2Zz4K);
  --jp-icon-python: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iLTEwIC0xMCAxMzEuMTYxMzYxNjk0MzM1OTQgMTMyLjM4ODk5OTkzODk2NDg0Ij4KICA8cGF0aCBjbGFzcz0ianAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjMzA2OTk4IiBkPSJNIDU0LjkxODc4NSw5LjE5Mjc0MjFlLTQgQyA1MC4zMzUxMzIsMC4wMjIyMTcyNyA0NS45NTc4NDYsMC40MTMxMzY5NyA0Mi4xMDYyODUsMS4wOTQ2NjkzIDMwLjc2MDA2OSwzLjA5OTE3MzEgMjguNzAwMDM2LDcuMjk0NzcxNCAyOC43MDAwMzUsMTUuMDMyMTY5IHYgMTAuMjE4NzUgaCAyNi44MTI1IHYgMy40MDYyNSBoIC0yNi44MTI1IC0xMC4wNjI1IGMgLTcuNzkyNDU5LDAgLTE0LjYxNTc1ODgsNC42ODM3MTcgLTE2Ljc0OTk5OTgsMTMuNTkzNzUgLTIuNDYxODE5OTgsMTAuMjEyOTY2IC0yLjU3MTAxNTA4LDE2LjU4NjAyMyAwLDI3LjI1IDEuOTA1OTI4Myw3LjkzNzg1MiA2LjQ1NzU0MzIsMTMuNTkzNzQ4IDE0LjI0OTk5OTgsMTMuNTkzNzUgaCA5LjIxODc1IHYgLTEyLjI1IGMgMCwtOC44NDk5MDIgNy42NTcxNDQsLTE2LjY1NjI0OCAxNi43NSwtMTYuNjU2MjUgaCAyNi43ODEyNSBjIDcuNDU0OTUxLDAgMTMuNDA2MjUzLC02LjEzODE2NCAxMy40MDYyNSwtMTMuNjI1IHYgLTI1LjUzMTI1IGMgMCwtNy4yNjYzMzg2IC02LjEyOTk4LC0xMi43MjQ3NzcxIC0xMy40MDYyNSwtMTMuOTM3NDk5NyBDIDY0LjI4MTU0OCwwLjMyNzk0Mzk3IDU5LjUwMjQzOCwtMC4wMjAzNzkwMyA1NC45MTg3ODUsOS4xOTI3NDIxZS00IFogbSAtMTQuNSw4LjIxODc1MDEyNTc5IGMgMi43Njk1NDcsMCA1LjAzMTI1LDIuMjk4NjQ1NiA1LjAzMTI1LDUuMTI0OTk5NiAtMmUtNiwyLjgxNjMzNiAtMi4yNjE3MDMsNS4wOTM3NSAtNS4wMzEyNSw1LjA5Mzc1IC0yLjc3OTQ3NiwtMWUtNiAtNS4wMzEyNSwtMi4yNzc0MTUgLTUuMDMxMjUsLTUuMDkzNzUgLTEwZS03LC0yLjgyNjM1MyAyLjI1MTc3NCwtNS4xMjQ5OTk2IDUuMDMxMjUsLTUuMTI0OTk5NiB6Ii8+CiAgPHBhdGggY2xhc3M9ImpwLWljb24tc2VsZWN0YWJsZSIgZmlsbD0iI2ZmZDQzYiIgZD0ibSA4NS42Mzc1MzUsMjguNjU3MTY5IHYgMTEuOTA2MjUgYyAwLDkuMjMwNzU1IC03LjgyNTg5NSwxNi45OTk5OTkgLTE2Ljc1LDE3IGggLTI2Ljc4MTI1IGMgLTcuMzM1ODMzLDAgLTEzLjQwNjI0OSw2LjI3ODQ4MyAtMTMuNDA2MjUsMTMuNjI1IHYgMjUuNTMxMjQ3IGMgMCw3LjI2NjM0NCA2LjMxODU4OCwxMS41NDAzMjQgMTMuNDA2MjUsMTMuNjI1MDA0IDguNDg3MzMxLDIuNDk1NjEgMTYuNjI2MjM3LDIuOTQ2NjMgMjYuNzgxMjUsMCA2Ljc1MDE1NSwtMS45NTQzOSAxMy40MDYyNTMsLTUuODg3NjEgMTMuNDA2MjUsLTEzLjYyNTAwNCBWIDg2LjUwMDkxOSBoIC0yNi43ODEyNSB2IC0zLjQwNjI1IGggMjYuNzgxMjUgMTMuNDA2MjU0IGMgNy43OTI0NjEsMCAxMC42OTYyNTEsLTUuNDM1NDA4IDEzLjQwNjI0MSwtMTMuNTkzNzUgMi43OTkzMywtOC4zOTg4ODYgMi42ODAyMiwtMTYuNDc1Nzc2IDAsLTI3LjI1IC0xLjkyNTc4LC03Ljc1NzQ0MSAtNS42MDM4NywtMTMuNTkzNzUgLTEzLjQwNjI0MSwtMTMuNTkzNzUgeiBtIC0xNS4wNjI1LDY0LjY1NjI1IGMgMi43Nzk0NzgsM2UtNiA1LjAzMTI1LDIuMjc3NDE3IDUuMDMxMjUsNS4wOTM3NDcgLTJlLTYsMi44MjYzNTQgLTIuMjUxNzc1LDUuMTI1MDA0IC01LjAzMTI1LDUuMTI1MDA0IC0yLjc2OTU1LDAgLTUuMDMxMjUsLTIuMjk4NjUgLTUuMDMxMjUsLTUuMTI1MDA0IDJlLTYsLTIuODE2MzMgMi4yNjE2OTcsLTUuMDkzNzQ3IDUuMDMxMjUsLTUuMDkzNzQ3IHoiLz4KPC9zdmc+Cg==);
  --jp-icon-r-kernel: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIyIDIyIj4KICA8cGF0aCBjbGFzcz0ianAtaWNvbi1jb250cmFzdDMganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjMjE5NkYzIiBkPSJNNC40IDIuNWMxLjItLjEgMi45LS4zIDQuOS0uMyAyLjUgMCA0LjEuNCA1LjIgMS4zIDEgLjcgMS41IDEuOSAxLjUgMy41IDAgMi0xLjQgMy41LTIuOSA0LjEgMS4yLjQgMS43IDEuNiAyLjIgMyAuNiAxLjkgMSAzLjkgMS4zIDQuNmgtMy44Yy0uMy0uNC0uOC0xLjctMS4yLTMuN3MtMS4yLTIuNi0yLjYtMi42aC0uOXY2LjRINC40VjIuNXptMy43IDYuOWgxLjRjMS45IDAgMi45LS45IDIuOS0yLjNzLTEtMi4zLTIuOC0yLjNjLS43IDAtMS4zIDAtMS42LjJ2NC41aC4xdi0uMXoiLz4KPC9zdmc+Cg==);
  --jp-icon-react: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMTUwIDE1MCA1NDEuOSAyOTUuMyI+CiAgPGcgY2xhc3M9ImpwLWljb24tYnJhbmQyIGpwLWljb24tc2VsZWN0YWJsZSIgZmlsbD0iIzYxREFGQiI+CiAgICA8cGF0aCBkPSJNNjY2LjMgMjk2LjVjMC0zMi41LTQwLjctNjMuMy0xMDMuMS04Mi40IDE0LjQtNjMuNiA4LTExNC4yLTIwLjItMTMwLjQtNi41LTMuOC0xNC4xLTUuNi0yMi40LTUuNnYyMi4zYzQuNiAwIDguMy45IDExLjQgMi42IDEzLjYgNy44IDE5LjUgMzcuNSAxNC45IDc1LjctMS4xIDkuNC0yLjkgMTkuMy01LjEgMjkuNC0xOS42LTQuOC00MS04LjUtNjMuNS0xMC45LTEzLjUtMTguNS0yNy41LTM1LjMtNDEuNi01MCAzMi42LTMwLjMgNjMuMi00Ni45IDg0LTQ2LjlWNzhjLTI3LjUgMC02My41IDE5LjYtOTkuOSA1My42LTM2LjQtMzMuOC03Mi40LTUzLjItOTkuOS01My4ydjIyLjNjMjAuNyAwIDUxLjQgMTYuNSA4NCA0Ni42LTE0IDE0LjctMjggMzEuNC00MS4zIDQ5LjktMjIuNiAyLjQtNDQgNi4xLTYzLjYgMTEtMi4zLTEwLTQtMTkuNy01LjItMjktNC43LTM4LjIgMS4xLTY3LjkgMTQuNi03NS44IDMtMS44IDYuOS0yLjYgMTEuNS0yLjZWNzguNWMtOC40IDAtMTYgMS44LTIyLjYgNS42LTI4LjEgMTYuMi0zNC40IDY2LjctMTkuOSAxMzAuMS02Mi4yIDE5LjItMTAyLjcgNDkuOS0xMDIuNyA4Mi4zIDAgMzIuNSA0MC43IDYzLjMgMTAzLjEgODIuNC0xNC40IDYzLjYtOCAxMTQuMiAyMC4yIDEzMC40IDYuNSAzLjggMTQuMSA1LjYgMjIuNSA1LjYgMjcuNSAwIDYzLjUtMTkuNiA5OS45LTUzLjYgMzYuNCAzMy44IDcyLjQgNTMuMiA5OS45IDUzLjIgOC40IDAgMTYtMS44IDIyLjYtNS42IDI4LjEtMTYuMiAzNC40LTY2LjcgMTkuOS0xMzAuMSA2Mi0xOS4xIDEwMi41LTQ5LjkgMTAyLjUtODIuM3ptLTEzMC4yLTY2LjdjLTMuNyAxMi45LTguMyAyNi4yLTEzLjUgMzkuNS00LjEtOC04LjQtMTYtMTMuMS0yNC00LjYtOC05LjUtMTUuOC0xNC40LTIzLjQgMTQuMiAyLjEgMjcuOSA0LjcgNDEgNy45em0tNDUuOCAxMDYuNWMtNy44IDEzLjUtMTUuOCAyNi4zLTI0LjEgMzguMi0xNC45IDEuMy0zMCAyLTQ1LjIgMi0xNS4xIDAtMzAuMi0uNy00NS0xLjktOC4zLTExLjktMTYuNC0yNC42LTI0LjItMzgtNy42LTEzLjEtMTQuNS0yNi40LTIwLjgtMzkuOCA2LjItMTMuNCAxMy4yLTI2LjggMjAuNy0zOS45IDcuOC0xMy41IDE1LjgtMjYuMyAyNC4xLTM4LjIgMTQuOS0xLjMgMzAtMiA0NS4yLTIgMTUuMSAwIDMwLjIuNyA0NSAxLjkgOC4zIDExLjkgMTYuNCAyNC42IDI0LjIgMzggNy42IDEzLjEgMTQuNSAyNi40IDIwLjggMzkuOC02LjMgMTMuNC0xMy4yIDI2LjgtMjAuNyAzOS45em0zMi4zLTEzYzUuNCAxMy40IDEwIDI2LjggMTMuOCAzOS44LTEzLjEgMy4yLTI2LjkgNS45LTQxLjIgOCA0LjktNy43IDkuOC0xNS42IDE0LjQtMjMuNyA0LjYtOCA4LjktMTYuMSAxMy0yNC4xek00MjEuMiA0MzBjLTkuMy05LjYtMTguNi0yMC4zLTI3LjgtMzIgOSAuNCAxOC4yLjcgMjcuNS43IDkuNCAwIDE4LjctLjIgMjcuOC0uNy05IDExLjctMTguMyAyMi40LTI3LjUgMzJ6bS03NC40LTU4LjljLTE0LjItMi4xLTI3LjktNC43LTQxLTcuOSAzLjctMTIuOSA4LjMtMjYuMiAxMy41LTM5LjUgNC4xIDggOC40IDE2IDEzLjEgMjQgNC43IDggOS41IDE1LjggMTQuNCAyMy40ek00MjAuNyAxNjNjOS4zIDkuNiAxOC42IDIwLjMgMjcuOCAzMi05LS40LTE4LjItLjctMjcuNS0uNy05LjQgMC0xOC43LjItMjcuOC43IDktMTEuNyAxOC4zLTIyLjQgMjcuNS0zMnptLTc0IDU4LjljLTQuOSA3LjctOS44IDE1LjYtMTQuNCAyMy43LTQuNiA4LTguOSAxNi0xMyAyNC01LjQtMTMuNC0xMC0yNi44LTEzLjgtMzkuOCAxMy4xLTMuMSAyNi45LTUuOCA0MS4yLTcuOXptLTkwLjUgMTI1LjJjLTM1LjQtMTUuMS01OC4zLTM0LjktNTguMy01MC42IDAtMTUuNyAyMi45LTM1LjYgNTguMy01MC42IDguNi0zLjcgMTgtNyAyNy43LTEwLjEgNS43IDE5LjYgMTMuMiA0MCAyMi41IDYwLjktOS4yIDIwLjgtMTYuNiA0MS4xLTIyLjIgNjAuNi05LjktMy4xLTE5LjMtNi41LTI4LTEwLjJ6TTMxMCA0OTBjLTEzLjYtNy44LTE5LjUtMzcuNS0xNC45LTc1LjcgMS4xLTkuNCAyLjktMTkuMyA1LjEtMjkuNCAxOS42IDQuOCA0MSA4LjUgNjMuNSAxMC45IDEzLjUgMTguNSAyNy41IDM1LjMgNDEuNiA1MC0zMi42IDMwLjMtNjMuMiA0Ni45LTg0IDQ2LjktNC41LS4xLTguMy0xLTExLjMtMi43em0yMzcuMi03Ni4yYzQuNyAzOC4yLTEuMSA2Ny45LTE0LjYgNzUuOC0zIDEuOC02LjkgMi42LTExLjUgMi42LTIwLjcgMC01MS40LTE2LjUtODQtNDYuNiAxNC0xNC43IDI4LTMxLjQgNDEuMy00OS45IDIyLjYtMi40IDQ0LTYuMSA2My42LTExIDIuMyAxMC4xIDQuMSAxOS44IDUuMiAyOS4xem0zOC41LTY2LjdjLTguNiAzLjctMTggNy0yNy43IDEwLjEtNS43LTE5LjYtMTMuMi00MC0yMi41LTYwLjkgOS4yLTIwLjggMTYuNi00MS4xIDIyLjItNjAuNiA5LjkgMy4xIDE5LjMgNi41IDI4LjEgMTAuMiAzNS40IDE1LjEgNTguMyAzNC45IDU4LjMgNTAuNi0uMSAxNS43LTIzIDM1LjYtNTguNCA1MC42ek0zMjAuOCA3OC40eiIvPgogICAgPGNpcmNsZSBjeD0iNDIwLjkiIGN5PSIyOTYuNSIgcj0iNDUuNyIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-redo: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjE2Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgICA8cGF0aCBkPSJNMCAwaDI0djI0SDB6IiBmaWxsPSJub25lIi8+PHBhdGggZD0iTTE4LjQgMTAuNkMxNi41NSA4Ljk5IDE0LjE1IDggMTEuNSA4Yy00LjY1IDAtOC41OCAzLjAzLTkuOTYgNy4yMkwzLjkgMTZjMS4wNS0zLjE5IDQuMDUtNS41IDcuNi01LjUgMS45NSAwIDMuNzMuNzIgNS4xMiAxLjg4TDEzIDE2aDlWN2wtMy42IDMuNnoiLz4KICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-refresh: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDE4IDE4Ij4KICAgIDxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSI+CiAgICAgICAgPHBhdGggZD0iTTkgMTMuNWMtMi40OSAwLTQuNS0yLjAxLTQuNS00LjVTNi41MSA0LjUgOSA0LjVjMS4yNCAwIDIuMzYuNTIgMy4xNyAxLjMzTDEwIDhoNVYzbC0xLjc2IDEuNzZDMTIuMTUgMy42OCAxMC42NiAzIDkgMyA1LjY5IDMgMy4wMSA1LjY5IDMuMDEgOVM1LjY5IDE1IDkgMTVjMi45NyAwIDUuNDMtMi4xNiA1LjktNWgtMS41MmMtLjQ2IDItMi4yNCAzLjUtNC4zOCAzLjV6Ii8+CiAgICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-regex: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIwIDIwIj4KICA8ZyBjbGFzcz0ianAtaWNvbjIiIGZpbGw9IiM0MTQxNDEiPgogICAgPHJlY3QgeD0iMiIgeT0iMiIgd2lkdGg9IjE2IiBoZWlnaHQ9IjE2Ii8+CiAgPC9nPgoKICA8ZyBjbGFzcz0ianAtaWNvbi1hY2NlbnQyIiBmaWxsPSIjRkZGIj4KICAgIDxjaXJjbGUgY2xhc3M9InN0MiIgY3g9IjUuNSIgY3k9IjE0LjUiIHI9IjEuNSIvPgogICAgPHJlY3QgeD0iMTIiIHk9IjQiIGNsYXNzPSJzdDIiIHdpZHRoPSIxIiBoZWlnaHQ9IjgiLz4KICAgIDxyZWN0IHg9IjguNSIgeT0iNy41IiB0cmFuc2Zvcm09Im1hdHJpeCgwLjg2NiAtMC41IDAuNSAwLjg2NiAtMi4zMjU1IDcuMzIxOSkiIGNsYXNzPSJzdDIiIHdpZHRoPSI4IiBoZWlnaHQ9IjEiLz4KICAgIDxyZWN0IHg9IjEyIiB5PSI0IiB0cmFuc2Zvcm09Im1hdHJpeCgwLjUgLTAuODY2IDAuODY2IDAuNSAtMC42Nzc5IDE0LjgyNTIpIiBjbGFzcz0ic3QyIiB3aWR0aD0iMSIgaGVpZ2h0PSI4Ii8+CiAgPC9nPgo8L3N2Zz4K);
  --jp-icon-run: url(data:image/svg+xml;base64,PHN2ZyBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgIDxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSI+CiAgICAgICAgPHBhdGggZD0iTTggNXYxNGwxMS03eiIvPgogICAgPC9nPgo8L3N2Zz4K);
  --jp-icon-running: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDUxMiA1MTIiPgogIDxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSI+CiAgICA8cGF0aCBkPSJNMjU2IDhDMTE5IDggOCAxMTkgOCAyNTZzMTExIDI0OCAyNDggMjQ4IDI0OC0xMTEgMjQ4LTI0OFMzOTMgOCAyNTYgOHptOTYgMzI4YzAgOC44LTcuMiAxNi0xNiAxNkgxNzZjLTguOCAwLTE2LTcuMi0xNi0xNlYxNzZjMC04LjggNy4yLTE2IDE2LTE2aDE2MGM4LjggMCAxNiA3LjIgMTYgMTZ2MTYweiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-save: url(data:image/svg+xml;base64,PHN2ZyBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgIDxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSI+CiAgICAgICAgPHBhdGggZD0iTTE3IDNINWMtMS4xMSAwLTIgLjktMiAydjE0YzAgMS4xLjg5IDIgMiAyaDE0YzEuMSAwIDItLjkgMi0yVjdsLTQtNHptLTUgMTZjLTEuNjYgMC0zLTEuMzQtMy0zczEuMzQtMyAzLTMgMyAxLjM0IDMgMy0xLjM0IDMtMyAzem0zLTEwSDVWNWgxMHY0eiIvPgogICAgPC9nPgo8L3N2Zz4K);
  --jp-icon-search: url(data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMTggMTgiIHdpZHRoPSIxNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTEyLjEsMTAuOWgtMC43bC0wLjItMC4yYzAuOC0wLjksMS4zLTIuMiwxLjMtMy41YzAtMy0yLjQtNS40LTUuNC01LjRTMS44LDQuMiwxLjgsNy4xczIuNCw1LjQsNS40LDUuNCBjMS4zLDAsMi41LTAuNSwzLjUtMS4zbDAuMiwwLjJ2MC43bDQuMSw0LjFsMS4yLTEuMkwxMi4xLDEwLjl6IE03LjEsMTAuOWMtMi4xLDAtMy43LTEuNy0zLjctMy43czEuNy0zLjcsMy43LTMuN3MzLjcsMS43LDMuNywzLjcgUzkuMiwxMC45LDcuMSwxMC45eiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-settings: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8cGF0aCBjbGFzcz0ianAtaWNvbjMganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjNjE2MTYxIiBkPSJNMTkuNDMgMTIuOThjLjA0LS4zMi4wNy0uNjQuMDctLjk4cy0uMDMtLjY2LS4wNy0uOThsMi4xMS0xLjY1Yy4xOS0uMTUuMjQtLjQyLjEyLS42NGwtMi0zLjQ2Yy0uMTItLjIyLS4zOS0uMy0uNjEtLjIybC0yLjQ5IDFjLS41Mi0uNC0xLjA4LS43My0xLjY5LS45OGwtLjM4LTIuNjVBLjQ4OC40ODggMCAwMDE0IDJoLTRjLS4yNSAwLS40Ni4xOC0uNDkuNDJsLS4zOCAyLjY1Yy0uNjEuMjUtMS4xNy41OS0xLjY5Ljk4bC0yLjQ5LTFjLS4yMy0uMDktLjQ5IDAtLjYxLjIybC0yIDMuNDZjLS4xMy4yMi0uMDcuNDkuMTIuNjRsMi4xMSAxLjY1Yy0uMDQuMzItLjA3LjY1LS4wNy45OHMuMDMuNjYuMDcuOThsLTIuMTEgMS42NWMtLjE5LjE1LS4yNC40Mi0uMTIuNjRsMiAzLjQ2Yy4xMi4yMi4zOS4zLjYxLjIybDIuNDktMWMuNTIuNCAxLjA4LjczIDEuNjkuOThsLjM4IDIuNjVjLjAzLjI0LjI0LjQyLjQ5LjQyaDRjLjI1IDAgLjQ2LS4xOC40OS0uNDJsLjM4LTIuNjVjLjYxLS4yNSAxLjE3LS41OSAxLjY5LS45OGwyLjQ5IDFjLjIzLjA5LjQ5IDAgLjYxLS4yMmwyLTMuNDZjLjEyLS4yMi4wNy0uNDktLjEyLS42NGwtMi4xMS0xLjY1ek0xMiAxNS41Yy0xLjkzIDAtMy41LTEuNTctMy41LTMuNXMxLjU3LTMuNSAzLjUtMy41IDMuNSAxLjU3IDMuNSAzLjUtMS41NyAzLjUtMy41IDMuNXoiLz4KPC9zdmc+Cg==);
  --jp-icon-share: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIHZpZXdCb3g9IjAgMCAyNCAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTSAxOCAyIEMgMTYuMzU0OTkgMiAxNSAzLjM1NDk5MDQgMTUgNSBDIDE1IDUuMTkwOTUyOSAxNS4wMjE3OTEgNS4zNzcxMjI0IDE1LjA1NjY0MSA1LjU1ODU5MzggTCA3LjkyMTg3NSA5LjcyMDcwMzEgQyA3LjM5ODUzOTkgOS4yNzc4NTM5IDYuNzMyMDc3MSA5IDYgOSBDIDQuMzU0OTkwNCA5IDMgMTAuMzU0OTkgMyAxMiBDIDMgMTMuNjQ1MDEgNC4zNTQ5OTA0IDE1IDYgMTUgQyA2LjczMjA3NzEgMTUgNy4zOTg1Mzk5IDE0LjcyMjE0NiA3LjkyMTg3NSAxNC4yNzkyOTcgTCAxNS4wNTY2NDEgMTguNDM5NDUzIEMgMTUuMDIxNTU1IDE4LjYyMTUxNCAxNSAxOC44MDgzODYgMTUgMTkgQyAxNSAyMC42NDUwMSAxNi4zNTQ5OSAyMiAxOCAyMiBDIDE5LjY0NTAxIDIyIDIxIDIwLjY0NTAxIDIxIDE5IEMgMjEgMTcuMzU0OTkgMTkuNjQ1MDEgMTYgMTggMTYgQyAxNy4yNjc0OCAxNiAxNi42MDE1OTMgMTYuMjc5MzI4IDE2LjA3ODEyNSAxNi43MjI2NTYgTCA4Ljk0MzM1OTQgMTIuNTU4NTk0IEMgOC45NzgyMDk1IDEyLjM3NzEyMiA5IDEyLjE5MDk1MyA5IDEyIEMgOSAxMS44MDkwNDcgOC45NzgyMDk1IDExLjYyMjg3OCA4Ljk0MzM1OTQgMTEuNDQxNDA2IEwgMTYuMDc4MTI1IDcuMjc5Mjk2OSBDIDE2LjYwMTQ2IDcuNzIyMTQ2MSAxNy4yNjc5MjMgOCAxOCA4IEMgMTkuNjQ1MDEgOCAyMSA2LjY0NTAwOTYgMjEgNSBDIDIxIDMuMzU0OTkwNCAxOS42NDUwMSAyIDE4IDIgeiBNIDE4IDQgQyAxOC41NjQxMjkgNCAxOSA0LjQzNTg3MDYgMTkgNSBDIDE5IDUuNTY0MTI5NCAxOC41NjQxMjkgNiAxOCA2IEMgMTcuNDM1ODcxIDYgMTcgNS41NjQxMjk0IDE3IDUgQyAxNyA0LjQzNTg3MDYgMTcuNDM1ODcxIDQgMTggNCB6IE0gNiAxMSBDIDYuNTY0MTI5NCAxMSA3IDExLjQzNTg3MSA3IDEyIEMgNyAxMi41NjQxMjkgNi41NjQxMjk0IDEzIDYgMTMgQyA1LjQzNTg3MDYgMTMgNSAxMi41NjQxMjkgNSAxMiBDIDUgMTEuNDM1ODcxIDUuNDM1ODcwNiAxMSA2IDExIHogTSAxOCAxOCBDIDE4LjU2NDEyOSAxOCAxOSAxOC40MzU4NzEgMTkgMTkgQyAxOSAxOS41NjQxMjkgMTguNTY0MTI5IDIwIDE4IDIwIEMgMTcuNDM1ODcxIDIwIDE3IDE5LjU2NDEyOSAxNyAxOSBDIDE3IDE4LjQzNTg3MSAxNy40MzU4NzEgMTggMTggMTggeiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-spreadsheet: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIyIDIyIj4KICA8cGF0aCBjbGFzcz0ianAtaWNvbi1jb250cmFzdDEganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjNENBRjUwIiBkPSJNMi4yIDIuMnYxNy42aDE3LjZWMi4ySDIuMnptMTUuNCA3LjdoLTUuNVY0LjRoNS41djUuNXpNOS45IDQuNHY1LjVINC40VjQuNGg1LjV6bS01LjUgNy43aDUuNXY1LjVINC40di01LjV6bTcuNyA1LjV2LTUuNWg1LjV2NS41aC01LjV6Ii8+Cjwvc3ZnPgo=);
  --jp-icon-stop: url(data:image/svg+xml;base64,PHN2ZyBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgIDxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSI+CiAgICAgICAgPHBhdGggZD0iTTAgMGgyNHYyNEgweiIgZmlsbD0ibm9uZSIvPgogICAgICAgIDxwYXRoIGQ9Ik02IDZoMTJ2MTJINnoiLz4KICAgIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-tab: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTIxIDNIM2MtMS4xIDAtMiAuOS0yIDJ2MTRjMCAxLjEuOSAyIDIgMmgxOGMxLjEgMCAyLS45IDItMlY1YzAtMS4xLS45LTItMi0yem0wIDE2SDNWNWgxMHY0aDh2MTB6Ii8+CiAgPC9nPgo8L3N2Zz4K);
  --jp-icon-table-rows: url(data:image/svg+xml;base64,PHN2ZyBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgIDxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSI+CiAgICAgICAgPHBhdGggZD0iTTAgMGgyNHYyNEgweiIgZmlsbD0ibm9uZSIvPgogICAgICAgIDxwYXRoIGQ9Ik0yMSw4SDNWNGgxOFY4eiBNMjEsMTBIM3Y0aDE4VjEweiBNMjEsMTZIM3Y0aDE4VjE2eiIvPgogICAgPC9nPgo8L3N2Zz4K);
  --jp-icon-tag: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjgiIGhlaWdodD0iMjgiIHZpZXdCb3g9IjAgMCA0MyAyOCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KCTxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSI+CgkJPHBhdGggZD0iTTI4LjgzMzIgMTIuMzM0TDMyLjk5OTggMTYuNTAwN0wzNy4xNjY1IDEyLjMzNEgyOC44MzMyWiIvPgoJCTxwYXRoIGQ9Ik0xNi4yMDk1IDIxLjYxMDRDMTUuNjg3MyAyMi4xMjk5IDE0Ljg0NDMgMjIuMTI5OSAxNC4zMjQ4IDIxLjYxMDRMNi45ODI5IDE0LjcyNDVDNi41NzI0IDE0LjMzOTQgNi4wODMxMyAxMy42MDk4IDYuMDQ3ODYgMTMuMDQ4MkM1Ljk1MzQ3IDExLjUyODggNi4wMjAwMiA4LjYxOTQ0IDYuMDY2MjEgNy4wNzY5NUM2LjA4MjgxIDYuNTE0NzcgNi41NTU0OCA2LjA0MzQ3IDcuMTE4MDQgNi4wMzA1NUM5LjA4ODYzIDUuOTg0NzMgMTMuMjYzOCA1LjkzNTc5IDEzLjY1MTggNi4zMjQyNUwyMS43MzY5IDEzLjYzOUMyMi4yNTYgMTQuMTU4NSAyMS43ODUxIDE1LjQ3MjQgMjEuMjYyIDE1Ljk5NDZMMTYuMjA5NSAyMS42MTA0Wk05Ljc3NTg1IDguMjY1QzkuMzM1NTEgNy44MjU2NiA4LjYyMzUxIDcuODI1NjYgOC4xODI4IDguMjY1QzcuNzQzNDYgOC43MDU3MSA3Ljc0MzQ2IDkuNDE3MzMgOC4xODI4IDkuODU2NjdDOC42MjM4MiAxMC4yOTY0IDkuMzM1ODIgMTAuMjk2NCA5Ljc3NTg1IDkuODU2NjdDMTAuMjE1NiA5LjQxNzMzIDEwLjIxNTYgOC43MDUzMyA5Ljc3NTg1IDguMjY1WiIvPgoJPC9nPgo8L3N2Zz4K);
  --jp-icon-terminal: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0IiA+CiAgICA8cmVjdCBjbGFzcz0ianAtdGVybWluYWwtaWNvbi1iYWNrZ3JvdW5kLWNvbG9yIGpwLWljb24tc2VsZWN0YWJsZSIgd2lkdGg9IjIwIiBoZWlnaHQ9IjIwIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgyIDIpIiBmaWxsPSIjMzMzMzMzIi8+CiAgICA8cGF0aCBjbGFzcz0ianAtdGVybWluYWwtaWNvbi1jb2xvciBqcC1pY29uLXNlbGVjdGFibGUtaW52ZXJzZSIgZD0iTTUuMDU2NjQgOC43NjE3MkM1LjA1NjY0IDguNTk3NjYgNS4wMzEyNSA4LjQ1MzEyIDQuOTgwNDcgOC4zMjgxMkM0LjkzMzU5IDguMTk5MjIgNC44NTU0NyA4LjA4MjAzIDQuNzQ2MDkgNy45NzY1NkM0LjY0MDYyIDcuODcxMDkgNC41IDcuNzc1MzkgNC4zMjQyMiA3LjY4OTQ1QzQuMTUyMzQgNy41OTk2MSAzLjk0MzM2IDcuNTExNzIgMy42OTcyNyA3LjQyNTc4QzMuMzAyNzMgNy4yODUxNiAyLjk0MzM2IDcuMTM2NzIgMi42MTkxNCA2Ljk4MDQ3QzIuMjk0OTIgNi44MjQyMiAyLjAxNzU4IDYuNjQyNTggMS43ODcxMSA2LjQzNTU1QzEuNTYwNTUgNi4yMjg1MiAxLjM4NDc3IDUuOTg4MjggMS4yNTk3NyA1LjcxNDg0QzEuMTM0NzcgNS40Mzc1IDEuMDcyMjcgNS4xMDkzOCAxLjA3MjI3IDQuNzMwNDdDMS4wNzIyNyA0LjM5ODQ0IDEuMTI4OTEgNC4wOTU3IDEuMjQyMTkgMy44MjIyN0MxLjM1NTQ3IDMuNTQ0OTIgMS41MTU2MiAzLjMwNDY5IDEuNzIyNjYgMy4xMDE1NkMxLjkyOTY5IDIuODk4NDQgMi4xNzk2OSAyLjczNDM3IDIuNDcyNjYgMi42MDkzOEMyLjc2NTYyIDIuNDg0MzggMy4wOTE4IDIuNDA0MyAzLjQ1MTE3IDIuMzY5MTRWMS4xMDkzOEg0LjM4ODY3VjIuMzgwODZDNC43NDAyMyAyLjQyNzczIDUuMDU2NjQgMi41MjM0NCA1LjMzNzg5IDIuNjY3OTdDNS42MTkxNCAyLjgxMjUgNS44NTc0MiAzLjAwMTk1IDYuMDUyNzMgMy4yMzYzM0M2LjI1MTk1IDMuNDY2OCA2LjQwNDMgMy43NDAyMyA2LjUwOTc3IDQuMDU2NjRDNi42MTkxNCA0LjM2OTE0IDYuNjczODMgNC43MjA3IDYuNjczODMgNS4xMTEzM0g1LjA0NDkyQzUuMDQ0OTIgNC42Mzg2NyA0LjkzNzUgNC4yODEyNSA0LjcyMjY2IDQuMDM5MDZDNC41MDc4MSAzLjc5Mjk3IDQuMjE2OCAzLjY2OTkyIDMuODQ5NjEgMy42Njk5MkMzLjY1MDM5IDMuNjY5OTIgMy40NzY1NiAzLjY5NzI3IDMuMzI4MTIgMy43NTE5NUMzLjE4MzU5IDMuODAyNzMgMy4wNjQ0NSAzLjg3Njk1IDIuOTcwNyAzLjk3NDYxQzIuODc2OTUgNC4wNjgzNiAyLjgwNjY0IDQuMTc5NjkgMi43NTk3NyA0LjMwODU5QzIuNzE2OCA0LjQzNzUgMi42OTUzMSA0LjU3ODEyIDIuNjk1MzEgNC43MzA0N0MyLjY5NTMxIDQuODgyODEgMi43MTY4IDUuMDE5NTMgMi43NTk3NyA1LjE0MDYyQzIuODA2NjQgNS4yNTc4MSAyLjg4MjgxIDUuMzY3MTkgMi45ODgyOCA1LjQ2ODc1QzMuMDk3NjYgNS41NzAzMSAzLjI0MDIzIDUuNjY3OTcgMy40MTYwMiA1Ljc2MTcyQzMuNTkxOCA1Ljg1MTU2IDMuODEwNTUgNS45NDMzNiA0LjA3MjI3IDYuMDM3MTFDNC40NjY4IDYuMTg1NTUgNC44MjQyMiA2LjMzOTg0IDUuMTQ0NTMgNi41QzUuNDY0ODQgNi42NTYyNSA1LjczODI4IDYuODM5ODQgNS45NjQ4NCA3LjA1MDc4QzYuMTk1MzEgNy4yNTc4MSA2LjM3MTA5IDcuNSA2LjQ5MjE5IDcuNzc3MzRDNi42MTcxOSA4LjA1MDc4IDYuNjc5NjkgOC4zNzUgNi42Nzk2OSA4Ljc1QzYuNjc5NjkgOS4wOTM3NSA2LjYyMzA1IDkuNDA0MyA2LjUwOTc3IDkuNjgxNjRDNi4zOTY0OCA5Ljk1NTA4IDYuMjM0MzggMTAuMTkxNCA2LjAyMzQ0IDEwLjM5MDZDNS44MTI1IDEwLjU4OTggNS41NTg1OSAxMC43NSA1LjI2MTcyIDEwLjg3MTFDNC45NjQ4NCAxMC45ODgzIDQuNjMyODEgMTEuMDY0NSA0LjI2NTYyIDExLjA5OTZWMTIuMjQ4SDMuMzMzOThWMTEuMDk5NkMzLjAwMTk1IDExLjA2ODQgMi42Nzk2OSAxMC45OTYxIDIuMzY3MTkgMTAuODgyOEMyLjA1NDY5IDEwLjc2NTYgMS43NzczNCAxMC41OTc3IDEuNTM1MTYgMTAuMzc4OUMxLjI5Njg4IDEwLjE2MDIgMS4xMDU0NyA5Ljg4NDc3IDAuOTYwOTM4IDkuNTUyNzNDMC44MTY0MDYgOS4yMTY4IDAuNzQ0MTQxIDguODE0NDUgMC43NDQxNDEgOC4zNDU3SDIuMzc4OTFDMi4zNzg5MSA4LjYyNjk1IDIuNDE5OTIgOC44NjMyOCAyLjUwMTk1IDkuMDU0NjlDMi41ODM5OCA5LjI0MjE5IDIuNjg5NDUgOS4zOTI1OCAyLjgxODM2IDkuNTA1ODZDMi45NTExNyA5LjYxNTIzIDMuMTAxNTYgOS42OTMzNiAzLjI2OTUzIDkuNzQwMjNDMy40Mzc1IDkuNzg3MTEgMy42MDkzOCA5LjgxMDU1IDMuNzg1MTYgOS44MTA1NUM0LjIwMzEyIDkuODEwNTUgNC41MTk1MyA5LjcxMjg5IDQuNzM0MzggOS41MTc1OEM0Ljk0OTIyIDkuMzIyMjcgNS4wNTY2NCA5LjA3MDMxIDUuMDU2NjQgOC43NjE3MlpNMTMuNDE4IDEyLjI3MTVIOC4wNzQyMlYxMUgxMy40MThWMTIuMjcxNVoiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDMuOTUyNjQgNikiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo=);
  --jp-icon-text-editor: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8cGF0aCBjbGFzcz0ianAtdGV4dC1lZGl0b3ItaWNvbi1jb2xvciBqcC1pY29uLXNlbGVjdGFibGUiIGZpbGw9IiM2MTYxNjEiIGQ9Ik0xNSAxNUgzdjJoMTJ2LTJ6bTAtOEgzdjJoMTJWN3pNMyAxM2gxOHYtMkgzdjJ6bTAgOGgxOHYtMkgzdjJ6TTMgM3YyaDE4VjNIM3oiLz4KPC9zdmc+Cg==);
  --jp-icon-toc: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjNjE2MTYxIj4KICAgIDxwYXRoIGQ9Ik03LDVIMjFWN0g3VjVNNywxM1YxMUgyMVYxM0g3TTQsNC41QTEuNSwxLjUgMCAwLDEgNS41LDZBMS41LDEuNSAwIDAsMSA0LDcuNUExLjUsMS41IDAgMCwxIDIuNSw2QTEuNSwxLjUgMCAwLDEgNCw0LjVNNCwxMC41QTEuNSwxLjUgMCAwLDEgNS41LDEyQTEuNSwxLjUgMCAwLDEgNCwxMy41QTEuNSwxLjUgMCAwLDEgMi41LDEyQTEuNSwxLjUgMCAwLDEgNCwxMC41TTcsMTlWMTdIMjFWMTlIN000LDE2LjVBMS41LDEuNSAwIDAsMSA1LjUsMThBMS41LDEuNSAwIDAsMSA0LDE5LjVBMS41LDEuNSAwIDAsMSAyLjUsMThBMS41LDEuNSAwIDAsMSA0LDE2LjVaIiAvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-tree-view: url(data:image/svg+xml;base64,PHN2ZyBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgIDxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSI+CiAgICAgICAgPHBhdGggZD0iTTAgMGgyNHYyNEgweiIgZmlsbD0ibm9uZSIvPgogICAgICAgIDxwYXRoIGQ9Ik0yMiAxMVYzaC03djNIOVYzSDJ2OGg3VjhoMnYxMGg0djNoN3YtOGgtN3YzaC0yVjhoMnYzeiIvPgogICAgPC9nPgo8L3N2Zz4K);
  --jp-icon-trusted: url(data:image/svg+xml;base64,PHN2ZyBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI1Ij4KICAgIDxwYXRoIGNsYXNzPSJqcC1pY29uMiIgc3Ryb2tlPSIjMzMzMzMzIiBzdHJva2Utd2lkdGg9IjIiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDIgMykiIGQ9Ik0xLjg2MDk0IDExLjQ0MDlDMC44MjY0NDggOC43NzAyNyAwLjg2Mzc3OSA2LjA1NzY0IDEuMjQ5MDcgNC4xOTkzMkMyLjQ4MjA2IDMuOTMzNDcgNC4wODA2OCAzLjQwMzQ3IDUuNjAxMDIgMi44NDQ5QzcuMjM1NDkgMi4yNDQ0IDguODU2NjYgMS41ODE1IDkuOTg3NiAxLjA5NTM5QzExLjA1OTcgMS41ODM0MSAxMi42MDk0IDIuMjQ0NCAxNC4yMTggMi44NDMzOUMxNS43NTAzIDMuNDEzOTQgMTcuMzk5NSAzLjk1MjU4IDE4Ljc1MzkgNC4yMTM4NUMxOS4xMzY0IDYuMDcxNzcgMTkuMTcwOSA4Ljc3NzIyIDE4LjEzOSAxMS40NDA5QzE3LjAzMDMgMTQuMzAzMiAxNC42NjY4IDE3LjE4NDQgOS45OTk5OSAxOC45MzU0QzUuMzMzMiAxNy4xODQ0IDIuOTY5NjggMTQuMzAzMiAxLjg2MDk0IDExLjQ0MDlaIi8+CiAgICA8cGF0aCBjbGFzcz0ianAtaWNvbjIiIGZpbGw9IiMzMzMzMzMiIHN0cm9rZT0iIzMzMzMzMyIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoOCA5Ljg2NzE5KSIgZD0iTTIuODYwMTUgNC44NjUzNUwwLjcyNjU0OSAyLjk5OTU5TDAgMy42MzA0NUwyLjg2MDE1IDYuMTMxNTdMOCAwLjYzMDg3Mkw3LjI3ODU3IDBMMi44NjAxNSA0Ljg2NTM1WiIvPgo8L3N2Zz4K);
  --jp-icon-undo: url(data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIxNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTEyLjUgOGMtMi42NSAwLTUuMDUuOTktNi45IDIuNkwyIDd2OWg5bC0zLjYyLTMuNjJjMS4zOS0xLjE2IDMuMTYtMS44OCA1LjEyLTEuODggMy41NCAwIDYuNTUgMi4zMSA3LjYgNS41bDIuMzctLjc4QzIxLjA4IDExLjAzIDE3LjE1IDggMTIuNSA4eiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-user: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIHZpZXdCb3g9IjAgMCAyNCAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTE2IDdhNCA0IDAgMTEtOCAwIDQgNCAwIDAxOCAwek0xMiAxNGE3IDcgMCAwMC03IDdoMTRhNyA3IDAgMDAtNy03eiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-users: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDM2IDI0IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgogPGcgY2xhc3M9ImpwLWljb24zIiB0cmFuc2Zvcm09Im1hdHJpeCgxLjczMjcgMCAwIDEuNzMyNyAtMy42MjgyIC4wOTk1NzcpIiBmaWxsPSIjNjE2MTYxIj4KICA8cGF0aCB0cmFuc2Zvcm09Im1hdHJpeCgxLjUsMCwwLDEuNSwwLC02KSIgZD0ibTEyLjE4NiA3LjUwOThjLTEuMDUzNSAwLTEuOTc1NyAwLjU2NjUtMi40Nzg1IDEuNDEwMiAwLjc1MDYxIDAuMzEyNzcgMS4zOTc0IDAuODI2NDggMS44NzMgMS40NzI3aDMuNDg2M2MwLTEuNTkyLTEuMjg4OS0yLjg4MjgtMi44ODA5LTIuODgyOHoiLz4KICA8cGF0aCBkPSJtMjAuNDY1IDIuMzg5NWEyLjE4ODUgMi4xODg1IDAgMCAxLTIuMTg4NCAyLjE4ODUgMi4xODg1IDIuMTg4NSAwIDAgMS0yLjE4ODUtMi4xODg1IDIuMTg4NSAyLjE4ODUgMCAwIDEgMi4xODg1LTIuMTg4NSAyLjE4ODUgMi4xODg1IDAgMCAxIDIuMTg4NCAyLjE4ODV6Ii8+CiAgPHBhdGggdHJhbnNmb3JtPSJtYXRyaXgoMS41LDAsMCwxLjUsMCwtNikiIGQ9Im0zLjU4OTggOC40MjE5Yy0xLjExMjYgMC0yLjAxMzcgMC45MDExMS0yLjAxMzcgMi4wMTM3aDIuODE0NWMwLjI2Nzk3LTAuMzczMDkgMC41OTA3LTAuNzA0MzUgMC45NTg5OC0wLjk3ODUyLTAuMzQ0MzMtMC42MTY4OC0xLjAwMzEtMS4wMzUyLTEuNzU5OC0xLjAzNTJ6Ii8+CiAgPHBhdGggZD0ibTYuOTE1NCA0LjYyM2ExLjUyOTQgMS41Mjk0IDAgMCAxLTEuNTI5NCAxLjUyOTQgMS41Mjk0IDEuNTI5NCAwIDAgMS0xLjUyOTQtMS41Mjk0IDEuNTI5NCAxLjUyOTQgMCAwIDEgMS41Mjk0LTEuNTI5NCAxLjUyOTQgMS41Mjk0IDAgMCAxIDEuNTI5NCAxLjUyOTR6Ii8+CiAgPHBhdGggZD0ibTYuMTM1IDEzLjUzNWMwLTMuMjM5MiAyLjYyNTktNS44NjUgNS44NjUtNS44NjUgMy4yMzkyIDAgNS44NjUgMi42MjU5IDUuODY1IDUuODY1eiIvPgogIDxjaXJjbGUgY3g9IjEyIiBjeT0iMy43Njg1IiByPSIyLjk2ODUiLz4KIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-vega: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIyIDIyIj4KICA8ZyBjbGFzcz0ianAtaWNvbjEganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjMjEyMTIxIj4KICAgIDxwYXRoIGQ9Ik0xMC42IDUuNGwyLjItMy4ySDIuMnY3LjNsNC02LjZ6Ii8+CiAgICA8cGF0aCBkPSJNMTUuOCAyLjJsLTQuNCA2LjZMNyA2LjNsLTQuOCA4djUuNWgxNy42VjIuMmgtNHptLTcgMTUuNEg1LjV2LTQuNGgzLjN2NC40em00LjQgMEg5LjhWOS44aDMuNHY3Ljh6bTQuNCAwaC0zLjRWNi41aDMuNHYxMS4xeiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-word: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIwIDIwIj4KIDxnIGNsYXNzPSJqcC1pY29uMiIgZmlsbD0iIzQxNDE0MSI+CiAgPHJlY3QgeD0iMiIgeT0iMiIgd2lkdGg9IjE2IiBoZWlnaHQ9IjE2Ii8+CiA8L2c+CiA8ZyBjbGFzcz0ianAtaWNvbi1hY2NlbnQyIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSguNDMgLjA0MDEpIiBmaWxsPSIjZmZmIj4KICA8cGF0aCBkPSJtNC4xNCA4Ljc2cTAuMDY4Mi0xLjg5IDIuNDItMS44OSAxLjE2IDAgMS42OCAwLjQyIDAuNTY3IDAuNDEgMC41NjcgMS4xNnYzLjQ3cTAgMC40NjIgMC41MTQgMC40NjIgMC4xMDMgMCAwLjItMC4wMjMxdjAuNzE0cS0wLjM5OSAwLjEwMy0wLjY1MSAwLjEwMy0wLjQ1MiAwLTAuNjkzLTAuMjItMC4yMzEtMC4yLTAuMjg0LTAuNjYyLTAuOTU2IDAuODcyLTIgMC44NzItMC45MDMgMC0xLjQ3LTAuNDcyLTAuNTI1LTAuNDcyLTAuNTI1LTEuMjYgMC0wLjI2MiAwLjA0NTItMC40NzIgMC4wNTY3LTAuMjIgMC4xMTYtMC4zNzggMC4wNjgyLTAuMTY4IDAuMjMxLTAuMzA0IDAuMTU4LTAuMTQ3IDAuMjYyLTAuMjQyIDAuMTE2LTAuMDkxNCAwLjM2OC0wLjE2OCAwLjI2Mi0wLjA5MTQgMC4zOTktMC4xMjYgMC4xMzYtMC4wNDUyIDAuNDcyLTAuMTAzIDAuMzM2LTAuMDU3OCAwLjUwNC0wLjA3OTggMC4xNTgtMC4wMjMxIDAuNTY3LTAuMDc5OCAwLjU1Ni0wLjA2ODIgMC43NzctMC4yMjEgMC4yMi0wLjE1MiAwLjIyLTAuNDQxdi0wLjI1MnEwLTAuNDMtMC4zNTctMC42NjItMC4zMzYtMC4yMzEtMC45NzYtMC4yMzEtMC42NjIgMC0wLjk5OCAwLjI2Mi0wLjMzNiAwLjI1Mi0wLjM5OSAwLjc5OHptMS44OSAzLjY4cTAuNzg4IDAgMS4yNi0wLjQxIDAuNTA0LTAuNDIgMC41MDQtMC45MDN2LTEuMDVxLTAuMjg0IDAuMTM2LTAuODYxIDAuMjMxLTAuNTY3IDAuMDkxNC0wLjk4NyAwLjE1OC0wLjQyIDAuMDY4Mi0wLjc2NiAwLjMyNi0wLjMzNiAwLjI1Mi0wLjMzNiAwLjcwNHQwLjMwNCAwLjcwNCAwLjg2MSAwLjI1MnoiIHN0cm9rZS13aWR0aD0iMS4wNSIvPgogIDxwYXRoIGQ9Im0xMCA0LjU2aDAuOTQ1djMuMTVxMC42NTEtMC45NzYgMS44OS0wLjk3NiAxLjE2IDAgMS44OSAwLjg0IDAuNjgyIDAuODQgMC42ODIgMi4zMSAwIDEuNDctMC43MDQgMi40Mi0wLjcwNCAwLjg4Mi0xLjg5IDAuODgyLTEuMjYgMC0xLjg5LTEuMDJ2MC43NjZoLTAuODV6bTIuNjIgMy4wNHEtMC43NDYgMC0xLjE2IDAuNjQtMC40NTIgMC42My0wLjQ1MiAxLjY4IDAgMS4wNSAwLjQ1MiAxLjY4dDEuMTYgMC42M3EwLjc3NyAwIDEuMjYtMC42MyAwLjQ5NC0wLjY0IDAuNDk0LTEuNjggMC0xLjA1LTAuNDcyLTEuNjgtMC40NjItMC42NC0xLjI2LTAuNjR6IiBzdHJva2Utd2lkdGg9IjEuMDUiLz4KICA8cGF0aCBkPSJtMi43MyAxNS44IDEzLjYgMC4wMDgxYzAuMDA2OSAwIDAtMi42IDAtMi42IDAtMC4wMDc4LTEuMTUgMC0xLjE1IDAtMC4wMDY5IDAtMC4wMDgzIDEuNS0wLjAwODMgMS41LTJlLTMgLTAuMDAxNC0xMS4zLTAuMDAxNC0xMS4zLTAuMDAxNGwtMC4wMDU5Mi0xLjVjMC0wLjAwNzgtMS4xNyAwLjAwMTMtMS4xNyAwLjAwMTN6IiBzdHJva2Utd2lkdGg9Ii45NzUiLz4KIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-yaml: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIyIDIyIj4KICA8ZyBjbGFzcz0ianAtaWNvbi1jb250cmFzdDIganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjRDgxQjYwIj4KICAgIDxwYXRoIGQ9Ik03LjIgMTguNnYtNS40TDMgNS42aDMuM2wxLjQgMy4xYy4zLjkuNiAxLjYgMSAyLjUuMy0uOC42LTEuNiAxLTIuNWwxLjQtMy4xaDMuNGwtNC40IDcuNnY1LjVsLTIuOS0uMXoiLz4KICAgIDxjaXJjbGUgY2xhc3M9InN0MCIgY3g9IjE3LjYiIGN5PSIxNi41IiByPSIyLjEiLz4KICAgIDxjaXJjbGUgY2xhc3M9InN0MCIgY3g9IjE3LjYiIGN5PSIxMSIgcj0iMi4xIi8+CiAgPC9nPgo8L3N2Zz4K);
}

/* Icon CSS class declarations */

.jp-AddAboveIcon {
  background-image: var(--jp-icon-add-above);
}

.jp-AddBelowIcon {
  background-image: var(--jp-icon-add-below);
}

.jp-AddIcon {
  background-image: var(--jp-icon-add);
}

.jp-BellIcon {
  background-image: var(--jp-icon-bell);
}

.jp-BugDotIcon {
  background-image: var(--jp-icon-bug-dot);
}

.jp-BugIcon {
  background-image: var(--jp-icon-bug);
}

.jp-BuildIcon {
  background-image: var(--jp-icon-build);
}

.jp-CaretDownEmptyIcon {
  background-image: var(--jp-icon-caret-down-empty);
}

.jp-CaretDownEmptyThinIcon {
  background-image: var(--jp-icon-caret-down-empty-thin);
}

.jp-CaretDownIcon {
  background-image: var(--jp-icon-caret-down);
}

.jp-CaretLeftIcon {
  background-image: var(--jp-icon-caret-left);
}

.jp-CaretRightIcon {
  background-image: var(--jp-icon-caret-right);
}

.jp-CaretUpEmptyThinIcon {
  background-image: var(--jp-icon-caret-up-empty-thin);
}

.jp-CaretUpIcon {
  background-image: var(--jp-icon-caret-up);
}

.jp-CaseSensitiveIcon {
  background-image: var(--jp-icon-case-sensitive);
}

.jp-CheckIcon {
  background-image: var(--jp-icon-check);
}

.jp-CircleEmptyIcon {
  background-image: var(--jp-icon-circle-empty);
}

.jp-CircleIcon {
  background-image: var(--jp-icon-circle);
}

.jp-ClearIcon {
  background-image: var(--jp-icon-clear);
}

.jp-CloseIcon {
  background-image: var(--jp-icon-close);
}

.jp-CodeCheckIcon {
  background-image: var(--jp-icon-code-check);
}

.jp-CodeIcon {
  background-image: var(--jp-icon-code);
}

.jp-CollapseAllIcon {
  background-image: var(--jp-icon-collapse-all);
}

.jp-ConsoleIcon {
  background-image: var(--jp-icon-console);
}

.jp-CopyIcon {
  background-image: var(--jp-icon-copy);
}

.jp-CopyrightIcon {
  background-image: var(--jp-icon-copyright);
}

.jp-CutIcon {
  background-image: var(--jp-icon-cut);
}

.jp-DeleteIcon {
  background-image: var(--jp-icon-delete);
}

.jp-DownloadIcon {
  background-image: var(--jp-icon-download);
}

.jp-DuplicateIcon {
  background-image: var(--jp-icon-duplicate);
}

.jp-EditIcon {
  background-image: var(--jp-icon-edit);
}

.jp-EllipsesIcon {
  background-image: var(--jp-icon-ellipses);
}

.jp-ErrorIcon {
  background-image: var(--jp-icon-error);
}

.jp-ExpandAllIcon {
  background-image: var(--jp-icon-expand-all);
}

.jp-ExtensionIcon {
  background-image: var(--jp-icon-extension);
}

.jp-FastForwardIcon {
  background-image: var(--jp-icon-fast-forward);
}

.jp-FileIcon {
  background-image: var(--jp-icon-file);
}

.jp-FileUploadIcon {
  background-image: var(--jp-icon-file-upload);
}

.jp-FilterDotIcon {
  background-image: var(--jp-icon-filter-dot);
}

.jp-FilterIcon {
  background-image: var(--jp-icon-filter);
}

.jp-FilterListIcon {
  background-image: var(--jp-icon-filter-list);
}

.jp-FolderFavoriteIcon {
  background-image: var(--jp-icon-folder-favorite);
}

.jp-FolderIcon {
  background-image: var(--jp-icon-folder);
}

.jp-HomeIcon {
  background-image: var(--jp-icon-home);
}

.jp-Html5Icon {
  background-image: var(--jp-icon-html5);
}

.jp-ImageIcon {
  background-image: var(--jp-icon-image);
}

.jp-InfoIcon {
  background-image: var(--jp-icon-info);
}

.jp-InspectorIcon {
  background-image: var(--jp-icon-inspector);
}

.jp-JsonIcon {
  background-image: var(--jp-icon-json);
}

.jp-JuliaIcon {
  background-image: var(--jp-icon-julia);
}

.jp-JupyterFaviconIcon {
  background-image: var(--jp-icon-jupyter-favicon);
}

.jp-JupyterIcon {
  background-image: var(--jp-icon-jupyter);
}

.jp-JupyterlabWordmarkIcon {
  background-image: var(--jp-icon-jupyterlab-wordmark);
}

.jp-KernelIcon {
  background-image: var(--jp-icon-kernel);
}

.jp-KeyboardIcon {
  background-image: var(--jp-icon-keyboard);
}

.jp-LaunchIcon {
  background-image: var(--jp-icon-launch);
}

.jp-LauncherIcon {
  background-image: var(--jp-icon-launcher);
}

.jp-LineFormIcon {
  background-image: var(--jp-icon-line-form);
}

.jp-LinkIcon {
  background-image: var(--jp-icon-link);
}

.jp-ListIcon {
  background-image: var(--jp-icon-list);
}

.jp-MarkdownIcon {
  background-image: var(--jp-icon-markdown);
}

.jp-MoveDownIcon {
  background-image: var(--jp-icon-move-down);
}

.jp-MoveUpIcon {
  background-image: var(--jp-icon-move-up);
}

.jp-NewFolderIcon {
  background-image: var(--jp-icon-new-folder);
}

.jp-NotTrustedIcon {
  background-image: var(--jp-icon-not-trusted);
}

.jp-NotebookIcon {
  background-image: var(--jp-icon-notebook);
}

.jp-NumberingIcon {
  background-image: var(--jp-icon-numbering);
}

.jp-OfflineBoltIcon {
  background-image: var(--jp-icon-offline-bolt);
}

.jp-PaletteIcon {
  background-image: var(--jp-icon-palette);
}

.jp-PasteIcon {
  background-image: var(--jp-icon-paste);
}

.jp-PdfIcon {
  background-image: var(--jp-icon-pdf);
}

.jp-PythonIcon {
  background-image: var(--jp-icon-python);
}

.jp-RKernelIcon {
  background-image: var(--jp-icon-r-kernel);
}

.jp-ReactIcon {
  background-image: var(--jp-icon-react);
}

.jp-RedoIcon {
  background-image: var(--jp-icon-redo);
}

.jp-RefreshIcon {
  background-image: var(--jp-icon-refresh);
}

.jp-RegexIcon {
  background-image: var(--jp-icon-regex);
}

.jp-RunIcon {
  background-image: var(--jp-icon-run);
}

.jp-RunningIcon {
  background-image: var(--jp-icon-running);
}

.jp-SaveIcon {
  background-image: var(--jp-icon-save);
}

.jp-SearchIcon {
  background-image: var(--jp-icon-search);
}

.jp-SettingsIcon {
  background-image: var(--jp-icon-settings);
}

.jp-ShareIcon {
  background-image: var(--jp-icon-share);
}

.jp-SpreadsheetIcon {
  background-image: var(--jp-icon-spreadsheet);
}

.jp-StopIcon {
  background-image: var(--jp-icon-stop);
}

.jp-TabIcon {
  background-image: var(--jp-icon-tab);
}

.jp-TableRowsIcon {
  background-image: var(--jp-icon-table-rows);
}

.jp-TagIcon {
  background-image: var(--jp-icon-tag);
}

.jp-TerminalIcon {
  background-image: var(--jp-icon-terminal);
}

.jp-TextEditorIcon {
  background-image: var(--jp-icon-text-editor);
}

.jp-TocIcon {
  background-image: var(--jp-icon-toc);
}

.jp-TreeViewIcon {
  background-image: var(--jp-icon-tree-view);
}

.jp-TrustedIcon {
  background-image: var(--jp-icon-trusted);
}

.jp-UndoIcon {
  background-image: var(--jp-icon-undo);
}

.jp-UserIcon {
  background-image: var(--jp-icon-user);
}

.jp-UsersIcon {
  background-image: var(--jp-icon-users);
}

.jp-VegaIcon {
  background-image: var(--jp-icon-vega);
}

.jp-WordIcon {
  background-image: var(--jp-icon-word);
}

.jp-YamlIcon {
  background-image: var(--jp-icon-yaml);
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/**
 * (DEPRECATED) Support for consuming icons as CSS background images
 */

.jp-Icon,
.jp-MaterialIcon {
  background-position: center;
  background-repeat: no-repeat;
  background-size: 16px;
  min-width: 16px;
  min-height: 16px;
}

.jp-Icon-cover {
  background-position: center;
  background-repeat: no-repeat;
  background-size: cover;
}

/**
 * (DEPRECATED) Support for specific CSS icon sizes
 */

.jp-Icon-16 {
  background-size: 16px;
  min-width: 16px;
  min-height: 16px;
}

.jp-Icon-18 {
  background-size: 18px;
  min-width: 18px;
  min-height: 18px;
}

.jp-Icon-20 {
  background-size: 20px;
  min-width: 20px;
  min-height: 20px;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.lm-TabBar .lm-TabBar-addButton {
  align-items: center;
  display: flex;
  padding: 4px;
  padding-bottom: 5px;
  margin-right: 1px;
  background-color: var(--jp-layout-color2);
}

.lm-TabBar .lm-TabBar-addButton:hover {
  background-color: var(--jp-layout-color1);
}

.lm-DockPanel-tabBar .lm-TabBar-tab {
  width: var(--jp-private-horizontal-tab-width);
}

.lm-DockPanel-tabBar .lm-TabBar-content {
  flex: unset;
}

.lm-DockPanel-tabBar[data-orientation='horizontal'] {
  flex: 1 1 auto;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/**
 * Support for icons as inline SVG HTMLElements
 */

/* recolor the primary elements of an icon */
.jp-icon0[fill] {
  fill: var(--jp-inverse-layout-color0);
}

.jp-icon1[fill] {
  fill: var(--jp-inverse-layout-color1);
}

.jp-icon2[fill] {
  fill: var(--jp-inverse-layout-color2);
}

.jp-icon3[fill] {
  fill: var(--jp-inverse-layout-color3);
}

.jp-icon4[fill] {
  fill: var(--jp-inverse-layout-color4);
}

.jp-icon0[stroke] {
  stroke: var(--jp-inverse-layout-color0);
}

.jp-icon1[stroke] {
  stroke: var(--jp-inverse-layout-color1);
}

.jp-icon2[stroke] {
  stroke: var(--jp-inverse-layout-color2);
}

.jp-icon3[stroke] {
  stroke: var(--jp-inverse-layout-color3);
}

.jp-icon4[stroke] {
  stroke: var(--jp-inverse-layout-color4);
}

/* recolor the accent elements of an icon */
.jp-icon-accent0[fill] {
  fill: var(--jp-layout-color0);
}

.jp-icon-accent1[fill] {
  fill: var(--jp-layout-color1);
}

.jp-icon-accent2[fill] {
  fill: var(--jp-layout-color2);
}

.jp-icon-accent3[fill] {
  fill: var(--jp-layout-color3);
}

.jp-icon-accent4[fill] {
  fill: var(--jp-layout-color4);
}

.jp-icon-accent0[stroke] {
  stroke: var(--jp-layout-color0);
}

.jp-icon-accent1[stroke] {
  stroke: var(--jp-layout-color1);
}

.jp-icon-accent2[stroke] {
  stroke: var(--jp-layout-color2);
}

.jp-icon-accent3[stroke] {
  stroke: var(--jp-layout-color3);
}

.jp-icon-accent4[stroke] {
  stroke: var(--jp-layout-color4);
}

/* set the color of an icon to transparent */
.jp-icon-none[fill] {
  fill: none;
}

.jp-icon-none[stroke] {
  stroke: none;
}

/* brand icon colors. Same for light and dark */
.jp-icon-brand0[fill] {
  fill: var(--jp-brand-color0);
}

.jp-icon-brand1[fill] {
  fill: var(--jp-brand-color1);
}

.jp-icon-brand2[fill] {
  fill: var(--jp-brand-color2);
}

.jp-icon-brand3[fill] {
  fill: var(--jp-brand-color3);
}

.jp-icon-brand4[fill] {
  fill: var(--jp-brand-color4);
}

.jp-icon-brand0[stroke] {
  stroke: var(--jp-brand-color0);
}

.jp-icon-brand1[stroke] {
  stroke: var(--jp-brand-color1);
}

.jp-icon-brand2[stroke] {
  stroke: var(--jp-brand-color2);
}

.jp-icon-brand3[stroke] {
  stroke: var(--jp-brand-color3);
}

.jp-icon-brand4[stroke] {
  stroke: var(--jp-brand-color4);
}

/* warn icon colors. Same for light and dark */
.jp-icon-warn0[fill] {
  fill: var(--jp-warn-color0);
}

.jp-icon-warn1[fill] {
  fill: var(--jp-warn-color1);
}

.jp-icon-warn2[fill] {
  fill: var(--jp-warn-color2);
}

.jp-icon-warn3[fill] {
  fill: var(--jp-warn-color3);
}

.jp-icon-warn0[stroke] {
  stroke: var(--jp-warn-color0);
}

.jp-icon-warn1[stroke] {
  stroke: var(--jp-warn-color1);
}

.jp-icon-warn2[stroke] {
  stroke: var(--jp-warn-color2);
}

.jp-icon-warn3[stroke] {
  stroke: var(--jp-warn-color3);
}

/* icon colors that contrast well with each other and most backgrounds */
.jp-icon-contrast0[fill] {
  fill: var(--jp-icon-contrast-color0);
}

.jp-icon-contrast1[fill] {
  fill: var(--jp-icon-contrast-color1);
}

.jp-icon-contrast2[fill] {
  fill: var(--jp-icon-contrast-color2);
}

.jp-icon-contrast3[fill] {
  fill: var(--jp-icon-contrast-color3);
}

.jp-icon-contrast0[stroke] {
  stroke: var(--jp-icon-contrast-color0);
}

.jp-icon-contrast1[stroke] {
  stroke: var(--jp-icon-contrast-color1);
}

.jp-icon-contrast2[stroke] {
  stroke: var(--jp-icon-contrast-color2);
}

.jp-icon-contrast3[stroke] {
  stroke: var(--jp-icon-contrast-color3);
}

.jp-icon-dot[fill] {
  fill: var(--jp-warn-color0);
}

.jp-jupyter-icon-color[fill] {
  fill: var(--jp-jupyter-icon-color, var(--jp-warn-color0));
}

.jp-notebook-icon-color[fill] {
  fill: var(--jp-notebook-icon-color, var(--jp-warn-color0));
}

.jp-json-icon-color[fill] {
  fill: var(--jp-json-icon-color, var(--jp-warn-color1));
}

.jp-console-icon-color[fill] {
  fill: var(--jp-console-icon-color, white);
}

.jp-console-icon-background-color[fill] {
  fill: var(--jp-console-icon-background-color, var(--jp-brand-color1));
}

.jp-terminal-icon-color[fill] {
  fill: var(--jp-terminal-icon-color, var(--jp-layout-color2));
}

.jp-terminal-icon-background-color[fill] {
  fill: var(
    --jp-terminal-icon-background-color,
    var(--jp-inverse-layout-color2)
  );
}

.jp-text-editor-icon-color[fill] {
  fill: var(--jp-text-editor-icon-color, var(--jp-inverse-layout-color3));
}

.jp-inspector-icon-color[fill] {
  fill: var(--jp-inspector-icon-color, var(--jp-inverse-layout-color3));
}

/* CSS for icons in selected filebrowser listing items */
.jp-DirListing-item.jp-mod-selected .jp-icon-selectable[fill] {
  fill: #fff;
}

.jp-DirListing-item.jp-mod-selected .jp-icon-selectable-inverse[fill] {
  fill: var(--jp-brand-color1);
}

/* stylelint-disable selector-max-class, selector-max-compound-selectors */

/**
* TODO: come up with non css-hack solution for showing the busy icon on top
*  of the close icon
* CSS for complex behavior of close icon of tabs in the main area tabbar
*/
.lm-DockPanel-tabBar
  .lm-TabBar-tab.lm-mod-closable.jp-mod-dirty
  > .lm-TabBar-tabCloseIcon
  > :not(:hover)
  > .jp-icon3[fill] {
  fill: none;
}

.lm-DockPanel-tabBar
  .lm-TabBar-tab.lm-mod-closable.jp-mod-dirty
  > .lm-TabBar-tabCloseIcon
  > :not(:hover)
  > .jp-icon-busy[fill] {
  fill: var(--jp-inverse-layout-color3);
}

/* stylelint-enable selector-max-class, selector-max-compound-selectors */

/* CSS for icons in status bar */
#jp-main-statusbar .jp-mod-selected .jp-icon-selectable[fill] {
  fill: #fff;
}

#jp-main-statusbar .jp-mod-selected .jp-icon-selectable-inverse[fill] {
  fill: var(--jp-brand-color1);
}

/* special handling for splash icon CSS. While the theme CSS reloads during
   splash, the splash icon can loose theming. To prevent that, we set a
   default for its color variable */
:root {
  --jp-warn-color0: var(--md-orange-700);
}

/* not sure what to do with this one, used in filebrowser listing */
.jp-DragIcon {
  margin-right: 4px;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/**
 * Support for alt colors for icons as inline SVG HTMLElements
 */

/* alt recolor the primary elements of an icon */
.jp-icon-alt .jp-icon0[fill] {
  fill: var(--jp-layout-color0);
}

.jp-icon-alt .jp-icon1[fill] {
  fill: var(--jp-layout-color1);
}

.jp-icon-alt .jp-icon2[fill] {
  fill: var(--jp-layout-color2);
}

.jp-icon-alt .jp-icon3[fill] {
  fill: var(--jp-layout-color3);
}

.jp-icon-alt .jp-icon4[fill] {
  fill: var(--jp-layout-color4);
}

.jp-icon-alt .jp-icon0[stroke] {
  stroke: var(--jp-layout-color0);
}

.jp-icon-alt .jp-icon1[stroke] {
  stroke: var(--jp-layout-color1);
}

.jp-icon-alt .jp-icon2[stroke] {
  stroke: var(--jp-layout-color2);
}

.jp-icon-alt .jp-icon3[stroke] {
  stroke: var(--jp-layout-color3);
}

.jp-icon-alt .jp-icon4[stroke] {
  stroke: var(--jp-layout-color4);
}

/* alt recolor the accent elements of an icon */
.jp-icon-alt .jp-icon-accent0[fill] {
  fill: var(--jp-inverse-layout-color0);
}

.jp-icon-alt .jp-icon-accent1[fill] {
  fill: var(--jp-inverse-layout-color1);
}

.jp-icon-alt .jp-icon-accent2[fill] {
  fill: var(--jp-inverse-layout-color2);
}

.jp-icon-alt .jp-icon-accent3[fill] {
  fill: var(--jp-inverse-layout-color3);
}

.jp-icon-alt .jp-icon-accent4[fill] {
  fill: var(--jp-inverse-layout-color4);
}

.jp-icon-alt .jp-icon-accent0[stroke] {
  stroke: var(--jp-inverse-layout-color0);
}

.jp-icon-alt .jp-icon-accent1[stroke] {
  stroke: var(--jp-inverse-layout-color1);
}

.jp-icon-alt .jp-icon-accent2[stroke] {
  stroke: var(--jp-inverse-layout-color2);
}

.jp-icon-alt .jp-icon-accent3[stroke] {
  stroke: var(--jp-inverse-layout-color3);
}

.jp-icon-alt .jp-icon-accent4[stroke] {
  stroke: var(--jp-inverse-layout-color4);
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.jp-icon-hoverShow:not(:hover) .jp-icon-hoverShow-content {
  display: none !important;
}

/**
 * Support for hover colors for icons as inline SVG HTMLElements
 */

/**
 * regular colors
 */

/* recolor the primary elements of an icon */
.jp-icon-hover :hover .jp-icon0-hover[fill] {
  fill: var(--jp-inverse-layout-color0);
}

.jp-icon-hover :hover .jp-icon1-hover[fill] {
  fill: var(--jp-inverse-layout-color1);
}

.jp-icon-hover :hover .jp-icon2-hover[fill] {
  fill: var(--jp-inverse-layout-color2);
}

.jp-icon-hover :hover .jp-icon3-hover[fill] {
  fill: var(--jp-inverse-layout-color3);
}

.jp-icon-hover :hover .jp-icon4-hover[fill] {
  fill: var(--jp-inverse-layout-color4);
}

.jp-icon-hover :hover .jp-icon0-hover[stroke] {
  stroke: var(--jp-inverse-layout-color0);
}

.jp-icon-hover :hover .jp-icon1-hover[stroke] {
  stroke: var(--jp-inverse-layout-color1);
}

.jp-icon-hover :hover .jp-icon2-hover[stroke] {
  stroke: var(--jp-inverse-layout-color2);
}

.jp-icon-hover :hover .jp-icon3-hover[stroke] {
  stroke: var(--jp-inverse-layout-color3);
}

.jp-icon-hover :hover .jp-icon4-hover[stroke] {
  stroke: var(--jp-inverse-layout-color4);
}

/* recolor the accent elements of an icon */
.jp-icon-hover :hover .jp-icon-accent0-hover[fill] {
  fill: var(--jp-layout-color0);
}

.jp-icon-hover :hover .jp-icon-accent1-hover[fill] {
  fill: var(--jp-layout-color1);
}

.jp-icon-hover :hover .jp-icon-accent2-hover[fill] {
  fill: var(--jp-layout-color2);
}

.jp-icon-hover :hover .jp-icon-accent3-hover[fill] {
  fill: var(--jp-layout-color3);
}

.jp-icon-hover :hover .jp-icon-accent4-hover[fill] {
  fill: var(--jp-layout-color4);
}

.jp-icon-hover :hover .jp-icon-accent0-hover[stroke] {
  stroke: var(--jp-layout-color0);
}

.jp-icon-hover :hover .jp-icon-accent1-hover[stroke] {
  stroke: var(--jp-layout-color1);
}

.jp-icon-hover :hover .jp-icon-accent2-hover[stroke] {
  stroke: var(--jp-layout-color2);
}

.jp-icon-hover :hover .jp-icon-accent3-hover[stroke] {
  stroke: var(--jp-layout-color3);
}

.jp-icon-hover :hover .jp-icon-accent4-hover[stroke] {
  stroke: var(--jp-layout-color4);
}

/* set the color of an icon to transparent */
.jp-icon-hover :hover .jp-icon-none-hover[fill] {
  fill: none;
}

.jp-icon-hover :hover .jp-icon-none-hover[stroke] {
  stroke: none;
}

/**
 * inverse colors
 */

/* inverse recolor the primary elements of an icon */
.jp-icon-hover.jp-icon-alt :hover .jp-icon0-hover[fill] {
  fill: var(--jp-layout-color0);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon1-hover[fill] {
  fill: var(--jp-layout-color1);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon2-hover[fill] {
  fill: var(--jp-layout-color2);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon3-hover[fill] {
  fill: var(--jp-layout-color3);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon4-hover[fill] {
  fill: var(--jp-layout-color4);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon0-hover[stroke] {
  stroke: var(--jp-layout-color0);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon1-hover[stroke] {
  stroke: var(--jp-layout-color1);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon2-hover[stroke] {
  stroke: var(--jp-layout-color2);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon3-hover[stroke] {
  stroke: var(--jp-layout-color3);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon4-hover[stroke] {
  stroke: var(--jp-layout-color4);
}

/* inverse recolor the accent elements of an icon */
.jp-icon-hover.jp-icon-alt :hover .jp-icon-accent0-hover[fill] {
  fill: var(--jp-inverse-layout-color0);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon-accent1-hover[fill] {
  fill: var(--jp-inverse-layout-color1);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon-accent2-hover[fill] {
  fill: var(--jp-inverse-layout-color2);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon-accent3-hover[fill] {
  fill: var(--jp-inverse-layout-color3);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon-accent4-hover[fill] {
  fill: var(--jp-inverse-layout-color4);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon-accent0-hover[stroke] {
  stroke: var(--jp-inverse-layout-color0);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon-accent1-hover[stroke] {
  stroke: var(--jp-inverse-layout-color1);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon-accent2-hover[stroke] {
  stroke: var(--jp-inverse-layout-color2);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon-accent3-hover[stroke] {
  stroke: var(--jp-inverse-layout-color3);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon-accent4-hover[stroke] {
  stroke: var(--jp-inverse-layout-color4);
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.jp-IFrame {
  width: 100%;
  height: 100%;
}

.jp-IFrame > iframe {
  border: none;
}

/*
When drag events occur, `lm-mod-override-cursor` is added to the body.
Because iframes steal all cursor events, the following two rules are necessary
to suppress pointer events while resize drags are occurring. There may be a
better solution to this problem.
*/
body.lm-mod-override-cursor .jp-IFrame {
  position: relative;
}

body.lm-mod-override-cursor .jp-IFrame::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: transparent;
}

/*-----------------------------------------------------------------------------
| Copyright (c) 2014-2016, Jupyter Development Team.
|
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.jp-HoverBox {
  position: fixed;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.jp-FormGroup-content fieldset {
  border: none;
  padding: 0;
  min-width: 0;
  width: 100%;
}

/* stylelint-disable selector-max-type */

.jp-FormGroup-content fieldset .jp-inputFieldWrapper input,
.jp-FormGroup-content fieldset .jp-inputFieldWrapper select,
.jp-FormGroup-content fieldset .jp-inputFieldWrapper textarea {
  font-size: var(--jp-content-font-size2);
  border-color: var(--jp-input-border-color);
  border-style: solid;
  border-radius: var(--jp-border-radius);
  border-width: 1px;
  padding: 6px 8px;
  background: none;
  color: var(--jp-ui-font-color0);
  height: inherit;
}

.jp-FormGroup-content fieldset input[type='checkbox'] {
  position: relative;
  top: 2px;
  margin-left: 0;
}

.jp-FormGroup-content button.jp-mod-styled {
  cursor: pointer;
}

.jp-FormGroup-content .checkbox label {
  cursor: pointer;
  font-size: var(--jp-content-font-size1);
}

.jp-FormGroup-content .jp-root > fieldset > legend {
  display: none;
}

.jp-FormGroup-content .jp-root > fieldset > p {
  display: none;
}

/** copy of `input.jp-mod-styled:focus` style */
.jp-FormGroup-content fieldset input:focus,
.jp-FormGroup-content fieldset select:focus {
  -moz-outline-radius: unset;
  outline: var(--jp-border-width) solid var(--md-blue-500);
  outline-offset: -1px;
  box-shadow: inset 0 0 4px var(--md-blue-300);
}

.jp-FormGroup-content fieldset input:hover:not(:focus),
.jp-FormGroup-content fieldset select:hover:not(:focus) {
  background-color: var(--jp-border-color2);
}

/* stylelint-enable selector-max-type */

.jp-FormGroup-content .checkbox .field-description {
  /* Disable default description field for checkbox:
   because other widgets do not have description fields,
   we add descriptions to each widget on the field level.
  */
  display: none;
}

.jp-FormGroup-content #root__description {
  display: none;
}

.jp-FormGroup-content .jp-modifiedIndicator {
  width: 5px;
  background-color: var(--jp-brand-color2);
  margin-top: 0;
  margin-left: calc(var(--jp-private-settingeditor-modifier-indent) * -1);
  flex-shrink: 0;
}

.jp-FormGroup-content .jp-modifiedIndicator.jp-errorIndicator {
  background-color: var(--jp-error-color0);
  margin-right: 0.5em;
}

/* RJSF ARRAY style */

.jp-arrayFieldWrapper legend {
  font-size: var(--jp-content-font-size2);
  color: var(--jp-ui-font-color0);
  flex-basis: 100%;
  padding: 4px 0;
  font-weight: var(--jp-content-heading-font-weight);
  border-bottom: 1px solid var(--jp-border-color2);
}

.jp-arrayFieldWrapper .field-description {
  padding: 4px 0;
  white-space: pre-wrap;
}

.jp-arrayFieldWrapper .array-item {
  width: 100%;
  border: 1px solid var(--jp-border-color2);
  border-radius: 4px;
  margin: 4px;
}

.jp-ArrayOperations {
  display: flex;
  margin-left: 8px;
}

.jp-ArrayOperationsButton {
  margin: 2px;
}

.jp-ArrayOperationsButton .jp-icon3[fill] {
  fill: var(--jp-ui-font-color0);
}

button.jp-ArrayOperationsButton.jp-mod-styled:disabled {
  cursor: not-allowed;
  opacity: 0.5;
}

/* RJSF form validation error */

.jp-FormGroup-content .validationErrors {
  color: var(--jp-error-color0);
}

/* Hide panel level error as duplicated the field level error */
.jp-FormGroup-content .panel.errors {
  display: none;
}

/* RJSF normal content (settings-editor) */

.jp-FormGroup-contentNormal {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
}

.jp-FormGroup-contentNormal .jp-FormGroup-contentItem {
  margin-left: 7px;
  color: var(--jp-ui-font-color0);
}

.jp-FormGroup-contentNormal .jp-FormGroup-description {
  flex-basis: 100%;
  padding: 4px 7px;
}

.jp-FormGroup-contentNormal .jp-FormGroup-default {
  flex-basis: 100%;
  padding: 4px 7px;
}

.jp-FormGroup-contentNormal .jp-FormGroup-fieldLabel {
  font-size: var(--jp-content-font-size1);
  font-weight: normal;
  min-width: 120px;
}

.jp-FormGroup-contentNormal fieldset:not(:first-child) {
  margin-left: 7px;
}

.jp-FormGroup-contentNormal .field-array-of-string .array-item {
  /* Display `jp-ArrayOperations` buttons side-by-side with content except
    for small screens where flex-wrap will place them one below the other.
  */
  display: flex;
  align-items: center;
  flex-wrap: wrap;
}

.jp-FormGroup-contentNormal .jp-objectFieldWrapper .form-group {
  padding: 2px 8px 2px var(--jp-private-settingeditor-modifier-indent);
  margin-top: 2px;
}

/* RJSF compact content (metadata-form) */

.jp-FormGroup-content.jp-FormGroup-contentCompact {
  width: 100%;
}

.jp-FormGroup-contentCompact .form-group {
  display: flex;
  padding: 0.5em 0.2em 0.5em 0;
}

.jp-FormGroup-contentCompact
  .jp-FormGroup-compactTitle
  .jp-FormGroup-description {
  font-size: var(--jp-ui-font-size1);
  color: var(--jp-ui-font-color2);
}

.jp-FormGroup-contentCompact .jp-FormGroup-fieldLabel {
  padding-bottom: 0.3em;
}

.jp-FormGroup-contentCompact .jp-inputFieldWrapper .form-control {
  width: 100%;
  box-sizing: border-box;
}

.jp-FormGroup-contentCompact .jp-arrayFieldWrapper .jp-FormGroup-compactTitle {
  padding-bottom: 7px;
}

.jp-FormGroup-contentCompact
  .jp-objectFieldWrapper
  .jp-objectFieldWrapper
  .form-group {
  padding: 2px 8px 2px var(--jp-private-settingeditor-modifier-indent);
  margin-top: 2px;
}

.jp-FormGroup-contentCompact ul.error-detail {
  margin-block-start: 0.5em;
  margin-block-end: 0.5em;
  padding-inline-start: 1em;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

.jp-SidePanel {
  display: flex;
  flex-direction: column;
  min-width: var(--jp-sidebar-min-width);
  overflow-y: auto;
  color: var(--jp-ui-font-color1);
  background: var(--jp-layout-color1);
  font-size: var(--jp-ui-font-size1);
}

.jp-SidePanel-header {
  flex: 0 0 auto;
  display: flex;
  border-bottom: var(--jp-border-width) solid var(--jp-border-color2);
  font-size: var(--jp-ui-font-size0);
  font-weight: 600;
  letter-spacing: 1px;
  margin: 0;
  padding: 2px;
  text-transform: uppercase;
}

.jp-SidePanel-toolbar {
  flex: 0 0 auto;
}

.jp-SidePanel-content {
  flex: 1 1 auto;
}

.jp-SidePanel-toolbar,
.jp-AccordionPanel-toolbar {
  height: var(--jp-private-toolbar-height);
}

.jp-SidePanel-toolbar.jp-Toolbar-micro {
  display: none;
}

.lm-AccordionPanel .jp-AccordionPanel-title {
  box-sizing: border-box;
  line-height: 25px;
  margin: 0;
  display: flex;
  align-items: center;
  background: var(--jp-layout-color1);
  color: var(--jp-ui-font-color1);
  border-bottom: var(--jp-border-width) solid var(--jp-toolbar-border-color);
  box-shadow: var(--jp-toolbar-box-shadow);
  font-size: var(--jp-ui-font-size0);
}

.jp-AccordionPanel-title {
  cursor: pointer;
  user-select: none;
  -moz-user-select: none;
  -webkit-user-select: none;
  text-transform: uppercase;
}

.lm-AccordionPanel[data-orientation='horizontal'] > .jp-AccordionPanel-title {
  /* Title is rotated for horizontal accordion panel using CSS */
  display: block;
  transform-origin: top left;
  transform: rotate(-90deg) translate(-100%);
}

.jp-AccordionPanel-title .lm-AccordionPanel-titleLabel {
  user-select: none;
  text-overflow: ellipsis;
  white-space: nowrap;
  overflow: hidden;
}

.jp-AccordionPanel-title .lm-AccordionPanel-titleCollapser {
  transform: rotate(-90deg);
  margin: auto 0;
  height: 16px;
}

.jp-AccordionPanel-title.lm-mod-expanded .lm-AccordionPanel-titleCollapser {
  transform: rotate(0deg);
}

.lm-AccordionPanel .jp-AccordionPanel-toolbar {
  background: none;
  box-shadow: none;
  border: none;
  margin-left: auto;
}

.lm-AccordionPanel .lm-SplitPanel-handle:hover {
  background: var(--jp-layout-color3);
}

.jp-text-truncated {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/*-----------------------------------------------------------------------------
| Copyright (c) 2017, Jupyter Development Team.
|
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.jp-Spinner {
  position: absolute;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 10;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background: var(--jp-layout-color0);
  outline: none;
}

.jp-SpinnerContent {
  font-size: 10px;
  margin: 50px auto;
  text-indent: -9999em;
  width: 3em;
  height: 3em;
  border-radius: 50%;
  background: var(--jp-brand-color3);
  background: linear-gradient(
    to right,
    #f37626 10%,
    rgba(255, 255, 255, 0) 42%
  );
  position: relative;
  animation: load3 1s infinite linear, fadeIn 1s;
}

.jp-SpinnerContent::before {
  width: 50%;
  height: 50%;
  background: #f37626;
  border-radius: 100% 0 0;
  position: absolute;
  top: 0;
  left: 0;
  content: '';
}

.jp-SpinnerContent::after {
  background: var(--jp-layout-color0);
  width: 75%;
  height: 75%;
  border-radius: 50%;
  content: '';
  margin: auto;
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0;
  right: 0;
}

@keyframes fadeIn {
  0% {
    opacity: 0;
  }

  100% {
    opacity: 1;
  }
}

@keyframes load3 {
  0% {
    transform: rotate(0deg);
  }

  100% {
    transform: rotate(360deg);
  }
}

/*-----------------------------------------------------------------------------
| Copyright (c) 2014-2017, Jupyter Development Team.
|
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

button.jp-mod-styled {
  font-size: var(--jp-ui-font-size1);
  color: var(--jp-ui-font-color0);
  border: none;
  box-sizing: border-box;
  text-align: center;
  line-height: 32px;
  height: 32px;
  padding: 0 12px;
  letter-spacing: 0.8px;
  outline: none;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
}

input.jp-mod-styled {
  background: var(--jp-input-background);
  height: 28px;
  box-sizing: border-box;
  border: var(--jp-border-width) solid var(--jp-border-color1);
  padding-left: 7px;
  padding-right: 7px;
  font-size: var(--jp-ui-font-size2);
  color: var(--jp-ui-font-color0);
  outline: none;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
}

input[type='checkbox'].jp-mod-styled {
  appearance: checkbox;
  -webkit-appearance: checkbox;
  -moz-appearance: checkbox;
  height: auto;
}

input.jp-mod-styled:focus {
  border: var(--jp-border-width) solid var(--md-blue-500);
  box-shadow: inset 0 0 4px var(--md-blue-300);
}

.jp-select-wrapper {
  display: flex;
  position: relative;
  flex-direction: column;
  padding: 1px;
  background-color: var(--jp-layout-color1);
  box-sizing: border-box;
  margin-bottom: 12px;
}

.jp-select-wrapper:not(.multiple) {
  height: 28px;
}

.jp-select-wrapper.jp-mod-focused select.jp-mod-styled {
  border: var(--jp-border-width) solid var(--jp-input-active-border-color);
  box-shadow: var(--jp-input-box-shadow);
  background-color: var(--jp-input-active-background);
}

select.jp-mod-styled:hover {
  cursor: pointer;
  color: var(--jp-ui-font-color0);
  background-color: var(--jp-input-hover-background);
  box-shadow: inset 0 0 1px rgba(0, 0, 0, 0.5);
}

select.jp-mod-styled {
  flex: 1 1 auto;
  width: 100%;
  font-size: var(--jp-ui-font-size2);
  background: var(--jp-input-background);
  color: var(--jp-ui-font-color0);
  padding: 0 25px 0 8px;
  border: var(--jp-border-width) solid var(--jp-input-border-color);
  border-radius: 0;
  outline: none;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
}

select.jp-mod-styled:not([multiple]) {
  height: 32px;
}

select.jp-mod-styled[multiple] {
  max-height: 200px;
  overflow-y: auto;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.jp-switch {
  display: flex;
  align-items: center;
  padding-left: 4px;
  padding-right: 4px;
  font-size: var(--jp-ui-font-size1);
  background-color: transparent;
  color: var(--jp-ui-font-color1);
  border: none;
  height: 20px;
}

.jp-switch:hover {
  background-color: var(--jp-layout-color2);
}

.jp-switch-label {
  margin-right: 5px;
  font-family: var(--jp-ui-font-family);
}

.jp-switch-track {
  cursor: pointer;
  background-color: var(--jp-switch-color, var(--jp-border-color1));
  -webkit-transition: 0.4s;
  transition: 0.4s;
  border-radius: 34px;
  height: 16px;
  width: 35px;
  position: relative;
}

.jp-switch-track::before {
  content: '';
  position: absolute;
  height: 10px;
  width: 10px;
  margin: 3px;
  left: 0;
  background-color: var(--jp-ui-inverse-font-color1);
  -webkit-transition: 0.4s;
  transition: 0.4s;
  border-radius: 50%;
}

.jp-switch[aria-checked='true'] .jp-switch-track {
  background-color: var(--jp-switch-true-position-color, var(--jp-warn-color0));
}

.jp-switch[aria-checked='true'] .jp-switch-track::before {
  /* track width (35) - margins (3 + 3) - thumb width (10) */
  left: 19px;
}

/*-----------------------------------------------------------------------------
| Copyright (c) 2014-2016, Jupyter Development Team.
|
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

:root {
  --jp-private-toolbar-height: calc(
    28px + var(--jp-border-width)
  ); /* leave 28px for content */
}

.jp-Toolbar {
  color: var(--jp-ui-font-color1);
  flex: 0 0 auto;
  display: flex;
  flex-direction: row;
  border-bottom: var(--jp-border-width) solid var(--jp-toolbar-border-color);
  box-shadow: var(--jp-toolbar-box-shadow);
  background: var(--jp-toolbar-background);
  min-height: var(--jp-toolbar-micro-height);
  padding: 2px;
  z-index: 8;
  overflow-x: hidden;
}

/* Toolbar items */

.jp-Toolbar > .jp-Toolbar-item.jp-Toolbar-spacer {
  flex-grow: 1;
  flex-shrink: 1;
}

.jp-Toolbar-item.jp-Toolbar-kernelStatus {
  display: inline-block;
  width: 32px;
  background-repeat: no-repeat;
  background-position: center;
  background-size: 16px;
}

.jp-Toolbar > .jp-Toolbar-item {
  flex: 0 0 auto;
  display: flex;
  padding-left: 1px;
  padding-right: 1px;
  font-size: var(--jp-ui-font-size1);
  line-height: var(--jp-private-toolbar-height);
  height: 100%;
}

/* Toolbar buttons */

/* This is the div we use to wrap the react component into a Widget */
div.jp-ToolbarButton {
  color: transparent;
  border: none;
  box-sizing: border-box;
  outline: none;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  padding: 0;
  margin: 0;
}

button.jp-ToolbarButtonComponent {
  background: var(--jp-layout-color1);
  border: none;
  box-sizing: border-box;
  outline: none;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  padding: 0 6px;
  margin: 0;
  height: 24px;
  border-radius: var(--jp-border-radius);
  display: flex;
  align-items: center;
  text-align: center;
  font-size: 14px;
  min-width: unset;
  min-height: unset;
}

button.jp-ToolbarButtonComponent:disabled {
  opacity: 0.4;
}

button.jp-ToolbarButtonComponent > span {
  padding: 0;
  flex: 0 0 auto;
}

button.jp-ToolbarButtonComponent .jp-ToolbarButtonComponent-label {
  font-size: var(--jp-ui-font-size1);
  line-height: 100%;
  padding-left: 2px;
  color: var(--jp-ui-font-color1);
  font-family: var(--jp-ui-font-family);
}

#jp-main-dock-panel[data-mode='single-document']
  .jp-MainAreaWidget
  > .jp-Toolbar.jp-Toolbar-micro {
  padding: 0;
  min-height: 0;
}

#jp-main-dock-panel[data-mode='single-document']
  .jp-MainAreaWidget
  > .jp-Toolbar {
  border: none;
  box-shadow: none;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

.jp-WindowedPanel-outer {
  position: relative;
  overflow-y: auto;
}

.jp-WindowedPanel-inner {
  position: relative;
}

.jp-WindowedPanel-window {
  position: absolute;
  left: 0;
  right: 0;
  overflow: visible;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/* Sibling imports */

body {
  color: var(--jp-ui-font-color1);
  font-size: var(--jp-ui-font-size1);
}

/* Disable native link decoration styles everywhere outside of dialog boxes */
a {
  text-decoration: unset;
  color: unset;
}

a:hover {
  text-decoration: unset;
  color: unset;
}

/* Accessibility for links inside dialog box text */
.jp-Dialog-content a {
  text-decoration: revert;
  color: var(--jp-content-link-color);
}

.jp-Dialog-content a:hover {
  text-decoration: revert;
}

/* Styles for ui-components */
.jp-Button {
  color: var(--jp-ui-font-color2);
  border-radius: var(--jp-border-radius);
  padding: 0 12px;
  font-size: var(--jp-ui-font-size1);

  /* Copy from blueprint 3 */
  display: inline-flex;
  flex-direction: row;
  border: none;
  cursor: pointer;
  align-items: center;
  justify-content: center;
  text-align: left;
  vertical-align: middle;
  min-height: 30px;
  min-width: 30px;
}

.jp-Button:disabled {
  cursor: not-allowed;
}

.jp-Button:empty {
  padding: 0 !important;
}

.jp-Button.jp-mod-small {
  min-height: 24px;
  min-width: 24px;
  font-size: 12px;
  padding: 0 7px;
}

/* Use our own theme for hover styles */
.jp-Button.jp-mod-minimal:hover {
  background-color: var(--jp-layout-color2);
}

.jp-Button.jp-mod-minimal {
  background: none;
}

.jp-InputGroup {
  display: block;
  position: relative;
}

.jp-InputGroup input {
  box-sizing: border-box;
  border: none;
  border-radius: 0;
  background-color: transparent;
  color: var(--jp-ui-font-color0);
  box-shadow: inset 0 0 0 var(--jp-border-width) var(--jp-input-border-color);
  padding-bottom: 0;
  padding-top: 0;
  padding-left: 10px;
  padding-right: 28px;
  position: relative;
  width: 100%;
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  font-size: 14px;
  font-weight: 400;
  height: 30px;
  line-height: 30px;
  outline: none;
  vertical-align: middle;
}

.jp-InputGroup input:focus {
  box-shadow: inset 0 0 0 var(--jp-border-width)
      var(--jp-input-active-box-shadow-color),
    inset 0 0 0 3px var(--jp-input-active-box-shadow-color);
}

.jp-InputGroup input:disabled {
  cursor: not-allowed;
  resize: block;
  background-color: var(--jp-layout-color2);
  color: var(--jp-ui-font-color2);
}

.jp-InputGroup input:disabled ~ span {
  cursor: not-allowed;
  color: var(--jp-ui-font-color2);
}

.jp-InputGroup input::placeholder,
input::placeholder {
  color: var(--jp-ui-font-color2);
}

.jp-InputGroupAction {
  position: absolute;
  bottom: 1px;
  right: 0;
  padding: 6px;
}

.jp-HTMLSelect.jp-DefaultStyle select {
  background-color: initial;
  border: none;
  border-radius: 0;
  box-shadow: none;
  color: var(--jp-ui-font-color0);
  display: block;
  font-size: var(--jp-ui-font-size1);
  font-family: var(--jp-ui-font-family);
  height: 24px;
  line-height: 14px;
  padding: 0 25px 0 10px;
  text-align: left;
  -moz-appearance: none;
  -webkit-appearance: none;
}

.jp-HTMLSelect.jp-DefaultStyle select:disabled {
  background-color: var(--jp-layout-color2);
  color: var(--jp-ui-font-color2);
  cursor: not-allowed;
  resize: block;
}

.jp-HTMLSelect.jp-DefaultStyle select:disabled ~ span {
  cursor: not-allowed;
}

/* Use our own theme for hover and option styles */
/* stylelint-disable-next-line selector-max-type */
.jp-HTMLSelect.jp-DefaultStyle select:hover,
.jp-HTMLSelect.jp-DefaultStyle select > option {
  background-color: var(--jp-layout-color2);
  color: var(--jp-ui-font-color0);
}

select {
  box-sizing: border-box;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Styles
|----------------------------------------------------------------------------*/

.jp-StatusBar-Widget {
  display: flex;
  align-items: center;
  background: var(--jp-layout-color2);
  min-height: var(--jp-statusbar-height);
  justify-content: space-between;
  padding: 0 10px;
}

.jp-StatusBar-Left {
  display: flex;
  align-items: center;
  flex-direction: row;
}

.jp-StatusBar-Middle {
  display: flex;
  align-items: center;
}

.jp-StatusBar-Right {
  display: flex;
  align-items: center;
  flex-direction: row-reverse;
}

.jp-StatusBar-Item {
  max-height: var(--jp-statusbar-height);
  margin: 0 2px;
  height: var(--jp-statusbar-height);
  white-space: nowrap;
  text-overflow: ellipsis;
  color: var(--jp-ui-font-color1);
  padding: 0 6px;
}

.jp-mod-highlighted:hover {
  background-color: var(--jp-layout-color3);
}

.jp-mod-clicked {
  background-color: var(--jp-brand-color1);
}

.jp-mod-clicked:hover {
  background-color: var(--jp-brand-color0);
}

.jp-mod-clicked .jp-StatusBar-TextItem {
  color: var(--jp-ui-inverse-font-color1);
}

.jp-StatusBar-HoverItem {
  box-shadow: '0px 4px 4px rgba(0, 0, 0, 0.25)';
}

.jp-StatusBar-TextItem {
  font-size: var(--jp-ui-font-size1);
  font-family: var(--jp-ui-font-family);
  line-height: 24px;
  color: var(--jp-ui-font-color1);
}

.jp-StatusBar-GroupItem {
  display: flex;
  align-items: center;
  flex-direction: row;
}

.jp-Statusbar-ProgressCircle svg {
  display: block;
  margin: 0 auto;
  width: 16px;
  height: 24px;
  align-self: normal;
}

.jp-Statusbar-ProgressCircle path {
  fill: var(--jp-inverse-layout-color3);
}

.jp-Statusbar-ProgressBar-progress-bar {
  height: 10px;
  width: 100px;
  border: solid 0.25px var(--jp-brand-color2);
  border-radius: 3px;
  overflow: hidden;
  align-self: center;
}

.jp-Statusbar-ProgressBar-progress-bar > div {
  background-color: var(--jp-brand-color2);
  background-image: linear-gradient(
    -45deg,
    rgba(255, 255, 255, 0.2) 25%,
    transparent 25%,
    transparent 50%,
    rgba(255, 255, 255, 0.2) 50%,
    rgba(255, 255, 255, 0.2) 75%,
    transparent 75%,
    transparent
  );
  background-size: 40px 40px;
  float: left;
  width: 0%;
  height: 100%;
  font-size: 12px;
  line-height: 14px;
  color: #fff;
  text-align: center;
  animation: jp-Statusbar-ExecutionTime-progress-bar 2s linear infinite;
}

.jp-Statusbar-ProgressBar-progress-bar p {
  color: var(--jp-ui-font-color1);
  font-family: var(--jp-ui-font-family);
  font-size: var(--jp-ui-font-size1);
  line-height: 10px;
  width: 100px;
}

@keyframes jp-Statusbar-ExecutionTime-progress-bar {
  0% {
    background-position: 0 0;
  }

  100% {
    background-position: 40px 40px;
  }
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Variables
|----------------------------------------------------------------------------*/

:root {
  --jp-private-commandpalette-search-height: 28px;
}

/*-----------------------------------------------------------------------------
| Overall styles
|----------------------------------------------------------------------------*/

.lm-CommandPalette {
  padding-bottom: 0;
  color: var(--jp-ui-font-color1);
  background: var(--jp-layout-color1);

  /* This is needed so that all font sizing of children done in ems is
   * relative to this base size */
  font-size: var(--jp-ui-font-size1);
}

/*-----------------------------------------------------------------------------
| Modal variant
|----------------------------------------------------------------------------*/

.jp-ModalCommandPalette {
  position: absolute;
  z-index: 10000;
  top: 38px;
  left: 30%;
  margin: 0;
  padding: 4px;
  width: 40%;
  box-shadow: var(--jp-elevation-z4);
  border-radius: 4px;
  background: var(--jp-layout-color0);
}

.jp-ModalCommandPalette .lm-CommandPalette {
  max-height: 40vh;
}

.jp-ModalCommandPalette .lm-CommandPalette .lm-close-icon::after {
  display: none;
}

.jp-ModalCommandPalette .lm-CommandPalette .lm-CommandPalette-header {
  display: none;
}

.jp-ModalCommandPalette .lm-CommandPalette .lm-CommandPalette-item {
  margin-left: 4px;
  margin-right: 4px;
}

.jp-ModalCommandPalette
  .lm-CommandPalette
  .lm-CommandPalette-item.lm-mod-disabled {
  display: none;
}

/*-----------------------------------------------------------------------------
| Search
|----------------------------------------------------------------------------*/

.lm-CommandPalette-search {
  padding: 4px;
  background-color: var(--jp-layout-color1);
  z-index: 2;
}

.lm-CommandPalette-wrapper {
  overflow: overlay;
  padding: 0 9px;
  background-color: var(--jp-input-active-background);
  height: 30px;
  box-shadow: inset 0 0 0 var(--jp-border-width) var(--jp-input-border-color);
}

.lm-CommandPalette.lm-mod-focused .lm-CommandPalette-wrapper {
  box-shadow: inset 0 0 0 1px var(--jp-input-active-box-shadow-color),
    inset 0 0 0 3px var(--jp-input-active-box-shadow-color);
}

.jp-SearchIconGroup {
  color: white;
  background-color: var(--jp-brand-color1);
  position: absolute;
  top: 4px;
  right: 4px;
  padding: 5px 5px 1px;
}

.jp-SearchIconGroup svg {
  height: 20px;
  width: 20px;
}

.jp-SearchIconGroup .jp-icon3[fill] {
  fill: var(--jp-layout-color0);
}

.lm-CommandPalette-input {
  background: transparent;
  width: calc(100% - 18px);
  float: left;
  border: none;
  outline: none;
  font-size: var(--jp-ui-font-size1);
  color: var(--jp-ui-font-color0);
  line-height: var(--jp-private-commandpalette-search-height);
}

.lm-CommandPalette-input::-webkit-input-placeholder,
.lm-CommandPalette-input::-moz-placeholder,
.lm-CommandPalette-input:-ms-input-placeholder {
  color: var(--jp-ui-font-color2);
  font-size: var(--jp-ui-font-size1);
}

/*-----------------------------------------------------------------------------
| Results
|----------------------------------------------------------------------------*/

.lm-CommandPalette-header:first-child {
  margin-top: 0;
}

.lm-CommandPalette-header {
  border-bottom: solid var(--jp-border-width) var(--jp-border-color2);
  color: var(--jp-ui-font-color1);
  cursor: pointer;
  display: flex;
  font-size: var(--jp-ui-font-size0);
  font-weight: 600;
  letter-spacing: 1px;
  margin-top: 8px;
  padding: 8px 0 8px 12px;
  text-transform: uppercase;
}

.lm-CommandPalette-header.lm-mod-active {
  background: var(--jp-layout-color2);
}

.lm-CommandPalette-header > mark {
  background-color: transparent;
  font-weight: bold;
  color: var(--jp-ui-font-color1);
}

.lm-CommandPalette-item {
  padding: 4px 12px 4px 4px;
  color: var(--jp-ui-font-color1);
  font-size: var(--jp-ui-font-size1);
  font-weight: 400;
  display: flex;
}

.lm-CommandPalette-item.lm-mod-disabled {
  color: var(--jp-ui-font-color2);
}

.lm-CommandPalette-item.lm-mod-active {
  color: var(--jp-ui-inverse-font-color1);
  background: var(--jp-brand-color1);
}

.lm-CommandPalette-item.lm-mod-active .lm-CommandPalette-itemLabel > mark {
  color: var(--jp-ui-inverse-font-color0);
}

.lm-CommandPalette-item.lm-mod-active .jp-icon-selectable[fill] {
  fill: var(--jp-layout-color0);
}

.lm-CommandPalette-item.lm-mod-active:hover:not(.lm-mod-disabled) {
  color: var(--jp-ui-inverse-font-color1);
  background: var(--jp-brand-color1);
}

.lm-CommandPalette-item:hover:not(.lm-mod-active):not(.lm-mod-disabled) {
  background: var(--jp-layout-color2);
}

.lm-CommandPalette-itemContent {
  overflow: hidden;
}

.lm-CommandPalette-itemLabel > mark {
  color: var(--jp-ui-font-color0);
  background-color: transparent;
  font-weight: bold;
}

.lm-CommandPalette-item.lm-mod-disabled mark {
  color: var(--jp-ui-font-color2);
}

.lm-CommandPalette-item .lm-CommandPalette-itemIcon {
  margin: 0 4px 0 0;
  position: relative;
  width: 16px;
  top: 2px;
  flex: 0 0 auto;
}

.lm-CommandPalette-item.lm-mod-disabled .lm-CommandPalette-itemIcon {
  opacity: 0.6;
}

.lm-CommandPalette-item .lm-CommandPalette-itemShortcut {
  flex: 0 0 auto;
}

.lm-CommandPalette-itemCaption {
  display: none;
}

.lm-CommandPalette-content {
  background-color: var(--jp-layout-color1);
}

.lm-CommandPalette-content:empty::after {
  content: 'No results';
  margin: auto;
  margin-top: 20px;
  width: 100px;
  display: block;
  font-size: var(--jp-ui-font-size2);
  font-family: var(--jp-ui-font-family);
  font-weight: lighter;
}

.lm-CommandPalette-emptyMessage {
  text-align: center;
  margin-top: 24px;
  line-height: 1.32;
  padding: 0 8px;
  color: var(--jp-content-font-color3);
}

/*-----------------------------------------------------------------------------
| Copyright (c) 2014-2017, Jupyter Development Team.
|
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.jp-Dialog {
  position: absolute;
  z-index: 10000;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  top: 0;
  left: 0;
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  background: var(--jp-dialog-background);
}

.jp-Dialog-content {
  display: flex;
  flex-direction: column;
  margin-left: auto;
  margin-right: auto;
  background: var(--jp-layout-color1);
  padding: 24px 24px 12px;
  min-width: 300px;
  min-height: 150px;
  max-width: 1000px;
  max-height: 500px;
  box-sizing: border-box;
  box-shadow: var(--jp-elevation-z20);
  word-wrap: break-word;
  border-radius: var(--jp-border-radius);

  /* This is needed so that all font sizing of children done in ems is
   * relative to this base size */
  font-size: var(--jp-ui-font-size1);
  color: var(--jp-ui-font-color1);
  resize: both;
}

.jp-Dialog-content.jp-Dialog-content-small {
  max-width: 500px;
}

.jp-Dialog-button {
  overflow: visible;
}

button.jp-Dialog-button:focus {
  outline: 1px solid var(--jp-brand-color1);
  outline-offset: 4px;
  -moz-outline-radius: 0;
}

button.jp-Dialog-button:focus::-moz-focus-inner {
  border: 0;
}

button.jp-Dialog-button.jp-mod-styled.jp-mod-accept:focus,
button.jp-Dialog-button.jp-mod-styled.jp-mod-warn:focus,
button.jp-Dialog-button.jp-mod-styled.jp-mod-reject:focus {
  outline-offset: 4px;
  -moz-outline-radius: 0;
}

button.jp-Dialog-button.jp-mod-styled.jp-mod-accept:focus {
  outline: 1px solid var(--jp-accept-color-normal, var(--jp-brand-color1));
}

button.jp-Dialog-button.jp-mod-styled.jp-mod-warn:focus {
  outline: 1px solid var(--jp-warn-color-normal, var(--jp-error-color1));
}

button.jp-Dialog-button.jp-mod-styled.jp-mod-reject:focus {
  outline: 1px solid var(--jp-reject-color-normal, var(--md-grey-600));
}

button.jp-Dialog-close-button {
  padding: 0;
  height: 100%;
  min-width: unset;
  min-height: unset;
}

.jp-Dialog-header {
  display: flex;
  justify-content: space-between;
  flex: 0 0 auto;
  padding-bottom: 12px;
  font-size: var(--jp-ui-font-size3);
  font-weight: 400;
  color: var(--jp-ui-font-color1);
}

.jp-Dialog-body {
  display: flex;
  flex-direction: column;
  flex: 1 1 auto;
  font-size: var(--jp-ui-font-size1);
  background: var(--jp-layout-color1);
  color: var(--jp-ui-font-color1);
  overflow: auto;
}

.jp-Dialog-footer {
  display: flex;
  flex-direction: row;
  justify-content: flex-end;
  align-items: center;
  flex: 0 0 auto;
  margin-left: -12px;
  margin-right: -12px;
  padding: 12px;
}

.jp-Dialog-checkbox {
  padding-right: 5px;
}

.jp-Dialog-checkbox > input:focus-visible {
  outline: 1px solid var(--jp-input-active-border-color);
  outline-offset: 1px;
}

.jp-Dialog-spacer {
  flex: 1 1 auto;
}

.jp-Dialog-title {
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}

.jp-Dialog-body > .jp-select-wrapper {
  width: 100%;
}

.jp-Dialog-body > button {
  padding: 0 16px;
}

.jp-Dialog-body > label {
  line-height: 1.4;
  color: var(--jp-ui-font-color0);
}

.jp-Dialog-button.jp-mod-styled:not(:last-child) {
  margin-right: 12px;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

.jp-Input-Boolean-Dialog {
  flex-direction: row-reverse;
  align-items: end;
  width: 100%;
}

.jp-Input-Boolean-Dialog > label {
  flex: 1 1 auto;
}

/*-----------------------------------------------------------------------------
| Copyright (c) 2014-2016, Jupyter Development Team.
|
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.jp-MainAreaWidget > :focus {
  outline: none;
}

.jp-MainAreaWidget .jp-MainAreaWidget-error {
  padding: 6px;
}

.jp-MainAreaWidget .jp-MainAreaWidget-error > pre {
  width: auto;
  padding: 10px;
  background: var(--jp-error-color3);
  border: var(--jp-border-width) solid var(--jp-error-color1);
  border-radius: var(--jp-border-radius);
  color: var(--jp-ui-font-color1);
  font-size: var(--jp-ui-font-size1);
  white-space: pre-wrap;
  word-wrap: break-word;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

/**
 * google-material-color v1.2.6
 * https://github.com/danlevan/google-material-color
 */
:root {
  --md-red-50: #ffebee;
  --md-red-100: #ffcdd2;
  --md-red-200: #ef9a9a;
  --md-red-300: #e57373;
  --md-red-400: #ef5350;
  --md-red-500: #f44336;
  --md-red-600: #e53935;
  --md-red-700: #d32f2f;
  --md-red-800: #c62828;
  --md-red-900: #b71c1c;
  --md-red-A100: #ff8a80;
  --md-red-A200: #ff5252;
  --md-red-A400: #ff1744;
  --md-red-A700: #d50000;
  --md-pink-50: #fce4ec;
  --md-pink-100: #f8bbd0;
  --md-pink-200: #f48fb1;
  --md-pink-300: #f06292;
  --md-pink-400: #ec407a;
  --md-pink-500: #e91e63;
  --md-pink-600: #d81b60;
  --md-pink-700: #c2185b;
  --md-pink-800: #ad1457;
  --md-pink-900: #880e4f;
  --md-pink-A100: #ff80ab;
  --md-pink-A200: #ff4081;
  --md-pink-A400: #f50057;
  --md-pink-A700: #c51162;
  --md-purple-50: #f3e5f5;
  --md-purple-100: #e1bee7;
  --md-purple-200: #ce93d8;
  --md-purple-300: #ba68c8;
  --md-purple-400: #ab47bc;
  --md-purple-500: #9c27b0;
  --md-purple-600: #8e24aa;
  --md-purple-700: #7b1fa2;
  --md-purple-800: #6a1b9a;
  --md-purple-900: #4a148c;
  --md-purple-A100: #ea80fc;
  --md-purple-A200: #e040fb;
  --md-purple-A400: #d500f9;
  --md-purple-A700: #a0f;
  --md-deep-purple-50: #ede7f6;
  --md-deep-purple-100: #d1c4e9;
  --md-deep-purple-200: #b39ddb;
  --md-deep-purple-300: #9575cd;
  --md-deep-purple-400: #7e57c2;
  --md-deep-purple-500: #673ab7;
  --md-deep-purple-600: #5e35b1;
  --md-deep-purple-700: #512da8;
  --md-deep-purple-800: #4527a0;
  --md-deep-purple-900: #311b92;
  --md-deep-purple-A100: #b388ff;
  --md-deep-purple-A200: #7c4dff;
  --md-deep-purple-A400: #651fff;
  --md-deep-purple-A700: #6200ea;
  --md-indigo-50: #e8eaf6;
  --md-indigo-100: #c5cae9;
  --md-indigo-200: #9fa8da;
  --md-indigo-300: #7986cb;
  --md-indigo-400: #5c6bc0;
  --md-indigo-500: #3f51b5;
  --md-indigo-600: #3949ab;
  --md-indigo-700: #303f9f;
  --md-indigo-800: #283593;
  --md-indigo-900: #1a237e;
  --md-indigo-A100: #8c9eff;
  --md-indigo-A200: #536dfe;
  --md-indigo-A400: #3d5afe;
  --md-indigo-A700: #304ffe;
  --md-blue-50: #e3f2fd;
  --md-blue-100: #bbdefb;
  --md-blue-200: #90caf9;
  --md-blue-300: #64b5f6;
  --md-blue-400: #42a5f5;
  --md-blue-500: #2196f3;
  --md-blue-600: #1e88e5;
  --md-blue-700: #1976d2;
  --md-blue-800: #1565c0;
  --md-blue-900: #0d47a1;
  --md-blue-A100: #82b1ff;
  --md-blue-A200: #448aff;
  --md-blue-A400: #2979ff;
  --md-blue-A700: #2962ff;
  --md-light-blue-50: #e1f5fe;
  --md-light-blue-100: #b3e5fc;
  --md-light-blue-200: #81d4fa;
  --md-light-blue-300: #4fc3f7;
  --md-light-blue-400: #29b6f6;
  --md-light-blue-500: #03a9f4;
  --md-light-blue-600: #039be5;
  --md-light-blue-700: #0288d1;
  --md-light-blue-800: #0277bd;
  --md-light-blue-900: #01579b;
  --md-light-blue-A100: #80d8ff;
  --md-light-blue-A200: #40c4ff;
  --md-light-blue-A400: #00b0ff;
  --md-light-blue-A700: #0091ea;
  --md-cyan-50: #e0f7fa;
  --md-cyan-100: #b2ebf2;
  --md-cyan-200: #80deea;
  --md-cyan-300: #4dd0e1;
  --md-cyan-400: #26c6da;
  --md-cyan-500: #00bcd4;
  --md-cyan-600: #00acc1;
  --md-cyan-700: #0097a7;
  --md-cyan-800: #00838f;
  --md-cyan-900: #006064;
  --md-cyan-A100: #84ffff;
  --md-cyan-A200: #18ffff;
  --md-cyan-A400: #00e5ff;
  --md-cyan-A700: #00b8d4;
  --md-teal-50: #e0f2f1;
  --md-teal-100: #b2dfdb;
  --md-teal-200: #80cbc4;
  --md-teal-300: #4db6ac;
  --md-teal-400: #26a69a;
  --md-teal-500: #009688;
  --md-teal-600: #00897b;
  --md-teal-700: #00796b;
  --md-teal-800: #00695c;
  --md-teal-900: #004d40;
  --md-teal-A100: #a7ffeb;
  --md-teal-A200: #64ffda;
  --md-teal-A400: #1de9b6;
  --md-teal-A700: #00bfa5;
  --md-green-50: #e8f5e9;
  --md-green-100: #c8e6c9;
  --md-green-200: #a5d6a7;
  --md-green-300: #81c784;
  --md-green-400: #66bb6a;
  --md-green-500: #4caf50;
  --md-green-600: #43a047;
  --md-green-700: #388e3c;
  --md-green-800: #2e7d32;
  --md-green-900: #1b5e20;
  --md-green-A100: #b9f6ca;
  --md-green-A200: #69f0ae;
  --md-green-A400: #00e676;
  --md-green-A700: #00c853;
  --md-light-green-50: #f1f8e9;
  --md-light-green-100: #dcedc8;
  --md-light-green-200: #c5e1a5;
  --md-light-green-300: #aed581;
  --md-light-green-400: #9ccc65;
  --md-light-green-500: #8bc34a;
  --md-light-green-600: #7cb342;
  --md-light-green-700: #689f38;
  --md-light-green-800: #558b2f;
  --md-light-green-900: #33691e;
  --md-light-green-A100: #ccff90;
  --md-light-green-A200: #b2ff59;
  --md-light-green-A400: #76ff03;
  --md-light-green-A700: #64dd17;
  --md-lime-50: #f9fbe7;
  --md-lime-100: #f0f4c3;
  --md-lime-200: #e6ee9c;
  --md-lime-300: #dce775;
  --md-lime-400: #d4e157;
  --md-lime-500: #cddc39;
  --md-lime-600: #c0ca33;
  --md-lime-700: #afb42b;
  --md-lime-800: #9e9d24;
  --md-lime-900: #827717;
  --md-lime-A100: #f4ff81;
  --md-lime-A200: #eeff41;
  --md-lime-A400: #c6ff00;
  --md-lime-A700: #aeea00;
  --md-yellow-50: #fffde7;
  --md-yellow-100: #fff9c4;
  --md-yellow-200: #fff59d;
  --md-yellow-300: #fff176;
  --md-yellow-400: #ffee58;
  --md-yellow-500: #ffeb3b;
  --md-yellow-600: #fdd835;
  --md-yellow-700: #fbc02d;
  --md-yellow-800: #f9a825;
  --md-yellow-900: #f57f17;
  --md-yellow-A100: #ffff8d;
  --md-yellow-A200: #ff0;
  --md-yellow-A400: #ffea00;
  --md-yellow-A700: #ffd600;
  --md-amber-50: #fff8e1;
  --md-amber-100: #ffecb3;
  --md-amber-200: #ffe082;
  --md-amber-300: #ffd54f;
  --md-amber-400: #ffca28;
  --md-amber-500: #ffc107;
  --md-amber-600: #ffb300;
  --md-amber-700: #ffa000;
  --md-amber-800: #ff8f00;
  --md-amber-900: #ff6f00;
  --md-amber-A100: #ffe57f;
  --md-amber-A200: #ffd740;
  --md-amber-A400: #ffc400;
  --md-amber-A700: #ffab00;
  --md-orange-50: #fff3e0;
  --md-orange-100: #ffe0b2;
  --md-orange-200: #ffcc80;
  --md-orange-300: #ffb74d;
  --md-orange-400: #ffa726;
  --md-orange-500: #ff9800;
  --md-orange-600: #fb8c00;
  --md-orange-700: #f57c00;
  --md-orange-800: #ef6c00;
  --md-orange-900: #e65100;
  --md-orange-A100: #ffd180;
  --md-orange-A200: #ffab40;
  --md-orange-A400: #ff9100;
  --md-orange-A700: #ff6d00;
  --md-deep-orange-50: #fbe9e7;
  --md-deep-orange-100: #ffccbc;
  --md-deep-orange-200: #ffab91;
  --md-deep-orange-300: #ff8a65;
  --md-deep-orange-400: #ff7043;
  --md-deep-orange-500: #ff5722;
  --md-deep-orange-600: #f4511e;
  --md-deep-orange-700: #e64a19;
  --md-deep-orange-800: #d84315;
  --md-deep-orange-900: #bf360c;
  --md-deep-orange-A100: #ff9e80;
  --md-deep-orange-A200: #ff6e40;
  --md-deep-orange-A400: #ff3d00;
  --md-deep-orange-A700: #dd2c00;
  --md-brown-50: #efebe9;
  --md-brown-100: #d7ccc8;
  --md-brown-200: #bcaaa4;
  --md-brown-300: #a1887f;
  --md-brown-400: #8d6e63;
  --md-brown-500: #795548;
  --md-brown-600: #6d4c41;
  --md-brown-700: #5d4037;
  --md-brown-800: #4e342e;
  --md-brown-900: #3e2723;
  --md-grey-50: #fafafa;
  --md-grey-100: #f5f5f5;
  --md-grey-200: #eee;
  --md-grey-300: #e0e0e0;
  --md-grey-400: #bdbdbd;
  --md-grey-500: #9e9e9e;
  --md-grey-600: #757575;
  --md-grey-700: #616161;
  --md-grey-800: #424242;
  --md-grey-900: #212121;
  --md-blue-grey-50: #eceff1;
  --md-blue-grey-100: #cfd8dc;
  --md-blue-grey-200: #b0bec5;
  --md-blue-grey-300: #90a4ae;
  --md-blue-grey-400: #78909c;
  --md-blue-grey-500: #607d8b;
  --md-blue-grey-600: #546e7a;
  --md-blue-grey-700: #455a64;
  --md-blue-grey-800: #37474f;
  --md-blue-grey-900: #263238;
}

/*-----------------------------------------------------------------------------
| Copyright (c) 2014-2017, Jupyter Development Team.
|
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| RenderedText
|----------------------------------------------------------------------------*/

:root {
  /* This is the padding value to fill the gaps between lines containing spans with background color. */
  --jp-private-code-span-padding: calc(
    (var(--jp-code-line-height) - 1) * var(--jp-code-font-size) / 2
  );
}

.jp-RenderedText {
  text-align: left;
  padding-left: var(--jp-code-padding);
  line-height: var(--jp-code-line-height);
  font-family: var(--jp-code-font-family);
}

.jp-RenderedText pre,
.jp-RenderedJavaScript pre,
.jp-RenderedHTMLCommon pre {
  color: var(--jp-content-font-color1);
  font-size: var(--jp-code-font-size);
  border: none;
  margin: 0;
  padding: 0;
}

.jp-RenderedText pre a:link {
  text-decoration: none;
  color: var(--jp-content-link-color);
}

.jp-RenderedText pre a:hover {
  text-decoration: underline;
  color: var(--jp-content-link-color);
}

.jp-RenderedText pre a:visited {
  text-decoration: none;
  color: var(--jp-content-link-color);
}

/* console foregrounds and backgrounds */
.jp-RenderedText pre .ansi-black-fg {
  color: #3e424d;
}

.jp-RenderedText pre .ansi-red-fg {
  color: #e75c58;
}

.jp-RenderedText pre .ansi-green-fg {
  color: #00a250;
}

.jp-RenderedText pre .ansi-yellow-fg {
  color: #ddb62b;
}

.jp-RenderedText pre .ansi-blue-fg {
  color: #208ffb;
}

.jp-RenderedText pre .ansi-magenta-fg {
  color: #d160c4;
}

.jp-RenderedText pre .ansi-cyan-fg {
  color: #60c6c8;
}

.jp-RenderedText pre .ansi-white-fg {
  color: #c5c1b4;
}

.jp-RenderedText pre .ansi-black-bg {
  background-color: #3e424d;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-red-bg {
  background-color: #e75c58;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-green-bg {
  background-color: #00a250;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-yellow-bg {
  background-color: #ddb62b;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-blue-bg {
  background-color: #208ffb;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-magenta-bg {
  background-color: #d160c4;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-cyan-bg {
  background-color: #60c6c8;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-white-bg {
  background-color: #c5c1b4;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-black-intense-fg {
  color: #282c36;
}

.jp-RenderedText pre .ansi-red-intense-fg {
  color: #b22b31;
}

.jp-RenderedText pre .ansi-green-intense-fg {
  color: #007427;
}

.jp-RenderedText pre .ansi-yellow-intense-fg {
  color: #b27d12;
}

.jp-RenderedText pre .ansi-blue-intense-fg {
  color: #0065ca;
}

.jp-RenderedText pre .ansi-magenta-intense-fg {
  color: #a03196;
}

.jp-RenderedText pre .ansi-cyan-intense-fg {
  color: #258f8f;
}

.jp-RenderedText pre .ansi-white-intense-fg {
  color: #a1a6b2;
}

.jp-RenderedText pre .ansi-black-intense-bg {
  background-color: #282c36;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-red-intense-bg {
  background-color: #b22b31;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-green-intense-bg {
  background-color: #007427;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-yellow-intense-bg {
  background-color: #b27d12;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-blue-intense-bg {
  background-color: #0065ca;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-magenta-intense-bg {
  background-color: #a03196;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-cyan-intense-bg {
  background-color: #258f8f;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-white-intense-bg {
  background-color: #a1a6b2;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-default-inverse-fg {
  color: var(--jp-ui-inverse-font-color0);
}

.jp-RenderedText pre .ansi-default-inverse-bg {
  background-color: var(--jp-inverse-layout-color0);
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-bold {
  font-weight: bold;
}

.jp-RenderedText pre .ansi-underline {
  text-decoration: underline;
}

.jp-RenderedText[data-mime-type='application/vnd.jupyter.stderr'] {
  background: var(--jp-rendermime-error-background);
  padding-top: var(--jp-code-padding);
}

/*-----------------------------------------------------------------------------
| RenderedLatex
|----------------------------------------------------------------------------*/

.jp-RenderedLatex {
  color: var(--jp-content-font-color1);
  font-size: var(--jp-content-font-size1);
  line-height: var(--jp-content-line-height);
}

/* Left-justify outputs.*/
.jp-OutputArea-output.jp-RenderedLatex {
  padding: var(--jp-code-padding);
  text-align: left;
}

/*-----------------------------------------------------------------------------
| RenderedHTML
|----------------------------------------------------------------------------*/

.jp-RenderedHTMLCommon {
  color: var(--jp-content-font-color1);
  font-family: var(--jp-content-font-family);
  font-size: var(--jp-content-font-size1);
  line-height: var(--jp-content-line-height);

  /* Give a bit more R padding on Markdown text to keep line lengths reasonable */
  padding-right: 20px;
}

.jp-RenderedHTMLCommon em {
  font-style: italic;
}

.jp-RenderedHTMLCommon strong {
  font-weight: bold;
}

.jp-RenderedHTMLCommon u {
  text-decoration: underline;
}

.jp-RenderedHTMLCommon a:link {
  text-decoration: none;
  color: var(--jp-content-link-color);
}

.jp-RenderedHTMLCommon a:hover {
  text-decoration: underline;
  color: var(--jp-content-link-color);
}

.jp-RenderedHTMLCommon a:visited {
  text-decoration: none;
  color: var(--jp-content-link-color);
}

/* Headings */

.jp-RenderedHTMLCommon h1,
.jp-RenderedHTMLCommon h2,
.jp-RenderedHTMLCommon h3,
.jp-RenderedHTMLCommon h4,
.jp-RenderedHTMLCommon h5,
.jp-RenderedHTMLCommon h6 {
  line-height: var(--jp-content-heading-line-height);
  font-weight: var(--jp-content-heading-font-weight);
  font-style: normal;
  margin: var(--jp-content-heading-margin-top) 0
    var(--jp-content-heading-margin-bottom) 0;
}

.jp-RenderedHTMLCommon h1:first-child,
.jp-RenderedHTMLCommon h2:first-child,
.jp-RenderedHTMLCommon h3:first-child,
.jp-RenderedHTMLCommon h4:first-child,
.jp-RenderedHTMLCommon h5:first-child,
.jp-RenderedHTMLCommon h6:first-child {
  margin-top: calc(0.5 * var(--jp-content-heading-margin-top));
}

.jp-RenderedHTMLCommon h1:last-child,
.jp-RenderedHTMLCommon h2:last-child,
.jp-RenderedHTMLCommon h3:last-child,
.jp-RenderedHTMLCommon h4:last-child,
.jp-RenderedHTMLCommon h5:last-child,
.jp-RenderedHTMLCommon h6:last-child {
  margin-bottom: calc(0.5 * var(--jp-content-heading-margin-bottom));
}

.jp-RenderedHTMLCommon h1 {
  font-size: var(--jp-content-font-size5);
}

.jp-RenderedHTMLCommon h2 {
  font-size: var(--jp-content-font-size4);
}

.jp-RenderedHTMLCommon h3 {
  font-size: var(--jp-content-font-size3);
}

.jp-RenderedHTMLCommon h4 {
  font-size: var(--jp-content-font-size2);
}

.jp-RenderedHTMLCommon h5 {
  font-size: var(--jp-content-font-size1);
}

.jp-RenderedHTMLCommon h6 {
  font-size: var(--jp-content-font-size0);
}

/* Lists */

/* stylelint-disable selector-max-type, selector-max-compound-selectors */

.jp-RenderedHTMLCommon ul:not(.list-inline),
.jp-RenderedHTMLCommon ol:not(.list-inline) {
  padding-left: 2em;
}

.jp-RenderedHTMLCommon ul {
  list-style: disc;
}

.jp-RenderedHTMLCommon ul ul {
  list-style: square;
}

.jp-RenderedHTMLCommon ul ul ul {
  list-style: circle;
}

.jp-RenderedHTMLCommon ol {
  list-style: decimal;
}

.jp-RenderedHTMLCommon ol ol {
  list-style: upper-alpha;
}

.jp-RenderedHTMLCommon ol ol ol {
  list-style: lower-alpha;
}

.jp-RenderedHTMLCommon ol ol ol ol {
  list-style: lower-roman;
}

.jp-RenderedHTMLCommon ol ol ol ol ol {
  list-style: decimal;
}

.jp-RenderedHTMLCommon ol,
.jp-RenderedHTMLCommon ul {
  margin-bottom: 1em;
}

.jp-RenderedHTMLCommon ul ul,
.jp-RenderedHTMLCommon ul ol,
.jp-RenderedHTMLCommon ol ul,
.jp-RenderedHTMLCommon ol ol {
  margin-bottom: 0;
}

/* stylelint-enable selector-max-type, selector-max-compound-selectors */

.jp-RenderedHTMLCommon hr {
  color: var(--jp-border-color2);
  background-color: var(--jp-border-color1);
  margin-top: 1em;
  margin-bottom: 1em;
}

.jp-RenderedHTMLCommon > pre {
  margin: 1.5em 2em;
}

.jp-RenderedHTMLCommon pre,
.jp-RenderedHTMLCommon code {
  border: 0;
  background-color: var(--jp-layout-color0);
  color: var(--jp-content-font-color1);
  font-family: var(--jp-code-font-family);
  font-size: inherit;
  line-height: var(--jp-code-line-height);
  padding: 0;
  white-space: pre-wrap;
}

.jp-RenderedHTMLCommon :not(pre) > code {
  background-color: var(--jp-layout-color2);
  padding: 1px 5px;
}

/* Tables */

.jp-RenderedHTMLCommon table {
  border-collapse: collapse;
  border-spacing: 0;
  border: none;
  color: var(--jp-ui-font-color1);
  font-size: var(--jp-ui-font-size1);
  table-layout: fixed;
  margin-left: auto;
  margin-bottom: 1em;
  margin-right: auto;
}

.jp-RenderedHTMLCommon thead {
  border-bottom: var(--jp-border-width) solid var(--jp-border-color1);
  vertical-align: bottom;
}

.jp-RenderedHTMLCommon td,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon tr {
  vertical-align: middle;
  padding: 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}

.jp-RenderedMarkdown.jp-RenderedHTMLCommon td,
.jp-RenderedMarkdown.jp-RenderedHTMLCommon th {
  max-width: none;
}

:not(.jp-RenderedMarkdown).jp-RenderedHTMLCommon td,
:not(.jp-RenderedMarkdown).jp-RenderedHTMLCommon th,
:not(.jp-RenderedMarkdown).jp-RenderedHTMLCommon tr {
  text-align: right;
}

.jp-RenderedHTMLCommon th {
  font-weight: bold;
}

.jp-RenderedHTMLCommon tbody tr:nth-child(odd) {
  background: var(--jp-layout-color0);
}

.jp-RenderedHTMLCommon tbody tr:nth-child(even) {
  background: var(--jp-rendermime-table-row-background);
}

.jp-RenderedHTMLCommon tbody tr:hover {
  background: var(--jp-rendermime-table-row-hover-background);
}

.jp-RenderedHTMLCommon p {
  text-align: left;
  margin: 0;
  margin-bottom: 1em;
}

.jp-RenderedHTMLCommon img {
  -moz-force-broken-image-icon: 1;
}

/* Restrict to direct children as other images could be nested in other content. */
.jp-RenderedHTMLCommon > img {
  display: block;
  margin-left: 0;
  margin-right: 0;
  margin-bottom: 1em;
}

/* Change color behind transparent images if they need it... */
[data-jp-theme-light='false'] .jp-RenderedImage img.jp-needs-light-background {
  background-color: var(--jp-inverse-layout-color1);
}

[data-jp-theme-light='true'] .jp-RenderedImage img.jp-needs-dark-background {
  background-color: var(--jp-inverse-layout-color1);
}

.jp-RenderedHTMLCommon img,
.jp-RenderedImage img,
.jp-RenderedHTMLCommon svg,
.jp-RenderedSVG svg {
  max-width: 100%;
  height: auto;
}

.jp-RenderedHTMLCommon img.jp-mod-unconfined,
.jp-RenderedImage img.jp-mod-unconfined,
.jp-RenderedHTMLCommon svg.jp-mod-unconfined,
.jp-RenderedSVG svg.jp-mod-unconfined {
  max-width: none;
}

.jp-RenderedHTMLCommon .alert {
  padding: var(--jp-notebook-padding);
  border: var(--jp-border-width) solid transparent;
  border-radius: var(--jp-border-radius);
  margin-bottom: 1em;
}

.jp-RenderedHTMLCommon .alert-info {
  color: var(--jp-info-color0);
  background-color: var(--jp-info-color3);
  border-color: var(--jp-info-color2);
}

.jp-RenderedHTMLCommon .alert-info hr {
  border-color: var(--jp-info-color3);
}

.jp-RenderedHTMLCommon .alert-info > p:last-child,
.jp-RenderedHTMLCommon .alert-info > ul:last-child {
  margin-bottom: 0;
}

.jp-RenderedHTMLCommon .alert-warning {
  color: var(--jp-warn-color0);
  background-color: var(--jp-warn-color3);
  border-color: var(--jp-warn-color2);
}

.jp-RenderedHTMLCommon .alert-warning hr {
  border-color: var(--jp-warn-color3);
}

.jp-RenderedHTMLCommon .alert-warning > p:last-child,
.jp-RenderedHTMLCommon .alert-warning > ul:last-child {
  margin-bottom: 0;
}

.jp-RenderedHTMLCommon .alert-success {
  color: var(--jp-success-color0);
  background-color: var(--jp-success-color3);
  border-color: var(--jp-success-color2);
}

.jp-RenderedHTMLCommon .alert-success hr {
  border-color: var(--jp-success-color3);
}

.jp-RenderedHTMLCommon .alert-success > p:last-child,
.jp-RenderedHTMLCommon .alert-success > ul:last-child {
  margin-bottom: 0;
}

.jp-RenderedHTMLCommon .alert-danger {
  color: var(--jp-error-color0);
  background-color: var(--jp-error-color3);
  border-color: var(--jp-error-color2);
}

.jp-RenderedHTMLCommon .alert-danger hr {
  border-color: var(--jp-error-color3);
}

.jp-RenderedHTMLCommon .alert-danger > p:last-child,
.jp-RenderedHTMLCommon .alert-danger > ul:last-child {
  margin-bottom: 0;
}

.jp-RenderedHTMLCommon blockquote {
  margin: 1em 2em;
  padding: 0 1em;
  border-left: 5px solid var(--jp-border-color2);
}

a.jp-InternalAnchorLink {
  visibility: hidden;
  margin-left: 8px;
  color: var(--md-blue-800);
}

h1:hover .jp-InternalAnchorLink,
h2:hover .jp-InternalAnchorLink,
h3:hover .jp-InternalAnchorLink,
h4:hover .jp-InternalAnchorLink,
h5:hover .jp-InternalAnchorLink,
h6:hover .jp-InternalAnchorLink {
  visibility: visible;
}

.jp-RenderedHTMLCommon kbd {
  background-color: var(--jp-rendermime-table-row-background);
  border: 1px solid var(--jp-border-color0);
  border-bottom-color: var(--jp-border-color2);
  border-radius: 3px;
  box-shadow: inset 0 -1px 0 rgba(0, 0, 0, 0.25);
  display: inline-block;
  font-size: var(--jp-ui-font-size0);
  line-height: 1em;
  padding: 0.2em 0.5em;
}

/* Most direct children of .jp-RenderedHTMLCommon have a margin-bottom of 1.0.
 * At the bottom of cells this is a bit too much as there is also spacing
 * between cells. Going all the way to 0 gets too tight between markdown and
 * code cells.
 */
.jp-RenderedHTMLCommon > *:last-child {
  margin-bottom: 0.5em;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Copyright (c) 2014-2017, PhosphorJS Contributors
|
| Distributed under the terms of the BSD 3-Clause License.
|
| The full license is in the file LICENSE, distributed with this software.
|----------------------------------------------------------------------------*/

.lm-cursor-backdrop {
  position: fixed;
  width: 200px;
  height: 200px;
  margin-top: -100px;
  margin-left: -100px;
  will-change: transform;
  z-index: 100;
}

.lm-mod-drag-image {
  will-change: transform;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

.jp-lineFormSearch {
  padding: 4px 12px;
  background-color: var(--jp-layout-color2);
  box-shadow: var(--jp-toolbar-box-shadow);
  z-index: 2;
  font-size: var(--jp-ui-font-size1);
}

.jp-lineFormCaption {
  font-size: var(--jp-ui-font-size0);
  line-height: var(--jp-ui-font-size1);
  margin-top: 4px;
  color: var(--jp-ui-font-color0);
}

.jp-baseLineForm {
  border: none;
  border-radius: 0;
  position: absolute;
  background-size: 16px;
  background-repeat: no-repeat;
  background-position: center;
  outline: none;
}

.jp-lineFormButtonContainer {
  top: 4px;
  right: 8px;
  height: 24px;
  padding: 0 12px;
  width: 12px;
}

.jp-lineFormButtonIcon {
  top: 0;
  right: 0;
  background-color: var(--jp-brand-color1);
  height: 100%;
  width: 100%;
  box-sizing: border-box;
  padding: 4px 6px;
}

.jp-lineFormButton {
  top: 0;
  right: 0;
  background-color: transparent;
  height: 100%;
  width: 100%;
  box-sizing: border-box;
}

.jp-lineFormWrapper {
  overflow: hidden;
  padding: 0 8px;
  border: 1px solid var(--jp-border-color0);
  background-color: var(--jp-input-active-background);
  height: 22px;
}

.jp-lineFormWrapperFocusWithin {
  border: var(--jp-border-width) solid var(--md-blue-500);
  box-shadow: inset 0 0 4px var(--md-blue-300);
}

.jp-lineFormInput {
  background: transparent;
  width: 200px;
  height: 100%;
  border: none;
  outline: none;
  color: var(--jp-ui-font-color0);
  line-height: 28px;
}

/*-----------------------------------------------------------------------------
| Copyright (c) 2014-2016, Jupyter Development Team.
|
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.jp-JSONEditor {
  display: flex;
  flex-direction: column;
  width: 100%;
}

.jp-JSONEditor-host {
  flex: 1 1 auto;
  border: var(--jp-border-width) solid var(--jp-input-border-color);
  border-radius: 0;
  background: var(--jp-layout-color0);
  min-height: 50px;
  padding: 1px;
}

.jp-JSONEditor.jp-mod-error .jp-JSONEditor-host {
  border-color: red;
  outline-color: red;
}

.jp-JSONEditor-header {
  display: flex;
  flex: 1 0 auto;
  padding: 0 0 0 12px;
}

.jp-JSONEditor-header label {
  flex: 0 0 auto;
}

.jp-JSONEditor-commitButton {
  height: 16px;
  width: 16px;
  background-size: 18px;
  background-repeat: no-repeat;
  background-position: center;
}

.jp-JSONEditor-host.jp-mod-focused {
  background-color: var(--jp-input-active-background);
  border: 1px solid var(--jp-input-active-border-color);
  box-shadow: var(--jp-input-box-shadow);
}

.jp-Editor.jp-mod-dropTarget {
  border: var(--jp-border-width) solid var(--jp-input-active-border-color);
  box-shadow: var(--jp-input-box-shadow);
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/
.jp-DocumentSearch-input {
  border: none;
  outline: none;
  color: var(--jp-ui-font-color0);
  font-size: var(--jp-ui-font-size1);
  background-color: var(--jp-layout-color0);
  font-family: var(--jp-ui-font-family);
  padding: 2px 1px;
  resize: none;
}

.jp-DocumentSearch-overlay {
  position: absolute;
  background-color: var(--jp-toolbar-background);
  border-bottom: var(--jp-border-width) solid var(--jp-toolbar-border-color);
  border-left: var(--jp-border-width) solid var(--jp-toolbar-border-color);
  top: 0;
  right: 0;
  z-index: 7;
  min-width: 405px;
  padding: 2px;
  font-size: var(--jp-ui-font-size1);

  --jp-private-document-search-button-height: 20px;
}

.jp-DocumentSearch-overlay button {
  background-color: var(--jp-toolbar-background);
  outline: 0;
}

.jp-DocumentSearch-overlay button:hover {
  background-color: var(--jp-layout-color2);
}

.jp-DocumentSearch-overlay button:active {
  background-color: var(--jp-layout-color3);
}

.jp-DocumentSearch-overlay-row {
  display: flex;
  align-items: center;
  margin-bottom: 2px;
}

.jp-DocumentSearch-button-content {
  display: inline-block;
  cursor: pointer;
  box-sizing: border-box;
  width: 100%;
  height: 100%;
}

.jp-DocumentSearch-button-content svg {
  width: 100%;
  height: 100%;
}

.jp-DocumentSearch-input-wrapper {
  border: var(--jp-border-width) solid var(--jp-border-color0);
  display: flex;
  background-color: var(--jp-layout-color0);
  margin: 2px;
}

.jp-DocumentSearch-input-wrapper:focus-within {
  border-color: var(--jp-cell-editor-active-border-color);
}

.jp-DocumentSearch-toggle-wrapper,
.jp-DocumentSearch-button-wrapper {
  all: initial;
  overflow: hidden;
  display: inline-block;
  border: none;
  box-sizing: border-box;
}

.jp-DocumentSearch-toggle-wrapper {
  width: 14px;
  height: 14px;
}

.jp-DocumentSearch-button-wrapper {
  width: var(--jp-private-document-search-button-height);
  height: var(--jp-private-document-search-button-height);
}

.jp-DocumentSearch-toggle-wrapper:focus,
.jp-DocumentSearch-button-wrapper:focus {
  outline: var(--jp-border-width) solid
    var(--jp-cell-editor-active-border-color);
  outline-offset: -1px;
}

.jp-DocumentSearch-toggle-wrapper,
.jp-DocumentSearch-button-wrapper,
.jp-DocumentSearch-button-content:focus {
  outline: none;
}

.jp-DocumentSearch-toggle-placeholder {
  width: 5px;
}

.jp-DocumentSearch-input-button::before {
  display: block;
  padding-top: 100%;
}

.jp-DocumentSearch-input-button-off {
  opacity: var(--jp-search-toggle-off-opacity);
}

.jp-DocumentSearch-input-button-off:hover {
  opacity: var(--jp-search-toggle-hover-opacity);
}

.jp-DocumentSearch-input-button-on {
  opacity: var(--jp-search-toggle-on-opacity);
}

.jp-DocumentSearch-index-counter {
  padding-left: 10px;
  padding-right: 10px;
  user-select: none;
  min-width: 35px;
  display: inline-block;
}

.jp-DocumentSearch-up-down-wrapper {
  display: inline-block;
  padding-right: 2px;
  margin-left: auto;
  white-space: nowrap;
}

.jp-DocumentSearch-spacer {
  margin-left: auto;
}

.jp-DocumentSearch-up-down-wrapper button {
  outline: 0;
  border: none;
  width: var(--jp-private-document-search-button-height);
  height: var(--jp-private-document-search-button-height);
  vertical-align: middle;
  margin: 1px 5px 2px;
}

.jp-DocumentSearch-up-down-button:hover {
  background-color: var(--jp-layout-color2);
}

.jp-DocumentSearch-up-down-button:active {
  background-color: var(--jp-layout-color3);
}

.jp-DocumentSearch-filter-button {
  border-radius: var(--jp-border-radius);
}

.jp-DocumentSearch-filter-button:hover {
  background-color: var(--jp-layout-color2);
}

.jp-DocumentSearch-filter-button-enabled {
  background-color: var(--jp-layout-color2);
}

.jp-DocumentSearch-filter-button-enabled:hover {
  background-color: var(--jp-layout-color3);
}

.jp-DocumentSearch-search-options {
  padding: 0 8px;
  margin-left: 3px;
  width: 100%;
  display: grid;
  justify-content: start;
  grid-template-columns: 1fr 1fr;
  align-items: center;
  justify-items: stretch;
}

.jp-DocumentSearch-search-filter-disabled {
  color: var(--jp-ui-font-color2);
}

.jp-DocumentSearch-search-filter {
  display: flex;
  align-items: center;
  user-select: none;
}

.jp-DocumentSearch-regex-error {
  color: var(--jp-error-color0);
}

.jp-DocumentSearch-replace-button-wrapper {
  overflow: hidden;
  display: inline-block;
  box-sizing: border-box;
  border: var(--jp-border-width) solid var(--jp-border-color0);
  margin: auto 2px;
  padding: 1px 4px;
  height: calc(var(--jp-private-document-search-button-height) + 2px);
}

.jp-DocumentSearch-replace-button-wrapper:focus {
  border: var(--jp-border-width) solid var(--jp-cell-editor-active-border-color);
}

.jp-DocumentSearch-replace-button {
  display: inline-block;
  text-align: center;
  cursor: pointer;
  box-sizing: border-box;
  color: var(--jp-ui-font-color1);

  /* height - 2 * (padding of wrapper) */
  line-height: calc(var(--jp-private-document-search-button-height) - 2px);
  width: 100%;
  height: 100%;
}

.jp-DocumentSearch-replace-button:focus {
  outline: none;
}

.jp-DocumentSearch-replace-wrapper-class {
  margin-left: 14px;
  display: flex;
}

.jp-DocumentSearch-replace-toggle {
  border: none;
  background-color: var(--jp-toolbar-background);
  border-radius: var(--jp-border-radius);
}

.jp-DocumentSearch-replace-toggle:hover {
  background-color: var(--jp-layout-color2);
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.cm-editor {
  line-height: var(--jp-code-line-height);
  font-size: var(--jp-code-font-size);
  font-family: var(--jp-code-font-family);
  border: 0;
  border-radius: 0;
  height: auto;

  /* Changed to auto to autogrow */
}

.cm-editor pre {
  padding: 0 var(--jp-code-padding);
}

.jp-CodeMirrorEditor[data-type='inline'] .cm-dialog {
  background-color: var(--jp-layout-color0);
  color: var(--jp-content-font-color1);
}

.jp-CodeMirrorEditor {
  cursor: text;
}

/* When zoomed out 67% and 33% on a screen of 1440 width x 900 height */
@media screen and (min-width: 2138px) and (max-width: 4319px) {
  .jp-CodeMirrorEditor[data-type='inline'] .cm-cursor {
    border-left: var(--jp-code-cursor-width1) solid
      var(--jp-editor-cursor-color);
  }
}

/* When zoomed out less than 33% */
@media screen and (min-width: 4320px) {
  .jp-CodeMirrorEditor[data-type='inline'] .cm-cursor {
    border-left: var(--jp-code-cursor-width2) solid
      var(--jp-editor-cursor-color);
  }
}

.cm-editor.jp-mod-readOnly .cm-cursor {
  display: none;
}

.jp-CollaboratorCursor {
  border-left: 5px solid transparent;
  border-right: 5px solid transparent;
  border-top: none;
  border-bottom: 3px solid;
  background-clip: content-box;
  margin-left: -5px;
  margin-right: -5px;
}

.cm-searching,
.cm-searching span {
  /* `.cm-searching span`: we need to override syntax highlighting */
  background-color: var(--jp-search-unselected-match-background-color);
  color: var(--jp-search-unselected-match-color);
}

.cm-searching::selection,
.cm-searching span::selection {
  background-color: var(--jp-search-unselected-match-background-color);
  color: var(--jp-search-unselected-match-color);
}

.jp-current-match > .cm-searching,
.jp-current-match > .cm-searching span,
.cm-searching > .jp-current-match,
.cm-searching > .jp-current-match span {
  background-color: var(--jp-search-selected-match-background-color);
  color: var(--jp-search-selected-match-color);
}

.jp-current-match > .cm-searching::selection,
.cm-searching > .jp-current-match::selection,
.jp-current-match > .cm-searching span::selection {
  background-color: var(--jp-search-selected-match-background-color);
  color: var(--jp-search-selected-match-color);
}

.cm-trailingspace {
  background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAFCAYAAAB4ka1VAAAAsElEQVQIHQGlAFr/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA7+r3zKmT0/+pk9P/7+r3zAAAAAAAAAAABAAAAAAAAAAA6OPzM+/q9wAAAAAA6OPzMwAAAAAAAAAAAgAAAAAAAAAAGR8NiRQaCgAZIA0AGR8NiQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQyoYJ/SY80UAAAAASUVORK5CYII=);
  background-position: center left;
  background-repeat: repeat-x;
}

.jp-CollaboratorCursor-hover {
  position: absolute;
  z-index: 1;
  transform: translateX(-50%);
  color: white;
  border-radius: 3px;
  padding-left: 4px;
  padding-right: 4px;
  padding-top: 1px;
  padding-bottom: 1px;
  text-align: center;
  font-size: var(--jp-ui-font-size1);
  white-space: nowrap;
}

.jp-CodeMirror-ruler {
  border-left: 1px dashed var(--jp-border-color2);
}

/* Styles for shared cursors (remote cursor locations and selected ranges) */
.jp-CodeMirrorEditor .cm-ySelectionCaret {
  position: relative;
  border-left: 1px solid black;
  margin-left: -1px;
  margin-right: -1px;
  box-sizing: border-box;
}

.jp-CodeMirrorEditor .cm-ySelectionCaret > .cm-ySelectionInfo {
  white-space: nowrap;
  position: absolute;
  top: -1.15em;
  padding-bottom: 0.05em;
  left: -1px;
  font-size: 0.95em;
  font-family: var(--jp-ui-font-family);
  font-weight: bold;
  line-height: normal;
  user-select: none;
  color: white;
  padding-left: 2px;
  padding-right: 2px;
  z-index: 101;
  transition: opacity 0.3s ease-in-out;
}

.jp-CodeMirrorEditor .cm-ySelectionInfo {
  transition-delay: 0.7s;
  opacity: 0;
}

.jp-CodeMirrorEditor .cm-ySelectionCaret:hover > .cm-ySelectionInfo {
  opacity: 1;
  transition-delay: 0s;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.jp-MimeDocument {
  outline: none;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Variables
|----------------------------------------------------------------------------*/

:root {
  --jp-private-filebrowser-button-height: 28px;
  --jp-private-filebrowser-button-width: 48px;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.jp-FileBrowser .jp-SidePanel-content {
  display: flex;
  flex-direction: column;
}

.jp-FileBrowser-toolbar.jp-Toolbar {
  flex-wrap: wrap;
  row-gap: 12px;
  border-bottom: none;
  height: auto;
  margin: 8px 12px 0;
  box-shadow: none;
  padding: 0;
  justify-content: flex-start;
}

.jp-FileBrowser-Panel {
  flex: 1 1 auto;
  display: flex;
  flex-direction: column;
}

.jp-BreadCrumbs {
  flex: 0 0 auto;
  margin: 8px 12px;
}

.jp-BreadCrumbs-item {
  margin: 0 2px;
  padding: 0 2px;
  border-radius: var(--jp-border-radius);
  cursor: pointer;
}

.jp-BreadCrumbs-item:hover {
  background-color: var(--jp-layout-color2);
}

.jp-BreadCrumbs-item:first-child {
  margin-left: 0;
}

.jp-BreadCrumbs-item.jp-mod-dropTarget {
  background-color: var(--jp-brand-color2);
  opacity: 0.7;
}

/*-----------------------------------------------------------------------------
| Buttons
|----------------------------------------------------------------------------*/

.jp-FileBrowser-toolbar > .jp-Toolbar-item {
  flex: 0 0 auto;
  padding-left: 0;
  padding-right: 2px;
  align-items: center;
  height: unset;
}

.jp-FileBrowser-toolbar > .jp-Toolbar-item .jp-ToolbarButtonComponent {
  width: 40px;
}

/*-----------------------------------------------------------------------------
| Other styles
|----------------------------------------------------------------------------*/

.jp-FileDialog.jp-mod-conflict input {
  color: var(--jp-error-color1);
}

.jp-FileDialog .jp-new-name-title {
  margin-top: 12px;
}

.jp-LastModified-hidden {
  display: none;
}

.jp-FileSize-hidden {
  display: none;
}

.jp-FileBrowser .lm-AccordionPanel > h3:first-child {
  display: none;
}

/*-----------------------------------------------------------------------------
| DirListing
|----------------------------------------------------------------------------*/

.jp-DirListing {
  flex: 1 1 auto;
  display: flex;
  flex-direction: column;
  outline: 0;
}

.jp-DirListing-header {
  flex: 0 0 auto;
  display: flex;
  flex-direction: row;
  align-items: center;
  overflow: hidden;
  border-top: var(--jp-border-width) solid var(--jp-border-color2);
  border-bottom: var(--jp-border-width) solid var(--jp-border-color1);
  box-shadow: var(--jp-toolbar-box-shadow);
  z-index: 2;
}

.jp-DirListing-headerItem {
  padding: 4px 12px 2px;
  font-weight: 500;
}

.jp-DirListing-headerItem:hover {
  background: var(--jp-layout-color2);
}

.jp-DirListing-headerItem.jp-id-name {
  flex: 1 0 84px;
}

.jp-DirListing-headerItem.jp-id-modified {
  flex: 0 0 112px;
  border-left: var(--jp-border-width) solid var(--jp-border-color2);
  text-align: right;
}

.jp-DirListing-headerItem.jp-id-filesize {
  flex: 0 0 75px;
  border-left: var(--jp-border-width) solid var(--jp-border-color2);
  text-align: right;
}

.jp-id-narrow {
  display: none;
  flex: 0 0 5px;
  padding: 4px;
  border-left: var(--jp-border-width) solid var(--jp-border-color2);
  text-align: right;
  color: var(--jp-border-color2);
}

.jp-DirListing-narrow .jp-id-narrow {
  display: block;
}

.jp-DirListing-narrow .jp-id-modified,
.jp-DirListing-narrow .jp-DirListing-itemModified {
  display: none;
}

.jp-DirListing-headerItem.jp-mod-selected {
  font-weight: 600;
}

/* increase specificity to override bundled default */
.jp-DirListing-content {
  flex: 1 1 auto;
  margin: 0;
  padding: 0;
  list-style-type: none;
  overflow: auto;
  background-color: var(--jp-layout-color1);
}

.jp-DirListing-content mark {
  color: var(--jp-ui-font-color0);
  background-color: transparent;
  font-weight: bold;
}

.jp-DirListing-content .jp-DirListing-item.jp-mod-selected mark {
  color: var(--jp-ui-inverse-font-color0);
}

/* Style the directory listing content when a user drops a file to upload */
.jp-DirListing.jp-mod-native-drop .jp-DirListing-content {
  outline: 5px dashed rgba(128, 128, 128, 0.5);
  outline-offset: -10px;
  cursor: copy;
}

.jp-DirListing-item {
  display: flex;
  flex-direction: row;
  align-items: center;
  padding: 4px 12px;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.jp-DirListing-checkboxWrapper {
  /* Increases hit area of checkbox. */
  padding: 4px;
}

.jp-DirListing-header
  .jp-DirListing-checkboxWrapper
  + .jp-DirListing-headerItem {
  padding-left: 4px;
}

.jp-DirListing-content .jp-DirListing-checkboxWrapper {
  position: relative;
  left: -4px;
  margin: -4px 0 -4px -8px;
}

.jp-DirListing-checkboxWrapper.jp-mod-visible {
  visibility: visible;
}

/* For devices that support hovering, hide checkboxes until hovered, selected...
*/
@media (hover: hover) {
  .jp-DirListing-checkboxWrapper {
    visibility: hidden;
  }

  .jp-DirListing-item:hover .jp-DirListing-checkboxWrapper,
  .jp-DirListing-item.jp-mod-selected .jp-DirListing-checkboxWrapper {
    visibility: visible;
  }
}

.jp-DirListing-item[data-is-dot] {
  opacity: 75%;
}

.jp-DirListing-item.jp-mod-selected {
  color: var(--jp-ui-inverse-font-color1);
  background: var(--jp-brand-color1);
}

.jp-DirListing-item.jp-mod-dropTarget {
  background: var(--jp-brand-color3);
}

.jp-DirListing-item:hover:not(.jp-mod-selected) {
  background: var(--jp-layout-color2);
}

.jp-DirListing-itemIcon {
  flex: 0 0 20px;
  margin-right: 4px;
}

.jp-DirListing-itemText {
  flex: 1 0 64px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  user-select: none;
}

.jp-DirListing-itemText:focus {
  outline-width: 2px;
  outline-color: var(--jp-inverse-layout-color1);
  outline-style: solid;
  outline-offset: 1px;
}

.jp-DirListing-item.jp-mod-selected .jp-DirListing-itemText:focus {
  outline-color: var(--jp-layout-color1);
}

.jp-DirListing-itemModified {
  flex: 0 0 125px;
  text-align: right;
}

.jp-DirListing-itemFileSize {
  flex: 0 0 90px;
  text-align: right;
}

.jp-DirListing-editor {
  flex: 1 0 64px;
  outline: none;
  border: none;
  color: var(--jp-ui-font-color1);
  background-color: var(--jp-layout-color1);
}

.jp-DirListing-item.jp-mod-running .jp-DirListing-itemIcon::before {
  color: var(--jp-success-color1);
  content: '\25CF';
  font-size: 8px;
  position: absolute;
  left: -8px;
}

.jp-DirListing-item.jp-mod-running.jp-mod-selected
  .jp-DirListing-itemIcon::before {
  color: var(--jp-ui-inverse-font-color1);
}

.jp-DirListing-item.lm-mod-drag-image,
.jp-DirListing-item.jp-mod-selected.lm-mod-drag-image {
  font-size: var(--jp-ui-font-size1);
  padding-left: 4px;
  margin-left: 4px;
  width: 160px;
  background-color: var(--jp-ui-inverse-font-color2);
  box-shadow: var(--jp-elevation-z2);
  border-radius: 0;
  color: var(--jp-ui-font-color1);
  transform: translateX(-40%) translateY(-58%);
}

.jp-Document {
  min-width: 120px;
  min-height: 120px;
  outline: none;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Main OutputArea
| OutputArea has a list of Outputs
|----------------------------------------------------------------------------*/

.jp-OutputArea {
  overflow-y: auto;
}

.jp-OutputArea-child {
  display: table;
  table-layout: fixed;
  width: 100%;
  overflow: hidden;
}

.jp-OutputPrompt {
  width: var(--jp-cell-prompt-width);
  color: var(--jp-cell-outprompt-font-color);
  font-family: var(--jp-cell-prompt-font-family);
  padding: var(--jp-code-padding);
  letter-spacing: var(--jp-cell-prompt-letter-spacing);
  line-height: var(--jp-code-line-height);
  font-size: var(--jp-code-font-size);
  border: var(--jp-border-width) solid transparent;
  opacity: var(--jp-cell-prompt-opacity);

  /* Right align prompt text, don't wrap to handle large prompt numbers */
  text-align: right;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;

  /* Disable text selection */
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.jp-OutputArea-prompt {
  display: table-cell;
  vertical-align: top;
}

.jp-OutputArea-output {
  display: table-cell;
  width: 100%;
  height: auto;
  overflow: auto;
  user-select: text;
  -moz-user-select: text;
  -webkit-user-select: text;
  -ms-user-select: text;
}

.jp-OutputArea .jp-RenderedText {
  padding-left: 1ch;
}

/**
 * Prompt overlay.
 */

.jp-OutputArea-promptOverlay {
  position: absolute;
  top: 0;
  width: var(--jp-cell-prompt-width);
  height: 100%;
  opacity: 0.5;
}

.jp-OutputArea-promptOverlay:hover {
  background: var(--jp-layout-color2);
  box-shadow: inset 0 0 1px var(--jp-inverse-layout-color0);
  cursor: zoom-out;
}

.jp-mod-outputsScrolled .jp-OutputArea-promptOverlay:hover {
  cursor: zoom-in;
}

/**
 * Isolated output.
 */
.jp-OutputArea-output.jp-mod-isolated {
  width: 100%;
  display: block;
}

/*
When drag events occur, `lm-mod-override-cursor` is added to the body.
Because iframes steal all cursor events, the following two rules are necessary
to suppress pointer events while resize drags are occurring. There may be a
better solution to this problem.
*/
body.lm-mod-override-cursor .jp-OutputArea-output.jp-mod-isolated {
  position: relative;
}

body.lm-mod-override-cursor .jp-OutputArea-output.jp-mod-isolated::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: transparent;
}

/* pre */

.jp-OutputArea-output pre {
  border: none;
  margin: 0;
  padding: 0;
  overflow-x: auto;
  overflow-y: auto;
  word-break: break-all;
  word-wrap: break-word;
  white-space: pre-wrap;
}

/* tables */

.jp-OutputArea-output.jp-RenderedHTMLCommon table {
  margin-left: 0;
  margin-right: 0;
}

/* description lists */

.jp-OutputArea-output dl,
.jp-OutputArea-output dt,
.jp-OutputArea-output dd {
  display: block;
}

.jp-OutputArea-output dl {
  width: 100%;
  overflow: hidden;
  padding: 0;
  margin: 0;
}

.jp-OutputArea-output dt {
  font-weight: bold;
  float: left;
  width: 20%;
  padding: 0;
  margin: 0;
}

.jp-OutputArea-output dd {
  float: left;
  width: 80%;
  padding: 0;
  margin: 0;
}

.jp-TrimmedOutputs pre {
  background: var(--jp-layout-color3);
  font-size: calc(var(--jp-code-font-size) * 1.4);
  text-align: center;
  text-transform: uppercase;
}

/* Hide the gutter in case of
 *  - nested output areas (e.g. in the case of output widgets)
 *  - mirrored output areas
 */
.jp-OutputArea .jp-OutputArea .jp-OutputArea-prompt {
  display: none;
}

/* Hide empty lines in the output area, for instance due to cleared widgets */
.jp-OutputArea-prompt:empty {
  padding: 0;
  border: 0;
}

/*-----------------------------------------------------------------------------
| executeResult is added to any Output-result for the display of the object
| returned by a cell
|----------------------------------------------------------------------------*/

.jp-OutputArea-output.jp-OutputArea-executeResult {
  margin-left: 0;
  width: 100%;
}

/* Text output with the Out[] prompt needs a top padding to match the
 * alignment of the Out[] prompt itself.
 */
.jp-OutputArea-executeResult .jp-RenderedText.jp-OutputArea-output {
  padding-top: var(--jp-code-padding);
  border-top: var(--jp-border-width) solid transparent;
}

/*-----------------------------------------------------------------------------
| The Stdin output
|----------------------------------------------------------------------------*/

.jp-Stdin-prompt {
  color: var(--jp-content-font-color0);
  padding-right: var(--jp-code-padding);
  vertical-align: baseline;
  flex: 0 0 auto;
}

.jp-Stdin-input {
  font-family: var(--jp-code-font-family);
  font-size: inherit;
  color: inherit;
  background-color: inherit;
  width: 42%;
  min-width: 200px;

  /* make sure input baseline aligns with prompt */
  vertical-align: baseline;

  /* padding + margin = 0.5em between prompt and cursor */
  padding: 0 0.25em;
  margin: 0 0.25em;
  flex: 0 0 70%;
}

.jp-Stdin-input::placeholder {
  opacity: 0;
}

.jp-Stdin-input:focus {
  box-shadow: none;
}

.jp-Stdin-input:focus::placeholder {
  opacity: 1;
}

/*-----------------------------------------------------------------------------
| Output Area View
|----------------------------------------------------------------------------*/

.jp-LinkedOutputView .jp-OutputArea {
  height: 100%;
  display: block;
}

.jp-LinkedOutputView .jp-OutputArea-output:only-child {
  height: 100%;
}

/*-----------------------------------------------------------------------------
| Printing
|----------------------------------------------------------------------------*/

@media print {
  .jp-OutputArea-child {
    break-inside: avoid-page;
  }
}

/*-----------------------------------------------------------------------------
| Mobile
|----------------------------------------------------------------------------*/
@media only screen and (max-width: 760px) {
  .jp-OutputPrompt {
    display: table-row;
    text-align: left;
  }

  .jp-OutputArea-child .jp-OutputArea-output {
    display: table-row;
    margin-left: var(--jp-notebook-padding);
  }
}

/* Trimmed outputs warning */
.jp-TrimmedOutputs > a {
  margin: 10px;
  text-decoration: none;
  cursor: pointer;
}

.jp-TrimmedOutputs > a:hover {
  text-decoration: none;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Table of Contents
|----------------------------------------------------------------------------*/

:root {
  --jp-private-toc-active-width: 4px;
}

.jp-TableOfContents {
  display: flex;
  flex-direction: column;
  background: var(--jp-layout-color1);
  color: var(--jp-ui-font-color1);
  font-size: var(--jp-ui-font-size1);
  height: 100%;
}

.jp-TableOfContents-placeholder {
  text-align: center;
}

.jp-TableOfContents-placeholderContent {
  color: var(--jp-content-font-color2);
  padding: 8px;
}

.jp-TableOfContents-placeholderContent > h3 {
  margin-bottom: var(--jp-content-heading-margin-bottom);
}

.jp-TableOfContents .jp-SidePanel-content {
  overflow-y: auto;
}

.jp-TableOfContents-tree {
  margin: 4px;
}

.jp-TableOfContents ol {
  list-style-type: none;
}

/* stylelint-disable-next-line selector-max-type */
.jp-TableOfContents li > ol {
  /* Align left border with triangle icon center */
  padding-left: 11px;
}

.jp-TableOfContents-content {
  /* left margin for the active heading indicator */
  margin: 0 0 0 var(--jp-private-toc-active-width);
  padding: 0;
  background-color: var(--jp-layout-color1);
}

.jp-tocItem {
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.jp-tocItem-heading {
  display: flex;
  cursor: pointer;
}

.jp-tocItem-heading:hover {
  background-color: var(--jp-layout-color2);
}

.jp-tocItem-content {
  display: block;
  padding: 4px 0;
  white-space: nowrap;
  text-overflow: ellipsis;
  overflow-x: hidden;
}

.jp-tocItem-collapser {
  height: 20px;
  margin: 2px 2px 0;
  padding: 0;
  background: none;
  border: none;
  cursor: pointer;
}

.jp-tocItem-collapser:hover {
  background-color: var(--jp-layout-color3);
}

/* Active heading indicator */

.jp-tocItem-heading::before {
  content: ' ';
  background: transparent;
  width: var(--jp-private-toc-active-width);
  height: 24px;
  position: absolute;
  left: 0;
  border-radius: var(--jp-border-radius);
}

.jp-tocItem-heading.jp-tocItem-active::before {
  background-color: var(--jp-brand-color1);
}

.jp-tocItem-heading:hover.jp-tocItem-active::before {
  background: var(--jp-brand-color0);
  opacity: 1;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.jp-Collapser {
  flex: 0 0 var(--jp-cell-collapser-width);
  padding: 0;
  margin: 0;
  border: none;
  outline: none;
  background: transparent;
  border-radius: var(--jp-border-radius);
  opacity: 1;
}

.jp-Collapser-child {
  display: block;
  width: 100%;
  box-sizing: border-box;

  /* height: 100% doesn't work because the height of its parent is computed from content */
  position: absolute;
  top: 0;
  bottom: 0;
}

/*-----------------------------------------------------------------------------
| Printing
|----------------------------------------------------------------------------*/

/*
Hiding collapsers in print mode.

Note: input and output wrappers have "display: block" propery in print mode.
*/

@media print {
  .jp-Collapser {
    display: none;
  }
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Header/Footer
|----------------------------------------------------------------------------*/

/* Hidden by zero height by default */
.jp-CellHeader,
.jp-CellFooter {
  height: 0;
  width: 100%;
  padding: 0;
  margin: 0;
  border: none;
  outline: none;
  background: transparent;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Input
|----------------------------------------------------------------------------*/

/* All input areas */
.jp-InputArea {
  display: table;
  table-layout: fixed;
  width: 100%;
  overflow: hidden;
}

.jp-InputArea-editor {
  display: table-cell;
  overflow: hidden;
  vertical-align: top;

  /* This is the non-active, default styling */
  border: var(--jp-border-width) solid var(--jp-cell-editor-border-color);
  border-radius: 0;
  background: var(--jp-cell-editor-background);
}

.jp-InputPrompt {
  display: table-cell;
  vertical-align: top;
  width: var(--jp-cell-prompt-width);
  color: var(--jp-cell-inprompt-font-color);
  font-family: var(--jp-cell-prompt-font-family);
  padding: var(--jp-code-padding);
  letter-spacing: var(--jp-cell-prompt-letter-spacing);
  opacity: var(--jp-cell-prompt-opacity);
  line-height: var(--jp-code-line-height);
  font-size: var(--jp-code-font-size);
  border: var(--jp-border-width) solid transparent;

  /* Right align prompt text, don't wrap to handle large prompt numbers */
  text-align: right;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;

  /* Disable text selection */
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

/*-----------------------------------------------------------------------------
| Mobile
|----------------------------------------------------------------------------*/
@media only screen and (max-width: 760px) {
  .jp-InputArea-editor {
    display: table-row;
    margin-left: var(--jp-notebook-padding);
  }

  .jp-InputPrompt {
    display: table-row;
    text-align: left;
  }
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Placeholder
|----------------------------------------------------------------------------*/

.jp-Placeholder {
  display: table;
  table-layout: fixed;
  width: 100%;
}

.jp-Placeholder-prompt {
  display: table-cell;
  box-sizing: border-box;
}

.jp-Placeholder-content {
  display: table-cell;
  padding: 4px 6px;
  border: 1px solid transparent;
  border-radius: 0;
  background: none;
  box-sizing: border-box;
  cursor: pointer;
}

.jp-Placeholder-contentContainer {
  display: flex;
}

.jp-Placeholder-content:hover,
.jp-InputPlaceholder > .jp-Placeholder-content:hover {
  border-color: var(--jp-layout-color3);
}

.jp-Placeholder-content .jp-MoreHorizIcon {
  width: 32px;
  height: 16px;
  border: 1px solid transparent;
  border-radius: var(--jp-border-radius);
}

.jp-Placeholder-content .jp-MoreHorizIcon:hover {
  border: 1px solid var(--jp-border-color1);
  box-shadow: 0 0 2px 0 rgba(0, 0, 0, 0.25);
  background-color: var(--jp-layout-color0);
}

.jp-PlaceholderText {
  white-space: nowrap;
  overflow-x: hidden;
  color: var(--jp-inverse-layout-color3);
  font-family: var(--jp-code-font-family);
}

.jp-InputPlaceholder > .jp-Placeholder-content {
  border-color: var(--jp-cell-editor-border-color);
  background: var(--jp-cell-editor-background);
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Private CSS variables
|----------------------------------------------------------------------------*/

:root {
  --jp-private-cell-scrolling-output-offset: 5px;
}

/*-----------------------------------------------------------------------------
| Cell
|----------------------------------------------------------------------------*/

.jp-Cell {
  padding: var(--jp-cell-padding);
  margin: 0;
  border: none;
  outline: none;
  background: transparent;
}

/*-----------------------------------------------------------------------------
| Common input/output
|----------------------------------------------------------------------------*/

.jp-Cell-inputWrapper,
.jp-Cell-outputWrapper {
  display: flex;
  flex-direction: row;
  padding: 0;
  margin: 0;

  /* Added to reveal the box-shadow on the input and output collapsers. */
  overflow: visible;
}

/* Only input/output areas inside cells */
.jp-Cell-inputArea,
.jp-Cell-outputArea {
  flex: 1 1 auto;
}

/*-----------------------------------------------------------------------------
| Collapser
|----------------------------------------------------------------------------*/

/* Make the output collapser disappear when there is not output, but do so
 * in a manner that leaves it in the layout and preserves its width.
 */
.jp-Cell.jp-mod-noOutputs .jp-Cell-outputCollapser {
  border: none !important;
  background: transparent !important;
}

.jp-Cell:not(.jp-mod-noOutputs) .jp-Cell-outputCollapser {
  min-height: var(--jp-cell-collapser-min-height);
}

/*-----------------------------------------------------------------------------
| Output
|----------------------------------------------------------------------------*/

/* Put a space between input and output when there IS output */
.jp-Cell:not(.jp-mod-noOutputs) .jp-Cell-outputWrapper {
  margin-top: 5px;
}

.jp-CodeCell.jp-mod-outputsScrolled .jp-Cell-outputArea {
  overflow-y: auto;
  max-height: 24em;
  margin-left: var(--jp-private-cell-scrolling-output-offset);
  resize: vertical;
}

.jp-CodeCell.jp-mod-outputsScrolled .jp-Cell-outputArea[style*='height'] {
  max-height: unset;
}

.jp-CodeCell.jp-mod-outputsScrolled .jp-Cell-outputArea::after {
  content: ' ';
  box-shadow: inset 0 0 6px 2px rgb(0 0 0 / 30%);
  width: 100%;
  height: 100%;
  position: sticky;
  bottom: 0;
  top: 0;
  margin-top: -50%;
  float: left;
  display: block;
  pointer-events: none;
}

.jp-CodeCell.jp-mod-outputsScrolled .jp-OutputArea-child {
  padding-top: 6px;
}

.jp-CodeCell.jp-mod-outputsScrolled .jp-OutputArea-prompt {
  width: calc(
    var(--jp-cell-prompt-width) - var(--jp-private-cell-scrolling-output-offset)
  );
}

.jp-CodeCell.jp-mod-outputsScrolled .jp-OutputArea-promptOverlay {
  left: calc(-1 * var(--jp-private-cell-scrolling-output-offset));
}

/*-----------------------------------------------------------------------------
| CodeCell
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| MarkdownCell
|----------------------------------------------------------------------------*/

.jp-MarkdownOutput {
  display: table-cell;
  width: 100%;
  margin-top: 0;
  margin-bottom: 0;
  padding-left: var(--jp-code-padding);
}

.jp-MarkdownOutput.jp-RenderedHTMLCommon {
  overflow: auto;
}

/* collapseHeadingButton (show always if hiddenCellsButton is _not_ shown) */
.jp-collapseHeadingButton {
  display: flex;
  min-height: var(--jp-cell-collapser-min-height);
  font-size: var(--jp-code-font-size);
  position: absolute;
  background-color: transparent;
  background-size: 25px;
  background-repeat: no-repeat;
  background-position-x: center;
  background-position-y: top;
  background-image: var(--jp-icon-caret-down);
  right: 0;
  top: 0;
  bottom: 0;
}

.jp-collapseHeadingButton.jp-mod-collapsed {
  background-image: var(--jp-icon-caret-right);
}

/*
 set the container font size to match that of content
 so that the nested collapse buttons have the right size
*/
.jp-MarkdownCell .jp-InputPrompt {
  font-size: var(--jp-content-font-size1);
}

/*
  Align collapseHeadingButton with cell top header
  The font sizes are identical to the ones in packages/rendermime/style/base.css
*/
.jp-mod-rendered .jp-collapseHeadingButton[data-heading-level='1'] {
  font-size: var(--jp-content-font-size5);
  background-position-y: calc(0.3 * var(--jp-content-font-size5));
}

.jp-mod-rendered .jp-collapseHeadingButton[data-heading-level='2'] {
  font-size: var(--jp-content-font-size4);
  background-position-y: calc(0.3 * var(--jp-content-font-size4));
}

.jp-mod-rendered .jp-collapseHeadingButton[data-heading-level='3'] {
  font-size: var(--jp-content-font-size3);
  background-position-y: calc(0.3 * var(--jp-content-font-size3));
}

.jp-mod-rendered .jp-collapseHeadingButton[data-heading-level='4'] {
  font-size: var(--jp-content-font-size2);
  background-position-y: calc(0.3 * var(--jp-content-font-size2));
}

.jp-mod-rendered .jp-collapseHeadingButton[data-heading-level='5'] {
  font-size: var(--jp-content-font-size1);
  background-position-y: top;
}

.jp-mod-rendered .jp-collapseHeadingButton[data-heading-level='6'] {
  font-size: var(--jp-content-font-size0);
  background-position-y: top;
}

/* collapseHeadingButton (show only on (hover,active) if hiddenCellsButton is shown) */
.jp-Notebook.jp-mod-showHiddenCellsButton .jp-collapseHeadingButton {
  display: none;
}

.jp-Notebook.jp-mod-showHiddenCellsButton
  :is(.jp-MarkdownCell:hover, .jp-mod-active)
  .jp-collapseHeadingButton {
  display: flex;
}

/* showHiddenCellsButton (only show if jp-mod-showHiddenCellsButton is set, which
is a consequence of the showHiddenCellsButton option in Notebook Settings)*/
.jp-Notebook.jp-mod-showHiddenCellsButton .jp-showHiddenCellsButton {
  margin-left: calc(var(--jp-cell-prompt-width) + 2 * var(--jp-code-padding));
  margin-top: var(--jp-code-padding);
  border: 1px solid var(--jp-border-color2);
  background-color: var(--jp-border-color3) !important;
  color: var(--jp-content-font-color0) !important;
  display: flex;
}

.jp-Notebook.jp-mod-showHiddenCellsButton .jp-showHiddenCellsButton:hover {
  background-color: var(--jp-border-color2) !important;
}

.jp-showHiddenCellsButton {
  display: none;
}

/*-----------------------------------------------------------------------------
| Printing
|----------------------------------------------------------------------------*/

/*
Using block instead of flex to allow the use of the break-inside CSS property for
cell outputs.
*/

@media print {
  .jp-Cell-inputWrapper,
  .jp-Cell-outputWrapper {
    display: block;
  }
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Variables
|----------------------------------------------------------------------------*/

:root {
  --jp-notebook-toolbar-padding: 2px 5px 2px 2px;
}

/*-----------------------------------------------------------------------------

/*-----------------------------------------------------------------------------
| Styles
|----------------------------------------------------------------------------*/

.jp-NotebookPanel-toolbar {
  padding: var(--jp-notebook-toolbar-padding);

  /* disable paint containment from lumino 2.0 default strict CSS containment */
  contain: style size !important;
}

.jp-Toolbar-item.jp-Notebook-toolbarCellType .jp-select-wrapper.jp-mod-focused {
  border: none;
  box-shadow: none;
}

.jp-Notebook-toolbarCellTypeDropdown select {
  height: 24px;
  font-size: var(--jp-ui-font-size1);
  line-height: 14px;
  border-radius: 0;
  display: block;
}

.jp-Notebook-toolbarCellTypeDropdown span {
  top: 5px !important;
}

.jp-Toolbar-responsive-popup {
  position: absolute;
  height: fit-content;
  display: flex;
  flex-direction: row;
  flex-wrap: wrap;
  justify-content: flex-end;
  border-bottom: var(--jp-border-width) solid var(--jp-toolbar-border-color);
  box-shadow: var(--jp-toolbar-box-shadow);
  background: var(--jp-toolbar-background);
  min-height: var(--jp-toolbar-micro-height);
  padding: var(--jp-notebook-toolbar-padding);
  z-index: 1;
  right: 0;
  top: 0;
}

.jp-Toolbar > .jp-Toolbar-responsive-opener {
  margin-left: auto;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Variables
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------

/*-----------------------------------------------------------------------------
| Styles
|----------------------------------------------------------------------------*/

.jp-Notebook-ExecutionIndicator {
  position: relative;
  display: inline-block;
  height: 100%;
  z-index: 9997;
}

.jp-Notebook-ExecutionIndicator-tooltip {
  visibility: hidden;
  height: auto;
  width: max-content;
  width: -moz-max-content;
  background-color: var(--jp-layout-color2);
  color: var(--jp-ui-font-color1);
  text-align: justify;
  border-radius: 6px;
  padding: 0 5px;
  position: fixed;
  display: table;
}

.jp-Notebook-ExecutionIndicator-tooltip.up {
  transform: translateX(-50%) translateY(-100%) translateY(-32px);
}

.jp-Notebook-ExecutionIndicator-tooltip.down {
  transform: translateX(calc(-100% + 16px)) translateY(5px);
}

.jp-Notebook-ExecutionIndicator-tooltip.hidden {
  display: none;
}

.jp-Notebook-ExecutionIndicator:hover .jp-Notebook-ExecutionIndicator-tooltip {
  visibility: visible;
}

.jp-Notebook-ExecutionIndicator span {
  font-size: var(--jp-ui-font-size1);
  font-family: var(--jp-ui-font-family);
  color: var(--jp-ui-font-color1);
  line-height: 24px;
  display: block;
}

.jp-Notebook-ExecutionIndicator-progress-bar {
  display: flex;
  justify-content: center;
  height: 100%;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

/*
 * Execution indicator
 */
.jp-tocItem-content::after {
  content: '';

  /* Must be identical to form a circle */
  width: 12px;
  height: 12px;
  background: none;
  border: none;
  position: absolute;
  right: 0;
}

.jp-tocItem-content[data-running='0']::after {
  border-radius: 50%;
  border: var(--jp-border-width) solid var(--jp-inverse-layout-color3);
  background: none;
}

.jp-tocItem-content[data-running='1']::after {
  border-radius: 50%;
  border: var(--jp-border-width) solid var(--jp-inverse-layout-color3);
  background-color: var(--jp-inverse-layout-color3);
}

.jp-tocItem-content[data-running='0'],
.jp-tocItem-content[data-running='1'] {
  margin-right: 12px;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

.jp-Notebook-footer {
  height: 27px;
  margin-left: calc(
    var(--jp-cell-prompt-width) + var(--jp-cell-collapser-width) +
      var(--jp-cell-padding)
  );
  width: calc(
    100% -
      (
        var(--jp-cell-prompt-width) + var(--jp-cell-collapser-width) +
          var(--jp-cell-padding) + var(--jp-cell-padding)
      )
  );
  border: var(--jp-border-width) solid var(--jp-cell-editor-border-color);
  color: var(--jp-ui-font-color3);
  margin-top: 6px;
  background: none;
  cursor: pointer;
}

.jp-Notebook-footer:focus {
  border-color: var(--jp-cell-editor-active-border-color);
}

/* For devices that support hovering, hide footer until hover */
@media (hover: hover) {
  .jp-Notebook-footer {
    opacity: 0;
  }

  .jp-Notebook-footer:focus,
  .jp-Notebook-footer:hover {
    opacity: 1;
  }
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Imports
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| CSS variables
|----------------------------------------------------------------------------*/

:root {
  --jp-side-by-side-output-size: 1fr;
  --jp-side-by-side-resized-cell: var(--jp-side-by-side-output-size);
  --jp-private-notebook-dragImage-width: 304px;
  --jp-private-notebook-dragImage-height: 36px;
  --jp-private-notebook-selected-color: var(--md-blue-400);
  --jp-private-notebook-active-color: var(--md-green-400);
}

/*-----------------------------------------------------------------------------
| Notebook
|----------------------------------------------------------------------------*/

/* stylelint-disable selector-max-class */

.jp-NotebookPanel {
  display: block;
  height: 100%;
}

.jp-NotebookPanel.jp-Document {
  min-width: 240px;
  min-height: 120px;
}

.jp-Notebook {
  padding: var(--jp-notebook-padding);
  outline: none;
  overflow: auto;
  background: var(--jp-layout-color0);
}

.jp-Notebook.jp-mod-scrollPastEnd::after {
  display: block;
  content: '';
  min-height: var(--jp-notebook-scroll-padding);
}

.jp-MainAreaWidget-ContainStrict .jp-Notebook * {
  contain: strict;
}

.jp-Notebook .jp-Cell {
  overflow: visible;
}

.jp-Notebook .jp-Cell .jp-InputPrompt {
  cursor: move;
}

/*-----------------------------------------------------------------------------
| Notebook state related styling
|
| The notebook and cells each have states, here are the possibilities:
|
| - Notebook
|   - Command
|   - Edit
| - Cell
|   - None
|   - Active (only one can be active)
|   - Selected (the cells actions are applied to)
|   - Multiselected (when multiple selected, the cursor)
|   - No outputs
|----------------------------------------------------------------------------*/

/* Command or edit modes */

.jp-Notebook .jp-Cell:not(.jp-mod-active) .jp-InputPrompt {
  opacity: var(--jp-cell-prompt-not-active-opacity);
  color: var(--jp-cell-prompt-not-active-font-color);
}

.jp-Notebook .jp-Cell:not(.jp-mod-active) .jp-OutputPrompt {
  opacity: var(--jp-cell-prompt-not-active-opacity);
  color: var(--jp-cell-prompt-not-active-font-color);
}

/* cell is active */
.jp-Notebook .jp-Cell.jp-mod-active .jp-Collapser {
  background: var(--jp-brand-color1);
}

/* cell is dirty */
.jp-Notebook .jp-Cell.jp-mod-dirty .jp-InputPrompt {
  color: var(--jp-warn-color1);
}

.jp-Notebook .jp-Cell.jp-mod-dirty .jp-InputPrompt::before {
  color: var(--jp-warn-color1);
  content: '';
}

.jp-Notebook .jp-Cell.jp-mod-active.jp-mod-dirty .jp-Collapser {
  background: var(--jp-warn-color1);
}

/* collapser is hovered */
.jp-Notebook .jp-Cell .jp-Collapser:hover {
  box-shadow: var(--jp-elevation-z2);
  background: var(--jp-brand-color1);
  opacity: var(--jp-cell-collapser-not-active-hover-opacity);
}

/* cell is active and collapser is hovered */
.jp-Notebook .jp-Cell.jp-mod-active .jp-Collapser:hover {
  background: var(--jp-brand-color0);
  opacity: 1;
}

/* Command mode */

.jp-Notebook.jp-mod-commandMode .jp-Cell.jp-mod-selected {
  background: var(--jp-notebook-multiselected-color);
}

.jp-Notebook.jp-mod-commandMode
  .jp-Cell.jp-mod-active.jp-mod-selected:not(.jp-mod-multiSelected) {
  background: transparent;
}

/* Edit mode */

.jp-Notebook.jp-mod-editMode .jp-Cell.jp-mod-active .jp-InputArea-editor {
  border: var(--jp-border-width) solid var(--jp-cell-editor-active-border-color);
  box-shadow: var(--jp-input-box-shadow);
  background-color: var(--jp-cell-editor-active-background);
}

/*-----------------------------------------------------------------------------
| Notebook drag and drop
|----------------------------------------------------------------------------*/

.jp-Notebook-cell.jp-mod-dropSource {
  opacity: 0.5;
}

.jp-Notebook-cell.jp-mod-dropTarget,
.jp-Notebook.jp-mod-commandMode
  .jp-Notebook-cell.jp-mod-active.jp-mod-selected.jp-mod-dropTarget {
  border-top-color: var(--jp-private-notebook-selected-color);
  border-top-style: solid;
  border-top-width: 2px;
}

.jp-dragImage {
  display: block;
  flex-direction: row;
  width: var(--jp-private-notebook-dragImage-width);
  height: var(--jp-private-notebook-dragImage-height);
  border: var(--jp-border-width) solid var(--jp-cell-editor-border-color);
  background: var(--jp-cell-editor-background);
  overflow: visible;
}

.jp-dragImage-singlePrompt {
  box-shadow: 2px 2px 4px 0 rgba(0, 0, 0, 0.12);
}

.jp-dragImage .jp-dragImage-content {
  flex: 1 1 auto;
  z-index: 2;
  font-size: var(--jp-code-font-size);
  font-family: var(--jp-code-font-family);
  line-height: var(--jp-code-line-height);
  padding: var(--jp-code-padding);
  border: var(--jp-border-width) solid var(--jp-cell-editor-border-color);
  background: var(--jp-cell-editor-background-color);
  color: var(--jp-content-font-color3);
  text-align: left;
  margin: 4px 4px 4px 0;
}

.jp-dragImage .jp-dragImage-prompt {
  flex: 0 0 auto;
  min-width: 36px;
  color: var(--jp-cell-inprompt-font-color);
  padding: var(--jp-code-padding);
  padding-left: 12px;
  font-family: var(--jp-cell-prompt-font-family);
  letter-spacing: var(--jp-cell-prompt-letter-spacing);
  line-height: 1.9;
  font-size: var(--jp-code-font-size);
  border: var(--jp-border-width) solid transparent;
}

.jp-dragImage-multipleBack {
  z-index: -1;
  position: absolute;
  height: 32px;
  width: 300px;
  top: 8px;
  left: 8px;
  background: var(--jp-layout-color2);
  border: var(--jp-border-width) solid var(--jp-input-border-color);
  box-shadow: 2px 2px 4px 0 rgba(0, 0, 0, 0.12);
}

/*-----------------------------------------------------------------------------
| Cell toolbar
|----------------------------------------------------------------------------*/

.jp-NotebookTools {
  display: block;
  min-width: var(--jp-sidebar-min-width);
  color: var(--jp-ui-font-color1);
  background: var(--jp-layout-color1);

  /* This is needed so that all font sizing of children done in ems is
    * relative to this base size */
  font-size: var(--jp-ui-font-size1);
  overflow: auto;
}

.jp-ActiveCellTool {
  padding: 12px 0;
  display: flex;
}

.jp-ActiveCellTool-Content {
  flex: 1 1 auto;
}

.jp-ActiveCellTool .jp-ActiveCellTool-CellContent {
  background: var(--jp-cell-editor-background);
  border: var(--jp-border-width) solid var(--jp-cell-editor-border-color);
  border-radius: 0;
  min-height: 29px;
}

.jp-ActiveCellTool .jp-InputPrompt {
  min-width: calc(var(--jp-cell-prompt-width) * 0.75);
}

.jp-ActiveCellTool-CellContent > pre {
  padding: 5px 4px;
  margin: 0;
  white-space: normal;
}

.jp-MetadataEditorTool {
  flex-direction: column;
  padding: 12px 0;
}

.jp-RankedPanel > :not(:first-child) {
  margin-top: 12px;
}

.jp-KeySelector select.jp-mod-styled {
  font-size: var(--jp-ui-font-size1);
  color: var(--jp-ui-font-color0);
  border: var(--jp-border-width) solid var(--jp-border-color1);
}

.jp-KeySelector label,
.jp-MetadataEditorTool label,
.jp-NumberSetter label {
  line-height: 1.4;
}

.jp-NotebookTools .jp-select-wrapper {
  margin-top: 4px;
  margin-bottom: 0;
}

.jp-NumberSetter input {
  width: 100%;
  margin-top: 4px;
}

.jp-NotebookTools .jp-Collapse {
  margin-top: 16px;
}

/*-----------------------------------------------------------------------------
| Presentation Mode (.jp-mod-presentationMode)
|----------------------------------------------------------------------------*/

.jp-mod-presentationMode .jp-Notebook {
  --jp-content-font-size1: var(--jp-content-presentation-font-size1);
  --jp-code-font-size: var(--jp-code-presentation-font-size);
}

.jp-mod-presentationMode .jp-Notebook .jp-Cell .jp-InputPrompt,
.jp-mod-presentationMode .jp-Notebook .jp-Cell .jp-OutputPrompt {
  flex: 0 0 110px;
}

/*-----------------------------------------------------------------------------
| Side-by-side Mode (.jp-mod-sideBySide)
|----------------------------------------------------------------------------*/
.jp-mod-sideBySide.jp-Notebook .jp-Notebook-cell {
  margin-top: 3em;
  margin-bottom: 3em;
  margin-left: 5%;
  margin-right: 5%;
}

.jp-mod-sideBySide.jp-Notebook .jp-CodeCell {
  display: grid;
  grid-template-columns: minmax(0, 1fr) min-content minmax(
      0,
      var(--jp-side-by-side-output-size)
    );
  grid-template-rows: auto minmax(0, 1fr) auto;
  grid-template-areas:
    'header header header'
    'input handle output'
    'footer footer footer';
}

.jp-mod-sideBySide.jp-Notebook .jp-CodeCell.jp-mod-resizedCell {
  grid-template-columns: minmax(0, 1fr) min-content minmax(
      0,
      var(--jp-side-by-side-resized-cell)
    );
}

.jp-mod-sideBySide.jp-Notebook .jp-CodeCell .jp-CellHeader {
  grid-area: header;
}

.jp-mod-sideBySide.jp-Notebook .jp-CodeCell .jp-Cell-inputWrapper {
  grid-area: input;
}

.jp-mod-sideBySide.jp-Notebook .jp-CodeCell .jp-Cell-outputWrapper {
  /* overwrite the default margin (no vertical separation needed in side by side move */
  margin-top: 0;
  grid-area: output;
}

.jp-mod-sideBySide.jp-Notebook .jp-CodeCell .jp-CellFooter {
  grid-area: footer;
}

.jp-mod-sideBySide.jp-Notebook .jp-CodeCell .jp-CellResizeHandle {
  grid-area: handle;
  user-select: none;
  display: block;
  height: 100%;
  cursor: ew-resize;
  padding: 0 var(--jp-cell-padding);
}

.jp-mod-sideBySide.jp-Notebook .jp-CodeCell .jp-CellResizeHandle::after {
  content: '';
  display: block;
  background: var(--jp-border-color2);
  height: 100%;
  width: 5px;
}

.jp-mod-sideBySide.jp-Notebook
  .jp-CodeCell.jp-mod-resizedCell
  .jp-CellResizeHandle::after {
  background: var(--jp-border-color0);
}

.jp-CellResizeHandle {
  display: none;
}

/*-----------------------------------------------------------------------------
| Placeholder
|----------------------------------------------------------------------------*/

.jp-Cell-Placeholder {
  padding-left: 55px;
}

.jp-Cell-Placeholder-wrapper {
  background: #fff;
  border: 1px solid;
  border-color: #e5e6e9 #dfe0e4 #d0d1d5;
  border-radius: 4px;
  -webkit-border-radius: 4px;
  margin: 10px 15px;
}

.jp-Cell-Placeholder-wrapper-inner {
  padding: 15px;
  position: relative;
}

.jp-Cell-Placeholder-wrapper-body {
  background-repeat: repeat;
  background-size: 50% auto;
}

.jp-Cell-Placeholder-wrapper-body div {
  background: #f6f7f8;
  background-image: -webkit-linear-gradient(
    left,
    #f6f7f8 0%,
    #edeef1 20%,
    #f6f7f8 40%,
    #f6f7f8 100%
  );
  background-repeat: no-repeat;
  background-size: 800px 104px;
  height: 104px;
  position: absolute;
  right: 15px;
  left: 15px;
  top: 15px;
}

div.jp-Cell-Placeholder-h1 {
  top: 20px;
  height: 20px;
  left: 15px;
  width: 150px;
}

div.jp-Cell-Placeholder-h2 {
  left: 15px;
  top: 50px;
  height: 10px;
  width: 100px;
}

div.jp-Cell-Placeholder-content-1,
div.jp-Cell-Placeholder-content-2,
div.jp-Cell-Placeholder-content-3 {
  left: 15px;
  right: 15px;
  height: 10px;
}

div.jp-Cell-Placeholder-content-1 {
  top: 100px;
}

div.jp-Cell-Placeholder-content-2 {
  top: 120px;
}

div.jp-Cell-Placeholder-content-3 {
  top: 140px;
}

</style>
<style type="text/css">
/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*
The following CSS variables define the main, public API for styling JupyterLab.
These variables should be used by all plugins wherever possible. In other
words, plugins should not define custom colors, sizes, etc unless absolutely
necessary. This enables users to change the visual theme of JupyterLab
by changing these variables.

Many variables appear in an ordered sequence (0,1,2,3). These sequences
are designed to work well together, so for example, `--jp-border-color1` should
be used with `--jp-layout-color1`. The numbers have the following meanings:

* 0: super-primary, reserved for special emphasis
* 1: primary, most important under normal situations
* 2: secondary, next most important under normal situations
* 3: tertiary, next most important under normal situations

Throughout JupyterLab, we are mostly following principles from Google's
Material Design when selecting colors. We are not, however, following
all of MD as it is not optimized for dense, information rich UIs.
*/

:root {
  /* Elevation
   *
   * We style box-shadows using Material Design's idea of elevation. These particular numbers are taken from here:
   *
   * https://github.com/material-components/material-components-web
   * https://material-components-web.appspot.com/elevation.html
   */

  /* The dark theme shadows need a bit of work, but this will probably also require work on the core layout
   * colors used in the theme as well. */
  --jp-shadow-base-lightness: 32;
  --jp-shadow-umbra-color: rgba(
    var(--jp-shadow-base-lightness),
    var(--jp-shadow-base-lightness),
    var(--jp-shadow-base-lightness),
    0.2
  );
  --jp-shadow-penumbra-color: rgba(
    var(--jp-shadow-base-lightness),
    var(--jp-shadow-base-lightness),
    var(--jp-shadow-base-lightness),
    0.14
  );
  --jp-shadow-ambient-color: rgba(
    var(--jp-shadow-base-lightness),
    var(--jp-shadow-base-lightness),
    var(--jp-shadow-base-lightness),
    0.12
  );
  --jp-elevation-z0: none;
  --jp-elevation-z1: 0 2px 1px -1px var(--jp-shadow-umbra-color),
    0 1px 1px 0 var(--jp-shadow-penumbra-color),
    0 1px 3px 0 var(--jp-shadow-ambient-color);
  --jp-elevation-z2: 0 3px 1px -2px var(--jp-shadow-umbra-color),
    0 2px 2px 0 var(--jp-shadow-penumbra-color),
    0 1px 5px 0 var(--jp-shadow-ambient-color);
  --jp-elevation-z4: 0 2px 4px -1px var(--jp-shadow-umbra-color),
    0 4px 5px 0 var(--jp-shadow-penumbra-color),
    0 1px 10px 0 var(--jp-shadow-ambient-color);
  --jp-elevation-z6: 0 3px 5px -1px var(--jp-shadow-umbra-color),
    0 6px 10px 0 var(--jp-shadow-penumbra-color),
    0 1px 18px 0 var(--jp-shadow-ambient-color);
  --jp-elevation-z8: 0 5px 5px -3px var(--jp-shadow-umbra-color),
    0 8px 10px 1px var(--jp-shadow-penumbra-color),
    0 3px 14px 2px var(--jp-shadow-ambient-color);
  --jp-elevation-z12: 0 7px 8px -4px var(--jp-shadow-umbra-color),
    0 12px 17px 2px var(--jp-shadow-penumbra-color),
    0 5px 22px 4px var(--jp-shadow-ambient-color);
  --jp-elevation-z16: 0 8px 10px -5px var(--jp-shadow-umbra-color),
    0 16px 24px 2px var(--jp-shadow-penumbra-color),
    0 6px 30px 5px var(--jp-shadow-ambient-color);
  --jp-elevation-z20: 0 10px 13px -6px var(--jp-shadow-umbra-color),
    0 20px 31px 3px var(--jp-shadow-penumbra-color),
    0 8px 38px 7px var(--jp-shadow-ambient-color);
  --jp-elevation-z24: 0 11px 15px -7px var(--jp-shadow-umbra-color),
    0 24px 38px 3px var(--jp-shadow-penumbra-color),
    0 9px 46px 8px var(--jp-shadow-ambient-color);

  /* Borders
   *
   * The following variables, specify the visual styling of borders in JupyterLab.
   */

  --jp-border-width: 1px;
  --jp-border-color0: var(--md-grey-700);
  --jp-border-color1: var(--md-grey-700);
  --jp-border-color2: var(--md-grey-800);
  --jp-border-color3: var(--md-grey-900);
  --jp-inverse-border-color: var(--md-grey-600);
  --jp-border-radius: 2px;

  /* UI Fonts
   *
   * The UI font CSS variables are used for the typography all of the JupyterLab
   * user interface elements that are not directly user generated content.
   *
   * The font sizing here is done assuming that the body font size of --jp-ui-font-size1
   * is applied to a parent element. When children elements, such as headings, are sized
   * in em all things will be computed relative to that body size.
   */

  --jp-ui-font-scale-factor: 1.2;
  --jp-ui-font-size0: 0.83333em;
  --jp-ui-font-size1: 13px; /* Base font size */
  --jp-ui-font-size2: 1.2em;
  --jp-ui-font-size3: 1.44em;
  --jp-ui-font-family: system-ui, -apple-system, blinkmacsystemfont, 'Segoe UI',
    helvetica, arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji',
    'Segoe UI Symbol';

  /*
   * Use these font colors against the corresponding main layout colors.
   * In a light theme, these go from dark to light.
   */

  /* Defaults use Material Design specification */
  --jp-ui-font-color0: rgba(255, 255, 255, 1);
  --jp-ui-font-color1: rgba(255, 255, 255, 0.87);
  --jp-ui-font-color2: rgba(255, 255, 255, 0.54);
  --jp-ui-font-color3: rgba(255, 255, 255, 0.38);

  /*
   * Use these against the brand/accent/warn/error colors.
   * These will typically go from light to darker, in both a dark and light theme.
   */

  --jp-ui-inverse-font-color0: rgba(0, 0, 0, 1);
  --jp-ui-inverse-font-color1: rgba(0, 0, 0, 0.8);
  --jp-ui-inverse-font-color2: rgba(0, 0, 0, 0.5);
  --jp-ui-inverse-font-color3: rgba(0, 0, 0, 0.3);

  /* Content Fonts
   *
   * Content font variables are used for typography of user generated content.
   *
   * The font sizing here is done assuming that the body font size of --jp-content-font-size1
   * is applied to a parent element. When children elements, such as headings, are sized
   * in em all things will be computed relative to that body size.
   */

  --jp-content-line-height: 1.6;
  --jp-content-font-scale-factor: 1.2;
  --jp-content-font-size0: 0.83333em;
  --jp-content-font-size1: 14px; /* Base font size */
  --jp-content-font-size2: 1.2em;
  --jp-content-font-size3: 1.44em;
  --jp-content-font-size4: 1.728em;
  --jp-content-font-size5: 2.0736em;

  /* This gives a magnification of about 125% in presentation mode over normal. */
  --jp-content-presentation-font-size1: 17px;
  --jp-content-heading-line-height: 1;
  --jp-content-heading-margin-top: 1.2em;
  --jp-content-heading-margin-bottom: 0.8em;
  --jp-content-heading-font-weight: 500;

  /* Defaults use Material Design specification */
  --jp-content-font-color0: rgba(255, 255, 255, 1);
  --jp-content-font-color1: rgba(255, 255, 255, 1);
  --jp-content-font-color2: rgba(255, 255, 255, 0.7);
  --jp-content-font-color3: rgba(255, 255, 255, 0.5);
  --jp-content-link-color: var(--md-blue-300);
  --jp-content-font-family: system-ui, -apple-system, blinkmacsystemfont,
    'Segoe UI', helvetica, arial, sans-serif, 'Apple Color Emoji',
    'Segoe UI Emoji', 'Segoe UI Symbol';

  /*
   * Code Fonts
   *
   * Code font variables are used for typography of code and other monospaces content.
   */

  --jp-code-font-size: 13px;
  --jp-code-line-height: 1.3077; /* 17px for 13px base */
  --jp-code-padding: 5px; /* 5px for 13px base, codemirror highlighting needs integer px value */
  --jp-code-font-family-default: menlo, consolas, 'DejaVu Sans Mono', monospace;
  --jp-code-font-family: var(--jp-code-font-family-default);

  /* This gives a magnification of about 125% in presentation mode over normal. */
  --jp-code-presentation-font-size: 16px;

  /* may need to tweak cursor width if you change font size */
  --jp-code-cursor-width0: 1.4px;
  --jp-code-cursor-width1: 2px;
  --jp-code-cursor-width2: 4px;

  /* Layout
   *
   * The following are the main layout colors use in JupyterLab. In a light
   * theme these would go from light to dark.
   */

  --jp-layout-color0: #111;
  --jp-layout-color1: var(--md-grey-900);
  --jp-layout-color2: var(--md-grey-800);
  --jp-layout-color3: var(--md-grey-700);
  --jp-layout-color4: var(--md-grey-600);

  /* Inverse Layout
   *
   * The following are the inverse layout colors use in JupyterLab. In a light
   * theme these would go from dark to light.
   */

  --jp-inverse-layout-color0: white;
  --jp-inverse-layout-color1: white;
  --jp-inverse-layout-color2: var(--md-grey-200);
  --jp-inverse-layout-color3: var(--md-grey-400);
  --jp-inverse-layout-color4: var(--md-grey-600);

  /* Brand/accent */

  --jp-brand-color0: var(--md-blue-700);
  --jp-brand-color1: var(--md-blue-500);
  --jp-brand-color2: var(--md-blue-300);
  --jp-brand-color3: var(--md-blue-100);
  --jp-brand-color4: var(--md-blue-50);
  --jp-accent-color0: var(--md-green-700);
  --jp-accent-color1: var(--md-green-500);
  --jp-accent-color2: var(--md-green-300);
  --jp-accent-color3: var(--md-green-100);

  /* State colors (warn, error, success, info) */

  --jp-warn-color0: var(--md-orange-700);
  --jp-warn-color1: var(--md-orange-500);
  --jp-warn-color2: var(--md-orange-300);
  --jp-warn-color3: var(--md-orange-100);
  --jp-error-color0: var(--md-red-700);
  --jp-error-color1: var(--md-red-500);
  --jp-error-color2: var(--md-red-300);
  --jp-error-color3: var(--md-red-100);
  --jp-success-color0: var(--md-green-700);
  --jp-success-color1: var(--md-green-500);
  --jp-success-color2: var(--md-green-300);
  --jp-success-color3: var(--md-green-100);
  --jp-info-color0: var(--md-cyan-700);
  --jp-info-color1: var(--md-cyan-500);
  --jp-info-color2: var(--md-cyan-300);
  --jp-info-color3: var(--md-cyan-100);

  /* Cell specific styles */

  --jp-cell-padding: 5px;
  --jp-cell-collapser-width: 8px;
  --jp-cell-collapser-min-height: 20px;
  --jp-cell-collapser-not-active-hover-opacity: 0.6;
  --jp-cell-editor-background: var(--jp-layout-color1);
  --jp-cell-editor-border-color: var(--md-grey-700);
  --jp-cell-editor-box-shadow: inset 0 0 2px var(--md-blue-300);
  --jp-cell-editor-active-background: var(--jp-layout-color0);
  --jp-cell-editor-active-border-color: var(--jp-brand-color1);
  --jp-cell-prompt-width: 64px;
  --jp-cell-prompt-font-family: var(--jp-code-font-family-default);
  --jp-cell-prompt-letter-spacing: 0;
  --jp-cell-prompt-opacity: 1;
  --jp-cell-prompt-not-active-opacity: 1;
  --jp-cell-prompt-not-active-font-color: var(--md-grey-300);

  /* A custom blend of MD grey and blue 600
   * See https://meyerweb.com/eric/tools/color-blend/#546E7A:1E88E5:5:hex */
  --jp-cell-inprompt-font-color: #307fc1;

  /* A custom blend of MD grey and orange 600
   * https://meyerweb.com/eric/tools/color-blend/#546E7A:F4511E:5:hex */
  --jp-cell-outprompt-font-color: #bf5b3d;

  /* Notebook specific styles */

  --jp-notebook-padding: 10px;
  --jp-notebook-select-background: var(--jp-layout-color1);
  --jp-notebook-multiselected-color: rgba(33, 150, 243, 0.24);

  /* The scroll padding is calculated to fill enough space at the bottom of the
  notebook to show one single-line cell (with appropriate padding) at the top
  when the notebook is scrolled all the way to the bottom. We also subtract one
  pixel so that no scrollbar appears if we have just one single-line cell in the
  notebook. This padding is to enable a 'scroll past end' feature in a notebook.
  */
  --jp-notebook-scroll-padding: calc(
    100% - var(--jp-code-font-size) * var(--jp-code-line-height) -
      var(--jp-code-padding) - var(--jp-cell-padding) - 1px
  );

  /* Rendermime styles */

  --jp-rendermime-error-background: rgba(244, 67, 54, 0.28);
  --jp-rendermime-table-row-background: var(--md-grey-900);
  --jp-rendermime-table-row-hover-background: rgba(3, 169, 244, 0.2);

  /* Dialog specific styles */

  --jp-dialog-background: rgba(0, 0, 0, 0.6);

  /* Console specific styles */

  --jp-console-padding: 10px;

  /* Toolbar specific styles */

  --jp-toolbar-border-color: var(--jp-border-color2);
  --jp-toolbar-micro-height: 8px;
  --jp-toolbar-background: var(--jp-layout-color1);
  --jp-toolbar-box-shadow: 0 0 2px 0 rgba(0, 0, 0, 0.8);
  --jp-toolbar-header-margin: 4px 4px 0 4px;
  --jp-toolbar-active-background: var(--jp-layout-color0);

  /* Statusbar specific styles */

  --jp-statusbar-height: 24px;

  /* Input field styles */

  --jp-input-box-shadow: inset 0 0 2px var(--md-blue-300);
  --jp-input-active-background: var(--jp-layout-color0);
  --jp-input-hover-background: var(--jp-layout-color2);
  --jp-input-background: var(--md-grey-800);
  --jp-input-border-color: var(--jp-inverse-border-color);
  --jp-input-active-border-color: var(--jp-brand-color1);
  --jp-input-active-box-shadow-color: rgba(19, 124, 189, 0.3);

  /* General editor styles */

  --jp-editor-selected-background: var(--jp-layout-color2);
  --jp-editor-selected-focused-background: rgba(33, 150, 243, 0.24);
  --jp-editor-cursor-color: var(--jp-ui-font-color0);

  /* Code mirror specific styles */

  --jp-mirror-editor-keyword-color: var(--md-green-500);
  --jp-mirror-editor-atom-color: var(--md-blue-300);
  --jp-mirror-editor-number-color: var(--md-green-400);
  --jp-mirror-editor-def-color: var(--md-blue-600);
  --jp-mirror-editor-variable-color: var(--md-grey-300);
  --jp-mirror-editor-variable-2-color: var(--md-blue-500);
  --jp-mirror-editor-variable-3-color: var(--md-green-600);
  --jp-mirror-editor-punctuation-color: var(--md-blue-400);
  --jp-mirror-editor-property-color: var(--md-blue-400);
  --jp-mirror-editor-operator-color: #a2f;
  --jp-mirror-editor-comment-color: #408080;
  --jp-mirror-editor-string-color: #ff7070;
  --jp-mirror-editor-string-2-color: var(--md-purple-300);
  --jp-mirror-editor-meta-color: #a2f;
  --jp-mirror-editor-qualifier-color: #555;
  --jp-mirror-editor-builtin-color: var(--md-green-600);
  --jp-mirror-editor-bracket-color: #997;
  --jp-mirror-editor-tag-color: var(--md-green-700);
  --jp-mirror-editor-attribute-color: var(--md-blue-700);
  --jp-mirror-editor-header-color: var(--md-blue-500);
  --jp-mirror-editor-quote-color: var(--md-green-300);
  --jp-mirror-editor-link-color: var(--md-blue-700);
  --jp-mirror-editor-error-color: #f00;
  --jp-mirror-editor-hr-color: #999;

  /*
    RTC user specific colors.
    These colors are used for the cursor, username in the editor,
    and the icon of the user.
  */

  --jp-collaborator-color1: #ad4a00;
  --jp-collaborator-color2: #7b6a00;
  --jp-collaborator-color3: #007e00;
  --jp-collaborator-color4: #008772;
  --jp-collaborator-color5: #0079b9;
  --jp-collaborator-color6: #8b45c6;
  --jp-collaborator-color7: #be208b;

  /* Vega extension styles */

  --jp-vega-background: var(--md-grey-400);

  /* Sidebar-related styles */

  --jp-sidebar-min-width: 250px;

  /* Search-related styles */

  --jp-search-toggle-off-opacity: 0.6;
  --jp-search-toggle-hover-opacity: 0.8;
  --jp-search-toggle-on-opacity: 1;
  --jp-search-selected-match-background-color: rgb(255, 225, 0);
  --jp-search-selected-match-color: black;
  --jp-search-unselected-match-background-color: var(
    --jp-inverse-layout-color0
  );
  --jp-search-unselected-match-color: var(--jp-ui-inverse-font-color0);

  /* scrollbar related styles. Supports every browser except Edge. */

  /* colors based on JetBrain's Darcula theme */

  --jp-scrollbar-background-color: #3f4244;
  --jp-scrollbar-thumb-color: 88, 96, 97; /* need to specify thumb color as an RGB triplet */
  --jp-scrollbar-endpad: 3px; /* the minimum gap between the thumb and the ends of a scrollbar */

  /* hacks for setting the thumb shape. These do nothing in Firefox */

  --jp-scrollbar-thumb-margin: 3.5px; /* the space in between the sides of the thumb and the track */
  --jp-scrollbar-thumb-radius: 9px; /* set to a large-ish value for rounded endcaps on the thumb */

  /* Icon colors that work well with light or dark backgrounds */
  --jp-icon-contrast-color0: var(--md-purple-600);
  --jp-icon-contrast-color1: var(--md-green-600);
  --jp-icon-contrast-color2: var(--md-pink-600);
  --jp-icon-contrast-color3: var(--md-blue-600);

  /* Button colors */
  --jp-accept-color-normal: var(--md-blue-700);
  --jp-accept-color-hover: var(--md-blue-800);
  --jp-accept-color-active: var(--md-blue-900);
  --jp-warn-color-normal: var(--md-red-700);
  --jp-warn-color-hover: var(--md-red-800);
  --jp-warn-color-active: var(--md-red-900);
  --jp-reject-color-normal: var(--md-grey-600);
  --jp-reject-color-hover: var(--md-grey-700);
  --jp-reject-color-active: var(--md-grey-800);

  /* File or activity icons and switch semantic variables */
  --jp-jupyter-icon-color: #f37626;
  --jp-notebook-icon-color: #f37626;
  --jp-json-icon-color: var(--md-orange-500);
  --jp-console-icon-background-color: var(--md-blue-500);
  --jp-console-icon-color: white;
  --jp-terminal-icon-background-color: var(--md-grey-200);
  --jp-terminal-icon-color: var(--md-grey-800);
  --jp-text-editor-icon-color: var(--md-grey-200);
  --jp-inspector-icon-color: var(--md-grey-200);
  --jp-switch-color: var(--md-grey-400);
  --jp-switch-true-position-color: var(--md-orange-700);
}
</style>
<style type="text/css">
/* Force rendering true colors when outputing to pdf */
* {
  -webkit-print-color-adjust: exact;
}

/* Misc */
a.anchor-link {
  display: none;
}

/* Input area styling */
.jp-InputArea {
  overflow: hidden;
}

.jp-InputArea-editor {
  overflow: hidden;
}

.cm-editor.cm-s-jupyter .highlight pre {
/* weird, but --jp-code-padding defined to be 5px but 4px horizontal padding is hardcoded for pre.cm-line */
  padding: var(--jp-code-padding) 4px;
  margin: 0;

  font-family: inherit;
  font-size: inherit;
  line-height: inherit;
  color: inherit;

}

.jp-OutputArea-output pre {
  line-height: inherit;
  font-family: inherit;
}

.jp-RenderedText pre {
  color: var(--jp-content-font-color1);
  font-size: var(--jp-code-font-size);
}

/* Hiding the collapser by default */
.jp-Collapser {
  display: none;
}

@page {
    margin: 0.5in; /* Margin for each printed piece of paper */
}

@media print {
  .jp-Cell-inputWrapper,
  .jp-Cell-outputWrapper {
    display: block;
  }
}
</style>
<!-- Load mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS_CHTML-full,Safe"> </script>
<!-- MathJax configuration -->
<script type="text/x-mathjax-config">
    init_mathjax = function() {
        if (window.MathJax) {
        // MathJax loaded
            MathJax.Hub.Config({
                TeX: {
                    equationNumbers: {
                    autoNumber: "AMS",
                    useLabelIds: true
                    }
                },
                tex2jax: {
                    inlineMath: [ ['$','$'], ["\\(","\\)"] ],
                    displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
                    processEscapes: true,
                    processEnvironments: true
                },
                displayAlign: 'center',
                CommonHTML: {
                    linebreaks: {
                    automatic: true
                    }
                }
            });

            MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
        }
    }
    init_mathjax();
    </script>
<!-- End of mathjax configuration --><script type="module">
  document.addEventListener("DOMContentLoaded", async () => {
    const diagrams = document.querySelectorAll(".jp-Mermaid > pre.mermaid");
    // do not load mermaidjs if not needed
    if (!diagrams.length) {
      return;
    }
    const mermaid = (await import("https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.7.0/mermaid.esm.min.mjs")).default;
    const parser = new DOMParser();

    mermaid.initialize({
      maxTextSize: 100000,
      maxEdges: 100000,
      startOnLoad: false,
      fontFamily: window
        .getComputedStyle(document.body)
        .getPropertyValue("--jp-ui-font-family"),
      theme: document.querySelector("body[data-jp-theme-light='true']")
        ? "default"
        : "dark",
    });

    let _nextMermaidId = 0;

    function makeMermaidImage(svg) {
      const img = document.createElement("img");
      const doc = parser.parseFromString(svg, "image/svg+xml");
      const svgEl = doc.querySelector("svg");
      const { maxWidth } = svgEl?.style || {};
      const firstTitle = doc.querySelector("title");
      const firstDesc = doc.querySelector("desc");

      img.setAttribute("src", `data:image/svg+xml,${encodeURIComponent(svg)}`);
      if (maxWidth) {
        img.width = parseInt(maxWidth);
      }
      if (firstTitle) {
        img.setAttribute("alt", firstTitle.textContent);
      }
      if (firstDesc) {
        const caption = document.createElement("figcaption");
        caption.className = "sr-only";
        caption.textContent = firstDesc.textContent;
        return [img, caption];
      }
      return [img];
    }

    async function makeMermaidError(text) {
      let errorMessage = "";
      try {
        await mermaid.parse(text);
      } catch (err) {
        errorMessage = `${err}`;
      }

      const result = document.createElement("details");
      result.className = 'jp-RenderedMermaid-Details';
      const summary = document.createElement("summary");
      summary.className = 'jp-RenderedMermaid-Summary';
      const pre = document.createElement("pre");
      const code = document.createElement("code");
      code.innerText = text;
      pre.appendChild(code);
      summary.appendChild(pre);
      result.appendChild(summary);

      const warning = document.createElement("pre");
      warning.innerText = errorMessage;
      result.appendChild(warning);
      return [result];
    }

    async function renderOneMarmaid(src) {
      const id = `jp-mermaid-${_nextMermaidId++}`;
      const parent = src.parentNode;
      let raw = src.textContent.trim();
      const el = document.createElement("div");
      el.style.visibility = "hidden";
      document.body.appendChild(el);
      let results = null;
      let output = null;
      try {
        let { svg } = await mermaid.render(id, raw, el);
        svg = cleanMermaidSvg(svg);
        results = makeMermaidImage(svg);
        output = document.createElement("figure");
        results.map(output.appendChild, output);
      } catch (err) {
        parent.classList.add("jp-mod-warning");
        results = await makeMermaidError(raw);
        output = results[0];
      } finally {
        el.remove();
      }
      parent.classList.add("jp-RenderedMermaid");
      parent.appendChild(output);
    }


    /**
     * Post-process to ensure mermaid diagrams contain only valid SVG and XHTML.
     */
    function cleanMermaidSvg(svg) {
      return svg.replace(RE_VOID_ELEMENT, replaceVoidElement);
    }


    /**
     * A regular expression for all void elements, which may include attributes and
     * a slash.
     *
     * @see https://developer.mozilla.org/en-US/docs/Glossary/Void_element
     *
     * Of these, only `<br>` is generated by Mermaid in place of `\n`,
     * but _any_ "malformed" tag will break the SVG rendering entirely.
     */
    const RE_VOID_ELEMENT =
      /<\s*(area|base|br|col|embed|hr|img|input|link|meta|param|source|track|wbr)\s*([^>]*?)\s*>/gi;

    /**
     * Ensure a void element is closed with a slash, preserving any attributes.
     */
    function replaceVoidElement(match, tag, rest) {
      rest = rest.trim();
      if (!rest.endsWith('/')) {
        rest = `${rest} /`;
      }
      return `<${tag} ${rest}>`;
    }

    void Promise.all([...diagrams].map(renderOneMarmaid));
  });
</script>
<style>
  .jp-Mermaid:not(.jp-RenderedMermaid) {
    display: none;
  }

  .jp-RenderedMermaid {
    overflow: auto;
    display: flex;
  }

  .jp-RenderedMermaid.jp-mod-warning {
    width: auto;
    padding: 0.5em;
    margin-top: 0.5em;
    border: var(--jp-border-width) solid var(--jp-warn-color2);
    border-radius: var(--jp-border-radius);
    color: var(--jp-ui-font-color1);
    font-size: var(--jp-ui-font-size1);
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  .jp-RenderedMermaid figure {
    margin: 0;
    overflow: auto;
    max-width: 100%;
  }

  .jp-RenderedMermaid img {
    max-width: 100%;
  }

  .jp-RenderedMermaid-Details > pre {
    margin-top: 1em;
  }

  .jp-RenderedMermaid-Summary {
    color: var(--jp-warn-color2);
  }

  .jp-RenderedMermaid:not(.jp-mod-warning) pre {
    display: none;
  }

  .jp-RenderedMermaid-Summary > pre {
    display: inline-block;
    white-space: normal;
  }
</style>
<!-- End of mermaid configuration --></head>
<body class="jp-Notebook" data-jp-theme-light="false" data-jp-theme-name="JupyterLab Dark">
<main>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=1">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h1 id="spiral_compiler-(Polyglot)">spiral_compiler (Polyglot)<a class="anchor-link" href="#spiral_compiler-(Polyglot)"></a></h1>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=2">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="nb">open</span> <span class="n">rust</span><span class="o">.</span><span class="n">rust_operators</span>
<span class="nb">open</span> <span class="n">rust</span>
<span class="nb">open</span> <span class="n">sm</span><span class="s1">'_operators</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=3">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="spiral_compiler">spiral_compiler<a class="anchor-link" href="#spiral_compiler"></a></h2>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=4">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="get_args">get_args<a class="anchor-link" href="#get_args"></a></h3>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=5">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">inl</span> <span class="n">get_args</span> <span class="p">()</span> <span class="o">=</span>
    <span class="p">{</span>
        <span class="n">exception</span> <span class="o">=</span> <span class="s2">"exception"</span><span class="p">,</span> <span class="s1">'e'</span>
        <span class="n">trace_level</span> <span class="o">=</span> <span class="s2">"trace_level"</span><span class="p">,</span> <span class="s1">'t'</span>
        <span class="n">wasm</span> <span class="o">=</span> <span class="s2">"wasm"</span><span class="p">,</span> <span class="s1">'w'</span>
    <span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=6">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="nb">open</span> <span class="n">FSharp</span><span class="o">.</span><span class="n">Core</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=7">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="ch">#!import ../../../polyglot/lib/fsharp/Notebooks.dib</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=8">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="o">//</span> <span class="c1">#!import '../../../polyglot/deps/The-Spiral-Language/The Spiral Language 2/Supervisor.fs'</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=9">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="ch">#!import ../../../polyglot/lib/fsharp/Common.fs</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=10">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1">#r @"../../../../../../../.nuget/packages/fsharpx.collections/3.1.0/lib/netstandard2.0/FSharpx.Collections.dll"</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=11">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="o">//</span> <span class="c1">#if !INTERACTIVE</span>
<span class="o">//</span> <span class="nb">open</span> <span class="n">Polyglot</span>
<span class="nb">open</span> <span class="n">Common</span>
<span class="o">//</span> <span class="nb">open</span> <span class="n">Lib</span>
<span class="o">//</span> <span class="c1">#endif</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=12">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="PersistentVector">PersistentVector<a class="anchor-link" href="#PersistentVector"></a></h2>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=13">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="o">//</span> <span class="c1">#!import '../../../polyglot/deps/The-Spiral-Language/The Spiral Language 2/PersistentVectorExtensions.fs'</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=14">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="o">//</span> <span class="c1">#if !INTERACTIVE</span>
<span class="o">//</span>     <span class="nb">open</span> <span class="n">Polyglot</span>
<span class="o">//</span>     <span class="nb">open</span> <span class="n">Common</span>
<span class="o">//</span>     <span class="nb">open</span> <span class="n">Lib</span>
<span class="o">//</span> <span class="c1">#endif</span>
<span class="o">//</span> <span class="nb">open</span> <span class="n">System</span>
<span class="o">//</span> <span class="nb">open</span> <span class="n">FSharpx</span><span class="o">.</span><span class="n">Collections</span>

<span class="n">let</span> <span class="n">private</span> <span class="n">range_checks</span> <span class="kn">from</span> <span class="nn">near_to</span> <span class="n">vec</span> <span class="o">=</span>
    <span class="k">if</span> <span class="kn">from</span> <span class="o">&lt;=</span> <span class="n">near_to</span> <span class="o">=</span> <span class="n">false</span> <span class="n">then</span>
        <span class="n">Common</span><span class="o">.</span><span class="n">trace</span> <span class="n">Common</span><span class="o">.</span><span class="n">Critical</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"PersistentVectorExtensions.range_checks / `from` must be less or equal to `near_to`. / from: </span><span class="si">{from}</span><span class="s2"> / near_to: </span><span class="si">{near_to}</span><span class="s2"> / vec: </span><span class="si">{vec}</span><span class="s2">"</span><span class="p">)</span> <span class="n">Common</span><span class="o">.</span><span class="n">_locals</span>
        <span class="o">//</span> <span class="k">raise</span> <span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">ArgumentException</span><span class="p">(</span><span class="s2">"`from` must be less or equal to `near_to`."</span><span class="p">))</span>
    <span class="k">if</span> <span class="kn">from</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="n">then</span> <span class="k">raise</span> <span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">ArgumentException</span><span class="p">(</span><span class="s2">"`from` must not be negative."</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">FSharpx</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">PersistentVector</span><span class="o">.</span><span class="n">length</span> <span class="n">vec</span> <span class="o">&lt;</span> <span class="n">near_to</span> <span class="n">then</span> <span class="k">raise</span> <span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">ArgumentException</span><span class="p">(</span><span class="s2">"`near_to` must not be beyond the length of the vector."</span><span class="p">))</span>

<span class="o">///</span> <span class="n">O</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="n">m</span><span class="p">)</span><span class="o">.</span> <span class="n">Replace</span> <span class="n">the</span> <span class="n">specified</span> <span class="nb">range</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">vector</span> <span class="k">with</span> <span class="n">the</span> <span class="n">sequence</span><span class="o">.</span>
<span class="n">let</span> <span class="n">replace</span> <span class="kn">from</span> <span class="nn">near_to</span> <span class="n">seq</span> <span class="n">vec</span> <span class="o">=</span>
    <span class="n">range_checks</span> <span class="kn">from</span> <span class="nn">near_to</span> <span class="n">vec</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">rest</span> <span class="n">s</span> <span class="o">=</span>
        <span class="k">if</span> <span class="kn">from</span> <span class="o">&lt;</span> <span class="n">FSharpx</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">PersistentVector</span><span class="o">.</span><span class="n">length</span> <span class="n">s</span> <span class="n">then</span>
            <span class="n">FSharpx</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">PersistentVector</span><span class="o">.</span><span class="n">unconj</span> <span class="n">s</span> <span class="o">|&gt;</span> <span class="n">fst</span> <span class="o">|&gt;</span> <span class="n">rest</span>
        <span class="k">else</span>
            <span class="n">Seq</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">FSharpx</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">PersistentVector</span><span class="o">.</span><span class="n">conj</span> <span class="n">x</span> <span class="n">s</span><span class="p">)</span> <span class="n">s</span> <span class="n">seq</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">init</span> <span class="n">s</span> <span class="o">=</span>
        <span class="k">if</span> <span class="n">near_to</span> <span class="o">&lt;</span> <span class="n">FSharpx</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">PersistentVector</span><span class="o">.</span><span class="n">length</span> <span class="n">s</span> <span class="n">then</span>
            <span class="n">let</span> <span class="n">s</span><span class="s1">',x = FSharpx.Collections.PersistentVector.unconj s</span>
            <span class="n">FSharpx</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">PersistentVector</span><span class="o">.</span><span class="n">conj</span> <span class="n">x</span> <span class="p">(</span><span class="n">init</span> <span class="n">s</span><span class="s1">')</span>
        <span class="k">else</span>
            <span class="n">rest</span> <span class="n">s</span>
    <span class="n">init</span> <span class="n">vec</span>

<span class="o">///</span> <span class="n">O</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span> <span class="n">Returns</span> <span class="n">a</span> <span class="n">vector</span> <span class="n">of</span> <span class="n">the</span> <span class="n">supplied</span> <span class="n">length</span> <span class="n">using</span> <span class="n">the</span> <span class="n">supplied</span> <span class="n">function</span> <span class="n">operating</span> <span class="n">on</span> <span class="n">the</span> <span class="n">index</span><span class="o">.</span>
<span class="n">let</span> <span class="n">mapi</span> <span class="n">f</span> <span class="n">vec</span> <span class="o">=</span> <span class="n">FSharpx</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">PersistentVector</span><span class="o">.</span><span class="n">init</span> <span class="p">(</span><span class="n">FSharpx</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">PersistentVector</span><span class="o">.</span><span class="n">length</span> <span class="n">vec</span><span class="p">)</span> <span class="p">(</span><span class="n">fun</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">i</span> <span class="n">vec</span><span class="o">.</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

<span class="o">///</span> <span class="n">O</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span> <span class="n">Iterates</span> <span class="n">over</span> <span class="n">a</span> <span class="n">vector</span> <span class="n">using</span> <span class="n">the</span> <span class="n">supplied</span> <span class="n">function</span> <span class="n">operating</span> <span class="n">on</span> <span class="n">the</span> <span class="n">index</span><span class="o">.</span>
<span class="n">let</span> <span class="nb">iter</span> <span class="n">f</span> <span class="n">vec</span> <span class="o">=</span> 
    <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="n">i</span> <span class="o">=</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FSharpx</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">PersistentVector</span><span class="o">.</span><span class="n">length</span> <span class="n">vec</span> <span class="n">then</span> <span class="n">f</span> <span class="n">vec</span><span class="o">.</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">loop</span> <span class="mi">0</span>

<span class="o">///</span> <span class="n">O</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span> <span class="n">Unzips</span> <span class="n">a</span> <span class="n">vector</span> <span class="n">of</span> <span class="n">pairs</span> <span class="n">into</span> <span class="n">pairs</span> <span class="n">of</span> <span class="n">vectors</span><span class="o">.</span>
<span class="n">let</span> <span class="n">unzip</span> <span class="n">vec</span> <span class="o">=</span> 
    <span class="n">let</span> <span class="n">mutable</span> <span class="n">a</span> <span class="o">=</span> <span class="n">FSharpx</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">PersistentVector</span><span class="o">.</span><span class="n">empty</span>
    <span class="n">let</span> <span class="n">mutable</span> <span class="n">b</span> <span class="o">=</span> <span class="n">FSharpx</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">PersistentVector</span><span class="o">.</span><span class="n">empty</span>
    <span class="nb">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">a</span><span class="s1">',b'</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="o">&lt;-</span> <span class="n">FSharpx</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">PersistentVector</span><span class="o">.</span><span class="n">conj</span> <span class="n">a</span><span class="s1">' a; b &lt;- FSharpx.Collections.PersistentVector.conj b'</span> <span class="n">b</span><span class="p">)</span> <span class="n">vec</span>
    <span class="n">a</span><span class="p">,</span><span class="n">b</span>
        
<span class="o">///</span> <span class="n">O</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span> <span class="n">Concatenates</span> <span class="n">a</span> <span class="n">vector</span> <span class="n">of</span> <span class="n">vectors</span><span class="o">.</span>
<span class="n">let</span> <span class="n">concat</span> <span class="n">vec</span> <span class="o">=</span> <span class="n">FSharpx</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">PersistentVector</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">FSharpx</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">PersistentVector</span><span class="o">.</span><span class="n">append</span><span class="p">)</span> <span class="n">FSharpx</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">PersistentVector</span><span class="o">.</span><span class="n">empty</span> <span class="n">vec</span>

<span class="o">///</span> <span class="n">O</span><span class="p">(</span><span class="n">near_to</span><span class="o">-</span><span class="n">from</span><span class="p">)</span><span class="o">.</span> <span class="n">Get</span> <span class="n">the</span> <span class="n">vector</span> <span class="n">at</span> <span class="n">a</span> <span class="nb">range</span><span class="o">.</span>
<span class="n">let</span> <span class="n">rangePersistentVector</span> <span class="kn">from</span> <span class="nn">near_to</span> <span class="n">vec</span> <span class="o">=</span>
    <span class="n">range_checks</span> <span class="kn">from</span> <span class="nn">near_to</span> <span class="n">vec</span>
    <span class="n">FSharpx</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">PersistentVector</span><span class="o">.</span><span class="n">init</span> <span class="p">(</span><span class="n">near_to</span><span class="o">-</span><span class="n">from</span><span class="p">)</span> <span class="p">(</span><span class="n">fun</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">vec</span><span class="o">.</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">from</span><span class="p">])</span>

<span class="o">///</span> <span class="n">O</span><span class="p">(</span><span class="o">~</span><span class="n">n</span><span class="p">)</span><span class="o">.</span> <span class="n">Returns</span> <span class="n">the</span> <span class="n">last</span> <span class="n">element</span> <span class="k">for</span> <span class="n">which</span> <span class="n">a</span> <span class="n">given</span> <span class="n">function</span> <span class="n">returns</span> <span class="n">true</span><span class="o">.</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">such</span> <span class="n">an</span> <span class="n">element</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">exist</span><span class="o">.</span>
<span class="n">let</span> <span class="n">tryFindBack</span> <span class="n">f</span> <span class="n">vec</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="n">i</span> <span class="o">=</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="n">then</span> 
            <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">FSharpx</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">PersistentVector</span><span class="o">.</span><span class="n">nth</span> <span class="n">i</span> <span class="n">vec</span>
            <span class="k">if</span> <span class="n">f</span> <span class="n">x</span> <span class="n">then</span> <span class="n">Some</span> <span class="n">x</span> <span class="k">else</span> <span class="n">loop</span> <span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span>
            <span class="kc">None</span>
    <span class="n">loop</span> <span class="p">(</span><span class="n">FSharpx</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">PersistentVector</span><span class="o">.</span><span class="n">length</span> <span class="n">vec</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=15">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="HashConsing">HashConsing<a class="anchor-link" href="#HashConsing"></a></h2>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=16">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="o">//</span> <span class="n">Adapted</span> <span class="n">from</span><span class="p">:</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">backtracking</span><span class="o">/</span><span class="n">ocaml</span><span class="o">-</span><span class="n">hashcons</span>
<span class="o">//</span> <span class="n">Type</span><span class="o">-</span><span class="n">Safe</span> <span class="n">Modular</span> <span class="n">Hash</span><span class="o">-</span><span class="n">Consing</span><span class="p">:</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="o">.</span><span class="n">lri</span><span class="o">.</span><span class="n">fr</span><span class="o">/~</span><span class="n">filliatr</span><span class="o">/</span><span class="n">ftp</span><span class="o">/</span><span class="n">publis</span><span class="o">/</span><span class="nb">hash</span><span class="o">-</span><span class="n">consing2</span><span class="o">.</span><span class="n">pdf</span>

<span class="o">//</span> <span class="nb">open</span> <span class="n">System</span>
<span class="nb">open</span> <span class="n">System</span><span class="o">.</span><span class="n">Runtime</span><span class="o">.</span><span class="n">InteropServices</span>

<span class="p">[</span><span class="o">&lt;</span><span class="n">CustomComparison</span><span class="p">;</span><span class="n">CustomEquality</span><span class="p">;</span><span class="n">StructuredFormatDisplay</span><span class="p">(</span><span class="s2">"</span><span class="si">{AsString}</span><span class="s2">"</span><span class="p">)</span><span class="o">&gt;</span><span class="p">]</span>
<span class="nb">type</span> <span class="n">ConsedNode</span><span class="o">&lt;</span><span class="s1">'a&gt; =</span>
    <span class="p">{</span>
    <span class="n">node</span><span class="p">:</span> <span class="s1">'a</span>
    <span class="n">tag</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">hkey</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">}</span>

    <span class="n">override</span> <span class="n">x</span><span class="o">.</span><span class="n">ToString</span><span class="p">()</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">"&lt;tag </span><span class="si">%i</span><span class="s2">&gt;"</span> <span class="n">x</span><span class="o">.</span><span class="n">tag</span>
    <span class="n">member</span> <span class="n">x</span><span class="o">.</span><span class="n">AsString</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">ToString</span><span class="p">()</span>
    <span class="n">override</span> <span class="n">x</span><span class="o">.</span><span class="n">GetHashCode</span><span class="p">()</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">hkey</span>
    <span class="n">override</span> <span class="n">x</span><span class="o">.</span><span class="n">Equals</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">=</span> 
        <span class="k">match</span> <span class="n">y</span> <span class="k">with</span> 
        <span class="o">|</span> <span class="p">:</span><span class="err">?</span> <span class="n">ConsedNode</span><span class="o">&lt;</span><span class="s1">'a&gt; as y -&gt; x.tag = y.tag</span>
        <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">false</span>

    <span class="n">interface</span> <span class="n">System</span><span class="o">.</span><span class="n">IComparable</span> <span class="k">with</span>
        <span class="n">member</span> <span class="n">x</span><span class="o">.</span><span class="n">CompareTo</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">=</span> 
            <span class="k">match</span> <span class="n">y</span> <span class="k">with</span>
            <span class="o">|</span> <span class="p">:</span><span class="err">?</span> <span class="n">ConsedNode</span><span class="o">&lt;</span><span class="s1">'a&gt; as y -&gt; compare x.tag y.tag</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="k">raise</span> <span class="o">&lt;|</span> <span class="n">System</span><span class="o">.</span><span class="n">ArgumentException</span> <span class="s2">"Invalid comparison for HashConsed."</span>

<span class="nb">type</span> <span class="n">HashConsTable</span><span class="p">()</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">mutable</span> <span class="n">table</span><span class="p">:</span> <span class="n">ResizeArray</span><span class="o">&lt;</span><span class="n">GCHandle</span><span class="o">&gt;</span> <span class="p">[]</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">init</span> <span class="mi">7</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">ResizeArray</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">let</span> <span class="n">mutable</span> <span class="n">total_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">let</span> <span class="n">mutable</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">let</span> <span class="n">mutable</span> <span class="n">is_finalized</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">false</span>
    <span class="n">let</span> <span class="n">mutable</span> <span class="n">counter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">member</span> <span class="n">private</span> <span class="n">t</span><span class="o">.</span><span class="n">Resize</span><span class="p">()</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">next_table_length</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="mi">3</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mi">3</span>

        <span class="n">let</span> <span class="n">table_length</span><span class="s1">' = next_table_length table.Length</span>
        <span class="k">if</span> <span class="n">table_length</span><span class="s1">' &lt;= table.Length then failwith "The hash consing table cannot be grown anymore."</span>
        <span class="n">let</span> <span class="n">table</span><span class="s1">' = Array.init table_length'</span> <span class="p">(</span><span class="n">fun</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">ResizeArray</span><span class="p">())</span>
        <span class="n">let</span> <span class="n">limit</span><span class="s1">' = limit+2</span>
        <span class="n">let</span> <span class="n">total_size</span><span class="s1">' = </span>
            <span class="n">let</span> <span class="n">mutable</span> <span class="n">total_size</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span> <span class="n">to</span> <span class="n">table</span><span class="o">.</span><span class="n">Length</span><span class="o">-</span><span class="mi">1</span> <span class="n">do</span>
                <span class="n">let</span> <span class="n">table</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span> <span class="n">to</span> <span class="n">table</span><span class="o">.</span><span class="n">Count</span><span class="o">-</span><span class="mi">1</span> <span class="n">do</span>
                    <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">total_size</span> <span class="o">&lt;-</span>
                        <span class="k">match</span> <span class="n">x</span><span class="o">.</span><span class="n">Target</span> <span class="k">with</span>
                        <span class="o">|</span> <span class="n">null</span> <span class="o">-&gt;</span> 
                            <span class="n">x</span><span class="o">.</span><span class="n">Free</span><span class="p">()</span>
                            <span class="n">total_size</span>
                        <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> 
                            <span class="n">let</span> <span class="n">bucket</span> <span class="o">=</span> <span class="n">table</span><span class="s1">'.[(hash a &amp;&amp;&amp; System.Int32.MaxValue) % table_length'</span><span class="p">]</span>
                            <span class="n">bucket</span><span class="o">.</span><span class="n">Add</span> <span class="n">x</span>
                            <span class="n">total_size</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">total_size</span>
        <span class="n">table</span> <span class="o">&lt;-</span> <span class="n">table</span><span class="s1">'</span>
        <span class="n">limit</span> <span class="o">&lt;-</span> <span class="n">limit</span><span class="s1">'</span>
        <span class="n">total_size</span> <span class="o">&lt;-</span> <span class="n">total_size</span><span class="s1">'</span>

    <span class="n">member</span> <span class="n">t</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="s1">'a): ConsedNode&lt;'</span><span class="n">a</span><span class="o">&gt;</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">hkey</span> <span class="o">=</span> <span class="nb">hash</span> <span class="n">x</span>
        <span class="n">let</span> <span class="n">table</span> <span class="o">=</span> <span class="n">table</span>
        <span class="n">let</span> <span class="n">bucket</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="p">[(</span><span class="n">hkey</span> <span class="o">&amp;&amp;&amp;</span> <span class="n">System</span><span class="o">.</span><span class="n">Int32</span><span class="o">.</span><span class="n">MaxValue</span><span class="p">)</span> <span class="o">%</span> <span class="n">Array</span><span class="o">.</span><span class="n">length</span> <span class="n">table</span><span class="p">]</span>
        <span class="n">let</span> <span class="n">sz</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">Count</span>

        <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="n">empty_pos</span> <span class="n">i</span> <span class="o">=</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sz</span> <span class="n">then</span>
                <span class="k">match</span> <span class="n">bucket</span><span class="o">.</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">Target</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">null</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="n">i</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="o">|</span> <span class="p">:</span><span class="err">?</span> <span class="n">ConsedNode</span><span class="o">&lt;</span><span class="s1">'a&gt; as y when hkey = y.hkey &amp;&amp; x = y.node -&gt; y</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="n">empty_pos</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span>
                <span class="n">let</span> <span class="n">node</span> <span class="o">=</span> <span class="p">{</span><span class="n">node</span><span class="o">=</span><span class="n">x</span><span class="p">;</span> <span class="n">hkey</span><span class="o">=</span><span class="n">hkey</span><span class="p">;</span> <span class="n">tag</span><span class="o">=</span><span class="n">counter</span><span class="p">}</span>
                <span class="n">counter</span> <span class="o">&lt;-</span> <span class="n">counter</span><span class="o">+</span><span class="mi">1</span>
                <span class="k">if</span> <span class="n">empty_pos</span> <span class="o">&lt;&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="n">then</span>
                    <span class="n">let</span> <span class="n">mutable</span> <span class="n">m</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="p">[</span><span class="n">empty_pos</span><span class="p">]</span>
                    <span class="n">m</span><span class="o">.</span><span class="n">Target</span> <span class="o">&lt;-</span> <span class="n">node</span>
                <span class="k">else</span>
                    <span class="n">bucket</span><span class="o">.</span><span class="n">Add</span> <span class="p">(</span><span class="n">GCHandle</span><span class="o">.</span><span class="n">Alloc</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="n">GCHandleType</span><span class="o">.</span><span class="n">Weak</span><span class="p">))</span>
                    <span class="n">total_size</span> <span class="o">&lt;-</span> <span class="n">total_size</span><span class="o">+</span><span class="mi">1</span>
                    <span class="k">if</span> <span class="n">total_size</span> <span class="o">&gt;</span> <span class="n">limit</span> <span class="o">*</span> <span class="n">Array</span><span class="o">.</span><span class="n">length</span> <span class="n">table</span> <span class="n">then</span> <span class="n">t</span><span class="o">.</span><span class="n">Resize</span><span class="p">()</span>
                <span class="n">node</span>

        <span class="n">loop</span> <span class="o">-</span><span class="mi">1</span> <span class="mi">0</span> <span class="o">//</span> <span class="err">`</span><span class="o">-</span><span class="mi">1</span><span class="err">`</span> <span class="n">indicates</span> <span class="n">the</span> <span class="n">state</span> <span class="n">of</span> <span class="n">no</span> <span class="n">empty</span> <span class="n">bucket</span>

    <span class="n">override</span> <span class="n">__</span><span class="o">.</span><span class="n">Finalize</span><span class="p">()</span> <span class="o">=</span>
        <span class="k">if</span> <span class="n">is_finalized</span> <span class="o">=</span> <span class="n">false</span> <span class="n">then</span>
            <span class="n">table</span> <span class="o">|&gt;</span> <span class="p">(</span><span class="n">Array</span><span class="o">.</span><span class="n">iter</span> <span class="o">&lt;&lt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">iter</span><span class="p">)</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">.</span><span class="n">Free</span><span class="p">())</span>
            <span class="n">is_finalized</span> <span class="o">&lt;-</span> <span class="n">true</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=17">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1">#r @"../../../../../../../.nuget/packages/argu/6.2.4/lib/netstandard2.0/Argu.dll"</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=18">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="Startup">Startup<a class="anchor-link" href="#Startup"></a></h2>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=19">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="nb">open</span> <span class="n">Argu</span>

<span class="nb">type</span> <span class="n">PrimitiveType</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">UInt8T</span> <span class="o">|</span> <span class="n">UInt16T</span> <span class="o">|</span> <span class="n">UInt32T</span> <span class="o">|</span> <span class="n">UInt64T</span>
    <span class="o">|</span> <span class="n">Int8T</span> <span class="o">|</span> <span class="n">Int16T</span> <span class="o">|</span> <span class="n">Int32T</span> <span class="o">|</span> <span class="n">Int64T</span>
    <span class="o">|</span> <span class="n">Float32T</span> <span class="o">|</span> <span class="n">Float64T</span>
    <span class="o">|</span> <span class="n">BoolT</span> <span class="o">|</span> <span class="n">StringT</span> <span class="o">|</span> <span class="n">CharT</span>

<span class="nb">type</span> <span class="n">DefaultEnv</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">port</span> <span class="p">:</span> <span class="nb">int</span>
    <span class="n">default_int</span> <span class="p">:</span> <span class="n">PrimitiveType</span>
    <span class="n">default_uint</span> <span class="p">:</span> <span class="n">PrimitiveType</span>
    <span class="n">default_float</span> <span class="p">:</span> <span class="n">PrimitiveType</span>
    <span class="p">}</span>

<span class="nb">type</span> <span class="n">CliArguments</span> <span class="o">=</span>
    <span class="o">|</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">Mandatory</span><span class="p">;</span><span class="n">Unique</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">Port</span> <span class="n">of</span> <span class="nb">int</span>
    <span class="o">|</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">Unique</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">Default_Int</span> <span class="n">of</span> <span class="n">string</span>
    <span class="o">|</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">Unique</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">Default_Float</span> <span class="n">of</span> <span class="n">string</span>

    <span class="n">interface</span> <span class="n">IArgParserTemplate</span> <span class="k">with</span>
        <span class="n">member</span> <span class="n">s</span><span class="o">.</span><span class="n">Usage</span> <span class="o">=</span>
            <span class="k">match</span> <span class="n">s</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">Port</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="s2">"specify a primary port."</span>
            <span class="o">|</span> <span class="n">Default_Int</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="s2">"specify the default int: i8, i16, i32, i64, u8, u16, u32, u64"</span>
            <span class="o">|</span> <span class="n">Default_Float</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="s2">"specify the default float: f32, f64"</span>

<span class="n">let</span> <span class="n">parseStartup</span> <span class="n">args</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">parser</span> <span class="o">=</span> <span class="n">ArgumentParser</span><span class="o">.</span><span class="n">Create</span><span class="o">&lt;</span><span class="n">CliArguments</span><span class="o">&gt;</span><span class="p">(</span><span class="n">programName</span> <span class="o">=</span> <span class="s2">"spiral.exe"</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">results</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">ParseCommandLine</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">let</span> <span class="nb">int</span> <span class="o">=</span> 
        <span class="k">match</span> <span class="n">results</span><span class="o">.</span><span class="n">GetResult</span><span class="p">(</span><span class="n">Default_Int</span><span class="p">,</span><span class="s2">"i32"</span><span class="p">)</span> <span class="k">with</span>
        <span class="o">|</span> <span class="s2">"i8"</span> <span class="o">-&gt;</span> <span class="n">Int8T</span>
        <span class="o">|</span> <span class="s2">"i16"</span> <span class="o">-&gt;</span> <span class="n">Int16T</span>
        <span class="o">|</span> <span class="s2">"i32"</span> <span class="o">-&gt;</span> <span class="n">Int32T</span>
        <span class="o">|</span> <span class="s2">"i64"</span> <span class="o">-&gt;</span> <span class="n">Int64T</span>
        <span class="o">|</span> <span class="s2">"u8"</span> <span class="o">-&gt;</span> <span class="n">UInt8T</span>
        <span class="o">|</span> <span class="s2">"u16"</span> <span class="o">-&gt;</span> <span class="n">UInt16T</span>
        <span class="o">|</span> <span class="s2">"u32"</span> <span class="o">-&gt;</span> <span class="n">UInt32T</span>
        <span class="o">|</span> <span class="s2">"u64"</span> <span class="o">-&gt;</span> <span class="n">UInt64T</span>
        <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="err">$</span><span class="s2">"Invalid default int.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s{x}</span><span class="se">\n</span><span class="s2">Expected one of: i8, i16, i32, i64, u8, u16, u32, u64"</span>

    <span class="n">let</span> <span class="n">uint</span> <span class="o">=</span>
        <span class="k">match</span> <span class="nb">int</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">Int8T</span> <span class="o">-&gt;</span> <span class="n">UInt8T</span>
        <span class="o">|</span> <span class="n">Int16T</span> <span class="o">-&gt;</span> <span class="n">UInt16T</span>
        <span class="o">|</span> <span class="n">Int32T</span> <span class="o">-&gt;</span> <span class="n">UInt32T</span>
        <span class="o">|</span> <span class="n">Int64T</span> <span class="o">-&gt;</span> <span class="n">UInt64T</span>
        <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="o">//</span> <span class="n">If</span> <span class="n">the</span> <span class="nb">int</span> <span class="ow">is</span> <span class="n">unsigned</span> <span class="n">then</span> <span class="n">make</span> <span class="n">them</span> <span class="n">the</span> <span class="n">same</span> <span class="nb">type</span><span class="o">.</span>
    <span class="p">{</span>
    <span class="n">port</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">GetResult</span><span class="p">(</span><span class="n">Port</span><span class="p">)</span>
    <span class="n">default_int</span> <span class="o">=</span> <span class="nb">int</span>
    <span class="n">default_uint</span> <span class="o">=</span> <span class="n">uint</span>
    <span class="n">default_float</span> <span class="o">=</span> 
        <span class="k">match</span> <span class="n">results</span><span class="o">.</span><span class="n">GetResult</span><span class="p">(</span><span class="n">Default_Float</span><span class="p">,</span><span class="s2">"f64"</span><span class="p">)</span> <span class="k">with</span>
        <span class="o">|</span> <span class="s2">"f32"</span> <span class="o">-&gt;</span> <span class="n">Float32T</span>
        <span class="o">|</span> <span class="s2">"f64"</span> <span class="o">-&gt;</span> <span class="n">Float64T</span>
        <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="err">$</span><span class="s2">"Invalid default float.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s{x}</span><span class="se">\n</span><span class="s2">Expected one of: f32, f64"</span>
    <span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=20">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="Utils">Utils<a class="anchor-link" href="#Utils"></a></h2>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=21">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="nb">open</span> <span class="n">System</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">Generic</span>
<span class="nb">open</span> <span class="n">System</span><span class="o">.</span><span class="n">Runtime</span><span class="o">.</span><span class="n">CompilerServices</span>
<span class="o">//</span> <span class="nb">open</span> <span class="n">Common</span>
<span class="c1">#if !INTERACTIVE</span>
<span class="nb">open</span> <span class="n">Lib</span>
<span class="c1">#endif</span>

<span class="n">let</span> <span class="n">list_try_zip</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="k">try</span> <span class="n">Some</span> <span class="p">(</span><span class="n">List</span><span class="o">.</span><span class="n">zip</span> <span class="n">a</span> <span class="n">b</span><span class="p">)</span> <span class="k">with</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="kc">None</span>

<span class="n">let</span> <span class="n">inline</span> <span class="n">get_default</span> <span class="p">(</span><span class="n">memo_dict</span><span class="p">:</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="o">&gt;</span><span class="p">)</span> <span class="n">k</span> <span class="k">def</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">memo_dict</span><span class="o">.</span><span class="n">TryGetValue</span> <span class="n">k</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">true</span><span class="p">,</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">v</span>
    <span class="o">|</span> <span class="n">false</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">def</span><span class="p">()</span>
<span class="n">let</span> <span class="n">inline</span> <span class="n">memoize</span><span class="s1">' (memo_dict: ConditionalWeakTable&lt;_,_&gt;) f k =</span>
    <span class="k">match</span> <span class="n">memo_dict</span><span class="o">.</span><span class="n">TryGetValue</span> <span class="n">k</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">true</span><span class="p">,</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">v</span>
    <span class="o">|</span> <span class="n">false</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">v</span> <span class="o">=</span> <span class="n">f</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">memo_dict</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">);</span> <span class="n">v</span>
<span class="n">let</span> <span class="n">inline</span> <span class="n">memoize</span> <span class="p">(</span><span class="n">memo_dict</span><span class="p">:</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="o">&gt;</span><span class="p">)</span> <span class="n">f</span> <span class="n">k</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">memo_dict</span><span class="o">.</span><span class="n">TryGetValue</span> <span class="n">k</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">true</span><span class="p">,</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">v</span>
    <span class="o">|</span> <span class="n">false</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">v</span> <span class="o">=</span> <span class="n">f</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">memo_dict</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">);</span> <span class="n">v</span>
<span class="n">let</span> <span class="n">lines</span> <span class="p">(</span><span class="nb">str</span> <span class="p">:</span> <span class="n">string</span><span class="p">)</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">Split</span><span class="p">([</span><span class="o">|</span><span class="s2">"</span><span class="se">\r\n</span><span class="s2">"</span><span class="p">;</span><span class="s2">"</span><span class="se">\r</span><span class="s2">"</span><span class="p">;</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="o">|</span><span class="p">],</span><span class="n">System</span><span class="o">.</span><span class="n">StringSplitOptions</span><span class="o">.</span><span class="kc">None</span><span class="p">)</span>
<span class="n">let</span> <span class="n">inline</span> <span class="n">remove</span> <span class="p">(</span><span class="nb">dict</span> <span class="p">:</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="o">&gt;</span><span class="p">)</span> <span class="n">x</span> <span class="n">on_succ</span> <span class="n">on_fail</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">mutable</span> <span class="n">q</span> <span class="o">=</span> <span class="n">Unchecked</span><span class="o">.</span><span class="n">defaultof</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;</span>
    <span class="k">if</span> <span class="nb">dict</span><span class="o">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q</span><span class="p">)</span> <span class="n">then</span> <span class="n">on_succ</span> <span class="n">q</span> <span class="k">else</span> <span class="n">on_fail</span> <span class="p">()</span>
<span class="n">let</span> <span class="n">file_uri</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">string</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">result</span> <span class="o">=</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">SpiralFileSystem</span><span class="o">.</span><span class="n">standardize_path</span> <span class="o">|&gt;</span> <span class="n">SpiralFileSystem</span><span class="o">.</span><span class="n">new_file_uri</span>
    <span class="n">trace</span> <span class="n">Verbose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"Utils.file_uri / x: </span><span class="si">{x}</span><span class="s2"> / result: </span><span class="si">{result}</span><span class="s2">"</span><span class="p">)</span> <span class="n">_locals</span>
    <span class="n">result</span>

<span class="o">//</span><span class="nb">open</span> <span class="n">Hopac</span>
<span class="o">//</span><span class="nb">open</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">Infixes</span>
<span class="o">//</span><span class="nb">open</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">Extensions</span>
<span class="o">//</span><span class="nb">open</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">Stream</span>

<span class="o">//</span><span class="n">let</span> <span class="n">print_ch</span> <span class="o">=</span> <span class="n">Ch</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span><span class="p">()</span>
<span class="o">//</span><span class="n">let</span> <span class="n">pr</span> <span class="n">x</span> <span class="o">=</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">run</span> <span class="p">(</span><span class="n">Ch</span><span class="o">.</span><span class="n">send</span> <span class="n">print_ch</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">ToString</span><span class="p">()))</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=22">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="ParserCombinators">ParserCombinators<a class="anchor-link" href="#ParserCombinators"></a></h2>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=23">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">let</span> <span class="n">inline</span> <span class="n">index</span> <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="o">^</span><span class="n">a</span> <span class="p">:</span> <span class="p">(</span><span class="n">member</span> <span class="n">Index</span><span class="p">:</span> <span class="o">^</span><span class="n">b</span><span class="p">)</span> <span class="n">d</span><span class="p">)</span>
<span class="n">let</span> <span class="n">inline</span> <span class="n">index_set</span> <span class="n">i</span> <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="o">^</span><span class="n">a</span> <span class="p">:</span> <span class="p">(</span><span class="n">member</span> <span class="n">set_Index</span><span class="p">:</span> <span class="o">^</span><span class="n">b</span> <span class="o">-&gt;</span> <span class="n">unit</span><span class="p">)</span> <span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">i</span><span class="p">))</span>

<span class="n">let</span> <span class="n">inline</span> <span class="p">(</span><span class="o">.&gt;&gt;.</span><span class="p">)</span> <span class="n">a</span> <span class="n">b</span> <span class="n">d</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">a</span> <span class="n">d</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">Ok</span> <span class="n">a</span> <span class="o">-&gt;</span>
        <span class="k">match</span> <span class="n">b</span> <span class="n">d</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">Ok</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">Ok</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>   

<span class="n">let</span> <span class="n">inline</span> <span class="n">tuple3</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="n">d</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">a</span> <span class="n">d</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">Ok</span> <span class="n">a</span> <span class="o">-&gt;</span>
        <span class="k">match</span> <span class="n">b</span> <span class="n">d</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">Ok</span> <span class="n">b</span> <span class="o">-&gt;</span> 
            <span class="k">match</span> <span class="n">c</span> <span class="n">d</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">Ok</span> <span class="n">c</span> <span class="o">-&gt;</span> <span class="n">Ok</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>  

<span class="n">let</span> <span class="n">inline</span> <span class="n">tuple4</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="n">d</span><span class="s1">' d =</span>
    <span class="k">match</span> <span class="n">a</span> <span class="n">d</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">Ok</span> <span class="n">a</span> <span class="o">-&gt;</span>
        <span class="k">match</span> <span class="n">b</span> <span class="n">d</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">Ok</span> <span class="n">b</span> <span class="o">-&gt;</span> 
            <span class="k">match</span> <span class="n">c</span> <span class="n">d</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">Ok</span> <span class="n">c</span> <span class="o">-&gt;</span> 
                <span class="k">match</span> <span class="n">d</span><span class="s1">' d with</span>
                <span class="o">|</span> <span class="n">Ok</span> <span class="n">d</span><span class="s1">' -&gt; Ok (a, b, c, d'</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>
            <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>  

<span class="n">let</span> <span class="n">inline</span> <span class="n">tuple5</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="n">d</span><span class="s1">' e d =</span>
    <span class="k">match</span> <span class="n">a</span> <span class="n">d</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">Ok</span> <span class="n">a</span> <span class="o">-&gt;</span>
        <span class="k">match</span> <span class="n">b</span> <span class="n">d</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">Ok</span> <span class="n">b</span> <span class="o">-&gt;</span> 
            <span class="k">match</span> <span class="n">c</span> <span class="n">d</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">Ok</span> <span class="n">c</span> <span class="o">-&gt;</span> 
                <span class="k">match</span> <span class="n">d</span><span class="s1">' d with</span>
                <span class="o">|</span> <span class="n">Ok</span> <span class="n">d</span><span class="s1">' -&gt; </span>
                    <span class="k">match</span> <span class="n">e</span> <span class="n">d</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">Ok</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">Ok</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="s1">', e)</span>
                    <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>
                <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>
            <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>  

<span class="n">let</span> <span class="n">inline</span> <span class="n">tuple6</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="n">d</span><span class="s1">' e f d =</span>
    <span class="k">match</span> <span class="n">a</span> <span class="n">d</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">Ok</span> <span class="n">a</span> <span class="o">-&gt;</span>
        <span class="k">match</span> <span class="n">b</span> <span class="n">d</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">Ok</span> <span class="n">b</span> <span class="o">-&gt;</span> 
            <span class="k">match</span> <span class="n">c</span> <span class="n">d</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">Ok</span> <span class="n">c</span> <span class="o">-&gt;</span> 
                <span class="k">match</span> <span class="n">d</span><span class="s1">' d with</span>
                <span class="o">|</span> <span class="n">Ok</span> <span class="n">d</span><span class="s1">' -&gt; </span>
                    <span class="k">match</span> <span class="n">e</span> <span class="n">d</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">Ok</span> <span class="n">e</span> <span class="o">-&gt;</span> 
                        <span class="k">match</span> <span class="n">f</span> <span class="n">d</span> <span class="k">with</span>
                        <span class="o">|</span> <span class="n">Ok</span> <span class="n">f</span> <span class="o">-&gt;</span> <span class="n">Ok</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="s1">', e, f)</span>
                        <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>
                    <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>
                <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>
            <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span> 

<span class="n">let</span> <span class="n">inline</span> <span class="n">tuple7</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="n">d</span><span class="s1">' e f g d =</span>
    <span class="k">match</span> <span class="n">a</span> <span class="n">d</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">Ok</span> <span class="n">a</span> <span class="o">-&gt;</span>
        <span class="k">match</span> <span class="n">b</span> <span class="n">d</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">Ok</span> <span class="n">b</span> <span class="o">-&gt;</span> 
            <span class="k">match</span> <span class="n">c</span> <span class="n">d</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">Ok</span> <span class="n">c</span> <span class="o">-&gt;</span> 
                <span class="k">match</span> <span class="n">d</span><span class="s1">' d with</span>
                <span class="o">|</span> <span class="n">Ok</span> <span class="n">d</span><span class="s1">' -&gt; </span>
                    <span class="k">match</span> <span class="n">e</span> <span class="n">d</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">Ok</span> <span class="n">e</span> <span class="o">-&gt;</span> 
                        <span class="k">match</span> <span class="n">f</span> <span class="n">d</span> <span class="k">with</span>
                        <span class="o">|</span> <span class="n">Ok</span> <span class="n">f</span> <span class="o">-&gt;</span>
                            <span class="k">match</span> <span class="n">g</span> <span class="n">d</span> <span class="k">with</span>
                            <span class="o">|</span> <span class="n">Ok</span> <span class="n">g</span> <span class="o">-&gt;</span> <span class="n">Ok</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="s1">', e, f, g)</span>
                            <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>
                        <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>
                    <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>
                <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>
            <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>  

<span class="n">let</span> <span class="n">inline</span> <span class="n">pipe2</span> <span class="n">a</span> <span class="n">b</span> <span class="n">f</span> <span class="n">d</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">a</span> <span class="n">d</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">Ok</span> <span class="n">a</span> <span class="o">-&gt;</span>
        <span class="k">match</span> <span class="n">b</span> <span class="n">d</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">Ok</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">Ok</span> <span class="p">(</span><span class="n">f</span> <span class="n">a</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>  

<span class="n">let</span> <span class="n">inline</span> <span class="n">pipe3</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="n">f</span> <span class="n">d</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">a</span> <span class="n">d</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">Ok</span> <span class="n">a</span> <span class="o">-&gt;</span>
        <span class="k">match</span> <span class="n">b</span> <span class="n">d</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">Ok</span> <span class="n">b</span> <span class="o">-&gt;</span> 
            <span class="k">match</span> <span class="n">c</span> <span class="n">d</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">Ok</span> <span class="n">c</span> <span class="o">-&gt;</span> <span class="n">Ok</span> <span class="p">(</span><span class="n">f</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>  

<span class="n">let</span> <span class="n">inline</span> <span class="n">pipe4</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="n">d</span><span class="s1">' f d =</span>
    <span class="k">match</span> <span class="n">a</span> <span class="n">d</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">Ok</span> <span class="n">a</span> <span class="o">-&gt;</span>
        <span class="k">match</span> <span class="n">b</span> <span class="n">d</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">Ok</span> <span class="n">b</span> <span class="o">-&gt;</span> 
            <span class="k">match</span> <span class="n">c</span> <span class="n">d</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">Ok</span> <span class="n">c</span> <span class="o">-&gt;</span> 
                <span class="k">match</span> <span class="n">d</span><span class="s1">' d with</span>
                <span class="o">|</span> <span class="n">Ok</span> <span class="n">d</span><span class="s1">' -&gt; Ok (f a b c d'</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>
            <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>  

<span class="n">let</span> <span class="n">inline</span> <span class="n">pipe5</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="n">d</span><span class="s1">' e f d =</span>
    <span class="k">match</span> <span class="n">a</span> <span class="n">d</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">Ok</span> <span class="n">a</span> <span class="o">-&gt;</span>
        <span class="k">match</span> <span class="n">b</span> <span class="n">d</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">Ok</span> <span class="n">b</span> <span class="o">-&gt;</span> 
            <span class="k">match</span> <span class="n">c</span> <span class="n">d</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">Ok</span> <span class="n">c</span> <span class="o">-&gt;</span> 
                <span class="k">match</span> <span class="n">d</span><span class="s1">' d with</span>
                <span class="o">|</span> <span class="n">Ok</span> <span class="n">d</span><span class="s1">' -&gt; </span>
                    <span class="k">match</span> <span class="n">e</span> <span class="n">d</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">Ok</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">Ok</span> <span class="p">(</span><span class="n">f</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="n">d</span><span class="s1">' e)</span>
                    <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>
                <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>
            <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>  

<span class="n">let</span> <span class="n">inline</span> <span class="p">(</span><span class="o">.&gt;&gt;</span><span class="p">)</span> <span class="n">a</span> <span class="n">b</span> <span class="n">d</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">a</span> <span class="n">d</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">Ok</span> <span class="n">a</span> <span class="o">-&gt;</span>
        <span class="k">match</span> <span class="n">b</span> <span class="n">d</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">Ok</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">Ok</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>   

<span class="n">let</span> <span class="n">inline</span> <span class="p">(</span><span class="o">&gt;&gt;.</span><span class="p">)</span> <span class="n">a</span> <span class="n">b</span> <span class="n">d</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">a</span> <span class="n">d</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">Ok</span> <span class="n">a</span> <span class="o">-&gt;</span>
        <span class="k">match</span> <span class="n">b</span> <span class="n">d</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">Ok</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">Ok</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>   

<span class="n">let</span> <span class="n">inline</span> <span class="n">opt</span> <span class="n">a</span> <span class="n">d</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">index</span> <span class="n">d</span>
    <span class="k">match</span> <span class="n">a</span> <span class="n">d</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">Ok</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">Ok</span><span class="p">(</span><span class="n">Some</span> <span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> 
        <span class="k">if</span> <span class="n">s</span> <span class="o">=</span> <span class="n">index</span> <span class="n">d</span> <span class="n">then</span> <span class="n">Ok</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span> <span class="n">Error</span> <span class="n">x</span>

<span class="n">let</span> <span class="n">inline</span> <span class="n">optional</span> <span class="n">a</span> <span class="n">d</span> <span class="o">=</span> 
    <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">index</span> <span class="n">d</span>
    <span class="k">match</span> <span class="n">a</span> <span class="n">d</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">Ok</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">Ok</span><span class="p">()</span>
    <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> 
        <span class="k">if</span> <span class="n">s</span> <span class="o">=</span> <span class="n">index</span> <span class="n">d</span> <span class="n">then</span> <span class="n">Ok</span><span class="p">()</span>
        <span class="k">else</span> <span class="n">Error</span> <span class="n">x</span>

<span class="n">let</span> <span class="n">inline</span> <span class="p">(</span><span class="o">|&gt;&gt;</span><span class="p">)</span> <span class="n">a</span> <span class="n">b</span> <span class="n">d</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">a</span> <span class="n">d</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">Ok</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">Ok</span><span class="p">(</span><span class="n">b</span> <span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>

<span class="n">let</span> <span class="n">inline</span> <span class="p">(</span><span class="o">&gt;&gt;%</span><span class="p">)</span> <span class="n">a</span> <span class="n">b</span> <span class="n">d</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">a</span> <span class="n">d</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">Ok</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">Ok</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>
        
<span class="n">let</span> <span class="n">inline</span> <span class="p">(</span><span class="o">&gt;&gt;=</span><span class="p">)</span> <span class="n">a</span> <span class="n">b</span> <span class="n">d</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">a</span> <span class="n">d</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">Ok</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">b</span> <span class="n">a</span> <span class="n">d</span>
    <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>

<span class="n">let</span> <span class="n">inline</span> <span class="p">(</span><span class="o">&gt;&gt;=</span><span class="err">?</span><span class="p">)</span> <span class="n">a</span> <span class="n">b</span> <span class="n">d</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">i</span> <span class="o">=</span> <span class="n">index</span> <span class="n">d</span>
    <span class="k">match</span> <span class="n">a</span> <span class="n">d</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">Ok</span> <span class="n">a</span> <span class="o">-&gt;</span> 
        <span class="n">let</span> <span class="n">i</span><span class="s1">' = index d</span>
        <span class="k">match</span> <span class="n">b</span> <span class="n">a</span> <span class="n">d</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">Ok</span> <span class="n">_</span> <span class="k">as</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">Error</span> <span class="n">_</span> <span class="k">as</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="k">if</span> <span class="n">i</span><span class="s1">' = index d then index_set i d); x // Backtracks to the beginning if the parser state has not changed.</span>
    <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>

<span class="n">let</span> <span class="n">inline</span> <span class="n">many_iter</span> <span class="n">f</span> <span class="n">a</span> <span class="n">d</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="p">()</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">index</span> <span class="n">d</span>
        <span class="k">match</span> <span class="n">a</span> <span class="n">d</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">Ok</span> <span class="n">_</span> <span class="n">when</span> <span class="n">s</span> <span class="o">=</span> <span class="n">index</span> <span class="n">d</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"The parser succeeded without changing the parser index in `many`. Had an exception not been raised the parser would have diverged."</span>
        <span class="o">|</span> <span class="n">Ok</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">x</span><span class="p">;</span> <span class="n">loop</span><span class="p">()</span>
        <span class="o">|</span> <span class="n">Error</span> <span class="n">er</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">s</span> <span class="o">=</span> <span class="n">index</span> <span class="n">d</span> <span class="n">then</span> <span class="n">Ok</span><span class="p">()</span> <span class="k">else</span> <span class="n">Error</span> <span class="n">er</span>
    <span class="n">loop</span> <span class="p">()</span>

<span class="n">let</span> <span class="n">inline</span> <span class="n">many_resize_array</span> <span class="n">a</span> <span class="n">d</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">ar</span> <span class="o">=</span> <span class="n">ResizeArray</span><span class="p">()</span>
    <span class="k">match</span> <span class="n">many_iter</span> <span class="n">ar</span><span class="o">.</span><span class="n">Add</span> <span class="n">a</span> <span class="n">d</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">Ok</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Ok</span><span class="p">(</span><span class="n">ar</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">Error</span> <span class="n">er</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">er</span>
<span class="n">let</span> <span class="n">inline</span> <span class="n">many_array</span> <span class="n">a</span> <span class="n">d</span> <span class="o">=</span> <span class="n">many_resize_array</span> <span class="n">a</span> <span class="n">d</span> <span class="o">|&gt;</span> <span class="n">Result</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">.</span><span class="n">ToArray</span><span class="p">())</span>
<span class="n">let</span> <span class="n">inline</span> <span class="n">many</span> <span class="n">a</span> <span class="n">d</span> <span class="o">=</span> <span class="n">many_resize_array</span> <span class="n">a</span> <span class="n">d</span> <span class="o">|&gt;</span> <span class="n">Result</span><span class="o">.</span><span class="n">map</span> <span class="n">Seq</span><span class="o">.</span><span class="n">toList</span>

<span class="n">let</span> <span class="n">inline</span> <span class="n">sepBy</span> <span class="n">a</span> <span class="n">b</span> <span class="n">d</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">index</span> <span class="n">d</span>
    <span class="k">match</span> <span class="n">a</span> <span class="n">d</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">Ok</span> <span class="n">a</span><span class="s1">' -&gt; (many (b &gt;&gt;. a) |&gt;&gt; fun b -&gt; a'</span> <span class="p">::</span> <span class="n">b</span><span class="p">)</span> <span class="n">d</span>
    <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">s</span> <span class="o">=</span> <span class="n">index</span> <span class="n">d</span> <span class="n">then</span> <span class="n">Ok</span> <span class="p">[]</span> <span class="k">else</span> <span class="n">Error</span> <span class="n">x</span>

<span class="n">let</span> <span class="n">inline</span> <span class="n">sepBy1</span> <span class="n">a</span> <span class="n">b</span> <span class="n">d</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">a</span> <span class="n">d</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">Ok</span> <span class="n">a</span><span class="s1">' -&gt; (many (b &gt;&gt;. a) |&gt;&gt; fun b -&gt; a'</span> <span class="p">::</span> <span class="n">b</span><span class="p">)</span> <span class="n">d</span>
    <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>

<span class="n">let</span> <span class="n">inline</span> <span class="n">many1</span> <span class="n">a</span> <span class="n">d</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">a</span> <span class="n">d</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">Ok</span> <span class="n">a</span><span class="s1">' -&gt; (many a |&gt;&gt; fun b -&gt; a'</span> <span class="p">::</span> <span class="n">b</span><span class="p">)</span> <span class="n">d</span>
    <span class="o">|</span> <span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">x</span>

<span class="n">let</span> <span class="n">inline</span> <span class="n">attempt</span> <span class="n">a</span> <span class="n">d</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">index</span> <span class="n">d</span>
    <span class="k">match</span> <span class="n">a</span> <span class="n">d</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">Ok</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Ok</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">Error</span> <span class="n">a</span> <span class="k">as</span> <span class="n">a</span><span class="s1">' -&gt; index_set s d; a'</span>

<span class="o">///</span> <span class="n">Restores</span> <span class="n">the</span> <span class="n">index</span> <span class="n">on</span> <span class="n">an</span> <span class="n">error</span> <span class="k">if</span> <span class="n">at</span> <span class="n">least</span> <span class="n">i</span> <span class="n">tokens</span> <span class="n">have</span> <span class="n">been</span> <span class="n">consumed</span><span class="o">.</span>
<span class="n">let</span> <span class="n">inline</span> <span class="n">restore</span> <span class="n">i</span> <span class="n">a</span> <span class="n">d</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">index</span> <span class="n">d</span>
    <span class="k">match</span> <span class="n">a</span> <span class="n">d</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">Ok</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Ok</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">Error</span> <span class="n">_</span> <span class="k">as</span> <span class="n">er</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="k">if</span> <span class="n">index</span> <span class="n">d</span> <span class="o">&lt;=</span> <span class="n">s</span> <span class="o">+</span> <span class="n">i</span> <span class="n">then</span> <span class="n">index_set</span> <span class="n">s</span> <span class="n">d</span><span class="p">);</span> <span class="n">er</span>

<span class="n">let</span> <span class="n">inline</span> <span class="n">alt</span> <span class="n">s</span> <span class="n">a</span> <span class="n">b</span> <span class="n">d</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">a</span> <span class="n">d</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">Ok</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Ok</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">Error</span> <span class="n">a</span> <span class="k">as</span> <span class="n">a</span><span class="s1">' -&gt; </span>
        <span class="k">if</span> <span class="n">s</span> <span class="o">=</span> <span class="n">index</span> <span class="n">d</span> <span class="n">then</span>
            <span class="k">match</span> <span class="n">b</span> <span class="n">d</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">Ok</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Ok</span> <span class="n">x</span>
            <span class="o">|</span> <span class="n">Error</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">s</span> <span class="o">=</span> <span class="n">index</span> <span class="n">d</span> <span class="n">then</span> <span class="n">Error</span><span class="p">(</span><span class="n">List</span><span class="o">.</span><span class="n">append</span> <span class="n">a</span> <span class="n">b</span><span class="p">)</span> <span class="k">else</span> <span class="n">Error</span> <span class="n">b</span>
        <span class="k">else</span>
            <span class="n">a</span><span class="s1">'</span>

<span class="n">let</span> <span class="n">inline</span> <span class="p">(</span><span class="o">&lt;|&gt;</span><span class="p">)</span> <span class="n">a</span> <span class="n">b</span> <span class="n">d</span> <span class="o">=</span> <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">index</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">alt</span> <span class="n">s</span> <span class="n">a</span> <span class="n">b</span> <span class="n">d</span>

<span class="n">let</span> <span class="n">inline</span> <span class="p">(</span><span class="o">&lt;|&gt;%</span><span class="p">)</span> <span class="n">a</span> <span class="n">b</span> <span class="n">d</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">index</span> <span class="n">d</span>
    <span class="k">match</span> <span class="n">a</span> <span class="n">d</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">Ok</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Ok</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">Error</span> <span class="n">_</span> <span class="k">as</span> <span class="n">a</span><span class="s1">' -&gt; if s = index d then Ok b else a'</span>

<span class="n">let</span> <span class="n">inline</span> <span class="n">choice</span> <span class="n">ar</span> <span class="n">d</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">index</span> <span class="n">d</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="n">i</span> <span class="o">=</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">length</span> <span class="n">ar</span> <span class="n">then</span>
            <span class="k">match</span> <span class="n">ar</span><span class="o">.</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="n">d</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">Ok</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Ok</span> <span class="n">x</span>
            <span class="o">|</span> <span class="n">Error</span> <span class="n">a</span> <span class="k">as</span> <span class="n">a</span><span class="s1">' -&gt; </span>
                <span class="k">if</span> <span class="n">s</span> <span class="o">=</span> <span class="n">index</span> <span class="n">d</span> <span class="n">then</span>
                    <span class="k">match</span> <span class="n">loop</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">Ok</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Ok</span> <span class="n">x</span>
                    <span class="o">|</span> <span class="n">Error</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">Error</span><span class="p">(</span><span class="n">List</span><span class="o">.</span><span class="n">append</span> <span class="n">a</span> <span class="n">b</span><span class="p">)</span>
                <span class="k">else</span>
                    <span class="n">a</span><span class="s1">'</span>
        <span class="k">else</span>
            <span class="n">Error</span> <span class="p">[]</span>
    <span class="n">loop</span> <span class="mi">0</span>

<span class="n">let</span> <span class="n">inline</span> <span class="n">between</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="o">=</span> <span class="n">a</span> <span class="o">&gt;&gt;.</span> <span class="n">c</span> <span class="o">.&gt;&gt;</span> <span class="n">b</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=24">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="LineParsers">LineParsers<a class="anchor-link" href="#LineParsers"></a></h2>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=25">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="o">//</span> <span class="nb">open</span> <span class="n">System</span>
<span class="o">//</span> <span class="nb">open</span> <span class="n">System</span><span class="o">.</span><span class="n">Text</span>

<span class="nb">type</span> <span class="n">TokenizerRange</span> <span class="o">=</span> <span class="p">{</span><span class="kn">from</span> <span class="p">:</span> <span class="nb">int</span><span class="p">;</span> <span class="n">nearTo</span> <span class="p">:</span> <span class="nb">int</span><span class="p">}</span>
<span class="nb">type</span> <span class="n">TokenizerError</span> <span class="o">=</span> <span class="n">string</span>

<span class="nb">type</span> <span class="n">Tokenizer</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">text</span> <span class="p">:</span> <span class="n">string</span> <span class="o">//</span> <span class="n">A</span> <span class="n">single</span> <span class="n">line</span><span class="o">.</span>
    <span class="n">mutable</span> <span class="kn">from</span> <span class="p">:</span> <span class="nb">int</span>
    <span class="p">}</span> <span class="k">with</span>

    <span class="n">member</span> <span class="n">t</span><span class="o">.</span><span class="n">Index</span> <span class="k">with</span> <span class="n">get</span><span class="p">()</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="kn">from</span> <span class="nn">and</span> <span class="nb">set</span> <span class="n">i</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="kn">from</span> <span class="o">&lt;-</span> <span class="n">i</span>

<span class="n">let</span> <span class="n">range_char</span> <span class="n">i</span> <span class="o">=</span> <span class="p">{</span><span class="n">from</span><span class="o">=</span><span class="n">i</span><span class="p">;</span> <span class="n">nearTo</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">}</span>
<span class="n">let</span> <span class="n">error_char</span> <span class="n">i</span> <span class="n">er</span> <span class="o">=</span> <span class="n">Result</span><span class="o">.</span><span class="n">Error</span> <span class="p">[</span><span class="n">range_char</span> <span class="n">i</span><span class="p">,</span> <span class="n">er</span><span class="p">]</span>

<span class="n">let</span> <span class="n">inc</span><span class="s1">' i (s : Tokenizer) = s.from &lt;- s.from+i</span>
<span class="n">let</span> <span class="n">inc</span> <span class="p">(</span><span class="n">s</span> <span class="p">:</span> <span class="n">Tokenizer</span><span class="p">)</span> <span class="o">=</span> <span class="n">inc</span><span class="s1">' 1 s</span>

<span class="o">///</span> <span class="n">End</span> <span class="n">Of</span> <span class="n">Line</span> <span class="n">character</span>
<span class="n">let</span> <span class="n">eolLineParsers</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Char</span><span class="o">.</span><span class="n">MaxValue</span>
<span class="n">let</span> <span class="n">peek</span><span class="s1">' (s : Tokenizer) i =</span>
    <span class="n">let</span> <span class="n">i</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="kn">from</span> <span class="o">+</span> <span class="n">i</span>
    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">Length</span> <span class="n">then</span> <span class="n">s</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">else</span> <span class="n">eolLineParsers</span>

<span class="n">let</span> <span class="n">peek</span> <span class="p">(</span><span class="n">s</span> <span class="p">:</span> <span class="n">Tokenizer</span><span class="p">)</span> <span class="o">=</span> <span class="n">peek</span><span class="s1">' s 0</span>

<span class="n">let</span> <span class="n">inline</span> <span class="n">many1Satisfy2L</span> <span class="n">init</span> <span class="n">body</span> <span class="n">label</span> <span class="p">(</span><span class="n">s</span> <span class="p">:</span> <span class="n">Tokenizer</span><span class="p">)</span> <span class="o">=</span> 
    <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">peek</span> <span class="n">s</span>
    <span class="k">if</span> <span class="n">init</span> <span class="n">x</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">&lt;&gt;</span> <span class="n">eolLineParsers</span> <span class="n">then</span>
        <span class="n">inc</span> <span class="n">s</span>
        <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="p">(</span><span class="n">b</span> <span class="p">:</span> <span class="n">System</span><span class="o">.</span><span class="n">Text</span><span class="o">.</span><span class="n">StringBuilder</span><span class="p">)</span> <span class="o">=</span> 
            <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">peek</span> <span class="n">s</span>
            <span class="k">if</span> <span class="n">body</span> <span class="n">x</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">&lt;&gt;</span> <span class="n">eolLineParsers</span> <span class="n">then</span> <span class="n">inc</span> <span class="n">s</span><span class="p">;</span> <span class="n">b</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">loop</span>
            <span class="k">else</span> <span class="n">b</span><span class="o">.</span><span class="n">ToString</span><span class="p">()</span>
        <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span><span class="p">(</span><span class="n">loop</span> <span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">Text</span><span class="o">.</span><span class="n">StringBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
    <span class="k">else</span>
        <span class="n">let</span> <span class="n">i</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="kn">from</span>
        <span class="nn">error_char</span> <span class="n">i</span> <span class="n">label</span>

<span class="n">let</span> <span class="n">inline</span> <span class="n">many1SatisfyL</span> <span class="n">body</span> <span class="n">label</span> <span class="p">(</span><span class="n">s</span> <span class="p">:</span> <span class="n">Tokenizer</span><span class="p">)</span> <span class="o">=</span> <span class="n">many1Satisfy2L</span> <span class="n">body</span> <span class="n">body</span> <span class="n">label</span> <span class="n">s</span>

<span class="n">let</span> <span class="n">inline</span> <span class="n">skip</span> <span class="n">c</span> <span class="p">(</span><span class="n">s</span> <span class="p">:</span> <span class="n">Tokenizer</span><span class="p">)</span> <span class="o">=</span> <span class="n">let</span> <span class="n">b</span> <span class="o">=</span> <span class="n">peek</span> <span class="n">s</span> <span class="o">=</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">(</span><span class="k">if</span> <span class="n">b</span> <span class="n">then</span> <span class="n">inc</span> <span class="n">s</span><span class="p">);</span> <span class="n">b</span>
<span class="n">let</span> <span class="n">rec</span> <span class="n">spaces</span><span class="s1">' (s : Tokenizer) = if peek s = '</span> <span class="s1">' then inc s; spaces'</span> <span class="n">s</span>
<span class="n">let</span> <span class="n">spaces</span> <span class="n">s</span> <span class="o">=</span> <span class="n">spaces</span><span class="s1">' s |&gt; Result.Ok</span>

<span class="n">let</span> <span class="n">spaces1</span> <span class="p">(</span><span class="n">s</span> <span class="p">:</span> <span class="n">Tokenizer</span><span class="p">)</span> <span class="o">=</span>
    <span class="k">if</span> <span class="n">peek</span> <span class="n">s</span> <span class="o">=</span> <span class="s1">' '</span> <span class="n">then</span> <span class="n">inc</span> <span class="n">s</span><span class="p">;</span> <span class="n">spaces</span> <span class="n">s</span> <span class="k">else</span> <span class="n">error_char</span> <span class="n">s</span><span class="o">.</span><span class="kn">from</span> <span class="s2">"space"</span>

<span class="n">let</span> <span class="n">skip_char</span> <span class="n">c</span> <span class="p">(</span><span class="n">s</span> <span class="p">:</span> <span class="n">Tokenizer</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">let</span> <span class="kn">from</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="kn">from</span>
    <span class="nn">if</span> <span class="n">skip</span> <span class="n">c</span> <span class="n">s</span> <span class="n">then</span> <span class="n">Ok</span><span class="p">()</span> <span class="k">else</span> <span class="n">error_char</span> <span class="kn">from</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"'</span><span class="si">%c</span><span class="s2">'"</span> <span class="n">c</span><span class="p">)</span>

<span class="n">let</span> <span class="n">skip_string</span> <span class="n">x</span> <span class="p">(</span><span class="n">s</span> <span class="p">:</span> <span class="n">Tokenizer</span><span class="p">)</span> <span class="o">=</span>
    <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">String</span><span class="o">.</span><span class="n">Compare</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">text</span><span class="p">,</span><span class="n">s</span><span class="o">.</span><span class="n">from</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">Length</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">then</span> <span class="n">inc</span><span class="s1">' x.Length s; Ok()</span>
    <span class="k">else</span> <span class="n">error_char</span> <span class="n">s</span><span class="o">.</span><span class="kn">from</span> <span class="nn">x</span>

<span class="n">let</span> <span class="n">anyOf</span> <span class="p">(</span><span class="n">l</span> <span class="p">:</span> <span class="n">char</span> <span class="nb">list</span><span class="p">)</span> <span class="p">(</span><span class="n">s</span> <span class="p">:</span> <span class="n">Tokenizer</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">c</span> <span class="o">=</span> <span class="n">peek</span> <span class="n">s</span>
    <span class="k">if</span> <span class="n">Seq</span><span class="o">.</span><span class="n">contains</span> <span class="n">c</span> <span class="n">l</span> <span class="n">then</span> 
        <span class="n">inc</span> <span class="n">s</span><span class="p">;</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="k">else</span>
        <span class="n">let</span> <span class="n">i</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="kn">from</span>
        <span class="nn">Error</span> <span class="p">(</span><span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">c</span> <span class="o">-&gt;</span> <span class="n">range_char</span> <span class="n">i</span><span class="p">,</span> <span class="n">string</span> <span class="n">c</span><span class="p">)</span> <span class="n">l</span><span class="p">)</span>

<span class="n">let</span> <span class="n">chars_till_string</span> <span class="n">close</span> <span class="p">(</span><span class="n">s</span> <span class="p">:</span> <span class="n">Tokenizer</span><span class="p">)</span> <span class="o">=</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">close</span> <span class="o">&lt;&gt;</span> <span class="s2">""</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="p">(</span><span class="n">b</span> <span class="p">:</span> <span class="n">System</span><span class="o">.</span><span class="n">Text</span><span class="o">.</span><span class="n">StringBuilder</span><span class="p">)</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">peek</span> <span class="n">s</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">=</span> <span class="n">close</span><span class="o">.</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">System</span><span class="o">.</span><span class="n">String</span><span class="o">.</span><span class="n">Compare</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">text</span><span class="p">,</span><span class="n">s</span><span class="o">.</span><span class="n">from</span><span class="p">,</span><span class="n">close</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">close</span><span class="o">.</span><span class="n">Length</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">then</span> <span class="n">inc</span><span class="s1">' close.Length s; Ok(b.ToString())</span>
        <span class="k">else</span> 
            <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;&gt;</span> <span class="n">eolLineParsers</span> <span class="n">then</span> <span class="n">inc</span> <span class="n">s</span><span class="p">;</span> <span class="n">b</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">loop</span>
            <span class="k">else</span> <span class="n">error_char</span> <span class="n">s</span><span class="o">.</span><span class="kn">from</span> <span class="nn">close</span>
    <span class="n">loop</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">Text</span><span class="o">.</span><span class="n">StringBuilder</span><span class="p">())</span>

<span class="o">///</span> <span class="n">Parses</span> <span class="n">a</span> <span class="n">number</span> <span class="k">as</span> <span class="n">a</span> <span class="n">sequence</span> <span class="n">of</span> <span class="n">digits</span> <span class="ow">and</span> <span class="n">optionally</span> <span class="n">underscores</span><span class="o">.</span> <span class="n">Filters</span> <span class="n">out</span> <span class="n">the</span> <span class="n">underscores</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">result</span><span class="o">.</span>
<span class="n">let</span> <span class="n">numberLineParsers</span> <span class="p">(</span><span class="n">s</span> <span class="p">:</span> <span class="n">Tokenizer</span><span class="p">)</span> <span class="o">=</span> 
    <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">peek</span> <span class="n">s</span>
    <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">Char</span><span class="o">.</span><span class="n">IsDigit</span> <span class="n">x</span> <span class="n">then</span>
        <span class="n">inc</span> <span class="n">s</span>
        <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="p">(</span><span class="n">b</span> <span class="p">:</span> <span class="n">System</span><span class="o">.</span><span class="n">Text</span><span class="o">.</span><span class="n">StringBuilder</span><span class="p">)</span> <span class="o">=</span> 
            <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">peek</span> <span class="n">s</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">=</span> <span class="s1">'_'</span> <span class="n">then</span> <span class="n">inc</span> <span class="n">s</span><span class="p">;</span> <span class="n">loop</span> <span class="n">b</span>
            <span class="k">elif</span> <span class="n">System</span><span class="o">.</span><span class="n">Char</span><span class="o">.</span><span class="n">IsDigit</span> <span class="n">x</span> <span class="n">then</span> <span class="n">inc</span> <span class="n">s</span><span class="p">;</span> <span class="n">loop</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="k">else</span> <span class="n">Ok</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">ToString</span><span class="p">())</span>
        <span class="n">loop</span> <span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">Text</span><span class="o">.</span><span class="n">StringBuilder</span><span class="p">()</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="k">else</span>
        <span class="n">let</span> <span class="n">i</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="kn">from</span>
        <span class="nn">error_char</span> <span class="n">i</span> <span class="s2">"number"</span>

<span class="n">let</span> <span class="n">number_fractional</span> <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">numberLineParsers</span> <span class="o">.&gt;&gt;.</span> <span class="p">(</span><span class="n">opt</span> <span class="p">(</span><span class="n">skip_char</span> <span class="s1">'.'</span> <span class="o">&gt;&gt;.</span> <span class="n">numberLineParsers</span><span class="p">)))</span> <span class="n">s</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=26">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="VSCTypes">VSCTypes<a class="anchor-link" href="#VSCTypes"></a></h2>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=27">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="nb">type</span> <span class="n">VSCPos</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span><span class="n">line</span> <span class="p">:</span> <span class="nb">int</span><span class="p">;</span> <span class="n">character</span> <span class="p">:</span> <span class="nb">int</span><span class="o">|</span><span class="p">}</span>
<span class="nb">type</span> <span class="n">VSCRange</span> <span class="o">=</span> <span class="n">VSCPos</span> <span class="o">*</span> <span class="n">VSCPos</span>
<span class="nb">type</span> <span class="n">RString</span> <span class="o">=</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">string</span>

<span class="nb">type</span> <span class="n">PackageId</span> <span class="o">=</span> <span class="nb">int</span>
<span class="nb">type</span> <span class="n">ModuleId</span> <span class="o">=</span> <span class="nb">int</span>
<span class="nb">type</span> <span class="n">DirId</span> <span class="o">=</span> <span class="nb">int</span>
<span class="nb">type</span> <span class="n">GlobalId</span> <span class="o">=</span> <span class="p">{</span> <span class="n">package_id</span> <span class="p">:</span> <span class="n">PackageId</span><span class="p">;</span> <span class="n">module_id</span> <span class="p">:</span> <span class="n">ModuleId</span><span class="p">;</span> <span class="n">tag</span> <span class="p">:</span> <span class="nb">int</span> <span class="p">}</span>
<span class="nb">type</span> <span class="n">RGlobalId</span> <span class="o">=</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">GlobalId</span>
<span class="nb">type</span> <span class="n">SpiEdit</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span><span class="n">from</span><span class="p">:</span> <span class="nb">int</span><span class="p">;</span> <span class="n">nearTo</span><span class="p">:</span> <span class="nb">int</span><span class="p">;</span> <span class="n">lines</span><span class="p">:</span> <span class="n">string</span> <span class="p">[]</span><span class="o">|</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=28">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="Tokenize">Tokenize<a class="anchor-link" href="#Tokenize"></a></h2>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=29">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="o">//</span> <span class="nb">open</span> <span class="n">System</span>
<span class="o">//</span> <span class="nb">open</span> <span class="n">System</span><span class="o">.</span><span class="n">Text</span>
<span class="o">//</span> <span class="nb">open</span> <span class="n">FSharpx</span><span class="o">.</span><span class="n">Collections</span>

<span class="nb">type</span> <span class="n">TokenKeyword</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">SpecIn</span>
    <span class="o">|</span> <span class="n">SpecAnd</span>
    <span class="o">|</span> <span class="n">SpecFun</span>
    <span class="o">|</span> <span class="n">SpecMatch</span>
    <span class="o">|</span> <span class="n">SpecTypecase</span>
    <span class="o">|</span> <span class="n">SpecFunction</span>
    <span class="o">|</span> <span class="n">SpecWith</span>
    <span class="o">|</span> <span class="n">SpecWithout</span>
    <span class="o">|</span> <span class="n">SpecAs</span>
    <span class="o">|</span> <span class="n">SpecWhen</span>
    <span class="o">|</span> <span class="n">SpecInl</span>
    <span class="o">|</span> <span class="n">SpecForall</span>
    <span class="o">|</span> <span class="n">SpecExists</span>
    <span class="o">|</span> <span class="n">SpecLet</span>
    <span class="o">|</span> <span class="n">SpecInm</span>
    <span class="o">|</span> <span class="n">SpecInb</span>
    <span class="o">|</span> <span class="n">SpecRec</span>
    <span class="o">|</span> <span class="n">SpecIf</span>
    <span class="o">|</span> <span class="n">SpecThen</span>
    <span class="o">|</span> <span class="n">SpecElif</span>
    <span class="o">|</span> <span class="n">SpecElse</span>
    <span class="o">|</span> <span class="n">SpecJoin</span>
    <span class="o">|</span> <span class="n">SpecJoinBackend</span>
    <span class="o">|</span> <span class="n">SpecType</span>
    <span class="o">|</span> <span class="n">SpecNominal</span>
    <span class="o">|</span> <span class="n">SpecReal</span>
    <span class="o">|</span> <span class="n">SpecUnion</span>
    <span class="o">|</span> <span class="n">SpecOpen</span>
    <span class="o">|</span> <span class="n">SpecWildcard</span>
    <span class="o">|</span> <span class="n">SpecPrototype</span>
    <span class="o">|</span> <span class="n">SpecInstance</span>

<span class="nb">type</span> <span class="n">ParenthesisState</span> <span class="o">=</span> <span class="n">Open</span> <span class="o">|</span> <span class="n">Close</span>
<span class="nb">type</span> <span class="n">Parenthesis</span> <span class="o">=</span> <span class="n">Round</span> <span class="o">|</span> <span class="n">Square</span> <span class="o">|</span> <span class="n">Curly</span>
<span class="nb">type</span> <span class="n">MacroEnum</span> <span class="o">=</span> <span class="n">MTerm</span> <span class="o">|</span> <span class="n">MType</span> <span class="o">|</span> <span class="n">MTypeLit</span>

<span class="nb">type</span> <span class="n">Literal</span> <span class="o">=</span> 
    <span class="o">|</span> <span class="n">LitUInt8</span> <span class="n">of</span> <span class="n">uint8</span>
    <span class="o">|</span> <span class="n">LitUInt16</span> <span class="n">of</span> <span class="n">uint16</span>
    <span class="o">|</span> <span class="n">LitUInt32</span> <span class="n">of</span> <span class="n">uint32</span>
    <span class="o">|</span> <span class="n">LitUInt64</span> <span class="n">of</span> <span class="n">uint64</span>
    <span class="o">|</span> <span class="n">LitInt8</span> <span class="n">of</span> <span class="n">int8</span>
    <span class="o">|</span> <span class="n">LitInt16</span> <span class="n">of</span> <span class="n">int16</span>
    <span class="o">|</span> <span class="n">LitInt32</span> <span class="n">of</span> <span class="n">int32</span>
    <span class="o">|</span> <span class="n">LitInt64</span> <span class="n">of</span> <span class="n">int64</span>
    <span class="o">|</span> <span class="n">LitFloat32</span> <span class="n">of</span> <span class="n">float32</span>
    <span class="o">|</span> <span class="n">LitFloat64</span> <span class="n">of</span> <span class="nb">float</span>
    <span class="o">|</span> <span class="n">LitBool</span> <span class="n">of</span> <span class="nb">bool</span>
    <span class="o">|</span> <span class="n">LitString</span> <span class="n">of</span> <span class="n">string</span>
    <span class="o">|</span> <span class="n">LitChar</span> <span class="n">of</span> <span class="n">char</span>

    <span class="o">//</span> <span class="n">Converts</span> <span class="n">the</span> <span class="n">literal</span> <span class="n">back</span> <span class="n">to</span> <span class="n">their</span> <span class="n">string</span> <span class="n">representation</span><span class="o">.</span> <span class="n">Doesn</span><span class="s1">'t override the default printer.</span>
    <span class="n">member</span> <span class="n">l</span><span class="o">.</span><span class="n">LitToString</span><span class="p">()</span> <span class="o">=</span>
        <span class="k">match</span> <span class="n">l</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">LitUInt8</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">.</span><span class="n">ToString</span><span class="p">(</span><span class="s2">"R"</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">LitUInt16</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">.</span><span class="n">ToString</span><span class="p">(</span><span class="s2">"R"</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">LitUInt32</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">.</span><span class="n">ToString</span><span class="p">(</span><span class="s2">"R"</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">LitUInt64</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">.</span><span class="n">ToString</span><span class="p">(</span><span class="s2">"R"</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">LitInt8</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">.</span><span class="n">ToString</span><span class="p">(</span><span class="s2">"R"</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">LitInt16</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">.</span><span class="n">ToString</span><span class="p">(</span><span class="s2">"R"</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">LitInt32</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">.</span><span class="n">ToString</span><span class="p">(</span><span class="s2">"R"</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">LitInt64</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">.</span><span class="n">ToString</span><span class="p">(</span><span class="s2">"R"</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">LitFloat32</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">.</span><span class="n">ToString</span><span class="p">(</span><span class="s2">"R"</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">LitFloat64</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">.</span><span class="n">ToString</span><span class="p">(</span><span class="s2">"R"</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">LitBool</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">.</span><span class="n">ToString</span><span class="p">()</span>
        <span class="o">|</span> <span class="n">LitString</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">LitChar</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">.</span><span class="n">ToString</span><span class="p">()</span>


<span class="nb">type</span> <span class="n">SemanticTokenLegend</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">variable</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="o">|</span> <span class="n">symbol</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="o">|</span> <span class="n">string</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="o">|</span> <span class="n">number</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="o">|</span> <span class="n">operator</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="o">|</span> <span class="n">unary_operator</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="o">|</span> <span class="n">comment</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="o">|</span> <span class="n">keyword</span> <span class="o">=</span> <span class="mi">7</span>
    <span class="o">|</span> <span class="n">parenthesis</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="o">|</span> <span class="n">type_variable</span> <span class="o">=</span> <span class="mi">9</span>
    <span class="o">|</span> <span class="n">escaped_char</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="o">|</span> <span class="n">unescaped_char</span> <span class="o">=</span> <span class="mi">11</span>
    <span class="o">|</span> <span class="n">number_suffix</span> <span class="o">=</span> <span class="mi">12</span>
    <span class="o">|</span> <span class="n">escaped_var</span> <span class="o">=</span> <span class="mi">13</span>

<span class="nb">type</span> <span class="n">SpiralToken</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">TokVar</span> <span class="n">of</span> <span class="n">string</span> <span class="o">*</span> <span class="n">SemanticTokenLegend</span>
    <span class="o">|</span> <span class="n">TokSymbol</span> <span class="n">of</span> <span class="n">string</span> <span class="o">*</span> <span class="n">SemanticTokenLegend</span>
    <span class="o">|</span> <span class="n">TokOperator</span> <span class="n">of</span> <span class="n">string</span> <span class="o">*</span> <span class="n">SemanticTokenLegend</span>
    <span class="o">|</span> <span class="n">TokUnaryOperator</span> <span class="n">of</span> <span class="n">string</span> <span class="o">*</span> <span class="n">SemanticTokenLegend</span>
    <span class="o">|</span> <span class="n">TokValue</span> <span class="n">of</span> <span class="n">Literal</span>
    <span class="o">|</span> <span class="n">TokValueSuffix</span>
    <span class="o">|</span> <span class="n">TokDefaultValue</span> <span class="n">of</span> <span class="n">string</span>
    <span class="o">|</span> <span class="n">TokComment</span> <span class="n">of</span> <span class="n">string</span>
    <span class="o">|</span> <span class="n">TokKeyword</span> <span class="n">of</span> <span class="n">TokenKeyword</span>
    <span class="o">|</span> <span class="n">TokParenthesis</span> <span class="n">of</span> <span class="n">Parenthesis</span> <span class="o">*</span> <span class="n">ParenthesisState</span>
    <span class="o">|</span> <span class="n">TokStringOpen</span> <span class="o">|</span> <span class="n">TokStringClose</span>
    <span class="o">|</span> <span class="n">TokText</span> <span class="n">of</span> <span class="n">string</span>
    <span class="o">|</span> <span class="n">TokEscapedChar</span> <span class="n">of</span> <span class="n">char</span>
    <span class="o">|</span> <span class="n">TokEscapedVar</span>
    <span class="o">|</span> <span class="n">TokUnescapedChar</span> <span class="n">of</span> <span class="n">char</span>
    <span class="o">|</span> <span class="n">TokMacroOpen</span> <span class="o">|</span> <span class="n">TokMacroClose</span>
    <span class="o">|</span> <span class="n">TokMacroTermVar</span> <span class="n">of</span> <span class="n">string</span>
    <span class="o">|</span> <span class="n">TokMacroTypeVar</span> <span class="n">of</span> <span class="n">string</span>
    <span class="o">|</span> <span class="n">TokMacroTypeLitVar</span> <span class="n">of</span> <span class="n">string</span>
    <span class="o">|</span> <span class="n">TokMacroExpression</span> <span class="n">of</span> <span class="n">MacroEnum</span> <span class="o">*</span> <span class="n">ParenthesisState</span>

<span class="n">let</span> <span class="n">token_groups</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">TokUnaryOperator</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">r</span><span class="p">)</span> <span class="o">|</span> <span class="n">TokOperator</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">r</span><span class="p">)</span> <span class="o">|</span> <span class="n">TokVar</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">r</span><span class="p">)</span> <span class="o">|</span> <span class="n">TokSymbol</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">r</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">r</span>
    <span class="o">|</span> <span class="n">TokValue</span> <span class="p">(</span><span class="n">LitChar</span> <span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">TokStringOpen</span> <span class="o">|</span> <span class="n">TokStringClose</span> <span class="o">|</span> <span class="n">TokText</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TokMacroOpen</span> <span class="o">|</span> <span class="n">TokMacroClose</span> <span class="o">|</span> <span class="n">TokValue</span><span class="p">(</span><span class="n">LitString</span> <span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SemanticTokenLegend</span><span class="o">.</span><span class="n">string</span>
    <span class="o">|</span> <span class="n">TokComment</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">SemanticTokenLegend</span><span class="o">.</span><span class="n">comment</span>
    <span class="o">|</span> <span class="n">TokKeyword</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">SemanticTokenLegend</span><span class="o">.</span><span class="n">keyword</span>
    <span class="o">|</span> <span class="n">TokParenthesis</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">SemanticTokenLegend</span><span class="o">.</span><span class="n">parenthesis</span>
    <span class="o">|</span> <span class="n">TokMacroTypeVar</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">SemanticTokenLegend</span><span class="o">.</span><span class="n">type_variable</span>
    <span class="o">|</span> <span class="n">TokMacroTypeLitVar</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">SemanticTokenLegend</span><span class="o">.</span><span class="n">type_variable</span>
    <span class="o">|</span> <span class="n">TokMacroTermVar</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">SemanticTokenLegend</span><span class="o">.</span><span class="n">variable</span>
    <span class="o">|</span> <span class="n">TokMacroExpression</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">SemanticTokenLegend</span><span class="o">.</span><span class="n">parenthesis</span>
    <span class="o">|</span> <span class="n">TokEscapedChar</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">SemanticTokenLegend</span><span class="o">.</span><span class="n">escaped_char</span>
    <span class="o">|</span> <span class="n">TokEscapedVar</span> <span class="o">-&gt;</span> <span class="n">SemanticTokenLegend</span><span class="o">.</span><span class="n">escaped_var</span>
    <span class="o">|</span> <span class="n">TokUnescapedChar</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">SemanticTokenLegend</span><span class="o">.</span><span class="n">unescaped_char</span>
    <span class="o">|</span> <span class="n">TokValue</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TokDefaultValue</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">SemanticTokenLegend</span><span class="o">.</span><span class="n">number</span>
    <span class="o">|</span> <span class="n">TokValueSuffix</span> <span class="o">-&gt;</span> <span class="n">SemanticTokenLegend</span><span class="o">.</span><span class="n">number_suffix</span>

<span class="n">let</span> <span class="n">show_lit</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">LitUInt8</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%i</span><span class="s2">u8"</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">LitUInt16</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%i</span><span class="s2">u16"</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">LitUInt32</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%i</span><span class="s2">u32"</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">LitUInt64</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%i</span><span class="s2">u64"</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">LitInt8</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%i</span><span class="s2">i8"</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">LitInt16</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%i</span><span class="s2">i16"</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">LitInt32</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%i</span><span class="s2">i32"</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">LitInt64</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%i</span><span class="s2">i64"</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">LitFloat32</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%f</span><span class="s2">f32"</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">LitFloat64</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%f</span><span class="s2">f64"</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">LitBool</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"%b"</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">LitString</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2">"</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">LitChar</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%c</span><span class="s2">"</span> <span class="n">x</span>

<span class="n">let</span> <span class="n">is_small_var_char_starting</span> <span class="n">c</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Char</span><span class="o">.</span><span class="n">IsLower</span> <span class="n">c</span> <span class="o">||</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">'_'</span>
<span class="n">let</span> <span class="n">is_var_char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Char</span><span class="o">.</span><span class="n">IsLetterOrDigit</span> <span class="n">c</span> <span class="o">||</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">'_'</span> <span class="o">||</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">'''</span>
<span class="s1">let is_big_var_char_starting c = System.Char.IsUpper c</span>
<span class="s1">let is_var_char_starting c = System.Char.IsLetter c || c = '_'</span>
<span class="s1">let is_parenth_open c = </span>
<span class="s1">    let f x = c = x</span>
<span class="s1">    f '(' || f '[' || f '{'</span>
<span class="s1">let is_parenth_close c = </span>
<span class="s1">    let f x = c = x</span>
<span class="s1">    f ')' || f ']' || f '}'</span>

<span class="s1">// http://www.asciitable.com/</span>
<span class="s1">let is_operator_char c =</span>
<span class="s1">    let f x = c = x</span>
<span class="s1">    '!' &lt;= c &amp;&amp; c &lt;= '~' &amp;&amp; (is_var_char c || f '"' || is_parenth_open c || is_parenth_close c) = false</span>
<span class="s1">let is_prefix_separator_char c = </span>
<span class="s1">    let f x = c = x</span>
<span class="s1">    f ' ' || f eolLineParsers || is_parenth_open c</span>
<span class="s1">let is_postfix_separator_char c = </span>
<span class="s1">    let f x = c = x</span>
<span class="s1">    f ' ' || f eolLineParsers || is_parenth_close c</span>
<span class="s1">let is_separator_char c = is_prefix_separator_char c || is_parenth_close c</span>

<span class="s1">let var (s: Tokenizer) = </span>
<span class="s1">    let from = s.from</span>
<span class="s1">    let ok x = Result.Ok ({from=from; nearTo=s.from}, x)</span>
<span class="s1">    let body x _ = </span>
<span class="s1">        if skip ':' s then error_char from ": is not allowed directly after a var."</span>
<span class="s1">        else</span>
<span class="s1">            let f x = TokKeyword(x)</span>
<span class="s1">            match x with</span>
<span class="s1">            | "in" -&gt; f SpecIn</span>
<span class="s1">            | "and" -&gt; f SpecAnd | "fun" -&gt; f SpecFun</span>
<span class="s1">            | "match" -&gt; f SpecMatch | "typecase" -&gt; f SpecTypecase</span>
<span class="s1">            | "function" -&gt; f SpecFunction</span>
<span class="s1">            | "with" -&gt; f SpecWith | "without" -&gt; f SpecWithout</span>
<span class="s1">            | "as" -&gt; f SpecAs | "when" -&gt; f SpecWhen</span>
<span class="s1">            | "inl" -&gt; f SpecInl | "forall" -&gt; f SpecForall</span>
<span class="s1">            | "let" -&gt; f SpecLet | "inm" -&gt; f SpecInm</span>
<span class="s1">            | "inb" -&gt; f SpecInb | "rec" -&gt; f SpecRec</span>
<span class="s1">            | "if" -&gt; f SpecIf | "then" -&gt; f SpecThen</span>
<span class="s1">            | "elif" -&gt; f SpecElif | "else" -&gt; f SpecElse</span>
<span class="s1">            | "join" -&gt; f SpecJoin | "join_backend" -&gt; f SpecJoinBackend</span>
<span class="s1">            | "type" -&gt; f SpecType | "nominal" -&gt; f SpecNominal </span>
<span class="s1">            | "real" -&gt; f SpecReal | "union" -&gt; f SpecUnion</span>
<span class="s1">            | "open" -&gt; f SpecOpen | "_" -&gt; f SpecWildcard</span>
<span class="s1">            | "prototype" -&gt; f SpecPrototype | "instance" -&gt; f SpecInstance</span>
<span class="s1">            | "true" -&gt; TokValue(LitBool true) | "false" -&gt; TokValue(LitBool false)</span>
<span class="s1">            | "exists" -&gt; f SpecExists</span>
<span class="s1">            | x -&gt; TokVar(x,SemanticTokenLegend.variable)</span>
<span class="s1">            |&gt; ok</span>

<span class="s1">    (many1Satisfy2L is_var_char_starting is_var_char "variable" &gt;&gt;= body .&gt;&gt; spaces) s</span>

<span class="s1">let numberTokenize (s: Tokenizer) = </span>
<span class="s1">    let from = s.from</span>

<span class="s1">    let parser (s: Tokenizer) = </span>
<span class="s1">        if peek s = '-' &amp;&amp; System.Char.IsDigit (peek' s 1) &amp;&amp; is_prefix_separator_char (peek' s -1) then </span>
<span class="s1">            inc s</span>
<span class="s1">            number_fractional s |&gt; Result.map (function </span>
<span class="s1">                | (a,Some b) -&gt; sprintf "-</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">" a b</span>
<span class="s1">                | (a,None) -&gt; "-"+a)</span>
<span class="s1">        else number_fractional s |&gt; Result.map (function </span>
<span class="s1">                | (a,Some b) -&gt; sprintf "</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">" a b</span>
<span class="s1">                | (a,None) -&gt; a)</span>
<span class="s1">    </span>
<span class="s1">    let followedBySuffix x (s: Tokenizer) =</span>
<span class="s1">        let from' = s.from</span>
<span class="s1">        let inline safe_parse string_to_val val_to_lit val_dsc =</span>
<span class="s1">            if (let x = peek s in is_separator_char x || is_operator_char x) then</span>
<span class="s1">                match string_to_val x with</span>
<span class="s1">                | true, x -&gt; Ok [{from=from; nearTo=from'}, TokValue(val_to_lit x); {from=from'; nearTo=s.from}, TokValueSuffix]</span>
<span class="s1">                | false, _ -&gt; Error [{from=from; nearTo=s.from}, (sprintf "The string </span><span class="si">%s</span><span class="s1"> cannot be safely parsed as </span><span class="si">%s</span><span class="s1">." x val_dsc)]</span>
<span class="s1">            else error_char s.from "separator"</span>
<span class="s1">        let skip c = skip c s</span>
<span class="s1">        if skip 'i' then</span>
<span class="s1">            if skip '8' then safe_parse System.SByte.TryParse LitInt8 "i8"</span>
<span class="s1">            elif skip '1' &amp;&amp; skip '6' then safe_parse System.Int16.TryParse LitInt16 "i16"</span>
<span class="s1">            elif skip '3' &amp;&amp; skip '2' then safe_parse System.Int32.TryParse LitInt32 "i32"</span>
<span class="s1">            elif skip '6' &amp;&amp; skip '4' then safe_parse System.Int64.TryParse LitInt64 "i64"</span>
<span class="s1">            else error_char s.from "8,16,32 or 64"</span>
<span class="s1">        elif skip 'u' then</span>
<span class="s1">            if skip '8' then safe_parse System.Byte.TryParse LitUInt8 "uint8"</span>
<span class="s1">            elif skip '1' &amp;&amp; skip '6' then safe_parse System.UInt16.TryParse LitUInt16 "u16"</span>
<span class="s1">            elif skip '3' &amp;&amp; skip '2' then safe_parse System.UInt32.TryParse LitUInt32 "u32"</span>
<span class="s1">            elif skip '6' &amp;&amp; skip '4' then safe_parse System.UInt64.TryParse LitUInt64 "u64"</span>
<span class="s1">            else error_char s.from "8,16,32 or 64"</span>
<span class="s1">        elif skip 'f' then</span>
<span class="s1">            if skip '3' &amp;&amp; skip '2' then safe_parse System.Single.TryParse LitFloat32 "f32"</span>
<span class="s1">            elif skip '6' &amp;&amp; skip '4' then safe_parse System.Double.TryParse LitFloat64 "f64"</span>
<span class="s1">            else error_char s.from "32 or 64"</span>
<span class="s1">        else Ok [{from=from; nearTo=s.from}, TokDefaultValue x]</span>

<span class="s1">    (parser &gt;&gt;= followedBySuffix .&gt;&gt; spaces) s</span>

<span class="s1">let symbol s =</span>
<span class="s1">    let from = s.from</span>
<span class="s1">    let f x = ({from=from; nearTo=s.from}, x)</span>

<span class="s1">    let symbol x = TokSymbol(x,SemanticTokenLegend.symbol)</span>
<span class="s1">    let x = peek s</span>
<span class="s1">    let x' = peek' s 1</span>
<span class="s1">    if x = '.' &amp;&amp; x' = '(' then inc' 2 s; ((many1SatisfyL is_operator_char "operator") .&gt;&gt; skip_char ')' |&gt;&gt; (symbol &gt;&gt; f) .&gt;&gt; spaces) s</span>
<span class="s1">    elif x = '.' &amp;&amp; is_var_char_starting x' then inc s; ((many1SatisfyL is_var_char "variable") |&gt;&gt; (symbol &gt;&gt; f) .&gt;&gt; spaces) s</span>
<span class="s1">    else error_char from "symbol"</span>

<span class="s1">let comment (s : Tokenizer) =</span>
<span class="s1">    if peek s = '/' &amp;&amp; peek' s 1 = '/' then </span>
<span class="s1">        let from = s.from</span>
<span class="s1">        inc' 2 s</span>
<span class="s1">        while peek s = '/' || (peek s = '!' &amp;&amp; peek' s 1 = ' ') do</span>
<span class="s1">            inc s</span>
<span class="s1">        if skip ' ' s then</span>
<span class="s1">            let com = s.text.[s.from..]</span>
<span class="s1">            s.from &lt;- s.text.Length</span>
<span class="s1">            Ok ({from=from; nearTo=s.from}, TokComment com)</span>
<span class="s1">        else error_char s.from "whitespace"</span>
<span class="s1">    else</span>
<span class="s1">        error_char s.from "comment"</span>

<span class="s1">let operator (s : Tokenizer) = </span>
<span class="s1">    let from = s.from</span>
<span class="s1">    let ok x = ({from=from; nearTo=s.from}, x) |&gt; Ok</span>
<span class="s1">    let is_separator_prev = is_prefix_separator_char (peek' s -1)</span>
<span class="s1">    let f name (s: Tokenizer) = </span>
<span class="s1">        if is_separator_prev &amp;&amp; (is_postfix_separator_char (peek s) = false) then TokUnaryOperator(name,SemanticTokenLegend.unary_operator) |&gt; ok</span>
<span class="s1">        else TokOperator(name,SemanticTokenLegend.operator) |&gt; ok</span>
<span class="s1">    (many1SatisfyL is_operator_char "operator"  &gt;&gt;= f .&gt;&gt; spaces) s</span>

<span class="s1">let string_raw s =</span>
<span class="s1">    let from = s.from</span>
<span class="s1">    let f x = {from=from; nearTo=s.from}, TokValue(LitString x)</span>
<span class="s1">    (skip_string "@</span><span class="se">\"</span><span class="s1">" &gt;&gt;. chars_till_string "</span><span class="se">\"</span><span class="s1">" |&gt;&gt; f .&gt;&gt; spaces) s</span>

<span class="s1">let char_quoted s = </span>
<span class="s1">    let char_quoted_body (s: Tokenizer) =</span>
<span class="s1">        let inline read on_succ =</span>
<span class="s1">            let x = peek s</span>
<span class="s1">            if x &lt;&gt; eolLineParsers then inc s; on_succ x</span>
<span class="s1">            else error_char s.from "character or '"</span>
<span class="s1">        read (function</span>
<span class="s1">            | '</span><span class="se">\\</span><span class="s1">' -&gt; </span>
<span class="s1">                read (Ok &lt;&lt; function</span>
<span class="s1">                    | 'n' -&gt; '</span><span class="se">\n</span><span class="s1">' | 'r' -&gt; '</span><span class="se">\r</span><span class="s1">' | 't' -&gt; '</span><span class="se">\t</span><span class="s1">' | 'b' -&gt; '</span><span class="se">\b</span><span class="s1">'</span>
<span class="s1">                    | x -&gt; x</span>
<span class="s1">                    )</span>
<span class="s1">            | x -&gt; Ok x</span>
<span class="s1">            )</span>
<span class="s1">    let from = s.from</span>
<span class="s1">    let f _ x _ = {from=from; nearTo=s.from}, TokValue(LitChar x)</span>
<span class="s1">    (pipe3 (skip_char '</span><span class="se">\'</span><span class="s1">') char_quoted_body (skip_char '</span><span class="se">\'</span><span class="s1">') f .&gt;&gt; spaces) s</span>

<span class="s1">let inline special_char l text s =</span>
<span class="s1">    let inline f from x = {from=from; nearTo=s.from}, x</span>
<span class="s1">    let f = f s.from</span>
<span class="s1">    inc s</span>
<span class="s1">    let esc x = inc s; text (f (TokEscapedChar x) :: l)</span>
<span class="s1">    let unesc x = inc s; text (f (TokUnescapedChar x) :: l)</span>
<span class="s1">    match peek s with </span>
<span class="s1">    | x when x = eolLineParsers -&gt; error_char s.from "character"</span>
<span class="s1">    | 'n' -&gt; esc '</span><span class="se">\n</span><span class="s1">' | 'r' -&gt; esc '</span><span class="se">\r</span><span class="s1">'  | 't' -&gt; esc '</span><span class="se">\t</span><span class="s1">'  | 'b' -&gt; esc '</span><span class="se">\b</span><span class="s1">' </span>
<span class="s1">    | x -&gt; unesc x</span>

<span class="s1">let string_quoted' s =</span>
<span class="s1">    let inline f from x = {from=from; nearTo=s.from}, x</span>
<span class="s1">    let close l = let f = f s.from in inc s; List.rev (f TokStringClose :: l) |&gt; Ok</span>
<span class="s1">    let rec text l =</span>
<span class="s1">        let f = f s.from</span>
<span class="s1">        let rec loop (str : System.Text.StringBuilder) =</span>
<span class="s1">            let l () = if 0 &lt; str.Length then f (TokText(str.ToString())) :: l else l</span>
<span class="s1">            match peek s with</span>
<span class="s1">            | x when x = eolLineParsers -&gt; error_char s.from "character or </span><span class="se">\"</span><span class="s1">"</span>
<span class="s1">            | '</span><span class="se">\\</span><span class="s1">' -&gt; special_char (l ()) text s</span>
<span class="s1">            | '"' -&gt; close (l ())</span>
<span class="s1">            | x -&gt; inc s; loop (str.Append(x))</span>
<span class="s1">        loop (System.Text.StringBuilder())</span>
<span class="s1">        </span>
<span class="s1">    match peek s with</span>
<span class="s1">    | '"' -&gt; let f = f s.from in inc s; text [f TokStringOpen]</span>
<span class="s1">    | _ -&gt; error_char s.from "</span><span class="se">\"</span><span class="s1">"</span>
<span class="s1">let string_quoted s = (string_quoted' .&gt;&gt; spaces) s</span>

<span class="s1">type private TokenizerMacro =</span>
<span class="s1">    | Text of TokenizerRange * string</span>
<span class="s1">    | EscapedChar of TokenizerRange * char</span>
<span class="s1">    | EscapedVar of TokenizerRange</span>
<span class="s1">    | UnescapedChar of TokenizerRange * char</span>
<span class="s1">    | Expression of TokenizerRange * string * MacroEnum</span>
<span class="s1">    | Var of TokenizerRange * string * MacroEnum</span>

<span class="s1">let inline range p s = </span>
<span class="s1">    let from = s.from</span>
<span class="s1">    match p s with</span>
<span class="s1">    | Ok x -&gt; Ok({from=from; nearTo=s.from}, x)</span>
<span class="s1">    | Error l -&gt; Error l</span>

<span class="s1">let brackets s =</span>
<span class="s1">    let from = s.from</span>
<span class="s1">    let f spec = inc s; (spaces &gt;&gt;% ({from=from; nearTo=s.from}, TokParenthesis(spec))) s</span>
<span class="s1">    match peek s with</span>
<span class="s1">    | '(' -&gt; f (Round,Open) | '[' -&gt; f (Square,Open) | '{' -&gt; f (Curly,Open)</span>
<span class="s1">    | ')' -&gt; f (Round,Close) | ']' -&gt; f (Square,Close) | '}' -&gt; f (Curly,Close)</span>
<span class="s1">    | _ -&gt; error_char s.from "`(`,`[`,`{`,`}`,`]` or `)`"</span>

<span class="s1">let tab s = if peek s = '</span><span class="se">\t</span><span class="s1">' then Error [range_char (index s), "Tabs are not allowed."] else Error []</span>
<span class="s1">let eolTokenize s = if peek s = eolLineParsers then Ok [] else Error [range_char (index s), "end of line"]</span>

<span class="s1">let rec token s =</span>
<span class="s1">    let i = s.from</span>
<span class="s1">    let inline (+) a b = alt i a b</span>
<span class="s1">    let individual_tokens = string_quoted + numberTokenize + ((var + symbol + string_raw + char_quoted + brackets + comment + operator) |&gt;&gt; fun x -&gt; [x]) |&gt;&gt; fun x -&gt; x, []</span>
<span class="s1">    (macro + individual_tokens) s</span>
<span class="s1">and tokenize text =</span>
<span class="s1">    let mutable ar = FSharpx.Collections.PersistentVector.empty</span>
<span class="s1">    let mutable er = []</span>
<span class="s1">    let tokens =</span>
<span class="s1">        many_iter (fun (x : (TokenizerRange * SpiralToken) list,er' : (TokenizerRange * string) list) -&gt;</span>
<span class="s1">            List.iter (fun x -&gt; ar &lt;- FSharpx.Collections.PersistentVector.conj x ar) x</span>
<span class="s1">            er &lt;- List.append er' er</span>
<span class="s1">            ) token</span>
<span class="s1">    let er = match (spaces &gt;&gt;. tokens .&gt;&gt; (eolTokenize &lt;|&gt; tab)) {from=0; text=text} with Ok() -&gt; er | Error er' -&gt; List.append er' er</span>
<span class="s1">    ar, er</span>
<span class="s1">and macro s =</span>
<span class="s1">    let char_to_macro_expr = function</span>
<span class="s1">        | '`' -&gt; MType</span>
<span class="s1">        | '!' -&gt; MTerm</span>
<span class="s1">        | '@' -&gt; MTypeLit</span>
<span class="s1">        | _ -&gt; failwith "Compiler error: Unknown char in the tokenizer."</span>

<span class="s1">    let p_special_char s =</span>
<span class="s1">        match peek' s 0, peek' s 1 with</span>
<span class="s1">        | '</span><span class="se">\\</span><span class="s1">', ('n' | 'r' | 't' | 'b' as c) -&gt; </span>
<span class="s1">            let r = {from=s.from; nearTo=s.from+2}</span>
<span class="s1">            inc' 2 s</span>
<span class="s1">            Ok(EscapedChar(r, c))</span>
<span class="s1">        | '</span><span class="se">\\</span><span class="s1">', ('v' as c) -&gt; </span>
<span class="s1">            let r = {from=s.from; nearTo=s.from+2}</span>
<span class="s1">            inc' 2 s</span>
<span class="s1">            Ok(EscapedVar(r))</span>
<span class="s1">        | '</span><span class="se">\\</span><span class="s1">', c -&gt;</span>
<span class="s1">            let r = {from=s.from; nearTo=s.from+2}</span>
<span class="s1">            inc' 2 s </span>
<span class="s1">            Ok(UnescapedChar(r, c))</span>
<span class="s1">        | _ -&gt; error_char s.from "</span><span class="se">\\</span><span class="s1">"</span>

<span class="s1">    let p_var s = (many1Satisfy2L is_var_char_starting is_var_char "variable") s</span>
<span class="s1">    let p_text closing_char s = (range (many1SatisfyL (fun c -&gt; c &lt;&gt; closing_char &amp;&amp; c &lt;&gt; '`' &amp;&amp; c &lt;&gt; '!' &amp;&amp; c &lt;&gt; '@' &amp;&amp; c &lt;&gt; '</span><span class="se">\\</span><span class="s1">') "macro text") |&gt;&gt; Text) s</span>
<span class="s1">    let p_expr s = </span>
<span class="s1">        let start = anyOf ['`'; '!'; '@']</span>
<span class="s1">        let case_paren start_char = </span>
<span class="s1">            let mutable c = 1 // number of open parens.</span>
<span class="s1">            between (skip_char '(') (skip_char ')') (many1SatisfyL (fun x -&gt; // Stops when the number of open parens is 0.</span>
<span class="s1">                c &lt;- c + (match x with '(' -&gt; 1 | ')' -&gt; -1 | _ -&gt; 0)</span>
<span class="s1">                c &gt; 0</span>
<span class="s1">                ) "not )") </span>
<span class="s1">            |&gt;&gt; fun (body) range -&gt; Expression(range,body,char_to_macro_expr start_char)</span>
<span class="s1">        let case_var start_char =</span>
<span class="s1">            (skip_char start_char |&gt;&gt; fun () range -&gt; UnescapedChar(range,start_char))</span>
<span class="s1">            &lt;|&gt; (p_var |&gt;&gt; fun body range -&gt; Var(range,body,char_to_macro_expr start_char))</span>
<span class="s1">        (range (start &gt;&gt;= fun start_char -&gt; (case_paren start_char &lt;|&gt; case_var start_char))</span>
<span class="s1">        |&gt;&gt; fun (range, f) -&gt; f range) s</span>
<span class="s1">    let p_macro_inner closing_char s = (many (p_special_char &lt;|&gt; p_text closing_char &lt;|&gt; p_expr) &lt;|&gt;% []) s</span>
<span class="s1">    let p_macro s =</span>
<span class="s1">        let body a b = range (between (skip_string a) (skip_char b) (p_macro_inner b))</span>
<span class="s1">        (body "$</span><span class="se">\"</span><span class="s1">" '"' &lt;|&gt; body "$'" '''</span><span class="p">)</span> <span class="n">s</span>

    <span class="k">match</span> <span class="p">(</span><span class="n">p_macro</span> <span class="o">.&gt;&gt;</span> <span class="n">spaces</span><span class="p">)</span> <span class="n">s</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">Ok</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> 
        <span class="n">let</span> <span class="n">start</span> <span class="o">=</span> 
            <span class="n">let</span> <span class="n">r</span> <span class="o">=</span> <span class="p">{</span><span class="n">from</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">from</span><span class="p">;</span> <span class="n">nearTo</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">from</span><span class="o">+</span><span class="mi">2</span><span class="p">}</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">TokMacroOpen</span>
        <span class="n">let</span> <span class="n">end_</span> <span class="o">=</span> 
            <span class="n">let</span> <span class="n">r</span> <span class="o">=</span> <span class="p">{</span><span class="n">from</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">nearTo</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">nearTo</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">nearTo</span><span class="p">}</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">TokMacroClose</span>
    
        <span class="n">let</span> <span class="n">mutable</span> <span class="n">er</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">collect</span> <span class="p">(</span><span class="n">function</span>
            <span class="o">|</span> <span class="n">Text</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">TokText</span> <span class="n">x</span><span class="p">]</span>
            <span class="o">|</span> <span class="n">EscapedChar</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">match</span> <span class="n">x</span> <span class="k">with</span> <span class="s1">'n'</span> <span class="o">-&gt;</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">'</span> <span class="o">|</span> <span class="s1">'r'</span> <span class="o">-&gt;</span> <span class="s1">'</span><span class="se">\r</span><span class="s1">'</span> <span class="o">|</span> <span class="s1">'t'</span> <span class="o">-&gt;</span> <span class="s1">'</span><span class="se">\t</span><span class="s1">'</span> <span class="o">|</span> <span class="s1">'b'</span> <span class="o">-&gt;</span> <span class="s1">'</span><span class="se">\b</span><span class="s1">'</span> <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span>
                <span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">TokEscapedChar</span> <span class="n">x</span><span class="p">]</span>
            <span class="o">|</span> <span class="n">EscapedVar</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">TokEscapedVar</span><span class="p">]</span>
            <span class="o">|</span> <span class="n">UnescapedChar</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">TokUnescapedChar</span> <span class="n">x</span><span class="p">]</span>
            <span class="o">|</span> <span class="n">Var</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">MType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">TokMacroTypeVar</span> <span class="n">x</span><span class="p">]</span>
            <span class="o">|</span> <span class="n">Var</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">MTypeLit</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">TokMacroTypeLitVar</span> <span class="n">x</span><span class="p">]</span>
            <span class="o">|</span> <span class="n">Var</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">MTerm</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">TokMacroTermVar</span> <span class="n">x</span><span class="p">]</span>
            <span class="o">|</span> <span class="n">Expression</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="o">-&gt;</span> 
                <span class="n">let</span> <span class="n">start</span> <span class="o">=</span> 
                    <span class="n">let</span> <span class="n">r</span> <span class="o">=</span> <span class="p">{</span><span class="n">from</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">from</span><span class="p">;</span> <span class="n">nearTo</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">from</span><span class="o">+</span><span class="mi">2</span><span class="p">}</span>
                    <span class="n">r</span><span class="p">,</span> <span class="n">TokMacroExpression</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">Open</span><span class="p">)</span>
                <span class="n">let</span> <span class="n">end_</span> <span class="o">=</span> 
                    <span class="n">let</span> <span class="n">r</span> <span class="o">=</span> <span class="p">{</span><span class="n">from</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">nearTo</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">nearTo</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">nearTo</span><span class="p">}</span>
                    <span class="n">r</span><span class="p">,</span> <span class="n">TokMacroExpression</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">Close</span><span class="p">)</span>
                <span class="n">let</span> <span class="n">middle</span><span class="p">,</span><span class="n">er</span><span class="s1">' =</span>
                    <span class="n">let</span> <span class="n">adjust_range</span> <span class="p">(</span><span class="n">r</span> <span class="p">:</span> <span class="n">TokenizerRange</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="n">from</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="kn">from</span> <span class="o">+</span> <span class="p">(</span><span class="n">fst</span> <span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">nearTo</span><span class="p">;</span> <span class="n">nearTo</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">nearTo</span> <span class="o">+</span> <span class="p">(</span><span class="n">fst</span> <span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">nearTo</span><span class="p">},</span> <span class="n">x</span>
                    <span class="n">let</span> <span class="n">middle</span><span class="p">,</span><span class="n">er</span><span class="s1">' = tokenize x</span>
                    <span class="n">FSharpx</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">PersistentVector</span><span class="o">.</span><span class="n">map</span> <span class="n">adjust_range</span> <span class="n">middle</span><span class="p">,</span>
                    <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="n">adjust_range</span> <span class="n">er</span><span class="s1">'</span>
                <span class="n">er</span> <span class="o">&lt;-</span> <span class="n">List</span><span class="o">.</span><span class="n">append</span> <span class="n">er</span><span class="s1">' er</span>
                <span class="n">List</span><span class="o">.</span><span class="n">concat</span> <span class="p">[[</span><span class="n">start</span><span class="p">];</span> <span class="n">List</span><span class="o">.</span><span class="n">ofSeq</span> <span class="n">middle</span><span class="p">;</span> <span class="p">[</span><span class="n">end_</span><span class="p">]]</span>
            <span class="p">)</span>
        <span class="o">|&gt;</span> <span class="n">fun</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">Ok</span><span class="p">(</span><span class="n">List</span><span class="o">.</span><span class="n">concat</span> <span class="p">[[</span><span class="n">start</span><span class="p">];</span> <span class="n">l</span><span class="p">;</span> <span class="p">[</span><span class="n">end_</span><span class="p">]],</span> <span class="n">er</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">Error</span> <span class="n">er</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">er</span>

<span class="nb">type</span> <span class="n">LineToken</span> <span class="o">=</span> <span class="n">TokenizerRange</span> <span class="o">*</span> <span class="n">SpiralToken</span>
<span class="nb">type</span> <span class="n">LineComment</span> <span class="o">=</span> <span class="n">TokenizerRange</span> <span class="o">*</span> <span class="n">string</span>
<span class="nb">type</span> <span class="n">LineTokenErrors</span> <span class="o">=</span> <span class="p">(</span><span class="n">TokenizerRange</span> <span class="o">*</span> <span class="n">TokenizerError</span><span class="p">)</span> <span class="nb">list</span>

<span class="n">let</span> <span class="n">vscode_tokens</span> <span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="p">:</span> <span class="n">VSCRange</span><span class="p">)</span> <span class="p">(</span><span class="n">lines</span> <span class="p">:</span> <span class="n">LineToken</span> <span class="n">FSharpx</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">PersistentVector</span> <span class="n">FSharpx</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">PersistentVector</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">in_range</span> <span class="n">x</span> <span class="o">=</span> <span class="nb">min</span> <span class="n">lines</span><span class="o">.</span><span class="n">Length</span> <span class="n">x</span>
    <span class="n">let</span> <span class="n">from</span><span class="p">,</span> <span class="n">near_to</span> <span class="o">=</span> <span class="n">in_range</span> <span class="n">a</span><span class="o">.</span><span class="n">line</span><span class="p">,</span> <span class="n">in_range</span> <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">line</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">toks</span> <span class="o">=</span> <span class="n">ResizeArray</span><span class="p">()</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="n">i</span> <span class="n">line_delta</span> <span class="o">=</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">near_to</span> <span class="n">then</span>
            <span class="n">lines</span><span class="o">.</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|&gt;</span> <span class="n">FSharpx</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">PersistentVector</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">line_delta</span><span class="p">,</span><span class="n">from_prev</span><span class="p">)</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">toks</span><span class="o">.</span><span class="n">AddRange</span> <span class="p">[</span><span class="o">|</span><span class="n">line_delta</span><span class="p">;</span> <span class="n">r</span><span class="o">.</span><span class="n">from</span><span class="o">-</span><span class="n">from_prev</span><span class="p">;</span> <span class="n">r</span><span class="o">.</span><span class="n">nearTo</span><span class="o">-</span><span class="n">r</span><span class="o">.</span><span class="n">from</span><span class="p">;</span> <span class="nb">int</span> <span class="p">(</span><span class="n">token_groups</span> <span class="n">x</span><span class="p">);</span> <span class="mi">0</span><span class="o">|</span><span class="p">]</span>
                <span class="mi">0</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="kn">from</span>
                <span class="p">)</span> <span class="p">(</span><span class="n">line_delta</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="o">|&gt;</span> <span class="n">fst</span> <span class="o">|&gt;</span> <span class="p">((</span><span class="o">+</span><span class="p">)</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">loop</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">loop</span> <span class="kn">from</span> <span class="nn">from</span>
    <span class="n">toks</span><span class="o">.</span><span class="n">ToArray</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=30">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="BlockSplitting">BlockSplitting<a class="anchor-link" href="#BlockSplitting"></a></h2>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=31">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="o">//</span> <span class="nb">open</span> <span class="n">FSharpx</span><span class="o">.</span><span class="n">Collections</span>

<span class="nb">type</span> <span class="n">LineTokens</span> <span class="o">=</span> <span class="n">LineToken</span> <span class="n">FSharpx</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">PersistentVector</span> <span class="n">FSharpx</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">PersistentVector</span>
<span class="nb">type</span> <span class="n">Block</span><span class="o">&lt;</span><span class="s1">'a&gt; = {block: '</span><span class="n">a</span><span class="p">;</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span><span class="p">}</span>

<span class="o">///</span> <span class="n">Reads</span> <span class="n">the</span> <span class="n">comments</span> <span class="n">up</span> <span class="n">to</span> <span class="n">a</span> <span class="n">statement</span><span class="p">,</span> <span class="ow">and</span> <span class="n">then</span> <span class="n">reads</span> <span class="n">the</span> <span class="n">statement</span> <span class="n">body</span><span class="o">.</span> <span class="n">Leaves</span> <span class="nb">any</span> <span class="n">errors</span> <span class="k">for</span> <span class="n">the</span> <span class="n">parsing</span> <span class="n">stage</span><span class="o">.</span>
<span class="n">let</span> <span class="n">block_at</span> <span class="p">(</span><span class="n">lines</span> <span class="p">:</span> <span class="n">LineTokens</span><span class="p">)</span> <span class="n">i</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">mutable</span> <span class="n">block</span> <span class="o">=</span> <span class="n">FSharpx</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">PersistentVector</span><span class="o">.</span><span class="n">empty</span>
    <span class="n">let</span> <span class="n">add</span> <span class="n">x</span> <span class="o">=</span> <span class="n">block</span> <span class="o">&lt;-</span> <span class="n">FSharpx</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">PersistentVector</span><span class="o">.</span><span class="n">conj</span> <span class="n">x</span> <span class="n">block</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">loop_initial</span> <span class="n">i</span> <span class="o">=</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">lines</span><span class="o">.</span><span class="n">Length</span> <span class="n">then</span>
            <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">add</span> <span class="n">x</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">x</span><span class="o">.</span><span class="n">Length</span> <span class="n">then</span>
                <span class="n">let</span> <span class="n">r</span><span class="p">,</span><span class="n">t</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="kn">from</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">then</span>
                    <span class="k">match</span> <span class="n">t</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">TokComment</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">loop_initial</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">loop_body</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">loop_initial</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">This</span> <span class="n">branch</span> <span class="n">will</span> <span class="n">be</span> <span class="n">an</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">parsing</span> <span class="n">stage</span> <span class="n">unless</span> <span class="n">the</span> <span class="n">token</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">comment</span><span class="o">.</span>
            <span class="k">else</span> <span class="n">loop_initial</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="ow">and</span> <span class="n">loop_body</span> <span class="n">i</span> <span class="o">=</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">lines</span><span class="o">.</span><span class="n">Length</span> <span class="n">then</span>
            <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">x</span><span class="o">.</span><span class="n">Length</span> <span class="n">then</span>
                <span class="n">let</span> <span class="n">r</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="kn">from</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">then</span> <span class="n">add</span> <span class="n">x</span><span class="p">;</span> <span class="n">loop_body</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">add</span> <span class="n">x</span><span class="p">;</span> <span class="n">loop_body</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">loop_initial</span> <span class="n">i</span>
    <span class="p">{</span><span class="n">block</span> <span class="o">=</span> <span class="n">block</span><span class="p">;</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">i</span><span class="p">}</span>

<span class="o">//</span> <span class="n">Parses</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">blocks</span><span class="o">.</span>
<span class="n">let</span> <span class="n">rec</span> <span class="n">block_all</span> <span class="n">lines</span> <span class="n">i</span> <span class="o">=</span> 
    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FSharpx</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">PersistentVector</span><span class="o">.</span><span class="n">length</span> <span class="n">lines</span> <span class="n">then</span> 
        <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">block_at</span> <span class="n">lines</span> <span class="n">i</span>
        <span class="n">x</span> <span class="p">::</span> <span class="n">block_all</span> <span class="n">lines</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">x</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">Length</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>

<span class="o">//</span> <span class="n">Parses</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">blocks</span> <span class="k">with</span> <span class="n">diffing</span><span class="o">.</span> <span class="n">Only</span> <span class="n">parses</span> <span class="n">those</span> <span class="n">blocks</span> <span class="n">which</span> <span class="n">are</span> <span class="n">dirty</span> <span class="n">based</span> <span class="n">of</span> <span class="n">the</span> <span class="n">edit</span> <span class="nb">range</span><span class="o">.</span> <span class="n">Preserves</span> <span class="n">ref</span> <span class="n">equality</span> <span class="ow">and</span> <span class="n">saves</span> <span class="n">work</span><span class="o">.</span>
<span class="o">//</span> <span class="n">Without</span> <span class="n">considering</span> <span class="n">ref</span> <span class="n">preservation</span><span class="p">,</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">functionally</span> <span class="n">equivalent</span> <span class="n">to</span> <span class="n">just</span> <span class="n">call</span> <span class="err">`</span><span class="n">block_all</span><span class="err">`</span> <span class="n">on</span> <span class="n">just</span> <span class="err">`</span><span class="n">lines</span><span class="err">`</span><span class="o">.</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">function</span> <span class="ow">is</span> <span class="n">difficult</span> <span class="n">to</span> <span class="n">read</span> <span class="k">as</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">several</span> <span class="n">operations</span> <span class="n">fused</span> <span class="n">into</span> <span class="n">one</span> <span class="n">loop</span><span class="o">.</span>
<span class="n">let</span> <span class="n">wdiff_block_all</span> <span class="p">(</span><span class="n">blocks</span> <span class="p">:</span> <span class="n">LineTokens</span> <span class="n">Block</span> <span class="nb">list</span><span class="p">)</span> <span class="p">(</span><span class="n">lines</span> <span class="p">:</span> <span class="n">LineTokens</span><span class="p">,</span> <span class="n">lines_added</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">nearTo</span><span class="p">)</span> <span class="o">=</span>
    <span class="o">//</span> <span class="n">Lines</span> <span class="n">added</span> <span class="n">minus</span> <span class="n">lines</span> <span class="n">removed</span><span class="o">.</span>
    <span class="n">let</span> <span class="n">line_adjustment</span> <span class="o">=</span> <span class="n">lines_added</span> <span class="o">-</span> <span class="p">(</span><span class="n">nearTo</span> <span class="o">-</span> <span class="n">from</span><span class="p">)</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">dirty</span> <span class="n">block</span> <span class="n">boundary</span> <span class="n">needs</span> <span class="n">to</span> <span class="n">be</span> <span class="n">more</span> <span class="n">conservative</span> <span class="n">when</span> <span class="n">a</span> <span class="n">separator</span> <span class="ow">is</span> <span class="n">added</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">first</span> <span class="n">position</span> <span class="n">of</span> <span class="n">block</span><span class="o">.</span>
    <span class="o">//</span> <span class="n">Imagine</span> <span class="n">adding</span> <span class="n">a</span> <span class="n">newline</span> <span class="n">right</span> <span class="n">on</span> <span class="n">a</span> <span class="n">block</span> <span class="n">start</span><span class="o">.</span> <span class="n">This</span> <span class="n">would</span> <span class="n">extend</span> <span class="n">the</span> <span class="n">previous</span> <span class="n">block</span><span class="p">,</span> <span class="n">but</span> <span class="n">the</span> <span class="n">naive</span> <span class="n">check</span> <span class="n">would</span> <span class="ow">not</span> <span class="n">react</span> <span class="n">to</span> <span class="n">it</span><span class="o">.</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">same</span> <span class="n">goes</span> <span class="k">for</span> <span class="n">pasting</span> <span class="n">an</span> <span class="n">indented</span> <span class="n">piece</span> <span class="n">of</span> <span class="n">text</span><span class="o">.</span>
    <span class="n">let</span> <span class="n">dirty_from</span> <span class="o">=</span> <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="p">[</span><span class="n">from</span><span class="p">]</span> <span class="ow">in</span> <span class="kn">from</span> <span class="o">-</span> <span class="p">(</span><span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">Length</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">||</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">fst</span> <span class="n">x</span><span class="o">.</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="kn">from</span> <span class="nn">then</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">is_dirty</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">LineTokens</span> <span class="n">Block</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">dirty_from</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="o">.</span><span class="n">offset</span> <span class="o">&amp;&amp;</span> <span class="n">x</span><span class="o">.</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="n">nearTo</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">offset</span> <span class="o">&lt;=</span> <span class="n">dirty_from</span> <span class="o">&amp;&amp;</span> <span class="n">dirty_from</span> <span class="o">&lt;</span> <span class="n">x</span><span class="o">.</span><span class="n">offset</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">Length</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="n">blocks</span> <span class="n">i</span> <span class="o">=</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">lines</span><span class="o">.</span><span class="n">Length</span> <span class="n">then</span>
            <span class="k">match</span> <span class="n">blocks</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">x</span> <span class="p">::</span> <span class="n">xs</span> <span class="o">-&gt;</span>
                <span class="o">//</span> <span class="n">If</span> <span class="n">the</span> <span class="n">block</span> <span class="ow">is</span> <span class="n">dirty</span><span class="p">,</span> <span class="n">forget</span> <span class="n">it</span><span class="o">.</span>
                <span class="k">if</span> <span class="n">is_dirty</span> <span class="n">x</span> <span class="n">then</span> <span class="n">loop</span> <span class="n">xs</span> <span class="n">i</span> <span class="k">else</span> 
                    <span class="o">//</span> <span class="n">If</span> <span class="n">the</span> <span class="n">block</span> <span class="ow">is</span> <span class="n">past</span> <span class="n">the</span> <span class="n">removal</span> <span class="nb">range</span><span class="p">,</span> <span class="n">adjust</span> <span class="n">its</span> <span class="n">line</span> <span class="n">offset</span><span class="o">.</span>
                    <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span> <span class="k">with</span> <span class="n">offset</span><span class="o">=</span><span class="k">if</span> <span class="n">nearTo</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="o">.</span><span class="n">offset</span> <span class="n">then</span> <span class="n">x</span><span class="o">.</span><span class="n">offset</span> <span class="o">+</span> <span class="n">line_adjustment</span> <span class="k">else</span> <span class="n">x</span><span class="o">.</span><span class="n">offset</span><span class="p">}</span>
                    <span class="o">//</span> <span class="n">The</span> <span class="n">block</span> <span class="n">can</span><span class="s1">'t be dirty here. Hence if the offsets are the same, so are the blocks. Take it.</span>
                    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">i</span> <span class="n">then</span> <span class="n">x</span> <span class="p">::</span> <span class="n">loop</span> <span class="n">xs</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">Length</span><span class="p">)</span>
                    <span class="o">//</span> <span class="n">Else</span> <span class="k">if</span> <span class="n">the</span> <span class="n">block</span> <span class="n">has</span> <span class="n">been</span> <span class="n">skipped</span> <span class="n">over</span><span class="p">,</span> <span class="n">forget</span> <span class="n">it</span><span class="o">.</span>
                    <span class="k">elif</span> <span class="n">x</span><span class="o">.</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="n">i</span> <span class="n">then</span> <span class="n">loop</span> <span class="n">xs</span> <span class="n">i</span>
                    <span class="o">//</span> <span class="n">Else</span> <span class="n">the</span> <span class="n">block</span> <span class="n">has</span> <span class="n">been</span> <span class="n">dirty</span> <span class="n">filtered</span><span class="p">,</span> <span class="n">recalculate</span> <span class="n">it</span><span class="o">.</span>
                    <span class="k">else</span> <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">block_at</span> <span class="n">lines</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x</span> <span class="p">::</span> <span class="n">loop</span> <span class="n">blocks</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">block</span><span class="o">.</span><span class="n">Length</span><span class="p">)</span>
            <span class="o">|</span> <span class="p">[]</span> <span class="o">-&gt;</span> <span class="n">block_all</span> <span class="n">lines</span> <span class="n">i</span>
        <span class="k">else</span> <span class="p">[]</span>
    <span class="n">loop</span> <span class="n">blocks</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=32">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="BlockParsing">BlockParsing<a class="anchor-link" href="#BlockParsing"></a></h2>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=33">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1">#r @"../../../../../../../.nuget/packages/fparsec/2.0.0-beta2/lib/netstandard2.1/FParsec.dll"</span>
<span class="c1">#r @"../../../../../../../.nuget/packages/fparsec/2.0.0-beta2/lib/netstandard2.1/FParsecCS.dll"</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=34">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="o">//</span> <span class="nb">open</span> <span class="n">System</span>
<span class="o">//</span> <span class="nb">open</span> <span class="n">FParsec</span>
<span class="o">//</span> <span class="nb">open</span> <span class="n">FSharp</span><span class="o">.</span><span class="n">Core</span>

<span class="nb">type</span> <span class="n">SymbolString</span> <span class="o">=</span> <span class="n">string</span>
<span class="nb">type</span> <span class="n">VarString</span> <span class="o">=</span> <span class="n">string</span>
<span class="nb">type</span> <span class="n">NominalString</span> <span class="o">=</span> <span class="n">string</span>

<span class="nb">type</span> <span class="n">Layout</span> <span class="o">=</span> <span class="n">Heap</span> <span class="o">|</span> <span class="n">HeapMutable</span> <span class="o">|</span> <span class="n">StackMutable</span>
<span class="nb">type</span> <span class="n">FunType</span> <span class="o">=</span> <span class="n">FT_Vanilla</span> <span class="o">|</span> <span class="n">FT_Pointer</span> <span class="o">|</span> <span class="n">FT_Closure</span> <span class="o">//</span> <span class="n">The</span> <span class="n">closure</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">pointer</span> <span class="n">are</span> <span class="n">specific</span> <span class="n">to</span> <span class="n">the</span> <span class="n">C</span><span class="o">++</span> <span class="n">backend</span><span class="o">.</span>

<span class="nb">type</span> <span class="n">Op</span> <span class="o">=</span>
    <span class="o">//</span> <span class="n">Converts</span> <span class="n">the</span> <span class="n">function</span> <span class="n">to</span> <span class="n">a</span> <span class="n">specialized</span> <span class="nb">type</span> <span class="n">specific</span> <span class="n">to</span> <span class="n">the</span> <span class="n">C</span><span class="o">++</span> <span class="n">backend</span><span class="o">.</span>
    <span class="o">|</span> <span class="n">ToFunPtr</span>
    <span class="o">|</span> <span class="n">ToFunClosure</span>

    <span class="o">//</span> <span class="n">Compile</span> <span class="n">time</span> <span class="nb">hash</span> <span class="nb">set</span>
    <span class="o">|</span> <span class="n">HashSetCreate</span>
    <span class="o">|</span> <span class="n">HashSetAdd</span>
    <span class="o">|</span> <span class="n">HashSetContains</span>
    <span class="o">|</span> <span class="n">HashSetRemove</span>
    <span class="o">|</span> <span class="n">HashSetCount</span>

    <span class="o">//</span> <span class="n">Compile</span> <span class="n">time</span> <span class="nb">hash</span> <span class="nb">map</span>
    <span class="o">|</span> <span class="n">HashMapCreate</span>
    <span class="o">|</span> <span class="n">HashMapSetImmutable</span>
    <span class="o">|</span> <span class="n">HashMapSet</span>
    <span class="o">|</span> <span class="n">HashMapAdd</span>
    <span class="o">|</span> <span class="n">HashMapTryAdd</span>
    <span class="o">|</span> <span class="n">HashMapContains</span>
    <span class="o">|</span> <span class="n">HashMapRemove</span>
    <span class="o">|</span> <span class="n">HashMapCount</span>
    <span class="o">|</span> <span class="n">HashMapTryGet</span>

    <span class="o">//</span> <span class="n">Pragma</span>
    <span class="o">|</span> <span class="n">PragmaUnrollPush</span>
    <span class="o">|</span> <span class="n">PragmaUnrollPop</span>
    
    <span class="o">//</span> <span class="n">Backend</span> <span class="n">branching</span>
    <span class="o">|</span> <span class="n">BackendSwitch</span>

    <span class="o">//</span> <span class="n">Reordering</span> <span class="n">check</span>
    <span class="o">|</span> <span class="n">UsesOriginalTermVars</span>
    <span class="o">|</span> <span class="n">UsesOriginalNominals</span>

    <span class="o">//</span> <span class="n">Imports</span>
    <span class="o">|</span> <span class="n">Global</span>
    
    <span class="o">//</span> <span class="n">Python</span>
    <span class="o">|</span> <span class="n">ToPythonRecord</span>
    <span class="o">|</span> <span class="n">ToPythonNamedTuple</span>

    <span class="o">//</span> <span class="n">Branching</span>
    <span class="o">|</span> <span class="n">While</span>
    <span class="o">|</span> <span class="n">Do</span>
    <span class="o">|</span> <span class="n">Indent</span>

    <span class="o">//</span> <span class="n">Layout</span>
    <span class="o">|</span> <span class="n">LayoutToHeap</span>
    <span class="o">|</span> <span class="n">LayoutToHeapMutable</span>
    <span class="o">|</span> <span class="n">LayoutToStackMutable</span>
    <span class="o">|</span> <span class="n">LayoutIndex</span>

    <span class="o">//</span> <span class="n">Type</span>
    <span class="o">|</span> <span class="n">TypeToVar</span>
    <span class="o">|</span> <span class="n">TypeToSymbol</span>
    <span class="o">|</span> <span class="n">TypeLitToLit</span>
    <span class="o">|</span> <span class="n">LitToTypeLit</span>
    <span class="o">|</span> <span class="n">LitToSymbol</span>

    <span class="o">//</span> <span class="n">Closure</span> <span class="n">conversion</span>
    <span class="o">|</span> <span class="n">Dyn</span>

    <span class="o">//</span> <span class="n">Nominal</span> 
    <span class="o">|</span> <span class="n">NominalCreate</span> <span class="o">//</span> <span class="n">In</span> <span class="n">addition</span> <span class="n">to</span> <span class="n">regular</span> <span class="n">nominals</span><span class="p">,</span> <span class="n">it</span> <span class="n">can</span> <span class="n">also</span> <span class="n">creates</span> <span class="n">unions</span>
    <span class="o">|</span> <span class="n">NominalStrip</span>
    <span class="o">|</span> <span class="n">NominalTypeApply</span>

    <span class="o">//</span> <span class="n">Union</span>
    <span class="o">|</span> <span class="n">Unbox</span>
    <span class="o">|</span> <span class="n">Unbox2</span>
    <span class="o">|</span> <span class="n">UnionTag</span>
    <span class="o">|</span> <span class="n">UnionUntag</span>
    <span class="o">|</span> <span class="n">UnionToRecord</span>

    <span class="o">//</span> <span class="n">String</span>
    <span class="o">|</span> <span class="n">StringLength</span>
    <span class="o">|</span> <span class="n">StringIndex</span>
    <span class="o">|</span> <span class="n">StringSlice</span>
    <span class="o">|</span> <span class="n">StaticStringConcat</span>
    <span class="o">|</span> <span class="n">Printf</span> <span class="o">//</span> <span class="n">Cuda</span> <span class="n">specific</span>

    <span class="o">//</span> <span class="n">Array</span>
    <span class="o">|</span> <span class="n">ArrayCreate</span>
    <span class="o">|</span> <span class="n">ArrayLength</span>
    <span class="o">|</span> <span class="n">ArrayIndex</span>
    <span class="o">|</span> <span class="n">ArrayIndexSet</span>

    <span class="o">//</span> <span class="n">Record</span>
    <span class="o">|</span> <span class="n">RecordMap</span>
    <span class="o">|</span> <span class="n">RecordIter</span>
    <span class="o">|</span> <span class="n">RecordFilter</span>
    <span class="o">|</span> <span class="n">RecordFold</span>
    <span class="o">|</span> <span class="n">RecordFoldBack</span>
    <span class="o">|</span> <span class="n">RecordLength</span>

    <span class="o">//</span> <span class="n">Record</span> <span class="n">Type</span>
    <span class="o">|</span> <span class="n">RecordTypeMap</span>
    <span class="o">|</span> <span class="n">RecordTypeIter</span>
    <span class="o">|</span> <span class="n">RecordTypeFold</span>
    <span class="o">|</span> <span class="n">RecordTypeFoldBack</span>
    <span class="o">|</span> <span class="n">RecordTypeLength</span>
    <span class="o">|</span> <span class="n">RecordTypeTryFind</span>

    <span class="o">//</span> <span class="n">BinOps</span>
    <span class="o">|</span> <span class="n">Add</span>
    <span class="o">|</span> <span class="n">Sub</span>
    <span class="o">|</span> <span class="n">Mult</span> 
    <span class="o">|</span> <span class="n">Div</span> 
    <span class="o">|</span> <span class="n">Mod</span> 
    <span class="o">|</span> <span class="n">Pow</span>
    <span class="o">|</span> <span class="n">LTE</span>
    <span class="o">|</span> <span class="n">LT</span>
    <span class="o">|</span> <span class="n">EQ</span>
    <span class="o">|</span> <span class="n">TypeEq</span>
    <span class="o">|</span> <span class="n">NEQ</span>
    <span class="o">|</span> <span class="n">GT</span>
    <span class="o">|</span> <span class="n">GTE</span> 
    <span class="o">|</span> <span class="n">BoolAnd</span>
    <span class="o">|</span> <span class="n">BoolOr</span>
    <span class="o">|</span> <span class="n">BitwiseAnd</span>
    <span class="o">|</span> <span class="n">BitwiseOr</span>
    <span class="o">|</span> <span class="n">BitwiseXor</span>
    <span class="o">|</span> <span class="n">BitwiseComplement</span>
    <span class="o">|</span> <span class="n">ShiftLeft</span>
    <span class="o">|</span> <span class="n">ShiftRight</span>

    <span class="o">//</span> <span class="n">Unary</span> <span class="n">math</span> <span class="n">ops</span>
    <span class="o">|</span> <span class="n">Neg</span>
    <span class="o">|</span> <span class="n">Tanh</span>
    <span class="o">|</span> <span class="n">Log</span>
    <span class="o">|</span> <span class="n">Exp</span>
    <span class="o">|</span> <span class="n">Sin</span>
    <span class="o">|</span> <span class="n">Cos</span>
    <span class="o">|</span> <span class="n">Sqrt</span>
    <span class="o">|</span> <span class="n">NanIs</span>
    <span class="o">|</span> <span class="n">Conv</span>

    <span class="o">//</span> <span class="n">Infinity</span>
    <span class="o">|</span> <span class="n">Infinity</span>
    <span class="o">|</span> <span class="n">Pi</span>

    <span class="o">//</span> <span class="n">Static</span> <span class="n">Is</span>
    <span class="o">|</span> <span class="n">LitIs</span>
    <span class="o">|</span> <span class="n">PrimIs</span>
    <span class="o">|</span> <span class="n">SymbolIs</span>
    <span class="o">|</span> <span class="n">VarIs</span>
    <span class="o">|</span> <span class="n">UnionIs</span>
    <span class="o">|</span> <span class="n">HeapUnionIs</span>
    <span class="o">|</span> <span class="n">LayoutIs</span>
    <span class="o">|</span> <span class="n">NominalIs</span>
    <span class="o">|</span> <span class="n">FunctionIs</span>
    <span class="o">|</span> <span class="n">ExistsIs</span>
    <span class="o">|</span> <span class="n">PrototypeHas</span>

    <span class="o">//</span> <span class="n">Static</span> <span class="n">Type</span> <span class="n">Is</span>
    <span class="o">|</span> <span class="n">PrimTypeIs</span>
    <span class="o">|</span> <span class="n">SymbolTypeIs</span>
    <span class="o">|</span> <span class="n">UnionTypeIs</span>
    <span class="o">|</span> <span class="n">HeapUnionTypeIs</span>
    <span class="o">|</span> <span class="n">LayoutTypeIs</span>
    <span class="o">|</span> <span class="n">ExistsTypeIs</span>
    <span class="o">|</span> <span class="n">NominalTypeIs</span>

    <span class="o">//</span> <span class="n">Panic</span>
    <span class="o">|</span> <span class="n">FailWith</span>

    <span class="o">//</span> <span class="n">Static</span> <span class="n">unary</span> <span class="n">operations</span>
    <span class="o">|</span> <span class="n">PrintStatic</span>
    <span class="o">|</span> <span class="n">PrintRaw</span>
    <span class="o">|</span> <span class="n">ErrorType</span>
    <span class="o">|</span> <span class="n">ExistsStrip</span>
    <span class="o">|</span> <span class="n">StringLitToSymbol</span>
    <span class="o">|</span> <span class="n">SymbolToString</span>
    
    <span class="o">//</span> <span class="n">Serialization</span> <span class="n">helpers</span>
    <span class="o">|</span> <span class="n">VarTag</span>
    <span class="o">|</span> <span class="n">TagToSymbol</span>
    <span class="o">|</span> <span class="n">FunctionTermSlotsGet</span>
    <span class="o">|</span> <span class="n">FunctionTermSlotsSet</span>
    <span class="o">|</span> <span class="n">FreeVars</span>
    <span class="o">|</span> <span class="n">FreeVarsReplace</span>
    <span class="o">|</span> <span class="n">SizeOf</span>

<span class="nb">type</span> <span class="n">PatternCompilationErrors</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">DisjointOrPatternVar</span>
    <span class="o">|</span> <span class="n">DuplicateTermVar</span>
    <span class="o">|</span> <span class="n">DuplicateTypeVar</span>
    <span class="o">|</span> <span class="n">ShadowedVar</span>
    <span class="o">|</span> <span class="n">DuplicateRecordSymbol</span>
    <span class="o">|</span> <span class="n">DuplicateRecordInjection</span>

<span class="nb">type</span> <span class="n">ParserErrors</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">TypeVarsNeedToBeExplicitForExists</span>
    <span class="o">|</span> <span class="n">InvalidPattern</span> <span class="n">of</span> <span class="n">PatternCompilationErrors</span>
    <span class="o">|</span> <span class="n">ExpectedKeyword</span> <span class="n">of</span> <span class="n">TokenKeyword</span>
    <span class="o">|</span> <span class="n">ExpectedStringOpen</span> <span class="o">|</span> <span class="n">ExpectedStringClose</span>
    <span class="o">|</span> <span class="n">ExpectedMacroOpen</span> <span class="o">|</span> <span class="n">ExpectedMacroClose</span>
    <span class="o">|</span> <span class="n">ExpectedMacroVar</span> <span class="o">|</span> <span class="n">ExpectedMacroTypeVar</span> <span class="o">|</span> <span class="n">ExpectedMacroTypeLitVar</span> 
    <span class="o">|</span> <span class="n">ExpectedEscapedChar</span> <span class="n">of</span> <span class="n">is_term_macro</span> <span class="p">:</span> <span class="nb">bool</span>
    <span class="o">|</span> <span class="n">ExpectedText</span> <span class="o">|</span> <span class="n">ExpectedUnescapedChar</span>
    <span class="o">|</span> <span class="n">ExpectedOperator</span><span class="s1">'</span>
    <span class="o">|</span> <span class="n">ExpectedOperator</span> <span class="n">of</span> <span class="n">string</span>
    <span class="o">|</span> <span class="n">ExpectedUnaryOperator</span><span class="s1">'</span>
    <span class="o">|</span> <span class="n">ExpectedUnaryOperator</span> <span class="n">of</span> <span class="n">string</span>
    <span class="o">|</span> <span class="n">ExpectedUnit</span>
    <span class="o">|</span> <span class="n">ExpectedVar</span>
    <span class="o">|</span> <span class="n">ExpectedVarOrOpAsNameOfRecStatement</span>
    <span class="o">|</span> <span class="n">ExpectedVarOrOpAsNameOfGlobalStatement</span>
    <span class="o">|</span> <span class="n">ExpectedSmallVar</span>
    <span class="o">|</span> <span class="n">ExpectedBigVar</span>
    <span class="o">|</span> <span class="n">ExpectedLit</span>
    <span class="o">|</span> <span class="n">ExpectedSymbolPaired</span>
    <span class="o">|</span> <span class="n">SymbolPairedShouldStartWithUppercaseInTypeScope</span>
    <span class="o">|</span> <span class="n">ExpectedSymbol</span>
    <span class="o">|</span> <span class="n">ExpectedParenthesis</span> <span class="n">of</span> <span class="n">Parenthesis</span> <span class="o">*</span> <span class="n">ParenthesisState</span>
    <span class="o">|</span> <span class="n">ExpectedMacroExpression</span> <span class="n">of</span> <span class="n">MacroEnum</span> <span class="o">*</span> <span class="n">ParenthesisState</span>
    <span class="o">|</span> <span class="n">ExpectedOpenParenthesis</span>
    <span class="o">|</span> <span class="n">ExpectedStatement</span>
    <span class="o">|</span> <span class="n">ExpectedEob</span>
    <span class="o">|</span> <span class="n">ExpectedFunctionAsBodyOfRecStatement</span>
    <span class="o">|</span> <span class="n">ExpectedSinglePatternWhenStatementNameIsNorVarOrOp</span>
    <span class="o">|</span> <span class="n">ExpectedGlobalFunction</span>
    <span class="o">|</span> <span class="n">ExpectedExpression</span>
    <span class="o">|</span> <span class="n">InbuiltOpNotFound</span>
    <span class="o">|</span> <span class="n">UnknownOperator</span>
    <span class="o">|</span> <span class="n">UnexpectedEob</span>
    <span class="o">|</span> <span class="n">UnexpectedAndInlRec</span>
    <span class="o">|</span> <span class="n">ForallNotAllowed</span>
    <span class="o">|</span> <span class="n">TypecaseNotAllowed</span>
    <span class="o">|</span> <span class="n">MetavarNotAllowed</span>
    <span class="o">|</span> <span class="n">TermNotAllowed</span>
    <span class="o">|</span> <span class="n">UnknownError</span>
    <span class="o">|</span> <span class="n">DuplicateRecordTypeVar</span>
    <span class="o">|</span> <span class="n">DuplicateForallVar</span>
    <span class="o">|</span> <span class="n">DuplicateExistsVar</span>
    <span class="o">|</span> <span class="n">DuplicateConstraint</span>
    <span class="o">|</span> <span class="n">DuplicateTermRecordSymbol</span>
    <span class="o">|</span> <span class="n">DuplicateTermRecordInjection</span>
    <span class="o">|</span> <span class="n">DuplicateRecFunctionName</span>
    <span class="o">|</span> <span class="n">BottomUpNumberParseError</span> <span class="n">of</span> <span class="n">string</span> <span class="o">*</span> <span class="n">string</span>
    <span class="o">|</span> <span class="n">ExpectedPairedSymbolInUnion</span>
    <span class="o">|</span> <span class="n">DuplicateUnionKey</span>
    <span class="o">|</span> <span class="n">MetavarShadowedByVar</span>
    <span class="o">|</span> <span class="n">VarShadowedByMetavar</span>
    <span class="o">|</span> <span class="n">ListLiteralsNotAllowedInBottomUp</span>
    <span class="o">|</span> <span class="n">ArrayLiteralsNotAllowedInBottomUp</span>
    <span class="o">|</span> <span class="n">ForallNotAllowedInTypecase</span>
    <span class="o">|</span> <span class="n">ExistsNotAllowedInTypecase</span>

<span class="nb">type</span> <span class="n">RawKindExpr</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">RawKindWildcard</span>
    <span class="o">|</span> <span class="n">RawKindStar</span>
    <span class="o">|</span> <span class="n">RawKindFun</span> <span class="n">of</span> <span class="n">RawKindExpr</span> <span class="o">*</span> <span class="n">RawKindExpr</span>

<span class="nb">type</span> <span class="n">UnionLayout</span> <span class="o">=</span> <span class="n">UStack</span> <span class="o">|</span> <span class="n">UHeap</span>

<span class="nb">type</span> <span class="n">HoVar</span> <span class="o">=</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="p">(</span><span class="n">VarString</span> <span class="o">*</span> <span class="n">RawKindExpr</span><span class="p">)</span>
<span class="nb">type</span> <span class="n">TypeVar</span> <span class="o">=</span> <span class="n">HoVar</span> <span class="o">*</span> <span class="p">(</span><span class="n">VSCRange</span> <span class="o">*</span> <span class="n">VarString</span><span class="p">)</span> <span class="nb">list</span>
<span class="nb">type</span> <span class="n">RawMacro</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">RawMacroText</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">string</span>
    <span class="o">|</span> <span class="n">RawMacroTerm</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">RawExpr</span>
    <span class="o">|</span> <span class="n">RawMacroType</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">RawTExpr</span>
    <span class="o">|</span> <span class="n">RawMacroTypeLit</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">RawTExpr</span>
<span class="ow">and</span> <span class="n">RawRecordWith</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">RawRecordWithSymbol</span> <span class="n">of</span> <span class="p">(</span><span class="n">VSCRange</span> <span class="o">*</span> <span class="n">SymbolString</span><span class="p">)</span> <span class="o">*</span> <span class="n">RawExpr</span>
    <span class="o">|</span> <span class="n">RawRecordWithSymbolModify</span> <span class="n">of</span> <span class="p">(</span><span class="n">VSCRange</span> <span class="o">*</span> <span class="n">SymbolString</span><span class="p">)</span> <span class="o">*</span> <span class="n">RawExpr</span>
    <span class="o">|</span> <span class="n">RawRecordWithInjectVar</span> <span class="n">of</span> <span class="p">(</span><span class="n">VSCRange</span> <span class="o">*</span> <span class="n">VarString</span><span class="p">)</span> <span class="o">*</span> <span class="n">RawExpr</span>
    <span class="o">|</span> <span class="n">RawRecordWithInjectVarModify</span> <span class="n">of</span> <span class="p">(</span><span class="n">VSCRange</span> <span class="o">*</span> <span class="n">VarString</span><span class="p">)</span> <span class="o">*</span> <span class="n">RawExpr</span>
<span class="ow">and</span> <span class="n">RawRecordWithout</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">RawRecordWithoutSymbol</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">SymbolString</span>
    <span class="o">|</span> <span class="n">RawRecordWithoutInjectVar</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">VarString</span>
<span class="ow">and</span> <span class="n">PatRecordMember</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">PatRecordMembersSymbol</span> <span class="n">of</span> <span class="p">(</span><span class="n">VSCRange</span> <span class="o">*</span> <span class="n">SymbolString</span><span class="p">)</span> <span class="o">*</span> <span class="n">name</span><span class="p">:</span> <span class="n">Pattern</span>
    <span class="o">|</span> <span class="n">PatRecordMembersInjectVar</span> <span class="n">of</span> <span class="p">(</span><span class="n">VSCRange</span> <span class="o">*</span> <span class="n">VarString</span><span class="p">)</span> <span class="o">*</span> <span class="n">name</span><span class="p">:</span> <span class="n">Pattern</span>
<span class="ow">and</span> <span class="n">Pattern</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">PatB</span> <span class="n">of</span> <span class="n">VSCRange</span>
    <span class="o">|</span> <span class="n">PatE</span> <span class="n">of</span> <span class="n">VSCRange</span>
    <span class="o">|</span> <span class="n">PatVar</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">VarString</span>
    <span class="o">|</span> <span class="n">PatDyn</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">Pattern</span>
    <span class="o">|</span> <span class="n">PatUnbox</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">symbol</span><span class="p">:</span> <span class="n">string</span> <span class="o">*</span> <span class="n">Pattern</span>
    <span class="o">|</span> <span class="n">PatExists</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="p">(</span><span class="n">VSCRange</span> <span class="o">*</span> <span class="n">VarString</span><span class="p">)</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">Pattern</span>
    <span class="o">|</span> <span class="n">PatAnnot</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">Pattern</span> <span class="o">*</span> <span class="n">RawTExpr</span>
    <span class="o">|</span> <span class="n">PatPair</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">Pattern</span> <span class="o">*</span> <span class="n">Pattern</span>
    <span class="o">|</span> <span class="n">PatSymbol</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">string</span>
    <span class="o">|</span> <span class="n">PatRecordMembers</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">PatRecordMember</span> <span class="nb">list</span>
    <span class="o">|</span> <span class="n">PatOr</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">Pattern</span> <span class="o">*</span> <span class="n">Pattern</span>
    <span class="o">|</span> <span class="n">PatAnd</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">Pattern</span> <span class="o">*</span> <span class="n">Pattern</span>
    <span class="o">|</span> <span class="n">PatValue</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">Literal</span>
    <span class="o">|</span> <span class="n">PatDefaultValue</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">VarString</span>
    <span class="o">|</span> <span class="n">PatWhen</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">Pattern</span> <span class="o">*</span> <span class="n">RawExpr</span>
    <span class="o">|</span> <span class="n">PatNominal</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="p">(</span><span class="n">VSCRange</span> <span class="o">*</span> <span class="n">VarString</span><span class="p">)</span> <span class="o">*</span>  <span class="p">(</span><span class="n">VSCRange</span> <span class="o">*</span> <span class="n">VarString</span><span class="p">)</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">Pattern</span>
    <span class="o">|</span> <span class="n">PatArray</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">Pattern</span> <span class="nb">list</span>
    <span class="o">|</span> <span class="n">PatFilledDefaultValue</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">VarString</span> <span class="o">*</span> <span class="n">RawTExpr</span> <span class="o">//</span> <span class="n">Filled</span> <span class="ow">in</span> <span class="n">by</span> <span class="n">the</span> <span class="n">inferencer</span><span class="o">.</span>
<span class="ow">and</span> <span class="n">RawExpr</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">RawB</span> <span class="n">of</span> <span class="n">VSCRange</span>
    <span class="o">|</span> <span class="n">RawV</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">VarString</span> <span class="o">*</span> <span class="n">is_tvar_applied</span> <span class="p">:</span> <span class="nb">bool</span>
    <span class="o">|</span> <span class="n">RawLit</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">Literal</span>
    <span class="o">|</span> <span class="n">RawDefaultLit</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">string</span>
    <span class="o">|</span> <span class="n">RawSymbol</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">SymbolString</span>
    <span class="o">|</span> <span class="n">RawType</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">RawTExpr</span>
    <span class="o">|</span> <span class="n">RawMatch</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">body</span><span class="p">:</span> <span class="n">RawExpr</span> <span class="o">*</span> <span class="p">(</span><span class="n">Pattern</span> <span class="o">*</span> <span class="n">RawExpr</span><span class="p">)</span> <span class="nb">list</span>
    <span class="o">|</span> <span class="n">RawFun</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="p">(</span><span class="n">Pattern</span> <span class="o">*</span> <span class="n">RawExpr</span><span class="p">)</span> <span class="nb">list</span>
    <span class="o">|</span> <span class="n">RawForall</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">TypeVar</span> <span class="o">*</span> <span class="n">RawExpr</span>
    <span class="o">|</span> <span class="n">RawExists</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="p">(</span><span class="n">VSCRange</span> <span class="o">*</span> <span class="n">RawTExpr</span> <span class="nb">list</span> <span class="n">option</span><span class="p">)</span> <span class="o">*</span> <span class="n">RawExpr</span>
    <span class="o">|</span> <span class="n">RawRecBlock</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="p">((</span><span class="n">VSCRange</span> <span class="o">*</span> <span class="n">VarString</span><span class="p">)</span> <span class="o">*</span> <span class="n">RawExpr</span><span class="p">)</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">on_succ</span><span class="p">:</span> <span class="n">RawExpr</span> <span class="o">//</span> <span class="n">The</span> <span class="n">bodies</span> <span class="n">of</span> <span class="n">a</span> <span class="n">block</span> <span class="n">must</span> <span class="n">be</span> <span class="n">RawFun</span> <span class="ow">or</span> <span class="n">RawForall</span><span class="o">.</span>
    <span class="o">|</span> <span class="n">RawRecordWith</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">RawExpr</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">RawRecordWith</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">RawRecordWithout</span> <span class="nb">list</span>
    <span class="o">|</span> <span class="n">RawOp</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">Op</span> <span class="o">*</span> <span class="n">RawExpr</span> <span class="nb">list</span>
    <span class="o">|</span> <span class="n">RawJoinPoint</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">backend</span><span class="p">:</span> <span class="p">(</span><span class="n">VSCRange</span> <span class="o">*</span> <span class="n">string</span><span class="p">)</span> <span class="n">option</span> <span class="o">*</span> <span class="n">RawExpr</span> <span class="o">*</span> <span class="n">name</span><span class="p">:</span> <span class="n">string</span> <span class="n">option</span>
    <span class="o">|</span> <span class="n">RawAnnot</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">RawExpr</span> <span class="o">*</span> <span class="n">RawTExpr</span>
    <span class="o">|</span> <span class="n">RawTypecase</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">RawTExpr</span> <span class="o">*</span> <span class="p">(</span><span class="n">RawTExpr</span> <span class="o">*</span> <span class="n">RawExpr</span><span class="p">)</span> <span class="nb">list</span>
    <span class="o">|</span> <span class="n">RawOpen</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="p">(</span><span class="n">VSCRange</span> <span class="o">*</span> <span class="n">VarString</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">VSCRange</span> <span class="o">*</span> <span class="n">SymbolString</span><span class="p">)</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">on_succ</span><span class="p">:</span> <span class="n">RawExpr</span>
    <span class="o">|</span> <span class="n">RawApply</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">RawExpr</span> <span class="o">*</span> <span class="n">RawExpr</span>
    <span class="o">|</span> <span class="n">RawIfThenElse</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">RawExpr</span> <span class="o">*</span> <span class="n">RawExpr</span> <span class="o">*</span> <span class="n">RawExpr</span>
    <span class="o">|</span> <span class="n">RawIfThen</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">RawExpr</span> <span class="o">*</span> <span class="n">RawExpr</span>
    <span class="o">|</span> <span class="n">RawPair</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">RawExpr</span> <span class="o">*</span> <span class="n">RawExpr</span>
    <span class="o">|</span> <span class="n">RawSeq</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">RawExpr</span> <span class="o">*</span> <span class="n">RawExpr</span>
    <span class="o">|</span> <span class="n">RawHeapMutableSet</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">RawExpr</span> <span class="o">*</span> <span class="n">RawExpr</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">RawExpr</span>
    <span class="o">|</span> <span class="n">RawReal</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">RawExpr</span>
    <span class="o">|</span> <span class="n">RawMacro</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">RawMacro</span> <span class="nb">list</span>
    <span class="o">|</span> <span class="n">RawArray</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">RawExpr</span> <span class="nb">list</span>
    <span class="o">|</span> <span class="n">RawMissingBody</span> <span class="n">of</span> <span class="n">VSCRange</span>
    <span class="o">|</span> <span class="n">RawFilledForall</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">string</span> <span class="o">*</span> <span class="n">RawExpr</span> <span class="o">//</span> <span class="n">Filled</span> <span class="ow">in</span> <span class="n">by</span> <span class="n">the</span> <span class="n">inferencer</span><span class="o">.</span>
<span class="ow">and</span> <span class="n">RawTExpr</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">RawTWildcard</span> <span class="n">of</span> <span class="n">VSCRange</span>
    <span class="o">|</span> <span class="n">RawTB</span> <span class="n">of</span> <span class="n">VSCRange</span>
    <span class="o">|</span> <span class="n">RawTMetaVar</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">VarString</span>
    <span class="o">|</span> <span class="n">RawTLit</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">Literal</span>
    <span class="o">|</span> <span class="n">RawTVar</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">VarString</span>
    <span class="o">|</span> <span class="n">RawTPair</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">RawTExpr</span> <span class="o">*</span> <span class="n">RawTExpr</span>
    <span class="o">|</span> <span class="n">RawTFun</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">RawTExpr</span> <span class="o">*</span> <span class="n">RawTExpr</span> <span class="o">*</span> <span class="n">FunType</span>
    <span class="o">|</span> <span class="n">RawTArray</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">RawTExpr</span>
    <span class="o">|</span> <span class="n">RawTRecord</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">Map</span><span class="o">&lt;</span><span class="nb">int</span> <span class="o">*</span> <span class="n">string</span><span class="p">,</span><span class="n">RawTExpr</span><span class="o">&gt;</span>
    <span class="o">|</span> <span class="n">RawTSymbol</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">SymbolString</span>
    <span class="o">|</span> <span class="n">RawTApply</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">RawTExpr</span> <span class="o">*</span> <span class="n">RawTExpr</span>
    <span class="o">|</span> <span class="n">RawTForall</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">TypeVar</span> <span class="o">*</span> <span class="n">RawTExpr</span>
    <span class="o">|</span> <span class="n">RawTExists</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">TypeVar</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">RawTExpr</span>
    <span class="o">|</span> <span class="n">RawTPrim</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">PrimitiveType</span>
    <span class="o">|</span> <span class="n">RawTTerm</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">RawExpr</span>
    <span class="o">|</span> <span class="n">RawTMacro</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">RawMacro</span> <span class="nb">list</span>
    <span class="o">|</span> <span class="n">RawTUnion</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">Map</span><span class="o">&lt;</span><span class="nb">int</span> <span class="o">*</span> <span class="n">string</span><span class="p">,</span><span class="nb">bool</span> <span class="o">*</span> <span class="n">RawTExpr</span><span class="o">&gt;</span> <span class="o">*</span> <span class="n">UnionLayout</span> <span class="o">*</span> <span class="n">this</span><span class="p">:</span> <span class="n">RawTExpr</span>  <span class="o">//</span> <span class="n">The</span> <span class="n">boolean</span> <span class="n">arg</span> <span class="n">determines</span> <span class="n">whether</span> <span class="n">the</span> <span class="n">union</span> <span class="n">case</span> <span class="ow">is</span> <span class="n">generalized</span><span class="o">.</span> <span class="err">`</span><span class="n">this</span><span class="err">`</span> <span class="ow">is</span> <span class="n">the</span> <span class="bp">self</span> <span class="nb">type</span><span class="o">.</span>
    <span class="o">|</span> <span class="n">RawTLayout</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">RawTExpr</span> <span class="o">*</span> <span class="n">Layout</span>
    <span class="o">|</span> <span class="n">RawTTypecase</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">RawTExpr</span> <span class="o">*</span> <span class="p">(</span><span class="n">RawTExpr</span> <span class="o">*</span> <span class="n">RawTExpr</span><span class="p">)</span> <span class="nb">list</span>
    <span class="o">|</span> <span class="n">RawTFilledNominal</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">GlobalId</span> <span class="o">//</span> <span class="n">Filled</span> <span class="ow">in</span> <span class="n">by</span> <span class="n">the</span> <span class="n">inferencer</span><span class="o">.</span>

<span class="n">let</span> <span class="p">(</span><span class="o">+.</span><span class="p">)</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">=</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span>
<span class="n">let</span> <span class="n">range_of_hovar</span> <span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="p">:</span> <span class="n">HoVar</span><span class="p">)</span> <span class="o">=</span> <span class="n">r</span>
<span class="n">let</span> <span class="n">range_of_typevar</span> <span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="p">:</span> <span class="n">TypeVar</span><span class="p">)</span> <span class="o">=</span> <span class="n">range_of_hovar</span> <span class="n">x</span>
<span class="n">let</span> <span class="n">hovar_name</span> <span class="p">((</span><span class="n">_</span><span class="p">,(</span><span class="n">name</span><span class="p">,</span><span class="n">_</span><span class="p">))</span> <span class="p">:</span> <span class="n">HoVar</span><span class="p">)</span> <span class="o">=</span> <span class="n">name</span>
<span class="n">let</span> <span class="n">typevar_name</span> <span class="p">((</span><span class="n">h</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="p">:</span> <span class="n">TypeVar</span><span class="p">)</span> <span class="o">=</span> <span class="n">hovar_name</span> <span class="n">h</span>
<span class="n">let</span> <span class="n">range_of_record_with</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">RawRecordWithSymbol</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">),</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawRecordWithSymbolModify</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">),</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawRecordWithInjectVar</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">),</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawRecordWithInjectVarModify</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">),</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">r</span>
<span class="n">let</span> <span class="n">range_of_record_without</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">RawRecordWithoutSymbol</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawRecordWithoutInjectVar</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">r</span>
<span class="n">let</span> <span class="n">range_of_pattern</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">PatB</span> <span class="n">r</span>
    <span class="o">|</span> <span class="n">PatE</span> <span class="n">r</span>
    <span class="o">|</span> <span class="n">PatVar</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">PatDyn</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">PatUnbox</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">PatExists</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">PatSymbol</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">PatValue</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">PatDefaultValue</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">PatRecordMembers</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">PatArray</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">PatAnnot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">PatPair</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">PatOr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">PatAnd</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">PatWhen</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">PatFilledDefaultValue</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">PatNominal</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">r</span>
<span class="n">let</span> <span class="n">range_of_pat_record_member</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">PatRecordMembersSymbol</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">),</span><span class="n">x</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">PatRecordMembersInjectVar</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">),</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">r</span> <span class="o">+.</span> <span class="n">range_of_pattern</span> <span class="n">x</span>
<span class="n">let</span> <span class="n">range_of_expr</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">RawB</span> <span class="n">r</span>
    <span class="o">|</span> <span class="n">RawMissingBody</span> <span class="n">r</span>
    <span class="o">|</span> <span class="n">RawMacro</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawV</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawLit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawDefaultLit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawSymbol</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawType</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawJoinPoint</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawArray</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawMatch</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawFun</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawReal</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawRecBlock</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawOp</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawAnnot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawTypecase</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawForall</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawExists</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawFilledForall</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawApply</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawPair</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawIfThen</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawSeq</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawHeapMutableSet</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawRecordWith</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawIfThenElse</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawOpen</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">r</span>

<span class="n">let</span> <span class="n">rawv</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">=</span> <span class="n">RawV</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">true</span><span class="p">)</span>
    
<span class="n">let</span> <span class="n">range_of_texpr</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">RawTWildcard</span> <span class="n">r</span>
    <span class="o">|</span> <span class="n">RawTB</span> <span class="n">r</span>
    <span class="o">|</span> <span class="n">RawTLit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawTMacro</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawTMetaVar</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawTVar</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawTArray</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawTRecord</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawTUnion</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawTSymbol</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawTPrim</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawTTerm</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawTFilledNominal</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawTPair</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawTFun</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawTApply</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawTLayout</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawTExists</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawTTypecase</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawTForall</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">r</span>

<span class="n">let</span> <span class="n">rec</span> <span class="n">range_of_texpr_gadt_constructor</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">RawTForall</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">range_of_texpr_gadt_constructor</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">RawTFun</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">range_of_texpr</span> <span class="n">x</span>

<span class="n">let</span> <span class="n">rec</span> <span class="n">range_of_texpr_gadt_body</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">RawTForall</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">range_of_texpr_gadt_body</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">RawTFun</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">range_of_texpr</span> <span class="n">x</span>

<span class="nb">type</span> <span class="n">VectorCord</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span><span class="n">row</span> <span class="p">:</span> <span class="nb">int</span><span class="p">;</span> <span class="n">col</span> <span class="p">:</span> <span class="nb">int</span><span class="o">|</span><span class="p">}</span>
<span class="nb">type</span> <span class="n">Env__</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">semantic_updates</span> <span class="p">:</span> <span class="p">(</span><span class="n">VectorCord</span> <span class="o">*</span> <span class="n">SemanticTokenLegend</span><span class="p">)</span> <span class="n">ResizeArray</span>
    <span class="n">tokens_cords</span> <span class="p">:</span> <span class="n">VectorCord</span> <span class="p">[]</span>
    <span class="n">tokens</span> <span class="p">:</span> <span class="p">(</span><span class="n">VSCRange</span> <span class="o">*</span> <span class="n">SpiralToken</span><span class="p">)</span> <span class="p">[]</span>
    <span class="n">comments</span> <span class="p">:</span> <span class="n">LineComment</span> <span class="n">option</span> <span class="p">[]</span>
    <span class="n">i</span> <span class="p">:</span> <span class="nb">int</span> <span class="n">ref</span>
    <span class="n">is_top_down</span> <span class="p">:</span> <span class="nb">bool</span>
    <span class="n">default_env</span> <span class="p">:</span> <span class="n">DefaultEnv</span>
    <span class="p">}</span> <span class="k">with</span>

    <span class="n">member</span> <span class="n">d</span><span class="o">.</span><span class="n">Index</span> <span class="k">with</span> <span class="n">get</span><span class="p">()</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">i</span><span class="o">.</span><span class="n">contents</span> <span class="ow">and</span> <span class="nb">set</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">i</span><span class="o">.</span><span class="n">Value</span> <span class="o">&lt;-</span> <span class="n">i</span>
<span class="nb">type</span> <span class="n">BlockParsingEnv</span> <span class="o">=</span> <span class="n">Env__</span>

<span class="n">let</span> <span class="n">inline</span> <span class="n">try_current_template</span> <span class="p">(</span><span class="n">d</span> <span class="p">:</span> <span class="n">BlockParsingEnv</span><span class="p">)</span> <span class="n">on_succ</span> <span class="n">on_fail</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">i</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">Index</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">d</span><span class="o">.</span><span class="n">tokens</span><span class="o">.</span><span class="n">Length</span> <span class="n">then</span> <span class="n">on_succ</span> <span class="n">d</span><span class="o">.</span><span class="n">tokens</span><span class="o">.</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">else</span> <span class="n">on_fail</span><span class="p">()</span>

<span class="n">let</span> <span class="n">inline</span> <span class="n">try_current</span> <span class="n">d</span> <span class="n">f</span> <span class="o">=</span> <span class="n">try_current_template</span> <span class="n">d</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="o">.</span><span class="n">Error</span> <span class="p">[])</span>
<span class="n">let</span> <span class="n">print_current</span> <span class="n">d</span> <span class="o">=</span> <span class="n">try_current</span> <span class="n">d</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">printfn</span> <span class="s2">"%A"</span> <span class="n">x</span><span class="p">;</span> <span class="n">Ok</span><span class="p">())</span> <span class="o">//</span> <span class="n">For</span> <span class="n">parser</span> <span class="n">debugging</span> <span class="n">purposes</span><span class="o">.</span>
<span class="n">let</span> <span class="n">inline</span> <span class="n">line_template</span> <span class="n">d</span> <span class="n">f</span> <span class="o">=</span> <span class="n">try_current_template</span> <span class="n">d</span> <span class="p">(</span><span class="n">fst</span> <span class="o">&gt;&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">let</span> <span class="n">col</span> <span class="n">d</span> <span class="o">=</span> <span class="n">line_template</span> <span class="n">d</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">r</span><span class="o">.</span><span class="n">character</span><span class="p">)</span>
<span class="n">let</span> <span class="n">lineBlockParsing</span> <span class="n">d</span> <span class="o">=</span> <span class="n">line_template</span> <span class="n">d</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">r</span><span class="o">.</span><span class="n">line</span><span class="p">)</span>

<span class="n">let</span> <span class="n">skip</span><span class="s1">' (d : BlockParsingEnv) i = d.i.Value &lt;- d.i.contents+i</span>
<span class="n">let</span> <span class="n">skipBlockParsing</span> <span class="n">d</span> <span class="o">=</span> <span class="n">skip</span><span class="s1">' d 1</span>

<span class="n">let</span> <span class="n">skip_string_open</span> <span class="n">d</span> <span class="o">=</span>
    <span class="n">try_current</span> <span class="n">d</span> <span class="o">&lt;|</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span><span class="n">TokStringOpen</span> <span class="o">-&gt;</span> <span class="n">skipBlockParsing</span> <span class="n">d</span><span class="p">;</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="o">.</span><span class="n">Error</span> <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">ExpectedStringOpen</span><span class="p">]</span>

<span class="n">let</span> <span class="n">skip_string_close</span> <span class="n">d</span> <span class="o">=</span>
    <span class="n">try_current</span> <span class="n">d</span> <span class="o">&lt;|</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span><span class="n">TokStringClose</span> <span class="o">-&gt;</span> <span class="n">skipBlockParsing</span> <span class="n">d</span><span class="p">;</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="o">.</span><span class="n">Error</span> <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">ExpectedStringClose</span><span class="p">]</span>

<span class="n">let</span> <span class="n">skip_macro_open</span> <span class="n">d</span> <span class="o">=</span>
    <span class="n">try_current</span> <span class="n">d</span> <span class="o">&lt;|</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span><span class="n">TokMacroOpen</span> <span class="o">-&gt;</span> <span class="n">skipBlockParsing</span> <span class="n">d</span><span class="p">;</span> <span class="n">Ok</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="o">.</span><span class="n">Error</span> <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">ExpectedMacroOpen</span><span class="p">]</span>

<span class="n">let</span> <span class="n">skip_macro_close</span> <span class="n">d</span> <span class="o">=</span>
    <span class="n">try_current</span> <span class="n">d</span> <span class="o">&lt;|</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span><span class="n">TokMacroClose</span> <span class="o">-&gt;</span> <span class="n">skipBlockParsing</span> <span class="n">d</span><span class="p">;</span> <span class="n">Ok</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="o">.</span><span class="n">Error</span> <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">ExpectedMacroClose</span><span class="p">]</span>

<span class="n">let</span> <span class="n">read_text</span> <span class="n">is_term_macro</span> <span class="n">d</span> <span class="o">=</span>
    <span class="n">let</span> <span class="p">(</span><span class="o">+.</span><span class="p">)</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span>
        <span class="k">match</span> <span class="n">a</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">Some</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">Some</span> <span class="p">(</span><span class="n">a</span> <span class="o">+.</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">Some</span> <span class="n">b</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="p">(</span><span class="n">a</span> <span class="p">:</span> <span class="n">VSCRange</span> <span class="n">option</span><span class="p">)</span> <span class="p">(</span><span class="nb">str</span> <span class="p">:</span> <span class="n">System</span><span class="o">.</span><span class="n">Text</span><span class="o">.</span><span class="n">StringBuilder</span><span class="p">)</span> <span class="o">=</span>
        <span class="n">try_current</span> <span class="n">d</span> <span class="o">&lt;|</span> <span class="n">function</span>
            <span class="o">|</span> <span class="n">b</span><span class="p">,</span><span class="n">TokText</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">skipBlockParsing</span> <span class="n">d</span><span class="p">;</span> <span class="n">loop</span> <span class="p">(</span><span class="n">a</span> <span class="o">+.</span> <span class="n">b</span><span class="p">)</span> <span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="o">|</span> <span class="n">b</span><span class="p">,</span><span class="n">TokEscapedVar</span> <span class="n">when</span> <span class="n">is_term_macro</span> <span class="o">-&gt;</span> <span class="n">skipBlockParsing</span> <span class="n">d</span><span class="p">;</span> <span class="n">loop</span> <span class="p">(</span><span class="n">a</span> <span class="o">+.</span> <span class="n">b</span><span class="p">)</span> <span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="s2">"</span><span class="se">\\</span><span class="s2">v"</span><span class="p">))</span>
            <span class="o">|</span> <span class="n">b</span><span class="p">,(</span><span class="n">TokEscapedChar</span> <span class="n">x</span> <span class="o">|</span> <span class="n">TokUnescapedChar</span> <span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">skipBlockParsing</span> <span class="n">d</span><span class="p">;</span> <span class="n">loop</span> <span class="p">(</span><span class="n">a</span> <span class="o">+.</span> <span class="n">b</span><span class="p">)</span> <span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="o">|</span> <span class="n">b</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> 
                <span class="k">if</span> <span class="n">Option</span><span class="o">.</span><span class="n">isNone</span> <span class="n">a</span> <span class="n">then</span> <span class="n">Result</span><span class="o">.</span><span class="n">Error</span> <span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">ExpectedText</span><span class="p">;</span> <span class="n">b</span><span class="p">,</span> <span class="n">ExpectedEscapedChar</span> <span class="n">is_term_macro</span><span class="p">;</span> <span class="n">b</span><span class="p">,</span> <span class="n">ExpectedUnescapedChar</span><span class="p">]</span>
                <span class="k">else</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span><span class="p">(</span><span class="n">Option</span><span class="o">.</span><span class="n">get</span> <span class="n">a</span><span class="p">,</span> <span class="nb">str</span><span class="o">.</span><span class="n">ToString</span><span class="p">())</span>
    <span class="n">loop</span> <span class="kc">None</span> <span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">Text</span><span class="o">.</span><span class="n">StringBuilder</span><span class="p">())</span>

<span class="n">let</span> <span class="n">read_macro_var</span> <span class="n">d</span> <span class="o">=</span>
    <span class="n">try_current</span> <span class="n">d</span> <span class="o">&lt;|</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">TokMacroTermVar</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">skipBlockParsing</span> <span class="n">d</span><span class="p">;</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span><span class="p">(</span><span class="n">RawMacroTerm</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">rawv</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">x</span><span class="p">)))</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">TokMacroTypeVar</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">skipBlockParsing</span> <span class="n">d</span><span class="p">;</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span><span class="p">(</span><span class="n">RawMacroType</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">RawTVar</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">x</span><span class="p">)))</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">TokMacroTypeLitVar</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">skipBlockParsing</span> <span class="n">d</span><span class="p">;</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span><span class="p">(</span><span class="n">RawMacroTypeLit</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">RawTVar</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">x</span><span class="p">)))</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span><span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">ExpectedMacroVar</span><span class="p">]</span>
    
<span class="n">let</span> <span class="n">read_macro_type_var</span> <span class="n">d</span> <span class="o">=</span>
    <span class="n">try_current</span> <span class="n">d</span> <span class="o">&lt;|</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">TokMacroTypeVar</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">skipBlockParsing</span> <span class="n">d</span><span class="p">;</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span><span class="p">(</span><span class="n">RawMacroType</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">RawTVar</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">x</span><span class="p">)))</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">TokMacroTypeLitVar</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">skipBlockParsing</span> <span class="n">d</span><span class="p">;</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span><span class="p">(</span><span class="n">RawMacroTypeLit</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">RawTVar</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">x</span><span class="p">)))</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span><span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">ExpectedMacroTypeVar</span><span class="p">]</span>

<span class="n">let</span> <span class="n">skip_keyword</span> <span class="n">t</span> <span class="n">d</span> <span class="o">=</span>
    <span class="n">try_current</span> <span class="n">d</span> <span class="o">&lt;|</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span><span class="n">TokKeyword</span> <span class="n">t</span><span class="s1">' when t = t'</span> <span class="o">-&gt;</span> <span class="n">skipBlockParsing</span> <span class="n">d</span><span class="p">;</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span> <span class="n">t</span><span class="s1">'</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">ExpectedKeyword</span> <span class="n">t</span><span class="p">]</span>

<span class="n">let</span> <span class="n">skip_keyword</span><span class="s1">' t d =</span>
    <span class="n">try_current</span> <span class="n">d</span> <span class="o">&lt;|</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span><span class="n">TokKeyword</span> <span class="n">t</span><span class="s1">' when t = t'</span> <span class="o">-&gt;</span> <span class="n">skipBlockParsing</span> <span class="n">d</span><span class="p">;</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span> <span class="n">p</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">ExpectedKeyword</span> <span class="n">t</span><span class="p">]</span>

<span class="n">let</span> <span class="n">read_unary_op</span> <span class="n">d</span> <span class="o">=</span>
    <span class="n">try_current</span> <span class="n">d</span> <span class="o">&lt;|</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">TokUnaryOperator</span><span class="p">(</span><span class="n">t</span><span class="s1">',_) -&gt; skipBlockParsing d; Result.Ok t'</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">ExpectedUnaryOperator</span><span class="s1">']</span>

<span class="n">let</span> <span class="n">read_unary_op</span><span class="s1">' d =</span>
    <span class="n">try_current</span> <span class="n">d</span> <span class="o">&lt;|</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">TokUnaryOperator</span><span class="p">(</span><span class="n">t</span><span class="s1">',_) -&gt; skipBlockParsing d; Result.Ok(p,t'</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">ExpectedUnaryOperator</span><span class="s1">']</span>

<span class="n">let</span> <span class="n">read_op</span> <span class="n">d</span> <span class="o">=</span>
    <span class="n">try_current</span> <span class="n">d</span> <span class="o">&lt;|</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">TokOperator</span><span class="p">(</span><span class="n">t</span><span class="s1">',_) -&gt; skipBlockParsing d; Result.Ok t'</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">ExpectedOperator</span><span class="s1">']</span>

<span class="n">let</span> <span class="n">read_op</span><span class="s1">' d =</span>
    <span class="n">try_current</span> <span class="n">d</span> <span class="o">&lt;|</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">TokOperator</span><span class="p">(</span><span class="n">t</span><span class="s1">',_) -&gt; skipBlockParsing d; Result.Ok(p,t'</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">ExpectedOperator</span><span class="s1">']</span>

<span class="n">let</span> <span class="n">update_semantic</span> <span class="p">(</span><span class="n">d</span> <span class="p">:</span> <span class="n">BlockParsingEnv</span><span class="p">)</span> <span class="o">=</span> <span class="n">let</span> <span class="n">i</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">Index</span> <span class="ow">in</span> <span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">d</span><span class="o">.</span><span class="n">semantic_updates</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">tokens_cords</span><span class="o">.</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">x</span><span class="p">)</span>
<span class="n">let</span> <span class="n">read_op_type</span> <span class="n">d</span> <span class="o">=</span>
    <span class="n">try_current</span> <span class="n">d</span> <span class="o">&lt;|</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">TokOperator</span><span class="p">(</span><span class="n">t</span><span class="s1">',r) -&gt; update_semantic d SemanticTokenLegend.type_variable; skipBlockParsing d; Result.Ok(p,t'</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">ExpectedOperator</span><span class="s1">']</span>

<span class="n">let</span> <span class="n">skip_op</span> <span class="n">t</span> <span class="n">d</span> <span class="o">=</span>
    <span class="n">try_current</span> <span class="n">d</span> <span class="o">&lt;|</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">TokOperator</span><span class="p">(</span><span class="n">t</span><span class="s1">',_) when t'</span> <span class="o">=</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">skipBlockParsing</span> <span class="n">d</span><span class="p">;</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span> <span class="n">p</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">ExpectedOperator</span> <span class="n">t</span><span class="p">]</span>

<span class="n">let</span> <span class="n">skip_unary_op</span> <span class="n">t</span> <span class="n">d</span> <span class="o">=</span>
    <span class="n">try_current</span> <span class="n">d</span> <span class="o">&lt;|</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">TokUnaryOperator</span><span class="p">(</span><span class="n">t</span><span class="s1">',_) when t'</span> <span class="o">=</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">skipBlockParsing</span> <span class="n">d</span><span class="p">;</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span> <span class="n">t</span><span class="s1">'</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">ExpectedUnaryOperator</span> <span class="n">t</span><span class="p">]</span>

<span class="n">let</span> <span class="n">read_var</span> <span class="n">d</span> <span class="o">=</span>
    <span class="n">try_current</span> <span class="n">d</span> <span class="o">&lt;|</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">TokVar</span><span class="p">(</span><span class="n">t</span><span class="s1">',_) -&gt; skipBlockParsing d; Result.Ok t'</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">ExpectedVar</span><span class="p">]</span>

<span class="n">let</span> <span class="n">read_var</span><span class="s1">' d =</span>
    <span class="n">try_current</span> <span class="n">d</span> <span class="o">&lt;|</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">TokVar</span><span class="p">(</span><span class="n">t</span><span class="s1">',_) -&gt; let r = update_semantic d in skipBlockParsing d; Result.Ok(p,t'</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">ExpectedVar</span><span class="p">]</span>

<span class="n">let</span> <span class="n">read_var</span><span class="s1">''</span> <span class="n">d</span> <span class="o">=</span>
    <span class="n">try_current</span> <span class="n">d</span> <span class="o">&lt;|</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">TokVar</span><span class="p">(</span><span class="n">t</span><span class="s1">',_) -&gt; skipBlockParsing d; Result.Ok(p,t'</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">ExpectedVar</span><span class="p">]</span>

<span class="n">let</span> <span class="n">read_big_var</span> <span class="n">d</span> <span class="o">=</span>
    <span class="n">try_current</span> <span class="n">d</span> <span class="o">&lt;|</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">TokVar</span><span class="p">(</span><span class="n">t</span><span class="s1">',_) when System.Char.IsUpper(t'</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">skipBlockParsing</span> <span class="n">d</span><span class="p">;</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">t</span><span class="s1">')</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">ExpectedBigVar</span><span class="p">]</span>

<span class="n">let</span> <span class="n">read_var_as_symbol</span> <span class="n">d</span> <span class="o">=</span>
    <span class="n">try_current</span> <span class="n">d</span> <span class="o">&lt;|</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">TokVar</span><span class="p">(</span><span class="n">t</span><span class="s1">',_) -&gt; update_semantic d SemanticTokenLegend.symbol; skipBlockParsing d; Result.Ok t'</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">ExpectedVar</span><span class="p">]</span>

<span class="n">let</span> <span class="n">read_big_var_as_symbol</span> <span class="n">d</span> <span class="o">=</span>
    <span class="n">try_current</span> <span class="n">d</span> <span class="o">&lt;|</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">TokVar</span><span class="p">(</span><span class="n">t</span><span class="s1">',_) when System.Char.IsUpper(t'</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">update_semantic</span> <span class="n">d</span> <span class="n">SemanticTokenLegend</span><span class="o">.</span><span class="n">symbol</span><span class="p">;</span> <span class="n">skipBlockParsing</span> <span class="n">d</span><span class="p">;</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span> <span class="n">t</span><span class="s1">'</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">ExpectedBigVar</span><span class="p">]</span>

<span class="n">let</span> <span class="n">read_big_var_as_keyword</span> <span class="n">d</span> <span class="o">=</span>
    <span class="n">try_current</span> <span class="n">d</span> <span class="o">&lt;|</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">TokVar</span><span class="p">(</span><span class="n">t</span><span class="s1">',_) when System.Char.IsUpper(t'</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">update_semantic</span> <span class="n">d</span> <span class="n">SemanticTokenLegend</span><span class="o">.</span><span class="n">keyword</span><span class="p">;</span> <span class="n">skipBlockParsing</span> <span class="n">d</span><span class="p">;</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">t</span><span class="s1">')</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">ExpectedBigVar</span><span class="p">]</span>

<span class="n">let</span> <span class="n">read_small_var</span> <span class="n">d</span> <span class="o">=</span>
    <span class="n">try_current</span> <span class="n">d</span> <span class="o">&lt;|</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">TokVar</span><span class="p">(</span><span class="n">t</span><span class="s1">',r) when System.Char.IsUpper(t'</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="n">false</span> <span class="o">-&gt;</span> <span class="n">skipBlockParsing</span> <span class="n">d</span><span class="p">;</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span> <span class="n">t</span><span class="s1">'</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">ExpectedSmallVar</span><span class="p">]</span>

<span class="n">let</span> <span class="n">read_small_var</span><span class="s1">' d =</span>
    <span class="n">try_current</span> <span class="n">d</span> <span class="o">&lt;|</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">TokVar</span><span class="p">(</span><span class="n">t</span><span class="s1">',r) when System.Char.IsUpper(t'</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="n">false</span> <span class="o">-&gt;</span> <span class="n">skipBlockParsing</span> <span class="n">d</span><span class="p">;</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">t</span><span class="s1">')</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">ExpectedSmallVar</span><span class="p">]</span>

<span class="n">let</span> <span class="n">read_big_type_var</span> <span class="n">d</span> <span class="o">=</span>
    <span class="n">try_current</span> <span class="n">d</span> <span class="o">&lt;|</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">TokVar</span><span class="p">(</span><span class="n">t</span><span class="s1">',r) when System.Char.IsUpper(t'</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">update_semantic</span> <span class="n">d</span> <span class="n">SemanticTokenLegend</span><span class="o">.</span><span class="n">type_variable</span><span class="p">;</span> <span class="n">skipBlockParsing</span> <span class="n">d</span><span class="p">;</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span><span class="p">(</span><span class="n">t</span><span class="s1">')</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">ExpectedSmallVar</span><span class="p">]</span>

<span class="n">let</span> <span class="n">read_big_type_var</span><span class="s1">' d =</span>
    <span class="n">try_current</span> <span class="n">d</span> <span class="o">&lt;|</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">TokVar</span><span class="p">(</span><span class="n">t</span><span class="s1">',r) when System.Char.IsUpper(t'</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">update_semantic</span> <span class="n">d</span> <span class="n">SemanticTokenLegend</span><span class="o">.</span><span class="n">type_variable</span><span class="p">;</span> <span class="n">skipBlockParsing</span> <span class="n">d</span><span class="p">;</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">t</span><span class="s1">')</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">ExpectedSmallVar</span><span class="p">]</span>

<span class="n">let</span> <span class="n">read_small_type_var</span> <span class="n">d</span> <span class="o">=</span>
    <span class="n">try_current</span> <span class="n">d</span> <span class="o">&lt;|</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">TokVar</span><span class="p">(</span><span class="n">t</span><span class="s1">',r) when System.Char.IsUpper(t'</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="n">false</span> <span class="o">-&gt;</span> <span class="n">update_semantic</span> <span class="n">d</span> <span class="n">SemanticTokenLegend</span><span class="o">.</span><span class="n">type_variable</span><span class="p">;</span> <span class="n">skipBlockParsing</span> <span class="n">d</span><span class="p">;</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span><span class="p">(</span><span class="n">t</span><span class="s1">')</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">ExpectedSmallVar</span><span class="p">]</span>

<span class="n">let</span> <span class="n">read_small_type_var</span><span class="s1">' d =</span>
    <span class="n">try_current</span> <span class="n">d</span> <span class="o">&lt;|</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">TokVar</span><span class="p">(</span><span class="n">t</span><span class="s1">',r) when System.Char.IsUpper(t'</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="n">false</span> <span class="o">-&gt;</span> <span class="n">update_semantic</span> <span class="n">d</span> <span class="n">SemanticTokenLegend</span><span class="o">.</span><span class="n">type_variable</span><span class="p">;</span> <span class="n">skipBlockParsing</span> <span class="n">d</span><span class="p">;</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">t</span><span class="s1">')</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">ExpectedSmallVar</span><span class="p">]</span>

<span class="n">let</span> <span class="n">read_value</span> <span class="n">d</span> <span class="o">=</span>
    <span class="n">try_current</span> <span class="n">d</span> <span class="o">&lt;|</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">TokValue</span> <span class="n">t</span><span class="s1">' -&gt; </span>
            <span class="n">skipBlockParsing</span> <span class="n">d</span>
            <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">Index</span> <span class="o">&lt;</span> <span class="n">d</span><span class="o">.</span><span class="n">tokens</span><span class="o">.</span><span class="n">Length</span> <span class="n">then</span> 
                <span class="k">match</span> <span class="n">snd</span> <span class="n">d</span><span class="o">.</span><span class="n">tokens</span><span class="o">.</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">Index</span><span class="p">]</span> <span class="k">with</span> 
                <span class="o">|</span> <span class="n">TokValueSuffix</span> <span class="o">-&gt;</span> <span class="n">skipBlockParsing</span> <span class="n">d</span> 
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="p">()</span>
            <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">t</span><span class="s1">')</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">ExpectedLit</span><span class="p">]</span>

<span class="n">let</span> <span class="n">read_symbol</span> <span class="n">d</span> <span class="o">=</span>
    <span class="n">try_current</span> <span class="n">d</span> <span class="o">&lt;|</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">TokSymbol</span><span class="p">(</span><span class="n">t</span><span class="s1">',r) -&gt; skipBlockParsing d; Result.Ok(p,t'</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">ExpectedSymbol</span><span class="p">]</span>

<span class="n">let</span> <span class="n">skip_parenthesis</span> <span class="n">a</span> <span class="n">b</span> <span class="n">d</span> <span class="o">=</span>
    <span class="n">try_current</span> <span class="n">d</span> <span class="o">&lt;|</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">TokParenthesis</span><span class="p">(</span><span class="n">a</span><span class="s1">',b'</span><span class="p">)</span> <span class="n">when</span> <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="s1">' &amp;&amp; b = b'</span> <span class="o">-&gt;</span> <span class="n">skipBlockParsing</span> <span class="n">d</span><span class="p">;</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span><span class="p">()</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">ExpectedParenthesis</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)]</span>

<span class="n">let</span> <span class="n">skip_macro_expression</span> <span class="n">a</span> <span class="n">b</span> <span class="n">d</span> <span class="o">=</span>
    <span class="n">try_current</span> <span class="n">d</span> <span class="o">&lt;|</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">TokMacroExpression</span><span class="p">(</span><span class="n">a</span><span class="s1">',b'</span><span class="p">)</span> <span class="n">when</span> <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="s1">' &amp;&amp; b = b'</span> <span class="o">-&gt;</span> <span class="n">skipBlockParsing</span> <span class="n">d</span><span class="p">;</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span><span class="p">()</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">ExpectedMacroExpression</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)]</span>

<span class="n">let</span> <span class="n">on_succ</span> <span class="n">x</span> <span class="n">_</span> <span class="o">=</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span> <span class="n">x</span>
<span class="o">//</span> <span class="nb">open</span> <span class="n">FParsec</span>
<span class="n">let</span> <span class="n">macro_expression</span> <span class="n">ty</span> <span class="n">a</span> <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">skip_macro_expression</span> <span class="n">ty</span> <span class="n">Open</span> <span class="o">&gt;&gt;.</span> <span class="n">a</span> <span class="o">.&gt;&gt;</span> <span class="n">skip_macro_expression</span> <span class="n">ty</span> <span class="n">Close</span><span class="p">)</span> <span class="n">d</span>
<span class="n">let</span> <span class="n">rounds</span> <span class="n">a</span> <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">skip_parenthesis</span> <span class="n">Round</span> <span class="n">Open</span> <span class="o">&gt;&gt;.</span> <span class="n">a</span> <span class="o">.&gt;&gt;</span> <span class="n">skip_parenthesis</span> <span class="n">Round</span> <span class="n">Close</span><span class="p">)</span> <span class="n">d</span>
<span class="n">let</span> <span class="n">curlies</span> <span class="n">a</span> <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">skip_parenthesis</span> <span class="n">Curly</span> <span class="n">Open</span> <span class="o">&gt;&gt;.</span> <span class="n">a</span> <span class="o">.&gt;&gt;</span> <span class="n">skip_parenthesis</span> <span class="n">Curly</span> <span class="n">Close</span><span class="p">)</span> <span class="n">d</span>
<span class="n">let</span> <span class="n">squares</span> <span class="n">a</span> <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">skip_parenthesis</span> <span class="n">Square</span> <span class="n">Open</span> <span class="o">&gt;&gt;.</span> <span class="n">a</span> <span class="o">.&gt;&gt;</span> <span class="n">skip_parenthesis</span> <span class="n">Square</span> <span class="n">Close</span><span class="p">)</span> <span class="n">d</span>

<span class="n">let</span> <span class="n">indexBlockParsing</span> <span class="p">(</span><span class="n">t</span> <span class="p">:</span> <span class="n">BlockParsingEnv</span><span class="p">)</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">Index</span>
<span class="n">let</span> <span class="n">index_setBlockParsing</span> <span class="n">v</span> <span class="p">(</span><span class="n">t</span> <span class="p">:</span> <span class="n">BlockParsingEnv</span><span class="p">)</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">Index</span> <span class="o">&lt;-</span> <span class="n">v</span>

<span class="n">let</span> <span class="n">inline</span> <span class="n">rangeBlockParsing</span> <span class="n">exp</span> <span class="n">s</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">i</span> <span class="o">=</span> <span class="n">indexBlockParsing</span> <span class="n">s</span>
    <span class="n">exp</span> <span class="n">s</span> <span class="o">|&gt;</span> <span class="n">Result</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span>
        <span class="n">let</span> <span class="n">i</span><span class="s1">' = indexBlockParsing s</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">i</span><span class="s1">' then fst s.tokens.[i] +. fst s.tokens.[i'</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span> <span class="p">:</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">_</span>
        <span class="k">else</span>
            <span class="n">failwith</span> <span class="s2">"Compiler error: The parser passed into `range` has to consume at least one token for it to work."</span>
        <span class="p">)</span>

<span class="n">let</span> <span class="n">rec</span> <span class="n">kind</span> <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">sepBy1</span> <span class="p">((</span><span class="n">skip_op</span> <span class="s2">"*"</span> <span class="o">&gt;&gt;%</span> <span class="n">RawKindStar</span><span class="p">)</span> <span class="o">&lt;|&gt;</span> <span class="n">rounds</span> <span class="n">kind</span><span class="p">)</span> <span class="p">(</span><span class="n">skip_op</span> <span class="s2">"-&gt;"</span><span class="p">)</span> <span class="o">|&gt;&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">reduceBack</span> <span class="p">(</span><span class="n">fun</span> <span class="n">a</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">RawKindFun</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)))</span> <span class="n">d</span>

<span class="n">let</span> <span class="n">duplicates</span> <span class="n">er</span> <span class="n">x</span> <span class="o">=</span> 
    <span class="n">let</span> <span class="n">h</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">Generic</span><span class="o">.</span><span class="n">HashSet</span><span class="p">()</span>
    <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">choose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">r</span> <span class="p">:</span> <span class="n">VSCRange</span><span class="p">,</span><span class="n">n</span> <span class="p">:</span> <span class="n">string</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">Add</span> <span class="n">n</span> <span class="o">=</span> <span class="n">false</span> <span class="n">then</span> <span class="n">Some</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">er</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

<span class="n">let</span> <span class="n">inline</span> <span class="n">indentBlockParsing</span> <span class="n">i</span> <span class="n">op</span> <span class="nb">next</span> <span class="n">d</span> <span class="o">=</span> <span class="k">if</span> <span class="n">op</span> <span class="n">i</span> <span class="p">(</span><span class="n">col</span> <span class="n">d</span><span class="p">)</span> <span class="n">then</span> <span class="nb">next</span> <span class="n">d</span> <span class="k">else</span> <span class="n">Error</span> <span class="p">[]</span>

<span class="n">let</span> <span class="n">record_var</span> <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">read_var_as_symbol</span> <span class="o">&lt;|&gt;</span> <span class="n">rounds</span> <span class="n">read_op</span><span class="p">)</span> <span class="n">d</span>

<span class="n">let</span> <span class="n">patterns_validate</span> <span class="n">pats</span> <span class="o">=</span> 
    <span class="n">let</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">Generic</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Reference</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">ResizeArray</span><span class="p">()</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="n">is_type</span> <span class="n">pat</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">loop</span> <span class="o">=</span> <span class="n">loop</span> <span class="n">is_type</span>
        <span class="n">let</span> <span class="n">inline</span> <span class="n">duplicate_var</span><span class="p">()</span> <span class="o">=</span> <span class="n">InvalidPattern</span> <span class="p">(</span><span class="k">if</span> <span class="n">is_type</span> <span class="n">then</span> <span class="n">DuplicateTypeVar</span> <span class="k">else</span> <span class="n">DuplicateTermVar</span><span class="p">)</span>
        <span class="k">match</span> <span class="n">pat</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">PatFilledDefaultValue</span> <span class="n">_</span> <span class="o">|</span> <span class="n">PatDefaultValue</span> <span class="n">_</span> <span class="o">|</span> <span class="n">PatValue</span> <span class="n">_</span> <span class="o">|</span> <span class="n">PatSymbol</span> <span class="n">_</span> <span class="o">|</span> <span class="n">PatE</span> <span class="n">_</span> <span class="o">|</span> <span class="n">PatB</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="o">.</span><span class="n">empty</span>
        <span class="o">|</span> <span class="n">PatArray</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> 
            <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">x</span> <span class="o">-&gt;</span> 
                <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">loop</span> <span class="n">x</span>
                <span class="n">let</span> <span class="n">inters</span> <span class="o">=</span> <span class="n">Set</span><span class="o">.</span><span class="n">intersect</span> <span class="n">s</span> <span class="n">x</span>
                <span class="k">if</span> <span class="n">Set</span><span class="o">.</span><span class="n">isEmpty</span> <span class="n">inters</span> <span class="o">=</span> <span class="n">false</span> <span class="n">then</span> <span class="n">inters</span> <span class="o">|&gt;</span> <span class="n">Set</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">duplicate_var</span><span class="p">()))</span>
                <span class="n">s</span> <span class="o">+</span> <span class="n">x</span>
                <span class="p">)</span> <span class="n">Set</span><span class="o">.</span><span class="n">empty</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">PatExists</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="k">if</span> <span class="n">is_type</span> <span class="n">then</span>
                <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pos</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">r</span><span class="p">);</span> <span class="n">Set</span><span class="o">.</span><span class="n">add</span> <span class="n">x</span> <span class="n">s</span><span class="p">)</span> <span class="n">Set</span><span class="o">.</span><span class="n">empty</span> <span class="n">l</span>
                <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">loop</span> <span class="n">p</span>
                <span class="n">let</span> <span class="n">inters</span> <span class="o">=</span> <span class="n">Set</span><span class="o">.</span><span class="n">intersect</span> <span class="n">s</span> <span class="n">x</span>
                <span class="k">if</span> <span class="n">Set</span><span class="o">.</span><span class="n">isEmpty</span> <span class="n">inters</span> <span class="o">=</span> <span class="n">false</span> <span class="n">then</span> <span class="n">inters</span> <span class="o">|&gt;</span> <span class="n">Set</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">duplicate_var</span><span class="p">()))</span>
                <span class="n">s</span> <span class="o">+</span> <span class="n">x</span>
            <span class="k">else</span> 
                <span class="n">loop</span> <span class="n">p</span>
        <span class="o">|</span> <span class="n">PatVar</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> 
            <span class="k">if</span> <span class="n">is_type</span> <span class="n">then</span>
                <span class="n">Set</span><span class="o">.</span><span class="n">empty</span>
            <span class="k">else</span> 
                <span class="n">pos</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
                <span class="n">Set</span><span class="o">.</span><span class="n">singleton</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">PatDyn</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="o">|</span> <span class="n">PatAnnot</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">PatNominal</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="o">|</span> <span class="n">PatUnbox</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="o">|</span> <span class="n">PatWhen</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="n">p</span>
        <span class="o">|</span> <span class="n">PatRecordMembers</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">items</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">symbols</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">Generic</span><span class="o">.</span><span class="n">HashSet</span><span class="p">()</span>
            <span class="n">let</span> <span class="n">injects</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">Generic</span><span class="o">.</span><span class="n">HashSet</span><span class="p">()</span>
            <span class="n">let</span> <span class="nb">vars</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">Generic</span><span class="o">.</span><span class="n">HashSet</span><span class="p">()</span>
            <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">item</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">item</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">PatRecordMembersSymbol</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">keyword</span><span class="p">),</span><span class="n">name</span><span class="p">)</span> <span class="o">-&gt;</span>
                    <span class="k">if</span> <span class="n">symbols</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">keyword</span><span class="p">)</span> <span class="o">=</span> <span class="n">false</span> <span class="n">then</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">InvalidPattern</span> <span class="n">DuplicateRecordSymbol</span><span class="p">);</span> <span class="n">Set</span><span class="o">.</span><span class="n">empty</span> <span class="k">else</span> <span class="n">loop</span> <span class="n">name</span>
                <span class="o">|</span> <span class="n">PatRecordMembersInjectVar</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">var</span><span class="p">),</span><span class="n">name</span><span class="p">)</span> <span class="o">-&gt;</span>
                    <span class="k">if</span> <span class="n">injects</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="o">=</span> <span class="n">false</span> <span class="n">then</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">InvalidPattern</span> <span class="n">DuplicateRecordInjection</span><span class="p">);</span> <span class="n">Set</span><span class="o">.</span><span class="n">empty</span> <span class="k">else</span> <span class="n">loop</span> <span class="n">name</span>
                <span class="o">|&gt;</span> <span class="n">Set</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="nb">vars</span><span class="o">.</span><span class="n">Add</span> <span class="n">x</span> <span class="o">=</span> <span class="n">false</span> <span class="n">then</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span> <span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">duplicate_var</span><span class="p">()))</span>
                <span class="p">)</span> <span class="n">items</span>
            <span class="n">Set</span> <span class="nb">vars</span>
        <span class="o">|</span> <span class="n">PatPair</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="n">PatAnd</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> 
            <span class="n">let</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">loop</span> <span class="n">a</span><span class="p">,</span> <span class="n">loop</span> <span class="n">b</span>
            <span class="n">Set</span><span class="o">.</span><span class="n">intersect</span> <span class="n">b</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">Set</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span> <span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">duplicate_var</span><span class="p">()))</span>
            <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">PatOr</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> 
            <span class="n">let</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">loop</span> <span class="n">a</span><span class="p">,</span> <span class="n">loop</span> <span class="n">b</span>
            <span class="n">let</span> <span class="n">f</span> <span class="o">=</span> <span class="n">Set</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span> <span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">InvalidPattern</span> <span class="n">DisjointOrPatternVar</span><span class="p">))</span>
            <span class="n">f</span> <span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="p">);</span> <span class="n">f</span> <span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span>
            <span class="n">a</span>
    
    <span class="n">let</span> <span class="n">validate</span> <span class="n">is_type</span> <span class="o">=</span>
        <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">x</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">s</span><span class="s1">' = loop is_type x</span>
            <span class="n">Set</span><span class="o">.</span><span class="n">intersect</span> <span class="n">s</span><span class="s1">' s |&gt; Set.iter (fun x -&gt; errors.Add(pos.[x],InvalidPattern ShadowedVar))</span>
            <span class="n">s</span> <span class="o">+</span> <span class="n">s</span><span class="s1">'</span>
            <span class="p">)</span> <span class="n">Set</span><span class="o">.</span><span class="n">empty</span> <span class="n">pats</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
    <span class="n">validate</span> <span class="n">true</span><span class="p">;</span> <span class="n">validate</span> <span class="n">false</span>
    <span class="n">errors</span> <span class="o">|&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">toList</span>

<span class="n">let</span> <span class="n">join_point</span> <span class="n">is_let</span> <span class="n">name</span> <span class="o">=</span> <span class="n">function</span> <span class="o">//</span> <span class="n">Has</span> <span class="n">the</span> <span class="n">effect</span> <span class="n">of</span> <span class="n">removing</span> <span class="n">nested</span> <span class="n">join</span> <span class="n">points</span> <span class="n">due</span> <span class="n">to</span> <span class="ow">not</span> <span class="n">duplicating</span> <span class="n">them</span><span class="o">.</span>
    <span class="o">|</span> <span class="n">RawJoinPoint</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawJoinPoint</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">is_let</span> <span class="n">then</span> <span class="n">RawJoinPoint</span><span class="p">(</span><span class="n">range_of_expr</span> <span class="n">x</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span>
<span class="n">let</span> <span class="n">join_point_backend</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">=</span> <span class="n">RawJoinPoint</span><span class="p">(</span><span class="n">range_of_expr</span> <span class="n">b</span><span class="p">,</span> <span class="n">Some</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

<span class="o">///</span> <span class="n">Some</span> <span class="n">places</span> <span class="n">need</span> <span class="n">unique</span> <span class="n">string</span> <span class="n">refs</span><span class="p">,</span> <span class="n">so</span> <span class="n">this</span> <span class="ow">is</span> <span class="n">to</span> <span class="n">keep</span> <span class="n">the</span> <span class="n">compiler</span> <span class="kn">from</span> <span class="nn">interning</span> <span class="n">static</span> <span class="n">strings</span><span class="o">.</span>
<span class="n">let</span> <span class="n">unintern</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">string</span><span class="p">)</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Text</span><span class="o">.</span><span class="n">StringBuilder</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">ToString</span><span class="p">()</span>

<span class="n">let</span> <span class="n">rec</span> <span class="n">adjust_join_point</span> <span class="n">is_let</span> <span class="n">name</span> <span class="n">x</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">dyn_if_let</span> <span class="n">a</span> <span class="o">=</span> <span class="k">if</span> <span class="n">is_let</span> <span class="n">then</span> <span class="n">PatDyn</span><span class="p">(</span><span class="n">range_of_pattern</span> <span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="k">else</span> <span class="n">a</span>
    <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">RawForall</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawForall</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">adjust_join_point</span> <span class="n">is_let</span> <span class="n">name</span> <span class="n">b</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawFun</span><span class="p">(</span><span class="n">r</span><span class="p">,[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">RawFun</span><span class="p">(</span><span class="n">r</span><span class="p">,[</span><span class="n">dyn_if_let</span> <span class="n">a</span><span class="p">,</span> <span class="n">adjust_join_point</span> <span class="n">is_let</span> <span class="n">name</span> <span class="n">b</span><span class="p">])</span>
    <span class="o">|</span> <span class="n">RawFun</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">l</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="n">let</span> <span class="n">empty</span> <span class="o">=</span> <span class="n">fst</span> <span class="n">r</span><span class="p">,</span> <span class="n">fst</span> <span class="n">r</span>
        <span class="n">let</span> <span class="n">n</span> <span class="o">=</span> <span class="n">unintern</span> <span class="s2">" arg"</span>
        <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">PatVar</span><span class="p">(</span><span class="n">empty</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">dyn_if_let</span>
        <span class="n">let</span> <span class="n">b</span> <span class="o">=</span> <span class="n">RawMatch</span><span class="p">(</span><span class="n">empty</span><span class="p">,</span><span class="n">rawv</span><span class="p">(</span><span class="n">empty</span><span class="p">,</span><span class="n">n</span><span class="p">),</span><span class="n">l</span><span class="p">)</span>
        <span class="n">RawFun</span><span class="p">(</span><span class="n">r</span><span class="p">,[</span><span class="n">a</span><span class="p">,</span><span class="n">join_point</span> <span class="n">is_let</span> <span class="n">name</span> <span class="n">b</span><span class="p">])</span>
    <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">join_point</span> <span class="n">is_let</span> <span class="n">name</span> <span class="n">x</span>

<span class="n">let</span> <span class="n">adjust_join_point</span><span class="s1">' is_let name = function</span>
    <span class="o">|</span> <span class="n">RawForall</span> <span class="n">_</span> <span class="o">|</span> <span class="n">RawFun</span> <span class="n">_</span> <span class="k">as</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">adjust_join_point</span> <span class="n">is_let</span> <span class="n">name</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span>

<span class="n">let</span> <span class="n">inl_or_let_process</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="p">(</span><span class="n">is_let</span><span class="p">,</span> <span class="n">is_rec</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">foralls</span><span class="p">,</span> <span class="n">pats</span><span class="p">,</span> <span class="n">body</span><span class="p">))</span> <span class="n">_</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">is_rec</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">foralls</span><span class="p">,</span> <span class="n">pats</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">false</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[]</span> <span class="o">-&gt;</span> 
        <span class="k">match</span> <span class="n">patterns_validate</span> <span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">with</span>
        <span class="o">|</span> <span class="p">[]</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">adjust_join_point</span><span class="s1">' is_let (match name with PatVar(_,name) -&gt; Some name | _ -&gt; None) body),is_rec)</span>
        <span class="o">|</span> <span class="n">ers</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">ers</span>
    <span class="o">|</span> <span class="n">_</span><span class="p">,</span> <span class="n">PatVar</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">name</span><span class="s1">'), _, _ -&gt; </span>
        <span class="k">match</span> <span class="n">patterns_validate</span> <span class="p">(</span><span class="k">if</span> <span class="n">is_rec</span> <span class="n">then</span> <span class="n">name</span> <span class="p">::</span> <span class="n">pats</span> <span class="k">else</span> <span class="n">pats</span><span class="p">)</span> <span class="k">with</span>
        <span class="o">|</span> <span class="p">[]</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">body</span> <span class="o">=</span>
                <span class="n">let</span> <span class="n">dyn_if_let</span> <span class="n">x</span> <span class="o">=</span> <span class="k">if</span> <span class="n">is_let</span> <span class="n">then</span> <span class="n">PatDyn</span><span class="p">(</span><span class="n">range_of_pattern</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span>
                <span class="n">adjust_join_point</span> <span class="n">is_let</span> <span class="p">(</span><span class="n">Some</span> <span class="n">name</span><span class="s1">') body</span>
                <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="n">pat</span> <span class="n">body</span> <span class="o">-&gt;</span> <span class="n">RawFun</span><span class="p">(</span><span class="n">range_of_pattern</span> <span class="n">pat</span> <span class="o">+.</span> <span class="n">range_of_expr</span> <span class="n">body</span><span class="p">,[</span><span class="n">dyn_if_let</span> <span class="n">pat</span><span class="p">,</span><span class="n">body</span><span class="p">]))</span> <span class="n">pats</span>
                <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="n">typevar</span> <span class="n">body</span> <span class="o">-&gt;</span> <span class="n">RawForall</span><span class="p">(</span><span class="n">range_of_typevar</span> <span class="n">typevar</span> <span class="o">+.</span> <span class="n">range_of_expr</span> <span class="n">body</span><span class="p">,</span><span class="n">typevar</span><span class="p">,</span><span class="n">body</span><span class="p">))</span> <span class="n">foralls</span>
            <span class="k">match</span> <span class="n">is_rec</span><span class="p">,</span> <span class="n">body</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">false</span><span class="p">,</span> <span class="n">_</span> <span class="o">|</span> <span class="n">true</span><span class="p">,</span> <span class="p">(</span><span class="n">RawFun</span> <span class="n">_</span> <span class="o">|</span> <span class="n">RawForall</span> <span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">body</span><span class="p">),</span><span class="n">is_rec</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">true</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">ExpectedFunctionAsBodyOfRecStatement</span><span class="p">]</span>
        <span class="o">|</span> <span class="n">ers</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">ers</span>
    <span class="o">|</span> <span class="n">true</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="p">[</span><span class="n">range_of_pattern</span> <span class="n">name</span><span class="p">,</span> <span class="n">ExpectedVarOrOpAsNameOfRecStatement</span><span class="p">]</span>
    <span class="o">|</span> <span class="n">false</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="p">[</span><span class="n">range_of_pattern</span> <span class="n">name</span><span class="p">,</span> <span class="n">ExpectedSinglePatternWhenStatementNameIsNorVarOrOp</span><span class="p">]</span>

<span class="n">let</span> <span class="n">ho_var</span> <span class="n">d</span> <span class="p">:</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">HoVar</span><span class="p">,</span><span class="n">_</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">rangeBlockParsing</span> <span class="p">((</span><span class="n">read_small_type_var</span> <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="p">,</span> <span class="n">RawKindWildcard</span><span class="p">)</span> <span class="o">&lt;|&gt;</span> <span class="n">rounds</span> <span class="p">((</span><span class="n">read_small_type_var</span> <span class="o">.&gt;&gt;</span> <span class="n">skip_op</span> <span class="s2">":"</span><span class="p">)</span> <span class="o">.&gt;&gt;.</span> <span class="n">kind</span><span class="p">))</span> <span class="n">d</span>
<span class="n">let</span> <span class="n">forall_var</span> <span class="n">d</span> <span class="p">:</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">TypeVar</span><span class="p">,</span><span class="n">_</span><span class="o">&gt;</span> <span class="o">=</span> <span class="p">(</span><span class="n">ho_var</span> <span class="o">.&gt;&gt;.</span> <span class="p">(</span><span class="n">curlies</span> <span class="p">(</span><span class="n">sepBy</span> <span class="p">(</span><span class="n">read_small_type_var</span><span class="s1">' &lt;|&gt; rounds read_op_type) (skip_op ";")) &lt;|&gt;% [])) d</span>
<span class="n">let</span> <span class="n">forall</span> <span class="n">d</span> <span class="o">=</span> 
    <span class="p">(</span><span class="n">skip_keyword</span> <span class="n">SpecForall</span> <span class="o">&gt;&gt;.</span> <span class="n">many1</span> <span class="n">forall_var</span> <span class="o">.&gt;&gt;</span> <span class="n">skip_op</span> <span class="s2">"."</span> 
    <span class="o">&gt;&gt;=</span> <span class="n">fun</span> <span class="n">q</span> <span class="n">_</span> <span class="o">-&gt;</span> 
        <span class="n">let</span> <span class="n">x</span><span class="s1">' = q |&gt; List.collect (fun (_,l) -&gt; duplicates DuplicateConstraint l)</span>
        <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">q</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">((</span><span class="n">r</span><span class="p">,(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)),</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">duplicates</span> <span class="n">DuplicateForallVar</span>
        <span class="k">match</span> <span class="n">List</span><span class="o">.</span><span class="n">append</span> <span class="n">x</span> <span class="n">x</span><span class="s1">' with [] -&gt; Result.Ok q | er -&gt; Result.Error er</span>
        <span class="p">)</span> <span class="n">d</span>
<span class="n">let</span> <span class="n">pat_exists</span><span class="s1">' d = </span>
    <span class="p">(</span><span class="n">skip_keyword</span> <span class="n">SpecExists</span> <span class="o">&gt;&gt;.</span> <span class="n">many</span> <span class="p">(</span><span class="n">rangeBlockParsing</span> <span class="n">read_small_type_var</span><span class="p">)</span> <span class="o">.&gt;&gt;</span> <span class="n">skip_op</span> <span class="s2">"."</span> 
    <span class="o">&gt;&gt;=</span> <span class="n">fun</span> <span class="n">q</span> <span class="n">_</span> <span class="o">-&gt;</span> 
        <span class="k">match</span> <span class="n">duplicates</span> <span class="n">DuplicateExistsVar</span> <span class="n">q</span> <span class="k">with</span> <span class="p">[]</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span> <span class="n">q</span> <span class="o">|</span> <span class="n">er</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">er</span>
        <span class="p">)</span> <span class="n">d</span>
<span class="n">let</span> <span class="n">exists</span> <span class="n">d</span> <span class="o">=</span> 
    <span class="p">(</span><span class="n">skip_keyword</span> <span class="n">SpecExists</span> <span class="o">&gt;&gt;.</span> <span class="n">many</span> <span class="n">forall_var</span> <span class="o">.&gt;&gt;</span> <span class="n">skip_op</span> <span class="s2">"."</span> 
    <span class="o">&gt;&gt;=</span> <span class="n">fun</span> <span class="n">q</span> <span class="n">_</span> <span class="o">-&gt;</span> 
        <span class="n">let</span> <span class="n">x</span><span class="s1">' = q |&gt; List.collect (fun (_,l) -&gt; duplicates DuplicateConstraint l)</span>
        <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">q</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">((</span><span class="n">r</span><span class="p">,(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)),</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">duplicates</span> <span class="n">DuplicateExistsVar</span>
        <span class="k">match</span> <span class="n">List</span><span class="o">.</span><span class="n">append</span> <span class="n">x</span> <span class="n">x</span><span class="s1">' with [] -&gt; Result.Ok q | er -&gt; Error er</span>
        <span class="p">)</span> <span class="n">d</span>

<span class="n">let</span> <span class="n">inline</span> <span class="n">annotated_body</span> <span class="n">sep</span> <span class="n">exp</span> <span class="n">ty</span> <span class="o">=</span>
    <span class="n">pipe2</span> <span class="p">(</span><span class="n">opt</span> <span class="p">(</span><span class="n">skip_op</span> <span class="s2">":"</span> <span class="o">&gt;&gt;.</span> <span class="n">ty</span><span class="p">))</span>
        <span class="p">(</span><span class="n">skip_op</span> <span class="n">sep</span> <span class="o">.&gt;&gt;.</span> <span class="n">opt</span> <span class="n">exp</span><span class="p">)</span>
        <span class="p">(</span><span class="n">fun</span> <span class="n">a</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">b</span> <span class="o">=</span> <span class="n">match</span> <span class="n">b</span> <span class="k">with</span> <span class="n">Some</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">b</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">RawMissingBody</span> <span class="n">r</span>
            <span class="k">match</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">Some</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">RawAnnot</span><span class="p">(</span><span class="n">range_of_expr</span> <span class="n">b</span> <span class="o">+.</span> <span class="n">range_of_texpr</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
            <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">b</span><span class="p">)</span>

<span class="n">let</span> <span class="n">inline</span> <span class="n">inl_or_let</span> <span class="n">exp</span> <span class="n">pattern</span> <span class="n">ty</span> <span class="o">=</span>
    <span class="n">rangeBlockParsing</span> <span class="p">(</span><span class="n">tuple6</span> <span class="p">((</span><span class="n">skip_keyword</span> <span class="n">SpecInl</span> <span class="o">&gt;&gt;%</span> <span class="n">false</span><span class="p">)</span> <span class="o">&lt;|&gt;</span> <span class="p">(</span><span class="n">skip_keyword</span> <span class="n">SpecLet</span> <span class="o">&gt;&gt;%</span> <span class="n">true</span><span class="p">))</span>
            <span class="p">((</span><span class="n">skip_keyword</span> <span class="n">SpecRec</span> <span class="o">&gt;&gt;%</span> <span class="n">true</span><span class="p">)</span> <span class="o">&lt;|&gt;%</span> <span class="n">false</span><span class="p">)</span> <span class="n">pattern</span>
            <span class="p">(</span><span class="n">forall</span> <span class="o">&lt;|&gt;%</span> <span class="p">[])</span> <span class="p">(</span><span class="n">many</span> <span class="n">pattern</span><span class="p">)</span> <span class="p">(</span><span class="n">annotated_body</span> <span class="s2">"="</span> <span class="n">exp</span> <span class="n">ty</span><span class="p">))</span>
    <span class="o">&gt;&gt;=</span> <span class="n">inl_or_let_process</span>

<span class="n">let</span> <span class="n">inline</span> <span class="n">and_inl_or_let</span> <span class="n">exp</span> <span class="n">pattern</span> <span class="n">ty</span> <span class="o">=</span>
    <span class="n">rangeBlockParsing</span> <span class="p">(</span><span class="n">tuple6</span> <span class="p">(</span><span class="n">skip_keyword</span> <span class="n">SpecAnd</span> <span class="o">&gt;&gt;.</span> <span class="p">((</span><span class="n">skip_keyword</span> <span class="n">SpecInl</span> <span class="o">&gt;&gt;%</span> <span class="n">false</span><span class="p">)</span> <span class="o">&lt;|&gt;</span> <span class="p">(</span><span class="n">skip_keyword</span> <span class="n">SpecLet</span> <span class="o">&gt;&gt;%</span> <span class="n">true</span><span class="p">)))</span>
            <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span> <span class="n">true</span><span class="p">)</span> <span class="n">pattern</span>
            <span class="p">(</span><span class="n">forall</span> <span class="o">&lt;|&gt;%</span> <span class="p">[])</span> <span class="p">(</span><span class="n">many</span> <span class="n">pattern</span><span class="p">)</span> <span class="p">(</span><span class="n">annotated_body</span> <span class="s2">"="</span> <span class="n">exp</span> <span class="n">ty</span><span class="p">))</span>
    <span class="o">&gt;&gt;=</span> <span class="n">inl_or_let_process</span>

<span class="nb">type</span> <span class="n">Associativity</span> <span class="o">=</span> <span class="n">FParsec</span><span class="o">.</span><span class="n">Associativity</span>
<span class="n">let</span> <span class="n">inbuilt_operators</span> <span class="n">x</span> <span class="o">=</span> 
    <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
    <span class="o">|</span> <span class="s2">"+"</span> <span class="o">-&gt;</span> <span class="n">ValueSome</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">Associativity</span><span class="o">.</span><span class="n">Left</span><span class="p">)</span>
    <span class="o">|</span> <span class="s2">"-"</span> <span class="o">-&gt;</span> <span class="n">ValueSome</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">Associativity</span><span class="o">.</span><span class="n">Left</span><span class="p">)</span>
    <span class="o">|</span> <span class="s2">"*"</span> <span class="o">-&gt;</span> <span class="n">ValueSome</span><span class="p">(</span><span class="mi">70</span><span class="p">,</span> <span class="n">Associativity</span><span class="o">.</span><span class="n">Left</span><span class="p">)</span>
    <span class="o">|</span> <span class="s2">"/"</span> <span class="o">-&gt;</span> <span class="n">ValueSome</span><span class="p">(</span><span class="mi">70</span><span class="p">,</span> <span class="n">Associativity</span><span class="o">.</span><span class="n">Left</span><span class="p">)</span>
    <span class="o">|</span> <span class="s2">"%"</span> <span class="o">-&gt;</span> <span class="n">ValueSome</span><span class="p">(</span><span class="mi">70</span><span class="p">,</span> <span class="n">Associativity</span><span class="o">.</span><span class="n">Left</span><span class="p">)</span>
    <span class="o">|</span> <span class="s2">"|&gt;"</span> <span class="o">-&gt;</span> <span class="n">ValueSome</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">Associativity</span><span class="o">.</span><span class="n">Left</span><span class="p">)</span>
    <span class="o">|</span> <span class="s2">"&gt;&gt;"</span> <span class="o">-&gt;</span> <span class="n">ValueSome</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">Associativity</span><span class="o">.</span><span class="n">Left</span><span class="p">)</span>
    <span class="o">|</span> <span class="s2">"&lt;-"</span> <span class="o">-&gt;</span> <span class="n">ValueSome</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">Associativity</span><span class="o">.</span><span class="n">Left</span><span class="p">)</span>
    
    <span class="o">|</span> <span class="s2">"&lt;="</span> <span class="o">-&gt;</span> <span class="n">ValueSome</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="n">Associativity</span><span class="o">.</span><span class="kc">None</span><span class="p">)</span>
    <span class="o">|</span> <span class="s2">"&lt;"</span> <span class="o">-&gt;</span> <span class="n">ValueSome</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="n">Associativity</span><span class="o">.</span><span class="kc">None</span><span class="p">)</span>
    <span class="o">|</span> <span class="s2">"="</span> <span class="o">-&gt;</span> <span class="n">ValueSome</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="n">Associativity</span><span class="o">.</span><span class="kc">None</span><span class="p">)</span>
    <span class="o">|</span> <span class="s2">"`="</span> <span class="o">-&gt;</span> <span class="n">ValueSome</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="n">Associativity</span><span class="o">.</span><span class="kc">None</span><span class="p">)</span>
    <span class="o">|</span> <span class="s2">"&gt;"</span> <span class="o">-&gt;</span> <span class="n">ValueSome</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="n">Associativity</span><span class="o">.</span><span class="kc">None</span><span class="p">)</span>
    <span class="o">|</span> <span class="s2">"&gt;="</span> <span class="o">-&gt;</span> <span class="n">ValueSome</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="n">Associativity</span><span class="o">.</span><span class="kc">None</span><span class="p">)</span>
    <span class="o">|</span> <span class="s2">"&lt;&gt;"</span> <span class="o">-&gt;</span> <span class="n">ValueSome</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="n">Associativity</span><span class="o">.</span><span class="kc">None</span><span class="p">)</span>
    <span class="o">|</span> <span class="s2">"&lt;&lt;&lt;"</span> <span class="o">-&gt;</span> <span class="n">ValueSome</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="n">Associativity</span><span class="o">.</span><span class="kc">None</span><span class="p">)</span>
    <span class="o">|</span> <span class="s2">"&gt;&gt;&gt;"</span> <span class="o">-&gt;</span> <span class="n">ValueSome</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="n">Associativity</span><span class="o">.</span><span class="kc">None</span><span class="p">)</span>
    <span class="o">|</span> <span class="s2">"&amp;&amp;&amp;"</span> <span class="o">-&gt;</span> <span class="n">ValueSome</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="n">Associativity</span><span class="o">.</span><span class="kc">None</span><span class="p">)</span>
    <span class="o">|</span> <span class="s2">"|||"</span> <span class="o">-&gt;</span> <span class="n">ValueSome</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="n">Associativity</span><span class="o">.</span><span class="kc">None</span><span class="p">)</span>

    <span class="o">|</span> <span class="s2">"||"</span> <span class="o">-&gt;</span> <span class="n">ValueSome</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">Associativity</span><span class="o">.</span><span class="n">Right</span><span class="p">)</span>
    <span class="o">|</span> <span class="s2">"&amp;&amp;"</span> <span class="o">-&gt;</span> <span class="n">ValueSome</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">Associativity</span><span class="o">.</span><span class="n">Right</span><span class="p">)</span>
    <span class="o">|</span> <span class="s2">"::"</span> <span class="o">-&gt;</span> <span class="n">ValueSome</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">Associativity</span><span class="o">.</span><span class="n">Right</span><span class="p">)</span>
    <span class="o">|</span> <span class="s2">"^"</span> <span class="o">-&gt;</span> <span class="n">ValueSome</span><span class="p">(</span><span class="mi">45</span><span class="p">,</span> <span class="n">Associativity</span><span class="o">.</span><span class="n">Right</span><span class="p">)</span>
    <span class="o">|</span> <span class="s2">"&lt;|"</span> <span class="o">-&gt;</span> <span class="n">ValueSome</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">Associativity</span><span class="o">.</span><span class="n">Right</span><span class="p">)</span>
    <span class="o">|</span> <span class="s2">"&lt;&lt;"</span> <span class="o">-&gt;</span> <span class="n">ValueSome</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">Associativity</span><span class="o">.</span><span class="n">Right</span><span class="p">)</span>
    <span class="o">|</span> <span class="s2">"."</span> <span class="o">-&gt;</span> <span class="n">ValueSome</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">Associativity</span><span class="o">.</span><span class="n">Right</span><span class="p">)</span>
    <span class="o">|</span> <span class="s2">","</span> <span class="o">-&gt;</span> <span class="n">ValueSome</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">Associativity</span><span class="o">.</span><span class="n">Right</span><span class="p">)</span>
    <span class="o">|</span> <span class="s2">":&gt;"</span> <span class="o">-&gt;</span> <span class="n">ValueSome</span><span class="p">(</span><span class="mi">35</span><span class="p">,</span> <span class="n">Associativity</span><span class="o">.</span><span class="n">Right</span><span class="p">)</span>
    <span class="o">|</span> <span class="s2">":?&gt;"</span> <span class="o">-&gt;</span> <span class="n">ValueSome</span><span class="p">(</span><span class="mi">35</span><span class="p">,</span> <span class="n">Associativity</span><span class="o">.</span><span class="n">Right</span><span class="p">)</span>
    <span class="o">|</span> <span class="s2">"**"</span> <span class="o">-&gt;</span> <span class="n">ValueSome</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="n">Associativity</span><span class="o">.</span><span class="n">Right</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">ValueNone</span>

<span class="o">//</span> <span class="n">The</span> <span class="err">`</span><span class="o">.</span><span class="err">`</span> <span class="n">operator</span> <span class="n">has</span> <span class="n">special</span> <span class="n">behavior</span> <span class="n">similar</span> <span class="n">to</span> <span class="n">F</span><span class="c1">#.</span>
<span class="n">let</span> <span class="n">rec</span> <span class="n">precedence_associativity</span> <span class="n">name</span> <span class="o">=</span> 
    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">String</span><span class="o">.</span><span class="n">length</span> <span class="n">name</span> <span class="n">then</span>
        <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">String</span><span class="o">.</span><span class="n">length</span> <span class="n">name</span> <span class="o">&amp;&amp;</span> <span class="n">name</span><span class="o">.</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'.'</span> <span class="n">then</span> <span class="n">precedence_associativity</span> <span class="n">name</span><span class="o">.</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="p">]</span>
        <span class="k">else</span>
            <span class="k">match</span> <span class="n">inbuilt_operators</span> <span class="n">name</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">ValueNone</span> <span class="o">-&gt;</span> <span class="n">precedence_associativity</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="p">[</span><span class="mf">0.</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">Length</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
            <span class="o">|</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">v</span>
    <span class="k">else</span> <span class="n">ValueNone</span>

<span class="n">let</span> <span class="n">op</span> <span class="p">(</span><span class="n">d</span> <span class="p">:</span> <span class="n">BlockParsingEnv</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">rangeBlockParsing</span> <span class="n">read_op</span> <span class="n">d</span> <span class="o">|&gt;</span> <span class="n">Result</span><span class="o">.</span><span class="n">bind</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">o</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
        <span class="o">|</span> <span class="s2">"=&gt;"</span> <span class="o">|</span> <span class="s2">"|"</span> <span class="o">|</span> <span class="s2">":"</span> <span class="o">|</span> <span class="s2">";"</span> <span class="o">-&gt;</span> <span class="n">skip</span><span class="s1">' d -1; Error [] // Separators get special handling for sake of better error messages.</span>
        <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">precedence_associativity</span> <span class="n">x</span> <span class="k">with</span> <span class="o">//</span> <span class="n">TODO</span><span class="p">:</span> <span class="n">Might</span> <span class="n">be</span> <span class="n">good</span> <span class="n">to</span> <span class="n">memoize</span> <span class="n">this</span><span class="o">.</span>
            <span class="o">|</span> <span class="n">ValueNone</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="p">[</span><span class="n">o</span><span class="p">,</span> <span class="n">UnknownOperator</span><span class="p">]</span>
            <span class="o">|</span> <span class="n">ValueSome</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">inline</span> <span class="n">f</span> <span class="n">on_succ</span> <span class="o">=</span> <span class="n">Ok</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">fun</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> 
                    <span class="n">let</span> <span class="n">ra</span><span class="p">,</span> <span class="n">rb</span> <span class="o">=</span> <span class="n">range_of_expr</span> <span class="n">a</span><span class="p">,</span> <span class="n">range_of_expr</span> <span class="n">b</span>
                    <span class="n">let</span> <span class="n">r</span> <span class="o">=</span> <span class="n">ra</span> <span class="o">+.</span> <span class="n">rb</span>
                    <span class="n">on_succ</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
                <span class="o">|</span> <span class="s2">"."</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">RawSeq</span>
                <span class="o">|</span> <span class="s2">"&amp;&amp;"</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawIfThenElse</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">RawLit</span><span class="p">(</span><span class="n">o</span><span class="p">,</span><span class="n">LitBool</span> <span class="n">false</span><span class="p">)))</span>
                <span class="o">|</span> <span class="s2">"||"</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawIfThenElse</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">RawLit</span><span class="p">(</span><span class="n">o</span><span class="p">,</span><span class="n">LitBool</span> <span class="n">true</span><span class="p">),</span><span class="n">b</span><span class="p">))</span>
                <span class="o">|</span> <span class="s2">","</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">RawPair</span>
                <span class="o">|</span> <span class="s2">"&lt;-"</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span>
                    <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="n">l</span> <span class="o">=</span> <span class="n">function</span>
                        <span class="o">|</span> <span class="n">RawApply</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="p">(</span><span class="n">b</span> <span class="p">::</span> <span class="n">l</span><span class="p">)</span> <span class="n">a</span>
                        <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="p">,</span> <span class="n">l</span>
                    <span class="n">let</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="n">loop</span> <span class="p">[]</span> <span class="n">a</span>
                    <span class="n">RawHeapMutableSet</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawApply</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">RawApply</span><span class="p">(</span><span class="n">r</span> <span class="o">+.</span> <span class="n">o</span><span class="p">,</span><span class="n">rawv</span><span class="p">(</span><span class="n">o</span><span class="p">,</span><span class="n">x</span><span class="p">),</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">))</span>
        <span class="p">)</span>

<span class="n">let</span> <span class="n">private</span> <span class="n">string_to_op_dict</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">Generic</span><span class="o">.</span><span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Structural</span><span class="p">)</span>
<span class="n">Microsoft</span><span class="o">.</span><span class="n">FSharp</span><span class="o">.</span><span class="n">Reflection</span><span class="o">.</span><span class="n">FSharpType</span><span class="o">.</span><span class="n">GetUnionCases</span><span class="p">(</span><span class="n">typeof</span><span class="o">&lt;</span><span class="n">Op</span><span class="o">&gt;</span><span class="p">)</span>
<span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">string_to_op_dict</span><span class="o">.</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">Name</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">Microsoft</span><span class="o">.</span><span class="n">FSharp</span><span class="o">.</span><span class="n">Reflection</span><span class="o">.</span><span class="n">FSharpValue</span><span class="o">.</span><span class="n">MakeUnion</span><span class="p">(</span><span class="n">x</span><span class="p">,[</span><span class="o">||</span><span class="p">])</span> <span class="p">:</span><span class="err">?</span><span class="o">&gt;</span> <span class="n">Op</span><span class="p">)</span>
<span class="n">let</span> <span class="n">string_to_op</span> <span class="n">x</span> <span class="o">=</span> <span class="n">string_to_op_dict</span><span class="o">.</span><span class="n">TryGetValue</span> <span class="n">x</span>

<span class="n">let</span> <span class="n">symbol_paired_concat</span> <span class="n">k</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">b</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Text</span><span class="o">.</span><span class="n">StringBuilder</span><span class="p">()</span>
    <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">x</span> <span class="p">:</span> <span class="n">string</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">b</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="s1">'_'</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">ignore</span><span class="p">)</span> <span class="n">k</span>
    <span class="n">b</span><span class="o">.</span><span class="n">ToString</span><span class="p">()</span>

<span class="n">let</span> <span class="n">module_openBlockParsing</span> <span class="o">=</span> <span class="n">rangeBlockParsing</span> <span class="p">((</span><span class="n">skip_keyword</span> <span class="n">SpecOpen</span> <span class="o">&gt;&gt;.</span> <span class="n">read_small_var</span><span class="s1">') .&gt;&gt;. (many read_symbol))</span>
<span class="n">let</span> <span class="n">bar</span> <span class="n">i</span> <span class="n">d</span> <span class="o">=</span> <span class="n">indentBlockParsing</span> <span class="n">i</span> <span class="p">(</span><span class="o">&lt;=</span><span class="p">)</span> <span class="p">(</span><span class="n">skip_op</span> <span class="s2">"|"</span><span class="p">)</span> <span class="n">d</span>

<span class="n">let</span> <span class="n">inline</span> <span class="n">pat_pair</span> <span class="nb">next</span> <span class="o">=</span> 
    <span class="n">sepBy1</span> <span class="nb">next</span> <span class="p">(</span><span class="n">skip_op</span> <span class="s2">","</span><span class="p">)</span> 
    <span class="o">|&gt;&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">reduceBack</span> <span class="p">(</span><span class="n">fun</span> <span class="n">a</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">PatPair</span><span class="p">(</span><span class="n">range_of_pattern</span> <span class="n">a</span> <span class="o">+.</span> <span class="n">range_of_pattern</span> <span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span>

<span class="nb">type</span> <span class="n">RootTypeFlags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">allow_typecase_metavars</span> <span class="p">:</span> <span class="nb">bool</span>
    <span class="n">allow_term</span> <span class="p">:</span> <span class="nb">bool</span>
    <span class="n">allow_wildcard</span> <span class="p">:</span> <span class="nb">bool</span>
    <span class="p">}</span>

<span class="n">let</span> <span class="n">root_type_defaults</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">allow_typecase_metavars</span> <span class="o">=</span> <span class="n">false</span>
    <span class="n">allow_term</span> <span class="o">=</span> <span class="n">false</span>
    <span class="n">allow_wildcard</span> <span class="o">=</span> <span class="n">false</span>
    <span class="p">}</span>

<span class="n">let</span> <span class="n">bottom_up_number</span> <span class="p">(</span><span class="n">default_env</span> <span class="p">:</span> <span class="n">DefaultEnv</span><span class="p">)</span> <span class="p">(</span><span class="n">r</span> <span class="p">:</span> <span class="n">VSCRange</span><span class="p">,</span><span class="n">x</span> <span class="p">:</span> <span class="n">string</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">inline</span> <span class="n">f</span> <span class="n">string_to_val</span> <span class="n">val_to_lit</span> <span class="n">val_dsc</span> <span class="o">=</span>
        <span class="k">match</span> <span class="n">string_to_val</span> <span class="n">x</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">true</span><span class="p">,</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Ok</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">val_to_lit</span> <span class="n">x</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">false</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">BottomUpNumberParseError</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">val_dsc</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">Contains</span> <span class="s1">'.'</span> <span class="n">then</span>
        <span class="k">match</span> <span class="n">default_env</span><span class="o">.</span><span class="n">default_float</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">Float32T</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">System</span><span class="o">.</span><span class="n">Single</span><span class="o">.</span><span class="n">TryParse</span> <span class="n">LitFloat32</span> <span class="s2">"f32"</span>
        <span class="o">|</span> <span class="n">Float64T</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">System</span><span class="o">.</span><span class="n">Double</span><span class="o">.</span><span class="n">TryParse</span> <span class="n">LitFloat64</span> <span class="s2">"f64"</span>
        <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">failwithf</span> <span class="s2">"Compiler error: Invalid default float type. Got: %A"</span> <span class="n">x</span>
    <span class="k">else</span>
        <span class="k">match</span> <span class="n">default_env</span><span class="o">.</span><span class="n">default_int</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">Int8T</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">System</span><span class="o">.</span><span class="n">SByte</span><span class="o">.</span><span class="n">TryParse</span> <span class="n">LitInt8</span> <span class="s2">"i8"</span>
        <span class="o">|</span> <span class="n">Int16T</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">System</span><span class="o">.</span><span class="n">Int16</span><span class="o">.</span><span class="n">TryParse</span> <span class="n">LitInt16</span> <span class="s2">"i16"</span>
        <span class="o">|</span> <span class="n">Int32T</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">System</span><span class="o">.</span><span class="n">Int32</span><span class="o">.</span><span class="n">TryParse</span> <span class="n">LitInt32</span> <span class="s2">"i32"</span>
        <span class="o">|</span> <span class="n">Int64T</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">System</span><span class="o">.</span><span class="n">Int64</span><span class="o">.</span><span class="n">TryParse</span> <span class="n">LitInt64</span> <span class="s2">"i64"</span>
        <span class="o">|</span> <span class="n">UInt8T</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">System</span><span class="o">.</span><span class="n">Byte</span><span class="o">.</span><span class="n">TryParse</span> <span class="n">LitUInt8</span> <span class="s2">"u8"</span>
        <span class="o">|</span> <span class="n">UInt16T</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">System</span><span class="o">.</span><span class="n">UInt16</span><span class="o">.</span><span class="n">TryParse</span> <span class="n">LitUInt16</span> <span class="s2">"u16"</span>
        <span class="o">|</span> <span class="n">UInt32T</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">System</span><span class="o">.</span><span class="n">UInt32</span><span class="o">.</span><span class="n">TryParse</span> <span class="n">LitUInt32</span> <span class="s2">"u32"</span>
        <span class="o">|</span> <span class="n">UInt64T</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">System</span><span class="o">.</span><span class="n">UInt64</span><span class="o">.</span><span class="n">TryParse</span> <span class="n">LitUInt64</span> <span class="s2">"u64"</span>
        <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">failwithf</span> <span class="s2">"Compiler error: Invalid default int type. Got: %A"</span> <span class="n">x</span>

<span class="n">let</span> <span class="n">typecase_validate</span> <span class="n">x</span> <span class="n">_</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">metavars</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">Generic</span><span class="o">.</span><span class="n">HashSet</span><span class="p">()</span>    
    <span class="n">let</span> <span class="nb">vars</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">Generic</span><span class="o">.</span><span class="n">HashSet</span><span class="p">()</span>
    <span class="n">let</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">ResizeArray</span><span class="p">()</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">f</span> <span class="o">=</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">RawTFilledNominal</span> <span class="n">_</span> <span class="o">|</span> <span class="n">RawTTerm</span> <span class="n">_</span> <span class="o">|</span> <span class="n">RawTTypecase</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: This case is not supposed to appear in typecase."</span>
        <span class="o">|</span> <span class="n">RawTForall</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">ForallNotAllowedInTypecase</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawTExists</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">ExistsNotAllowedInTypecase</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawTLit</span> <span class="n">_</span> <span class="o">|</span> <span class="n">RawTPrim</span> <span class="n">_</span> <span class="o">|</span> <span class="n">RawTSymbol</span> <span class="n">_</span> <span class="o">|</span> <span class="n">RawTB</span> <span class="n">_</span> <span class="o">|</span> <span class="n">RawTWildcard</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="p">()</span>
        <span class="o">|</span> <span class="n">RawTMetaVar</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="nb">vars</span><span class="o">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="n">then</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">MetavarShadowedByVar</span><span class="p">)</span> <span class="k">else</span> <span class="n">metavars</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
        <span class="o">|</span> <span class="n">RawTVar</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">metavars</span><span class="o">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="n">then</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">VarShadowedByMetavar</span><span class="p">)</span> <span class="k">else</span> <span class="nb">vars</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
        <span class="o">|</span> <span class="n">RawTApply</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="n">RawTFun</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">RawTPair</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span><span class="p">;</span> <span class="n">f</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">RawTLayout</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">RawTArray</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">RawTUnion</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="p">(</span><span class="n">snd</span> <span class="n">x</span><span class="p">))</span> <span class="n">a</span> 
        <span class="o">|</span> <span class="n">RawTRecord</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">RawTMacro</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">function</span> <span class="n">RawMacroType</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span> <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="p">())</span>
    <span class="n">f</span> <span class="n">x</span>
    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Count</span> <span class="n">then</span> <span class="n">Error</span> <span class="p">(</span><span class="n">Seq</span><span class="o">.</span><span class="n">toList</span> <span class="n">errors</span><span class="p">)</span> <span class="k">else</span> <span class="n">Ok</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="o">//</span> <span class="n">Parses</span> <span class="n">an</span> <span class="n">expression</span> <span class="n">only</span> <span class="k">if</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">directly</span> <span class="nb">next</span> <span class="n">to</span> <span class="n">the</span> <span class="n">previous</span> <span class="n">one</span><span class="o">.</span>
<span class="n">let</span> <span class="n">inline</span> <span class="n">expr_tight</span> <span class="nb">next</span> <span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="n">BlockParsingEnv</span><span class="p">)</span> <span class="o">=</span> 
    <span class="n">let</span> <span class="n">i</span> <span class="o">=</span> <span class="n">indexBlockParsing</span> <span class="n">d</span>
    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">d</span><span class="o">.</span><span class="n">tokens</span><span class="o">.</span><span class="n">Length</span> <span class="n">then</span>
        <span class="n">let</span> <span class="n">r</span><span class="p">,</span><span class="sa">r</span><span class="s1">' = snd (fst d.tokens.[i-1]), fst (fst d.tokens.[i])</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">line</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">'.line &amp;&amp; r.character = r'</span><span class="o">.</span><span class="n">character</span> <span class="n">then</span> <span class="nb">next</span> <span class="n">d</span> <span class="k">else</span> <span class="n">Error</span> <span class="p">[]</span>
    <span class="k">else</span> <span class="n">Error</span> <span class="p">[]</span>

<span class="n">let</span> <span class="n">inline</span> <span class="n">read_default_value</span><span class="s1">' f d =</span>
    <span class="n">try_current</span> <span class="n">d</span> <span class="o">&lt;|</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">TokDefaultValue</span> <span class="n">t</span><span class="s1">' -&gt; skipBlockParsing d; f (p,t'</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="n">ExpectedLit</span><span class="p">]</span>
<span class="n">let</span> <span class="n">inline</span> <span class="n">read_default_value</span> <span class="n">on_top</span> <span class="n">on_bot</span> <span class="n">d</span> <span class="o">=</span>
    <span class="n">read_default_value</span><span class="s1">' (fun (p,t'</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">is_top_down</span> <span class="n">then</span> <span class="n">Ok</span><span class="p">(</span><span class="n">on_top</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">t</span><span class="s1">'))</span>
        <span class="k">else</span> <span class="n">bottom_up_number</span> <span class="n">d</span><span class="o">.</span><span class="n">default_env</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">t</span><span class="s1">') |&gt; Result.map on_bot</span>
        <span class="p">)</span> <span class="n">d</span>
<span class="n">let</span> <span class="n">read_string</span> <span class="o">=</span> <span class="n">tuple3</span> <span class="n">skip_string_open</span> <span class="p">((</span><span class="n">read_text</span> <span class="n">false</span> <span class="o">|&gt;&gt;</span> <span class="n">snd</span><span class="p">)</span> <span class="o">&lt;|&gt;%</span> <span class="s2">""</span><span class="p">)</span> <span class="n">skip_string_close</span>
<span class="n">let</span> <span class="n">pat_var</span> <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">read_small_var</span><span class="s1">' |&gt;&gt; PatVar) d</span>
<span class="n">let</span> <span class="n">pat_list_pair</span> <span class="n">r</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">PatUnbox</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="s2">"Cons"</span><span class="p">,</span><span class="n">PatPair</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span>
<span class="n">let</span> <span class="n">rec</span> <span class="n">root_pattern_var_nominal_union</span> <span class="n">s</span> <span class="o">=</span>
    <span class="p">(</span><span class="n">read_var</span><span class="s1">' &gt;&gt;= fun (r,a,re) s -&gt;</span>
        <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">Char</span><span class="o">.</span><span class="n">IsUpper</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="n">then</span>
            <span class="p">(</span><span class="n">opt</span> <span class="n">root_pattern_var</span> <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="n">b</span> <span class="o">-&gt;</span>
                <span class="n">re</span> <span class="n">SemanticTokenLegend</span><span class="o">.</span><span class="n">symbol</span>
                <span class="n">let</span> <span class="n">b</span> <span class="o">=</span> <span class="n">match</span> <span class="n">b</span> <span class="k">with</span> <span class="n">Some</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">b</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">PatE</span> <span class="n">r</span>
                <span class="n">PatUnbox</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
                <span class="p">)</span> <span class="n">s</span>
        <span class="k">else</span> 
            <span class="p">(</span><span class="n">many</span> <span class="p">(</span><span class="n">expr_tight</span> <span class="n">read_symbol</span><span class="p">)</span> <span class="o">&gt;&gt;=</span> <span class="n">fun</span> <span class="n">syms</span> <span class="n">s</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">syms</span> <span class="k">with</span>
                <span class="o">|</span> <span class="p">[]</span> <span class="o">-&gt;</span>
                    <span class="p">(</span><span class="n">opt</span> <span class="n">root_pattern_var</span> <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="n">b</span> <span class="o">-&gt;</span>
                        <span class="k">match</span> <span class="n">b</span> <span class="k">with</span>
                        <span class="o">|</span> <span class="n">Some</span> <span class="n">b</span> <span class="o">-&gt;</span>
                            <span class="n">re</span> <span class="n">SemanticTokenLegend</span><span class="o">.</span><span class="n">type_variable</span>
                            <span class="n">PatNominal</span><span class="p">(</span><span class="n">r</span> <span class="o">+.</span> <span class="n">range_of_pattern</span> <span class="n">b</span><span class="p">,(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">syms</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
                        <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span>
                            <span class="n">PatVar</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
                        <span class="p">)</span> <span class="n">s</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span>
                    <span class="p">(</span><span class="n">root_pattern_var</span> <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="n">b</span> <span class="o">-&gt;</span>
                        <span class="n">re</span> <span class="n">SemanticTokenLegend</span><span class="o">.</span><span class="n">type_variable</span>
                        <span class="n">PatNominal</span><span class="p">(</span><span class="n">r</span> <span class="o">+.</span> <span class="n">range_of_pattern</span> <span class="n">b</span><span class="p">,(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">syms</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
                        <span class="p">)</span> <span class="n">s</span>
                <span class="p">)</span> <span class="n">s</span>
        <span class="p">)</span> <span class="n">s</span>
<span class="ow">and</span> <span class="n">root_pattern_wildcard</span> <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">skip_keyword</span><span class="s1">' SpecWildcard |&gt;&gt; PatE) d</span>
<span class="ow">and</span> <span class="n">root_pattern_dyn</span> <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">rangeBlockParsing</span> <span class="p">(</span><span class="n">skip_unary_op</span> <span class="s2">"~"</span> <span class="o">&gt;&gt;.</span> <span class="n">root_pattern_var</span><span class="p">)</span> <span class="o">|&gt;&gt;</span> <span class="n">PatDyn</span><span class="p">)</span> <span class="n">d</span>
<span class="ow">and</span> <span class="n">root_pattern_record</span> <span class="n">d</span> <span class="o">=</span> 
    <span class="n">let</span> <span class="n">pat_record_item</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">inj</span> <span class="o">=</span> <span class="n">skip_unary_op</span> <span class="s2">"$"</span> <span class="o">&gt;&gt;.</span> <span class="n">read_small_var</span><span class="s1">' |&gt;&gt; fun a -&gt; PatRecordMembersInjectVar,a</span>
        <span class="n">let</span> <span class="n">var</span> <span class="o">=</span> <span class="n">rangeBlockParsing</span> <span class="n">record_var</span> <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">PatRecordMembersSymbol</span><span class="p">,</span><span class="n">a</span>
        <span class="p">((</span><span class="n">inj</span> <span class="o">&lt;|&gt;</span> <span class="n">var</span><span class="p">)</span> <span class="o">.&gt;&gt;.</span> <span class="p">(</span><span class="n">opt</span> <span class="p">(</span><span class="n">skip_op</span> <span class="s2">"="</span> <span class="o">&gt;&gt;.</span> <span class="n">root_pattern_pair</span><span class="p">)))</span>
        <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="p">((</span><span class="n">f</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">defaultArg</span> <span class="n">b</span> <span class="p">(</span><span class="n">PatVar</span> <span class="n">a</span><span class="p">))</span>
    <span class="p">(</span><span class="n">rangeBlockParsing</span> <span class="p">(</span><span class="n">curlies</span> <span class="p">(</span><span class="n">many</span> <span class="n">pat_record_item</span><span class="p">))</span> <span class="o">|&gt;&gt;</span> <span class="n">PatRecordMembers</span><span class="p">)</span> <span class="n">d</span>
<span class="ow">and</span> <span class="n">root_pattern_type</span> <span class="n">s</span> <span class="o">=</span> 
    <span class="n">pipe2</span> <span class="n">root_pattern</span> <span class="p">(</span><span class="n">opt</span> <span class="p">(</span><span class="n">skip_op</span> <span class="s2">":"</span> <span class="o">&gt;&gt;.</span> <span class="n">root_type_annot</span><span class="p">))</span>
        <span class="p">(</span><span class="n">fun</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">function</span> <span class="n">Some</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">PatAnnot</span><span class="p">(</span><span class="n">range_of_pattern</span> <span class="n">a</span> <span class="o">+.</span> <span class="n">range_of_texpr</span> <span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="p">)</span> <span class="n">s</span>
<span class="ow">and</span> <span class="n">root_pattern_rounds</span> <span class="n">d</span> <span class="o">=</span> 
    <span class="p">(</span><span class="n">rangeBlockParsing</span> <span class="p">(</span><span class="n">rounds</span> <span class="p">((((</span><span class="n">read_op</span><span class="s1">' |&gt;&gt; PatVar) &lt;|&gt; root_pattern_type) |&gt;&gt; fun x _ -&gt; x) &lt;|&gt;% PatB))</span>
    <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="n">r</span><span class="p">)</span> <span class="n">d</span>
<span class="ow">and</span> <span class="n">pat_array</span> <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">skip_unary_op</span> <span class="s2">";"</span> <span class="o">&gt;&gt;.</span> <span class="n">rangeBlockParsing</span> <span class="p">(</span><span class="n">squares</span> <span class="p">(</span><span class="n">sepBy</span> <span class="n">root_pattern_type</span> <span class="p">(</span><span class="n">skip_op</span> <span class="s2">";"</span><span class="p">)))</span> <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PatArray</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">))</span> <span class="n">s</span>
<span class="ow">and</span> <span class="n">pat_list</span> <span class="n">s</span> <span class="o">=</span>
    <span class="p">(</span><span class="n">rangeBlockParsing</span> <span class="p">(</span><span class="n">squares</span> <span class="p">(</span><span class="n">sepBy</span> <span class="n">root_pattern_type</span> <span class="p">(</span><span class="n">skip_op</span> <span class="s2">";"</span><span class="p">)))</span>
    <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">),</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="n">List</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">pat_list_pair</span> <span class="n">r</span><span class="p">)</span> <span class="n">x</span> <span class="p">(</span><span class="n">PatUnbox</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="s2">"Nil"</span><span class="p">,</span><span class="n">PatB</span> <span class="n">r</span><span class="p">)))</span> <span class="n">s</span>
<span class="ow">and</span> <span class="n">pat_exists</span> <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">rangeBlockParsing</span> <span class="p">(</span><span class="n">pat_exists</span><span class="s1">' .&gt;&gt;. root_pattern) |&gt;&gt; fun (r,(l,b)) -&gt; PatExists(r,l,b)) s</span>
<span class="ow">and</span> <span class="n">root_pattern</span> <span class="n">s</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">body</span> <span class="n">s</span> <span class="o">=</span> 
        <span class="n">let</span> <span class="n">pat_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">read_value</span> <span class="o">|&gt;&gt;</span> <span class="n">PatValue</span><span class="p">)</span> <span class="o">&lt;|&gt;</span> <span class="p">(</span><span class="n">read_default_value</span> <span class="n">PatDefaultValue</span> <span class="n">PatValue</span><span class="p">)</span>
        <span class="n">let</span> <span class="n">pat_string</span> <span class="o">=</span> <span class="n">read_string</span> <span class="o">|&gt;&gt;</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PatValue</span><span class="p">(</span><span class="n">a</span> <span class="o">+.</span> <span class="n">b</span><span class="p">,</span><span class="n">LitString</span> <span class="n">x</span><span class="p">))</span>
        <span class="n">let</span> <span class="n">pat_symbol</span> <span class="o">=</span> <span class="n">read_symbol</span> <span class="o">|&gt;&gt;</span> <span class="n">PatSymbol</span>
        <span class="n">let</span> <span class="p">(</span><span class="o">+</span><span class="p">)</span> <span class="o">=</span> <span class="n">alt</span> <span class="p">(</span><span class="n">indexBlockParsing</span> <span class="n">s</span><span class="p">)</span>
        <span class="p">(</span><span class="n">root_pattern_rounds</span> <span class="o">+</span> <span class="n">root_pattern_var_nominal_union</span> <span class="o">+</span> <span class="n">root_pattern_wildcard</span> <span class="o">+</span> <span class="n">root_pattern_dyn</span> <span class="o">+</span> <span class="n">pat_value</span> <span class="o">+</span> <span class="n">pat_string</span> 
        <span class="o">+</span> <span class="n">root_pattern_record</span> <span class="o">+</span> <span class="n">pat_symbol</span> <span class="o">+</span> <span class="n">pat_array</span> <span class="o">+</span> <span class="n">pat_list</span> <span class="o">+</span> <span class="n">pat_exists</span><span class="p">)</span> <span class="n">s</span>

    <span class="n">let</span> <span class="n">pat_and</span> <span class="o">=</span> <span class="n">sepBy1</span> <span class="n">body</span> <span class="p">(</span><span class="n">skip_op</span> <span class="s2">"&amp;"</span><span class="p">)</span> <span class="o">|&gt;&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">reduce</span> <span class="p">(</span><span class="n">fun</span> <span class="n">a</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">PatAnd</span><span class="p">(</span><span class="n">range_of_pattern</span> <span class="n">a</span> <span class="o">+.</span> <span class="n">range_of_pattern</span> <span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span>
    <span class="n">let</span> <span class="n">pat_pair</span> <span class="o">=</span> <span class="n">pat_pair</span> <span class="n">pat_and</span>
    <span class="n">let</span> <span class="n">pat_cons</span> <span class="o">=</span> <span class="n">rangeBlockParsing</span> <span class="p">(</span><span class="n">sepBy1</span> <span class="n">pat_pair</span> <span class="p">(</span><span class="n">skip_op</span> <span class="s2">"::"</span><span class="p">))</span> <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">reduceBack</span> <span class="p">(</span><span class="n">pat_list_pair</span> <span class="n">r</span><span class="p">)</span> <span class="n">x</span>
    <span class="n">let</span> <span class="n">pat_or</span> <span class="o">=</span> <span class="n">sepBy1</span> <span class="n">pat_cons</span> <span class="p">(</span><span class="n">skip_op</span> <span class="s2">"|"</span><span class="p">)</span> <span class="o">|&gt;&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">reduce</span> <span class="p">(</span><span class="n">fun</span> <span class="n">a</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">PatOr</span><span class="p">(</span><span class="n">range_of_pattern</span> <span class="n">a</span> <span class="o">+.</span> <span class="n">range_of_pattern</span> <span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span>
    <span class="n">let</span> <span class="n">pat_as</span> <span class="o">=</span> <span class="n">pat_or</span> <span class="o">.&gt;&gt;.</span> <span class="p">(</span><span class="n">opt</span> <span class="p">(</span><span class="n">skip_keyword</span> <span class="n">SpecAs</span> <span class="o">&gt;&gt;.</span> <span class="n">pat_or</span> <span class="p">))</span> <span class="o">|&gt;&gt;</span> <span class="n">function</span> <span class="n">a</span><span class="p">,</span> <span class="n">Some</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">PatAnd</span><span class="p">(</span><span class="n">range_of_pattern</span> <span class="n">a</span> <span class="o">+.</span> <span class="n">range_of_pattern</span> <span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">a</span>
    <span class="n">pat_as</span> <span class="n">s</span>
<span class="ow">and</span> <span class="n">root_pattern_when</span> <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">root_pattern</span> <span class="o">.&gt;&gt;.</span> <span class="p">(</span><span class="n">opt</span> <span class="p">(</span><span class="n">skip_keyword</span> <span class="n">SpecWhen</span> <span class="o">&gt;&gt;.</span> <span class="n">root_term</span><span class="p">))</span> <span class="o">|&gt;&gt;</span> <span class="n">function</span> <span class="n">a</span><span class="p">,</span> <span class="n">Some</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">PatWhen</span><span class="p">(</span><span class="n">range_of_pattern</span> <span class="n">a</span> <span class="o">+.</span> <span class="n">range_of_expr</span> <span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="p">)</span> <span class="n">d</span>
<span class="ow">and</span> <span class="n">root_pattern_var</span> <span class="n">d</span> <span class="o">=</span>
    <span class="n">let</span> <span class="p">(</span><span class="o">+</span><span class="p">)</span> <span class="o">=</span> <span class="n">alt</span> <span class="p">(</span><span class="n">indexBlockParsing</span> <span class="n">d</span><span class="p">)</span>
    <span class="p">(</span><span class="n">pat_var</span> <span class="o">+</span> <span class="n">root_pattern_wildcard</span> <span class="o">+</span> <span class="n">root_pattern_dyn</span> <span class="o">+</span> <span class="n">root_pattern_rounds</span> <span class="o">+</span> <span class="n">root_pattern_record</span> <span class="o">+</span> <span class="n">pat_array</span> <span class="o">+</span> <span class="n">pat_list</span> <span class="o">+</span> <span class="n">pat_exists</span><span class="p">)</span> <span class="n">d</span>
<span class="ow">and</span> <span class="n">root_pattern_pair</span> <span class="n">d</span> <span class="o">=</span> <span class="n">pat_pair</span> <span class="n">root_pattern_var</span> <span class="n">d</span>
<span class="ow">and</span> <span class="n">root_type_annot</span> <span class="n">d</span> <span class="o">=</span> <span class="n">root_type</span> <span class="p">{</span><span class="n">root_type_defaults</span> <span class="k">with</span> <span class="n">allow_term</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">is_top_down</span><span class="o">=</span><span class="n">false</span><span class="p">;</span> <span class="n">allow_wildcard</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">is_top_down</span><span class="p">}</span> <span class="n">d</span>
<span class="ow">and</span> <span class="n">root_type_record</span> <span class="p">(</span><span class="n">flags</span> <span class="p">:</span> <span class="n">RootTypeFlags</span><span class="p">)</span> <span class="n">d</span> <span class="o">=</span>
    <span class="p">(</span><span class="n">rangeBlockParsing</span> <span class="p">(</span><span class="n">curlies</span> <span class="p">(</span><span class="n">sepBy</span> <span class="p">((</span><span class="n">rangeBlockParsing</span> <span class="n">record_var</span> <span class="o">.&gt;&gt;</span> <span class="n">skip_op</span> <span class="s2">":"</span><span class="p">)</span> <span class="o">.&gt;&gt;.</span> <span class="n">root_type</span> <span class="n">flags</span><span class="p">)</span> <span class="p">(</span><span class="n">optional</span> <span class="p">(</span><span class="n">skip_op</span> <span class="s2">";"</span><span class="p">))))</span>
    <span class="o">&gt;&gt;=</span> <span class="n">fun</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="n">_</span> <span class="o">-&gt;</span>
        <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="n">fst</span> <span class="o">|&gt;</span> <span class="n">duplicates</span> <span class="n">DuplicateRecordTypeVar</span>
        <span class="o">|&gt;</span> <span class="n">function</span> <span class="p">[]</span> <span class="o">-&gt;</span> <span class="n">Ok</span><span class="p">(</span><span class="n">RawTRecord</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">mapi</span> <span class="p">(</span><span class="n">fun</span> <span class="n">i</span> <span class="p">((</span><span class="n">_</span><span class="p">,</span><span class="n">n</span><span class="p">),</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">n</span><span class="p">),</span><span class="n">x</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">ofList</span><span class="p">))</span> <span class="o">|</span> <span class="n">er</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">er</span>
        <span class="p">)</span> <span class="n">d</span>
<span class="ow">and</span> <span class="n">root_type_union</span> <span class="p">(</span><span class="n">flags</span> <span class="p">:</span> <span class="n">RootTypeFlags</span><span class="p">)</span> <span class="n">d</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">bar</span> <span class="o">=</span> <span class="n">bar</span> <span class="p">(</span><span class="n">col</span> <span class="n">d</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">vanilla</span> <span class="o">=</span> <span class="n">skip_op</span> <span class="s2">":"</span> <span class="o">&gt;&gt;.</span> <span class="n">root_type</span> <span class="n">flags</span> <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Some</span> <span class="p">(</span><span class="n">false</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">gadt</span> <span class="o">=</span> 
        <span class="n">skip_op</span> <span class="s2">"::"</span>
        <span class="o">&gt;&gt;.</span> <span class="n">pipe2</span> <span class="p">(</span><span class="n">opt</span> <span class="n">forall</span><span class="p">)</span> <span class="p">(</span><span class="n">root_type</span> <span class="n">flags</span><span class="p">)</span> <span class="p">(</span><span class="n">Option</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">List</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="n">a</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">RawTForall</span><span class="p">(</span><span class="n">range_of_typevar</span> <span class="n">a</span> <span class="o">+.</span> <span class="n">range_of_texpr</span> <span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))))</span>
        <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Some</span> <span class="p">(</span><span class="n">true</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

    <span class="n">let</span> <span class="n">body</span> <span class="o">=</span> <span class="n">vanilla</span> <span class="o">&lt;|&gt;</span> <span class="n">gadt</span> <span class="o">&lt;|&gt;%</span> <span class="kc">None</span>
    <span class="p">(</span><span class="n">rangeBlockParsing</span> <span class="p">(</span><span class="n">optional</span> <span class="n">bar</span> <span class="o">&gt;&gt;.</span> <span class="n">sepBy1</span> <span class="p">(</span><span class="n">rangeBlockParsing</span> <span class="n">read_big_var_as_symbol</span> <span class="o">.&gt;&gt;.</span> <span class="n">body</span><span class="p">)</span> <span class="n">bar</span><span class="p">)</span>
    <span class="o">&gt;&gt;=</span> <span class="n">fun</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="n">_</span> <span class="o">-&gt;</span>
        <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="n">fst</span> <span class="o">|&gt;</span> <span class="n">duplicates</span> <span class="n">DuplicateUnionKey</span>
        <span class="o">|&gt;</span> <span class="n">function</span> 
            <span class="o">|</span> <span class="p">[]</span> <span class="o">-&gt;</span> <span class="n">Ok</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">mapi</span> <span class="p">(</span><span class="n">fun</span> <span class="n">i</span> <span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">),</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">n</span><span class="p">),</span> <span class="n">match</span> <span class="n">x</span> <span class="k">with</span> <span class="n">Some</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">false</span><span class="p">,</span> <span class="n">RawTB</span> <span class="n">r</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">ofList</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">er</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">er</span>
        <span class="p">)</span> <span class="n">d</span>
<span class="ow">and</span> <span class="n">root_type</span> <span class="p">(</span><span class="n">flags</span> <span class="p">:</span> <span class="n">RootTypeFlags</span><span class="p">)</span> <span class="n">d</span> <span class="o">=</span>
    <span class="n">let</span> <span class="nb">next</span> <span class="o">=</span> <span class="n">root_type</span> <span class="n">flags</span>
    <span class="n">let</span> <span class="n">cases</span> <span class="n">d</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">wildcard</span> <span class="n">d</span> <span class="o">=</span> <span class="k">if</span> <span class="n">flags</span><span class="o">.</span><span class="n">allow_wildcard</span> <span class="n">then</span> <span class="p">(</span><span class="n">skip_keyword</span><span class="s1">' SpecWildcard |&gt;&gt; RawTWildcard) d else Error []</span>
        <span class="o">//</span> <span class="n">This</span> <span class="n">metavar</span> <span class="n">case</span> <span class="n">only</span> <span class="n">occurs</span> <span class="ow">in</span> <span class="n">typecase</span> <span class="n">during</span> <span class="n">the</span> <span class="n">bottom</span><span class="o">-</span><span class="n">up</span> <span class="n">segment</span><span class="o">.</span> <span class="n">It</span> <span class="n">should</span> <span class="ow">not</span> <span class="n">be</span> <span class="n">confused</span> <span class="k">with</span> <span class="n">metavars</span> <span class="n">during</span> <span class="n">top</span><span class="o">-</span><span class="n">down</span> <span class="nb">type</span> <span class="n">inference</span><span class="o">.</span>
        <span class="n">let</span> <span class="n">metavar</span> <span class="n">d</span> <span class="o">=</span> <span class="k">if</span> <span class="n">flags</span><span class="o">.</span><span class="n">allow_typecase_metavars</span> <span class="n">then</span> <span class="p">(</span><span class="n">skip_unary_op</span> <span class="s2">"~"</span> <span class="o">&gt;&gt;.</span> <span class="n">read_var</span><span class="s1">' |&gt;&gt; fun (a,b,r) -&gt; r SemanticTokenLegend.type_variable; RawTMetaVar(a,b)) d else Error []</span>
        <span class="n">let</span> <span class="n">term</span> <span class="n">d</span> <span class="o">=</span> <span class="k">if</span> <span class="n">flags</span><span class="o">.</span><span class="n">allow_term</span> <span class="n">then</span> <span class="p">(</span><span class="n">rangeBlockParsing</span> <span class="p">(</span><span class="n">skip_unary_op</span> <span class="s2">"`"</span> <span class="o">&gt;&gt;.</span> <span class="p">((</span><span class="n">read_var</span><span class="s1">''</span> <span class="o">|&gt;&gt;</span> <span class="n">rawv</span><span class="p">)</span> <span class="o">&lt;|&gt;</span> <span class="n">rounds</span> <span class="n">root_term</span><span class="p">))</span> <span class="o">|&gt;&gt;</span> <span class="n">RawTTerm</span><span class="p">)</span> <span class="p">{</span><span class="n">d</span> <span class="k">with</span> <span class="n">is_top_down</span><span class="o">=</span><span class="n">false</span><span class="p">}</span> <span class="k">else</span> <span class="n">Error</span> <span class="p">[]</span>
        <span class="n">let</span> <span class="n">symbol</span> <span class="o">=</span> <span class="n">read_symbol</span> <span class="o">|&gt;&gt;</span> <span class="n">RawTSymbol</span>
        <span class="n">let</span> <span class="n">record</span> <span class="o">=</span> <span class="n">root_type_record</span> <span class="n">flags</span>
        <span class="n">let</span> <span class="n">lit</span> <span class="o">=</span> <span class="p">(</span><span class="n">read_value</span> <span class="o">|&gt;&gt;</span> <span class="n">RawTLit</span><span class="p">)</span> <span class="o">&lt;|&gt;</span> <span class="p">(</span><span class="n">read_string</span> <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawTLit</span><span class="p">(</span><span class="n">a</span> <span class="o">+.</span> <span class="n">c</span><span class="p">,</span> <span class="n">LitString</span> <span class="n">b</span><span class="p">))</span>
        <span class="n">let</span> <span class="n">lit_default</span> <span class="o">=</span> <span class="n">read_default_value</span><span class="s1">' (bottom_up_number d.default_env &gt;&gt; Result.map RawTLit)</span>
        <span class="n">let</span> <span class="n">var</span> <span class="o">=</span> <span class="n">read_var</span><span class="s1">' |&gt;&gt; fun (o,x,r) -&gt;</span>
            <span class="n">r</span> <span class="n">SemanticTokenLegend</span><span class="o">.</span><span class="n">type_variable</span>
            <span class="n">RawTVar</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">let</span> <span class="n">rounds</span> <span class="o">=</span>
            <span class="n">rangeBlockParsing</span> <span class="p">(</span><span class="n">rounds</span> <span class="p">((</span><span class="nb">next</span> <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="n">x</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="p">)</span> <span class="o">&lt;|&gt;%</span> <span class="n">RawTB</span><span class="p">))</span>
            <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="n">r</span>
        <span class="n">let</span> <span class="n">macro</span> <span class="o">=</span> 
            <span class="n">let</span> <span class="n">read_macro_expression</span> <span class="n">s</span> <span class="o">=</span> 
                <span class="p">(</span><span class="n">macro_expression</span> <span class="n">MType</span> <span class="p">(</span><span class="n">root_type</span> <span class="n">root_type_defaults</span> <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">RawMacroType</span><span class="p">(</span><span class="n">range_of_texpr</span> <span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">))</span>
                <span class="o">&lt;|&gt;</span> <span class="n">macro_expression</span> <span class="n">MTypeLit</span> <span class="p">(</span><span class="n">root_type</span> <span class="n">root_type_defaults</span> <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">RawMacroTypeLit</span><span class="p">(</span><span class="n">range_of_texpr</span> <span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">)))</span> <span class="n">s</span>
            <span class="n">let</span> <span class="n">body</span> <span class="o">=</span> <span class="n">many</span> <span class="p">((</span><span class="n">read_text</span> <span class="n">false</span> <span class="o">|&gt;&gt;</span> <span class="n">RawMacroText</span><span class="p">)</span> <span class="o">&lt;|&gt;</span> <span class="n">read_macro_type_var</span> <span class="o">&lt;|&gt;</span> <span class="n">read_macro_expression</span><span class="p">)</span>
            <span class="n">pipe3</span> <span class="n">skip_macro_open</span> <span class="n">body</span> <span class="n">skip_macro_close</span> <span class="p">(</span><span class="n">fun</span> <span class="n">a</span> <span class="n">l</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">RawTMacro</span><span class="p">(</span><span class="n">a</span> <span class="o">+.</span> <span class="n">b</span><span class="p">,</span> <span class="n">l</span><span class="p">))</span>
        <span class="n">let</span> <span class="n">exists</span> <span class="o">=</span> <span class="n">rangeBlockParsing</span> <span class="p">(</span><span class="n">exists</span> <span class="o">.&gt;&gt;.</span> <span class="n">root_type</span> <span class="n">flags</span><span class="p">)</span> <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">l</span><span class="p">,</span><span class="n">b</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">RawTExists</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
        <span class="n">let</span> <span class="n">foralls</span> <span class="o">=</span> <span class="n">rangeBlockParsing</span> <span class="p">(</span><span class="n">forall</span> <span class="o">.&gt;&gt;.</span> <span class="n">root_type</span> <span class="n">flags</span><span class="p">)</span> <span class="o">|&gt;&gt;</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">l</span><span class="p">,</span><span class="n">b</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="n">a</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">RawTForall</span><span class="p">(</span><span class="n">range_of_typevar</span> <span class="n">a</span> <span class="o">+.</span> <span class="n">range_of_texpr</span> <span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span> <span class="n">l</span> <span class="n">b</span><span class="p">)</span>
        <span class="n">let</span> <span class="p">(</span><span class="o">+</span><span class="p">)</span> <span class="o">=</span> <span class="n">alt</span> <span class="p">(</span><span class="n">indexBlockParsing</span> <span class="n">d</span><span class="p">)</span>
        <span class="p">(</span><span class="n">rounds</span> <span class="o">+</span> <span class="n">lit</span> <span class="o">+</span> <span class="n">lit_default</span> <span class="o">+</span> <span class="n">wildcard</span> <span class="o">+</span> <span class="n">term</span> <span class="o">+</span> <span class="n">metavar</span> <span class="o">+</span> <span class="n">var</span> <span class="o">+</span> <span class="n">record</span> <span class="o">+</span> <span class="n">symbol</span> <span class="o">+</span> <span class="n">macro</span> <span class="o">+</span> <span class="n">exists</span> <span class="o">+</span> <span class="n">foralls</span><span class="p">)</span> <span class="n">d</span>

    <span class="n">let</span> <span class="n">fold_applies</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">a</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">RawTApply</span><span class="p">(</span><span class="n">range_of_texpr</span> <span class="n">a</span> <span class="o">+.</span> <span class="n">range_of_texpr</span> <span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span> <span class="n">a</span> <span class="n">b</span>
    <span class="n">let</span> <span class="n">apply_tight</span> <span class="n">d</span> <span class="o">=</span> <span class="n">pipe2</span> <span class="n">cases</span> <span class="p">(</span><span class="n">many</span> <span class="p">(</span><span class="n">expr_tight</span> <span class="n">cases</span><span class="p">))</span> <span class="n">fold_applies</span> <span class="n">d</span>
    <span class="n">let</span> <span class="n">apply</span> <span class="n">d</span> <span class="o">=</span> <span class="n">pipe2</span> <span class="n">apply_tight</span> <span class="p">(</span><span class="n">many</span> <span class="p">(</span><span class="n">indentBlockParsing</span> <span class="p">(</span><span class="n">col</span> <span class="n">d</span><span class="p">)</span> <span class="p">(</span><span class="o">&lt;</span><span class="p">)</span> <span class="n">apply_tight</span><span class="p">))</span> <span class="n">fold_applies</span> <span class="n">d</span>
    
    <span class="n">let</span> <span class="n">pairs</span> <span class="o">=</span> <span class="n">sepBy1</span> <span class="n">apply</span> <span class="p">(</span><span class="n">skip_op</span> <span class="s2">"*"</span><span class="p">)</span> <span class="o">|&gt;&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">reduceBack</span> <span class="p">(</span><span class="n">fun</span> <span class="n">a</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">RawTPair</span><span class="p">(</span><span class="n">range_of_texpr</span> <span class="n">a</span> <span class="o">+.</span> <span class="n">range_of_texpr</span> <span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span>
    <span class="n">let</span> <span class="n">functions</span> <span class="o">=</span> <span class="n">sepBy1</span> <span class="n">pairs</span> <span class="p">(</span><span class="n">skip_op</span> <span class="s2">"-&gt;"</span><span class="p">)</span> <span class="o">|&gt;&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">reduceBack</span> <span class="p">(</span><span class="n">fun</span> <span class="n">a</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">RawTFun</span><span class="p">(</span><span class="n">range_of_texpr</span> <span class="n">a</span> <span class="o">+.</span> <span class="n">range_of_texpr</span> <span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">FT_Vanilla</span><span class="p">))</span>
    
    <span class="n">functions</span> <span class="n">d</span>

<span class="ow">and</span> <span class="n">root_term</span> <span class="n">d</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">expressions</span> <span class="n">d</span> <span class="o">=</span>
        <span class="n">let</span> <span class="nb">next</span> <span class="o">=</span> <span class="n">root_term</span>
        <span class="n">let</span> <span class="n">case_var</span> <span class="o">=</span> <span class="n">read_var</span><span class="s1">''</span> <span class="o">|&gt;&gt;</span> <span class="n">rawv</span>
        <span class="n">let</span> <span class="n">case_value</span> <span class="o">=</span> <span class="n">read_value</span> <span class="o">|&gt;&gt;</span> <span class="n">RawLit</span>
        <span class="n">let</span> <span class="n">case_exists</span> <span class="o">=</span> 
            <span class="n">let</span> <span class="n">sequence_type</span> <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">many</span> <span class="p">(</span><span class="n">indentBlockParsing</span> <span class="p">(</span><span class="n">col</span> <span class="n">d</span><span class="p">)</span> <span class="p">(</span><span class="o">=</span><span class="p">)</span> <span class="p">(</span><span class="n">sepBy1</span> <span class="p">(</span><span class="n">root_type</span> <span class="n">root_type_defaults</span><span class="p">)</span>  <span class="p">(</span><span class="n">skip_op</span> <span class="s2">";"</span><span class="p">)))</span> <span class="o">|&gt;&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">concat</span><span class="p">)</span> <span class="n">d</span>
            <span class="p">((</span><span class="n">skip_keyword</span><span class="s1">' SpecExists) .&gt;&gt;. (opt (squares sequence_type)) .&gt;&gt;. next)</span>
                <span class="o">&gt;&gt;=</span> <span class="n">fun</span> <span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">type_vars</span><span class="p">),</span><span class="n">body</span><span class="p">)</span> <span class="n">d</span> <span class="o">-&gt;</span>
                        <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">is_top_down</span> <span class="o">||</span> <span class="n">Option</span><span class="o">.</span><span class="n">isSome</span> <span class="n">type_vars</span>
                        <span class="n">then</span> <span class="n">Ok</span><span class="p">(</span><span class="n">RawExists</span><span class="p">(</span><span class="n">r</span> <span class="o">+.</span> <span class="n">range_of_expr</span> <span class="n">body</span><span class="p">,</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">type_vars</span><span class="p">),</span> <span class="n">body</span><span class="p">))</span>
                        <span class="k">else</span> <span class="n">Error</span> <span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">TypeVarsNeedToBeExplicitForExists</span><span class="p">]</span>
        <span class="n">let</span> <span class="n">case_rounds</span> <span class="o">=</span> 
            <span class="n">rangeBlockParsing</span> <span class="p">(</span><span class="n">rounds</span> <span class="p">((((</span><span class="n">read_op</span><span class="s1">' |&gt;&gt; rawv) &lt;|&gt; next) |&gt;&gt; fun x _ -&gt; x) &lt;|&gt;% RawB))</span>
            <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="n">r</span>
        <span class="n">let</span> <span class="n">case_fun</span> <span class="o">=</span>
            <span class="p">(</span><span class="n">skip_keyword</span> <span class="n">SpecFun</span> <span class="o">&gt;&gt;.</span> <span class="n">many1</span> <span class="n">root_pattern_pair</span> <span class="o">.&gt;&gt;.</span> <span class="p">(</span><span class="n">annotated_body</span> <span class="s2">"=&gt;"</span> <span class="nb">next</span> <span class="n">root_type_annot</span><span class="p">))</span>
            <span class="o">&gt;&gt;=</span> <span class="n">fun</span> <span class="p">(</span><span class="n">pats</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span> <span class="n">_</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">patterns_validate</span> <span class="n">pats</span> <span class="k">with</span>
                <span class="o">|</span> <span class="p">[]</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="n">pat</span> <span class="n">body</span> <span class="o">-&gt;</span> <span class="n">RawFun</span><span class="p">(</span><span class="n">range_of_pattern</span> <span class="n">pat</span> <span class="o">+.</span> <span class="n">range_of_expr</span> <span class="n">body</span><span class="p">,[</span><span class="n">pat</span><span class="p">,</span><span class="n">body</span><span class="p">]))</span> <span class="n">pats</span> <span class="n">body</span> <span class="o">|&gt;</span> <span class="n">Ok</span>
                <span class="o">|</span> <span class="n">ers</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">ers</span>
            
        <span class="n">let</span> <span class="n">case_forall</span> <span class="n">d</span> <span class="o">=</span>
            <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">is_top_down</span> <span class="n">then</span> <span class="n">Error</span> <span class="p">[]</span> <span class="k">else</span>
                <span class="p">(</span><span class="n">tuple3</span> <span class="n">forall</span> <span class="p">(</span><span class="n">many</span> <span class="n">root_pattern_pair</span><span class="p">)</span> <span class="p">(</span><span class="n">annotated_body</span> <span class="s2">"=&gt;"</span> <span class="nb">next</span> <span class="n">root_type_annot</span><span class="p">)</span>
                <span class="o">&gt;&gt;=</span> <span class="n">fun</span> <span class="p">(</span><span class="n">foralls</span> <span class="p">:</span> <span class="n">TypeVar</span> <span class="nb">list</span><span class="p">,</span> <span class="n">pats</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span> <span class="n">_</span> <span class="o">-&gt;</span>
                    <span class="k">match</span> <span class="n">patterns_validate</span> <span class="n">pats</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="p">[]</span> <span class="o">-&gt;</span> 
                        <span class="n">List</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="n">pat</span> <span class="n">body</span> <span class="o">-&gt;</span> <span class="n">RawFun</span><span class="p">(</span><span class="n">range_of_pattern</span> <span class="n">pat</span> <span class="o">+.</span> <span class="n">range_of_expr</span> <span class="n">body</span><span class="p">,[</span><span class="n">pat</span><span class="p">,</span><span class="n">body</span><span class="p">]))</span> <span class="n">pats</span> <span class="n">body</span>
                        <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="n">a</span> <span class="n">body</span> <span class="o">-&gt;</span> <span class="n">RawForall</span><span class="p">(</span><span class="n">range_of_typevar</span> <span class="n">a</span> <span class="o">+.</span> <span class="n">range_of_expr</span> <span class="n">body</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">body</span><span class="p">))</span> <span class="n">foralls</span> <span class="o">|&gt;</span> <span class="n">Ok</span>
                    <span class="o">|</span> <span class="n">ers</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">ers</span><span class="p">)</span> <span class="n">d</span>

        <span class="n">let</span> <span class="n">case_default_value</span> <span class="o">=</span> <span class="n">read_default_value</span> <span class="n">RawDefaultLit</span> <span class="n">RawLit</span>
        <span class="n">let</span> <span class="n">case_if_then_else</span> <span class="n">d</span> <span class="o">=</span>
            <span class="n">let</span> <span class="n">i</span> <span class="o">=</span> <span class="n">col</span> <span class="n">d</span>
            <span class="n">let</span> <span class="n">inline</span> <span class="sa">f</span><span class="s1">' keyword = rangeBlockParsing (skip_keyword keyword &gt;&gt;. next)</span>
            <span class="n">let</span> <span class="n">inline</span> <span class="n">f</span> <span class="n">keyword</span> <span class="o">=</span> <span class="n">indentBlockParsing</span> <span class="n">i</span> <span class="p">(</span><span class="o">&lt;=</span><span class="p">)</span> <span class="p">(</span><span class="sa">f</span><span class="s1">' keyword)</span>
            <span class="p">(</span><span class="n">pipe4</span> <span class="p">(</span><span class="sa">f</span><span class="s1">' SpecIf) (f SpecThen) (many (f SpecElif .&gt;&gt;. f SpecThen)) (opt (f SpecElse))</span>
                <span class="p">(</span><span class="n">fun</span> <span class="n">cond</span> <span class="n">tr</span> <span class="n">elifs</span> <span class="n">fl</span> <span class="o">-&gt;</span> 
                    <span class="n">let</span> <span class="n">f</span> <span class="n">cond</span> <span class="n">tr</span> <span class="o">=</span> <span class="n">function</span>
                        <span class="o">|</span> <span class="n">Some</span> <span class="n">fl</span> <span class="o">-&gt;</span> <span class="n">fst</span> <span class="n">fl</span><span class="p">,</span> <span class="n">RawIfThenElse</span><span class="p">(</span><span class="n">fst</span> <span class="n">cond</span> <span class="o">+.</span> <span class="n">fst</span> <span class="n">fl</span><span class="p">,</span><span class="n">snd</span> <span class="n">cond</span><span class="p">,</span><span class="n">snd</span> <span class="n">tr</span><span class="p">,</span><span class="n">snd</span> <span class="n">fl</span><span class="p">)</span>
                        <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">fst</span> <span class="n">tr</span><span class="p">,</span> <span class="n">RawIfThen</span><span class="p">(</span><span class="n">fst</span> <span class="n">cond</span> <span class="o">+.</span> <span class="n">fst</span> <span class="n">tr</span><span class="p">,</span><span class="n">snd</span> <span class="n">cond</span><span class="p">,</span><span class="n">snd</span> <span class="n">tr</span><span class="p">)</span>
                    <span class="n">let</span> <span class="n">fl</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">cond</span><span class="p">,</span><span class="n">tr</span><span class="p">)</span> <span class="n">fl</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">cond</span> <span class="n">tr</span> <span class="n">fl</span> <span class="o">|&gt;</span> <span class="n">Some</span><span class="p">)</span> <span class="n">elifs</span> <span class="n">fl</span>
                    <span class="n">f</span> <span class="n">cond</span> <span class="n">tr</span> <span class="n">fl</span> <span class="o">|&gt;</span> <span class="n">snd</span><span class="p">))</span> <span class="n">d</span>
        
        <span class="n">let</span> <span class="n">case_match</span> <span class="o">=</span>
            <span class="n">let</span> <span class="n">clauses</span> <span class="n">d</span> <span class="o">=</span> 
                <span class="n">let</span> <span class="n">bar</span> <span class="o">=</span> <span class="n">bar</span> <span class="p">(</span><span class="n">col</span> <span class="n">d</span><span class="p">)</span>
                <span class="p">(</span><span class="n">optional</span> <span class="n">bar</span> <span class="o">&gt;&gt;.</span> <span class="n">sepBy1</span> <span class="p">(</span><span class="n">root_pattern_when</span> <span class="o">.&gt;&gt;.</span> <span class="p">(</span><span class="n">skip_op</span> <span class="s2">"=&gt;"</span> <span class="o">&gt;&gt;.</span> <span class="nb">next</span><span class="p">))</span> <span class="n">bar</span>
                <span class="o">&gt;&gt;=</span> <span class="n">fun</span> <span class="n">l</span> <span class="n">_</span> <span class="o">-&gt;</span>
                    <span class="k">match</span><span class="w"> </span><span class="n">l</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">collect</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="k">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">patterns_validate</span> <span class="p">[</span><span class="n">a</span><span class="p">])</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="p">[]</span> <span class="o">-&gt;</span> <span class="n">Ok</span> <span class="n">l</span>
                    <span class="o">|</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">e</span>
                    <span class="p">)</span> <span class="n">d</span>

            <span class="p">(</span><span class="n">rangeBlockParsing</span> <span class="p">(</span><span class="n">skip_keyword</span> <span class="n">SpecFunction</span> <span class="o">&gt;&gt;.</span> <span class="n">clauses</span><span class="p">)</span> <span class="o">|&gt;&gt;</span> <span class="n">RawFun</span><span class="p">)</span>
            <span class="o">&lt;|&gt;</span> <span class="p">(</span><span class="n">rangeBlockParsing</span> <span class="p">((</span><span class="n">skip_keyword</span> <span class="n">SpecMatch</span> <span class="o">&gt;&gt;.</span> <span class="nb">next</span> <span class="o">.&gt;&gt;</span> <span class="n">skip_keyword</span> <span class="n">SpecWith</span><span class="p">)</span> <span class="o">.&gt;&gt;.</span> <span class="n">clauses</span><span class="p">)</span> <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="p">(</span><span class="n">a</span><span class="p">,(</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">RawMatch</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">))</span>

        <span class="n">let</span> <span class="n">case_typecase</span> <span class="n">d</span> <span class="o">=</span>
            <span class="n">let</span> <span class="n">clauses</span> <span class="n">d</span> <span class="o">=</span> 
                <span class="n">let</span> <span class="n">bar</span> <span class="o">=</span> <span class="n">bar</span> <span class="p">(</span><span class="n">col</span> <span class="n">d</span><span class="p">)</span>
                <span class="n">let</span> <span class="n">typecase</span> <span class="o">=</span> <span class="n">root_type</span> <span class="p">{</span><span class="n">root_type_defaults</span> <span class="k">with</span> <span class="n">allow_typecase_metavars</span><span class="o">=</span><span class="n">true</span><span class="p">;</span> <span class="n">allow_wildcard</span><span class="o">=</span><span class="n">true</span><span class="p">}</span> <span class="o">&gt;&gt;=</span> <span class="n">typecase_validate</span>
                <span class="p">(</span><span class="n">optional</span> <span class="n">bar</span> <span class="o">&gt;&gt;.</span> <span class="n">sepBy1</span> <span class="p">(</span><span class="n">typecase</span> <span class="o">.&gt;&gt;.</span> <span class="p">(</span><span class="n">skip_op</span> <span class="s2">"=&gt;"</span> <span class="o">&gt;&gt;.</span> <span class="nb">next</span><span class="p">))</span> <span class="n">bar</span><span class="p">)</span> <span class="n">d</span>

            <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">is_top_down</span> <span class="n">then</span> <span class="n">Error</span> <span class="p">[]</span> <span class="k">else</span>
                <span class="p">(</span><span class="n">rangeBlockParsing</span> <span class="p">((</span><span class="n">skip_keyword</span> <span class="n">SpecTypecase</span> <span class="o">&gt;&gt;.</span> <span class="n">root_type</span> <span class="p">{</span><span class="n">root_type_defaults</span> <span class="k">with</span> <span class="n">allow_term</span><span class="o">=</span><span class="n">true</span><span class="p">}</span> <span class="o">.&gt;&gt;</span> <span class="n">skip_keyword</span> <span class="n">SpecWith</span><span class="p">)</span> <span class="o">.&gt;&gt;.</span> <span class="n">clauses</span><span class="p">)</span>
                <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">RawTypecase</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span> <span class="n">d</span>

        <span class="n">let</span> <span class="n">case_record</span> <span class="o">=</span>
            <span class="n">let</span> <span class="n">create</span> <span class="o">=</span> <span class="n">skip_op</span> <span class="s2">"="</span> <span class="o">&gt;&gt;.</span> <span class="nb">next</span>
            <span class="n">let</span> <span class="n">modify</span> <span class="o">=</span> <span class="n">skip_op</span> <span class="s2">"#="</span> <span class="o">&gt;&gt;.</span> <span class="nb">next</span>
            <span class="n">let</span> <span class="n">var</span> <span class="o">=</span> <span class="n">rangeBlockParsing</span> <span class="n">record_var</span>
            <span class="n">let</span> <span class="n">inject</span> <span class="o">=</span> <span class="n">skip_unary_op</span> <span class="s2">"$"</span> <span class="o">&gt;&gt;.</span> <span class="n">rangeBlockParsing</span> <span class="n">read_small_var</span>
            <span class="n">let</span> <span class="n">record_create_body</span> <span class="o">=</span>
                <span class="p">(</span><span class="n">var</span> <span class="o">.&gt;&gt;.</span> <span class="n">opt</span> <span class="n">create</span> <span class="o">|&gt;&gt;</span> <span class="n">function</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">Some</span> <span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawRecordWithSymbol</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawRecordWithSymbol</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">rawv</span> <span class="n">a</span><span class="p">))</span>
                <span class="o">&lt;|&gt;</span> <span class="p">(</span><span class="n">inject</span> <span class="o">.&gt;&gt;.</span> <span class="n">create</span> <span class="o">|&gt;&gt;</span> <span class="n">RawRecordWithInjectVar</span><span class="p">)</span>
            <span class="n">let</span> <span class="n">record_create</span> <span class="o">=</span> <span class="n">rangeBlockParsing</span> <span class="p">(</span><span class="n">curlies</span> <span class="p">(</span><span class="n">sepBy</span> <span class="n">record_create_body</span> <span class="p">(</span><span class="n">optional</span> <span class="p">(</span><span class="n">skip_op</span> <span class="s2">";"</span><span class="p">))))</span> <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">withs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">r</span><span class="p">,[],</span><span class="n">withs</span><span class="p">,[])</span>
            <span class="n">let</span> <span class="n">record_with_bodies</span> <span class="o">=</span>
                <span class="p">(</span><span class="n">var</span> <span class="o">&gt;&gt;=</span> <span class="n">fun</span> <span class="n">a</span> <span class="o">-&gt;</span>
                    <span class="p">((</span><span class="n">modify</span> <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">RawRecordWithSymbolModify</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span>
                    <span class="o">&lt;|&gt;</span> <span class="p">(</span><span class="n">opt</span> <span class="n">create</span> <span class="o">|&gt;&gt;</span> <span class="n">function</span> <span class="n">Some</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">RawRecordWithSymbol</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">RawRecordWithSymbol</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">rawv</span> <span class="n">a</span><span class="p">))))</span>
                <span class="o">&lt;|&gt;</span> <span class="p">(</span><span class="n">inject</span> <span class="o">&gt;&gt;=</span> <span class="n">fun</span> <span class="n">a</span> <span class="o">-&gt;</span>
                    <span class="p">((</span><span class="n">modify</span> <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">RawRecordWithInjectVarModify</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span>
                    <span class="o">&lt;|&gt;</span> <span class="p">(</span><span class="n">create</span> <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">RawRecordWithInjectVar</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))))</span>
            <span class="n">let</span> <span class="n">record_without_bodies</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span> <span class="o">|&gt;&gt;</span> <span class="n">RawRecordWithoutSymbol</span><span class="p">)</span> <span class="o">&lt;|&gt;</span> <span class="p">(</span><span class="n">inject</span> <span class="o">|&gt;&gt;</span> <span class="n">RawRecordWithoutInjectVar</span><span class="p">)</span>
            <span class="n">let</span> <span class="n">record_with</span> <span class="o">=</span>
                <span class="n">rangeBlockParsing</span>
                    <span class="p">(</span><span class="n">curlies</span>
                        <span class="p">(</span><span class="n">tuple4</span> <span class="n">read_small_var</span><span class="s1">'</span>
                            <span class="p">(</span><span class="n">many</span> <span class="p">((</span><span class="n">read_symbol</span> <span class="o">|&gt;&gt;</span> <span class="n">RawSymbol</span><span class="p">)</span> <span class="o">&lt;|&gt;</span> <span class="p">(</span><span class="n">skip_op</span> <span class="s2">"$"</span> <span class="o">&gt;&gt;.</span> <span class="n">read_small_var</span><span class="s1">' |&gt;&gt; rawv)))</span>
                            <span class="p">((</span><span class="n">skip_keyword</span> <span class="n">SpecWith</span> <span class="o">&gt;&gt;.</span> <span class="n">sepBy</span> <span class="n">record_with_bodies</span> <span class="p">(</span><span class="n">optional</span> <span class="p">(</span><span class="n">skip_op</span> <span class="s2">";"</span><span class="p">)))</span> <span class="o">&lt;|&gt;%</span> <span class="p">[])</span>
                            <span class="p">((</span><span class="n">skip_keyword</span> <span class="n">SpecWithout</span> <span class="o">&gt;&gt;.</span> <span class="n">many</span> <span class="n">record_without_bodies</span><span class="p">)</span> <span class="o">&lt;|&gt;%</span> <span class="p">[])))</span>
                <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">name</span><span class="p">,</span> <span class="n">acs</span><span class="p">,</span> <span class="n">withs</span><span class="p">,</span> <span class="n">withouts</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">rawv</span> <span class="n">name</span> <span class="p">::</span> <span class="n">acs</span><span class="p">,</span><span class="n">withs</span><span class="p">,</span><span class="n">withouts</span><span class="p">)</span>

            <span class="n">restore</span> <span class="mi">2</span> <span class="n">record_create</span> <span class="o">&lt;|&gt;</span> <span class="n">record_with</span>
            <span class="o">&gt;&gt;=</span> <span class="n">fun</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">withs</span><span class="p">,</span><span class="n">withouts</span> <span class="k">as</span> <span class="n">x</span><span class="p">)</span> <span class="n">_</span> <span class="o">-&gt;</span>
                <span class="p">[</span>
                <span class="n">withs</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">choose</span> <span class="p">(</span><span class="n">function</span> <span class="n">RawRecordWithSymbol</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">RawRecordWithSymbolModify</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Some</span> <span class="n">a</span> <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">duplicates</span> <span class="n">DuplicateTermRecordSymbol</span>
                <span class="n">withs</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">choose</span> <span class="p">(</span><span class="n">function</span> <span class="n">RawRecordWithInjectVar</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">RawRecordWithInjectVarModify</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Some</span> <span class="n">a</span> <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">duplicates</span> <span class="n">DuplicateTermRecordInjection</span>
                <span class="n">withouts</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">choose</span> <span class="p">(</span><span class="n">function</span> <span class="n">RawRecordWithoutSymbol</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Some</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">duplicates</span> <span class="n">DuplicateTermRecordSymbol</span>
                <span class="n">withouts</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">choose</span> <span class="p">(</span><span class="n">function</span> <span class="n">RawRecordWithoutInjectVar</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Some</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">duplicates</span> <span class="n">DuplicateTermRecordInjection</span>
                <span class="p">]</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">concat</span> <span class="o">|&gt;</span> <span class="n">function</span> <span class="p">[]</span> <span class="o">-&gt;</span> <span class="n">Ok</span><span class="p">(</span><span class="n">RawRecordWith</span> <span class="n">x</span><span class="p">)</span> <span class="o">|</span> <span class="n">er</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">er</span>

        <span class="n">let</span> <span class="n">case_join_point</span> <span class="o">=</span> <span class="n">skip_keyword</span> <span class="n">SpecJoin</span> <span class="o">&gt;&gt;.</span> <span class="nb">next</span> <span class="o">|&gt;&gt;</span> <span class="n">join_point</span> <span class="n">true</span> <span class="kc">None</span>
        <span class="n">let</span> <span class="n">case_join_point_backend</span> <span class="o">=</span> <span class="n">skip_keyword</span> <span class="n">SpecJoinBackend</span> <span class="o">&gt;&gt;.</span> <span class="p">(</span><span class="n">read_big_var_as_keyword</span> <span class="o">.&gt;&gt;.</span> <span class="nb">next</span><span class="p">)</span> <span class="o">|&gt;&gt;</span> <span class="n">join_point_backend</span>
        <span class="n">let</span> <span class="n">case_real</span> <span class="o">=</span> <span class="n">skip_keyword</span> <span class="n">SpecReal</span> <span class="o">&gt;&gt;.</span> <span class="p">(</span><span class="n">fun</span> <span class="n">d</span> <span class="o">-&gt;</span> <span class="nb">next</span> <span class="p">{</span><span class="n">d</span> <span class="k">with</span> <span class="n">is_top_down</span><span class="o">=</span><span class="n">false</span><span class="p">})</span> <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">RawReal</span><span class="p">(</span><span class="n">range_of_expr</span> <span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
        <span class="n">let</span> <span class="n">case_symbol</span> <span class="o">=</span> <span class="n">read_symbol</span> <span class="o">|&gt;&gt;</span> <span class="n">RawSymbol</span>
        <span class="n">let</span> <span class="n">case_list</span> <span class="o">=</span> <span class="n">rangeBlockParsing</span> <span class="p">(</span><span class="n">squares</span> <span class="n">sequence_body</span><span class="p">)</span> <span class="o">&gt;&gt;=</span> <span class="n">fun</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">l</span><span class="p">)</span> <span class="n">d</span> <span class="o">-&gt;</span> 
            <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">is_top_down</span> <span class="n">then</span>
                <span class="n">let</span> <span class="n">r</span> <span class="o">=</span> <span class="n">fst</span> <span class="n">r</span><span class="p">,</span> <span class="n">fst</span> <span class="n">r</span>
                <span class="n">List</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="n">a</span> <span class="n">b</span> <span class="o">-&gt;</span> 
                    <span class="n">RawApply</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">rawv</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">unintern</span> <span class="s2">"Cons"</span><span class="p">),</span><span class="n">RawPair</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span>
                    <span class="p">)</span> <span class="n">l</span> <span class="p">(</span><span class="n">rawv</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">unintern</span> <span class="s2">"Nil"</span><span class="p">))</span> <span class="o">|&gt;</span> <span class="n">Ok</span>
            <span class="k">else</span>
                <span class="n">Error</span> <span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">ListLiteralsNotAllowedInBottomUp</span><span class="p">]</span>

        <span class="n">let</span> <span class="n">case_string</span> <span class="o">=</span> <span class="n">read_string</span> <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawLit</span><span class="p">(</span><span class="n">a</span> <span class="o">+.</span> <span class="n">b</span><span class="p">,</span><span class="n">LitString</span> <span class="n">x</span><span class="p">)</span>

        <span class="n">let</span> <span class="n">case_macro</span> <span class="o">=</span>
            <span class="n">let</span> <span class="n">read_macro_expression</span> <span class="n">s</span> <span class="o">=</span> 
                <span class="p">(</span><span class="n">macro_expression</span> <span class="n">MTerm</span> <span class="p">(</span><span class="n">root_term</span> <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">RawMacroTerm</span><span class="p">(</span><span class="n">range_of_expr</span> <span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">))</span>
                <span class="o">&lt;|&gt;</span> <span class="n">macro_expression</span> <span class="n">MType</span> <span class="p">(</span><span class="n">root_type</span> <span class="n">root_type_defaults</span> <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">RawMacroType</span><span class="p">(</span><span class="n">range_of_texpr</span> <span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">))</span>
                <span class="o">&lt;|&gt;</span> <span class="n">macro_expression</span> <span class="n">MTypeLit</span> <span class="p">(</span><span class="n">root_type</span> <span class="n">root_type_defaults</span> <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">RawMacroTypeLit</span><span class="p">(</span><span class="n">range_of_texpr</span> <span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">)))</span> <span class="n">s</span>
            <span class="n">let</span> <span class="n">body</span> <span class="o">=</span> <span class="n">many</span> <span class="p">((</span><span class="n">read_text</span> <span class="n">true</span> <span class="o">|&gt;&gt;</span> <span class="n">RawMacroText</span><span class="p">)</span> <span class="o">&lt;|&gt;</span> <span class="n">read_macro_var</span> <span class="o">&lt;|&gt;</span> <span class="n">read_macro_expression</span><span class="p">)</span>
            <span class="n">pipe3</span> <span class="n">skip_macro_open</span> <span class="n">body</span> <span class="n">skip_macro_close</span> <span class="p">(</span><span class="n">fun</span> <span class="n">a</span> <span class="n">l</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">RawMacro</span><span class="p">(</span><span class="n">a</span> <span class="o">+.</span> <span class="n">b</span><span class="p">,</span> <span class="n">l</span><span class="p">))</span>

        <span class="n">let</span> <span class="p">(</span><span class="o">+</span><span class="p">)</span> <span class="o">=</span> <span class="n">alt</span> <span class="p">(</span><span class="n">indexBlockParsing</span> <span class="n">d</span><span class="p">)</span>

        <span class="p">(</span><span class="n">case_value</span> <span class="o">+</span> <span class="n">case_default_value</span> <span class="o">+</span> <span class="n">case_var</span> <span class="o">+</span> <span class="n">case_join_point</span> <span class="o">+</span> <span class="n">case_join_point_backend</span> <span class="o">+</span> <span class="n">case_real</span> <span class="o">+</span> <span class="n">case_symbol</span>
        <span class="o">+</span> <span class="n">case_typecase</span> <span class="o">+</span> <span class="n">case_match</span> <span class="o">+</span> <span class="n">case_typecase</span> <span class="o">+</span> <span class="n">case_rounds</span> <span class="o">+</span> <span class="n">case_list</span> <span class="o">+</span> <span class="n">case_record</span>
        <span class="o">+</span> <span class="n">case_if_then_else</span> <span class="o">+</span> <span class="n">case_fun</span> <span class="o">+</span> <span class="n">case_forall</span> <span class="o">+</span> <span class="n">case_string</span> <span class="o">+</span> <span class="n">case_macro</span> <span class="o">+</span> <span class="n">case_exists</span><span class="p">)</span> <span class="n">d</span>

    <span class="ow">and</span> <span class="n">application_tight</span> <span class="n">d</span> <span class="o">=</span>
        <span class="n">let</span> <span class="nb">next</span> <span class="o">=</span> <span class="n">expressions</span>
        <span class="n">pipe2</span> <span class="nb">next</span> <span class="p">(</span><span class="n">many</span> <span class="p">(</span><span class="n">expr_tight</span> <span class="nb">next</span><span class="p">))</span> <span class="p">(</span><span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">a</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">RawApply</span><span class="p">(</span><span class="n">range_of_expr</span> <span class="n">a</span> <span class="o">+.</span> <span class="n">range_of_expr</span> <span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)))</span> <span class="n">d</span>

    <span class="ow">and</span> <span class="n">sequence_body</span> <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">many</span> <span class="p">(</span><span class="n">indentBlockParsing</span> <span class="p">(</span><span class="n">col</span> <span class="n">d</span><span class="p">)</span> <span class="p">(</span><span class="o">=</span><span class="p">)</span> <span class="p">(</span><span class="n">sepBy1</span> <span class="n">operators</span> <span class="p">(</span><span class="n">skip_op</span> <span class="s2">";"</span><span class="p">)))</span> <span class="o">|&gt;&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">concat</span><span class="p">)</span> <span class="n">d</span>
    <span class="ow">and</span> <span class="n">unary_op</span> <span class="n">d</span> <span class="o">=</span>
        <span class="n">let</span> <span class="nb">next</span> <span class="o">=</span> <span class="n">application_tight</span>
        <span class="n">let</span> <span class="n">f</span> <span class="o">=</span> 
            <span class="n">read_unary_op</span><span class="s1">' &gt;&gt;= fun (o,a) d -&gt;</span>
                <span class="n">let</span> <span class="n">type_expr</span> <span class="n">d</span> <span class="o">=</span> 
                    <span class="n">choice</span> <span class="p">[</span><span class="o">|</span>
                        <span class="n">read_small_type_var</span><span class="s1">' |&gt;&gt; RawTVar</span>
                        <span class="n">read_value</span> <span class="o">|&gt;&gt;</span> <span class="n">RawTLit</span>
                        <span class="n">read_string</span> <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawTLit</span><span class="p">(</span><span class="n">a</span> <span class="o">+.</span> <span class="n">c</span><span class="p">,</span> <span class="n">LitString</span> <span class="n">b</span><span class="p">)</span>
                        <span class="n">rounds</span> <span class="p">(</span><span class="n">root_type</span> <span class="p">{</span><span class="n">root_type_defaults</span> <span class="k">with</span> <span class="n">allow_term</span><span class="o">=</span><span class="n">true</span><span class="p">})</span>
                        <span class="o">|</span><span class="p">]</span> <span class="n">d</span>
                <span class="n">let</span> <span class="n">term_expr</span> <span class="n">d</span> <span class="o">=</span>
                    <span class="n">choice</span> <span class="p">[</span><span class="o">|</span>
                        <span class="n">read_var</span><span class="s1">''</span> <span class="o">|&gt;&gt;</span> <span class="n">rawv</span>
                        <span class="n">read_value</span> <span class="o">|&gt;&gt;</span> <span class="n">RawLit</span>
                        <span class="n">read_default_value</span> <span class="n">RawDefaultLit</span> <span class="n">RawLit</span>
                        <span class="n">read_string</span> <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawLit</span><span class="p">(</span><span class="n">a</span> <span class="o">+.</span> <span class="n">c</span><span class="p">,</span> <span class="n">LitString</span> <span class="n">b</span><span class="p">)</span>
                        <span class="n">rounds</span> <span class="n">root_term</span>
                        <span class="o">|</span><span class="p">]</span> <span class="n">d</span>
                <span class="k">match</span> <span class="n">a</span> <span class="k">with</span>
                <span class="o">|</span> <span class="s2">";"</span> <span class="o">-&gt;</span> 
                    <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">is_top_down</span> <span class="n">then</span> <span class="p">(</span><span class="n">rangeBlockParsing</span> <span class="p">(</span><span class="n">squares</span> <span class="n">sequence_body</span><span class="p">)</span> <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawApply</span><span class="p">(</span><span class="n">o</span><span class="p">,</span><span class="n">RawV</span><span class="p">(</span><span class="n">o</span><span class="p">,</span><span class="n">unintern</span> <span class="s2">"array"</span><span class="p">,</span><span class="n">true</span><span class="p">),</span> <span class="n">RawArray</span><span class="p">(</span><span class="n">o</span><span class="p">,</span><span class="n">x</span><span class="p">)))</span> <span class="n">d</span>
                    <span class="k">else</span> <span class="n">Error</span> <span class="p">[</span><span class="n">o</span><span class="p">,</span> <span class="n">ArrayLiteralsNotAllowedInBottomUp</span><span class="p">]</span>
                <span class="o">|</span> <span class="s2">"!!!!"</span> <span class="o">-&gt;</span> 
                    <span class="p">(</span><span class="n">rangeBlockParsing</span> <span class="p">(</span><span class="n">read_big_var</span> <span class="o">.&gt;&gt;.</span> <span class="p">(</span><span class="n">rounds</span> <span class="p">(</span><span class="n">sepBy</span> <span class="p">(</span><span class="n">fun</span> <span class="n">d</span> <span class="o">-&gt;</span> <span class="n">unary_op</span> <span class="p">{</span><span class="n">d</span> <span class="k">with</span> <span class="n">is_top_down</span><span class="o">=</span><span class="n">false</span><span class="p">})</span> <span class="p">(</span><span class="n">skip_op</span> <span class="s2">","</span><span class="p">))))</span>
                    <span class="o">&gt;&gt;=</span> <span class="n">fun</span> <span class="p">(</span><span class="n">r</span><span class="p">,((</span><span class="n">ra</span><span class="p">,</span><span class="n">a</span><span class="p">),</span> <span class="n">b</span><span class="p">))</span> <span class="n">_</span> <span class="o">-&gt;</span>
                        <span class="k">match</span> <span class="n">string_to_op</span> <span class="n">a</span> <span class="k">with</span>
                        <span class="o">|</span> <span class="n">true</span><span class="p">,</span> <span class="n">op</span><span class="s1">' -&gt; Ok(RawOp(r,op'</span><span class="p">,</span><span class="n">b</span><span class="p">))</span>
                        <span class="o">|</span> <span class="n">false</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="p">[</span><span class="n">ra</span><span class="p">,</span><span class="n">InbuiltOpNotFound</span><span class="p">])</span> <span class="n">d</span>
                <span class="o">|</span> <span class="s2">"`"</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">is_top_down</span> <span class="n">then</span> <span class="n">Error</span> <span class="p">[]</span> <span class="k">else</span> <span class="p">(</span><span class="n">rangeBlockParsing</span> <span class="n">type_expr</span> <span class="o">|&gt;&gt;</span> <span class="n">RawType</span><span class="p">)</span> <span class="n">d</span>
                <span class="o">|</span> <span class="s2">"`@"</span> <span class="o">-&gt;</span> 
                    <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">is_top_down</span> <span class="n">then</span> <span class="n">Error</span> <span class="p">[]</span> <span class="k">else</span> 
                        <span class="p">(</span><span class="n">rangeBlockParsing</span> <span class="n">term_expr</span> <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> 
                            <span class="n">let</span> <span class="sa">r</span><span class="s1">' = o +. r </span>
                            <span class="n">RawType</span><span class="p">(</span><span class="sa">r</span><span class="s1">', RawTTerm(r'</span><span class="p">,</span><span class="n">RawOp</span><span class="p">(</span><span class="sa">r</span><span class="s1">',LitToTypeLit,[x])))</span>
                            <span class="p">)</span> <span class="n">d</span>
                <span class="o">|</span> <span class="s2">"``"</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">is_top_down</span> <span class="n">then</span> <span class="n">Error</span> <span class="p">[]</span> <span class="k">else</span> <span class="p">(</span><span class="n">rangeBlockParsing</span> <span class="n">type_expr</span> <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawOp</span><span class="p">(</span><span class="n">o</span> <span class="o">+.</span> <span class="n">r</span><span class="p">,</span><span class="n">TypeToVar</span><span class="p">,[</span><span class="n">RawType</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">)]))</span> <span class="n">d</span>
                <span class="o">|</span> <span class="s2">"`$"</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">read_var</span><span class="s1">''</span> <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawV</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">false</span><span class="p">))</span> <span class="n">d</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nb">next</span> <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">RawApply</span><span class="p">(</span><span class="n">o</span> <span class="o">+.</span> <span class="n">range_of_expr</span> <span class="n">b</span><span class="p">,</span><span class="n">rawv</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="s2">"~"</span> <span class="o">+</span> <span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">))</span> <span class="n">d</span>
        <span class="p">(</span><span class="n">f</span> <span class="o">&lt;|&gt;</span> <span class="nb">next</span><span class="p">)</span> <span class="n">d</span>

    <span class="ow">and</span> <span class="n">application</span> <span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="n">BlockParsingEnv</span><span class="p">)</span> <span class="o">=</span>
        <span class="n">let</span> <span class="nb">next</span> <span class="o">=</span> <span class="n">unary_op</span>
        <span class="n">pipe2</span> <span class="nb">next</span> <span class="p">(</span><span class="n">many</span> <span class="p">(</span><span class="n">indentBlockParsing</span> <span class="p">(</span><span class="n">col</span> <span class="n">d</span><span class="p">)</span> <span class="p">(</span><span class="o">&lt;</span><span class="p">)</span> <span class="nb">next</span><span class="p">))</span> <span class="p">(</span><span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">a</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">RawApply</span><span class="p">(</span><span class="n">range_of_expr</span> <span class="n">a</span> <span class="o">+.</span> <span class="n">range_of_expr</span> <span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)))</span> <span class="n">d</span>

    <span class="ow">and</span> <span class="n">operators</span> <span class="n">d</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">term</span> <span class="o">=</span> <span class="n">application</span>
        <span class="n">let</span> <span class="n">i</span> <span class="o">=</span> <span class="n">col</span> <span class="n">d</span>
        <span class="n">let</span> <span class="n">op</span> <span class="o">=</span> <span class="n">indentBlockParsing</span> <span class="n">i</span> <span class="p">(</span><span class="o">&lt;=</span><span class="p">)</span> <span class="n">op</span>

        <span class="o">///</span> <span class="n">Pratt</span> <span class="n">parser</span>
        <span class="n">let</span> <span class="n">rec</span> <span class="n">led</span> <span class="n">left</span> <span class="p">(</span><span class="n">prec</span><span class="p">,</span><span class="n">asoc</span><span class="p">,</span><span class="n">m</span><span class="p">)</span> <span class="n">d</span> <span class="o">=</span>
            <span class="k">match</span> <span class="n">asoc</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">Associativity</span><span class="o">.</span><span class="n">Right</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">tdop</span> <span class="p">(</span><span class="n">prec</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="n">right</span> <span class="o">-&gt;</span> <span class="n">m</span> <span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">))</span> <span class="n">d</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">tdop</span> <span class="n">prec</span> <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="n">right</span> <span class="o">-&gt;</span> <span class="n">m</span> <span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">))</span> <span class="n">d</span>

        <span class="ow">and</span> <span class="n">tdop</span> <span class="n">rbp</span> <span class="n">d</span> <span class="o">=</span>
            <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="n">left</span> <span class="n">d</span> <span class="o">=</span> 
                <span class="p">((</span><span class="n">op</span> <span class="o">&gt;&gt;=</span> <span class="n">fun</span> <span class="p">(</span><span class="n">prec</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span> <span class="k">as</span> <span class="n">v</span><span class="p">)</span> <span class="n">d</span> <span class="o">-&gt;</span>
                    <span class="k">if</span> <span class="n">rbp</span> <span class="o">&lt;</span> <span class="n">prec</span> <span class="n">then</span> <span class="p">(</span><span class="n">led</span> <span class="n">left</span> <span class="n">v</span> <span class="o">&gt;&gt;=</span> <span class="n">loop</span><span class="p">)</span> <span class="n">d</span>
                    <span class="k">else</span> <span class="n">skip</span><span class="s1">' d -1; Error []) &lt;|&gt;</span><span class="si">% le</span><span class="s1">ft) d</span>
            <span class="p">(</span><span class="n">term</span> <span class="o">&gt;&gt;=</span> <span class="n">loop</span><span class="p">)</span> <span class="n">d</span>

        <span class="n">pipe2</span> <span class="p">(</span><span class="n">tdop</span> <span class="n">System</span><span class="o">.</span><span class="n">Int32</span><span class="o">.</span><span class="n">MinValue</span><span class="p">)</span>
            <span class="p">(</span><span class="n">opt</span> <span class="p">(</span><span class="n">indentBlockParsing</span> <span class="n">i</span> <span class="p">(</span><span class="o">&lt;=</span><span class="p">)</span> <span class="p">(</span><span class="n">skip_op</span> <span class="s2">":"</span> <span class="o">&gt;&gt;.</span> <span class="n">root_type_annot</span><span class="p">)))</span>
            <span class="p">(</span><span class="n">fun</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">function</span> <span class="n">Some</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">RawAnnot</span><span class="p">(</span><span class="n">range_of_expr</span> <span class="n">a</span> <span class="o">+.</span> <span class="n">range_of_texpr</span> <span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="p">)</span>
            <span class="n">d</span>

    <span class="n">let</span> <span class="n">statements</span> <span class="n">d</span> <span class="o">=</span>
        <span class="n">let</span> <span class="nb">next</span> <span class="o">=</span> <span class="n">operators</span>
        <span class="n">let</span> <span class="n">inl_or_let</span> <span class="o">=</span>
            <span class="p">(</span><span class="n">inl_or_let</span> <span class="n">root_term</span> <span class="n">root_pattern_pair</span> <span class="n">root_type_annot</span> <span class="o">.&gt;&gt;.</span> <span class="n">many</span> <span class="p">(</span><span class="n">and_inl_or_let</span> <span class="n">root_term</span> <span class="n">root_pattern_pair</span> <span class="n">root_type_annot</span><span class="p">))</span>
            <span class="o">&gt;&gt;=</span> <span class="n">fun</span> <span class="n">x</span> <span class="n">_</span> <span class="o">-&gt;</span> 
                <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
                <span class="o">|</span> <span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">body</span><span class="p">),</span><span class="n">false</span><span class="p">),</span> <span class="p">[]</span> <span class="o">-&gt;</span> <span class="n">Ok</span><span class="p">(</span><span class="n">fun</span> <span class="n">on_succ</span> <span class="o">-&gt;</span> <span class="n">RawMatch</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">body</span><span class="p">,[</span><span class="n">name</span><span class="p">,</span><span class="n">on_succ</span><span class="p">]))</span>
                <span class="o">|</span> <span class="p">((</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">),</span><span class="n">false</span><span class="p">),</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">l</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">),</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">r</span><span class="p">,</span> <span class="n">UnexpectedAndInlRec</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">Error</span>
                <span class="o">|</span> <span class="n">x</span><span class="p">,</span> <span class="n">xs</span> <span class="o">-&gt;</span>
                    <span class="n">let</span> <span class="n">l</span> <span class="o">=</span> <span class="n">x</span> <span class="p">::</span> <span class="n">xs</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">function</span> 
                        <span class="o">|</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">PatVar</span><span class="p">(</span><span class="n">o</span><span class="p">,</span><span class="n">name</span><span class="p">),</span><span class="n">body</span><span class="p">),</span><span class="n">true</span> <span class="o">-&gt;</span> <span class="n">r</span><span class="p">,</span> <span class="p">((</span><span class="n">o</span><span class="p">,</span><span class="n">name</span><span class="p">),</span> <span class="n">body</span><span class="p">)</span>
                        <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: Recursive inl/let statements should always have PatVar for names and should always be recursive."</span>
                        <span class="p">)</span>
                    <span class="n">let</span> <span class="n">r</span> <span class="o">=</span> <span class="n">l</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="n">fst</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">reduce</span> <span class="p">(</span><span class="o">+.</span><span class="p">)</span>
                    <span class="n">l</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">snd</span> <span class="o">&gt;&gt;</span> <span class="n">fst</span><span class="p">)</span> 
                    <span class="o">|&gt;</span> <span class="n">duplicates</span> <span class="n">DuplicateRecFunctionName</span>
                    <span class="o">|&gt;</span> <span class="n">function</span> <span class="p">[]</span> <span class="o">-&gt;</span> <span class="n">Ok</span><span class="p">(</span><span class="n">fun</span> <span class="n">on_succ</span> <span class="o">-&gt;</span> <span class="n">RawRecBlock</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="n">snd</span> <span class="n">l</span><span class="p">,</span> <span class="n">on_succ</span><span class="p">))</span> <span class="o">|</span> <span class="n">er</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="n">er</span>
        <span class="n">let</span> <span class="n">module_open</span> <span class="o">=</span> <span class="n">module_openBlockParsing</span> <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">name</span><span class="p">,</span><span class="n">acs</span><span class="p">))</span> <span class="n">on_succ</span> <span class="o">-&gt;</span> <span class="n">RawOpen</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">acs</span><span class="p">,</span><span class="n">on_succ</span><span class="p">)</span>
        <span class="n">let</span> <span class="n">statement_parsers</span> <span class="n">d</span> <span class="o">=</span>
            <span class="n">let</span> <span class="p">(</span><span class="o">+</span><span class="p">)</span> <span class="o">=</span> <span class="n">alt</span> <span class="p">(</span><span class="n">indexBlockParsing</span> <span class="n">d</span><span class="p">)</span>
            <span class="p">(</span><span class="n">inl_or_let</span> <span class="o">+</span> <span class="n">module_open</span><span class="p">)</span> <span class="n">d</span>
        
        <span class="n">let</span> <span class="n">i</span> <span class="o">=</span> <span class="n">col</span> <span class="n">d</span>
        <span class="n">let</span> <span class="n">inline</span> <span class="n">if_</span> <span class="n">x</span> <span class="o">=</span> <span class="n">indentBlockParsing</span> <span class="n">i</span> <span class="n">x</span>
        <span class="n">let</span> <span class="n">stmts</span> <span class="o">=</span> 
            <span class="n">many1</span> <span class="p">(</span><span class="n">if_</span> <span class="p">(</span><span class="o">=</span><span class="p">)</span> <span class="p">(</span><span class="n">rangeBlockParsing</span> <span class="n">statement_parsers</span><span class="p">))</span> <span class="o">.&gt;&gt;.</span> <span class="n">opt</span> <span class="p">((</span><span class="n">if_</span> <span class="p">(</span><span class="o">&lt;=</span><span class="p">)</span> <span class="p">(</span><span class="n">skip_keyword</span> <span class="n">SpecIn</span><span class="p">)</span> <span class="o">&gt;&gt;.</span> <span class="n">root_term</span><span class="p">)</span> <span class="o">&lt;|&gt;</span> <span class="n">if_</span> <span class="p">(</span><span class="o">=</span><span class="p">)</span> <span class="nb">next</span><span class="p">)</span>
            <span class="o">&gt;&gt;=</span> <span class="n">fun</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">match</span> <span class="n">b</span> <span class="k">with</span> <span class="n">Some</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">Ok</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="p">[</span><span class="n">List</span><span class="o">.</span><span class="n">last</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">fst</span><span class="p">,</span> <span class="n">ExpectedExpression</span><span class="p">]</span>
        <span class="n">let</span> <span class="n">expr</span> <span class="o">=</span> <span class="n">if_</span> <span class="p">(</span><span class="o">=</span><span class="p">)</span> <span class="nb">next</span> <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="p">[],</span><span class="n">x</span>
        <span class="p">(</span><span class="n">many1</span> <span class="p">(</span><span class="n">stmts</span> <span class="o">&lt;|&gt;</span> <span class="n">expr</span><span class="p">)</span>
        <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> 
            <span class="n">List</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">stmts</span><span class="p">,</span><span class="n">expr</span><span class="p">)</span> <span class="n">s</span> <span class="o">-&gt;</span> 
                <span class="n">let</span> <span class="n">process_statements</span> <span class="n">s</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="n">b</span><span class="p">)</span> <span class="n">stmts</span> <span class="n">s</span>
                <span class="k">match</span> <span class="n">s</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">ValueNone</span> <span class="o">-&gt;</span> <span class="n">ValueSome</span> <span class="p">(</span><span class="n">process_statements</span> <span class="n">expr</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">ValueSome</span> <span class="n">expr</span><span class="s1">' -&gt; ValueSome (process_statements (RawSeq(range_of_expr expr +. range_of_expr expr'</span><span class="p">,</span><span class="n">expr</span><span class="p">,</span><span class="n">expr</span><span class="s1">')))</span>
                <span class="p">)</span> <span class="n">x</span> <span class="n">ValueNone</span> <span class="o">|&gt;</span> <span class="n">ValueOption</span><span class="o">.</span><span class="n">get</span>
            <span class="p">)</span> <span class="n">d</span>

    <span class="n">statements</span> <span class="n">d</span>

<span class="n">let</span> <span class="n">comments</span> <span class="p">(</span><span class="n">s</span> <span class="p">:</span> <span class="n">BlockParsingEnv</span><span class="p">)</span> <span class="o">=</span> 
    <span class="n">let</span> <span class="n">line_near_to</span> <span class="o">=</span> <span class="n">lineBlockParsing</span> <span class="n">s</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="n">line</span> <span class="n">d</span> <span class="o">=</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">line</span> <span class="n">then</span> 
            <span class="k">match</span> <span class="n">s</span><span class="o">.</span><span class="n">comments</span><span class="o">.</span><span class="p">[</span><span class="n">line</span><span class="p">]</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">Some</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">text</span><span class="p">)</span> <span class="o">-&gt;</span> 
                <span class="n">let</span> <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">TrimEnd</span><span class="p">()</span>
                <span class="n">loop</span> <span class="p">(</span><span class="n">line</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">((</span><span class="k">if</span> <span class="n">text</span> <span class="o">=</span> <span class="s2">""</span> <span class="n">then</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> <span class="k">else</span> <span class="n">text</span> <span class="o">+</span> <span class="s2">" "</span><span class="p">)</span> <span class="p">::</span> <span class="n">d</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">d</span>
        <span class="k">else</span> <span class="n">d</span>
    <span class="n">loop</span> <span class="p">(</span><span class="n">line_near_to</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">[]</span>
    <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">""</span>
    <span class="o">|&gt;</span> <span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Ok</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">TrimEnd</span><span class="p">())</span>

<span class="nb">type</span> <span class="n">Comments</span> <span class="o">=</span> <span class="n">string</span>

<span class="nb">type</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ReferenceEquality</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">TopStatement</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">TopAnd</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">TopStatement</span>
    <span class="o">|</span> <span class="n">TopInl</span> <span class="n">of</span> <span class="n">Comments</span> <span class="o">*</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="p">(</span><span class="n">VSCRange</span> <span class="o">*</span> <span class="n">VarString</span><span class="p">)</span> <span class="o">*</span> <span class="n">RawExpr</span> <span class="o">*</span> <span class="n">is_top_down</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="o">|</span> <span class="n">TopRecInl</span> <span class="n">of</span> <span class="n">Comments</span> <span class="o">*</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="p">(</span><span class="n">VSCRange</span> <span class="o">*</span> <span class="n">VarString</span><span class="p">)</span> <span class="o">*</span> <span class="n">RawExpr</span> <span class="o">*</span> <span class="n">is_top_down</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="o">|</span> <span class="n">TopNominal</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="p">(</span><span class="n">VSCRange</span> <span class="o">*</span> <span class="n">VarString</span><span class="p">)</span> <span class="o">*</span> <span class="n">HoVar</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">RawTExpr</span>
    <span class="o">|</span> <span class="n">TopNominalRec</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="p">(</span><span class="n">VSCRange</span> <span class="o">*</span> <span class="n">VarString</span><span class="p">)</span> <span class="o">*</span> <span class="n">HoVar</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">RawTExpr</span>
    <span class="o">|</span> <span class="n">TopType</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="p">(</span><span class="n">VSCRange</span> <span class="o">*</span> <span class="n">VarString</span><span class="p">)</span> <span class="o">*</span> <span class="n">HoVar</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">RawTExpr</span>
    <span class="o">|</span> <span class="n">TopPrototype</span> <span class="n">of</span> <span class="n">Comments</span> <span class="o">*</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="p">(</span><span class="n">VSCRange</span> <span class="o">*</span> <span class="n">VarString</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">VSCRange</span> <span class="o">*</span> <span class="n">VarString</span><span class="p">)</span> <span class="o">*</span> <span class="n">TypeVar</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">RawTExpr</span>
    <span class="o">|</span> <span class="n">TopInstance</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="p">(</span><span class="n">VSCRange</span> <span class="o">*</span> <span class="n">VarString</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">VSCRange</span> <span class="o">*</span> <span class="n">VarString</span><span class="p">)</span> <span class="o">*</span> <span class="n">TypeVar</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">RawExpr</span>
    <span class="o">|</span> <span class="n">TopOpen</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="p">(</span><span class="n">VSCRange</span> <span class="o">*</span> <span class="n">VarString</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">VSCRange</span> <span class="o">*</span> <span class="n">SymbolString</span><span class="p">)</span> <span class="nb">list</span>

<span class="n">let</span> <span class="n">top_inl_or_let_process</span> <span class="n">comments</span> <span class="n">is_top_down</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">PatVar</span><span class="p">(</span><span class="sa">r</span><span class="s1">',name),body),is_rec -&gt; </span>
        <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="o">=</span> <span class="n">function</span>
            <span class="o">|</span> <span class="n">RawAnnot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">body</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="n">body</span>
            <span class="o">|</span> <span class="n">RawForall</span> <span class="n">_</span> <span class="o">|</span> <span class="n">RawFun</span> <span class="n">_</span> <span class="o">-&gt;</span>
                <span class="k">if</span> <span class="n">is_rec</span> <span class="n">then</span> <span class="n">Ok</span><span class="p">(</span><span class="n">TopRecInl</span><span class="p">(</span><span class="n">comments</span><span class="p">,</span><span class="n">r</span><span class="p">,(</span><span class="sa">r</span><span class="s1">',name),body,is_top_down))</span>
                <span class="k">else</span> <span class="n">Ok</span><span class="p">(</span><span class="n">TopInl</span><span class="p">(</span><span class="n">comments</span><span class="p">,</span><span class="n">r</span><span class="p">,(</span><span class="sa">r</span><span class="s1">',name),body,is_top_down))</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">ExpectedGlobalFunction</span><span class="p">]</span>
        <span class="n">loop</span> <span class="n">body</span>
    <span class="o">|</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">_</span><span class="p">),</span><span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="p">[</span><span class="n">range_of_pattern</span> <span class="n">x</span><span class="p">,</span> <span class="n">ExpectedVarOrOpAsNameOfGlobalStatement</span><span class="p">]</span>
<span class="n">let</span> <span class="n">top_inl_or_let</span> <span class="n">d</span> <span class="o">=</span> <span class="p">((</span><span class="n">comments</span> <span class="o">.&gt;&gt;.</span> <span class="n">inl_or_let</span> <span class="n">root_term</span> <span class="n">root_pattern_pair</span> <span class="n">root_type_annot</span><span class="p">)</span> <span class="o">&gt;&gt;=</span> <span class="n">fun</span> <span class="p">(</span><span class="n">comments</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="n">d</span> <span class="o">-&gt;</span> <span class="n">top_inl_or_let_process</span> <span class="n">comments</span> <span class="n">d</span><span class="o">.</span><span class="n">is_top_down</span> <span class="n">x</span><span class="p">)</span> <span class="n">d</span>

<span class="n">let</span> <span class="n">process_union</span> <span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">layout</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">a</span><span class="p">,(</span><span class="sa">r</span><span class="s1">',b))) _ =</span>
    <span class="n">let</span> <span class="n">this</span> <span class="o">=</span> <span class="p">(</span><span class="n">RawTVar</span> <span class="n">n</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">||&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">RawTApply</span><span class="p">(</span><span class="sa">r</span><span class="s1">',s,RawTVar(r'</span><span class="p">,</span><span class="n">hovar_name</span> <span class="n">x</span><span class="p">)))</span>
    <span class="k">match</span> <span class="n">layout</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">UHeap</span> <span class="o">-&gt;</span> <span class="n">Ok</span><span class="p">(</span><span class="n">TopNominalRec</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">RawTUnion</span><span class="p">(</span><span class="sa">r</span><span class="s1">',b,layout,this)))</span>
    <span class="o">|</span> <span class="n">UStack</span> <span class="o">-&gt;</span> <span class="n">Ok</span><span class="p">(</span><span class="n">TopNominal</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">RawTUnion</span><span class="p">(</span><span class="sa">r</span><span class="s1">',b,layout,this)))</span>

<span class="n">let</span> <span class="n">union_clauses</span> <span class="n">d</span> <span class="o">=</span> <span class="n">root_type_union</span> <span class="n">root_type_defaults</span> <span class="n">d</span>
<span class="n">let</span> <span class="n">top_union</span> <span class="n">d</span> <span class="o">=</span> <span class="p">((</span><span class="n">rangeBlockParsing</span> <span class="p">(</span><span class="n">tuple4</span> <span class="p">(</span><span class="n">skip_keyword</span> <span class="n">SpecUnion</span> <span class="o">&gt;&gt;.</span> <span class="p">((</span><span class="n">skip_keyword</span> <span class="n">SpecRec</span> <span class="o">&gt;&gt;%</span> <span class="n">UHeap</span><span class="p">)</span> <span class="o">&lt;|&gt;%</span> <span class="n">UStack</span><span class="p">))</span> <span class="n">read_small_type_var</span><span class="s1">' (many ho_var .&gt;&gt; skip_op "=") union_clauses)) &gt;&gt;= process_union) d</span>
<span class="n">let</span> <span class="n">top_nominal</span> <span class="n">d</span> <span class="o">=</span> 
    <span class="p">(</span><span class="n">rangeBlockParsing</span> <span class="p">(</span><span class="n">tuple3</span> <span class="p">(</span><span class="n">skip_keyword</span> <span class="n">SpecNominal</span> <span class="o">&gt;&gt;.</span> <span class="n">read_small_type_var</span><span class="s1">') (many ho_var .&gt;&gt; skip_op "=") (root_type {root_type_defaults with allow_term=true}))</span>
    <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">n</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">TopNominal</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span> <span class="n">d</span>

<span class="n">let</span> <span class="n">inline</span> <span class="n">type_forall</span> <span class="nb">next</span> <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">pipe2</span> <span class="p">(</span><span class="n">forall</span> <span class="o">&lt;|&gt;%</span> <span class="p">[])</span> <span class="nb">next</span> <span class="p">(</span><span class="n">List</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">RawTForall</span><span class="p">(</span><span class="n">range_of_typevar</span> <span class="n">x</span> <span class="o">+.</span> <span class="n">range_of_texpr</span> <span class="n">s</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">s</span><span class="p">))))</span> <span class="n">d</span> 
<span class="n">let</span> <span class="n">top_prototype</span> <span class="n">d</span> <span class="o">=</span> 
    <span class="p">(</span><span class="n">rangeBlockParsing</span> 
        <span class="p">(</span><span class="n">tuple5</span> <span class="n">comments</span>
            <span class="p">(</span><span class="n">skip_keyword</span> <span class="n">SpecPrototype</span> <span class="o">&gt;&gt;.</span> <span class="p">(</span><span class="n">read_small_var</span><span class="s1">' &lt;|&gt; rounds read_op'</span><span class="p">))</span> <span class="n">read_small_type_var</span><span class="s1">' (many forall_var) </span>
            <span class="p">(</span><span class="n">skip_op</span> <span class="s2">":"</span> <span class="o">&gt;&gt;.</span> <span class="n">type_forall</span> <span class="p">(</span><span class="n">root_type</span> <span class="n">root_type_defaults</span><span class="p">)))</span>
    <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">com</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">TopPrototype</span><span class="p">(</span><span class="n">com</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">))</span> <span class="n">d</span>
<span class="n">let</span> <span class="n">top_instance</span> <span class="n">d</span> <span class="o">=</span>
    <span class="p">(</span><span class="n">rangeBlockParsing</span>
        <span class="p">(</span><span class="n">tuple4</span> <span class="p">(</span><span class="n">skip_keyword</span> <span class="n">SpecInstance</span> <span class="o">&gt;&gt;.</span> <span class="p">(</span><span class="n">read_small_var</span><span class="s1">' &lt;|&gt; rounds read_op'</span><span class="p">))</span> <span class="n">read_small_type_var</span><span class="s1">' (many forall_var) (skip_op "=" &gt;&gt;. root_term))</span>
    <span class="o">&gt;&gt;=</span> <span class="n">fun</span> <span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">prototype_name</span><span class="p">,</span> <span class="n">nominal_name</span><span class="p">,</span> <span class="n">nominal_foralls</span><span class="p">,</span> <span class="n">body</span><span class="p">))</span> <span class="n">_</span> <span class="o">-&gt;</span>
            <span class="n">Ok</span><span class="p">(</span><span class="n">TopInstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">prototype_name</span><span class="p">,</span><span class="n">nominal_name</span><span class="p">,</span><span class="n">nominal_foralls</span><span class="p">,</span><span class="n">body</span><span class="p">))</span>
            <span class="p">)</span> <span class="n">d</span>
<span class="n">let</span> <span class="n">top_type</span> <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">rangeBlockParsing</span> <span class="p">(</span><span class="n">tuple3</span> <span class="p">(</span><span class="n">skip_keyword</span> <span class="n">SpecType</span> <span class="o">&gt;&gt;.</span> <span class="n">read_small_type_var</span><span class="s1">') (many ho_var) (skip_op "=" &gt;&gt;. root_type root_type_defaults)) |&gt;&gt; fun (r,(a,b,c)) -&gt; TopType(r,a,b,c)) d</span>

<span class="n">let</span> <span class="n">top_and_inl_or_let</span> <span class="n">d</span> <span class="o">=</span> 
    <span class="p">(</span><span class="n">comments</span> <span class="o">.&gt;&gt;.</span> <span class="n">restore</span> <span class="mi">1</span> <span class="p">(</span><span class="n">rangeBlockParsing</span> <span class="p">(</span><span class="n">and_inl_or_let</span> <span class="n">root_term</span> <span class="n">root_pattern_pair</span> <span class="n">root_type_annot</span><span class="p">))</span> 
    <span class="o">&gt;&gt;=</span> <span class="n">fun</span> <span class="p">(</span><span class="n">comments</span><span class="p">,(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">))</span> <span class="n">d</span> <span class="o">-&gt;</span> <span class="n">top_inl_or_let_process</span> <span class="n">comments</span> <span class="n">d</span><span class="o">.</span><span class="n">is_top_down</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">Result</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">TopAnd</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">)))</span> <span class="n">d</span>

<span class="n">let</span> <span class="n">inline</span> <span class="n">top_and</span> <span class="n">f</span> <span class="o">=</span> <span class="n">restore</span> <span class="mi">1</span> <span class="p">(</span><span class="n">rangeBlockParsing</span> <span class="p">(</span><span class="n">skip_keyword</span> <span class="n">SpecAnd</span> <span class="o">&gt;&gt;.</span> <span class="n">f</span><span class="p">))</span> <span class="o">|&gt;&gt;</span> <span class="n">TopAnd</span>
<span class="n">let</span> <span class="n">top_and_union</span> <span class="n">d</span> <span class="o">=</span> <span class="n">top_and</span> <span class="p">((</span><span class="n">rangeBlockParsing</span> <span class="p">(</span><span class="n">tuple4</span> <span class="p">(</span><span class="n">skip_keyword</span> <span class="n">SpecUnion</span> <span class="o">&gt;&gt;%</span> <span class="n">UHeap</span><span class="p">)</span> <span class="n">read_small_type_var</span><span class="s1">' (many ho_var .&gt;&gt; skip_op "=") union_clauses)) &gt;&gt;= process_union) d</span>
<span class="n">let</span> <span class="n">top_open</span> <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">module_openBlockParsing</span> <span class="o">|&gt;&gt;</span> <span class="n">fun</span> <span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">name</span><span class="p">,</span><span class="n">acs</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">TopOpen</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">acs</span><span class="p">))</span> <span class="n">d</span>

<span class="n">let</span> <span class="n">top_statement</span> <span class="n">s</span> <span class="o">=</span>
    <span class="n">let</span> <span class="p">(</span><span class="o">+</span><span class="p">)</span> <span class="o">=</span> <span class="n">alt</span> <span class="p">(</span><span class="n">indexBlockParsing</span> <span class="n">s</span><span class="p">)</span>
    <span class="p">(</span><span class="n">top_inl_or_let</span> <span class="o">+</span> <span class="n">top_union</span> <span class="o">+</span> <span class="n">top_nominal</span> <span class="o">+</span> <span class="n">top_prototype</span> <span class="o">+</span> <span class="n">top_type</span> <span class="o">+</span> <span class="n">top_instance</span> <span class="o">+</span> <span class="n">top_and_inl_or_let</span> <span class="o">+</span> <span class="n">top_and_union</span> <span class="o">+</span> <span class="n">top_open</span><span class="p">)</span> <span class="n">s</span>

<span class="nb">type</span> <span class="n">ParserErrorsList</span> <span class="o">=</span> <span class="p">(</span><span class="n">VSCRange</span> <span class="o">*</span> <span class="n">ParserErrors</span><span class="p">)</span> <span class="nb">list</span>
<span class="nb">type</span> <span class="n">ParseResult</span> <span class="o">=</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">TopStatement</span><span class="p">,</span><span class="n">ParserErrorsList</span><span class="o">&gt;</span>
<span class="n">let</span> <span class="n">parseBlockParsing</span> <span class="p">(</span><span class="n">s</span> <span class="p">:</span> <span class="n">BlockParsingEnv</span><span class="p">)</span> <span class="p">:</span> <span class="n">ParseResult</span> <span class="o">=</span>
    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">.</span><span class="n">tokens</span><span class="o">.</span><span class="n">Length</span> <span class="n">then</span>
        <span class="k">match</span> <span class="n">top_statement</span> <span class="n">s</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">Ok</span> <span class="n">_</span> <span class="k">as</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">Index</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">tokens</span><span class="o">.</span><span class="n">Length</span> <span class="n">then</span> <span class="n">x</span> <span class="k">else</span> <span class="n">Error</span> <span class="p">[</span><span class="n">fst</span> <span class="n">s</span><span class="o">.</span><span class="n">tokens</span><span class="o">.</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">Index</span><span class="p">],</span> <span class="n">ExpectedEob</span><span class="p">]</span>
        <span class="o">|</span> <span class="n">Error</span> <span class="p">[]</span> <span class="o">-&gt;</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">Index</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">tokens</span><span class="o">.</span><span class="n">Length</span> <span class="n">then</span> <span class="n">Error</span> <span class="p">[</span><span class="n">fst</span> <span class="p">(</span><span class="n">Array</span><span class="o">.</span><span class="n">last</span> <span class="n">s</span><span class="o">.</span><span class="n">tokens</span><span class="p">),</span> <span class="n">UnexpectedEob</span><span class="p">]</span>
            <span class="k">else</span> <span class="n">Error</span> <span class="p">[</span><span class="n">fst</span> <span class="n">s</span><span class="o">.</span><span class="n">tokens</span><span class="o">.</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">Index</span><span class="p">],</span> <span class="n">ExpectedEob</span><span class="p">]</span>
        <span class="o">|</span> <span class="n">Error</span> <span class="n">_</span> <span class="k">as</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">l</span>
    <span class="k">else</span>
        <span class="n">Error</span> <span class="p">[]</span>

<span class="n">let</span> <span class="n">show_parser_error</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">TypeVarsNeedToBeExplicitForExists</span> <span class="o">-&gt;</span> <span class="s2">"The type vars for the exists body have to be specified up front in the bottom-up segment."</span>
    <span class="o">|</span> <span class="n">DuplicateExistsVar</span> <span class="o">-&gt;</span> <span class="s2">"Duplicate variable in the exists type."</span>
    <span class="o">|</span> <span class="n">ExistsNotAllowedInTypecase</span> <span class="o">-&gt;</span> <span class="s2">"The existential type is not allowed in typecase."</span>
    <span class="o">|</span> <span class="n">ForallNotAllowedInTypecase</span> <span class="o">-&gt;</span> <span class="s2">"The type lambda is not allowed in typecase."</span>
    <span class="o">|</span> <span class="n">MetavarShadowedByVar</span> <span class="o">-&gt;</span> <span class="s2">"The metavariable is shadowed by a variable."</span>
    <span class="o">|</span> <span class="n">VarShadowedByMetavar</span> <span class="o">-&gt;</span> <span class="s2">"The variable is shadowed by a metavariable."</span>
    <span class="o">|</span> <span class="n">ExpectedPairedSymbolInUnion</span> <span class="o">-&gt;</span> <span class="s2">"The union clause should be pair whose left side is a symbol."</span>
    <span class="o">|</span> <span class="n">ExpectedEscapedChar</span> <span class="n">false</span> <span class="o">-&gt;</span> <span class="s2">"escaped character"</span>
    <span class="o">|</span> <span class="n">ExpectedEscapedChar</span> <span class="n">true</span> <span class="o">-&gt;</span> <span class="s2">"escaped character or the escaped variable (</span><span class="se">\\</span><span class="s2">v)"</span>
    <span class="o">|</span> <span class="n">ExpectedUnescapedChar</span> <span class="o">-&gt;</span> <span class="s2">"unescaped character"</span>
    <span class="o">|</span> <span class="n">ExpectedMacroVar</span> <span class="o">-&gt;</span> <span class="s2">"variable"</span>
    <span class="o">|</span> <span class="n">ExpectedMacroTypeVar</span> <span class="o">-&gt;</span> <span class="s2">"type variable"</span>
    <span class="o">|</span> <span class="n">ExpectedMacroTypeLitVar</span> <span class="o">-&gt;</span> <span class="s2">"type literal variable"</span>
    <span class="o">|</span> <span class="n">ExpectedText</span> <span class="o">-&gt;</span> <span class="s2">"text"</span>
    <span class="o">|</span> <span class="n">ExpectedMacroOpen</span> <span class="o">-&gt;</span> <span class="s2">"$</span><span class="se">\"</span><span class="s2">"</span>
    <span class="o">|</span> <span class="n">ExpectedStringOpen</span> <span class="o">-&gt;</span> <span class="s2">"</span><span class="se">\"</span><span class="s2">"</span>
    <span class="o">|</span> <span class="n">ExpectedMacroClose</span> <span class="o">|</span> <span class="n">ExpectedStringClose</span> <span class="o">-&gt;</span> <span class="s2">"</span><span class="se">\"</span><span class="s2">"</span>
    <span class="o">|</span> <span class="n">ExpectedKeyword</span> <span class="n">x</span> <span class="o">-&gt;</span>
        <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">SpecExists</span> <span class="o">-&gt;</span> <span class="s2">"exists"</span>
        <span class="o">|</span> <span class="n">SpecIn</span> <span class="o">-&gt;</span> <span class="s2">"in"</span>
        <span class="o">|</span> <span class="n">SpecAnd</span> <span class="o">-&gt;</span> <span class="s2">"and"</span>
        <span class="o">|</span> <span class="n">SpecFun</span> <span class="o">-&gt;</span> <span class="s2">"fun"</span>
        <span class="o">|</span> <span class="n">SpecMatch</span> <span class="o">-&gt;</span> <span class="s2">"match"</span>
        <span class="o">|</span> <span class="n">SpecTypecase</span> <span class="o">-&gt;</span> <span class="s2">"typecase"</span>
        <span class="o">|</span> <span class="n">SpecFunction</span> <span class="o">-&gt;</span> <span class="s2">"function"</span>
        <span class="o">|</span> <span class="n">SpecWith</span> <span class="o">-&gt;</span> <span class="s2">"with"</span>
        <span class="o">|</span> <span class="n">SpecWithout</span> <span class="o">-&gt;</span> <span class="s2">"without"</span>
        <span class="o">|</span> <span class="n">SpecAs</span> <span class="o">-&gt;</span> <span class="s2">"as"</span>
        <span class="o">|</span> <span class="n">SpecWhen</span> <span class="o">-&gt;</span> <span class="s2">"when"</span>
        <span class="o">|</span> <span class="n">SpecInl</span> <span class="o">-&gt;</span> <span class="s2">"inl"</span>
        <span class="o">|</span> <span class="n">SpecLet</span> <span class="o">-&gt;</span> <span class="s2">"let"</span>
        <span class="o">|</span> <span class="n">SpecForall</span> <span class="o">-&gt;</span> <span class="s2">"forall"</span>
        <span class="o">|</span> <span class="n">SpecInm</span> <span class="o">-&gt;</span> <span class="s2">"inm"</span>
        <span class="o">|</span> <span class="n">SpecInb</span> <span class="o">-&gt;</span> <span class="s2">"inb"</span>
        <span class="o">|</span> <span class="n">SpecRec</span> <span class="o">-&gt;</span> <span class="s2">"rec"</span>
        <span class="o">|</span> <span class="n">SpecIf</span> <span class="o">-&gt;</span> <span class="s2">"if"</span>
        <span class="o">|</span> <span class="n">SpecThen</span> <span class="o">-&gt;</span> <span class="s2">"then"</span>
        <span class="o">|</span> <span class="n">SpecElif</span> <span class="o">-&gt;</span> <span class="s2">"elif"</span>
        <span class="o">|</span> <span class="n">SpecElse</span> <span class="o">-&gt;</span> <span class="s2">"else"</span>
        <span class="o">|</span> <span class="n">SpecJoin</span> <span class="o">-&gt;</span> <span class="s2">"join"</span>
        <span class="o">|</span> <span class="n">SpecJoinBackend</span> <span class="o">-&gt;</span> <span class="s2">"join_backend"</span>
        <span class="o">|</span> <span class="n">SpecType</span> <span class="o">-&gt;</span> <span class="s2">"type"</span>
        <span class="o">|</span> <span class="n">SpecNominal</span> <span class="o">-&gt;</span> <span class="s2">"nominal"</span>
        <span class="o">|</span> <span class="n">SpecReal</span> <span class="o">-&gt;</span> <span class="s2">"real"</span>
        <span class="o">|</span> <span class="n">SpecUnion</span> <span class="o">-&gt;</span> <span class="s2">"union"</span>
        <span class="o">|</span> <span class="n">SpecOpen</span> <span class="o">-&gt;</span> <span class="s2">"open"</span>
        <span class="o">|</span> <span class="n">SpecWildcard</span> <span class="o">-&gt;</span> <span class="s2">"_"</span>
        <span class="o">|</span> <span class="n">SpecInstance</span> <span class="o">-&gt;</span> <span class="s2">"instance"</span>
        <span class="o">|</span> <span class="n">SpecPrototype</span> <span class="o">-&gt;</span> <span class="s2">"prototype"</span>
    <span class="o">|</span> <span class="n">ExpectedParenthesis</span><span class="p">(</span><span class="n">Round</span><span class="p">,</span><span class="n">Open</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"("</span>
    <span class="o">|</span> <span class="n">ExpectedParenthesis</span><span class="p">(</span><span class="n">Curly</span><span class="p">,</span><span class="n">Open</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"{"</span>
    <span class="o">|</span> <span class="n">ExpectedParenthesis</span><span class="p">(</span><span class="n">Square</span><span class="p">,</span><span class="n">Open</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"["</span>
    <span class="o">|</span> <span class="n">ExpectedParenthesis</span><span class="p">(</span><span class="n">Round</span><span class="p">,</span><span class="n">Close</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">")"</span>
    <span class="o">|</span> <span class="n">ExpectedParenthesis</span><span class="p">(</span><span class="n">Curly</span><span class="p">,</span><span class="n">Close</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"}"</span>
    <span class="o">|</span> <span class="n">ExpectedParenthesis</span><span class="p">(</span><span class="n">Square</span><span class="p">,</span><span class="n">Close</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"]"</span>
    <span class="o">|</span> <span class="n">ExpectedMacroExpression</span><span class="p">(</span><span class="n">MTerm</span><span class="p">,</span><span class="n">Open</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"`("</span>
    <span class="o">|</span> <span class="n">ExpectedMacroExpression</span><span class="p">(</span><span class="n">MType</span><span class="p">,</span><span class="n">Open</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"!("</span>
    <span class="o">|</span> <span class="n">ExpectedMacroExpression</span><span class="p">(</span><span class="n">MTypeLit</span><span class="p">,</span><span class="n">Open</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"@("</span>
    <span class="o">|</span> <span class="n">ExpectedMacroExpression</span><span class="p">(</span><span class="n">MTerm</span><span class="p">,</span><span class="n">Close</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">")"</span>
    <span class="o">|</span> <span class="n">ExpectedMacroExpression</span><span class="p">(</span><span class="n">MType</span><span class="p">,</span><span class="n">Close</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">")"</span>
    <span class="o">|</span> <span class="n">ExpectedMacroExpression</span><span class="p">(</span><span class="n">MTypeLit</span><span class="p">,</span><span class="n">Close</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">")"</span>
    <span class="o">|</span> <span class="n">ExpectedOpenParenthesis</span> <span class="o">-&gt;</span> <span class="s2">"(, { or ["</span>
    <span class="o">|</span> <span class="n">ExpectedOperator</span><span class="s1">' -&gt; "operator"</span>
    <span class="o">|</span> <span class="n">ExpectedOperator</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">ExpectedUnaryOperator</span><span class="s1">' -&gt; "unary operator"</span>
    <span class="o">|</span> <span class="n">ExpectedUnaryOperator</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">ExpectedUnit</span> <span class="o">-&gt;</span> <span class="s2">"()"</span>
    <span class="o">|</span> <span class="n">ExpectedSmallVar</span> <span class="o">-&gt;</span> <span class="s2">"lowercase variable"</span>
    <span class="o">|</span> <span class="n">ExpectedBigVar</span> <span class="o">-&gt;</span> <span class="s2">"uppercase variable"</span>
    <span class="o">|</span> <span class="n">ExpectedVar</span> <span class="o">-&gt;</span> <span class="s2">"variable"</span>
    <span class="o">|</span> <span class="n">ExpectedLit</span> <span class="o">-&gt;</span> <span class="s2">"literal"</span>
    <span class="o">|</span> <span class="n">ExpectedSymbol</span> <span class="o">-&gt;</span> <span class="s2">"symbol"</span>
    <span class="o">|</span> <span class="n">ExpectedSymbolPaired</span> <span class="o">-&gt;</span> <span class="s2">"paired symbol"</span>
    <span class="o">|</span> <span class="n">ExpectedStatement</span> <span class="o">-&gt;</span> <span class="s2">"statement"</span>
    <span class="o">|</span> <span class="n">ExpectedFunctionAsBodyOfRecStatement</span> <span class="o">-&gt;</span> <span class="s2">"Rec statements should all return functions known at parse time."</span>
    <span class="o">|</span> <span class="n">ExpectedGlobalFunction</span> <span class="o">-&gt;</span> <span class="s2">"Global inl/let statements should all return functions known at parse time."</span>
    <span class="o">|</span> <span class="n">ExpectedSinglePatternWhenStatementNameIsNorVarOrOp</span> <span class="o">-&gt;</span> <span class="s2">"Unexpected pattern."</span>
    <span class="o">|</span> <span class="n">ExpectedVarOrOpAsNameOfGlobalStatement</span> <span class="o">-&gt;</span> <span class="s2">"The first pattern of a global statement should either be a variable or compile down to it."</span>
    <span class="o">|</span> <span class="n">ExpectedVarOrOpAsNameOfRecStatement</span> <span class="o">-&gt;</span> <span class="s2">"The first pattern of a recursive statement should either be a variable or compile down to it."</span>
    <span class="o">|</span> <span class="n">ExpectedExpression</span> <span class="o">-&gt;</span> <span class="s2">"A sequence of statements should end in an expression."</span>
    <span class="o">|</span> <span class="n">InbuiltOpNotFound</span> <span class="o">-&gt;</span> <span class="s2">"Not found among the inbuilt operations."</span>
    <span class="o">|</span> <span class="n">UnknownOperator</span> <span class="o">-&gt;</span> <span class="s2">"Operator does not have known precedence and associativity."</span>
    <span class="o">|</span> <span class="n">ForallNotAllowed</span> <span class="o">-&gt;</span> <span class="s2">"Forall not allowed here."</span>
    <span class="o">|</span> <span class="n">InvalidPattern</span> <span class="n">DisjointOrPatternVar</span> <span class="o">-&gt;</span> <span class="s2">"Both branches of an or pattern need to have the same variables. This one is disjoint."</span>
    <span class="o">|</span> <span class="n">InvalidPattern</span> <span class="n">DuplicateTermVar</span> <span class="o">-&gt;</span> <span class="s2">"Duplicate term variable in pattern."</span>
    <span class="o">|</span> <span class="n">InvalidPattern</span> <span class="n">DuplicateTypeVar</span> <span class="o">-&gt;</span> <span class="s2">"Duplicate type variable in pattern."</span>
    <span class="o">|</span> <span class="n">InvalidPattern</span> <span class="n">ShadowedVar</span> <span class="o">-&gt;</span> <span class="s2">"Shadowed pattern variable."</span>
    <span class="o">|</span> <span class="n">MetavarNotAllowed</span> <span class="o">-&gt;</span> <span class="s2">"Metavariable is not allowed here."</span>
    <span class="o">|</span> <span class="n">SymbolPairedShouldStartWithUppercaseInTypeScope</span> <span class="o">-&gt;</span> <span class="s2">"Paired symbol should start with uppercase in type scope."</span>
    <span class="o">|</span> <span class="n">TermNotAllowed</span> <span class="o">-&gt;</span> <span class="s2">"The term is not allowed here."</span>
    <span class="o">|</span> <span class="n">TypecaseNotAllowed</span> <span class="o">-&gt;</span> <span class="s2">"Typecase is not allowed here."</span>
    <span class="o">|</span> <span class="n">UnexpectedAndInlRec</span> <span class="o">-&gt;</span> <span class="s2">"The first statement of a recursive block has to be marked as recursive."</span>
    <span class="o">|</span> <span class="n">ExpectedEob</span> <span class="o">-&gt;</span> <span class="s2">"Failed to parse this token."</span>
    <span class="o">|</span> <span class="n">UnexpectedEob</span> <span class="o">-&gt;</span> <span class="s2">"Unexpected end of block past this token."</span>
    <span class="o">|</span> <span class="n">UnknownError</span> <span class="o">-&gt;</span> <span class="s2">"Compiler error: Parsing failed at this position with no error message and without consuming all the tokens in a block."</span>
    <span class="o">|</span> <span class="n">DuplicateRecordTypeVar</span> <span class="o">-&gt;</span> <span class="s2">"Duplicate record type variable."</span>
    <span class="o">|</span> <span class="n">DuplicateForallVar</span> <span class="o">-&gt;</span> <span class="s2">"Duplicate forall variable."</span>
    <span class="o">|</span> <span class="n">DuplicateConstraint</span> <span class="o">-&gt;</span> <span class="s2">"Duplicate constraint."</span>
    <span class="o">|</span> <span class="n">InvalidPattern</span> <span class="n">DuplicateRecordSymbol</span>
    <span class="o">|</span> <span class="n">DuplicateTermRecordSymbol</span> <span class="o">-&gt;</span> <span class="s2">"Duplicate record symbol."</span>
    <span class="o">|</span> <span class="n">InvalidPattern</span> <span class="n">DuplicateRecordInjection</span>
    <span class="o">|</span> <span class="n">DuplicateTermRecordInjection</span> <span class="o">-&gt;</span> <span class="s2">"Duplicate record injection."</span>
    <span class="o">|</span> <span class="n">DuplicateRecFunctionName</span> <span class="o">-&gt;</span> <span class="s2">"Shadowing of functions by the members of the same mutually recursive block is not allowed."</span>
    <span class="o">|</span> <span class="n">BottomUpNumberParseError</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">val_dsc</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"The string </span><span class="si">%s</span><span class="s2"> cannot be safely parsed as </span><span class="si">%s</span><span class="s2">."</span> <span class="n">x</span> <span class="n">val_dsc</span>
    <span class="o">|</span> <span class="n">DuplicateUnionKey</span> <span class="o">-&gt;</span> <span class="s2">"Duplicate union keys are not allowed."</span>
    <span class="o">|</span> <span class="n">ListLiteralsNotAllowedInBottomUp</span> <span class="o">-&gt;</span> <span class="s2">"List literals are not allowed in the bottom-up segment."</span>
    <span class="o">|</span> <span class="n">ArrayLiteralsNotAllowedInBottomUp</span> <span class="o">-&gt;</span> <span class="s2">"Array literals are not allowed in the bottom-up segment."</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=35">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="HopacInfixes">HopacInfixes<a class="anchor-link" href="#HopacInfixes"></a></h2>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=36">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1">#r @"../../../../../../../.nuget/packages/hopac/0.5.1/lib/netstandard2.0/Hopac.dll"</span>
<span class="c1">#r @"../../../../../../../.nuget/packages/hopac/0.5.1/lib/netstandard2.0/Hopac.Core.dll"</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=37">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="nb">open</span> <span class="n">Hopac</span>
<span class="nb">open</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">Infixes</span>

<span class="n">let</span> <span class="p">(</span><span class="o">&gt;&gt;**</span><span class="p">)</span> <span class="n">x</span> <span class="n">f</span> <span class="o">=</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">Promise</span><span class="o">.</span><span class="n">Now</span><span class="o">.</span><span class="n">isFulfilled</span>
    <span class="n">then</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">Promise</span><span class="o">.</span><span class="n">Now</span><span class="o">.</span><span class="n">get</span> <span class="o">|&gt;</span> <span class="n">f</span>
    <span class="k">else</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">Infixes</span><span class="o">.</span><span class="p">(</span><span class="o">&gt;&gt;=*</span><span class="p">)</span> <span class="n">x</span> <span class="n">f</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=38">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="BlockBundling">BlockBundling<a class="anchor-link" href="#BlockBundling"></a></h2>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=39">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="nb">open</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">Extensions</span>
<span class="nb">open</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">Stream</span>

<span class="o">//</span> <span class="nb">open</span> <span class="n">FSharpx</span><span class="o">.</span><span class="n">Collections</span>

<span class="o">//</span> <span class="n">These</span> <span class="n">bundles</span> <span class="n">are</span> <span class="n">top</span> <span class="n">statements</span> <span class="n">that</span> <span class="n">have</span> <span class="n">their</span> <span class="nb">range</span> <span class="n">offsets</span> <span class="n">distributed</span> <span class="n">into</span> <span class="n">them</span><span class="o">.</span>
<span class="nb">type</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ReferenceEquality</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">Bundle</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">BundleType</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="p">(</span><span class="n">VSCRange</span> <span class="o">*</span> <span class="n">VarString</span><span class="p">)</span> <span class="o">*</span> <span class="n">HoVar</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">RawTExpr</span>
    <span class="o">|</span> <span class="n">BundleNominal</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="p">(</span><span class="n">VSCRange</span> <span class="o">*</span> <span class="n">VarString</span><span class="p">)</span> <span class="o">*</span> <span class="n">HoVar</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">RawTExpr</span>
    <span class="o">|</span> <span class="n">BundleNominalRec</span> <span class="n">of</span> <span class="p">(</span><span class="n">VSCRange</span> <span class="o">*</span> <span class="p">(</span><span class="n">VSCRange</span> <span class="o">*</span> <span class="n">VarString</span><span class="p">)</span> <span class="o">*</span> <span class="n">HoVar</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">RawTExpr</span><span class="p">)</span> <span class="nb">list</span>
    <span class="o">|</span> <span class="n">BundleInl</span> <span class="n">of</span> <span class="n">Comments</span> <span class="o">*</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="p">(</span><span class="n">VSCRange</span> <span class="o">*</span> <span class="n">VarString</span><span class="p">)</span> <span class="o">*</span> <span class="n">RawExpr</span> <span class="o">*</span> <span class="n">is_top_down</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="o">|</span> <span class="n">BundleRecInl</span> <span class="n">of</span> <span class="p">(</span><span class="n">Comments</span> <span class="o">*</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="p">(</span><span class="n">VSCRange</span> <span class="o">*</span> <span class="n">VarString</span><span class="p">)</span> <span class="o">*</span> <span class="n">RawExpr</span><span class="p">)</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">is_top_down</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="o">|</span> <span class="n">BundlePrototype</span> <span class="n">of</span> <span class="n">Comments</span> <span class="o">*</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="p">(</span><span class="n">VSCRange</span> <span class="o">*</span> <span class="n">VarString</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">VSCRange</span> <span class="o">*</span> <span class="n">VarString</span><span class="p">)</span> <span class="o">*</span> <span class="n">TypeVar</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">RawTExpr</span>
    <span class="o">|</span> <span class="n">BundleInstance</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="p">(</span><span class="n">VSCRange</span> <span class="o">*</span> <span class="n">VarString</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">VSCRange</span> <span class="o">*</span> <span class="n">VarString</span><span class="p">)</span> <span class="o">*</span> <span class="n">TypeVar</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">RawExpr</span>
    <span class="o">|</span> <span class="n">BundleOpen</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="p">(</span><span class="n">VSCRange</span> <span class="o">*</span> <span class="n">VarString</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">VSCRange</span> <span class="o">*</span> <span class="n">SymbolString</span><span class="p">)</span> <span class="nb">list</span>

<span class="n">let</span> <span class="n">bundle_range</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">BundleType</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">BundleNominal</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">BundleInl</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> 
    <span class="o">|</span> <span class="n">BundlePrototype</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">BundleInstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">BundleOpen</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">r</span>
    <span class="o">|</span> <span class="n">BundleNominalRec</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">head</span> <span class="n">l</span> <span class="o">|&gt;</span> <span class="n">fun</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">r</span>
    <span class="o">|</span> <span class="n">BundleRecInl</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">head</span> <span class="n">l</span> <span class="o">|&gt;</span> <span class="n">fun</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">r</span>

<span class="n">let</span> <span class="n">add_offset</span> <span class="n">offset</span> <span class="p">(</span><span class="nb">range</span> <span class="p">:</span> <span class="n">VSCRange</span><span class="p">)</span> <span class="p">:</span> <span class="n">VSCRange</span> <span class="o">=</span> 
    <span class="n">let</span> <span class="n">f</span> <span class="p">(</span><span class="n">a</span> <span class="p">:</span> <span class="n">VSCPos</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span><span class="n">a</span> <span class="k">with</span> <span class="n">line</span><span class="o">=</span><span class="n">offset</span> <span class="o">+</span> <span class="n">a</span><span class="o">.</span><span class="n">line</span><span class="o">|</span><span class="p">}</span>
    <span class="n">let</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="nb">range</span>
    <span class="n">f</span> <span class="n">a</span><span class="p">,</span> <span class="n">f</span> <span class="n">b</span>
<span class="n">let</span> <span class="n">add_offset_hovar</span> <span class="n">offset</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">=</span> <span class="n">add_offset</span> <span class="n">offset</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span>
<span class="n">let</span> <span class="n">add_offset_hovar_list</span> <span class="n">offset</span> <span class="n">x</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">add_offset_hovar</span> <span class="n">offset</span><span class="p">)</span> <span class="n">x</span>
<span class="n">let</span> <span class="n">add_offset_typevar</span> <span class="n">offset</span> <span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">),</span><span class="n">c</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">add_offset</span> <span class="n">offset</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="n">add_offset_hovar_list</span> <span class="n">offset</span> <span class="n">c</span>
<span class="n">let</span> <span class="n">add_offset_typevar_list</span> <span class="n">offset</span> <span class="n">x</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">add_offset_typevar</span> <span class="n">offset</span><span class="p">)</span> <span class="n">x</span>

<span class="n">let</span> <span class="n">rec</span> <span class="n">fold_offset_ty</span> <span class="n">offset</span> <span class="n">x</span> <span class="o">=</span> 
    <span class="n">let</span> <span class="n">f</span> <span class="o">=</span> <span class="n">fold_offset_ty</span> <span class="n">offset</span>
    <span class="n">let</span> <span class="n">g</span> <span class="o">=</span> <span class="n">add_offset</span> <span class="n">offset</span>
    <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">RawTWildcard</span> <span class="n">r</span> <span class="o">-&gt;</span> <span class="n">RawTWildcard</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawTLit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawTLit</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawTB</span> <span class="n">r</span> <span class="o">-&gt;</span> <span class="n">RawTB</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawTMetaVar</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawTMetaVar</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawTVar</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawTVar</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawTArray</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawTArray</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawTPair</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawTPair</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawTFun</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawTFun</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawTRecord</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawTRecord</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">Map</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawTUnion</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawTUnion</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">Map</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="p">(</span><span class="n">is_gadt</span><span class="p">,</span><span class="n">body</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">is_gadt</span><span class="p">,</span> <span class="n">f</span> <span class="n">body</span><span class="p">)</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">f</span> <span class="n">c</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawTTypecase</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawTTypecase</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span><span class="p">,</span> <span class="n">f</span> <span class="n">b</span><span class="p">)</span> <span class="n">b</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawTSymbol</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawTSymbol</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawTApply</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawTApply</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawTForall</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawTForall</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">add_offset_typevar</span> <span class="n">offset</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawTExists</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawTExists</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">add_offset_typevar_list</span> <span class="n">offset</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawTPrim</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawTPrim</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawTTerm</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawTTerm</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">fold_offset_term</span> <span class="n">offset</span> <span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawTMacro</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawTMacro</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">fold_offset_macro</span> <span class="n">offset</span> <span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawTFilledNominal</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawTFilledNominal</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawTLayout</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawTLayout</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
<span class="ow">and</span> <span class="n">fold_offset_macro</span> <span class="n">offset</span> <span class="n">a</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">g</span> <span class="o">=</span> <span class="n">add_offset</span> <span class="n">offset</span>
    <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">function</span>
        <span class="o">|</span> <span class="n">RawMacroText</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawMacroText</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawMacroTerm</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawMacroTerm</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">fold_offset_term</span> <span class="n">offset</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawMacroType</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawMacroType</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">fold_offset_ty</span> <span class="n">offset</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawMacroTypeLit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawMacroTypeLit</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">fold_offset_ty</span> <span class="n">offset</span> <span class="n">a</span><span class="p">)</span>
        <span class="p">)</span> <span class="n">a</span>
<span class="ow">and</span> <span class="n">fold_offset_term</span> <span class="n">offset</span> <span class="n">x</span> <span class="o">=</span> 
    <span class="n">let</span> <span class="n">f</span> <span class="o">=</span> <span class="n">fold_offset_term</span> <span class="n">offset</span>
    <span class="n">let</span> <span class="n">ty</span> <span class="o">=</span> <span class="n">fold_offset_ty</span> <span class="n">offset</span>
    <span class="n">let</span> <span class="n">g</span> <span class="o">=</span> <span class="n">add_offset</span> <span class="n">offset</span>
    <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">RawB</span> <span class="n">r</span> <span class="o">-&gt;</span> <span class="n">RawB</span> <span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawV</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawV</span> <span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawLit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawLit</span> <span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawDefaultLit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawDefaultLit</span> <span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawSymbol</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawSymbol</span> <span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawType</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawType</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span> <span class="n">ty</span> <span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawMatch</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawMatch</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">fold_offset_pattern</span> <span class="n">offset</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span> <span class="n">b</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawFun</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawFun</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">fold_offset_pattern</span> <span class="n">offset</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span> <span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawForall</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawForall</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">add_offset_typevar</span> <span class="n">offset</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawExists</span><span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="sa">r</span><span class="s1">',a),b) -&gt; RawExists(g r,(g r'</span><span class="p">,</span><span class="n">Option</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="n">ty</span><span class="p">)</span> <span class="n">a</span><span class="p">),</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawFilledForall</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawFilledForall</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawRecBlock</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawRecBlock</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawRecordWith</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> 
        <span class="n">let</span> <span class="n">b</span> <span class="o">=</span>
            <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">function</span>
                <span class="o">|</span> <span class="n">RawRecordWithSymbol</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawRecordWithSymbol</span><span class="p">((</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">RawRecordWithSymbolModify</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawRecordWithSymbolModify</span><span class="p">((</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">RawRecordWithInjectVar</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawRecordWithInjectVar</span><span class="p">((</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">RawRecordWithInjectVarModify</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawRecordWithInjectVarModify</span><span class="p">((</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="n">let</span> <span class="n">c</span> <span class="o">=</span>
            <span class="n">c</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">function</span>
                <span class="o">|</span> <span class="n">RawRecordWithoutSymbol</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawRecordWithoutSymbol</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">RawRecordWithoutInjectVar</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawRecordWithoutInjectVar</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="n">RawRecordWith</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawOp</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawOp</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="n">f</span> <span class="n">b</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawJoinPoint</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawJoinPoint</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">Option</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="sa">r</span><span class="s1">',w) -&gt; g r'</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> <span class="n">q</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawAnnot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawAnnot</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">ty</span> <span class="n">b</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawTypecase</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawTypecase</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">ty</span> <span class="n">a</span><span class="p">,</span><span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ty</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span> <span class="n">b</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawOpen</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawOpen</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">add_offset_hovar</span> <span class="n">offset</span> <span class="n">a</span><span class="p">,</span><span class="n">add_offset_hovar_list</span> <span class="n">offset</span> <span class="n">b</span><span class="p">,</span><span class="n">f</span> <span class="n">c</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawApply</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawApply</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawIfThenElse</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawIfThenElse</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">,</span><span class="n">f</span> <span class="n">c</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawIfThen</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawIfThen</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawPair</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawPair</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawSeq</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawSeq</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawHeapMutableSet</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawHeapMutableSet</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="n">f</span> <span class="n">b</span><span class="p">,</span><span class="n">f</span> <span class="n">c</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawReal</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawReal</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawMissingBody</span> <span class="n">r</span> <span class="o">-&gt;</span> <span class="n">RawMissingBody</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawMacro</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawMacro</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">fold_offset_macro</span> <span class="n">offset</span> <span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RawArray</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawArray</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="n">f</span> <span class="n">a</span><span class="p">)</span>
<span class="ow">and</span> <span class="n">fold_offset_pattern</span> <span class="n">offset</span> <span class="n">x</span> <span class="o">=</span> 
    <span class="n">let</span> <span class="n">f</span> <span class="o">=</span> <span class="n">fold_offset_pattern</span> <span class="n">offset</span>
    <span class="n">let</span> <span class="n">term</span> <span class="o">=</span> <span class="n">fold_offset_term</span> <span class="n">offset</span>
    <span class="n">let</span> <span class="n">ty</span> <span class="o">=</span> <span class="n">fold_offset_ty</span> <span class="n">offset</span>
    <span class="n">let</span> <span class="n">g</span> <span class="o">=</span> <span class="n">add_offset</span> <span class="n">offset</span>
    <span class="n">let</span> <span class="n">g</span><span class="s1">' x = add_offset_hovar offset x</span>
    <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">PatFilledDefaultValue</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: Later stages only."</span>
    <span class="o">|</span> <span class="n">PatB</span> <span class="n">r</span> <span class="o">-&gt;</span> <span class="n">PatB</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">PatE</span> <span class="n">r</span> <span class="o">-&gt;</span> <span class="n">PatE</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">PatVar</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PatVar</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">PatDyn</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PatDyn</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">PatUnbox</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PatUnbox</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">PatAnnot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PatAnnot</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">ty</span> <span class="n">b</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">PatPair</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PatPair</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">PatSymbol</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PatSymbol</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">PatRecordMembers</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">function</span>
            <span class="o">|</span> <span class="n">PatRecordMembersSymbol</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PatRecordMembersSymbol</span><span class="p">((</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">PatRecordMembersInjectVar</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PatRecordMembersInjectVar</span><span class="p">((</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">PatRecordMembers</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">PatOr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PatOr</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">PatAnd</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PatAnd</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">PatValue</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PatValue</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">PatDefaultValue</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PatDefaultValue</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">PatWhen</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PatWhen</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">term</span> <span class="n">b</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">PatNominal</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PatNominal</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">g</span><span class="s1">' a,List.map g'</span> <span class="n">b</span><span class="p">,</span><span class="n">f</span> <span class="n">c</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">PatExists</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PatExists</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="n">g</span><span class="s1">' a,f b)</span>
    <span class="o">|</span> <span class="n">PatArray</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PatArray</span><span class="p">(</span><span class="n">g</span> <span class="n">r</span><span class="p">,</span><span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="n">f</span> <span class="n">a</span><span class="p">)</span>
    
<span class="n">let</span> <span class="n">bundle_blocks</span> <span class="p">(</span><span class="n">blocks</span> <span class="p">:</span> <span class="n">TopStatement</span> <span class="n">Block</span> <span class="nb">list</span><span class="p">)</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">blocks</span> <span class="k">with</span>
    <span class="o">|</span> <span class="p">[]</span> <span class="o">-&gt;</span> <span class="kc">None</span>
    <span class="o">|</span> <span class="p">{</span><span class="n">block</span><span class="o">=</span><span class="n">TopAnd</span> <span class="n">_</span><span class="p">}</span> <span class="p">::</span> <span class="n">x</span><span class="s1">' -&gt; failwith "Compiler error: TopAnd should be eliminated during the first bundling step."</span>
    <span class="o">|</span> <span class="p">{</span><span class="n">block</span><span class="o">=</span><span class="n">TopRecInl</span> <span class="n">_</span><span class="p">}</span> <span class="p">::</span> <span class="n">_</span> <span class="k">as</span> <span class="n">l</span> <span class="o">-&gt;</span>
        <span class="n">l</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">mapFold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">function</span>
            <span class="o">|</span> <span class="p">{</span><span class="n">offset</span><span class="o">=</span><span class="n">i</span><span class="p">;</span> <span class="n">block</span><span class="o">=</span><span class="n">TopRecInl</span><span class="p">(</span><span class="n">com</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)}</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">com</span><span class="p">,</span> <span class="n">add_offset</span> <span class="n">i</span> <span class="n">r</span><span class="p">,</span> <span class="n">add_offset_hovar</span> <span class="n">i</span> <span class="n">a</span><span class="p">,</span> <span class="n">fold_offset_term</span> <span class="n">i</span> <span class="n">b</span><span class="p">),</span> <span class="n">c</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: Recursive inl statements can only be followed by statements of the same type."</span>
            <span class="p">)</span> <span class="n">true</span>
        <span class="o">|&gt;</span> <span class="n">BundleRecInl</span> <span class="o">|&gt;</span> <span class="n">Some</span>
    <span class="o">|</span> <span class="p">{</span><span class="n">block</span><span class="o">=</span><span class="n">TopNominalRec</span> <span class="n">_</span><span class="p">}</span> <span class="p">::</span> <span class="n">_</span> <span class="k">as</span> <span class="n">l</span> <span class="o">-&gt;</span>
        <span class="n">l</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">function</span> 
            <span class="o">|</span> <span class="p">{</span><span class="n">offset</span><span class="o">=</span><span class="n">i</span><span class="p">;</span> <span class="n">block</span><span class="o">=</span><span class="n">TopNominalRec</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)}</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">add_offset</span> <span class="n">i</span> <span class="n">r</span><span class="p">,</span> <span class="n">add_offset_hovar</span> <span class="n">i</span> <span class="n">a</span><span class="p">,</span> <span class="n">add_offset_hovar_list</span> <span class="n">i</span> <span class="n">b</span><span class="p">,</span> <span class="n">fold_offset_ty</span> <span class="n">i</span> <span class="n">c</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: Recursive type statements can only be followed by statements of the same type."</span>
            <span class="p">)</span>
        <span class="o">|&gt;</span> <span class="n">BundleNominalRec</span> <span class="o">|&gt;</span> <span class="n">Some</span>
    <span class="o">|</span> <span class="p">[{</span><span class="n">offset</span><span class="o">=</span><span class="n">i</span><span class="p">;</span> <span class="n">block</span><span class="o">=</span><span class="n">TopInl</span><span class="p">(</span><span class="n">com</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)}]</span> <span class="o">-&gt;</span> <span class="n">BundleInl</span><span class="p">(</span><span class="n">com</span><span class="p">,</span> <span class="n">add_offset</span> <span class="n">i</span> <span class="n">r</span><span class="p">,</span> <span class="n">add_offset_hovar</span> <span class="n">i</span> <span class="n">a</span><span class="p">,</span> <span class="n">fold_offset_term</span> <span class="n">i</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">Some</span>
    <span class="o">|</span> <span class="p">[{</span><span class="n">offset</span><span class="o">=</span><span class="n">i</span><span class="p">;</span> <span class="n">block</span><span class="o">=</span><span class="n">TopPrototype</span><span class="p">(</span><span class="n">com</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">)}]</span> <span class="o">-&gt;</span> <span class="n">BundlePrototype</span><span class="p">(</span><span class="n">com</span><span class="p">,</span><span class="n">add_offset</span> <span class="n">i</span> <span class="n">r</span><span class="p">,</span> <span class="n">add_offset_hovar</span> <span class="n">i</span> <span class="n">a</span><span class="p">,</span> <span class="n">add_offset_hovar</span> <span class="n">i</span> <span class="n">b</span><span class="p">,</span> <span class="n">add_offset_typevar_list</span> <span class="n">i</span> <span class="n">c</span><span class="p">,</span> <span class="n">fold_offset_ty</span> <span class="n">i</span> <span class="n">d</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">Some</span>
    <span class="o">|</span> <span class="p">[{</span><span class="n">offset</span><span class="o">=</span><span class="n">i</span><span class="p">;</span> <span class="n">block</span><span class="o">=</span><span class="n">TopNominal</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)}]</span> <span class="o">-&gt;</span> <span class="n">BundleNominal</span><span class="p">(</span><span class="n">add_offset</span> <span class="n">i</span> <span class="n">r</span><span class="p">,</span> <span class="n">add_offset_hovar</span> <span class="n">i</span> <span class="n">a</span><span class="p">,</span> <span class="n">add_offset_hovar_list</span> <span class="n">i</span> <span class="n">b</span><span class="p">,</span> <span class="n">fold_offset_ty</span> <span class="n">i</span> <span class="n">c</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">Some</span>
    <span class="o">|</span> <span class="p">[{</span><span class="n">offset</span><span class="o">=</span><span class="n">i</span><span class="p">;</span> <span class="n">block</span><span class="o">=</span><span class="n">TopType</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)}]</span> <span class="o">-&gt;</span> <span class="n">BundleType</span><span class="p">(</span><span class="n">add_offset</span> <span class="n">i</span> <span class="n">r</span><span class="p">,</span> <span class="n">add_offset_hovar</span> <span class="n">i</span> <span class="n">a</span><span class="p">,</span> <span class="n">add_offset_hovar_list</span> <span class="n">i</span> <span class="n">b</span><span class="p">,</span> <span class="n">fold_offset_ty</span> <span class="n">i</span> <span class="n">c</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">Some</span>
    <span class="o">|</span> <span class="p">[{</span><span class="n">offset</span><span class="o">=</span><span class="n">i</span><span class="p">;</span> <span class="n">block</span><span class="o">=</span><span class="n">TopInstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">)}]</span> <span class="o">-&gt;</span> <span class="n">BundleInstance</span><span class="p">(</span><span class="n">add_offset</span> <span class="n">i</span> <span class="n">r</span><span class="p">,</span> <span class="n">add_offset_hovar</span> <span class="n">i</span> <span class="n">a</span><span class="p">,</span> <span class="n">add_offset_hovar</span> <span class="n">i</span> <span class="n">b</span><span class="p">,</span> <span class="n">add_offset_typevar_list</span> <span class="n">i</span> <span class="n">c</span><span class="p">,</span> <span class="n">fold_offset_term</span> <span class="n">i</span> <span class="n">d</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">Some</span>
    <span class="o">|</span> <span class="p">[{</span><span class="n">offset</span><span class="o">=</span><span class="n">i</span><span class="p">;</span> <span class="n">block</span><span class="o">=</span><span class="n">TopOpen</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)}]</span> <span class="o">-&gt;</span> <span class="n">BundleOpen</span><span class="p">(</span><span class="n">add_offset</span> <span class="n">i</span> <span class="n">r</span><span class="p">,</span> <span class="n">add_offset_hovar</span> <span class="n">i</span> <span class="n">a</span><span class="p">,</span> <span class="n">add_offset_hovar_list</span> <span class="n">i</span> <span class="n">b</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">Some</span>
    <span class="o">|</span> <span class="p">{</span><span class="n">block</span><span class="o">=</span><span class="n">TopInl</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TopPrototype</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TopNominal</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TopType</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TopInstance</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TopOpen</span> <span class="n">_</span><span class="p">}</span> <span class="p">::</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: Regular top level statements should be singleton bundles."</span>

<span class="n">let</span> <span class="n">add_line_to_range</span> <span class="n">line</span> <span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="p">:</span> <span class="n">VSCRange</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span><span class="n">a</span> <span class="k">with</span> <span class="n">line</span><span class="o">=</span><span class="n">line</span><span class="o">+</span><span class="n">a</span><span class="o">.</span><span class="n">line</span><span class="o">|</span><span class="p">},</span> <span class="p">{</span><span class="o">|</span><span class="n">b</span> <span class="k">with</span> <span class="n">line</span><span class="o">=</span><span class="n">line</span><span class="o">+</span><span class="n">b</span><span class="o">.</span><span class="n">line</span><span class="o">|</span><span class="p">}</span>

<span class="n">let</span> <span class="n">process_error</span> <span class="n">v</span> <span class="o">=</span> 
    <span class="n">let</span> <span class="n">messages</span><span class="p">,</span> <span class="n">expecteds</span> <span class="o">=</span> <span class="n">v</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">distinct</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">partition</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="n">Char</span><span class="o">.</span><span class="n">IsUpper</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">let</span> <span class="n">ex</span> <span class="p">()</span> <span class="o">=</span> <span class="n">match</span> <span class="n">expecteds</span> <span class="k">with</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Expected: </span><span class="si">%s</span><span class="s2">"</span> <span class="n">x</span> <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Expected one of: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">", "</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">f</span> <span class="n">l</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> <span class="n">l</span>
    <span class="k">if</span> <span class="n">List</span><span class="o">.</span><span class="n">isEmpty</span> <span class="n">expecteds</span> <span class="n">then</span> <span class="n">f</span> <span class="n">messages</span>
    <span class="k">elif</span> <span class="n">List</span><span class="o">.</span><span class="n">isEmpty</span> <span class="n">messages</span> <span class="n">then</span> <span class="n">ex</span> <span class="p">()</span>
    <span class="k">else</span> <span class="n">f</span> <span class="p">(</span><span class="n">ex</span> <span class="p">()</span> <span class="p">::</span> <span class="s2">""</span> <span class="p">::</span> <span class="s2">"Other error messages:"</span> <span class="p">::</span> <span class="n">messages</span><span class="p">)</span>

<span class="n">let</span> <span class="n">show_block_parsing_error</span> <span class="n">line</span> <span class="p">(</span><span class="n">l</span> <span class="p">:</span> <span class="n">ParserErrorsList</span><span class="p">)</span> <span class="p">:</span> <span class="n">RString</span> <span class="nb">list</span> <span class="o">=</span>
    <span class="n">l</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">groupBy</span> <span class="n">fst</span>
    <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="o">-&gt;</span> 
        <span class="n">let</span> <span class="n">k</span> <span class="o">=</span> <span class="n">add_line_to_range</span> <span class="n">line</span> <span class="n">k</span>
        <span class="n">let</span> <span class="n">v</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">snd</span> <span class="o">&gt;&gt;</span> <span class="n">show_parser_error</span><span class="p">)</span> <span class="n">v</span>
        <span class="n">k</span><span class="p">,</span> <span class="n">process_error</span> <span class="n">v</span>
        <span class="p">)</span>

<span class="nb">type</span> <span class="n">ParsedBlock</span> <span class="o">=</span> <span class="p">{</span><span class="n">result</span> <span class="p">:</span> <span class="n">ParseResult</span><span class="p">;</span> <span class="n">semantic_tokens</span> <span class="p">:</span> <span class="n">LineTokens</span><span class="p">}</span>
<span class="nb">type</span> <span class="n">ParserState</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">is_top_down</span> <span class="p">:</span> <span class="nb">bool</span>
    <span class="n">blocks</span> <span class="p">:</span> <span class="p">(</span><span class="n">LineTokens</span> <span class="o">*</span> <span class="n">ParsedBlock</span> <span class="n">Promise</span> <span class="n">Block</span><span class="p">)</span> <span class="nb">list</span>
    <span class="p">}</span>
<span class="nb">type</span> <span class="n">BlockBundleValue</span> <span class="o">=</span> <span class="p">{</span><span class="n">bundle</span> <span class="p">:</span> <span class="n">Bundle</span> <span class="n">option</span><span class="p">;</span> <span class="n">errors</span> <span class="p">:</span> <span class="n">RString</span> <span class="nb">list</span><span class="p">}</span>
<span class="nb">type</span> <span class="n">BlockBundleState</span> <span class="o">=</span> <span class="p">(</span><span class="n">TopStatement</span> <span class="n">Block</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">BlockBundleValue</span><span class="p">)</span> <span class="n">Stream</span>
<span class="nb">type</span> <span class="n">private</span> <span class="n">BlockBundleStateInner</span> <span class="o">=</span> <span class="p">{</span><span class="n">errors</span> <span class="p">:</span> <span class="n">RString</span> <span class="nb">list</span><span class="p">;</span> <span class="n">tmp</span> <span class="p">:</span> <span class="n">TopStatement</span> <span class="n">Block</span> <span class="nb">list</span><span class="p">;</span> <span class="n">state</span> <span class="p">:</span> <span class="n">BlockBundleState</span><span class="p">}</span>

<span class="n">let</span> <span class="n">wdiff_block_bundle_init</span> <span class="p">:</span> <span class="n">BlockBundleState</span> <span class="o">=</span> <span class="n">Promise</span><span class="o">.</span><span class="n">Now</span><span class="o">.</span><span class="n">never</span><span class="p">()</span>
<span class="o">///</span> <span class="n">Bundles</span> <span class="n">the</span> <span class="n">blocks</span> <span class="k">with</span> <span class="n">the</span> <span class="err">`</span><span class="ow">and</span><span class="err">`</span> <span class="n">statements</span><span class="o">.</span> <span class="n">Also</span> <span class="n">collects</span> <span class="n">the</span> <span class="n">parser</span> <span class="n">errors</span><span class="o">.</span>
<span class="o">///</span> <span class="n">Does</span> <span class="n">diffing</span> <span class="n">to</span> <span class="n">ref</span> <span class="n">preserve</span> <span class="n">the</span> <span class="n">bundles</span><span class="o">.</span>
<span class="n">let</span> <span class="n">wdiff_block_bundle</span> <span class="p">(</span><span class="n">state</span> <span class="p">:</span> <span class="n">BlockBundleState</span><span class="p">)</span> <span class="p">(</span><span class="n">l</span> <span class="p">:</span> <span class="n">ParserState</span><span class="p">)</span> <span class="p">:</span> <span class="n">BlockBundleState</span> <span class="o">=</span>
    <span class="n">let</span> <span class="p">(</span><span class="o">+.</span><span class="p">)</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">add_line_to_range</span> <span class="n">a</span> <span class="n">b</span>

    <span class="n">let</span> <span class="n">empty</span> <span class="o">=</span> <span class="p">{</span><span class="n">state</span><span class="o">=</span><span class="n">wdiff_block_bundle_init</span><span class="p">;</span> <span class="n">tmp</span><span class="o">=</span><span class="p">[];</span> <span class="n">errors</span><span class="o">=</span><span class="p">[]}</span>
    <span class="n">let</span> <span class="n">move_temp</span> <span class="p">(</span><span class="n">s</span> <span class="p">:</span> <span class="n">BlockBundleStateInner</span><span class="p">)</span> <span class="nb">next</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">o</span><span class="s1">' = List.rev s.tmp</span>
        <span class="n">let</span> <span class="n">fl</span> <span class="p">()</span> <span class="o">=</span> <span class="p">(</span><span class="n">o</span><span class="s1">',{bundle=bundle_blocks o'</span><span class="p">;</span> <span class="n">errors</span><span class="o">=</span><span class="n">Seq</span><span class="o">.</span><span class="n">toList</span> <span class="n">s</span><span class="o">.</span><span class="n">errors</span><span class="p">}),</span> <span class="nb">next</span> <span class="n">empty</span>
        <span class="k">if</span> <span class="n">Promise</span><span class="o">.</span><span class="n">Now</span><span class="o">.</span><span class="n">isFulfilled</span> <span class="n">s</span><span class="o">.</span><span class="n">state</span> <span class="n">then</span>
            <span class="k">match</span> <span class="n">Promise</span><span class="o">.</span><span class="n">Now</span><span class="o">.</span><span class="n">get</span> <span class="n">s</span><span class="o">.</span><span class="n">state</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">Cons</span><span class="p">((</span><span class="n">o</span><span class="p">,</span><span class="n">q</span><span class="p">),</span><span class="n">xs</span><span class="p">)</span> <span class="n">when</span> <span class="n">o</span> <span class="o">=</span> <span class="n">o</span><span class="s1">' -&gt; (o,{bundle=q.bundle; errors=Seq.toList s.errors}), next {state=xs; tmp=[]; errors=[]}</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">fl</span> <span class="p">()</span>
        <span class="k">else</span> <span class="n">fl</span> <span class="p">()</span>
        <span class="o">|&gt;</span> <span class="n">Cons</span> <span class="o">|&gt;</span> <span class="n">Promise</span><span class="o">.</span><span class="n">Now</span><span class="o">.</span><span class="n">withValue</span>

    <span class="n">let</span> <span class="n">inline</span> <span class="nb">iter</span> <span class="p">(</span><span class="n">s</span> <span class="p">:</span> <span class="n">BlockBundleStateInner</span><span class="p">)</span> <span class="n">l</span> <span class="n">f</span> <span class="o">=</span> 
        <span class="k">match</span> <span class="n">l</span> <span class="k">with</span>
        <span class="o">|</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="p">::</span> <span class="n">x</span><span class="s1">' -&gt; let offset = x.offset in x.block &gt;&gt;** fun {result=a} -&gt; f (offset,a,x'</span><span class="p">)</span>
        <span class="o">|</span> <span class="p">[]</span> <span class="o">-&gt;</span> <span class="n">move_temp</span> <span class="n">s</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Promise</span><span class="o">.</span><span class="n">Now</span><span class="o">.</span><span class="n">withValue</span> <span class="n">Nil</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">init</span> <span class="p">(</span><span class="n">s</span> <span class="p">:</span> <span class="n">BlockBundleStateInner</span><span class="p">)</span> <span class="n">l</span> <span class="o">=</span> <span class="nb">iter</span> <span class="n">s</span> <span class="n">l</span> <span class="o">&lt;|</span> <span class="n">fun</span> <span class="p">(</span><span class="n">offset</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="s1">') -&gt; </span>
        <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">Ok</span> <span class="p">(</span><span class="n">TopAnd</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">init</span> <span class="p">{</span><span class="n">s</span> <span class="k">with</span> <span class="n">errors</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+.</span> <span class="n">r</span><span class="p">,</span> <span class="s2">"Invalid `and` statement."</span><span class="p">)</span> <span class="p">::</span> <span class="n">s</span><span class="o">.</span><span class="n">errors</span><span class="p">}</span> <span class="n">x</span><span class="s1">'</span>
        <span class="o">|</span> <span class="n">Ok</span> <span class="p">(</span><span class="n">TopRecInl</span> <span class="n">_</span> <span class="k">as</span> <span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">recinl</span> <span class="p">{</span><span class="n">s</span> <span class="k">with</span> <span class="n">tmp</span> <span class="o">=</span> <span class="p">{</span><span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">;</span> <span class="n">block</span><span class="o">=</span><span class="n">a</span><span class="p">}</span> <span class="p">::</span> <span class="n">s</span><span class="o">.</span><span class="n">tmp</span><span class="p">}</span> <span class="n">x</span><span class="s1">'</span>
        <span class="o">|</span> <span class="n">Ok</span> <span class="p">(</span><span class="n">TopNominalRec</span> <span class="n">_</span> <span class="k">as</span> <span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">rectype</span> <span class="p">{</span><span class="n">s</span> <span class="k">with</span> <span class="n">tmp</span> <span class="o">=</span> <span class="p">{</span><span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">;</span> <span class="n">block</span><span class="o">=</span><span class="n">a</span><span class="p">}</span> <span class="p">::</span> <span class="n">s</span><span class="o">.</span><span class="n">tmp</span><span class="p">}</span> <span class="n">x</span><span class="s1">'</span>
        <span class="o">|</span> <span class="n">Ok</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">move_temp</span> <span class="p">{</span><span class="n">s</span> <span class="k">with</span> <span class="n">tmp</span> <span class="o">=</span> <span class="p">{</span><span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">;</span> <span class="n">block</span><span class="o">=</span><span class="n">a</span><span class="p">}</span> <span class="p">::</span> <span class="n">s</span><span class="o">.</span><span class="n">tmp</span><span class="p">}</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">init</span> <span class="n">s</span> <span class="n">x</span><span class="s1">')</span>
        <span class="o">|</span> <span class="n">Error</span> <span class="n">er</span> <span class="o">-&gt;</span> <span class="n">init</span> <span class="p">{</span><span class="n">s</span> <span class="k">with</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">append</span> <span class="p">(</span><span class="n">show_block_parsing_error</span> <span class="n">offset</span> <span class="n">er</span><span class="p">)</span> <span class="n">s</span><span class="o">.</span><span class="n">errors</span><span class="p">}</span> <span class="n">x</span><span class="s1">'</span>
    <span class="ow">and</span> <span class="n">recinl</span> <span class="p">(</span><span class="n">s</span> <span class="p">:</span> <span class="n">BlockBundleStateInner</span><span class="p">)</span> <span class="n">l</span> <span class="o">=</span> <span class="nb">iter</span> <span class="n">s</span> <span class="n">l</span> <span class="o">&lt;|</span> <span class="n">fun</span> <span class="p">(</span><span class="n">offset</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="s1">') -&gt; </span>
        <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">Ok</span> <span class="p">(</span><span class="n">TopAnd</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">TopRecInl</span> <span class="n">_</span> <span class="o">&amp;</span> <span class="n">a</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">recinl</span> <span class="p">{</span><span class="n">s</span> <span class="k">with</span> <span class="n">tmp</span> <span class="o">=</span> <span class="p">{</span><span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">;</span> <span class="n">block</span><span class="o">=</span><span class="n">a</span><span class="p">}</span> <span class="p">::</span> <span class="n">s</span><span class="o">.</span><span class="n">tmp</span><span class="p">}</span> <span class="n">x</span><span class="s1">'</span>
        <span class="o">|</span> <span class="n">Ok</span> <span class="p">(</span><span class="n">TopAnd</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">_</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">recinl</span> <span class="p">{</span><span class="n">s</span> <span class="k">with</span> <span class="n">errors</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+.</span> <span class="n">r</span><span class="p">,</span> <span class="s2">"inl/let recursive statements can only be followed by `and` inl/let statements."</span><span class="p">)</span> <span class="p">::</span> <span class="n">s</span><span class="o">.</span><span class="n">errors</span><span class="p">}</span> <span class="n">x</span><span class="s1">'</span>
        <span class="o">|</span> <span class="n">Ok</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">move_temp</span> <span class="n">s</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">init</span> <span class="n">s</span> <span class="n">l</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">Error</span> <span class="n">er</span> <span class="o">-&gt;</span> <span class="n">recinl</span> <span class="p">{</span><span class="n">s</span> <span class="k">with</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">append</span> <span class="p">(</span><span class="n">show_block_parsing_error</span> <span class="n">offset</span> <span class="n">er</span><span class="p">)</span> <span class="n">s</span><span class="o">.</span><span class="n">errors</span><span class="p">}</span> <span class="n">x</span><span class="s1">'</span>
    <span class="ow">and</span> <span class="n">rectype</span> <span class="p">(</span><span class="n">s</span> <span class="p">:</span> <span class="n">BlockBundleStateInner</span><span class="p">)</span> <span class="n">l</span> <span class="o">=</span> <span class="nb">iter</span> <span class="n">s</span> <span class="n">l</span> <span class="o">&lt;|</span> <span class="n">fun</span> <span class="p">(</span><span class="n">offset</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="s1">') -&gt; </span>
        <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">Ok</span> <span class="p">(</span><span class="n">TopAnd</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">TopNominalRec</span> <span class="n">_</span> <span class="o">&amp;</span> <span class="n">a</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">rectype</span> <span class="p">{</span><span class="n">s</span> <span class="k">with</span> <span class="n">tmp</span> <span class="o">=</span> <span class="p">{</span><span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">;</span> <span class="n">block</span><span class="o">=</span><span class="n">a</span><span class="p">}</span> <span class="p">::</span> <span class="n">s</span><span class="o">.</span><span class="n">tmp</span><span class="p">}</span> <span class="n">x</span><span class="s1">'</span>
        <span class="o">|</span> <span class="n">Ok</span> <span class="p">(</span><span class="n">TopAnd</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">_</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">rectype</span> <span class="p">{</span><span class="n">s</span> <span class="k">with</span> <span class="n">errors</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+.</span> <span class="n">r</span><span class="p">,</span> <span class="s2">"`union rec` can only be followed by `and union`."</span><span class="p">)</span> <span class="p">::</span> <span class="n">s</span><span class="o">.</span><span class="n">errors</span><span class="p">}</span> <span class="n">x</span><span class="s1">'</span>
        <span class="o">|</span> <span class="n">Ok</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">move_temp</span> <span class="n">s</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">init</span> <span class="n">s</span> <span class="n">l</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">Error</span> <span class="n">er</span> <span class="o">-&gt;</span> <span class="n">rectype</span> <span class="p">{</span><span class="n">s</span> <span class="k">with</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">append</span> <span class="p">(</span><span class="n">show_block_parsing_error</span> <span class="n">offset</span> <span class="n">er</span><span class="p">)</span> <span class="n">s</span><span class="o">.</span><span class="n">errors</span><span class="p">}</span> <span class="n">x</span><span class="s1">'</span>

    <span class="n">init</span> <span class="p">{</span><span class="n">empty</span> <span class="k">with</span> <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">}</span> <span class="n">l</span><span class="o">.</span><span class="n">blocks</span>

<span class="n">let</span> <span class="n">semantic_tokens</span> <span class="p">(</span><span class="n">l</span> <span class="p">:</span> <span class="n">ParserState</span><span class="p">)</span> <span class="o">=</span> 
    <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="n">s</span> <span class="o">=</span> <span class="n">function</span>
        <span class="o">|</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="p">::</span> <span class="n">xs</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">.</span><span class="n">block</span> <span class="o">&gt;&gt;=</span> <span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="p">(</span><span class="n">FSharpx</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">PersistentVector</span><span class="o">.</span><span class="n">append</span> <span class="n">s</span> <span class="n">x</span><span class="o">.</span><span class="n">semantic_tokens</span><span class="p">)</span> <span class="n">xs</span>
        <span class="o">|</span> <span class="p">[]</span> <span class="o">-&gt;</span> <span class="n">Job</span><span class="o">.</span><span class="n">result</span> <span class="n">s</span>
    <span class="n">loop</span> <span class="n">FSharpx</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">PersistentVector</span><span class="o">.</span><span class="n">empty</span> <span class="n">l</span><span class="o">.</span><span class="n">blocks</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=40">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="Infer">Infer<a class="anchor-link" href="#Infer"></a></h2>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=41">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="nb">type</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ReferenceEquality</span><span class="o">&gt;</span><span class="p">]</span> <span class="s1">'a ref'</span> <span class="o">=</span> <span class="p">{</span><span class="n">mutable</span> <span class="n">contents</span><span class="s1">' : '</span><span class="n">a</span><span class="p">}</span>
<span class="nb">type</span> <span class="n">TT</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">KindType</span>
    <span class="o">|</span> <span class="n">KindFun</span> <span class="n">of</span> <span class="n">TT</span> <span class="o">*</span> <span class="n">TT</span>
    <span class="o">|</span> <span class="n">KindMetavar</span> <span class="n">of</span> <span class="n">TT</span> <span class="n">option</span> <span class="n">ref</span><span class="s1">'</span>

<span class="nb">type</span> <span class="n">Constraint</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">CUInt</span>
    <span class="o">|</span> <span class="n">CSInt</span>
    <span class="o">|</span> <span class="n">CInt</span>
    <span class="o">|</span> <span class="n">CFloat</span>
    <span class="o">|</span> <span class="n">CNumber</span>
    <span class="o">|</span> <span class="n">CPrim</span>
    <span class="o">|</span> <span class="n">CSymbol</span>
    <span class="o">|</span> <span class="n">CRecord</span>
    <span class="o">|</span> <span class="n">CPrototype</span> <span class="n">of</span> <span class="n">GlobalId</span>

<span class="nb">type</span> <span class="n">ConstraintOrModule</span> <span class="o">=</span> <span class="n">C</span> <span class="n">of</span> <span class="n">Constraint</span> <span class="o">|</span> <span class="n">M</span> <span class="n">of</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="n">ConstraintOrModule</span><span class="o">&gt;</span>

<span class="nb">type</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ReferenceEquality</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">Var</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">scope</span> <span class="p">:</span> <span class="nb">int</span>
    <span class="n">constraints</span> <span class="p">:</span> <span class="n">Constraint</span> <span class="n">Set</span> <span class="o">//</span> <span class="n">Must</span> <span class="n">be</span> <span class="n">stated</span> <span class="n">up</span> <span class="n">front</span> <span class="ow">and</span> <span class="n">needs</span> <span class="n">to</span> <span class="n">be</span> <span class="n">static</span> <span class="ow">in</span> <span class="n">forall</span> <span class="nb">vars</span>
    <span class="n">kind</span> <span class="p">:</span> <span class="n">TT</span> <span class="o">//</span> <span class="n">Is</span> <span class="ow">not</span> <span class="n">supposed</span> <span class="n">to</span> <span class="n">have</span> <span class="n">metavars</span><span class="o">.</span>
    <span class="n">name</span> <span class="p">:</span> <span class="n">string</span> <span class="o">//</span> <span class="n">Is</span> <span class="n">what</span> <span class="n">gets</span> <span class="n">printed</span><span class="o">.</span>
    <span class="p">}</span>

<span class="nb">type</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ReferenceEquality</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">MVar</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">mutable</span> <span class="n">scope</span> <span class="p">:</span> <span class="nb">int</span>
    <span class="n">mutable</span> <span class="n">constraints</span> <span class="p">:</span> <span class="n">Constraint</span> <span class="n">Set</span> <span class="o">//</span> <span class="n">Must</span> <span class="n">be</span> <span class="n">stated</span> <span class="n">up</span> <span class="n">front</span> <span class="ow">and</span> <span class="n">needs</span> <span class="n">to</span> <span class="n">be</span> <span class="n">static</span> <span class="ow">in</span> <span class="n">forall</span> <span class="nb">vars</span>
    <span class="n">kind</span> <span class="p">:</span> <span class="n">TT</span> <span class="o">//</span> <span class="n">Has</span> <span class="n">metavars</span><span class="p">,</span> <span class="ow">and</span> <span class="n">so</span> <span class="ow">is</span> <span class="n">mutable</span><span class="o">.</span>
    <span class="p">}</span>

<span class="nb">type</span> <span class="n">TM</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">TMText</span> <span class="n">of</span> <span class="n">string</span>
    <span class="o">|</span> <span class="n">TMVar</span> <span class="n">of</span> <span class="n">T</span>
    <span class="o">|</span> <span class="n">TMLitVar</span> <span class="n">of</span> <span class="n">T</span>
<span class="ow">and</span> <span class="n">T</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">TyB</span>
    <span class="o">|</span> <span class="n">TyLit</span> <span class="n">of</span> <span class="n">Literal</span>
    <span class="o">|</span> <span class="n">TyPrim</span> <span class="n">of</span> <span class="n">PrimitiveType</span>
    <span class="o">|</span> <span class="n">TySymbol</span> <span class="n">of</span> <span class="n">string</span>
    <span class="o">|</span> <span class="n">TyPair</span> <span class="n">of</span> <span class="n">T</span> <span class="o">*</span> <span class="n">T</span>
    <span class="o">|</span> <span class="n">TyRecord</span> <span class="n">of</span> <span class="n">Map</span><span class="o">&lt;</span><span class="nb">int</span> <span class="o">*</span> <span class="n">string</span><span class="p">,</span> <span class="n">T</span><span class="o">&gt;</span>
    <span class="o">|</span> <span class="n">TyModule</span> <span class="n">of</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">T</span><span class="o">&gt;</span>
    <span class="o">|</span> <span class="n">TyComment</span> <span class="n">of</span> <span class="n">Comments</span> <span class="o">*</span> <span class="n">T</span>
    <span class="o">|</span> <span class="n">TyFun</span> <span class="n">of</span> <span class="n">T</span> <span class="o">*</span> <span class="n">T</span> <span class="o">*</span> <span class="n">FunType</span>
    <span class="o">|</span> <span class="n">TyArray</span> <span class="n">of</span> <span class="n">T</span>
    <span class="o">|</span> <span class="n">TyNominal</span> <span class="n">of</span> <span class="n">GlobalId</span>
    <span class="o">|</span> <span class="n">TyUnion</span> <span class="n">of</span> <span class="n">Map</span><span class="o">&lt;</span><span class="nb">int</span> <span class="o">*</span> <span class="n">string</span><span class="p">,</span><span class="nb">bool</span> <span class="o">*</span> <span class="n">T</span><span class="o">&gt;</span> <span class="o">*</span> <span class="n">UnionLayout</span> <span class="o">//</span> <span class="n">The</span> <span class="n">boolean</span> <span class="n">arg</span> <span class="n">determines</span> <span class="n">whether</span> <span class="n">the</span> <span class="n">union</span> <span class="n">case</span> <span class="ow">is</span> <span class="n">generalized</span><span class="o">.</span>
    <span class="o">|</span> <span class="n">TyApply</span> <span class="n">of</span> <span class="n">T</span> <span class="o">*</span> <span class="n">T</span> <span class="o">*</span> <span class="n">TT</span> <span class="o">//</span> <span class="n">Regular</span> <span class="nb">type</span> <span class="n">functions</span> <span class="p">(</span><span class="n">TyInl</span><span class="p">)</span> <span class="n">get</span> <span class="n">reduced</span><span class="p">,</span> <span class="k">while</span> <span class="n">this</span> <span class="n">represents</span> <span class="n">the</span> <span class="n">staged</span> <span class="n">reduction</span> <span class="n">of</span> <span class="n">nominals</span><span class="o">.</span>
    <span class="o">|</span> <span class="n">TyInl</span> <span class="n">of</span> <span class="n">Var</span> <span class="o">*</span> <span class="n">T</span>
    <span class="o">|</span> <span class="n">TyForall</span> <span class="n">of</span> <span class="n">Var</span> <span class="o">*</span> <span class="n">T</span>
    <span class="o">|</span> <span class="n">TyExists</span> <span class="n">of</span> <span class="n">Var</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">T</span>
    <span class="o">|</span> <span class="n">TyMetavar</span> <span class="n">of</span> <span class="n">MVar</span> <span class="o">*</span> <span class="n">T</span> <span class="n">option</span> <span class="n">ref</span>
    <span class="o">|</span> <span class="n">TyVar</span> <span class="n">of</span> <span class="n">Var</span> <span class="o">*</span> <span class="n">T</span> <span class="n">option</span> <span class="n">ref</span>
    <span class="o">|</span> <span class="n">TyMacro</span> <span class="n">of</span> <span class="n">TM</span> <span class="nb">list</span>
    <span class="o">|</span> <span class="n">TyLayout</span> <span class="n">of</span> <span class="n">T</span> <span class="o">*</span> <span class="n">Layout</span>

<span class="n">let</span> <span class="n">tyvar</span> <span class="n">x</span> <span class="o">=</span> <span class="n">TyVar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ref</span> <span class="kc">None</span><span class="p">)</span>

<span class="nb">type</span> <span class="ne">TypeError</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">KindError</span> <span class="n">of</span> <span class="n">TT</span> <span class="o">*</span> <span class="n">TT</span>
    <span class="o">|</span> <span class="n">KindErrorInConstraint</span> <span class="n">of</span> <span class="n">TT</span> <span class="o">*</span> <span class="n">TT</span>
    <span class="o">|</span> <span class="n">ExpectedSymbolAsRecordKey</span> <span class="n">of</span> <span class="n">T</span>
    <span class="o">|</span> <span class="n">ExpectedSymbolAsModuleKey</span> <span class="n">of</span> <span class="n">T</span>
    <span class="o">|</span> <span class="n">UnboundVariable</span> <span class="n">of</span> <span class="n">string</span>
    <span class="o">|</span> <span class="n">UnboundModule</span>
    <span class="o">|</span> <span class="n">ModuleIndexFailedInOpen</span>
    <span class="o">|</span> <span class="n">ModuleIndexWouldShadowLocalVars</span> <span class="n">of</span> <span class="n">string</span> <span class="p">[]</span>
    <span class="o">|</span> <span class="n">TermError</span> <span class="n">of</span> <span class="n">T</span> <span class="o">*</span> <span class="n">T</span>
    <span class="o">|</span> <span class="n">TypeVarScopeError</span> <span class="n">of</span> <span class="n">string</span> <span class="o">*</span> <span class="n">T</span> <span class="o">*</span> <span class="n">T</span>
    <span class="o">|</span> <span class="n">RecursiveMetavarsNotAllowed</span> <span class="n">of</span> <span class="n">T</span> <span class="o">*</span> <span class="n">T</span>
    <span class="o">|</span> <span class="n">RecursiveTypevarsNotAllowed</span> <span class="n">of</span> <span class="n">T</span> <span class="o">*</span> <span class="n">T</span>
    <span class="o">|</span> <span class="n">ForallVarConstraintError</span> <span class="n">of</span> <span class="n">string</span> <span class="o">*</span> <span class="n">Constraint</span> <span class="n">Set</span> <span class="o">*</span> <span class="n">Constraint</span> <span class="n">Set</span>
    <span class="o">|</span> <span class="n">MetavarsNotAllowedInRecordWith</span>
    <span class="o">|</span> <span class="n">ExpectedRecord</span> <span class="n">of</span> <span class="n">T</span>
    <span class="o">|</span> <span class="n">ExpectedExistentialInTerm</span> <span class="n">of</span> <span class="n">T</span>
    <span class="o">|</span> <span class="n">ExpectedExistentialInPattern</span> <span class="n">of</span> <span class="n">T</span>
    <span class="o">|</span> <span class="n">UnexpectedNumberOfArgumentsInExistsPattern</span> <span class="n">of</span> <span class="n">got</span><span class="p">:</span> <span class="nb">int</span> <span class="o">*</span> <span class="n">expected</span><span class="p">:</span> <span class="nb">int</span>
    <span class="o">|</span> <span class="n">UnexpectedNumberOfArgumentsInExistsBody</span> <span class="n">of</span> <span class="n">got</span><span class="p">:</span> <span class="nb">int</span> <span class="o">*</span> <span class="n">expected</span><span class="p">:</span> <span class="nb">int</span>
    <span class="o">|</span> <span class="n">ExistsShouldntHaveMetavars</span> <span class="n">of</span> <span class="n">T</span> <span class="nb">list</span>
    <span class="o">|</span> <span class="n">ExpectedRecordInsideALayout</span> <span class="n">of</span> <span class="n">T</span>
    <span class="o">|</span> <span class="n">UnionsCannotBeApplied</span>
    <span class="o">|</span> <span class="n">ExpectedNominalInApply</span> <span class="n">of</span> <span class="n">T</span>
    <span class="o">|</span> <span class="n">MalformedNominal</span>
    <span class="o">|</span> <span class="n">LayoutSetMustBeAnnotated</span>
    <span class="o">|</span> <span class="n">ExpectedMutableLayout</span> <span class="n">of</span> <span class="n">T</span>
    <span class="o">|</span> <span class="n">ExpectedRecordAsResultOfIndex</span> <span class="n">of</span> <span class="n">T</span>
    <span class="o">|</span> <span class="n">RecordIndexFailed</span> <span class="n">of</span> <span class="n">string</span>
    <span class="o">|</span> <span class="n">ModuleIndexFailed</span> <span class="n">of</span> <span class="n">string</span>
    <span class="o">|</span> <span class="n">ExpectedModule</span> <span class="n">of</span> <span class="n">T</span>
    <span class="o">|</span> <span class="n">ExpectedSymbol</span><span class="s1">' of T</span>
    <span class="o">|</span> <span class="n">ExpectedSymbolInRecordWith</span> <span class="n">of</span> <span class="n">T</span>
    <span class="o">|</span> <span class="n">RealFunctionInTopDown</span>
    <span class="o">|</span> <span class="n">ModuleMustBeImmediatelyApplied</span>
    <span class="o">|</span> <span class="n">MissingRecordFieldsInPattern</span> <span class="n">of</span> <span class="n">T</span> <span class="o">*</span> <span class="n">string</span> <span class="nb">list</span>
    <span class="o">|</span> <span class="n">CasePatternNotFoundForType</span> <span class="n">of</span> <span class="n">GlobalId</span> <span class="o">*</span> <span class="n">string</span>
    <span class="o">|</span> <span class="n">CasePatternNotFound</span> <span class="n">of</span> <span class="n">string</span>
    <span class="o">|</span> <span class="n">CannotInferCasePatternFromTermInEnv</span> <span class="n">of</span> <span class="n">T</span>
    <span class="o">|</span> <span class="n">NominalInPatternUnbox</span> <span class="n">of</span> <span class="n">GlobalId</span>
    <span class="o">|</span> <span class="n">TypeInEnvIsNotNominal</span> <span class="n">of</span> <span class="n">T</span>
    <span class="o">|</span> <span class="n">UnionInPatternNominal</span> <span class="n">of</span> <span class="n">GlobalId</span>
    <span class="o">|</span> <span class="n">ConstraintError</span> <span class="n">of</span> <span class="n">Constraint</span> <span class="o">*</span> <span class="n">T</span>
    <span class="o">|</span> <span class="n">PrototypeConstraintCannotPropagateToMetavar</span> <span class="n">of</span> <span class="n">GlobalId</span> <span class="o">*</span> <span class="n">T</span>
    <span class="o">|</span> <span class="n">PrototypeConstraintCannotPropagateToVar</span> <span class="n">of</span> <span class="n">GlobalId</span> <span class="o">*</span> <span class="n">T</span>
    <span class="o">|</span> <span class="n">ExpectedAnnotation</span>
    <span class="o">|</span> <span class="n">ExpectedSinglePattern</span>
    <span class="o">|</span> <span class="n">RecursiveAnnotationHasMetavars</span> <span class="n">of</span> <span class="n">T</span>
    <span class="o">|</span> <span class="n">ValueRestriction</span> <span class="n">of</span> <span class="n">T</span>
    <span class="o">|</span> <span class="n">DuplicateRecInlName</span>
    <span class="o">|</span> <span class="n">DuplicateKeyInRecUnion</span>
    <span class="o">|</span> <span class="n">ExpectedConstraintInsteadOfModule</span>
    <span class="o">|</span> <span class="n">InstanceNotFound</span> <span class="n">of</span> <span class="n">prototype</span><span class="p">:</span> <span class="n">GlobalId</span> <span class="o">*</span> <span class="n">instance</span><span class="p">:</span> <span class="n">GlobalId</span>
    <span class="o">|</span> <span class="n">ExpectedPrototypeConstraint</span> <span class="n">of</span> <span class="n">Constraint</span>
    <span class="o">|</span> <span class="n">ExpectedPrototypeInsteadOfModule</span>
    <span class="o">|</span> <span class="n">ExpectedHigherOrder</span> <span class="n">of</span> <span class="n">T</span>
    <span class="o">|</span> <span class="n">InstanceArityError</span> <span class="n">of</span> <span class="n">prototype_arity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">*</span> <span class="n">instance_arity</span><span class="p">:</span> <span class="nb">int</span>
    <span class="o">|</span> <span class="n">InstanceCoreVarsShouldMatchTheArityDifference</span> <span class="n">of</span> <span class="n">got</span><span class="p">:</span> <span class="nb">int</span> <span class="o">*</span> <span class="n">expected</span><span class="p">:</span> <span class="nb">int</span>
    <span class="o">|</span> <span class="n">InstanceKindError</span> <span class="n">of</span> <span class="n">TT</span> <span class="o">*</span> <span class="n">TT</span>
    <span class="o">|</span> <span class="n">KindNotAllowedInInstanceForall</span>
    <span class="o">|</span> <span class="n">InstanceVarShouldNotMatchAnyOfPrototypes</span>
    <span class="o">|</span> <span class="n">MissingBody</span>
    <span class="o">|</span> <span class="n">MacroIsMissingAnnotation</span>
    <span class="o">|</span> <span class="n">ArrayIsMissingAnnotation</span>
    <span class="o">|</span> <span class="n">ExistsIsMissingAnnotation</span>
    <span class="o">|</span> <span class="n">ShadowedForall</span>
    <span class="o">|</span> <span class="n">ShadowedExists</span>
    <span class="o">|</span> <span class="n">UnionTypesMustHaveTheSameLayout</span>
    <span class="o">|</span> <span class="n">OrphanInstance</span>
    <span class="o">|</span> <span class="n">ShadowedInstance</span>
    <span class="o">|</span> <span class="n">UnusedTypeVariable</span> <span class="n">of</span> <span class="n">string</span> <span class="nb">list</span>
    <span class="o">|</span> <span class="n">CompilerError</span> <span class="n">of</span> <span class="n">string</span>
    <span class="o">|</span> <span class="n">IncorrectGADTConstructorType</span>
    <span class="o">|</span> <span class="n">IncorrectRecursiveNominal</span>

<span class="n">let</span> <span class="n">inline</span> <span class="n">shorten</span><span class="s1">'&lt;'</span><span class="n">a</span><span class="o">&gt;</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="s1">'a) link next =</span>
    <span class="n">let</span> <span class="n">x</span><span class="s1">' : '</span><span class="n">a</span> <span class="o">=</span> <span class="nb">next</span> <span class="n">x</span>
    <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">Object</span><span class="o">.</span><span class="n">ReferenceEquals</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="s1">') = false then link.contents'</span> <span class="o">&lt;-</span> <span class="n">Some</span> <span class="n">x</span><span class="s1">'</span>
    <span class="n">x</span><span class="s1">'</span>
<span class="n">let</span> <span class="n">rec</span> <span class="n">visit_tt</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">KindMetavar</span><span class="p">({</span><span class="n">contents</span><span class="s1">'=Some x} &amp; link) -&gt; shorten'</span> <span class="n">x</span> <span class="n">link</span> <span class="n">visit_tt</span>
    <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span>

<span class="n">let</span> <span class="n">inline</span> <span class="n">shorten</span><span class="o">&lt;</span><span class="s1">'a&gt; (x : '</span><span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">link</span> <span class="p">:</span> <span class="n">ref</span><span class="o">&lt;</span><span class="n">option</span><span class="o">&lt;</span><span class="s1">'a&gt;&gt;) next =</span>
    <span class="n">let</span> <span class="n">x</span><span class="s1">' : '</span><span class="n">a</span> <span class="o">=</span> <span class="nb">next</span> <span class="n">x</span>
    <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">Object</span><span class="o">.</span><span class="n">ReferenceEquals</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="s1">') = false then link.Value &lt;- Some x'</span>
    <span class="n">x</span><span class="s1">'</span>
<span class="n">let</span> <span class="n">rec</span> <span class="n">visit_t_mvar</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">TyComment</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">visit_t_mvar</span> <span class="n">a</span>
    <span class="o">|</span> <span class="n">TyMetavar</span><span class="p">(</span><span class="n">_</span><span class="p">,{</span><span class="n">contents</span><span class="o">=</span><span class="n">Some</span> <span class="n">x</span><span class="p">}</span> <span class="o">&amp;</span> <span class="n">link</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">shorten</span> <span class="n">x</span> <span class="n">link</span> <span class="n">visit_t_mvar</span>
    <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span>

<span class="n">let</span> <span class="n">rec</span> <span class="n">visit_t</span> <span class="n">x</span> <span class="o">=</span> 
    <span class="k">match</span> <span class="n">visit_t_mvar</span> <span class="n">x</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">TyVar</span><span class="p">(</span><span class="n">_</span><span class="p">,{</span><span class="n">contents</span><span class="o">=</span><span class="n">Some</span> <span class="n">x</span><span class="p">})</span> <span class="o">-&gt;</span> <span class="n">visit_t</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span>

<span class="n">exception</span> <span class="n">InferTypeErrorException</span> <span class="n">of</span> <span class="p">(</span><span class="n">VSCRange</span> <span class="o">*</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="nb">list</span>

<span class="n">let</span> <span class="n">rec</span> <span class="n">metavars</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">RawTTypecase</span> <span class="n">_</span> <span class="o">|</span> <span class="n">RawTExists</span> <span class="n">_</span> <span class="o">|</span> <span class="n">RawTFilledNominal</span> <span class="n">_</span> <span class="o">|</span> <span class="n">RawTMacro</span> <span class="n">_</span> <span class="o">|</span> <span class="n">RawTVar</span> <span class="n">_</span> <span class="o">|</span> <span class="n">RawTTerm</span> <span class="n">_</span> 
    <span class="o">|</span> <span class="n">RawTPrim</span> <span class="n">_</span> <span class="o">|</span> <span class="n">RawTWildcard</span> <span class="n">_</span> <span class="o">|</span> <span class="n">RawTLit</span> <span class="n">_</span> <span class="o">|</span> <span class="n">RawTB</span> <span class="n">_</span> <span class="o">|</span> <span class="n">RawTSymbol</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="o">.</span><span class="n">empty</span>
    <span class="o">|</span> <span class="n">RawTMetaVar</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="o">.</span><span class="n">singleton</span> <span class="n">a</span>
    <span class="o">|</span> <span class="n">RawTArray</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">RawTLayout</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">RawTForall</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">metavars</span> <span class="n">a</span>
    <span class="o">|</span> <span class="n">RawTPair</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="n">RawTApply</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="n">RawTFun</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">metavars</span> <span class="n">a</span> <span class="o">+</span> <span class="n">metavars</span> <span class="n">b</span>
    <span class="o">|</span> <span class="n">RawTUnion</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">this</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">_</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">s</span> <span class="o">+</span> <span class="n">metavars</span> <span class="n">v</span><span class="p">)</span> <span class="p">(</span><span class="n">metavars</span> <span class="n">this</span><span class="p">)</span> <span class="n">l</span>
    <span class="o">|</span> <span class="n">RawTRecord</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">l</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">_</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">s</span> <span class="o">+</span> <span class="n">metavars</span> <span class="n">v</span><span class="p">)</span> <span class="n">Set</span><span class="o">.</span><span class="n">empty</span> <span class="n">l</span>

<span class="nb">type</span> <span class="n">TopEnv</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">nominals_next_tag</span> <span class="p">:</span> <span class="nb">int</span>
    <span class="n">nominals_aux</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">GlobalId</span><span class="p">,</span> <span class="p">{</span><span class="o">|</span><span class="n">name</span> <span class="p">:</span> <span class="n">string</span><span class="p">;</span> <span class="n">kind</span> <span class="p">:</span> <span class="n">TT</span><span class="o">|</span><span class="p">}</span><span class="o">&gt;</span>
    <span class="n">nominals</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">GlobalId</span><span class="p">,</span> <span class="p">{</span><span class="o">|</span><span class="nb">vars</span> <span class="p">:</span> <span class="n">Var</span> <span class="nb">list</span><span class="p">;</span> <span class="n">body</span> <span class="p">:</span> <span class="n">T</span><span class="o">|</span><span class="p">}</span><span class="o">&gt;</span>
    <span class="n">prototypes_next_tag</span> <span class="p">:</span> <span class="nb">int</span>
    <span class="n">prototypes_instances</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">GlobalId</span> <span class="o">*</span> <span class="n">GlobalId</span><span class="p">,</span> <span class="n">Constraint</span> <span class="n">Set</span> <span class="nb">list</span><span class="o">&gt;</span>
    <span class="n">prototypes</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">GlobalId</span><span class="p">,</span> <span class="p">{</span><span class="o">|</span><span class="n">name</span> <span class="p">:</span> <span class="n">string</span><span class="p">;</span> <span class="n">signature</span><span class="p">:</span> <span class="n">T</span><span class="p">;</span> <span class="n">kind</span> <span class="p">:</span> <span class="n">TT</span><span class="o">|</span><span class="p">}</span><span class="o">&gt;</span>
    <span class="n">ty</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="n">T</span><span class="o">&gt;</span>
    <span class="n">term</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="n">T</span><span class="o">&gt;</span>
    <span class="n">constraints</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="n">ConstraintOrModule</span><span class="o">&gt;</span>
    <span class="p">}</span>

<span class="n">let</span> <span class="n">top_env_emptyInfer</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">nominals_next_tag</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">nominals_aux</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
    <span class="n">nominals</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
    <span class="n">prototypes_next_tag</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">prototypes_instances</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
    <span class="n">prototypes</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
    <span class="n">ty</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
    <span class="n">term</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
    <span class="n">constraints</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
    <span class="p">}</span>

<span class="n">let</span> <span class="n">unionInfer</span> <span class="n">small</span> <span class="n">big</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">nominals_next_tag</span> <span class="o">=</span> <span class="nb">max</span> <span class="n">small</span><span class="o">.</span><span class="n">nominals_next_tag</span> <span class="n">big</span><span class="o">.</span><span class="n">nominals_next_tag</span>
    <span class="n">nominals_aux</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">small</span><span class="o">.</span><span class="n">nominals_aux</span> <span class="n">big</span><span class="o">.</span><span class="n">nominals_aux</span>
    <span class="n">nominals</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">small</span><span class="o">.</span><span class="n">nominals</span> <span class="n">big</span><span class="o">.</span><span class="n">nominals</span>
    <span class="n">prototypes_next_tag</span> <span class="o">=</span> <span class="nb">max</span> <span class="n">small</span><span class="o">.</span><span class="n">prototypes_next_tag</span> <span class="n">big</span><span class="o">.</span><span class="n">prototypes_next_tag</span>
    <span class="n">prototypes_instances</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">small</span><span class="o">.</span><span class="n">prototypes_instances</span> <span class="n">big</span><span class="o">.</span><span class="n">prototypes_instances</span>
    <span class="n">prototypes</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">small</span><span class="o">.</span><span class="n">prototypes</span> <span class="n">big</span><span class="o">.</span><span class="n">prototypes</span>
    <span class="n">ty</span> <span class="o">=</span>
        <span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="n">k</span> <span class="n">v</span> <span class="n">s</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">v</span> <span class="o">=</span>
                <span class="k">match</span> <span class="n">v</span><span class="p">,</span> <span class="n">s</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">k</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">TyModule</span> <span class="n">x</span><span class="p">,</span> <span class="n">Some</span> <span class="p">(</span><span class="n">TyModule</span> <span class="n">x</span><span class="s1">') -&gt; Map.foldBack Map.add x x'</span> <span class="o">|&gt;</span> <span class="n">TyModule</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">v</span>
            <span class="n">s</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">k</span> <span class="n">v</span>
        <span class="p">)</span> <span class="n">small</span><span class="o">.</span><span class="n">ty</span> <span class="n">big</span><span class="o">.</span><span class="n">ty</span>
    <span class="n">term</span> <span class="o">=</span>
        <span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="n">k</span> <span class="n">v</span> <span class="n">s</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">v</span> <span class="o">=</span>
                <span class="k">match</span> <span class="n">v</span><span class="p">,</span> <span class="n">s</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">k</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">TyModule</span> <span class="n">x</span><span class="p">,</span> <span class="n">Some</span> <span class="p">(</span><span class="n">TyModule</span> <span class="n">x</span><span class="s1">') -&gt; Map.foldBack Map.add x x'</span> <span class="o">|&gt;</span> <span class="n">TyModule</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">v</span>
            <span class="n">s</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">k</span> <span class="n">v</span>
        <span class="p">)</span> <span class="n">small</span><span class="o">.</span><span class="n">term</span> <span class="n">big</span><span class="o">.</span><span class="n">term</span>
    <span class="n">constraints</span> <span class="o">=</span>
        <span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="n">k</span> <span class="n">v</span> <span class="n">s</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">v</span> <span class="o">=</span>
                <span class="k">match</span> <span class="n">v</span><span class="p">,</span> <span class="n">s</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">k</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">M</span> <span class="n">x</span><span class="p">,</span> <span class="n">Some</span> <span class="p">(</span><span class="n">M</span> <span class="n">x</span><span class="s1">') -&gt; Map.foldBack Map.add x x'</span> <span class="o">|&gt;</span> <span class="n">M</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">v</span>
            <span class="n">s</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">k</span> <span class="n">v</span>
        <span class="p">)</span> <span class="n">small</span><span class="o">.</span><span class="n">constraints</span> <span class="n">big</span><span class="o">.</span><span class="n">constraints</span>
    <span class="p">}</span>


<span class="n">let</span> <span class="n">in_moduleInfer</span> <span class="n">m</span> <span class="n">a</span> <span class="p">:</span> <span class="n">TopEnv</span> <span class="o">=</span>
    <span class="p">{</span><span class="n">a</span> <span class="k">with</span>
        <span class="n">ty</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">m</span> <span class="p">(</span><span class="n">TyModule</span> <span class="n">a</span><span class="o">.</span><span class="n">ty</span><span class="p">)</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
        <span class="n">term</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">m</span> <span class="p">(</span><span class="n">TyModule</span> <span class="n">a</span><span class="o">.</span><span class="n">term</span><span class="p">)</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">m</span> <span class="p">(</span><span class="n">M</span> <span class="n">a</span><span class="o">.</span><span class="n">constraints</span><span class="p">)</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
        <span class="p">}</span>

<span class="nb">type</span> <span class="n">Env_</span> <span class="o">=</span> <span class="p">{</span> <span class="n">ty</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="n">T</span><span class="o">&gt;</span><span class="p">;</span> <span class="n">term</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="n">T</span><span class="o">&gt;</span><span class="p">;</span> <span class="n">constraints</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="n">ConstraintOrModule</span><span class="o">&gt;</span> <span class="p">}</span>
<span class="nb">type</span> <span class="n">InferEnv</span> <span class="o">=</span> <span class="n">Env_</span>

<span class="n">let</span> <span class="n">kind_get</span> <span class="n">x</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="o">=</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">KindFun</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="p">::</span> <span class="n">loop</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="n">a</span><span class="p">]</span>
    <span class="n">let</span> <span class="n">l</span> <span class="o">=</span> <span class="n">loop</span> <span class="n">x</span>
    <span class="p">{</span><span class="o">|</span><span class="n">arity</span><span class="o">=</span><span class="n">List</span><span class="o">.</span><span class="n">length</span> <span class="n">l</span><span class="p">;</span> <span class="n">args</span><span class="o">=</span><span class="n">l</span><span class="o">|</span><span class="p">}</span>

<span class="n">let</span> <span class="n">prototype_init_forall_kind</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">TyForall</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">kind</span>
    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: The prototype should have at least one forall."</span>

<span class="n">let</span> <span class="n">show_primt</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">UInt8T</span> <span class="o">-&gt;</span> <span class="s2">"u8"</span>
    <span class="o">|</span> <span class="n">UInt16T</span> <span class="o">-&gt;</span> <span class="s2">"u16"</span>
    <span class="o">|</span> <span class="n">UInt32T</span> <span class="o">-&gt;</span> <span class="s2">"u32"</span>
    <span class="o">|</span> <span class="n">UInt64T</span> <span class="o">-&gt;</span> <span class="s2">"u64"</span>
    <span class="o">|</span> <span class="n">Int8T</span> <span class="o">-&gt;</span> <span class="s2">"i8"</span>
    <span class="o">|</span> <span class="n">Int16T</span> <span class="o">-&gt;</span> <span class="s2">"i16"</span>
    <span class="o">|</span> <span class="n">Int32T</span> <span class="o">-&gt;</span> <span class="s2">"i32"</span>
    <span class="o">|</span> <span class="n">Int64T</span> <span class="o">-&gt;</span> <span class="s2">"i64"</span>
    <span class="o">|</span> <span class="n">Float32T</span> <span class="o">-&gt;</span> <span class="s2">"f32"</span>
    <span class="o">|</span> <span class="n">Float64T</span> <span class="o">-&gt;</span> <span class="s2">"f64"</span>
    <span class="o">|</span> <span class="n">BoolT</span> <span class="o">-&gt;</span> <span class="s2">"bool"</span>
    <span class="o">|</span> <span class="n">StringT</span> <span class="o">-&gt;</span> <span class="s2">"string"</span>
    <span class="o">|</span> <span class="n">CharT</span> <span class="o">-&gt;</span> <span class="s2">"char"</span>

<span class="n">let</span> <span class="n">rec</span> <span class="n">constraint_name</span> <span class="p">(</span><span class="n">env</span> <span class="p">:</span> <span class="n">TopEnv</span><span class="p">)</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">CSInt</span> <span class="o">-&gt;</span> <span class="s2">"sint"</span> <span class="o">|</span> <span class="n">CUInt</span> <span class="o">-&gt;</span> <span class="s2">"uint"</span> <span class="o">|</span> <span class="n">CInt</span> <span class="o">-&gt;</span> <span class="s2">"int"</span>
    <span class="o">|</span> <span class="n">CFloat</span> <span class="o">-&gt;</span> <span class="s2">"float"</span> <span class="o">|</span> <span class="n">CNumber</span> <span class="o">-&gt;</span> <span class="s2">"number"</span> <span class="o">|</span> <span class="n">CPrim</span> <span class="o">-&gt;</span> <span class="s2">"prim"</span>
    <span class="o">|</span> <span class="n">CSymbol</span> <span class="o">-&gt;</span> <span class="s2">"symbol"</span> <span class="o">|</span> <span class="n">CRecord</span> <span class="o">-&gt;</span> <span class="s2">"record"</span>
    <span class="o">|</span> <span class="n">CPrototype</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">env</span><span class="o">.</span><span class="n">prototypes</span><span class="o">.</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>

<span class="n">let</span> <span class="n">constraint_kind</span> <span class="p">(</span><span class="n">env</span> <span class="p">:</span> <span class="n">TopEnv</span><span class="p">)</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">CSInt</span> <span class="o">|</span> <span class="n">CUInt</span> <span class="o">|</span> <span class="n">CInt</span> <span class="o">|</span> <span class="n">CFloat</span> <span class="o">|</span> <span class="n">CNumber</span> <span class="o">|</span> <span class="n">CPrim</span> <span class="o">|</span> <span class="n">CSymbol</span> <span class="o">|</span> <span class="n">CRecord</span> <span class="o">-&gt;</span> <span class="n">KindType</span>
    <span class="o">|</span> <span class="n">CPrototype</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">env</span><span class="o">.</span><span class="n">prototypes</span><span class="o">.</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">kind</span>

<span class="n">let</span> <span class="n">rec</span> <span class="n">tt</span> <span class="p">(</span><span class="n">env</span> <span class="p">:</span> <span class="n">TopEnv</span><span class="p">)</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">TyComment</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyMetavar</span><span class="p">(</span><span class="n">_</span><span class="p">,{</span><span class="n">contents</span><span class="o">=</span><span class="n">Some</span> <span class="n">x</span><span class="p">})</span> <span class="o">-&gt;</span> <span class="n">tt</span> <span class="n">env</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">TyNominal</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">env</span><span class="o">.</span><span class="n">nominals_aux</span><span class="o">.</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">kind</span>
    <span class="o">|</span> <span class="n">TyApply</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyMetavar</span><span class="p">({</span><span class="n">kind</span><span class="o">=</span><span class="n">x</span><span class="p">},</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyVar</span><span class="p">({</span><span class="n">kind</span><span class="o">=</span><span class="n">x</span><span class="p">},</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">TyExists</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyLit</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyUnion</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyLayout</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyMacro</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyB</span> <span class="o">|</span> <span class="n">TyPrim</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyForall</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyFun</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyRecord</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyModule</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyPair</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TySymbol</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyArray</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">KindType</span>
    <span class="o">|</span> <span class="n">TyInl</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KindFun</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span><span class="n">tt</span> <span class="n">env</span> <span class="n">a</span><span class="p">)</span>

<span class="n">let</span> <span class="n">rec</span> <span class="n">has_metavars</span> <span class="n">x</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">f</span> <span class="o">=</span> <span class="n">has_metavars</span>
    <span class="k">match</span> <span class="n">visit_t</span> <span class="n">x</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">TyMetavar</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">true</span>
    <span class="o">|</span> <span class="n">TyVar</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyNominal</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyB</span> <span class="o">|</span> <span class="n">TyLit</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyPrim</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TySymbol</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyModule</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">false</span>
    <span class="o">|</span> <span class="n">TyExists</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyComment</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyLayout</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyForall</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyInl</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyArray</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span>
    <span class="o">|</span> <span class="n">TyApply</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyFun</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyPair</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span> <span class="o">||</span> <span class="n">f</span> <span class="n">b</span>
    <span class="o">|</span> <span class="n">TyUnion</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">exists</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">snd</span> <span class="o">&gt;&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="n">l</span>
    <span class="o">|</span> <span class="n">TyRecord</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">exists</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="n">l</span>
    <span class="o">|</span> <span class="n">TyMacro</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">exists</span> <span class="p">(</span><span class="n">function</span> <span class="n">TMVar</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">has_metavars</span> <span class="n">x</span> <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">false</span><span class="p">)</span> <span class="n">a</span>

<span class="o">//</span> <span class="n">Eliminates</span> <span class="n">the</span> <span class="n">metavars</span> <span class="ow">in</span> <span class="n">the</span> <span class="nb">type</span> <span class="k">if</span> <span class="n">possible</span><span class="o">.</span>
<span class="n">let</span> <span class="n">term_subst</span> <span class="n">a</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">h</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">Generic</span><span class="o">.</span><span class="n">HashSet</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Reference</span><span class="p">)</span>
    <span class="o">//</span> <span class="s1">'a = '</span><span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'c = int * '</span><span class="n">d</span> <span class="o">=</span> <span class="nb">float</span><span class="p">)</span>
    <span class="o">//</span> <span class="n">visit_t</span> <span class="n">shortens</span> <span class="n">to</span><span class="p">:</span>
    <span class="o">//</span> <span class="s1">'a = ('</span><span class="n">c</span> <span class="o">=</span> <span class="nb">int</span> <span class="o">*</span> <span class="s1">'d = float)</span>
    <span class="o">//</span> <span class="n">visit_t</span> <span class="n">returns</span><span class="p">:</span>
    <span class="o">//</span> <span class="p">(</span><span class="s1">'c = int * '</span><span class="n">d</span> <span class="o">=</span> <span class="nb">float</span><span class="p">)</span>
    <span class="o">//</span> <span class="n">term_subst</span> <span class="n">returns</span><span class="p">:</span>
    <span class="o">//</span> <span class="nb">int</span> <span class="o">*</span> <span class="nb">float</span>
    <span class="n">let</span> <span class="n">inline</span> <span class="n">g</span> <span class="n">a</span> <span class="n">f</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">_</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">f</span><span class="p">()</span>
        <span class="n">let</span> <span class="n">_</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">x</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">f</span> <span class="n">a</span> <span class="o">=</span>
        <span class="k">match</span> <span class="n">visit_t</span> <span class="n">a</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">TyMetavar</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyNominal</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyB</span> <span class="o">|</span> <span class="n">TyLit</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyPrim</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TySymbol</span> <span class="n">_</span> <span class="k">as</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">TyVar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">r</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TyVar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">Contains</span> <span class="n">x</span> <span class="n">then</span> <span class="n">ref</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">r</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TyComment</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TyComment</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TyPair</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TyPair</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span> <span class="n">f</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TyRecord</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">TyRecord</span><span class="p">(</span><span class="n">Map</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TyModule</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">TyModule</span><span class="p">(</span><span class="n">Map</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TyUnion</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TyUnion</span><span class="p">(</span><span class="n">Map</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="p">(</span><span class="n">is_gadt</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">is_gadt</span><span class="p">,</span> <span class="n">f</span> <span class="n">x</span><span class="p">)</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TyFun</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TyFun</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span> <span class="n">f</span> <span class="n">b</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TyForall</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">g</span> <span class="n">a</span> <span class="o">&lt;|</span> <span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="n">TyForall</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TyExists</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TyExists</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TyArray</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">TyArray</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TyApply</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TyApply</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span> <span class="n">f</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TyInl</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">g</span> <span class="n">a</span> <span class="o">&lt;|</span> <span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="n">TyInl</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TyMacro</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">TyMacro</span><span class="p">(</span><span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">function</span> <span class="n">TMVar</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">TMVar</span><span class="p">(</span><span class="n">f</span> <span class="n">x</span><span class="p">)</span> <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="p">)</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TyLayout</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TyLayout</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
    <span class="n">f</span> <span class="n">a</span>

<span class="nb">type</span> <span class="n">HoverTypes</span><span class="p">()</span> <span class="o">=</span>
    <span class="o">//</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">to</span> <span class="n">allocate</span> <span class="n">less</span> <span class="n">trash</span> <span class="k">for</span> <span class="n">code</span> <span class="n">that</span> <span class="n">doesn</span><span class="s1">'t use GADTs. </span>
    <span class="o">//</span> <span class="n">Unfortunately</span><span class="p">,</span> <span class="n">we</span> <span class="n">cannot</span> <span class="n">use</span> <span class="n">memoization</span> <span class="n">instead</span> <span class="k">as</span> <span class="n">term_subst</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">functionally</span> <span class="n">pure</span><span class="o">.</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">has_substituted_tvars</span> <span class="n">x</span> <span class="o">=</span> 
        <span class="n">let</span> <span class="n">f</span> <span class="o">=</span> <span class="n">has_substituted_tvars</span>
        <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">TyMetavar</span><span class="p">(</span><span class="n">_</span><span class="p">,{</span><span class="n">contents</span><span class="o">=</span><span class="n">Some</span> <span class="n">_</span><span class="p">})</span> <span class="o">-&gt;</span> <span class="n">true</span>
        <span class="o">|</span> <span class="n">TyVar</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="p">{</span><span class="n">contents</span><span class="o">=</span><span class="n">Some</span> <span class="n">x</span><span class="p">})</span> <span class="o">|</span> <span class="n">TyComment</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">TyVar</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyMetavar</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyNominal</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyB</span> <span class="o">|</span> <span class="n">TyLit</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyPrim</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TySymbol</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyModule</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">false</span>
        <span class="o">|</span> <span class="n">TyExists</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyComment</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyLayout</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyForall</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyInl</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyArray</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">TyApply</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyFun</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyPair</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span> <span class="o">||</span> <span class="n">f</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">TyUnion</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">exists</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">snd</span> <span class="o">&gt;&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="n">l</span>
        <span class="o">|</span> <span class="n">TyRecord</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">exists</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="n">l</span>
        <span class="o">|</span> <span class="n">TyMacro</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">exists</span> <span class="p">(</span><span class="n">function</span> <span class="n">TMVar</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">has_metavars</span> <span class="n">x</span> <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">false</span><span class="p">)</span> <span class="n">a</span>
    <span class="n">let</span> <span class="n">hover_types</span> <span class="o">=</span> <span class="n">ResizeArray</span><span class="p">()</span>
    <span class="n">member</span> <span class="n">_</span><span class="o">.</span><span class="n">AddHover</span><span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">x</span><span class="p">,</span><span class="n">com</span><span class="p">))</span> <span class="o">=</span> <span class="n">hover_types</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,((</span><span class="k">if</span> <span class="n">has_substituted_tvars</span> <span class="n">x</span> <span class="n">then</span> <span class="n">term_subst</span> <span class="n">x</span> <span class="k">else</span> <span class="n">x</span><span class="p">),</span> <span class="n">com</span><span class="p">))</span>
    <span class="n">member</span> <span class="n">_</span><span class="o">.</span><span class="n">ToArray</span><span class="p">()</span> <span class="o">=</span> <span class="n">hover_types</span><span class="o">.</span><span class="n">ToArray</span><span class="p">()</span>

<span class="n">let</span> <span class="n">module_openInfer</span> <span class="p">(</span><span class="n">hover_types</span> <span class="p">:</span> <span class="n">HoverTypes</span> <span class="n">option</span><span class="p">)</span> <span class="p">(</span><span class="n">top_env</span> <span class="p">:</span> <span class="n">InferEnv</span><span class="p">)</span> <span class="p">(</span><span class="n">local_env_ty</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="n">T</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">(</span><span class="n">r</span> <span class="p">:</span> <span class="n">VSCRange</span><span class="p">)</span> <span class="n">b</span> <span class="n">l</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">tryFind</span> <span class="n">env</span> <span class="n">x</span> <span class="o">=</span>
        <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">x</span> <span class="n">env</span><span class="o">.</span><span class="n">term</span><span class="p">,</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">x</span> <span class="n">env</span><span class="o">.</span><span class="n">ty</span><span class="p">,</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">x</span> <span class="n">env</span><span class="o">.</span><span class="n">constraints</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">Some</span> <span class="p">(</span><span class="n">TyModule</span> <span class="n">a</span><span class="p">),</span> <span class="n">Some</span> <span class="p">(</span><span class="n">TyModule</span> <span class="n">b</span><span class="p">),</span> <span class="n">Some</span> <span class="p">(</span><span class="n">M</span> <span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ValueSome</span> <span class="p">{</span><span class="n">term</span><span class="o">=</span><span class="n">a</span><span class="p">;</span> <span class="n">ty</span><span class="o">=</span><span class="n">b</span><span class="p">;</span> <span class="n">constraints</span><span class="o">=</span><span class="n">c</span><span class="p">}</span>
        <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">ValueNone</span>
    <span class="k">match</span> <span class="n">tryFind</span> <span class="n">top_env</span> <span class="n">b</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">ValueNone</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">UnboundModule</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">ValueSome</span> <span class="n">env</span> <span class="o">-&gt;</span>
        <span class="n">hover_types</span> <span class="o">|&gt;</span> <span class="n">Option</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">hover_types</span> <span class="o">-&gt;</span> <span class="n">hover_types</span><span class="o">.</span><span class="n">AddHover</span><span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">TyModule</span> <span class="n">env</span><span class="o">.</span><span class="n">term</span><span class="p">,</span><span class="s2">""</span><span class="p">)))</span>
        <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="n">env</span> <span class="o">=</span> <span class="n">function</span>
            <span class="o">|</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="p">::</span> <span class="n">x</span><span class="s1">' -&gt;</span>
                <span class="k">match</span> <span class="n">tryFind</span> <span class="n">env</span> <span class="n">x</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">ValueSome</span> <span class="n">env</span> <span class="o">-&gt;</span>
                    <span class="n">hover_types</span> <span class="o">|&gt;</span> <span class="n">Option</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">hover_types</span> <span class="o">-&gt;</span> <span class="n">hover_types</span><span class="o">.</span><span class="n">AddHover</span><span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">TyModule</span> <span class="n">env</span><span class="o">.</span><span class="n">term</span><span class="p">,</span><span class="s2">""</span><span class="p">)))</span>
                    <span class="n">loop</span> <span class="n">env</span> <span class="n">x</span><span class="s1">'</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ModuleIndexFailedInOpen</span><span class="p">)</span>
            <span class="o">|</span> <span class="p">[]</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span> <span class="n">env</span>
        <span class="n">loop</span> <span class="n">env</span> <span class="n">l</span> <span class="o">|&gt;</span> <span class="n">Result</span><span class="o">.</span><span class="n">bind</span> <span class="p">(</span><span class="n">fun</span> <span class="n">env</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">h</span> <span class="o">=</span> <span class="n">ResizeArray</span><span class="p">()</span>
            <span class="n">local_env_ty</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">k</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="n">ContainsKey</span> <span class="n">k</span> <span class="n">then</span> <span class="n">h</span><span class="o">.</span><span class="n">Add</span> <span class="n">k</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">Count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">then</span> <span class="n">Result</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ModuleIndexWouldShadowLocalVars</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">ToArray</span><span class="p">()))</span>
            <span class="k">else</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span> <span class="n">env</span>
            <span class="p">)</span>


<span class="n">let</span> <span class="n">validate_bound_vars</span> <span class="p">(</span><span class="n">top_env</span> <span class="p">:</span> <span class="n">InferEnv</span><span class="p">)</span> <span class="n">constraints</span> <span class="n">term</span> <span class="n">ty</span> <span class="n">x</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">ResizeArray</span><span class="p">()</span>
    <span class="n">let</span> <span class="n">check_term</span> <span class="n">term</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">=</span> <span class="k">if</span> <span class="n">Set</span><span class="o">.</span><span class="n">contains</span> <span class="n">b</span> <span class="n">term</span> <span class="o">=</span> <span class="n">false</span> <span class="o">&amp;&amp;</span> <span class="n">Map</span><span class="o">.</span><span class="n">containsKey</span> <span class="n">b</span> <span class="n">top_env</span><span class="o">.</span><span class="n">term</span> <span class="o">=</span> <span class="n">false</span> <span class="n">then</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">UnboundVariable</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">check_ty</span> <span class="n">ty</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">=</span> <span class="k">if</span> <span class="n">Set</span><span class="o">.</span><span class="n">contains</span> <span class="n">b</span> <span class="n">ty</span> <span class="o">=</span> <span class="n">false</span> <span class="o">&amp;&amp;</span> <span class="n">Map</span><span class="o">.</span><span class="n">containsKey</span> <span class="n">b</span> <span class="n">top_env</span><span class="o">.</span><span class="n">ty</span> <span class="o">=</span> <span class="n">false</span> <span class="n">then</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">UnboundVariable</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">check_cons</span> <span class="n">constraints</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">=</span>
        <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">b</span> <span class="n">constraints</span> <span class="o">|&gt;</span> <span class="n">Option</span><span class="o">.</span><span class="n">orElseWith</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">b</span> <span class="n">top_env</span><span class="o">.</span><span class="n">constraints</span><span class="p">)</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">Some</span> <span class="p">(</span><span class="n">C</span> <span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">()</span>
        <span class="o">|</span> <span class="n">Some</span> <span class="p">(</span><span class="n">M</span> <span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">ExpectedConstraintInsteadOfModule</span><span class="p">)</span>
        <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">UnboundVariable</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">cterm</span> <span class="n">constraints</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">ty</span><span class="p">)</span> <span class="n">x</span> <span class="o">=</span>
        <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">RawSymbol</span> <span class="n">_</span> <span class="o">|</span> <span class="n">RawDefaultLit</span> <span class="n">_</span> <span class="o">|</span> <span class="n">RawLit</span> <span class="n">_</span> <span class="o">|</span> <span class="n">RawB</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="p">()</span>
        <span class="o">|</span> <span class="n">RawV</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">check_term</span> <span class="n">term</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawType</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ctype</span> <span class="n">constraints</span> <span class="n">term</span> <span class="n">ty</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">RawMatch</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">body</span><span class="p">,</span><span class="n">l</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cterm</span> <span class="n">constraints</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">ty</span><span class="p">)</span> <span class="n">body</span><span class="p">;</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cterm</span> <span class="n">constraints</span> <span class="p">(</span><span class="n">cpattern</span> <span class="n">constraints</span> <span class="n">term</span> <span class="n">ty</span> <span class="n">a</span><span class="p">)</span> <span class="n">b</span><span class="p">)</span> <span class="n">l</span>
        <span class="o">|</span> <span class="n">RawFun</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">l</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cterm</span> <span class="n">constraints</span> <span class="p">(</span><span class="n">cpattern</span> <span class="n">constraints</span> <span class="n">term</span> <span class="n">ty</span> <span class="n">a</span><span class="p">)</span> <span class="n">b</span><span class="p">)</span> <span class="n">l</span>
        <span class="o">|</span> <span class="n">RawForall</span><span class="p">(</span><span class="n">_</span><span class="p">,((</span><span class="n">_</span><span class="p">,(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)),</span><span class="n">l</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">check_cons</span> <span class="n">constraints</span><span class="p">)</span> <span class="n">l</span><span class="p">;</span> <span class="n">cterm</span> <span class="n">constraints</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">Set</span><span class="o">.</span><span class="n">add</span> <span class="n">a</span> <span class="n">ty</span><span class="p">)</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">RawFilledForall</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: Should not appear during variable validation."</span>
        <span class="o">|</span> <span class="n">RawRecBlock</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">on_succ</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">term</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="p">((</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">),</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="o">.</span><span class="n">add</span> <span class="n">x</span> <span class="n">s</span><span class="p">)</span> <span class="n">term</span> <span class="n">l</span>
            <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cterm</span> <span class="n">constraints</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">ty</span><span class="p">)</span> <span class="n">x</span><span class="p">)</span> <span class="n">l</span>
            <span class="n">cterm</span> <span class="n">constraints</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">ty</span><span class="p">)</span> <span class="n">on_succ</span>
        <span class="o">|</span> <span class="n">RawRecordWith</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">cterm</span> <span class="n">constraints</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">ty</span><span class="p">))</span> <span class="n">a</span>
            <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">function</span>
                <span class="o">|</span> <span class="n">RawRecordWithSymbol</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">e</span><span class="p">)</span> <span class="o">|</span> <span class="n">RawRecordWithSymbolModify</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">e</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cterm</span> <span class="n">constraints</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">ty</span><span class="p">)</span> <span class="n">e</span>
                <span class="o">|</span> <span class="n">RawRecordWithInjectVar</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">e</span><span class="p">)</span> <span class="o">|</span> <span class="n">RawRecordWithInjectVarModify</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">e</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">check_term</span> <span class="n">term</span> <span class="n">v</span><span class="p">;</span> <span class="n">cterm</span> <span class="n">constraints</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">ty</span><span class="p">)</span> <span class="n">e</span>
                <span class="p">)</span> <span class="n">b</span>
            <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">function</span> <span class="n">RawRecordWithoutSymbol</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="p">()</span> <span class="o">|</span> <span class="n">RawRecordWithoutInjectVar</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">check_term</span> <span class="n">term</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span> <span class="n">c</span>
        <span class="o">|</span> <span class="n">RawOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">l</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">cterm</span> <span class="n">constraints</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">ty</span><span class="p">))</span> <span class="n">l</span>
        <span class="o">|</span> <span class="n">RawReal</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">|</span> <span class="n">RawJoinPoint</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cterm</span> <span class="n">constraints</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">ty</span><span class="p">)</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">RawExists</span><span class="p">(</span><span class="n">_</span><span class="p">,(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Option</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">ctype</span> <span class="n">constraints</span> <span class="n">term</span> <span class="n">ty</span><span class="p">))</span> <span class="n">a</span><span class="p">;</span> <span class="n">cterm</span> <span class="n">constraints</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">ty</span><span class="p">)</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">RawAnnot</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">RawMacro</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cmacro</span> <span class="n">constraints</span> <span class="n">term</span> <span class="n">ty</span> <span class="n">a</span><span class="p">;</span> <span class="n">ctype</span> <span class="n">constraints</span> <span class="n">term</span> <span class="n">ty</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">RawMacro</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">MacroIsMissingAnnotation</span><span class="p">);</span> <span class="n">cmacro</span> <span class="n">constraints</span> <span class="n">term</span> <span class="n">ty</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">RawAnnot</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">RawArray</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">cterm</span> <span class="n">constraints</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">ty</span><span class="p">))</span> <span class="n">a</span><span class="p">;</span> <span class="n">ctype</span> <span class="n">constraints</span> <span class="n">term</span> <span class="n">ty</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">RawArray</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">ArrayIsMissingAnnotation</span><span class="p">);</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">cterm</span> <span class="n">constraints</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">ty</span><span class="p">))</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">RawAnnot</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cterm</span> <span class="n">constraints</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">ty</span><span class="p">)</span> <span class="n">a</span><span class="p">;</span> <span class="n">ctype</span> <span class="n">constraints</span> <span class="n">term</span> <span class="n">ty</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">RawTypecase</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">ctype</span> <span class="n">constraints</span> <span class="n">term</span> <span class="n">ty</span> <span class="n">a</span>
            <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">ctype</span> <span class="n">constraints</span> <span class="n">term</span> <span class="n">ty</span> <span class="n">a</span>
                <span class="n">cterm</span> <span class="n">constraints</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">ty</span> <span class="o">+</span> <span class="n">metavars</span> <span class="n">a</span><span class="p">)</span> <span class="n">b</span>
                <span class="p">)</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">RawOpen</span><span class="p">(</span><span class="n">_</span><span class="p">,(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">),</span><span class="n">l</span><span class="p">,</span><span class="n">on_succ</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">module_openInfer</span> <span class="kc">None</span> <span class="n">top_env</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span> <span class="n">a</span> <span class="n">b</span> <span class="n">l</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span> <span class="n">x</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">combine</span> <span class="n">e</span> <span class="n">m</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">k</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="o">.</span><span class="n">add</span> <span class="n">k</span> <span class="n">s</span><span class="p">)</span> <span class="n">e</span> <span class="n">m</span>
                <span class="n">cterm</span> <span class="p">(</span><span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">x</span><span class="o">.</span><span class="n">constraints</span> <span class="n">constraints</span><span class="p">)</span> <span class="p">(</span><span class="n">combine</span> <span class="n">term</span> <span class="n">x</span><span class="o">.</span><span class="n">term</span><span class="p">,</span> <span class="n">combine</span> <span class="n">ty</span> <span class="n">x</span><span class="o">.</span><span class="n">ty</span><span class="p">)</span> <span class="n">on_succ</span>
            <span class="o">|</span> <span class="n">Result</span><span class="o">.</span><span class="n">Error</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawHeapMutableSet</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cterm</span> <span class="n">constraints</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">ty</span><span class="p">)</span> <span class="n">a</span><span class="p">;</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">cterm</span> <span class="n">constraints</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">ty</span><span class="p">))</span> <span class="n">b</span><span class="p">;</span> <span class="n">cterm</span> <span class="n">constraints</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">ty</span><span class="p">)</span> <span class="n">c</span>
        <span class="o">|</span> <span class="n">RawSeq</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="n">RawPair</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="n">RawIfThen</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="n">RawApply</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cterm</span> <span class="n">constraints</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">ty</span><span class="p">)</span> <span class="n">a</span><span class="p">;</span> <span class="n">cterm</span> <span class="n">constraints</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">ty</span><span class="p">)</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">RawIfThenElse</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cterm</span> <span class="n">constraints</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">ty</span><span class="p">)</span> <span class="n">a</span><span class="p">;</span> <span class="n">cterm</span> <span class="n">constraints</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">ty</span><span class="p">)</span> <span class="n">b</span><span class="p">;</span> <span class="n">cterm</span> <span class="n">constraints</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">ty</span><span class="p">)</span> <span class="n">c</span>
        <span class="o">|</span> <span class="n">RawMissingBody</span> <span class="n">r</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">MissingBody</span><span class="p">)</span>
    <span class="ow">and</span> <span class="n">cmacro</span> <span class="n">constraints</span> <span class="n">term</span> <span class="n">ty</span> <span class="n">a</span> <span class="o">=</span>
        <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">function</span>
            <span class="o">|</span> <span class="n">RawMacroText</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="p">()</span>
            <span class="o">|</span> <span class="n">RawMacroTerm</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cterm</span> <span class="n">constraints</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">ty</span><span class="p">)</span> <span class="n">a</span>
            <span class="o">|</span> <span class="n">RawMacroType</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">RawMacroTypeLit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ctype</span> <span class="n">constraints</span> <span class="n">term</span> <span class="n">ty</span> <span class="n">a</span>
            <span class="p">)</span> <span class="n">a</span>
    <span class="ow">and</span> <span class="n">ctype</span> <span class="n">constraints</span> <span class="n">term</span> <span class="n">ty</span> <span class="n">x</span> <span class="o">=</span>
        <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">RawTFilledNominal</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">RawTPrim</span> <span class="n">_</span> <span class="o">|</span> <span class="n">RawTWildcard</span> <span class="n">_</span> <span class="o">|</span> <span class="n">RawTLit</span> <span class="n">_</span> <span class="o">|</span> <span class="n">RawTB</span> <span class="n">_</span> <span class="o">|</span> <span class="n">RawTSymbol</span> <span class="n">_</span> <span class="o">|</span> <span class="n">RawTMetaVar</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="p">()</span>
        <span class="o">|</span> <span class="n">RawTTypecase</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> 
            <span class="n">ctype</span> <span class="n">constraints</span> <span class="n">term</span> <span class="n">ty</span> <span class="n">a</span>
            <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> 
                <span class="n">ctype</span> <span class="n">constraints</span> <span class="n">term</span> <span class="n">ty</span> <span class="n">a</span>
                <span class="n">ctype</span> <span class="n">constraints</span> <span class="n">term</span> <span class="p">(</span><span class="n">ty</span> <span class="o">+</span> <span class="n">metavars</span> <span class="n">a</span><span class="p">)</span> <span class="n">b</span>
                <span class="p">)</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">RawTVar</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">check_ty</span> <span class="n">ty</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawTArray</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">RawTLayout</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ctype</span> <span class="n">constraints</span> <span class="n">term</span> <span class="n">ty</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">RawTPair</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="n">RawTApply</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="n">RawTFun</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ctype</span> <span class="n">constraints</span> <span class="n">term</span> <span class="n">ty</span> <span class="n">a</span><span class="p">;</span> <span class="n">ctype</span> <span class="n">constraints</span> <span class="n">term</span> <span class="n">ty</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">RawTUnion</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">this</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ctype</span> <span class="n">constraints</span> <span class="n">term</span> <span class="n">ty</span> <span class="n">x</span><span class="p">)</span> <span class="n">l</span><span class="p">;</span> <span class="n">ctype</span> <span class="n">constraints</span> <span class="n">term</span> <span class="n">ty</span> <span class="n">this</span>
        <span class="o">|</span> <span class="n">RawTRecord</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">l</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">ctype</span> <span class="n">constraints</span> <span class="n">term</span> <span class="n">ty</span><span class="p">)</span> <span class="n">l</span>
        <span class="o">|</span> <span class="n">RawTForall</span><span class="p">(</span><span class="n">_</span><span class="p">,((</span><span class="n">_</span><span class="p">,(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)),</span><span class="n">l</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">check_cons</span> <span class="n">constraints</span><span class="p">)</span> <span class="n">l</span><span class="p">;</span> <span class="n">ctype</span> <span class="n">constraints</span> <span class="n">term</span> <span class="p">(</span><span class="n">Set</span><span class="o">.</span><span class="n">add</span> <span class="n">a</span> <span class="n">ty</span><span class="p">)</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">RawTExists</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> 
            <span class="n">let</span> <span class="n">ty</span> <span class="o">=</span>
                <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">ty</span> <span class="p">((</span><span class="n">_</span><span class="p">,(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)),</span><span class="n">l</span><span class="p">)</span> <span class="o">-&gt;</span>
                    <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">check_cons</span> <span class="n">constraints</span><span class="p">)</span> <span class="n">l</span>
                    <span class="n">Set</span><span class="o">.</span><span class="n">add</span> <span class="n">a</span> <span class="n">ty</span>
                    <span class="p">)</span> <span class="n">ty</span> <span class="n">a</span>
            <span class="n">ctype</span> <span class="n">constraints</span> <span class="n">term</span> <span class="n">ty</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">RawTTerm</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cterm</span> <span class="n">constraints</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">ty</span><span class="p">)</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">RawTMacro</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cmacro</span> <span class="n">constraints</span> <span class="n">term</span> <span class="n">ty</span> <span class="n">a</span>
    <span class="ow">and</span> <span class="n">cpattern</span> <span class="n">constraints</span> <span class="n">term</span> <span class="n">ty</span> <span class="n">x</span> <span class="o">=</span>
        <span class="o">//</span><span class="n">let</span> <span class="n">is_first</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">Generic</span><span class="o">.</span><span class="n">HashSet</span><span class="p">()</span>
        <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">ty</span><span class="p">)</span> <span class="n">x</span> <span class="o">=</span> 
            <span class="n">let</span> <span class="n">f</span> <span class="o">=</span> <span class="n">loop</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">ty</span><span class="p">)</span>
            <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">PatDefaultValue</span> <span class="n">_</span> <span class="o">|</span> <span class="n">PatFilledDefaultValue</span> <span class="n">_</span> <span class="o">|</span> <span class="n">PatValue</span> <span class="n">_</span> <span class="o">|</span> <span class="n">PatSymbol</span> <span class="n">_</span> <span class="o">|</span> <span class="n">PatB</span> <span class="n">_</span> <span class="o">|</span> <span class="n">PatE</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">term</span><span class="p">,</span> <span class="n">ty</span>
            <span class="o">|</span> <span class="n">PatExists</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">ty</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="o">.</span><span class="n">add</span> <span class="n">x</span> <span class="n">s</span><span class="p">)</span> <span class="n">ty</span> <span class="n">a</span>
                <span class="n">loop</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">ty</span><span class="p">)</span> <span class="n">b</span>
            <span class="o">|</span> <span class="n">PatVar</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="o">//</span><span class="k">if</span> <span class="n">is_first</span><span class="o">.</span><span class="n">Add</span> <span class="n">b</span> <span class="n">then</span> <span class="p">()</span> <span class="o">//</span> <span class="n">TODO</span><span class="p">:</span> <span class="n">I</span> <span class="n">am</span> <span class="n">doing</span> <span class="n">it</span> <span class="n">like</span> <span class="n">this</span> <span class="n">so</span> <span class="n">I</span> <span class="n">can</span> <span class="n">reuse</span> <span class="n">this</span> <span class="n">code</span> <span class="n">later</span> <span class="k">for</span> <span class="n">variable</span> <span class="n">highlighting</span><span class="o">.</span>
                <span class="n">Set</span><span class="o">.</span><span class="n">add</span> <span class="n">b</span> <span class="n">term</span><span class="p">,</span> <span class="n">ty</span>
            <span class="o">|</span> <span class="n">PatDyn</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">|</span> <span class="n">PatUnbox</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">x</span>
            <span class="o">|</span> <span class="n">PatPair</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span> <span class="n">b</span>
            <span class="o">|</span> <span class="n">PatRecordMembers</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">l</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">function</span>
                    <span class="o">|</span> <span class="n">PatRecordMembersSymbol</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="n">s</span> <span class="n">x</span>
                    <span class="o">|</span> <span class="n">PatRecordMembersInjectVar</span><span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">),</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">check_term</span> <span class="n">term</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">);</span> <span class="n">loop</span> <span class="n">s</span> <span class="n">x</span>
                    <span class="p">)</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">ty</span><span class="p">)</span> <span class="n">l</span>
            <span class="o">|</span> <span class="n">PatAnd</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="n">PatOr</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="p">(</span><span class="n">loop</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">ty</span><span class="p">)</span> <span class="n">a</span><span class="p">)</span> <span class="n">b</span>
            <span class="o">|</span> <span class="n">PatAnnot</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ctype</span> <span class="n">constraints</span> <span class="n">term</span> <span class="n">ty</span> <span class="n">b</span><span class="p">;</span> <span class="n">f</span> <span class="n">a</span>
            <span class="o">|</span> <span class="n">PatWhen</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">r</span> <span class="o">=</span> <span class="n">f</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">cterm</span> <span class="n">constraints</span> <span class="n">r</span> <span class="n">b</span><span class="p">;</span> <span class="n">r</span>
            <span class="o">|</span> <span class="n">PatNominal</span><span class="p">(</span><span class="n">_</span><span class="p">,(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">_</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">check_ty</span> <span class="n">ty</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">);</span> <span class="n">f</span> <span class="n">b</span>
            <span class="o">|</span> <span class="n">PatArray</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="n">loop</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">ty</span><span class="p">)</span> <span class="n">a</span>
        <span class="n">loop</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">ty</span><span class="p">)</span> <span class="n">x</span>

    <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">Choice1Of2</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">cterm</span> <span class="n">constraints</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">ty</span><span class="p">)</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">Choice2Of2</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">ctype</span> <span class="n">constraints</span> <span class="n">term</span> <span class="n">ty</span> <span class="n">x</span>
    <span class="n">errors</span>

<span class="n">let</span> <span class="n">assert_bound_vars</span> <span class="p">(</span><span class="n">top_env</span> <span class="p">:</span> <span class="n">InferEnv</span><span class="p">)</span> <span class="n">constraints</span> <span class="n">term</span> <span class="n">ty</span> <span class="n">x</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">validate_bound_vars</span> <span class="n">top_env</span> <span class="n">constraints</span> <span class="n">term</span> <span class="n">ty</span> <span class="n">x</span>
    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Count</span> <span class="n">then</span> <span class="k">raise</span> <span class="p">(</span><span class="n">InferTypeErrorException</span> <span class="p">(</span><span class="n">Seq</span><span class="o">.</span><span class="n">toList</span> <span class="n">errors</span><span class="p">))</span>

<span class="n">let</span> <span class="n">rec</span> <span class="n">subst</span> <span class="p">(</span><span class="n">m</span> <span class="p">:</span> <span class="p">(</span><span class="n">Var</span> <span class="o">*</span> <span class="n">T</span><span class="p">)</span> <span class="nb">list</span><span class="p">)</span> <span class="n">x</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">f</span> <span class="o">=</span> <span class="n">subst</span> <span class="n">m</span>
    <span class="k">if</span> <span class="n">List</span><span class="o">.</span><span class="n">isEmpty</span> <span class="n">m</span> <span class="n">then</span> <span class="n">x</span> 
    <span class="k">else</span> 
        <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">TyComment</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TyMetavar</span><span class="p">(</span><span class="n">_</span><span class="p">,{</span><span class="n">contents</span><span class="o">=</span><span class="n">Some</span> <span class="n">x</span><span class="p">})</span> 
        <span class="o">|</span> <span class="n">TyVar</span> <span class="p">(</span><span class="n">_</span><span class="p">,{</span><span class="n">contents</span><span class="o">=</span><span class="n">Some</span> <span class="n">x</span><span class="p">})</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">x</span> <span class="o">//</span> <span class="n">Don</span><span class="s1">'t do path shortening here.</span>
        <span class="o">|</span> <span class="n">TyMetavar</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyNominal</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyB</span> <span class="o">|</span> <span class="n">TyLit</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyPrim</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TySymbol</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">TyPair</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TyPair</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span> <span class="n">f</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TyRecord</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">TyRecord</span><span class="p">(</span><span class="n">Map</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TyModule</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">TyModule</span><span class="p">(</span><span class="n">Map</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TyUnion</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TyUnion</span><span class="p">(</span><span class="n">Map</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="p">(</span><span class="n">is_gadt</span><span class="p">,</span><span class="n">body</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">is_gadt</span><span class="p">,</span> <span class="n">f</span> <span class="n">body</span><span class="p">)</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TyFun</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TyFun</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span> <span class="n">f</span> <span class="n">b</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TyArray</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">TyArray</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TyApply</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TyApply</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span> <span class="n">f</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TyVar</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">tryPick</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">a</span> <span class="o">=</span> <span class="n">v</span> <span class="n">then</span> <span class="n">Some</span> <span class="n">x</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span> <span class="n">m</span> <span class="o">|&gt;</span> <span class="n">Option</span><span class="o">.</span><span class="n">defaultValue</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">TyForall</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TyForall</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">f</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TyExists</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TyExists</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">f</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TyInl</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TyInl</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">f</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TyMacro</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">TyMacro</span><span class="p">(</span><span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">function</span> <span class="n">TMVar</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">TMVar</span><span class="p">(</span><span class="n">f</span> <span class="n">x</span><span class="p">)</span> <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="p">)</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TyLayout</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TyLayout</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>

<span class="n">let</span> <span class="n">type_apply_split</span> <span class="n">x</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="n">s</span> <span class="n">x</span> <span class="o">=</span>
        <span class="k">match</span> <span class="n">visit_t</span> <span class="n">x</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">TyApply</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="p">(</span><span class="n">b</span> <span class="p">::</span> <span class="n">s</span><span class="p">)</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="p">,</span> <span class="n">s</span>
    <span class="n">loop</span> <span class="p">[]</span> <span class="n">x</span>

<span class="n">let</span> <span class="n">rec</span> <span class="n">kind_subst</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">KindMetavar</span> <span class="p">({</span><span class="n">contents</span><span class="s1">'=Some x} &amp; link) -&gt; shorten'</span> <span class="n">x</span> <span class="n">link</span> <span class="n">kind_subst</span>
    <span class="o">|</span> <span class="n">KindMetavar</span> <span class="n">_</span> <span class="o">|</span> <span class="n">KindType</span> <span class="k">as</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">KindFun</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KindFun</span><span class="p">(</span><span class="n">kind_subst</span> <span class="n">a</span><span class="p">,</span><span class="n">kind_subst</span> <span class="n">b</span><span class="p">)</span>

<span class="n">let</span> <span class="n">rec</span> <span class="n">foralls_get</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">RawForall</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">a</span><span class="s1">', b = foralls_get b in a :: a'</span><span class="p">,</span> <span class="n">b</span>
    <span class="o">|</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="p">[],</span> <span class="n">b</span>

<span class="n">let</span> <span class="n">rec</span> <span class="n">foralls_ty_get</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">TyForall</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">a</span><span class="s1">', b = foralls_ty_get b in a :: a'</span><span class="p">,</span> <span class="n">b</span>
    <span class="o">|</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="p">[],</span> <span class="n">b</span>

<span class="n">let</span> <span class="n">rec</span> <span class="n">kind_force</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">KindMetavar</span> <span class="p">({</span><span class="n">contents</span><span class="s1">'=Some x} &amp; link) -&gt; shorten'</span> <span class="n">x</span> <span class="n">link</span> <span class="n">kind_force</span>
    <span class="o">|</span> <span class="n">KindMetavar</span> <span class="n">link</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">KindType</span> <span class="ow">in</span> <span class="n">link</span><span class="o">.</span><span class="n">contents</span><span class="s1">' &lt;- Some x; x</span>
    <span class="o">|</span> <span class="n">KindType</span> <span class="k">as</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">KindFun</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KindFun</span><span class="p">(</span><span class="n">kind_force</span> <span class="n">a</span><span class="p">,</span><span class="n">kind_force</span> <span class="n">b</span><span class="p">)</span>

<span class="n">let</span> <span class="n">p</span> <span class="n">prec</span> <span class="n">prec</span><span class="s1">' x = if prec &lt; prec'</span> <span class="n">then</span> <span class="n">x</span> <span class="k">else</span> <span class="n">sprintf</span> <span class="s2">"(</span><span class="si">%s</span><span class="s2">)"</span> <span class="n">x</span>
<span class="n">let</span> <span class="n">show_kind</span> <span class="n">x</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">f</span> <span class="n">prec</span> <span class="n">x</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="n">prec</span>
        <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">KindMetavar</span> <span class="p">{</span><span class="n">contents</span><span class="s1">'=Some x} -&gt; f prec x</span>
        <span class="o">|</span> <span class="n">KindMetavar</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="s2">"?"</span>
        <span class="o">|</span> <span class="n">KindType</span> <span class="o">-&gt;</span> <span class="s2">"*"</span>
        <span class="o">|</span> <span class="n">KindFun</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">p</span> <span class="mi">20</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> -&gt; </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">f</span> <span class="mi">20</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">f</span> <span class="mi">19</span> <span class="n">b</span><span class="p">))</span>
    <span class="n">f</span> <span class="o">-</span><span class="mi">1</span> <span class="n">x</span>

<span class="n">let</span> <span class="n">show_constraints</span> <span class="n">env</span> <span class="n">x</span> <span class="o">=</span> <span class="n">Set</span><span class="o">.</span><span class="n">toList</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">constraint_name</span> <span class="n">env</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">"; "</span> <span class="o">|&gt;</span> <span class="n">sprintf</span> <span class="s2">"{</span><span class="si">%s</span><span class="s2">}"</span>
<span class="n">let</span> <span class="n">show_nominal</span> <span class="p">(</span><span class="n">env</span> <span class="p">:</span> <span class="n">TopEnv</span><span class="p">)</span> <span class="n">i</span> <span class="o">=</span> <span class="n">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">i</span> <span class="n">env</span><span class="o">.</span><span class="n">nominals_aux</span> <span class="k">with</span> <span class="n">Some</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="s2">"?"</span>
<span class="n">let</span> <span class="n">show_layout_type</span> <span class="o">=</span> <span class="n">function</span> <span class="n">Heap</span> <span class="o">-&gt;</span> <span class="s2">"heap"</span> <span class="o">|</span> <span class="n">HeapMutable</span> <span class="o">-&gt;</span> <span class="s2">"mut"</span> <span class="o">|</span> <span class="n">StackMutable</span> <span class="o">-&gt;</span> <span class="s2">"stack_mut"</span>

<span class="n">let</span> <span class="n">show_t</span> <span class="p">(</span><span class="n">env</span> <span class="p">:</span> <span class="n">TopEnv</span><span class="p">)</span> <span class="n">x</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">show_var</span> <span class="p">(</span><span class="n">a</span> <span class="p">:</span> <span class="n">Var</span><span class="p">)</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">n</span> <span class="o">=</span> <span class="n">match</span> <span class="n">a</span><span class="o">.</span><span class="n">kind</span> <span class="k">with</span> <span class="n">KindType</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"(</span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">)"</span> <span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="p">(</span><span class="n">show_kind</span> <span class="n">a</span><span class="o">.</span><span class="n">kind</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Set</span><span class="o">.</span><span class="n">isEmpty</span> <span class="n">a</span><span class="o">.</span><span class="n">constraints</span> <span class="n">then</span> <span class="n">n</span>
        <span class="k">else</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">"</span> <span class="n">n</span> <span class="p">(</span><span class="n">show_constraints</span> <span class="n">env</span> <span class="n">a</span><span class="o">.</span><span class="n">constraints</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">f</span> <span class="n">prec</span> <span class="n">x</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="n">prec</span>
        <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">TyVar</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="p">{</span><span class="n">contents</span><span class="o">=</span><span class="n">Some</span> <span class="n">x</span><span class="p">})</span> <span class="o">|</span> <span class="n">TyComment</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyMetavar</span><span class="p">(</span><span class="n">_</span><span class="p">,{</span><span class="n">contents</span><span class="o">=</span><span class="n">Some</span> <span class="n">x</span><span class="p">})</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">prec</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">TyMetavar</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="s2">"_"</span>
        <span class="o">|</span> <span class="n">TyVar</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">name</span>
        <span class="o">|</span> <span class="n">TyNominal</span> <span class="n">i</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">i</span> <span class="n">env</span><span class="o">.</span><span class="n">nominals_aux</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">Some</span> <span class="n">x</span> <span class="n">when</span> <span class="n">prec</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"(</span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">)"</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="p">(</span><span class="n">show_kind</span> <span class="n">x</span><span class="o">.</span><span class="n">kind</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">Some</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="s2">"?"</span>
        <span class="o">|</span> <span class="n">TyB</span> <span class="o">-&gt;</span> <span class="s2">"()"</span>
        <span class="o">|</span> <span class="n">TyLit</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">show_lit</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">TyPrim</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">show_primt</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">TySymbol</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">".</span><span class="si">%s</span><span class="s2">"</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">TyExists</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> 
            <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="n">show_var</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">" "</span>
            <span class="n">p</span> <span class="mi">0</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"exists </span><span class="si">%s</span><span class="s2">. </span><span class="si">%s</span><span class="s2">"</span> <span class="n">a</span> <span class="p">(</span><span class="n">f</span> <span class="o">-</span><span class="mi">1</span> <span class="n">b</span><span class="p">))</span>
        <span class="o">|</span> <span class="n">TyForall</span> <span class="n">_</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span>
                <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="o">=</span> <span class="n">function</span>
                    <span class="o">|</span> <span class="n">TyForall</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">a</span><span class="s1">',b = loop b in (a :: a'</span><span class="p">),</span> <span class="n">b</span>
                    <span class="o">|</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="p">[],</span> <span class="n">b</span>
                <span class="n">loop</span> <span class="n">x</span>
            <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="n">show_var</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">" "</span>
            <span class="n">p</span> <span class="mi">0</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"forall </span><span class="si">%s</span><span class="s2">. </span><span class="si">%s</span><span class="s2">"</span> <span class="n">a</span> <span class="p">(</span><span class="n">f</span> <span class="o">-</span><span class="mi">1</span> <span class="n">b</span><span class="p">))</span>
        <span class="o">|</span> <span class="n">TyInl</span> <span class="n">_</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span>
                <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="o">=</span> <span class="n">function</span>
                    <span class="o">|</span> <span class="n">TyInl</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">a</span><span class="s1">',b = loop b in (a :: a'</span><span class="p">),</span> <span class="n">b</span>
                    <span class="o">|</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="p">[],</span> <span class="n">b</span>
                <span class="n">loop</span> <span class="n">x</span>
            <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="n">show_var</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">" "</span>
            <span class="n">p</span> <span class="mi">0</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> =&gt; </span><span class="si">%s</span><span class="s2">"</span> <span class="n">a</span> <span class="p">(</span><span class="n">f</span> <span class="o">-</span><span class="mi">1</span> <span class="n">b</span><span class="p">))</span>
        <span class="o">|</span> <span class="n">TyArray</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">p</span> <span class="mi">30</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"array_base </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">f</span> <span class="mi">30</span> <span class="n">a</span><span class="p">))</span>
        <span class="o">|</span> <span class="n">TyApply</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">p</span> <span class="mi">30</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">f</span> <span class="mi">29</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">f</span> <span class="mi">30</span> <span class="n">b</span><span class="p">))</span>
        <span class="o">|</span> <span class="n">TyPair</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">p</span> <span class="mi">25</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> * </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">f</span> <span class="mi">25</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">f</span> <span class="mi">24</span> <span class="n">b</span><span class="p">))</span>
        <span class="o">|</span> <span class="n">TyFun</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">FT_Vanilla</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">p</span> <span class="mi">20</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> -&gt; </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">f</span> <span class="mi">20</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">f</span> <span class="mi">19</span> <span class="n">b</span><span class="p">))</span>
        <span class="o">|</span> <span class="n">TyFun</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">FT_Pointer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">p</span> <span class="mi">20</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"fptr (</span><span class="si">%s</span><span class="s2"> -&gt; </span><span class="si">%s</span><span class="s2">)"</span> <span class="p">(</span><span class="n">f</span> <span class="mi">20</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">f</span> <span class="mi">19</span> <span class="n">b</span><span class="p">))</span>
        <span class="o">|</span> <span class="n">TyFun</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">FT_Closure</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">p</span> <span class="mi">20</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"closure (</span><span class="si">%s</span><span class="s2"> -&gt; </span><span class="si">%s</span><span class="s2">)"</span> <span class="p">(</span><span class="n">f</span> <span class="mi">20</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">f</span> <span class="mi">19</span> <span class="n">b</span><span class="p">))</span>
        <span class="o">|</span> <span class="n">TyModule</span> <span class="n">l</span> <span class="o">-&gt;</span>
            <span class="k">if</span> <span class="n">prec</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="n">then</span>
                <span class="n">l</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">toList</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="o">-&gt;</span>
                    <span class="n">let</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="n">k</span><span class="p">,</span> <span class="n">f</span> <span class="o">-</span><span class="mi">1</span> <span class="n">v</span>
                    <span class="k">match</span> <span class="n">v</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">TyComment</span><span class="p">(</span><span class="n">com</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="se">\n</span><span class="s2">---</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s2">---</span><span class="se">\n</span><span class="s2">"</span> <span class="n">a</span> <span class="n">b</span> <span class="n">com</span>
                    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">"</span> <span class="n">a</span> <span class="n">b</span>
                    <span class="p">)</span>
                <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
            <span class="k">else</span> <span class="s2">"module"</span>
        <span class="o">|</span> <span class="n">TyRecord</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"{</span><span class="si">%s</span><span class="s2">}"</span> <span class="p">(</span><span class="n">l</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">toList</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">((</span><span class="n">_</span><span class="p">,</span><span class="n">k</span><span class="p">),</span><span class="n">v</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">"</span> <span class="n">k</span> <span class="p">(</span><span class="n">f</span> <span class="o">-</span><span class="mi">1</span> <span class="n">v</span><span class="p">))</span> <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">"; "</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TyUnion</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"{</span><span class="si">%s</span><span class="s2">}"</span> <span class="p">(</span><span class="n">l</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">toList</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">((</span><span class="n">_</span><span class="p">,</span><span class="n">k</span><span class="p">),(</span><span class="n">_</span><span class="p">,</span><span class="n">v</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">"</span> <span class="n">k</span> <span class="p">(</span><span class="n">f</span> <span class="o">-</span><span class="mi">1</span> <span class="n">v</span><span class="p">))</span> <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">"| "</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TyMacro</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">p</span> <span class="mi">30</span> <span class="p">(</span><span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">function</span> <span class="n">TMLitVar</span> <span class="n">a</span> <span class="o">|</span> <span class="n">TMVar</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="o">-</span><span class="mi">1</span> <span class="n">a</span> <span class="o">|</span> <span class="n">TMText</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="p">)</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">""</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TyLayout</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">p</span> <span class="mi">30</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_layout_type</span> <span class="n">b</span><span class="p">)</span> <span class="p">(</span><span class="n">f</span> <span class="mi">30</span> <span class="n">a</span><span class="p">))</span>

    <span class="n">f</span> <span class="o">-</span><span class="mi">2</span> <span class="n">x</span>

<span class="n">let</span> <span class="n">show_type_error</span> <span class="p">(</span><span class="n">env</span> <span class="p">:</span> <span class="n">TopEnv</span><span class="p">)</span> <span class="n">x</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">f</span> <span class="o">=</span> <span class="n">show_t</span> <span class="n">env</span>
    <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">IncorrectRecursiveNominal</span> <span class="o">-&gt;</span> <span class="s2">"The non-recursive nominals should not use their own type in the clause."</span>
    <span class="o">|</span> <span class="n">IncorrectGADTConstructorType</span> <span class="o">-&gt;</span> <span class="s2">"The GADT case in the union has to result in an instance of the union being constructed. Any type other than the self being in the range of the union is not allowed."</span>
    <span class="o">|</span> <span class="n">ExistsShouldntHaveMetavars</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"The variables of the exists body shouldn't have metavariables left over in them.</span><span class="se">\n</span><span class="s2">Got: [</span><span class="si">%s</span><span class="s2">]"</span>  <span class="p">(</span><span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="n">f</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">", "</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">ExpectedExistentialInPattern</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"The variable being destructured in the pattern match need to be explicitly annotated and with an existential type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">UnexpectedNumberOfArgumentsInExistsPattern</span><span class="p">(</span><span class="n">got</span><span class="p">,</span><span class="n">exp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"The number of arguments in the existential pattern doesn't match the one in the type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%i</span><span class="se">\n</span><span class="s2">Expected: </span><span class="si">%i</span><span class="s2">"</span> <span class="n">got</span> <span class="n">exp</span>
    <span class="o">|</span> <span class="n">UnexpectedNumberOfArgumentsInExistsBody</span><span class="p">(</span><span class="n">got</span><span class="p">,</span><span class="n">exp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"The number of arguments in the existential body doesn't match the one in the type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%i</span><span class="se">\n</span><span class="s2">Expected: </span><span class="si">%i</span><span class="s2">"</span> <span class="n">got</span> <span class="n">exp</span>
    <span class="o">|</span> <span class="n">ExpectedExistentialInTerm</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"The body of `expects` need to be explicitly annotated and with an existential type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">UnionsCannotBeApplied</span> <span class="o">-&gt;</span> <span class="s2">"Unions cannot be applied."</span>
    <span class="o">|</span> <span class="n">ExpectedNominalInApply</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Expected a nominal.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">MalformedNominal</span> <span class="o">-&gt;</span> <span class="s2">"Malformed nominal."</span>
    <span class="o">|</span> <span class="n">ModuleMustBeImmediatelyApplied</span> <span class="o">-&gt;</span> <span class="s2">"Module must be immediately applied."</span>
    <span class="o">|</span> <span class="n">ExpectedSymbol</span><span class="s1">' a -&gt; sprintf "Expected a symbol.</span><span class="se">\n</span><span class="s1">Got: </span><span class="si">%s</span><span class="s1">" (f a)</span>
    <span class="o">|</span> <span class="n">KindError</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Kind unification failure.</span><span class="se">\n</span><span class="s2">Got:      </span><span class="si">%s</span><span class="se">\n</span><span class="s2">Expected: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_kind</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">show_kind</span> <span class="n">b</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">KindErrorInConstraint</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Kind unification failure when propagating them from constraints.</span><span class="se">\n</span><span class="s2">Got:      </span><span class="si">%s</span><span class="se">\n</span><span class="s2">Expected: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_kind</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">show_kind</span> <span class="n">b</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">TermError</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Unification failure.</span><span class="se">\n</span><span class="s2">Got:      </span><span class="si">%s</span><span class="se">\n</span><span class="s2">Expected: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RecursiveMetavarsNotAllowed</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Recursive metavariables are not allowed. A metavar cannot be unified with a type that has itself.</span><span class="se">\n</span><span class="s2">Got:      </span><span class="si">%s</span><span class="se">\n</span><span class="s2">Expected: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RecursiveTypevarsNotAllowed</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Recursive type variables are not allowed. A type variable cannot be unified with a type that has itself.</span><span class="se">\n</span><span class="s2">Got:      </span><span class="si">%s</span><span class="se">\n</span><span class="s2">Expected: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">ExpectedSymbolAsRecordKey</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Expected symbol as a record key.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">ExpectedSymbolAsModuleKey</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Expected symbol as a module key.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">UnboundVariable</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Unbound variable: </span><span class="si">%s</span><span class="s2">."</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">UnboundModule</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Unbound module."</span>
    <span class="o">|</span> <span class="n">ModuleIndexFailedInOpen</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Module does not have a submodule with that key."</span>
    <span class="o">|</span> <span class="n">ModuleIndexWouldShadowLocalVars</span> <span class="p">[</span><span class="o">|</span><span class="n">v</span><span class="o">|</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"The module open would shadow a local variable: </span><span class="si">{v}</span><span class="s2">."</span>
    <span class="o">|</span> <span class="n">ModuleIndexWouldShadowLocalVars</span> <span class="nb">vars</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">v</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">", "</span> <span class="nb">vars</span> <span class="ow">in</span> <span class="err">$</span><span class="s2">"The module open would shadow the local variables: </span><span class="si">{v}</span><span class="s2">."</span>
    <span class="o">|</span> <span class="n">TypeVarScopeError</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Tried to unify the type variable </span><span class="si">%s</span><span class="s2"> with a metavar outside its scope."</span> <span class="n">a</span>
    <span class="o">|</span> <span class="n">ForallVarConstraintError</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Metavariable's constraints must be a subset of the forall var </span><span class="si">%s</span><span class="s2">'s.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">Expected: </span><span class="si">%s</span><span class="s2">"</span> <span class="n">n</span> <span class="p">(</span><span class="n">show_constraints</span> <span class="n">env</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">show_constraints</span> <span class="n">env</span> <span class="n">b</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">MetavarsNotAllowedInRecordWith</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"In the top-down segment the record keys need to be fully known. Please add an annotation."</span>
    <span class="o">|</span> <span class="n">LayoutSetMustBeAnnotated</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"The layout type being set must be annotated."</span>
    <span class="o">|</span> <span class="n">ExpectedMutableLayout</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Expected a mutable layout type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">ExpectedRecord</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Expected a record.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">ExpectedRecordInsideALayout</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Expected a record inside a layout type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">ExpectedRecordAsResultOfIndex</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Expected a record as result of index.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RecordIndexFailed</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"The record does not have the key: </span><span class="si">%s</span><span class="s2">"</span> <span class="n">a</span>
    <span class="o">|</span> <span class="n">ModuleIndexFailed</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"The module does not have the key: </span><span class="si">%s</span><span class="s2">"</span> <span class="n">a</span>
    <span class="o">|</span> <span class="n">ExpectedModule</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Expected a module.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">ExpectedSymbolInRecordWith</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Expected a symbol.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">RealFunctionInTopDown</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Real segment functions are forbidden in the top-down segment. They can only be used in `real` expressions or .spir modules."</span>
    <span class="o">|</span> <span class="n">MissingRecordFieldsInPattern</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"The record is missing the following fields: </span><span class="si">%s</span><span class="s2">.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">", "</span> <span class="n">b</span><span class="p">)</span> <span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">CasePatternNotFoundForType</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> does not have the </span><span class="si">%s</span><span class="s2"> case."</span> <span class="p">(</span><span class="n">show_nominal</span> <span class="n">env</span> <span class="n">i</span><span class="p">)</span> <span class="n">n</span>
    <span class="o">|</span> <span class="n">CasePatternNotFound</span> <span class="n">n</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Cannot find a function with the same name as the </span><span class="si">%s</span><span class="s2"> case in the environment."</span> <span class="n">n</span>
    <span class="o">|</span> <span class="n">CannotInferCasePatternFromTermInEnv</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Cannot infer the higher order type that has this case from the following type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">NominalInPatternUnbox</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Expected an union type, but </span><span class="si">%s</span><span class="s2"> is a nominal."</span> <span class="p">(</span><span class="n">show_nominal</span> <span class="n">env</span> <span class="n">i</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">TypeInEnvIsNotNominal</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Expected a nominal type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">UnionInPatternNominal</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Expected a nominal type, but </span><span class="si">%s</span><span class="s2"> is an union."</span> <span class="p">(</span><span class="n">show_nominal</span> <span class="n">env</span> <span class="n">i</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">ConstraintError</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Constraint satisfaction error.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">Fails to satisfy: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span> <span class="p">(</span><span class="n">constraint_name</span> <span class="n">env</span> <span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">ExpectedAnnotation</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Recursive functions with foralls must be fully annotated."</span>
    <span class="o">|</span> <span class="n">ExpectedSinglePattern</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Recursive functions with foralls must not have multiple clauses in their patterns."</span>
    <span class="o">|</span> <span class="n">RecursiveAnnotationHasMetavars</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Recursive functions with foralls must not have metavars.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">ValueRestriction</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Metavars that are not part of the enclosing function's signature are not allowed. They need to be values.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">DuplicateRecInlName</span> <span class="o">-&gt;</span> <span class="s2">"Shadowing of functions by the members of the same mutually recursive block is not allowed."</span>
    <span class="o">|</span> <span class="n">DuplicateKeyInRecUnion</span> <span class="o">-&gt;</span> <span class="s2">"Mutually recursive unions should not have overlapping keys."</span>
    <span class="o">|</span> <span class="n">ExpectedConstraintInsteadOfModule</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Expected a constraint instead of module."</span>
    <span class="o">|</span> <span class="n">InstanceNotFound</span><span class="p">(</span><span class="n">prot</span><span class="p">,</span><span class="n">ins</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"The higher order type instance </span><span class="si">%s</span><span class="s2"> does not have the prototype </span><span class="si">%s</span><span class="s2">."</span> <span class="p">(</span><span class="n">show_nominal</span> <span class="n">env</span> <span class="n">ins</span><span class="p">)</span> <span class="n">env</span><span class="o">.</span><span class="n">prototypes</span><span class="o">.</span><span class="p">[</span><span class="n">prot</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
    <span class="o">|</span> <span class="n">ExpectedPrototypeConstraint</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Expected a prototype constraint.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">constraint_name</span> <span class="n">env</span> <span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">PrototypeConstraintCannotPropagateToMetavar</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Cannot propagate the </span><span class="si">%s</span><span class="s2"> prototype constraint to the applied metavariable as the kinds would not match. If this is not intended to be a type var, provide a type annotation to a concrete type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="n">env</span><span class="o">.</span><span class="n">prototypes</span><span class="o">.</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="p">(</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">PrototypeConstraintCannotPropagateToVar</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Cannot propagate the </span><span class="si">%s</span><span class="s2"> prototype constraint to the applied type variable as the kinds would not match.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="n">env</span><span class="o">.</span><span class="n">prototypes</span><span class="o">.</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="p">(</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">ExpectedPrototypeInsteadOfModule</span> <span class="o">-&gt;</span> <span class="s2">"Expected a prototype instead of module."</span>
    <span class="o">|</span> <span class="n">ExpectedHigherOrder</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Expected a higher order type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">InstanceArityError</span><span class="p">(</span><span class="n">prot</span><span class="p">,</span><span class="n">ins</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"The arity of the instance must be greater or equal to that of the prototype.</span><span class="se">\n</span><span class="s2">Instance arity:  </span><span class="si">%i</span><span class="se">\n</span><span class="s2">Prototype arity: </span><span class="si">%i</span><span class="s2">"</span> <span class="n">ins</span> <span class="n">prot</span>
    <span class="o">|</span> <span class="n">InstanceCoreVarsShouldMatchTheArityDifference</span><span class="p">(</span><span class="n">num_vars</span><span class="p">,</span><span class="n">expected</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"The number of forall variables in the instance needs to be specified so it equals the difference between the instance arity and the prototype arity.</span><span class="se">\n</span><span class="s2">Instance variables specified: </span><span class="si">%i</span><span class="se">\n</span><span class="s2">Expected:                     </span><span class="si">%i</span><span class="s2">"</span> <span class="n">num_vars</span> <span class="n">expected</span>
    <span class="o">|</span> <span class="n">InstanceKindError</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"The kinds of the instance foralls are incompatible with those of the prototype.</span><span class="se">\n</span><span class="s2">Got:      </span><span class="si">%s</span><span class="se">\n</span><span class="s2">Expected: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_kind</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">show_kind</span> <span class="n">b</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">KindNotAllowedInInstanceForall</span> <span class="o">-&gt;</span> <span class="s2">"Kinds should not be explicitly stated in instance foralls."</span>
    <span class="o">|</span> <span class="n">InstanceVarShouldNotMatchAnyOfPrototypes</span> <span class="o">-&gt;</span> <span class="s2">"Instance forall must not have the same name as any of the prototype foralls."</span>
    <span class="o">|</span> <span class="n">MissingBody</span> <span class="o">-&gt;</span> <span class="s2">"The function body is missing."</span>
    <span class="o">|</span> <span class="n">MacroIsMissingAnnotation</span> <span class="o">-&gt;</span> <span class="s2">"The macro needs an annotation."</span>
    <span class="o">|</span> <span class="n">ArrayIsMissingAnnotation</span> <span class="o">-&gt;</span> <span class="s2">"The array needs an annotation."</span>
    <span class="o">|</span> <span class="n">ExistsIsMissingAnnotation</span> <span class="o">-&gt;</span> <span class="s2">"The existential type needs an annotation."</span>
    <span class="o">|</span> <span class="n">ShadowedForall</span> <span class="o">-&gt;</span> <span class="s2">"Shadowing of foralls is not allowed in the top-down segment."</span>
    <span class="o">|</span> <span class="n">ShadowedExists</span> <span class="o">-&gt;</span> <span class="s2">"Shadowing of existential type variables is not allowed in the top-down segment."</span>
    <span class="o">|</span> <span class="n">UnionTypesMustHaveTheSameLayout</span> <span class="o">-&gt;</span> <span class="s2">"The two union types must have the same layout."</span>
    <span class="o">|</span> <span class="n">OrphanInstance</span> <span class="o">-&gt;</span> <span class="s2">"The instance has to be defined in the same package as either the prototype or the nominal."</span>
    <span class="o">|</span> <span class="n">ShadowedInstance</span> <span class="o">-&gt;</span> <span class="s2">"The instance cannot be defined twice."</span>
    <span class="o">|</span> <span class="n">UnusedTypeVariable</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"The type variable </span><span class="si">%s</span><span class="s2"> is unused in the function's type signature."</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">UnusedTypeVariable</span> <span class="nb">vars</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"The type variables </span><span class="si">%s</span><span class="s2"> are unused in the function's type signature."</span> <span class="p">(</span><span class="nb">vars</span> <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">", "</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">CompilerError</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span>

<span class="n">let</span> <span class="n">loc_env</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">TopEnv</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="n">term</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">term</span><span class="p">;</span> <span class="n">ty</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">ty</span><span class="p">;</span> <span class="n">constraints</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">constraints</span><span class="p">}</span>
<span class="n">let</span> <span class="n">names_of</span> <span class="nb">vars</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="nb">vars</span> <span class="o">|&gt;</span> <span class="n">Set</span>

<span class="n">let</span> <span class="n">lit</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">LitUInt8</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">TyPrim</span> <span class="n">UInt8T</span>
    <span class="o">|</span> <span class="n">LitUInt16</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">TyPrim</span> <span class="n">UInt16T</span>
    <span class="o">|</span> <span class="n">LitUInt32</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">TyPrim</span> <span class="n">UInt32T</span>
    <span class="o">|</span> <span class="n">LitUInt64</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">TyPrim</span> <span class="n">UInt64T</span>
    <span class="o">|</span> <span class="n">LitInt8</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">TyPrim</span> <span class="n">Int8T</span>
    <span class="o">|</span> <span class="n">LitInt16</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">TyPrim</span> <span class="n">Int16T</span>
    <span class="o">|</span> <span class="n">LitInt32</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">TyPrim</span> <span class="n">Int32T</span>
    <span class="o">|</span> <span class="n">LitInt64</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">TyPrim</span> <span class="n">Int64T</span>
    <span class="o">|</span> <span class="n">LitFloat32</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">TyPrim</span> <span class="n">Float32T</span>
    <span class="o">|</span> <span class="n">LitFloat64</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">TyPrim</span> <span class="n">Float64T</span>
    <span class="o">|</span> <span class="n">LitBool</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">TyPrim</span> <span class="n">BoolT</span>
    <span class="o">|</span> <span class="n">LitString</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">TyPrim</span> <span class="n">StringT</span>
    <span class="o">|</span> <span class="n">LitChar</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">TyPrim</span> <span class="n">CharT</span>

<span class="n">let</span> <span class="n">autogen_name_in_fun</span> <span class="p">(</span><span class="n">i</span> <span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">=</span> <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">char</span> <span class="n">i</span> <span class="o">+</span> <span class="s1">'a'</span> <span class="ow">in</span> <span class="k">if</span> <span class="s1">'z'</span> <span class="o">&lt;</span> <span class="n">x</span> <span class="n">then</span> <span class="n">sprintf</span> <span class="s2">"'</span><span class="si">%i</span><span class="s2">"</span> <span class="n">i</span> <span class="k">else</span> <span class="n">sprintf</span> <span class="s2">"'</span><span class="si">%c</span><span class="s2">"</span> <span class="n">x</span>
<span class="n">let</span> <span class="n">autogen_name_in_typecase</span> <span class="p">(</span><span class="n">i</span> <span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">=</span> <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">char</span> <span class="n">i</span> <span class="o">+</span> <span class="s1">'a'</span> <span class="ow">in</span> <span class="k">if</span> <span class="s1">'z'</span> <span class="o">&lt;</span> <span class="n">x</span> <span class="n">then</span> <span class="n">sprintf</span> <span class="s2">"'t</span><span class="si">%i</span><span class="s2">"</span> <span class="n">i</span> <span class="k">else</span> <span class="n">sprintf</span> <span class="s2">"'t</span><span class="si">%c</span><span class="s2">"</span> <span class="n">x</span>
<span class="n">let</span> <span class="n">trim_kind</span> <span class="o">=</span> <span class="n">function</span> <span class="n">KindFun</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">k</span> <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"impossible"</span>

<span class="o">//</span> <span class="n">Similar</span> <span class="n">to</span> <span class="n">BundleTop</span> <span class="k">except</span> <span class="k">with</span> <span class="nb">type</span> <span class="n">annotations</span> <span class="ow">and</span> <span class="nb">type</span> <span class="n">application</span> <span class="n">filled</span> <span class="ow">in</span><span class="o">.</span>
<span class="nb">type</span> <span class="n">FilledTop</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">FType</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">RString</span> <span class="o">*</span> <span class="n">HoVar</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">RawTExpr</span>
    <span class="o">|</span> <span class="n">FNominal</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">RString</span> <span class="o">*</span> <span class="n">HoVar</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">RawTExpr</span>
    <span class="o">|</span> <span class="n">FNominalRec</span> <span class="n">of</span> <span class="p">(</span><span class="n">VSCRange</span> <span class="o">*</span> <span class="n">RString</span> <span class="o">*</span> <span class="n">HoVar</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">RawTExpr</span><span class="p">)</span> <span class="nb">list</span>
    <span class="o">|</span> <span class="n">FInl</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">RString</span> <span class="o">*</span> <span class="n">RawExpr</span>
    <span class="o">|</span> <span class="n">FRecInl</span> <span class="n">of</span> <span class="p">(</span><span class="n">VSCRange</span> <span class="o">*</span> <span class="n">RString</span> <span class="o">*</span> <span class="n">RawExpr</span><span class="p">)</span> <span class="nb">list</span>
    <span class="o">|</span> <span class="n">FPrototype</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">RString</span> <span class="o">*</span> <span class="n">RString</span> <span class="o">*</span> <span class="n">TypeVar</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">RawTExpr</span>
    <span class="o">|</span> <span class="n">FInstance</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">RGlobalId</span> <span class="o">*</span> <span class="n">RGlobalId</span> <span class="o">*</span> <span class="n">RawExpr</span>
    <span class="o">|</span> <span class="n">FOpen</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">RString</span> <span class="o">*</span> <span class="n">RString</span> <span class="nb">list</span>

<span class="nb">type</span> <span class="s1">'a AdditionType =</span>
    <span class="o">|</span> <span class="n">AOpen</span> <span class="n">of</span> <span class="s1">'a</span>
    <span class="o">|</span> <span class="n">AInclude</span> <span class="n">of</span> <span class="s1">'a</span>

<span class="nb">type</span> <span class="n">InferScope</span> <span class="o">=</span> <span class="nb">int</span>

<span class="nb">open</span> <span class="n">System</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">Generic</span>
<span class="nb">type</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ReferenceEquality</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">InferResult</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">filled_top</span> <span class="p">:</span> <span class="n">FilledTop</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">Promise</span>
    <span class="n">top_env_additions</span> <span class="p">:</span> <span class="n">TopEnv</span> <span class="n">AdditionType</span>
    <span class="n">offset</span> <span class="p">:</span> <span class="nb">int</span>
    <span class="n">hovers</span> <span class="p">:</span> <span class="n">RString</span> <span class="p">[]</span>
    <span class="n">errors</span> <span class="p">:</span> <span class="n">RString</span> <span class="nb">list</span>
    <span class="p">}</span>

<span class="n">let</span> <span class="n">dispose_gadt_links</span> <span class="n">gadt_links</span> <span class="o">=</span> <span class="n">Seq</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">ref</span><span class="o">&lt;</span><span class="n">option</span><span class="o">&lt;</span><span class="s1">'a&gt;&gt;) -&gt; x.Value &lt;- None) gadt_links</span>

<span class="n">let</span> <span class="n">assert_foralls_used</span><span class="s1">' (errors : (VSCRange * TypeError) ResizeArray) outside_foralls r x =</span>
    <span class="n">let</span> <span class="n">h</span> <span class="o">=</span> <span class="n">HashSet</span><span class="p">()</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">f</span> <span class="n">x</span> <span class="o">=</span>
        <span class="k">match</span> <span class="n">visit_t</span> <span class="n">x</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">TyVar</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="o">.</span><span class="n">singleton</span> <span class="n">v</span><span class="o">.</span><span class="n">name</span>
        <span class="o">|</span> <span class="n">TyExists</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">a</span> <span class="n">v</span> <span class="o">-&gt;</span> 
                <span class="k">if</span> <span class="n">Set</span><span class="o">.</span><span class="n">contains</span> <span class="n">v</span><span class="o">.</span><span class="n">name</span> <span class="n">a</span> <span class="o">=</span> <span class="n">false</span> <span class="n">then</span> <span class="n">h</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">ignore</span><span class="p">;</span> <span class="n">a</span>
                <span class="k">else</span> <span class="n">Set</span><span class="o">.</span><span class="n">remove</span> <span class="n">v</span><span class="o">.</span><span class="n">name</span> <span class="n">a</span>
                <span class="p">)</span> <span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span> <span class="n">v</span>
        <span class="o">|</span> <span class="n">TyForall</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">f</span> <span class="n">a</span>
            <span class="k">if</span> <span class="n">Set</span><span class="o">.</span><span class="n">contains</span> <span class="n">v</span><span class="o">.</span><span class="n">name</span> <span class="n">a</span> <span class="o">=</span> <span class="n">false</span> <span class="n">then</span> <span class="n">h</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">ignore</span><span class="p">;</span> <span class="n">a</span>
            <span class="k">else</span> <span class="n">Set</span><span class="o">.</span><span class="n">remove</span> <span class="n">v</span><span class="o">.</span><span class="n">name</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">TyUnion</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyModule</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyMetavar</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyNominal</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyB</span> <span class="o">|</span> <span class="n">TyLit</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyPrim</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TySymbol</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="o">.</span><span class="n">empty</span>
        <span class="o">|</span> <span class="n">TyPair</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyApply</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyFun</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span> <span class="o">+</span> <span class="n">f</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">TyRecord</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">_</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="o">.</span><span class="n">union</span> <span class="n">s</span> <span class="p">(</span><span class="n">f</span> <span class="n">x</span><span class="p">))</span> <span class="n">Set</span><span class="o">.</span><span class="n">empty</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">TyComment</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyLayout</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyInl</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyArray</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">TyMacro</span> <span class="n">a</span> <span class="o">-&gt;</span> 
            <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">x</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">TMLitVar</span> <span class="n">a</span> <span class="o">|</span> <span class="n">TMVar</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span> 
                <span class="o">|</span> <span class="n">TMText</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="o">.</span><span class="n">empty</span>
                <span class="p">)</span> <span class="n">Set</span><span class="o">.</span><span class="n">empty</span> <span class="n">a</span>
    <span class="n">let</span> <span class="n">used_vars</span> <span class="o">=</span> <span class="n">f</span> <span class="n">x</span>
    <span class="n">Seq</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">Add</span> <span class="o">&gt;&gt;</span> <span class="n">ignore</span><span class="p">)</span> <span class="p">(</span><span class="n">outside_foralls</span> <span class="o">-</span> <span class="n">used_vars</span><span class="p">)</span>
    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">h</span><span class="o">.</span><span class="n">Count</span> <span class="n">then</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">UnusedTypeVariable</span> <span class="p">(</span><span class="n">Seq</span><span class="o">.</span><span class="n">toList</span> <span class="n">h</span><span class="p">))</span>

<span class="n">let</span> <span class="n">assert_foralls_used</span> <span class="n">errors</span> <span class="n">r</span> <span class="n">x</span> <span class="o">=</span> <span class="n">assert_foralls_used</span><span class="s1">' errors Set.empty r x</span>

<span class="n">let</span> <span class="n">validate_nominal</span> <span class="p">(</span><span class="n">errors</span> <span class="p">:</span> <span class="n">_</span> <span class="n">ResizeArray</span><span class="p">)</span> <span class="n">global_id</span> <span class="n">body</span> <span class="n">v</span> <span class="o">=</span>
    <span class="o">//</span> <span class="n">Stack</span> <span class="n">union</span> <span class="n">types</span> <span class="ow">and</span> <span class="n">regular</span> <span class="n">nominals</span> <span class="n">must</span> <span class="ow">not</span> <span class="n">be</span> <span class="n">recursive</span><span class="o">.</span>
    <span class="o">//</span> <span class="n">Unlike</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">previous</span> <span class="n">version</span> <span class="n">of</span> <span class="n">Spiral</span> <span class="n">which</span> <span class="n">simply</span> <span class="n">didn</span><span class="s1">'t put the nominal type in the environment</span>
    <span class="o">//</span> <span class="n">this</span> <span class="n">one</span> <span class="n">has</span> <span class="n">to</span> <span class="n">do</span> <span class="n">it</span> <span class="n">becaus</span> <span class="n">the</span> <span class="n">GADT</span> <span class="n">constructors</span> <span class="n">need</span> <span class="n">access</span> <span class="n">to</span> <span class="n">it</span><span class="o">.</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">assert_nominal_non_recursive</span> <span class="n">v</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">f</span> <span class="o">=</span> <span class="n">assert_nominal_non_recursive</span>
        <span class="k">match</span> <span class="n">visit_t</span> <span class="n">v</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">TyNominal</span> <span class="n">global_id</span><span class="s1">' -&gt; if global_id = global_id'</span> <span class="n">then</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">range_of_texpr_gadt_body</span> <span class="n">body</span><span class="p">,</span> <span class="n">IncorrectRecursiveNominal</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TyMetavar</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyVar</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyModule</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyUnion</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyB</span> <span class="o">|</span> <span class="n">TyLit</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyPrim</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TySymbol</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="p">()</span>
        <span class="o">|</span> <span class="n">TyPair</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyApply</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyFun</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span><span class="p">;</span> <span class="n">f</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">TyRecord</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">TyExists</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyComment</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyLayout</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyForall</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyInl</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyArray</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">TyMacro</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">function</span> <span class="n">TMLitVar</span> <span class="n">a</span> <span class="o">|</span> <span class="n">TMVar</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span> <span class="o">|</span> <span class="n">TMText</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="p">())</span> <span class="n">a</span>
    <span class="k">match</span> <span class="n">v</span> <span class="k">with</span> <span class="o">//</span> <span class="n">Validates</span> <span class="n">the</span> <span class="n">union</span> <span class="nb">type</span><span class="o">.</span>
    <span class="o">|</span> <span class="n">TyUnion</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">name</span> <span class="p">(</span><span class="n">is_gadt</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">-&gt;</span> 
            <span class="n">let</span> <span class="n">body</span> <span class="o">=</span>
                <span class="k">match</span> <span class="n">body</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">RawTUnion</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">find</span> <span class="n">name</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">snd</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: Expected an union."</span>
            <span class="n">let</span> <span class="n">is_stack</span> <span class="o">=</span> <span class="n">b</span> <span class="o">=</span> <span class="n">UStack</span>

            <span class="o">//</span> <span class="n">Makes</span> <span class="n">sure</span> <span class="n">that</span> <span class="n">the</span> <span class="n">GADT</span> <span class="n">constructor</span> <span class="ow">is</span> <span class="n">resulting</span> <span class="ow">in</span> <span class="n">its</span> <span class="n">own</span> <span class="nb">type</span><span class="o">.</span>
            <span class="o">//</span> <span class="n">Also</span> <span class="n">make</span> <span class="n">sure</span> <span class="n">that</span> <span class="n">it</span><span class="s1">'s not using an instance of itself in its constructor other than in first position.</span>
            <span class="n">let</span> <span class="n">rec</span> <span class="n">assert_gadt_has_proper_specialized_constructor</span> <span class="o">=</span> <span class="n">function</span>
                <span class="o">|</span> <span class="n">TyNominal</span> <span class="n">global_id</span><span class="s1">' -&gt; if global_id &lt;&gt; global_id'</span> <span class="n">then</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">range_of_texpr_gadt_constructor</span> <span class="n">body</span><span class="p">,</span> <span class="n">IncorrectGADTConstructorType</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">TyApply</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> 
                    <span class="n">assert_gadt_has_proper_specialized_constructor</span> <span class="n">a</span>
                    <span class="k">if</span> <span class="n">is_stack</span> <span class="n">then</span> <span class="n">assert_nominal_non_recursive</span> <span class="n">b</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">range_of_texpr_gadt_constructor</span> <span class="n">body</span><span class="p">,</span> <span class="n">IncorrectGADTConstructorType</span><span class="p">)</span>

            <span class="n">let</span> <span class="n">assert_gadt_is_valid</span> <span class="n">v</span> <span class="o">=</span>
                <span class="n">let</span> <span class="n">rec</span> <span class="n">find_gadt_constructor</span> <span class="n">outside_foralls</span> <span class="o">=</span> <span class="n">function</span>
                    <span class="o">|</span> <span class="n">TyForall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">find_gadt_constructor</span> <span class="p">(</span><span class="n">Set</span><span class="o">.</span><span class="n">add</span> <span class="n">n</span><span class="o">.</span><span class="n">name</span> <span class="n">outside_foralls</span><span class="p">)</span> <span class="n">t</span>
                    <span class="o">|</span> <span class="n">TyFun</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> 
                        <span class="k">if</span> <span class="n">is_stack</span> <span class="n">then</span> <span class="n">assert_nominal_non_recursive</span> <span class="n">a</span>
                        <span class="n">assert_gadt_has_proper_specialized_constructor</span> <span class="n">b</span>
                        <span class="n">assert_foralls_used</span> <span class="n">errors</span> <span class="p">(</span><span class="n">range_of_texpr_gadt_body</span> <span class="n">body</span><span class="p">)</span> <span class="n">a</span>
                        <span class="n">assert_foralls_used</span><span class="s1">' errors outside_foralls (range_of_texpr_gadt_constructor body) b</span>
                    <span class="o">|</span> <span class="n">b</span> <span class="o">-&gt;</span>
                        <span class="n">assert_gadt_has_proper_specialized_constructor</span> <span class="n">b</span>
                        <span class="n">assert_foralls_used</span><span class="s1">' errors outside_foralls (range_of_texpr_gadt_constructor body) b</span>
                        
                <span class="n">find_gadt_constructor</span> <span class="n">Set</span><span class="o">.</span><span class="n">empty</span> <span class="n">v</span>
                    
            <span class="k">if</span> <span class="n">is_gadt</span> <span class="n">then</span> <span class="n">assert_gadt_is_valid</span> <span class="n">v</span>
            <span class="k">else</span>
                <span class="k">if</span> <span class="n">is_stack</span> <span class="n">then</span> <span class="n">assert_nominal_non_recursive</span> <span class="n">v</span>
                <span class="n">assert_foralls_used</span> <span class="n">errors</span> <span class="p">(</span><span class="n">range_of_texpr</span> <span class="n">body</span><span class="p">)</span> <span class="n">v</span> <span class="o">//</span> <span class="n">We</span> <span class="n">need</span> <span class="n">to</span> <span class="k">assert</span> <span class="n">that</span> <span class="n">the</span> <span class="n">foralls</span> <span class="ow">in</span> <span class="n">regular</span> <span class="n">union</span> <span class="n">bodies</span> <span class="n">are</span> <span class="n">checked</span><span class="o">.</span>
            <span class="p">)</span>
    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span>
        <span class="n">assert_nominal_non_recursive</span> <span class="n">v</span>

<span class="n">let</span> <span class="n">rec</span> <span class="n">kind_to_rawkind</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">TT</span><span class="p">)</span> <span class="p">:</span> <span class="n">RawKindExpr</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">visit_tt</span> <span class="n">x</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">KindMetavar</span> <span class="n">_</span> <span class="o">|</span> <span class="n">KindType</span> <span class="o">-&gt;</span> <span class="n">RawKindStar</span>
    <span class="o">|</span> <span class="n">KindFun</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawKindFun</span><span class="p">(</span><span class="n">kind_to_rawkind</span> <span class="n">a</span><span class="p">,</span> <span class="n">kind_to_rawkind</span> <span class="n">b</span><span class="p">)</span>
    
<span class="n">let</span> <span class="n">var_to_hovar</span> <span class="n">r</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">Var</span><span class="p">)</span> <span class="p">:</span> <span class="n">HoVar</span> <span class="o">=</span> <span class="n">r</span><span class="p">,(</span><span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">kind_to_rawkind</span> <span class="n">x</span><span class="o">.</span><span class="n">kind</span><span class="p">)</span>
<span class="n">let</span> <span class="n">var_to_typevar</span> <span class="n">r</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">Var</span><span class="p">)</span> <span class="p">:</span> <span class="n">TypeVar</span> <span class="o">=</span> <span class="n">var_to_hovar</span> <span class="n">r</span> <span class="n">x</span><span class="p">,</span> <span class="p">[]</span> <span class="o">//</span> <span class="n">In</span> <span class="n">the</span> <span class="n">bottom</span> <span class="n">up</span> <span class="n">segment</span> <span class="n">the</span> <span class="n">constrains</span> <span class="n">aren</span><span class="s1">'t checked anywhere so we'</span><span class="n">ll</span> <span class="n">put</span> <span class="n">an</span> <span class="n">empty</span> <span class="nb">list</span> <span class="n">here</span><span class="o">.</span>

<span class="n">let</span> <span class="n">infer</span> <span class="n">package_id</span> <span class="n">module_id</span> <span class="p">(</span><span class="n">top_env</span><span class="s1">' : TopEnv) expr =</span>
    <span class="n">let</span> <span class="n">at_tag</span> <span class="n">i</span> <span class="o">=</span> <span class="p">{</span><span class="n">package_id</span><span class="o">=</span><span class="n">package_id</span><span class="p">;</span> <span class="n">module_id</span><span class="o">=</span><span class="n">module_id</span><span class="p">;</span> <span class="n">tag</span><span class="o">=</span><span class="n">i</span><span class="p">}</span>
    <span class="n">let</span> <span class="n">mutable</span> <span class="n">top_env</span> <span class="o">=</span> <span class="n">top_env</span><span class="s1">' // Is mutated only in two places at the top level. During actual inference can otherwise be thought of as immutable.</span>
    <span class="n">let</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">ResizeArray</span><span class="p">()</span>
    <span class="n">let</span> <span class="n">generalized_statements</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Reference</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">type_apply_args</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Reference</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">module_type_apply_args</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Reference</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">annotations</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="n">obj</span><span class="p">,</span><span class="n">_</span><span class="o">&gt;</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Reference</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">exists_vars</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="n">obj</span><span class="p">,</span><span class="n">_</span><span class="o">&gt;</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Reference</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">gadt_typecases</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="n">obj</span><span class="p">,</span><span class="n">_</span><span class="o">&gt;</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Reference</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">mutable</span> <span class="n">autogened_forallvar_count_in_typecase</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">let</span> <span class="n">mutable</span> <span class="n">autogened_forallvar_count_in_funs</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">let</span> <span class="n">hover_types</span> <span class="o">=</span> <span class="n">HoverTypes</span><span class="p">()</span>

    <span class="o">///</span> <span class="n">Fills</span> <span class="ow">in</span> <span class="n">the</span> <span class="nb">type</span> <span class="n">applies</span> <span class="ow">and</span> <span class="n">annotations</span><span class="p">,</span> <span class="ow">and</span> <span class="n">generalizes</span> <span class="n">statements</span><span class="o">.</span> <span class="n">Also</span> <span class="n">strips</span> <span class="n">annotations</span> <span class="kn">from</span> <span class="nn">terms</span> <span class="ow">and</span> <span class="n">patterns</span><span class="o">.</span>
    <span class="o">///</span> <span class="n">Dealing</span> <span class="k">with</span> <span class="n">recursive</span> <span class="n">statement</span> <span class="nb">type</span> <span class="n">applies</span> <span class="n">requires</span> <span class="n">some</span> <span class="n">special</span> <span class="n">consideration</span><span class="o">.</span>
    <span class="n">let</span> <span class="n">fill</span> <span class="n">r</span> <span class="n">rec_term</span> <span class="n">expr</span> <span class="o">=</span>
        <span class="k">assert</span> <span class="p">(</span><span class="mi">0</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">Count</span><span class="p">)</span>
        <span class="n">let</span> <span class="n">t_to_rawtexpr</span> <span class="n">r</span> <span class="n">vars_to_metavars</span> <span class="n">expr</span> <span class="o">=</span>
            <span class="n">let</span> <span class="n">rec</span> <span class="n">f</span> <span class="n">x</span> <span class="o">=</span>
                <span class="k">match</span> <span class="n">visit_t</span> <span class="n">x</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">TyUnion</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyMetavar</span> <span class="n">_</span>  <span class="o">|</span> <span class="n">TyInl</span> <span class="n">_</span>  <span class="o">|</span> <span class="n">TyModule</span> <span class="n">_</span> <span class="k">as</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">failwithf</span> <span class="s2">"Compiler error: These cases should not appear in fill.</span><span class="se">\n</span><span class="s2">Got: %A"</span> <span class="n">x</span>
                <span class="o">|</span> <span class="n">TyForall</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawTForall</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">var_to_typevar</span> <span class="n">r</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">TyComment</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">x</span>
                <span class="o">|</span> <span class="n">TyB</span> <span class="o">-&gt;</span> <span class="n">RawTB</span> <span class="n">r</span>
                <span class="o">|</span> <span class="n">TyLit</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">RawTLit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">TyPrim</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">RawTPrim</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">TySymbol</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">RawTSymbol</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">TyPair</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawTPair</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">TyRecord</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">RawTRecord</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">Map</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="n">l</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">TyFun</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawTFun</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">TyExists</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawTExists</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">n</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">n</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">RawKindWildcard</span><span class="p">)),[]),</span> <span class="n">f</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">TyArray</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">RawTArray</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">TyNominal</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">RawTFilledNominal</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">TyApply</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawTApply</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">TyVar</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> 
                    <span class="n">let</span> <span class="n">is_typecase_metavar</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">tryFind</span> <span class="p">(</span><span class="n">function</span> <span class="n">TyVar</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="o">=</span> <span class="n">b</span> <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: Expected a TyVar."</span><span class="p">)</span> <span class="n">vars_to_metavars</span> <span class="o">|&gt;</span> <span class="n">Option</span><span class="o">.</span><span class="n">isSome</span>
                    <span class="k">if</span> <span class="n">is_typecase_metavar</span> <span class="n">then</span> <span class="n">RawTMetaVar</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">else</span> <span class="n">RawTVar</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">TyMacro</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">l</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">function</span> <span class="n">TMText</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">RawMacroText</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">|</span> <span class="n">TMVar</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">RawMacroType</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">x</span><span class="p">)</span> <span class="o">|</span> <span class="n">TMLitVar</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">RawMacroTypeLit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">x</span><span class="p">))</span> <span class="o">|&gt;</span> <span class="n">fun</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">RawTMacro</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">l</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">TyLayout</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawTLayout</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
            <span class="n">f</span> <span class="n">expr</span>
        <span class="n">let</span> <span class="n">annot</span> <span class="n">r</span> <span class="n">x</span> <span class="o">=</span> <span class="n">t_to_rawtexpr</span> <span class="n">r</span> <span class="p">[]</span> <span class="p">(</span><span class="n">snd</span> <span class="n">annotations</span><span class="o">.</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
        <span class="n">let</span> <span class="n">rec</span> <span class="n">fill_typecases</span> <span class="n">rec_term</span> <span class="n">x</span> <span class="o">=</span>
            <span class="k">match</span> <span class="n">gadt_typecases</span><span class="o">.</span><span class="n">TryGetValue</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">true</span><span class="p">,</span> <span class="n">typecase_data</span> <span class="o">-&gt;</span>
                <span class="n">Seq</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">typecase_cond</span><span class="p">,</span><span class="n">forall_vars</span><span class="p">,</span><span class="n">typecase_constructor</span><span class="p">)</span> <span class="n">typecase_body</span> <span class="o">-&gt;</span>
                    <span class="n">let</span> <span class="n">r</span> <span class="o">=</span> <span class="n">range_of_expr</span> <span class="n">typecase_body</span>
                    <span class="n">RawTypecase</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">t_to_rawtexpr</span> <span class="n">r</span> <span class="p">[]</span> <span class="n">typecase_cond</span><span class="p">,</span> <span class="p">[</span><span class="n">t_to_rawtexpr</span> <span class="n">r</span> <span class="n">forall_vars</span> <span class="n">typecase_constructor</span><span class="p">,</span> <span class="n">typecase_body</span><span class="p">])</span>
                    <span class="p">)</span> <span class="n">typecase_data</span> <span class="p">(</span><span class="n">term</span> <span class="n">rec_term</span> <span class="n">x</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span>
                <span class="n">term</span> <span class="n">rec_term</span> <span class="n">x</span>
        <span class="ow">and</span> <span class="n">fill_foralls</span> <span class="n">r</span> <span class="n">rec_term</span> <span class="n">body</span> <span class="o">=</span> 
            <span class="n">let</span> <span class="n">_</span><span class="p">,</span><span class="n">body</span> <span class="o">=</span> <span class="n">foralls_get</span> <span class="n">body</span>
            <span class="n">let</span> <span class="n">l</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">foralls_ty_get</span> <span class="n">generalized_statements</span><span class="o">.</span><span class="p">[</span><span class="n">body</span><span class="p">]</span>
            <span class="n">List</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">Var</span><span class="p">)</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">RawFilledForall</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">s</span><span class="p">))</span> <span class="n">l</span> <span class="p">(</span><span class="n">term</span> <span class="n">rec_term</span> <span class="n">body</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">term</span> <span class="n">rec_term</span> <span class="n">x</span> <span class="o">=</span>
            <span class="n">let</span> <span class="n">f</span> <span class="o">=</span> <span class="n">term</span> <span class="n">rec_term</span>
            <span class="n">let</span> <span class="n">clauses</span> <span class="n">l</span> <span class="o">=</span> 
                <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> 
                    <span class="n">let</span> <span class="n">rec_term</span><span class="p">,</span><span class="n">a</span> <span class="o">=</span> <span class="n">pattern</span> <span class="n">rec_term</span> <span class="n">a</span> 
                    <span class="n">a</span><span class="p">,</span><span class="n">fill_typecases</span> <span class="n">rec_term</span> <span class="n">b</span>
                    <span class="p">)</span> <span class="n">l</span>
            <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">RawFilledForall</span> <span class="n">_</span> <span class="o">|</span> <span class="n">RawMissingBody</span> <span class="n">_</span> <span class="o">|</span> <span class="n">RawType</span> <span class="n">_</span> <span class="k">as</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">failwithf</span> <span class="s2">"Compiler error: These cases should not appear in fill. It is intended to be called on top level statements only.</span><span class="se">\n</span><span class="s2">Got: %A"</span> <span class="n">x</span>
            <span class="o">|</span> <span class="n">RawTypecase</span> <span class="n">_</span>
            <span class="o">|</span> <span class="n">RawSymbol</span> <span class="n">_</span> <span class="o">|</span> <span class="n">RawB</span> <span class="n">_</span> <span class="o">|</span> <span class="n">RawLit</span> <span class="n">_</span> <span class="o">|</span> <span class="n">RawOp</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">x</span>
            <span class="o">|</span> <span class="n">RawReal</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">x</span>
            <span class="o">|</span> <span class="n">RawV</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">false</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">x</span>
            <span class="o">|</span> <span class="n">RawV</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">true</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">type_apply_args</span><span class="o">.</span><span class="n">TryGetValue</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">true</span><span class="p">,</span> <span class="n">type_apply_args</span> <span class="o">-&gt;</span>
                    <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">n</span> <span class="n">rec_term</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">fst</span> <span class="n">type_apply_args</span>
                    <span class="o">|</span> <span class="n">Some</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">t</span> <span class="o">|&gt;</span> <span class="n">snd</span> <span class="n">type_apply_args</span>
                    <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">RawApply</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">RawType</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">t_to_rawtexpr</span> <span class="n">r</span> <span class="p">[]</span> <span class="n">x</span><span class="p">)))</span> <span class="n">x</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">x</span>
            <span class="o">|</span> <span class="n">RawDefaultLit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawAnnot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">annot</span> <span class="n">r</span> <span class="n">x</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">RawForall</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawForall</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">RawMatch</span><span class="p">(</span><span class="sa">r</span><span class="s1">''</span><span class="p">,(</span><span class="n">RawForall</span> <span class="n">_</span> <span class="o">|</span> <span class="n">RawFun</span> <span class="n">_</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">body</span><span class="p">,[</span><span class="n">PatVar</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">name</span><span class="p">),</span> <span class="n">on_succ</span><span class="p">])</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">_</span><span class="p">,</span><span class="n">body</span> <span class="o">=</span> <span class="n">foralls_get</span> <span class="n">body</span>
                <span class="n">RawMatch</span><span class="p">(</span><span class="sa">r</span><span class="s1">''</span><span class="p">,</span><span class="n">fill_foralls</span> <span class="n">r</span> <span class="n">rec_term</span> <span class="n">body</span><span class="p">,[</span><span class="n">PatVar</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">name</span><span class="p">),</span> <span class="n">fill_typecases</span> <span class="p">(</span><span class="n">Map</span><span class="o">.</span><span class="n">remove</span> <span class="n">name</span> <span class="n">rec_term</span><span class="p">)</span> <span class="n">on_succ</span><span class="p">])</span>
            <span class="o">|</span> <span class="n">RawMatch</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawMatch</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">clauses</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">RawFun</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawAnnot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">RawFun</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">clauses</span> <span class="n">a</span><span class="p">),</span><span class="n">annot</span> <span class="n">r</span> <span class="n">x</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">RawExists</span><span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="sa">r</span><span class="s1">',a),b) -&gt; RawExists(r,(r'</span><span class="p">,</span><span class="n">Some</span><span class="p">(</span><span class="n">Option</span><span class="o">.</span><span class="n">defaultWith</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">t_to_rawtexpr</span> <span class="n">r</span> <span class="p">[])</span> <span class="n">exists_vars</span><span class="o">.</span><span class="p">[</span><span class="n">x</span><span class="p">])</span> <span class="n">a</span><span class="p">)),</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">RawRecBlock</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">on_succ</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">has_foralls</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">exists</span> <span class="p">(</span><span class="n">function</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">RawForall</span> <span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">true</span> <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">false</span><span class="p">)</span> <span class="n">l</span>
                <span class="k">if</span> <span class="n">has_foralls</span> <span class="n">then</span> <span class="n">RawRecBlock</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="p">,</span> <span class="n">f</span> <span class="n">b</span><span class="p">)</span> <span class="n">l</span><span class="p">,</span><span class="n">f</span> <span class="n">on_succ</span><span class="p">)</span>
                <span class="k">else</span>
                    <span class="n">let</span> <span class="n">rec_term</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="p">((</span><span class="n">_</span><span class="p">,</span><span class="n">name</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">name</span> <span class="n">generalized_statements</span><span class="o">.</span><span class="p">[</span><span class="n">foralls_get</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">snd</span><span class="p">]</span> <span class="n">s</span><span class="p">)</span> <span class="n">rec_term</span> <span class="n">l</span>
                    <span class="n">let</span> <span class="n">l</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="p">,</span> <span class="n">fill_foralls</span> <span class="p">(</span><span class="n">fst</span> <span class="n">a</span><span class="p">)</span> <span class="n">rec_term</span> <span class="n">b</span><span class="p">)</span> <span class="n">l</span>
                    <span class="n">RawRecBlock</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">f</span> <span class="n">on_succ</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">RawRecordWith</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">function</span>
                    <span class="o">|</span> <span class="n">RawRecordWithSymbol</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawRecordWithSymbol</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
                    <span class="o">|</span> <span class="n">RawRecordWithSymbolModify</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawRecordWithSymbolModify</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
                    <span class="o">|</span> <span class="n">RawRecordWithInjectVar</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawRecordWithInjectVar</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
                    <span class="o">|</span> <span class="n">RawRecordWithInjectVarModify</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawRecordWithInjectVarModify</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">RawRecordWith</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">RawJoinPoint</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawAnnot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">RawJoinPoint</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">),</span><span class="n">annot</span> <span class="n">r</span> <span class="n">x</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">RawAnnot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span>
            <span class="o">|</span> <span class="n">RawOpen</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">f</span> <span class="o">=</span> <span class="n">function</span> <span class="n">TyModule</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span> <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: Module open should always succeed in fill."</span>
                <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">f</span> <span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="p">[</span><span class="n">snd</span> <span class="n">x</span><span class="p">])</span> <span class="n">top_env</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="p">[</span><span class="n">snd</span> <span class="n">a</span><span class="p">]</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">f</span>
                <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">k</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">remove</span> <span class="n">k</span> <span class="n">s</span><span class="p">)</span> <span class="n">rec_term</span>
                <span class="o">|&gt;</span> <span class="n">fun</span> <span class="n">rec_term</span> <span class="o">-&gt;</span> <span class="n">RawOpen</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">term</span> <span class="n">rec_term</span> <span class="n">c</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">RawApply</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">q</span> <span class="o">=</span> <span class="n">RawApply</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
                <span class="k">match</span> <span class="n">module_type_apply_args</span><span class="o">.</span><span class="n">TryGetValue</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">true</span><span class="p">,</span> <span class="n">typevars</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">a</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">RawApply</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">RawType</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">t_to_rawtexpr</span> <span class="n">r</span> <span class="p">[]</span> <span class="n">b</span><span class="p">)))</span> <span class="n">q</span> <span class="n">typevars</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">q</span>
            <span class="o">|</span> <span class="n">RawIfThenElse</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawIfThenElse</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">,</span><span class="n">f</span> <span class="n">c</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">RawIfThen</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawIfThen</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">RawPair</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawPair</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">RawSeq</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawSeq</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">RawHeapMutableSet</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawHeapMutableSet</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="n">f</span> <span class="n">b</span><span class="p">,</span><span class="n">f</span> <span class="n">c</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">RawMacro</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">l</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">l</span> <span class="o">=</span> <span class="n">l</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">function</span> <span class="n">RawMacroTerm</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawMacroTerm</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">x</span><span class="p">)</span> <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="p">)</span>
                <span class="n">RawAnnot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">RawMacro</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">l</span><span class="p">),</span><span class="n">annot</span> <span class="n">r</span> <span class="n">x</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">RawArray</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawAnnot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">RawArray</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="n">f</span> <span class="n">a</span><span class="p">),</span><span class="n">annot</span> <span class="n">r</span> <span class="n">x</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">pattern</span> <span class="n">rec_term</span> <span class="n">x</span><span class="s1">' =</span>
            <span class="n">let</span> <span class="n">mutable</span> <span class="n">rec_term</span> <span class="o">=</span> <span class="n">rec_term</span>
            <span class="n">let</span> <span class="n">rec</span> <span class="n">f</span> <span class="o">=</span> <span class="n">function</span>
                <span class="o">|</span> <span class="n">PatFilledDefaultValue</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: PatDefaultValueFilled should not appear in fill."</span>
                <span class="o">|</span> <span class="n">PatValue</span> <span class="n">_</span> <span class="o">|</span> <span class="n">PatSymbol</span> <span class="n">_</span> <span class="o">|</span> <span class="n">PatE</span> <span class="n">_</span> <span class="o">|</span> <span class="n">PatB</span> <span class="n">_</span> <span class="k">as</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span>
                <span class="o">|</span> <span class="n">PatVar</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">name</span><span class="p">)</span> <span class="k">as</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">rec_term</span> <span class="o">&lt;-</span> <span class="n">Map</span><span class="o">.</span><span class="n">remove</span> <span class="n">name</span> <span class="n">rec_term</span><span class="p">;</span> <span class="n">x</span>
                <span class="o">|</span> <span class="n">PatDyn</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PatDyn</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">PatUnbox</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PatUnbox</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">PatExists</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PatExists</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">PatAnnot</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span>
                <span class="o">|</span> <span class="n">PatPair</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PatPair</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">PatRecordMembers</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span>
                    <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">function</span>
                        <span class="o">|</span> <span class="n">PatRecordMembersSymbol</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PatRecordMembersSymbol</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
                        <span class="o">|</span> <span class="n">PatRecordMembersInjectVar</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PatRecordMembersInjectVar</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="n">PatRecordMembers</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">PatOr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PatOr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">PatAnd</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PatAnd</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">PatDefaultValue</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="k">as</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">PatFilledDefaultValue</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">annot</span> <span class="n">r</span> <span class="n">x</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">PatWhen</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PatWhen</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">term</span> <span class="n">rec_term</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">PatNominal</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PatNominal</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">f</span> <span class="n">c</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">PatArray</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PatArray</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="n">f</span> <span class="n">a</span><span class="p">)</span>
            <span class="n">rec_term</span><span class="p">,</span> <span class="n">f</span> <span class="n">x</span><span class="s1">'</span>

        <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">fill_foralls</span> <span class="n">r</span> <span class="n">rec_term</span> <span class="n">expr</span>
        <span class="k">assert</span> <span class="p">(</span><span class="mi">0</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">Count</span><span class="p">)</span>
        <span class="n">x</span>

    <span class="n">let</span> <span class="n">fresh_kind</span> <span class="p">()</span> <span class="o">=</span> <span class="n">KindMetavar</span> <span class="p">{</span><span class="n">contents</span><span class="s1">'=None}</span>
    <span class="n">let</span> <span class="n">fresh_var</span><span class="s1">''</span> <span class="n">x</span> <span class="o">=</span> <span class="n">TyMetavar</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ref</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">fresh_var</span><span class="s1">' scope kind = fresh_var'' {scope=scope; constraints=Set.empty; kind=kind}</span>
    <span class="n">let</span> <span class="n">fresh_subst_var</span> <span class="n">scope</span> <span class="n">cons</span> <span class="n">kind</span> <span class="o">=</span> <span class="n">fresh_var</span><span class="s1">''</span> <span class="p">{</span><span class="n">scope</span><span class="o">=</span><span class="n">scope</span><span class="p">;</span> <span class="n">constraints</span><span class="o">=</span><span class="n">cons</span><span class="p">;</span> <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">}</span>
    <span class="n">let</span> <span class="n">forall_subst_all</span> <span class="n">scope</span> <span class="n">x</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="n">m</span> <span class="n">x</span> <span class="o">=</span>
            <span class="k">match</span> <span class="n">visit_t</span> <span class="n">x</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">TyForall</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">v</span> <span class="o">=</span> <span class="n">fresh_subst_var</span> <span class="n">scope</span> <span class="n">a</span><span class="o">.</span><span class="n">constraints</span> <span class="n">a</span><span class="o">.</span><span class="n">kind</span>
                <span class="n">let</span> <span class="n">type_apply_args</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="n">loop</span> <span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="p">::</span> <span class="n">m</span><span class="p">)</span> <span class="n">b</span>
                <span class="n">v</span> <span class="p">::</span> <span class="n">type_apply_args</span><span class="p">,</span> <span class="n">b</span>
            <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="p">[],</span> <span class="n">subst</span> <span class="n">m</span> <span class="n">x</span>
        <span class="n">loop</span> <span class="p">[]</span> <span class="n">x</span>

    <span class="n">let</span> <span class="n">exists_subst_term</span> <span class="n">scope</span> <span class="p">(</span><span class="n">l</span> <span class="p">:</span> <span class="n">Var</span> <span class="nb">list</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span> <span class="o">=</span>
        <span class="n">let</span> <span class="nb">vars</span> <span class="o">=</span> <span class="n">l</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">fresh_subst_var</span> <span class="n">scope</span> <span class="n">a</span><span class="o">.</span><span class="n">constraints</span> <span class="n">a</span><span class="o">.</span><span class="n">kind</span><span class="p">)</span>
        <span class="nb">vars</span><span class="p">,</span> <span class="n">subst</span> <span class="p">(</span><span class="n">List</span><span class="o">.</span><span class="n">zip</span> <span class="n">l</span> <span class="nb">vars</span><span class="p">)</span> <span class="n">body</span>

    <span class="n">let</span> <span class="n">assert_exists_hasnt_metavars</span> <span class="n">r</span> <span class="nb">vars</span> <span class="o">=</span>
        <span class="k">if</span> <span class="n">List</span><span class="o">.</span><span class="n">exists</span> <span class="n">has_metavars</span> <span class="nb">vars</span> <span class="n">then</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ExistsShouldntHaveMetavars</span> <span class="nb">vars</span><span class="p">)</span>

    <span class="n">let</span> <span class="n">generalize</span> <span class="n">r</span> <span class="n">scope</span> <span class="p">(</span><span class="n">forall_vars</span> <span class="p">:</span> <span class="n">Var</span> <span class="nb">list</span><span class="p">)</span> <span class="p">(</span><span class="n">body</span> <span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">h</span> <span class="o">=</span> <span class="n">HashSet</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Reference</span><span class="p">)</span>
        <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">Add</span> <span class="o">&gt;&gt;</span> <span class="n">ignore</span><span class="p">)</span> <span class="n">forall_vars</span>
        <span class="n">let</span> <span class="n">generalized_metavars</span> <span class="o">=</span> <span class="n">ResizeArray</span><span class="p">()</span>
        <span class="n">let</span> <span class="n">rec</span> <span class="n">replace_metavars</span> <span class="n">x</span> <span class="o">=</span>
            <span class="n">let</span> <span class="n">f</span> <span class="o">=</span> <span class="n">replace_metavars</span>
            <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">TyVar</span> <span class="p">(</span><span class="n">_</span><span class="p">,{</span><span class="n">contents</span><span class="o">=</span><span class="n">Some</span> <span class="n">x</span><span class="p">})</span>
            <span class="o">|</span> <span class="n">TyMetavar</span><span class="p">(</span><span class="n">_</span><span class="p">,{</span><span class="n">contents</span><span class="o">=</span><span class="n">Some</span> <span class="n">x</span><span class="p">})</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">x</span>
            <span class="o">|</span> <span class="n">TyMetavar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span> <span class="n">when</span> <span class="n">scope</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">scope</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">v</span> <span class="o">=</span> <span class="n">tyvar</span> <span class="p">{</span><span class="n">scope</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">scope</span><span class="p">;</span> <span class="n">constraints</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">constraints</span><span class="p">;</span> <span class="n">kind</span><span class="o">=</span><span class="n">kind_force</span> <span class="n">x</span><span class="o">.</span><span class="n">kind</span><span class="p">;</span> <span class="n">name</span><span class="o">=</span><span class="n">autogen_name_in_fun</span> <span class="n">autogened_forallvar_count_in_funs</span><span class="p">}</span>
                <span class="n">autogened_forallvar_count_in_funs</span> <span class="o">&lt;-</span> <span class="n">autogened_forallvar_count_in_funs</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">link</span><span class="o">.</span><span class="n">Value</span> <span class="o">&lt;-</span> <span class="n">Some</span> <span class="n">v</span>
                <span class="n">replace_metavars</span> <span class="n">v</span>
            <span class="o">//</span> <span class="n">This</span> <span class="n">scheme</span> <span class="k">with</span> <span class="n">the</span> <span class="n">HashSet</span> <span class="ow">is</span> <span class="n">so</span> <span class="n">generalize</span> <span class="n">works</span> <span class="k">for</span> <span class="n">mutually</span> <span class="n">recursive</span> <span class="n">statements</span><span class="o">.</span>
            <span class="o">|</span> <span class="n">TyVar</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">scope</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">scope</span> <span class="o">&amp;&amp;</span> <span class="n">h</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="n">then</span> <span class="n">generalized_metavars</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">TyMetavar</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyNominal</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyB</span> <span class="o">|</span> <span class="n">TyLit</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyPrim</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TySymbol</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="p">()</span>
            <span class="o">|</span> <span class="n">TyPair</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyApply</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyFun</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span><span class="p">;</span> <span class="n">f</span> <span class="n">b</span>
            <span class="o">|</span> <span class="n">TyUnion</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">snd</span> <span class="o">&gt;&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="n">a</span>
            <span class="o">|</span> <span class="n">TyRecord</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="n">a</span>
            <span class="o">|</span> <span class="n">TyExists</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">Add</span> <span class="o">&gt;&gt;</span> <span class="n">ignore</span><span class="p">)</span> <span class="n">v</span><span class="p">;</span> <span class="n">f</span> <span class="n">a</span>
            <span class="o">|</span> <span class="n">TyForall</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">Add</span> <span class="o">&gt;&gt;</span> <span class="n">ignore</span><span class="p">)</span> <span class="n">v</span><span class="p">;</span> <span class="n">f</span> <span class="n">a</span>
            <span class="o">|</span> <span class="n">TyComment</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyLayout</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyArray</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span>
            <span class="o">|</span> <span class="n">TyMacro</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">function</span> <span class="n">TMLitVar</span> <span class="n">a</span> <span class="o">|</span> <span class="n">TMVar</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span> <span class="o">|</span> <span class="n">TMText</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="p">())</span> <span class="n">a</span>
            <span class="o">|</span> <span class="n">TyModule</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyInl</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="p">()</span>

        <span class="n">let</span> <span class="n">f</span> <span class="n">x</span> <span class="n">s</span> <span class="o">=</span> <span class="n">TyForall</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
        <span class="n">replace_metavars</span> <span class="n">body</span>
        <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">Seq</span><span class="o">.</span><span class="n">foldBack</span> <span class="n">f</span> <span class="n">generalized_metavars</span> <span class="n">body</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">foldBack</span> <span class="n">f</span> <span class="n">forall_vars</span> <span class="o">|&gt;</span> <span class="n">term_subst</span>
        <span class="k">if</span> <span class="n">List</span><span class="o">.</span><span class="n">isEmpty</span> <span class="n">forall_vars</span> <span class="o">=</span> <span class="n">false</span> <span class="n">then</span> <span class="n">assert_foralls_used</span> <span class="n">errors</span> <span class="n">r</span> <span class="n">x</span>
        <span class="n">x</span>

    <span class="n">let</span> <span class="n">gadt_extract</span> <span class="n">scope</span> <span class="p">(</span><span class="n">v</span> <span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">forall_subst_all_gadt</span> <span class="n">x</span> <span class="o">=</span>
            <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="n">m</span> <span class="n">x</span> <span class="o">=</span> 
                <span class="k">match</span> <span class="n">visit_t</span> <span class="n">x</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">TyForall</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
                    <span class="n">let</span> <span class="n">v</span> <span class="o">=</span> <span class="n">tyvar</span> <span class="p">{</span><span class="n">a</span> <span class="k">with</span> <span class="n">name</span><span class="o">=</span><span class="n">autogen_name_in_typecase</span> <span class="n">autogened_forallvar_count_in_typecase</span><span class="p">;</span> <span class="n">scope</span><span class="o">=</span><span class="n">scope</span><span class="p">}</span>
                    <span class="n">autogened_forallvar_count_in_typecase</span> <span class="o">&lt;-</span> <span class="n">autogened_forallvar_count_in_typecase</span><span class="o">+</span><span class="mi">1</span>
                    <span class="n">let</span> <span class="n">type_apply_args</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="n">loop</span> <span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="p">::</span> <span class="n">m</span><span class="p">)</span> <span class="n">b</span>
                    <span class="n">v</span> <span class="p">::</span> <span class="n">type_apply_args</span><span class="p">,</span> <span class="n">b</span>
                <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="p">[],</span> <span class="n">subst</span> <span class="n">m</span> <span class="n">x</span>
            <span class="n">loop</span> <span class="p">[]</span> <span class="n">x</span>
        <span class="n">let</span> <span class="n">forall_vars</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">forall_subst_all_gadt</span> <span class="n">v</span>
        <span class="k">match</span> <span class="n">v</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">TyFun</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">forall_vars</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span>
        <span class="o">|</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">forall_vars</span><span class="p">,</span><span class="n">TyB</span><span class="p">,</span><span class="n">b</span>

    <span class="n">let</span> <span class="n">inline</span> <span class="n">unify_kind</span><span class="s1">' er r got expected =</span>
        <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="p">(</span><span class="n">a</span><span class="s1">''</span><span class="p">,</span><span class="sa">b</span><span class="s1">''</span><span class="p">)</span> <span class="o">=</span>
            <span class="k">match</span> <span class="n">visit_tt</span> <span class="n">a</span><span class="s1">''</span><span class="p">,</span> <span class="n">visit_tt</span> <span class="sa">b</span><span class="s1">''</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">KindType</span><span class="p">,</span> <span class="n">KindType</span> <span class="o">-&gt;</span> <span class="p">()</span>
            <span class="o">|</span> <span class="n">KindFun</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">a</span><span class="s1">'), KindFun(b,b'</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">);</span> <span class="n">loop</span> <span class="p">(</span><span class="n">a</span><span class="s1">',b'</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">KindMetavar</span> <span class="n">a</span><span class="p">,</span> <span class="n">KindMetavar</span> <span class="n">b</span> <span class="o">&amp;</span> <span class="sa">b</span><span class="s1">' -&gt; if a &lt;&gt; b then a.contents'</span> <span class="o">&lt;-</span> <span class="n">Some</span> <span class="sa">b</span><span class="s1">'</span>
            <span class="o">|</span> <span class="n">KindMetavar</span> <span class="n">link</span><span class="p">,</span> <span class="n">b</span> <span class="o">|</span> <span class="n">b</span><span class="p">,</span> <span class="n">KindMetavar</span> <span class="n">link</span> <span class="o">-&gt;</span> <span class="n">link</span><span class="o">.</span><span class="n">contents</span><span class="s1">' &lt;- Some b</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="k">raise</span> <span class="p">(</span><span class="n">InferTypeErrorException</span> <span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">er</span> <span class="p">(</span><span class="n">got</span><span class="p">,</span> <span class="n">expected</span><span class="p">)])</span>
        <span class="n">loop</span> <span class="p">(</span><span class="n">got</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">unify_kind</span> <span class="n">r</span> <span class="n">got</span> <span class="n">expected</span> <span class="o">=</span> <span class="k">try</span> <span class="n">unify_kind</span><span class="s1">' KindError r got expected with :? InferTypeErrorException as e -&gt; errors.AddRange e.Data0</span>
    <span class="n">let</span> <span class="n">unify_gadt</span> <span class="p">(</span><span class="n">gadt_links</span> <span class="p">:</span> <span class="n">T</span> <span class="n">option</span> <span class="n">ref</span> <span class="n">ResizeArray</span> <span class="n">option</span><span class="p">)</span> <span class="p">(</span><span class="n">r</span> <span class="p">:</span> <span class="n">VSCRange</span><span class="p">)</span> <span class="p">(</span><span class="n">got</span> <span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="p">(</span><span class="n">expected</span> <span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="p">:</span> <span class="n">unit</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">unify_kind</span> <span class="n">got</span> <span class="n">expected</span> <span class="o">=</span> <span class="n">unify_kind</span><span class="s1">' KindError r got expected</span>
        <span class="n">let</span> <span class="n">er</span> <span class="p">()</span> <span class="o">=</span> <span class="k">raise</span> <span class="p">(</span><span class="n">InferTypeErrorException</span> <span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">TermError</span><span class="p">(</span><span class="n">got</span><span class="p">,</span> <span class="n">expected</span><span class="p">)])</span>

        <span class="n">let</span> <span class="n">rec</span> <span class="n">constraint_process</span> <span class="p">(</span><span class="n">con</span> <span class="p">:</span> <span class="n">Constraint</span> <span class="n">Set</span><span class="p">)</span> <span class="n">b</span> <span class="o">=</span>
            <span class="n">let</span> <span class="n">unify_kind</span> <span class="n">got</span> <span class="n">expected</span> <span class="o">=</span> <span class="n">unify_kind</span><span class="s1">' KindErrorInConstraint r got expected</span>
            <span class="n">let</span> <span class="n">body</span> <span class="o">=</span> <span class="n">function</span>
                <span class="o">|</span> <span class="n">CUInt</span><span class="p">,</span> <span class="n">TyPrim</span> <span class="p">(</span><span class="n">UInt8T</span> <span class="o">|</span> <span class="n">UInt16T</span> <span class="o">|</span> <span class="n">UInt32T</span> <span class="o">|</span> <span class="n">UInt64T</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">CSInt</span><span class="p">,</span> <span class="n">TyPrim</span> <span class="p">(</span><span class="n">Int8T</span> <span class="o">|</span> <span class="n">Int16T</span> <span class="o">|</span> <span class="n">Int32T</span> <span class="o">|</span> <span class="n">Int64T</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">CInt</span><span class="p">,</span> <span class="n">TyPrim</span> <span class="p">(</span><span class="n">UInt8T</span> <span class="o">|</span> <span class="n">UInt16T</span> <span class="o">|</span> <span class="n">UInt32T</span> <span class="o">|</span> <span class="n">UInt64T</span> <span class="o">|</span> <span class="n">Int8T</span> <span class="o">|</span> <span class="n">Int16T</span> <span class="o">|</span> <span class="n">Int32T</span> <span class="o">|</span> <span class="n">Int64T</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">CFloat</span><span class="p">,</span> <span class="n">TyPrim</span> <span class="p">(</span><span class="n">Float32T</span> <span class="o">|</span> <span class="n">Float64T</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">CNumber</span><span class="p">,</span> <span class="n">TyPrim</span> <span class="p">(</span><span class="n">UInt8T</span> <span class="o">|</span> <span class="n">UInt16T</span> <span class="o">|</span> <span class="n">UInt32T</span> <span class="o">|</span> <span class="n">UInt64T</span> <span class="o">|</span> <span class="n">Int8T</span> <span class="o">|</span> <span class="n">Int16T</span> <span class="o">|</span> <span class="n">Int32T</span> <span class="o">|</span> <span class="n">Int64T</span> <span class="o">|</span> <span class="n">Float32T</span> <span class="o">|</span> <span class="n">Float64T</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">CPrim</span><span class="p">,</span> <span class="n">TyPrim</span> <span class="n">_</span>
                <span class="o">|</span> <span class="n">CSymbol</span><span class="p">,</span> <span class="n">TySymbol</span> <span class="n">_</span>
                <span class="o">|</span> <span class="n">CRecord</span><span class="p">,</span> <span class="n">TyRecord</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="p">[]</span>
                <span class="o">|</span> <span class="n">con</span><span class="p">,</span> <span class="n">TyMetavar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">.</span><span class="n">constraints</span> <span class="o">&lt;-</span> <span class="n">Set</span><span class="o">.</span><span class="n">add</span> <span class="n">con</span> <span class="n">x</span><span class="o">.</span><span class="n">constraints</span><span class="p">;</span> <span class="p">[]</span>
                <span class="o">|</span> <span class="n">CPrototype</span> <span class="n">prot</span> <span class="o">&amp;</span> <span class="n">con</span><span class="p">,</span> <span class="n">x</span> <span class="o">-&gt;</span>
                    <span class="k">match</span> <span class="n">type_apply_split</span> <span class="n">x</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">TyNominal</span> <span class="n">ins</span><span class="p">,</span> <span class="n">x</span><span class="s1">' -&gt;</span>
                        <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="p">(</span><span class="n">prot</span><span class="p">,</span><span class="n">ins</span><span class="p">)</span> <span class="n">top_env</span><span class="o">.</span><span class="n">prototypes_instances</span> <span class="k">with</span>
                        <span class="o">|</span> <span class="n">Some</span> <span class="n">cons</span> <span class="o">-&gt;</span>
                            <span class="k">try</span> <span class="n">List</span><span class="o">.</span><span class="n">fold2</span> <span class="p">(</span><span class="n">fun</span> <span class="n">ers</span> <span class="n">con</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">append</span> <span class="p">(</span><span class="n">constraint_process</span> <span class="n">con</span> <span class="p">(</span><span class="n">visit_t</span> <span class="n">x</span><span class="p">))</span> <span class="n">ers</span><span class="p">)</span> <span class="p">[]</span> <span class="n">cons</span> <span class="n">x</span><span class="s1">'</span>
                            <span class="k">with</span> <span class="p">:</span><span class="err">?</span> <span class="n">System</span><span class="o">.</span><span class="n">ArgumentException</span> <span class="o">-&gt;</span> <span class="p">[]</span> <span class="o">//</span> <span class="n">This</span> <span class="n">case</span> <span class="n">can</span> <span class="n">occur</span> <span class="n">due</span> <span class="n">when</span> <span class="n">kind</span> <span class="n">application</span> <span class="n">overflows</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">previous</span> <span class="n">expression</span><span class="o">.</span>
                        <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="n">InstanceNotFound</span><span class="p">(</span><span class="n">prot</span><span class="p">,</span><span class="n">ins</span><span class="p">)]</span>
                    <span class="o">|</span> <span class="n">TyMetavar</span> <span class="n">_</span> <span class="o">&amp;</span> <span class="n">x</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="n">PrototypeConstraintCannotPropagateToMetavar</span><span class="p">(</span><span class="n">prot</span><span class="p">,</span><span class="n">x</span><span class="p">)]</span>
                    <span class="o">|</span> <span class="n">TyVar</span> <span class="n">_</span> <span class="o">&amp;</span> <span class="n">x</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="n">PrototypeConstraintCannotPropagateToVar</span><span class="p">(</span><span class="n">prot</span><span class="p">,</span><span class="n">x</span><span class="p">)]</span>
                    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="n">ConstraintError</span><span class="p">(</span><span class="n">con</span><span class="p">,</span><span class="n">x</span><span class="p">)]</span>
                <span class="o">|</span> <span class="n">con</span><span class="p">,</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="n">ConstraintError</span><span class="p">(</span><span class="n">con</span><span class="p">,</span><span class="n">x</span><span class="p">)]</span>

            <span class="k">match</span> <span class="n">b</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">TyVar</span> <span class="p">(</span><span class="n">_</span><span class="p">,{</span><span class="n">contents</span><span class="o">=</span><span class="n">Some</span> <span class="n">x</span><span class="p">})</span> <span class="o">-&gt;</span> <span class="n">constraint_process</span> <span class="n">con</span> <span class="n">x</span>
            <span class="o">|</span> <span class="n">TyVar</span> <span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">con</span><span class="o">.</span><span class="n">IsSubsetOf</span> <span class="n">b</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="n">false</span> <span class="n">then</span> <span class="p">[</span><span class="n">ForallVarConstraintError</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">con</span><span class="p">,</span><span class="n">b</span><span class="o">.</span><span class="n">constraints</span><span class="p">)]</span> <span class="k">else</span> <span class="p">[]</span>
            <span class="o">|</span> <span class="n">b</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">b_kind</span> <span class="o">=</span> <span class="n">tt</span> <span class="n">top_env</span> <span class="n">b</span>
                <span class="n">Set</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">ers</span> <span class="n">con</span> <span class="o">-&gt;</span>
                    <span class="n">unify_kind</span> <span class="n">b_kind</span> <span class="p">(</span><span class="n">constraint_kind</span> <span class="n">top_env</span> <span class="n">con</span><span class="p">)</span>
                    <span class="n">List</span><span class="o">.</span><span class="n">append</span> <span class="p">(</span><span class="n">body</span> <span class="p">(</span><span class="n">con</span><span class="p">,</span><span class="n">b</span><span class="p">))</span> <span class="n">ers</span>
                    <span class="p">)</span> <span class="p">[]</span> <span class="n">con</span>

        <span class="o">//</span> <span class="n">Does</span> <span class="n">occurs</span> <span class="n">checking</span> <span class="k">for</span> <span class="n">recursive</span> <span class="n">metavariables</span><span class="o">.</span>
        <span class="o">//</span> <span class="n">Does</span> <span class="n">scope</span> <span class="n">checking</span> <span class="ow">in</span> <span class="n">forall</span> <span class="nb">vars</span><span class="o">.</span>
        <span class="n">let</span> <span class="n">validate_mvar_unification</span> <span class="n">i</span> <span class="n">x</span> <span class="o">=</span>
            <span class="n">let</span> <span class="n">nested_tvars</span> <span class="o">=</span> <span class="n">HashSet</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Reference</span><span class="p">)</span>
            <span class="n">let</span> <span class="n">rec</span> <span class="n">f</span> <span class="n">x</span> <span class="o">=</span>
                <span class="k">match</span> <span class="n">visit_t</span> <span class="n">x</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">TyModule</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyNominal</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyB</span> <span class="o">|</span> <span class="n">TyLit</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyPrim</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TySymbol</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="p">()</span>
                <span class="o">|</span> <span class="n">TyMacro</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">function</span> <span class="n">TMText</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="p">()</span> <span class="o">|</span> <span class="n">TMLitVar</span> <span class="n">a</span> <span class="o">|</span> <span class="n">TMVar</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">TyForall</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyInl</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span>
                    <span class="n">let</span> <span class="n">_</span> <span class="o">=</span> <span class="n">nested_tvars</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="n">f</span> <span class="n">a</span>
                    <span class="n">let</span> <span class="n">_</span> <span class="o">=</span> <span class="n">nested_tvars</span><span class="o">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="p">()</span>
                <span class="o">|</span> <span class="n">TyExists</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span>
                    <span class="n">v</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">nested_tvars</span><span class="o">.</span><span class="n">Add</span> <span class="o">&gt;&gt;</span> <span class="n">ignore</span><span class="p">)</span>
                    <span class="n">f</span> <span class="n">a</span>
                    <span class="n">v</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">nested_tvars</span><span class="o">.</span><span class="n">Remove</span> <span class="o">&gt;&gt;</span> <span class="n">ignore</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">TyComment</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyArray</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span>
                <span class="o">|</span> <span class="n">TyApply</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyFun</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyPair</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span><span class="p">;</span> <span class="n">f</span> <span class="n">b</span>
                <span class="o">|</span> <span class="n">TyUnion</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">snd</span> <span class="o">&gt;&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="n">l</span>
                <span class="o">|</span> <span class="n">TyRecord</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="n">l</span>
                <span class="o">|</span> <span class="n">TyVar</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">nested_tvars</span><span class="o">.</span><span class="n">Contains</span> <span class="n">b</span> <span class="o">=</span> <span class="n">false</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">.</span><span class="n">scope</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">.</span><span class="n">scope</span> <span class="n">then</span> <span class="k">raise</span> <span class="p">(</span><span class="n">InferTypeErrorException</span> <span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="n">TypeVarScopeError</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">got</span><span class="p">,</span><span class="n">expected</span><span class="p">)])</span>
                <span class="o">|</span> <span class="n">TyMetavar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">=</span> <span class="n">x</span> <span class="n">then</span> <span class="k">raise</span> <span class="p">(</span><span class="n">InferTypeErrorException</span> <span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="n">RecursiveMetavarsNotAllowed</span><span class="p">(</span><span class="n">got</span><span class="p">,</span><span class="n">expected</span><span class="p">)])</span> <span class="k">elif</span> <span class="n">i</span><span class="o">.</span><span class="n">scope</span> <span class="o">&lt;</span> <span class="n">x</span><span class="o">.</span><span class="n">scope</span> <span class="n">then</span> <span class="n">x</span><span class="o">.</span><span class="n">scope</span> <span class="o">&lt;-</span> <span class="n">i</span><span class="o">.</span><span class="n">scope</span>
                <span class="o">|</span> <span class="n">TyLayout</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span>
            <span class="n">f</span> <span class="n">x</span>

        <span class="o">//</span> <span class="n">Does</span> <span class="n">occurs</span> <span class="n">checking</span> <span class="k">for</span> <span class="n">recursive</span> <span class="nb">type</span> <span class="n">variables</span><span class="o">.</span>
        <span class="n">let</span> <span class="n">rec</span> <span class="n">validate_tvar_unification</span> <span class="n">i</span> <span class="n">x</span> <span class="o">=</span>
            <span class="n">let</span> <span class="n">f</span> <span class="o">=</span> <span class="n">validate_tvar_unification</span> <span class="n">i</span>
            <span class="k">match</span> <span class="n">visit_t</span> <span class="n">x</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">TyMetavar</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyModule</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyNominal</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyB</span> <span class="o">|</span> <span class="n">TyLit</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyPrim</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TySymbol</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="p">()</span>
            <span class="o">|</span> <span class="n">TyMacro</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">function</span> <span class="n">TMText</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="p">()</span> <span class="o">|</span> <span class="n">TMLitVar</span> <span class="n">a</span> <span class="o">|</span> <span class="n">TMVar</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">TyExists</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyComment</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyForall</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyInl</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyArray</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span>
            <span class="o">|</span> <span class="n">TyApply</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyFun</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyPair</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span><span class="p">;</span> <span class="n">f</span> <span class="n">b</span>
            <span class="o">|</span> <span class="n">TyUnion</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">snd</span> <span class="o">&gt;&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="n">l</span>
            <span class="o">|</span> <span class="n">TyRecord</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="n">l</span>
            <span class="o">|</span> <span class="n">TyVar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">=</span> <span class="n">x</span> <span class="n">then</span> <span class="k">raise</span> <span class="p">(</span><span class="n">InferTypeErrorException</span> <span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="n">RecursiveTypevarsNotAllowed</span><span class="p">(</span><span class="n">got</span><span class="p">,</span><span class="n">expected</span><span class="p">)])</span>
            <span class="o">|</span> <span class="n">TyLayout</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span>

        <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="p">(</span><span class="n">a</span><span class="s1">''</span><span class="p">,</span><span class="sa">b</span><span class="s1">''</span><span class="p">)</span> <span class="o">=</span> 
            <span class="k">match</span> <span class="n">visit_t</span> <span class="n">a</span><span class="s1">''</span><span class="p">,</span> <span class="n">visit_t</span> <span class="sa">b</span><span class="s1">''</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">TyComment</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">),</span> <span class="n">b</span> <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="n">TyComment</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">TyMetavar</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">link</span><span class="p">),</span> <span class="n">TyMetavar</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">&amp;</span> <span class="sa">b</span><span class="s1">' -&gt;</span>
                <span class="k">if</span> <span class="n">a</span> <span class="o">&lt;&gt;</span> <span class="n">b</span> <span class="n">then</span>
                    <span class="n">unify_kind</span> <span class="n">a</span><span class="o">.</span><span class="n">kind</span> <span class="n">b</span><span class="o">.</span><span class="n">kind</span>
                    <span class="n">b</span><span class="o">.</span><span class="n">scope</span> <span class="o">&lt;-</span> <span class="nb">min</span> <span class="n">a</span><span class="o">.</span><span class="n">scope</span> <span class="n">b</span><span class="o">.</span><span class="n">scope</span>
                    <span class="n">b</span><span class="o">.</span><span class="n">constraints</span> <span class="o">&lt;-</span> <span class="n">a</span><span class="o">.</span><span class="n">constraints</span> <span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="n">constraints</span>
                    <span class="n">link</span><span class="o">.</span><span class="n">Value</span> <span class="o">&lt;-</span> <span class="n">Some</span> <span class="sa">b</span><span class="s1">'</span>
            <span class="o">|</span> <span class="n">TyMetavar</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">link</span><span class="p">),</span> <span class="n">b</span> <span class="o">|</span> <span class="n">b</span><span class="p">,</span> <span class="n">TyMetavar</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">link</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">validate_mvar_unification</span> <span class="n">a</span> <span class="n">b</span>
                <span class="n">unify_kind</span> <span class="n">a</span><span class="o">.</span><span class="n">kind</span> <span class="p">(</span><span class="n">tt</span> <span class="n">top_env</span> <span class="n">b</span><span class="p">)</span>
                <span class="k">match</span> <span class="n">constraint_process</span> <span class="n">a</span><span class="o">.</span><span class="n">constraints</span> <span class="n">b</span> <span class="k">with</span>
                <span class="o">|</span> <span class="p">[]</span> <span class="o">-&gt;</span> <span class="n">link</span><span class="o">.</span><span class="n">Value</span> <span class="o">&lt;-</span> <span class="n">Some</span> <span class="n">b</span>
                <span class="o">|</span> <span class="n">constraint_errors</span> <span class="o">-&gt;</span> <span class="k">raise</span> <span class="p">(</span><span class="n">InferTypeErrorException</span> <span class="p">(</span><span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="n">constraint_errors</span><span class="p">))</span>
            <span class="o">|</span> <span class="n">TyVar</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">),</span> <span class="n">TyVar</span> <span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="n">when</span> <span class="n">a</span> <span class="o">=</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="p">()</span>
            <span class="o">|</span> <span class="n">TyVar</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">link</span><span class="p">),</span> <span class="n">b</span> <span class="o">|</span> <span class="n">b</span><span class="p">,</span> <span class="n">TyVar</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">link</span><span class="p">)</span> <span class="n">when</span> <span class="n">gadt_links</span><span class="o">.</span><span class="n">IsSome</span> <span class="o">-&gt;</span>
                <span class="n">validate_tvar_unification</span> <span class="n">a</span> <span class="n">b</span>
                <span class="n">unify_kind</span> <span class="n">a</span><span class="o">.</span><span class="n">kind</span> <span class="p">(</span><span class="n">tt</span> <span class="n">top_env</span> <span class="n">b</span><span class="p">)</span>
                <span class="k">match</span> <span class="n">constraint_process</span> <span class="n">a</span><span class="o">.</span><span class="n">constraints</span> <span class="n">b</span> <span class="k">with</span>
                <span class="o">|</span> <span class="p">[]</span> <span class="o">-&gt;</span> <span class="n">link</span><span class="o">.</span><span class="n">Value</span> <span class="o">&lt;-</span> <span class="n">Some</span> <span class="n">b</span><span class="p">;</span> <span class="n">gadt_links</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">constraint_errors</span> <span class="o">-&gt;</span> <span class="k">raise</span> <span class="p">(</span><span class="n">InferTypeErrorException</span> <span class="p">(</span><span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="n">constraint_errors</span><span class="p">))</span>
            <span class="o">|</span> <span class="n">TyFun</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">a</span><span class="s1">',ta), TyFun(b,b'</span><span class="p">,</span><span class="n">tb</span><span class="p">)</span> <span class="n">when</span> <span class="n">ta</span> <span class="o">=</span> <span class="n">tb</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">);</span> <span class="n">loop</span> <span class="p">(</span><span class="n">a</span><span class="s1">',b'</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">TyPair</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">a</span><span class="s1">'), TyPair(b,b'</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">);</span> <span class="n">loop</span> <span class="p">(</span><span class="n">a</span><span class="s1">',b'</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">TyApply</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">a</span><span class="s1">',_), TyApply(b,b'</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="p">(</span><span class="n">a</span><span class="s1">',b'</span><span class="p">);</span> <span class="n">loop</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">TyUnion</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">q</span><span class="p">),</span> <span class="n">TyUnion</span><span class="p">(</span><span class="n">l</span><span class="s1">',q'</span><span class="p">)</span> <span class="o">-&gt;</span> 
                <span class="k">if</span> <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="s1">' then</span>
                    <span class="n">let</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">toArray</span> <span class="n">l</span><span class="p">,</span> <span class="n">Map</span><span class="o">.</span><span class="n">toArray</span> <span class="n">l</span><span class="s1">'</span>
                    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">Length</span> <span class="o">&lt;&gt;</span> <span class="n">b</span><span class="o">.</span><span class="n">Length</span> <span class="n">then</span> <span class="n">er</span> <span class="p">()</span>
                    <span class="k">else</span> <span class="n">Array</span><span class="o">.</span><span class="n">iter2</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">ka</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">kb</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">ka</span> <span class="o">=</span> <span class="n">kb</span> <span class="o">&amp;&amp;</span> <span class="n">fst</span> <span class="n">a</span> <span class="o">=</span> <span class="n">fst</span> <span class="n">b</span> <span class="n">then</span> <span class="n">loop</span> <span class="p">(</span><span class="n">snd</span> <span class="n">a</span><span class="p">,</span><span class="n">snd</span> <span class="n">b</span><span class="p">)</span> <span class="k">else</span> <span class="n">er</span><span class="p">())</span> <span class="n">a</span> <span class="n">b</span>
                <span class="k">else</span> <span class="k">raise</span> <span class="p">(</span><span class="n">InferTypeErrorException</span> <span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="n">UnionTypesMustHaveTheSameLayout</span><span class="p">])</span>
            <span class="o">|</span> <span class="n">TyRecord</span> <span class="n">l</span><span class="p">,</span> <span class="n">TyRecord</span> <span class="n">l</span><span class="s1">' -&gt; </span>
                <span class="n">let</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">toArray</span> <span class="n">l</span><span class="p">,</span> <span class="n">Map</span><span class="o">.</span><span class="n">toArray</span> <span class="n">l</span><span class="s1">'</span>
                <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">Length</span> <span class="o">&lt;&gt;</span> <span class="n">b</span><span class="o">.</span><span class="n">Length</span> <span class="n">then</span> <span class="n">er</span> <span class="p">()</span>
                <span class="k">else</span>
                    <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">sortBy</span> <span class="p">(</span><span class="n">fun</span> <span class="p">((</span><span class="n">_</span><span class="p">,</span><span class="n">k</span><span class="p">),</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">k</span><span class="p">)</span>
                    <span class="n">let</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">sortBy</span> <span class="p">(</span><span class="n">fun</span> <span class="p">((</span><span class="n">_</span><span class="p">,</span><span class="n">k</span><span class="p">),</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">k</span><span class="p">)</span>
                    <span class="n">Array</span><span class="o">.</span><span class="n">iter2</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">ka</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">kb</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">ka</span> <span class="o">|&gt;</span> <span class="n">snd</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">kb</span> <span class="o">|&gt;</span> <span class="n">snd</span><span class="p">)</span>
                        <span class="n">then</span> <span class="n">loop</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
                        <span class="k">else</span> <span class="n">er</span><span class="p">()</span>
                    <span class="p">)</span> <span class="n">a</span> <span class="n">b</span>
            <span class="o">|</span> <span class="n">TyNominal</span> <span class="n">i</span><span class="p">,</span> <span class="n">TyNominal</span> <span class="n">i</span><span class="s1">' when i = i'</span> <span class="o">-&gt;</span> <span class="p">()</span>
            <span class="o">|</span> <span class="n">TyB</span><span class="p">,</span> <span class="n">TyB</span> <span class="o">-&gt;</span> <span class="p">()</span>
            <span class="o">|</span> <span class="n">TyPrim</span> <span class="n">x</span><span class="p">,</span> <span class="n">TyPrim</span> <span class="n">x</span><span class="s1">' when x = x'</span> <span class="o">-&gt;</span> <span class="p">()</span>
            <span class="o">|</span> <span class="n">TyLit</span> <span class="n">a</span><span class="p">,</span> <span class="n">TyLit</span> <span class="n">b</span> <span class="n">when</span> <span class="n">a</span> <span class="o">=</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="p">()</span>
            <span class="o">|</span> <span class="n">TySymbol</span> <span class="n">x</span><span class="p">,</span> <span class="n">TySymbol</span> <span class="n">x</span><span class="s1">' when x = x'</span> <span class="o">-&gt;</span> <span class="p">()</span>
            <span class="o">|</span> <span class="n">TyArray</span> <span class="n">a</span><span class="p">,</span> <span class="n">TyArray</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
            <span class="o">//</span> <span class="n">Note</span><span class="p">:</span> <span class="n">Unifying</span> <span class="n">these</span> <span class="mi">3</span> <span class="n">only</span> <span class="n">makes</span> <span class="n">sense</span> <span class="k">if</span> <span class="n">the</span> <span class="err">`</span><span class="n">expected</span><span class="err">`</span> <span class="ow">is</span> <span class="n">fully</span> <span class="n">inferred</span> <span class="n">already</span><span class="o">.</span>
            <span class="o">|</span> <span class="n">TyExists</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">),</span> <span class="n">TyExists</span><span class="p">(</span><span class="n">a</span><span class="s1">',b'</span><span class="p">)</span> <span class="n">when</span> 
                    <span class="n">List</span><span class="o">.</span><span class="n">length</span> <span class="n">a</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">length</span> <span class="n">a</span><span class="s1">'</span>
                    <span class="o">&amp;&amp;</span> <span class="n">List</span><span class="o">.</span><span class="n">forall2</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">a</span> <span class="p">:</span> <span class="n">Var</span><span class="p">)</span> <span class="p">(</span><span class="n">a</span><span class="s1">' : Var) -&gt; a.kind = a'</span><span class="o">.</span><span class="n">kind</span> <span class="o">&amp;&amp;</span> <span class="n">a</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="n">a</span><span class="s1">'.constraints) a a'</span> <span class="o">-&gt;</span> 
                <span class="n">loop</span> <span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">subst</span> <span class="p">(</span><span class="n">List</span><span class="o">.</span><span class="n">map2</span> <span class="p">(</span><span class="n">fun</span> <span class="n">a</span> <span class="n">a</span><span class="s1">' -&gt; a'</span><span class="p">,</span> <span class="n">tyvar</span> <span class="n">a</span><span class="p">)</span> <span class="n">a</span> <span class="n">a</span><span class="s1">') b'</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">TyForall</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">),</span> <span class="n">TyForall</span><span class="p">(</span><span class="n">a</span><span class="s1">',b'</span><span class="p">)</span> 
            <span class="o">|</span> <span class="n">TyInl</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">),</span> <span class="n">TyInl</span><span class="p">(</span><span class="n">a</span><span class="s1">',b'</span><span class="p">)</span> <span class="n">when</span> <span class="n">a</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="n">a</span><span class="s1">'.kind &amp;&amp; a.constraints = a'</span><span class="o">.</span><span class="n">constraints</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">subst</span> <span class="p">[</span><span class="n">a</span><span class="s1">',tyvar a] b'</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">TyMacro</span> <span class="n">a</span><span class="p">,</span> <span class="n">TyMacro</span> <span class="n">b</span> <span class="o">-&gt;</span>
                <span class="n">List</span><span class="o">.</span><span class="n">iter2</span> <span class="p">(</span><span class="n">fun</span> <span class="n">a</span> <span class="n">b</span> <span class="o">-&gt;</span>
                    <span class="k">match</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">TMText</span> <span class="n">a</span><span class="p">,</span> <span class="n">TMText</span> <span class="n">b</span> <span class="n">when</span> <span class="n">System</span><span class="o">.</span><span class="n">Object</span><span class="o">.</span><span class="n">ReferenceEquals</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">||</span> <span class="n">a</span> <span class="o">=</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="p">()</span>
                    <span class="o">|</span> <span class="n">TMVar</span> <span class="n">a</span><span class="p">,</span> <span class="n">TMVar</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">loop</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
                    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">er</span> <span class="p">()</span>
                    <span class="p">)</span> <span class="n">a</span> <span class="n">b</span>
            <span class="o">|</span> <span class="n">TyLayout</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">a</span><span class="s1">'), TyLayout(b,b'</span><span class="p">)</span> <span class="n">when</span> <span class="n">a</span><span class="s1">' = b'</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">er</span> <span class="p">()</span>

        <span class="k">try</span> <span class="n">loop</span> <span class="p">(</span><span class="n">got</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>
        <span class="k">with</span> <span class="p">:</span><span class="err">?</span> <span class="n">InferTypeErrorException</span> <span class="k">as</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">AddRange</span> <span class="n">e</span><span class="o">.</span><span class="n">Data0</span>

    <span class="n">let</span> <span class="n">unify</span> <span class="nb">range</span> <span class="n">got</span> <span class="n">expected</span> <span class="o">=</span> <span class="n">unify_gadt</span> <span class="kc">None</span> <span class="nb">range</span> <span class="n">got</span> <span class="n">expected</span>

    <span class="n">let</span> <span class="n">apply_record</span> <span class="n">r</span> <span class="n">s</span> <span class="n">l</span> <span class="n">x</span> <span class="o">=</span>
        <span class="k">match</span> <span class="n">visit_t</span> <span class="n">x</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">TySymbol</span> <span class="n">x</span> <span class="o">-&gt;</span>
            <span class="k">match</span><span class="w"> </span><span class="n">l</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryPick</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="k">_</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">k</span> <span class="o">=</span> <span class="n">x</span> <span class="n">then</span> <span class="n">Some</span> <span class="n">v</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">Some</span> <span class="n">x</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">com</span> <span class="o">=</span> <span class="n">match</span> <span class="n">x</span> <span class="k">with</span> <span class="n">TyComment</span><span class="p">(</span><span class="n">com</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">com</span> <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="s2">""</span>
                <span class="n">unify</span> <span class="n">r</span> <span class="n">s</span> <span class="n">x</span>
                <span class="n">hover_types</span><span class="o">.</span><span class="n">AddHover</span> <span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">x</span><span class="p">,</span><span class="n">com</span><span class="p">))</span>
            <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">RecordIndexFailed</span> <span class="n">x</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">ExpectedSymbolAsRecordKey</span> <span class="n">x</span><span class="p">)</span>

    <span class="n">let</span> <span class="n">assert_bound_vars</span> <span class="n">env</span> <span class="n">a</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">keys_of</span> <span class="n">m</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">k</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="o">.</span><span class="n">add</span> <span class="n">k</span> <span class="n">s</span><span class="p">)</span> <span class="n">Set</span><span class="o">.</span><span class="n">empty</span> <span class="n">m</span>
        <span class="n">validate_bound_vars</span> <span class="p">(</span><span class="n">loc_env</span> <span class="n">top_env</span><span class="p">)</span> <span class="n">env</span><span class="o">.</span><span class="n">constraints</span> <span class="p">(</span><span class="n">keys_of</span> <span class="n">env</span><span class="o">.</span><span class="n">term</span><span class="p">)</span> <span class="p">(</span><span class="n">keys_of</span> <span class="n">env</span><span class="o">.</span><span class="n">ty</span><span class="p">)</span> <span class="p">(</span><span class="n">Choice1Of2</span> <span class="n">a</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">AddRange</span>

    <span class="n">let</span> <span class="n">fresh_var</span> <span class="n">scope</span> <span class="o">=</span> <span class="n">fresh_var</span><span class="s1">' scope KindType</span>

    <span class="n">let</span> <span class="n">v_cons</span> <span class="n">env</span> <span class="n">a</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">a</span> <span class="n">env</span> <span class="o">|&gt;</span> <span class="n">Option</span><span class="o">.</span><span class="n">orElseWith</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">a</span> <span class="n">top_env</span><span class="o">.</span><span class="n">constraints</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">v</span> <span class="n">env</span> <span class="n">top_env</span> <span class="n">a</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">a</span> <span class="n">env</span> <span class="o">|&gt;</span> <span class="n">Option</span><span class="o">.</span><span class="n">orElseWith</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">a</span> <span class="n">top_env</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">v_term</span> <span class="n">env</span> <span class="n">a</span> <span class="o">=</span> <span class="n">v</span> <span class="n">env</span><span class="o">.</span><span class="n">term</span> <span class="n">top_env</span><span class="o">.</span><span class="n">term</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">Option</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">function</span> <span class="n">TyComment</span><span class="p">(</span><span class="n">com</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">com</span><span class="p">,</span> <span class="n">visit_t</span> <span class="n">x</span> <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="s2">""</span><span class="p">,</span> <span class="n">visit_t</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">v_ty</span> <span class="n">env</span> <span class="n">a</span> <span class="o">=</span> <span class="n">v</span> <span class="n">env</span><span class="o">.</span><span class="n">ty</span> <span class="n">top_env</span><span class="o">.</span><span class="n">ty</span> <span class="n">a</span>

    <span class="n">let</span> <span class="n">typevar_to_var</span> <span class="n">scope</span> <span class="n">cons</span> <span class="p">(((</span><span class="n">_</span><span class="p">,(</span><span class="n">name</span><span class="p">,</span><span class="n">kind</span><span class="p">)),</span><span class="n">constraints</span><span class="p">)</span> <span class="p">:</span> <span class="n">TypeVar</span><span class="p">)</span> <span class="p">:</span> <span class="n">Var</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">rec</span> <span class="n">typevar</span> <span class="o">=</span> <span class="n">function</span>
            <span class="o">|</span> <span class="n">RawKindWildcard</span> <span class="o">-&gt;</span> <span class="n">fresh_kind</span><span class="p">()</span>
            <span class="o">|</span> <span class="n">RawKindStar</span> <span class="o">-&gt;</span> <span class="n">KindType</span>
            <span class="o">|</span> <span class="n">RawKindFun</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KindFun</span><span class="p">(</span><span class="n">typevar</span> <span class="n">a</span><span class="p">,</span> <span class="n">typevar</span> <span class="n">b</span><span class="p">)</span>
        <span class="n">let</span> <span class="n">kind</span> <span class="o">=</span> <span class="n">typevar</span> <span class="n">kind</span>
        <span class="n">let</span> <span class="n">cons</span> <span class="o">=</span>
            <span class="n">constraints</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">choose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">v_cons</span> <span class="n">cons</span> <span class="n">x</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">Some</span> <span class="p">(</span><span class="n">M</span> <span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">ExpectedConstraintInsteadOfModule</span><span class="p">);</span> <span class="kc">None</span>
                <span class="o">|</span> <span class="n">Some</span> <span class="p">(</span><span class="n">C</span> <span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">unify_kind</span> <span class="n">r</span> <span class="n">kind</span> <span class="p">(</span><span class="n">constraint_kind</span> <span class="n">top_env</span> <span class="n">x</span><span class="p">);</span> <span class="n">Some</span> <span class="n">x</span>
                <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">UnboundVariable</span> <span class="n">x</span><span class="p">);</span> <span class="kc">None</span>
                <span class="p">)</span> <span class="o">|&gt;</span> <span class="n">Set</span><span class="o">.</span><span class="n">ofList</span>

        <span class="p">{</span><span class="n">scope</span><span class="o">=</span><span class="n">scope</span><span class="p">;</span> <span class="n">constraints</span><span class="o">=</span><span class="n">cons</span><span class="p">;</span> <span class="n">kind</span><span class="o">=</span><span class="n">kind_force</span> <span class="n">kind</span><span class="p">;</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">}</span>

    <span class="n">let</span> <span class="n">typevars</span> <span class="n">scope</span> <span class="n">env</span> <span class="p">(</span><span class="n">l</span> <span class="p">:</span> <span class="n">TypeVar</span> <span class="nb">list</span><span class="p">)</span> <span class="o">=</span>
        <span class="n">List</span><span class="o">.</span><span class="n">mapFold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">x</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">v</span> <span class="o">=</span> <span class="n">typevar_to_var</span> <span class="n">scope</span> <span class="n">env</span><span class="o">.</span><span class="n">constraints</span> <span class="n">x</span>
            <span class="n">v</span><span class="p">,</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">v</span><span class="o">.</span><span class="n">name</span> <span class="p">(</span><span class="n">tyvar</span> <span class="n">v</span><span class="p">)</span> <span class="n">s</span>
            <span class="p">)</span> <span class="n">env</span><span class="o">.</span><span class="n">ty</span> <span class="n">l</span>

    <span class="n">let</span> <span class="n">rec</span> <span class="n">term</span> <span class="n">scope</span> <span class="n">env</span> <span class="n">s</span> <span class="n">x</span> <span class="o">=</span> <span class="n">term</span><span class="s1">' scope false env s x</span>
    <span class="ow">and</span> <span class="n">term</span><span class="s1">' scope is_in_left_apply (env : InferEnv) s x =</span>
        <span class="n">let</span> <span class="n">f</span> <span class="o">=</span> <span class="n">term</span> <span class="n">scope</span> <span class="n">env</span>
        <span class="n">let</span> <span class="sa">f</span><span class="s1">' x = let v = fresh_var scope in f v x; visit_t v</span>
        <span class="n">let</span> <span class="sa">f</span><span class="s1">''</span> <span class="n">x</span> <span class="o">=</span> <span class="n">let</span> <span class="n">v</span> <span class="o">=</span> <span class="n">fresh_var</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">term</span><span class="s1">' scope true env v x; visit_t v</span>
        <span class="n">let</span> <span class="n">inline</span> <span class="n">rawv</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">is_tvar_applied</span><span class="p">)</span> <span class="o">=</span>
            <span class="k">match</span> <span class="n">v_term</span> <span class="n">env</span> <span class="n">name</span> <span class="k">with</span>
            <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">UnboundVariable</span> <span class="n">name</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">Some</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">TySymbol</span> <span class="s2">"&lt;real&gt;"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">RealFunctionInTopDown</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">Some</span> <span class="p">(</span><span class="n">com</span><span class="p">,</span><span class="n">TyModule</span> <span class="n">_</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span> <span class="n">when</span> <span class="n">is_in_left_apply</span> <span class="o">=</span> <span class="n">false</span> <span class="o">-&gt;</span>
                <span class="n">hover_types</span><span class="o">.</span><span class="n">AddHover</span><span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">m</span><span class="p">,</span><span class="n">com</span><span class="p">))</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">ModuleMustBeImmediatelyApplied</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">Some</span> <span class="p">(</span><span class="n">com</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="k">if</span> <span class="n">is_tvar_applied</span> <span class="n">then</span>
                    <span class="k">match</span><span class="w"> </span><span class="n">a</span> <span class="k">with</span> <span class="n">TyForall</span> <span class="k">_</span><span class="w"> </span><span class="o">-&gt;</span> <span class="n">annotations</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">x</span><span class="p">,(</span><span class="n">r</span><span class="p">,</span><span class="n">s</span><span class="p">))</span> <span class="o">|</span> <span class="k">_</span> <span class="o">-&gt;</span> <span class="p">()</span>
                    <span class="n">let</span> <span class="n">f</span> <span class="n">a</span> <span class="o">=</span> <span class="n">let</span> <span class="n">l</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">forall_subst_all</span> <span class="n">scope</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">unify</span> <span class="n">r</span> <span class="n">s</span> <span class="n">v</span><span class="p">;</span> <span class="n">l</span>
                    <span class="n">let</span> <span class="n">l</span> <span class="o">=</span> <span class="n">f</span> <span class="n">a</span>
                    <span class="n">hover_types</span><span class="o">.</span><span class="n">AddHover</span><span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">s</span><span class="p">,</span><span class="n">com</span><span class="p">))</span>
                    <span class="n">type_apply_args</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">name</span><span class="p">,(</span><span class="n">l</span><span class="p">,</span><span class="n">f</span><span class="p">))</span>
                <span class="k">else</span>
                    <span class="n">unify</span> <span class="n">r</span> <span class="n">s</span> <span class="n">a</span>
                    <span class="n">hover_types</span><span class="o">.</span><span class="n">AddHover</span><span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">s</span><span class="p">,</span><span class="n">com</span><span class="p">))</span>
        <span class="n">let</span> <span class="n">match_clause</span> <span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">=</span>
            <span class="n">let</span> <span class="n">gadt_links</span><span class="p">,</span> <span class="n">gadt_typecases</span><span class="s1">', (scope, env) = pattern scope env q a</span>
            <span class="n">term</span> <span class="n">scope</span> <span class="n">env</span> <span class="n">w</span> <span class="n">b</span>
            <span class="n">dispose_gadt_links</span> <span class="n">gadt_links</span>
            <span class="n">gadt_typecases</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">gadt_typecases</span><span class="s1">')</span>
        <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">RawB</span> <span class="n">r</span> <span class="o">-&gt;</span> <span class="n">unify</span> <span class="n">r</span> <span class="n">s</span> <span class="n">TyB</span>
        <span class="o">|</span> <span class="n">RawV</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">is_tvar_applied</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">rawv</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">is_tvar_applied</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawDefaultLit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">unify</span> <span class="n">r</span> <span class="n">s</span> <span class="p">(</span><span class="n">fresh_subst_var</span> <span class="n">scope</span> <span class="p">(</span><span class="n">Set</span><span class="o">.</span><span class="n">singleton</span> <span class="n">CNumber</span><span class="p">)</span> <span class="n">KindType</span><span class="p">);</span> <span class="n">hover_types</span><span class="o">.</span><span class="n">AddHover</span><span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">s</span><span class="p">,</span><span class="s2">""</span><span class="p">));</span> <span class="n">annotations</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">x</span><span class="p">,(</span><span class="n">r</span><span class="p">,</span><span class="n">s</span><span class="p">))</span>
        <span class="o">|</span> <span class="n">RawLit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">unify</span> <span class="n">r</span> <span class="n">s</span> <span class="p">(</span><span class="n">lit</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawSymbol</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">unify</span> <span class="n">r</span> <span class="n">s</span> <span class="p">(</span><span class="n">TySymbol</span> <span class="n">x</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawIfThenElse</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">cond</span><span class="p">,</span><span class="n">tr</span><span class="p">,</span><span class="n">fl</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="p">(</span><span class="n">TyPrim</span> <span class="n">BoolT</span><span class="p">)</span> <span class="n">cond</span><span class="p">;</span> <span class="n">f</span> <span class="n">s</span> <span class="n">tr</span><span class="p">;</span> <span class="n">f</span> <span class="n">s</span> <span class="n">fl</span>
        <span class="o">|</span> <span class="n">RawIfThen</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">cond</span><span class="p">,</span><span class="n">tr</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="p">(</span><span class="n">TyPrim</span> <span class="n">BoolT</span><span class="p">)</span> <span class="n">cond</span><span class="p">;</span> <span class="n">unify</span> <span class="n">r</span> <span class="n">s</span> <span class="n">TyB</span><span class="p">;</span> <span class="n">f</span> <span class="n">TyB</span> <span class="n">tr</span>
        <span class="o">|</span> <span class="n">RawPair</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">q</span><span class="p">,</span><span class="n">w</span> <span class="o">=</span> <span class="n">fresh_var</span> <span class="n">scope</span><span class="p">,</span> <span class="n">fresh_var</span> <span class="n">scope</span>
            <span class="n">unify</span> <span class="n">r</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyPair</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span>
            <span class="n">f</span> <span class="n">q</span> <span class="n">a</span><span class="p">;</span> <span class="n">f</span> <span class="n">w</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">RawSeq</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">TyB</span> <span class="n">a</span><span class="p">;</span> <span class="n">f</span> <span class="n">s</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">RawReal</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">assert_bound_vars</span> <span class="n">env</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">RawOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">l</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">assert_bound_vars</span> <span class="n">env</span><span class="p">)</span> <span class="n">l</span>
        <span class="o">|</span> <span class="n">RawJoinPoint</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">annotations</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">x</span><span class="p">,(</span><span class="n">r</span><span class="p">,</span><span class="n">s</span><span class="p">));</span> <span class="n">f</span> <span class="n">s</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">RawJoinPoint</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">Some</span> <span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">unify</span> <span class="n">r</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyPair</span><span class="p">(</span><span class="n">TyPrim</span> <span class="n">Int32T</span><span class="p">,</span> <span class="n">TySymbol</span> <span class="s2">"tuple_of_free_vars"</span><span class="p">))</span>
            <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">fresh_var</span> <span class="n">scope</span>
            <span class="n">annotations</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">x</span><span class="p">,(</span><span class="n">r</span><span class="p">,</span><span class="n">s</span><span class="p">))</span>
            <span class="n">f</span> <span class="n">s</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">RawApply</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="s1">',b) -&gt;</span>
            <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="o">=</span> <span class="n">function</span>
                <span class="o">|</span> <span class="n">TyNominal</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyApply</span> <span class="n">_</span> <span class="k">as</span> <span class="n">a</span> <span class="o">-&gt;</span>
                    <span class="k">match</span> <span class="n">type_apply_split</span> <span class="n">a</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">TyNominal</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="o">-&gt;</span>
                        <span class="n">let</span> <span class="n">n</span> <span class="o">=</span> <span class="n">top_env</span><span class="o">.</span><span class="n">nominals</span><span class="o">.</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">match</span> <span class="n">n</span><span class="o">.</span><span class="n">body</span> <span class="k">with</span>
                        <span class="o">|</span> <span class="n">TyUnion</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">UnionsCannotBeApplied</span><span class="p">)</span>
                        <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span>
                            <span class="k">match</span> <span class="n">list_try_zip</span> <span class="n">n</span><span class="o">.</span><span class="n">vars</span> <span class="n">l</span> <span class="k">with</span>
                            <span class="o">|</span> <span class="n">Some</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="p">(</span><span class="n">subst</span> <span class="n">l</span> <span class="n">n</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
                            <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">MalformedNominal</span><span class="p">)</span>
                    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">ExpectedNominalInApply</span> <span class="n">a</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">TyLayout</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span>
                    <span class="k">match</span> <span class="n">visit_t</span> <span class="n">a</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">TyRecord</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">apply_record</span> <span class="n">r</span> <span class="n">s</span> <span class="n">l</span> <span class="p">(</span><span class="sa">f</span><span class="s1">' b)</span>
                    <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">ExpectedRecordInsideALayout</span> <span class="n">a</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">TyRecord</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">apply_record</span> <span class="n">r</span> <span class="n">s</span> <span class="n">l</span> <span class="p">(</span><span class="sa">f</span><span class="s1">' b)</span>
                <span class="o">|</span> <span class="n">TyModule</span> <span class="n">l</span> <span class="o">-&gt;</span>
                    <span class="k">match</span> <span class="sa">f</span><span class="s1">' b with</span>
                    <span class="o">|</span> <span class="n">TySymbol</span> <span class="n">n</span> <span class="o">-&gt;</span>
                        <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">n</span> <span class="n">l</span> <span class="k">with</span>
                        <span class="o">|</span> <span class="n">Some</span> <span class="p">(</span><span class="n">TyModule</span> <span class="n">_</span> <span class="k">as</span> <span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span>
                            <span class="k">if</span> <span class="n">is_in_left_apply</span> <span class="n">then</span> 
                                <span class="k">match</span><span class="w"> </span><span class="n">b</span> <span class="k">with</span> <span class="n">RawSymbol</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="k">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">hover_types</span><span class="o">.</span><span class="n">AddHover</span><span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">a</span><span class="p">,</span><span class="s2">""</span><span class="p">))</span> <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="p">()</span>
                                <span class="n">unify</span> <span class="n">r</span> <span class="n">s</span> <span class="n">a</span>
                            <span class="k">else</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">ModuleMustBeImmediatelyApplied</span><span class="p">)</span>
                        <span class="o">|</span> <span class="n">Some</span> <span class="n">a</span><span class="s1">' -&gt;</span>
                            <span class="n">let</span> <span class="n">typevars</span><span class="p">,</span><span class="n">a</span> <span class="o">=</span> <span class="n">forall_subst_all</span> <span class="n">scope</span> <span class="n">a</span><span class="s1">'</span>
                            <span class="k">if</span> <span class="n">List</span><span class="o">.</span><span class="n">isEmpty</span> <span class="n">typevars</span> <span class="o">=</span> <span class="n">false</span> <span class="n">then</span>
                                <span class="n">annotations</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">x</span><span class="p">,(</span><span class="n">r</span><span class="p">,</span><span class="n">s</span><span class="p">))</span>
                                <span class="n">module_type_apply_args</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">typevars</span><span class="p">)</span>
                            <span class="n">unify</span> <span class="n">r</span> <span class="n">s</span> <span class="n">a</span>
                            <span class="k">match</span> <span class="n">b</span> <span class="k">with</span> 
                            <span class="o">|</span> <span class="n">RawSymbol</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> 
                                <span class="n">let</span> <span class="n">com</span> <span class="o">=</span> <span class="n">match</span> <span class="n">a</span><span class="s1">' with TyComment(com,_) -&gt; com | _ -&gt; ""</span>
                                <span class="n">hover_types</span><span class="o">.</span><span class="n">AddHover</span><span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">a</span><span class="p">,</span><span class="n">com</span><span class="p">))</span>
                            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="p">()</span>
                        <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">ModuleIndexFailed</span> <span class="n">n</span><span class="p">)</span>
                    <span class="o">|</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">ExpectedSymbolAsModuleKey</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">TyFun</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span><span class="nb">range</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">unify</span> <span class="p">(</span><span class="n">range_of_expr</span> <span class="n">a</span><span class="s1">') range s; f domain b</span>
                <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">v</span> <span class="o">=</span> <span class="n">fresh_var</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">unify</span> <span class="p">(</span><span class="n">range_of_expr</span> <span class="n">a</span><span class="s1">') a (TyFun(v,s,FT_Vanilla)); f v b</span>
            <span class="n">loop</span> <span class="p">(</span><span class="sa">f</span><span class="s1">''</span> <span class="n">a</span><span class="s1">')</span>
        <span class="o">|</span> <span class="n">RawAnnot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>  <span class="n">ty_init</span> <span class="n">scope</span> <span class="n">env</span> <span class="n">s</span> <span class="n">b</span><span class="p">;</span> <span class="n">f</span> <span class="n">s</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">RawOpen</span><span class="p">(</span><span class="n">_</span><span class="p">,(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">l</span><span class="p">,</span><span class="n">on_succ</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">module_openInfer</span> <span class="p">(</span><span class="n">Some</span> <span class="n">hover_types</span><span class="p">)</span> <span class="p">(</span><span class="n">loc_env</span> <span class="n">top_env</span><span class="p">)</span> <span class="n">env</span><span class="o">.</span><span class="n">ty</span> <span class="n">r</span> <span class="n">a</span> <span class="n">l</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span> <span class="n">x</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">combine</span> <span class="n">big</span> <span class="n">small</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">small</span> <span class="n">big</span>
                <span class="n">term</span> <span class="n">scope</span> <span class="p">{</span><span class="n">term</span> <span class="o">=</span> <span class="n">combine</span> <span class="n">env</span><span class="o">.</span><span class="n">term</span> <span class="n">x</span><span class="o">.</span><span class="n">term</span><span class="p">;</span> <span class="n">ty</span> <span class="o">=</span> <span class="n">combine</span> <span class="n">env</span><span class="o">.</span><span class="n">ty</span> <span class="n">x</span><span class="o">.</span><span class="n">ty</span><span class="p">;</span> <span class="n">constraints</span> <span class="o">=</span> <span class="n">combine</span> <span class="n">env</span><span class="o">.</span><span class="n">constraints</span> <span class="n">x</span><span class="o">.</span><span class="n">constraints</span><span class="p">}</span> <span class="n">s</span> <span class="n">on_succ</span>
            <span class="o">|</span> <span class="n">Result</span><span class="o">.</span><span class="n">Error</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawRecordWith</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">withs</span><span class="p">,</span><span class="n">withouts</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">i</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">Count</span>
            <span class="n">let</span> <span class="n">withouts</span><span class="p">,</span><span class="n">fields</span> <span class="o">=</span>
                <span class="n">List</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">s</span> <span class="k">as</span> <span class="n">state</span><span class="p">)</span> <span class="o">-&gt;</span>
                    <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">RawRecordWithoutSymbol</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="o">|</span><span class="nb">range</span><span class="o">=</span><span class="n">r</span><span class="p">;</span> <span class="n">symbol</span> <span class="o">=</span> <span class="n">a</span><span class="o">|</span><span class="p">}</span> <span class="p">::</span> <span class="n">l</span><span class="p">,</span> <span class="n">Set</span><span class="o">.</span><span class="n">add</span> <span class="n">a</span> <span class="n">s</span>
                    <span class="o">|</span> <span class="n">RawRecordWithoutInjectVar</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span>
                        <span class="k">match</span> <span class="n">v_term</span> <span class="n">env</span> <span class="n">a</span> <span class="k">with</span>
                        <span class="o">|</span> <span class="n">Some</span> <span class="p">(</span><span class="n">com</span><span class="p">,</span> <span class="n">TySymbol</span> <span class="n">a</span> <span class="o">&amp;</span> <span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">hover_types</span><span class="o">.</span><span class="n">AddHover</span><span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">x</span><span class="p">,</span><span class="n">com</span><span class="p">));</span> <span class="p">{</span><span class="o">|</span><span class="nb">range</span><span class="o">=</span><span class="n">r</span><span class="p">;</span> <span class="n">symbol</span> <span class="o">=</span> <span class="n">a</span><span class="o">|</span><span class="p">}</span> <span class="p">::</span> <span class="n">l</span><span class="p">,</span> <span class="n">Set</span><span class="o">.</span><span class="n">add</span> <span class="n">a</span> <span class="n">s</span>
                        <span class="o">|</span> <span class="n">Some</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ExpectedSymbolAsRecordKey</span> <span class="n">x</span><span class="p">);</span> <span class="n">state</span>
                        <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">UnboundVariable</span> <span class="n">a</span><span class="p">);</span> <span class="n">state</span>
                    <span class="p">)</span> <span class="n">withouts</span> <span class="p">([],</span><span class="n">Set</span><span class="o">.</span><span class="n">empty</span><span class="p">)</span>
            <span class="n">let</span> <span class="n">withs</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span>
                <span class="n">List</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">s</span> <span class="k">as</span> <span class="n">state</span><span class="p">)</span> <span class="o">-&gt;</span>
                    <span class="n">let</span> <span class="n">with_symbol</span> <span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span><span class="nb">range</span><span class="o">=</span><span class="n">r</span><span class="p">;</span> <span class="n">symbol</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span> <span class="n">is_blocked</span><span class="o">=</span><span class="n">Set</span><span class="o">.</span><span class="n">contains</span> <span class="n">a</span> <span class="n">s</span><span class="p">;</span> <span class="n">is_modify</span><span class="o">=</span><span class="n">false</span><span class="p">;</span> <span class="n">var</span><span class="o">=</span><span class="n">fresh_var</span> <span class="n">scope</span><span class="p">;</span> <span class="n">body</span><span class="o">=</span><span class="n">b</span><span class="o">|</span><span class="p">}</span> <span class="p">::</span> <span class="n">l</span><span class="p">,</span> <span class="n">Set</span><span class="o">.</span><span class="n">add</span> <span class="n">a</span> <span class="n">s</span>
                    <span class="n">let</span> <span class="n">with_symbol_modify</span> <span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span><span class="nb">range</span><span class="o">=</span><span class="n">r</span><span class="p">;</span> <span class="n">symbol</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span> <span class="n">is_blocked</span><span class="o">=</span><span class="n">Set</span><span class="o">.</span><span class="n">contains</span> <span class="n">a</span> <span class="n">s</span><span class="p">;</span> <span class="n">is_modify</span><span class="o">=</span><span class="n">true</span><span class="p">;</span> <span class="n">var</span><span class="o">=</span><span class="n">TyFun</span><span class="p">(</span><span class="n">fresh_var</span> <span class="n">scope</span><span class="p">,</span><span class="n">fresh_var</span> <span class="n">scope</span><span class="p">,</span><span class="n">FT_Vanilla</span><span class="p">);</span> <span class="n">body</span><span class="o">=</span><span class="n">b</span><span class="o">|</span><span class="p">}</span> <span class="p">::</span> <span class="n">l</span><span class="p">,</span> <span class="n">Set</span><span class="o">.</span><span class="n">add</span> <span class="n">a</span> <span class="n">s</span>
                    <span class="n">let</span> <span class="n">inline</span> <span class="n">with_inject</span> <span class="nb">next</span> <span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">=</span>
                        <span class="k">match</span> <span class="n">v_term</span> <span class="n">env</span> <span class="n">a</span> <span class="k">with</span>
                        <span class="o">|</span> <span class="n">Some</span> <span class="p">(</span><span class="n">com</span><span class="p">,</span> <span class="n">TySymbol</span> <span class="n">a</span> <span class="o">&amp;</span> <span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">hover_types</span><span class="o">.</span><span class="n">AddHover</span><span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">x</span><span class="p">,</span><span class="n">com</span><span class="p">));</span> <span class="nb">next</span> <span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span>
                        <span class="o">|</span> <span class="n">Some</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ExpectedSymbolAsRecordKey</span> <span class="n">x</span><span class="p">);</span> <span class="sa">f</span><span class="s1">' b |&gt; ignore; state</span>
                        <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">UnboundVariable</span> <span class="n">a</span><span class="p">);</span> <span class="sa">f</span><span class="s1">' b |&gt; ignore; state</span>
                    <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">RawRecordWithSymbol</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">with_symbol</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
                    <span class="o">|</span> <span class="n">RawRecordWithSymbolModify</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">with_symbol_modify</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
                    <span class="o">|</span> <span class="n">RawRecordWithInjectVar</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">with_inject</span> <span class="n">with_symbol</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
                    <span class="o">|</span> <span class="n">RawRecordWithInjectVarModify</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">with_inject</span> <span class="n">with_symbol_modify</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
                    <span class="p">)</span> <span class="n">withs</span> <span class="p">([],</span><span class="n">fields</span><span class="p">)</span>

            <span class="n">let</span> <span class="nb">eval</span> <span class="n">m</span> <span class="o">=</span>
                <span class="n">let</span> <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">withs</span><span class="p">)</span> <span class="o">||&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">m</span> <span class="n">x</span> <span class="o">-&gt;</span>
                    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">is_modify</span> <span class="n">then</span>
                        <span class="n">let</span> <span class="n">i</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span>
                            <span class="k">match</span> <span class="n">m</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryPick</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">k</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">symbol</span> <span class="n">then</span> <span class="n">Some</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span> <span class="k">with</span>
                            <span class="o">|</span> <span class="n">Some</span> <span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span>
                            <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">range</span><span class="p">,</span><span class="n">RecordIndexFailed</span> <span class="n">x</span><span class="o">.</span><span class="n">symbol</span><span class="p">);</span> <span class="n">m</span><span class="o">.</span><span class="n">Count</span><span class="p">,</span> <span class="n">fresh_var</span> <span class="n">scope</span>
                        <span class="n">let</span> <span class="n">w</span> <span class="o">=</span> <span class="n">fresh_var</span> <span class="n">scope</span>
                        <span class="n">unify</span> <span class="n">x</span><span class="o">.</span><span class="n">range</span> <span class="p">(</span><span class="n">TyFun</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">FT_Vanilla</span><span class="p">))</span> <span class="n">x</span><span class="o">.</span><span class="n">var</span>
                        <span class="n">f</span> <span class="n">x</span><span class="o">.</span><span class="n">var</span> <span class="n">x</span><span class="o">.</span><span class="n">body</span>
                        <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span> <span class="n">w</span> <span class="n">m</span>
                    <span class="k">else</span>
                        <span class="n">f</span> <span class="n">x</span><span class="o">.</span><span class="n">var</span> <span class="n">x</span><span class="o">.</span><span class="n">body</span>
                        <span class="n">let</span> <span class="n">i</span> <span class="o">=</span>
                            <span class="n">m</span>
                            <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryPick</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">k</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">symbol</span> <span class="n">then</span> <span class="n">Some</span> <span class="n">i</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                            <span class="o">|&gt;</span> <span class="n">Option</span><span class="o">.</span><span class="n">defaultValue</span> <span class="n">m</span><span class="o">.</span><span class="n">Count</span>
                        <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span> <span class="n">x</span><span class="o">.</span><span class="n">var</span> <span class="n">m</span>
                    <span class="p">)</span>
                <span class="n">withouts</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">m</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">m</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">filter</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">k</span> <span class="o">&lt;&gt;</span> <span class="n">x</span><span class="o">.</span><span class="n">symbol</span><span class="p">))</span> <span class="n">m</span>

            <span class="n">let</span> <span class="n">bind</span> <span class="n">s</span> <span class="o">=</span> <span class="n">withs</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span>
                <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">is_blocked</span> <span class="o">=</span> <span class="n">false</span> <span class="n">then</span>
                    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">is_modify</span> <span class="n">then</span>
                        <span class="n">s</span>
                        <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryPick</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="s1">') v -&gt; if k'</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">symbol</span> <span class="n">then</span> <span class="n">Some</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="o">|&gt;</span> <span class="n">Option</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">unify</span> <span class="n">x</span><span class="o">.</span><span class="n">range</span> <span class="n">x</span><span class="o">.</span><span class="n">var</span> <span class="p">(</span><span class="n">TyFun</span><span class="p">(</span><span class="n">fresh_var</span> <span class="n">scope</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">FT_Vanilla</span><span class="p">)))</span>
                    <span class="k">else</span>
                        <span class="n">s</span>
                        <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryPick</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="s1">') v -&gt; if k'</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">symbol</span> <span class="n">then</span> <span class="n">Some</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="o">|&gt;</span> <span class="n">Option</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">k</span> <span class="o">|&gt;</span> <span class="n">unify</span> <span class="n">x</span><span class="o">.</span><span class="n">range</span> <span class="n">x</span><span class="o">.</span><span class="n">var</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="n">let</span> <span class="n">rec</span> <span class="n">tail</span><span class="s1">' m = function</span>
                <span class="o">|</span> <span class="n">x</span> <span class="p">::</span> <span class="n">xs</span> <span class="o">-&gt;</span>
                    <span class="k">match</span> <span class="sa">f</span><span class="s1">' x with</span>
                    <span class="o">|</span> <span class="n">TySymbol</span> <span class="n">k</span> <span class="o">-&gt;</span>
                        <span class="k">match</span> <span class="n">m</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryPick</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="s1">') v -&gt; if k'</span> <span class="o">=</span> <span class="n">k</span> <span class="n">then</span> <span class="n">Some</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span> <span class="k">with</span>
                        <span class="o">|</span> <span class="n">Some</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="o">-&gt;</span>
                            <span class="k">match</span> <span class="n">visit_t</span> <span class="n">m</span> <span class="k">with</span>
                            <span class="o">|</span> <span class="n">TyRecord</span> <span class="n">m</span> <span class="o">-&gt;</span> <span class="n">tail</span><span class="s1">' m xs</span>
                            <span class="o">|</span> <span class="n">m</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">range_of_expr</span> <span class="n">x</span><span class="p">,</span> <span class="n">ExpectedRecordAsResultOfIndex</span> <span class="n">m</span><span class="p">);</span> <span class="nb">eval</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
                        <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">range_of_expr</span> <span class="n">x</span><span class="p">,</span> <span class="n">RecordIndexFailed</span> <span class="n">k</span><span class="p">);</span> <span class="nb">eval</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
                        <span class="o">|&gt;</span> <span class="n">fun</span> <span class="n">v</span> <span class="o">-&gt;</span>
                            <span class="n">let</span> <span class="n">i</span> <span class="o">=</span> <span class="n">m</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryPick</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="s1">') v -&gt; if k'</span> <span class="o">=</span> <span class="n">k</span> <span class="n">then</span> <span class="n">Some</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                            <span class="k">match</span> <span class="n">i</span> <span class="k">with</span>
                            <span class="o">|</span> <span class="n">Some</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="p">(</span><span class="n">TyRecord</span> <span class="n">v</span><span class="p">)</span> <span class="n">m</span>
                            <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Count</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="p">(</span><span class="n">TyRecord</span> <span class="n">v</span><span class="p">)</span> <span class="n">m</span>
                    <span class="o">|</span> <span class="n">TyMetavar</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">range_of_expr</span> <span class="n">x</span><span class="p">,</span> <span class="n">MetavarsNotAllowedInRecordWith</span><span class="p">);</span> <span class="nb">eval</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
                    <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">range_of_expr</span> <span class="n">x</span><span class="p">,</span> <span class="n">ExpectedSymbolInRecordWith</span> <span class="n">a</span><span class="p">);</span> <span class="nb">eval</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
                <span class="o">|</span> <span class="p">[]</span> <span class="o">-&gt;</span> <span class="nb">eval</span> <span class="n">m</span>

            <span class="n">let</span> <span class="n">rec</span> <span class="n">tail</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">s</span><span class="p">)</span> <span class="o">=</span> <span class="n">function</span>
                <span class="o">|</span> <span class="n">x</span> <span class="p">::</span> <span class="n">xs</span> <span class="o">-&gt;</span>
                    <span class="k">match</span> <span class="sa">f</span><span class="s1">' x with</span>
                    <span class="o">|</span> <span class="n">TySymbol</span> <span class="n">k</span> <span class="o">-&gt;</span>
                        <span class="k">match</span>
                            <span class="n">m</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryPick</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="s1">') v -&gt; if k'</span> <span class="o">=</span> <span class="n">k</span> <span class="n">then</span> <span class="n">Some</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),</span>
                            <span class="n">s</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryPick</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="s1">') v -&gt; if k'</span> <span class="o">=</span> <span class="n">k</span> <span class="n">then</span> <span class="n">Some</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">with</span>
                        <span class="o">|</span> <span class="n">Some</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">m</span><span class="p">),</span> <span class="n">Some</span> <span class="p">(</span><span class="n">_i</span><span class="s1">',s) -&gt;</span>
                            <span class="k">match</span> <span class="n">visit_t</span> <span class="n">m</span><span class="p">,</span> <span class="n">visit_t</span> <span class="n">s</span> <span class="k">with</span>
                            <span class="o">|</span> <span class="n">TyRecord</span> <span class="n">m</span><span class="p">,</span> <span class="n">TyRecord</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">i</span><span class="p">,</span> <span class="n">tail</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">s</span><span class="p">)</span> <span class="n">xs</span>
                            <span class="o">|</span> <span class="n">TyRecord</span> <span class="n">m</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">i</span><span class="p">,</span> <span class="n">tail</span><span class="s1">' m xs</span>
                            <span class="o">|</span> <span class="n">m</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">range_of_expr</span> <span class="n">x</span><span class="p">,</span> <span class="n">ExpectedRecordAsResultOfIndex</span> <span class="n">m</span><span class="p">);</span> <span class="n">i</span><span class="p">,</span> <span class="nb">eval</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
                        <span class="o">|</span> <span class="n">Some</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">m</span><span class="p">),</span> <span class="kc">None</span> <span class="o">-&gt;</span>
                            <span class="k">match</span> <span class="n">visit_t</span> <span class="n">m</span> <span class="k">with</span>
                            <span class="o">|</span> <span class="n">TyRecord</span> <span class="n">m</span> <span class="o">-&gt;</span> <span class="n">i</span><span class="p">,</span> <span class="n">tail</span><span class="s1">' m xs</span>
                            <span class="o">|</span> <span class="n">m</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">range_of_expr</span> <span class="n">x</span><span class="p">,</span> <span class="n">ExpectedRecordAsResultOfIndex</span> <span class="n">m</span><span class="p">);</span> <span class="n">i</span><span class="p">,</span> <span class="nb">eval</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
                        <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">range_of_expr</span> <span class="n">x</span><span class="p">,</span> <span class="n">RecordIndexFailed</span> <span class="n">k</span><span class="p">);</span> <span class="n">i</span><span class="p">,</span> <span class="nb">eval</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
                        <span class="o">|&gt;</span> <span class="n">fun</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">(</span><span class="n">TyRecord</span> <span class="n">v</span><span class="p">)</span> <span class="n">m</span>
                    <span class="o">|</span> <span class="n">TyMetavar</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">range_of_expr</span> <span class="n">x</span><span class="p">,</span> <span class="n">MetavarsNotAllowedInRecordWith</span><span class="p">);</span> <span class="nb">eval</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
                    <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">range_of_expr</span> <span class="n">x</span><span class="p">,</span> <span class="n">ExpectedSymbolInRecordWith</span> <span class="n">a</span><span class="p">);</span> <span class="nb">eval</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
                <span class="o">|</span> <span class="p">[]</span> <span class="o">-&gt;</span> <span class="n">bind</span> <span class="n">s</span><span class="p">;</span> <span class="nb">eval</span> <span class="n">m</span>

            <span class="k">match</span> <span class="n">l</span> <span class="k">with</span>
            <span class="o">|</span> <span class="p">[]</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">visit_t</span> <span class="n">s</span> <span class="k">with</span> <span class="n">TyRecord</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">bind</span> <span class="n">s</span> <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="p">()</span>
                <span class="nb">eval</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
            <span class="o">|</span> <span class="n">m</span> <span class="p">::</span> <span class="n">l</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="sa">f</span><span class="s1">' m, visit_t s with</span>
                <span class="o">|</span> <span class="n">TyRecord</span> <span class="n">m</span><span class="p">,</span> <span class="n">TyRecord</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">tail</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">s</span><span class="p">)</span> <span class="n">l</span>
                <span class="o">|</span> <span class="n">TyRecord</span> <span class="n">m</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">tail</span><span class="s1">' m l</span>
                <span class="o">|</span> <span class="n">TyMetavar</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">range_of_expr</span> <span class="n">x</span><span class="p">,</span> <span class="n">MetavarsNotAllowedInRecordWith</span><span class="p">);</span> <span class="nb">eval</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
                <span class="o">|</span> <span class="n">a</span><span class="p">,</span><span class="n">_</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">range_of_expr</span> <span class="n">x</span><span class="p">,</span> <span class="n">ExpectedRecord</span> <span class="n">a</span><span class="p">);</span> <span class="nb">eval</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
            <span class="o">|&gt;</span> <span class="n">fun</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">errors</span><span class="o">.</span><span class="n">Count</span> <span class="o">=</span> <span class="n">i</span> <span class="n">then</span> <span class="n">unify</span> <span class="n">r</span> <span class="p">(</span><span class="n">TyRecord</span> <span class="n">v</span><span class="p">)</span> <span class="n">s</span>
        <span class="o">|</span> <span class="n">RawExists</span><span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="sa">r</span><span class="s1">',l),body) -&gt;</span>
            <span class="k">match</span> <span class="n">visit_t</span> <span class="n">s</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">TyExists</span><span class="p">(</span><span class="n">type_vars</span><span class="p">,</span><span class="n">type_body</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="nb">vars</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">exists_subst_term</span> <span class="n">scope</span> <span class="p">(</span><span class="n">type_vars</span><span class="p">,</span><span class="n">type_body</span><span class="p">)</span>
                <span class="n">l</span> <span class="o">|&gt;</span> <span class="n">Option</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">l</span> <span class="o">-&gt;</span>
                    <span class="n">let</span> <span class="n">l1</span><span class="p">,</span><span class="n">l2</span> <span class="o">=</span> <span class="nb">vars</span><span class="o">.</span><span class="n">Length</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">Length</span>
                    <span class="k">if</span> <span class="n">l1</span> <span class="o">=</span> <span class="n">l2</span> <span class="n">then</span> <span class="n">List</span><span class="o">.</span><span class="n">iter2</span> <span class="p">(</span><span class="n">ty_init</span> <span class="n">scope</span> <span class="n">env</span><span class="p">)</span> <span class="nb">vars</span> <span class="n">l</span>
                    <span class="k">else</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="sa">r</span><span class="s1">', UnexpectedNumberOfArgumentsInExistsBody(l1,l2))</span>
                    <span class="p">)</span>
                <span class="n">term</span> <span class="n">scope</span> <span class="n">env</span> <span class="n">s</span> <span class="n">body</span>
                <span class="n">assert_exists_hasnt_metavars</span> <span class="p">(</span><span class="n">range_of_expr</span> <span class="n">x</span><span class="p">)</span> <span class="nb">vars</span>
                <span class="n">exists_vars</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="nb">vars</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ExpectedExistentialInTerm</span> <span class="n">s</span><span class="p">);</span> <span class="n">f</span> <span class="p">(</span><span class="n">fresh_var</span> <span class="n">scope</span><span class="p">)</span> <span class="n">body</span>
        <span class="o">|</span> <span class="n">RawFun</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">l</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">annotations</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">x</span><span class="p">,(</span><span class="n">r</span><span class="p">,</span><span class="n">s</span><span class="p">))</span>
            <span class="n">let</span> <span class="n">q</span><span class="p">,</span><span class="n">w</span> <span class="o">=</span> <span class="n">fresh_var</span> <span class="n">scope</span><span class="p">,</span> <span class="n">fresh_var</span> <span class="n">scope</span>
            <span class="n">unify</span> <span class="n">r</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyFun</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">FT_Vanilla</span><span class="p">))</span>
            <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">match_clause</span> <span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">w</span><span class="p">))</span> <span class="n">l</span>
        <span class="o">|</span> <span class="n">RawForall</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: Should be handled in let statements."</span>
        <span class="o">|</span> <span class="n">RawMatch</span><span class="p">(</span><span class="n">_</span><span class="p">,(</span><span class="n">RawForall</span> <span class="n">_</span> <span class="o">|</span> <span class="n">RawFun</span> <span class="n">_</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">body</span><span class="p">,[</span><span class="n">PatVar</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">name</span><span class="p">),</span> <span class="n">on_succ</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">term</span> <span class="n">scope</span> <span class="p">(</span><span class="n">inl</span> <span class="n">scope</span> <span class="n">env</span> <span class="p">((</span><span class="n">r</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span> <span class="n">body</span><span class="p">))</span> <span class="n">s</span> <span class="n">on_succ</span>
        <span class="o">|</span> <span class="n">RawRecBlock</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">l</span><span class="s1">',on_succ) -&gt; term scope (rec_block scope env l'</span><span class="p">)</span> <span class="n">s</span> <span class="n">on_succ</span>
        <span class="o">|</span> <span class="n">RawMatch</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">body</span><span class="p">,</span><span class="n">l</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">body_var</span> <span class="o">=</span> <span class="n">fresh_var</span> <span class="n">scope</span>
            <span class="n">f</span> <span class="n">body_var</span> <span class="n">body</span>
            <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">match_clause</span> <span class="p">(</span><span class="n">body_var</span><span class="p">,</span><span class="n">s</span><span class="p">))</span> <span class="n">l</span>
        <span class="o">|</span> <span class="n">RawMissingBody</span> <span class="n">r</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">MissingBody</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawMacro</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">annotations</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">x</span><span class="p">,(</span><span class="n">r</span><span class="p">,</span><span class="n">s</span><span class="p">))</span>
            <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">function</span>
                <span class="o">|</span> <span class="n">RawMacroText</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="p">()</span>
                <span class="o">|</span> <span class="n">RawMacroTerm</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">term</span> <span class="n">scope</span> <span class="n">env</span> <span class="p">(</span><span class="n">fresh_var</span> <span class="n">scope</span><span class="p">)</span> <span class="n">a</span>
                <span class="o">|</span> <span class="n">RawMacroType</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">RawMacroTypeLit</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ty_init</span> <span class="n">scope</span> <span class="n">env</span> <span class="p">(</span><span class="n">fresh_var</span> <span class="n">scope</span><span class="p">)</span> <span class="n">a</span>
                <span class="p">)</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">RawHeapMutableSet</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">unify</span> <span class="n">r</span> <span class="n">s</span> <span class="n">TyB</span>
            <span class="k">try</span> <span class="n">let</span> <span class="n">v</span> <span class="o">=</span> <span class="n">fresh_var</span> <span class="n">scope</span>
                <span class="n">let</span> <span class="n">i</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">Count</span>
                <span class="n">f</span> <span class="n">v</span> <span class="n">a</span>
                <span class="k">match</span> <span class="n">visit_t</span> <span class="n">v</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">TyMetavar</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="k">raise</span> <span class="p">(</span><span class="n">InferTypeErrorException</span> <span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">LayoutSetMustBeAnnotated</span><span class="p">])</span>
                <span class="o">|</span> <span class="n">TyLayout</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">lay</span><span class="p">)</span> <span class="o">-&gt;</span>
                    <span class="k">match</span> <span class="n">lay</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">HeapMutable</span> <span class="o">|</span> <span class="n">StackMutable</span> <span class="o">-&gt;</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Count</span> <span class="n">then</span> <span class="k">raise</span> <span class="p">(</span><span class="n">InferTypeErrorException</span> <span class="p">[])</span>
                        <span class="n">let</span> <span class="n">b</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">range_of_expr</span> <span class="n">x</span><span class="p">,</span> <span class="sa">f</span><span class="s1">' x) b</span>
                        <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="s1">') (r'</span><span class="p">,</span><span class="sa">b</span><span class="s1">') -&gt;</span>
                            <span class="k">match</span> <span class="n">visit_t</span> <span class="n">a</span><span class="s1">' with</span>
                            <span class="o">|</span> <span class="n">TyRecord</span> <span class="n">a</span> <span class="o">-&gt;</span>
                                <span class="k">match</span> <span class="sa">b</span><span class="s1">' with</span>
                                <span class="o">|</span> <span class="n">TySymbol</span> <span class="n">b</span> <span class="o">-&gt;</span>
                                    <span class="k">match</span><span class="w"> </span><span class="n">a</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryPick</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="k">_</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">k</span> <span class="o">=</span> <span class="n">b</span> <span class="n">then</span> <span class="n">Some</span> <span class="n">v</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span> <span class="k">with</span>
                                    <span class="o">|</span> <span class="n">Some</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="sa">r</span><span class="s1">', x</span>
                                    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="k">raise</span> <span class="p">(</span><span class="n">InferTypeErrorException</span> <span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">RecordIndexFailed</span> <span class="n">b</span><span class="p">])</span>
                                <span class="o">|</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="k">raise</span> <span class="p">(</span><span class="n">InferTypeErrorException</span> <span class="p">[</span><span class="sa">r</span><span class="s1">', ExpectedSymbol'</span> <span class="n">b</span><span class="p">])</span>
                            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="k">raise</span> <span class="p">(</span><span class="n">InferTypeErrorException</span> <span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">ExpectedRecord</span> <span class="n">a</span><span class="p">])</span>
                            <span class="p">)</span> <span class="p">(</span><span class="n">range_of_expr</span> <span class="n">a</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">snd</span>
                    <span class="o">|</span> <span class="n">Heap</span> <span class="o">-&gt;</span> <span class="k">raise</span> <span class="p">(</span><span class="n">InferTypeErrorException</span> <span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">ExpectedMutableLayout</span> <span class="n">v</span><span class="p">])</span>
                <span class="o">|</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="k">raise</span> <span class="p">(</span><span class="n">InferTypeErrorException</span> <span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">ExpectedMutableLayout</span> <span class="n">v</span><span class="p">])</span>
            <span class="k">with</span> <span class="p">:</span><span class="err">?</span> <span class="n">InferTypeErrorException</span> <span class="k">as</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">AddRange</span> <span class="n">e</span><span class="o">.</span><span class="n">Data0</span><span class="p">;</span> <span class="n">fresh_var</span> <span class="n">scope</span>
            <span class="o">|&gt;</span> <span class="n">fun</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">v</span> <span class="n">c</span>
        <span class="o">|</span> <span class="n">RawArray</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">annotations</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">x</span><span class="p">,(</span><span class="n">r</span><span class="p">,</span><span class="n">s</span><span class="p">))</span>
            <span class="n">let</span> <span class="n">v</span> <span class="o">=</span> <span class="n">fresh_var</span> <span class="n">scope</span>
            <span class="n">unify</span> <span class="n">r</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyArray</span> <span class="n">v</span><span class="p">)</span>
            <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">f</span> <span class="n">v</span><span class="p">)</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">RawFilledForall</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: Should not manifest during type inference."</span>
        <span class="o">|</span> <span class="n">RawType</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: RawType should not appear in the top down segment."</span>
        <span class="o">|</span> <span class="n">RawTypecase</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: `typecase` should not appear in the top down segment."</span>
    <span class="ow">and</span> <span class="n">inl</span> <span class="n">scope</span> <span class="n">env</span> <span class="p">((</span><span class="n">r</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span> <span class="n">body</span><span class="p">)</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">scope</span> <span class="o">=</span> <span class="n">scope</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">let</span> <span class="nb">vars</span><span class="p">,</span><span class="n">body</span> <span class="o">=</span> <span class="n">foralls_get</span> <span class="n">body</span>
        <span class="nb">vars</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="p">((</span><span class="n">r</span><span class="p">,(</span><span class="n">name</span><span class="p">,</span><span class="n">_</span><span class="p">)),</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">Map</span><span class="o">.</span><span class="n">containsKey</span> <span class="n">name</span> <span class="n">env</span><span class="o">.</span><span class="n">ty</span> <span class="n">then</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">ShadowedForall</span><span class="p">))</span>
        <span class="n">let</span> <span class="nb">vars</span><span class="p">,</span><span class="n">env_ty</span> <span class="o">=</span> <span class="n">typevars</span> <span class="n">scope</span> <span class="n">env</span> <span class="nb">vars</span>
        <span class="n">let</span> <span class="n">body_var</span> <span class="o">=</span> <span class="n">fresh_var</span> <span class="n">scope</span>
        <span class="n">term</span> <span class="n">scope</span> <span class="p">{</span><span class="n">env</span> <span class="k">with</span> <span class="n">ty</span> <span class="o">=</span> <span class="n">env_ty</span><span class="p">}</span> <span class="n">body_var</span> <span class="n">body</span>
        <span class="n">let</span> <span class="n">t</span> <span class="o">=</span> <span class="n">generalize</span> <span class="n">r</span> <span class="n">scope</span> <span class="nb">vars</span> <span class="n">body_var</span>
        <span class="n">generalized_statements</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">body</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
        <span class="n">hover_types</span><span class="o">.</span><span class="n">AddHover</span><span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">t</span><span class="p">,</span><span class="s2">""</span><span class="p">))</span>
        <span class="p">{</span><span class="n">env</span> <span class="k">with</span> <span class="n">term</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">name</span> <span class="n">t</span> <span class="n">env</span><span class="o">.</span><span class="n">term</span> <span class="p">}</span>
    <span class="ow">and</span> <span class="n">rec_block</span> <span class="n">scope</span> <span class="n">env</span> <span class="n">l</span><span class="s1">' =</span>
        <span class="n">let</span> <span class="n">rec</span> <span class="n">term_annotations</span> <span class="n">scope</span> <span class="n">env</span> <span class="n">x</span> <span class="o">=</span>
            <span class="n">let</span> <span class="n">f</span> <span class="n">t</span> <span class="o">=</span> 
                <span class="n">let</span> <span class="n">i</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">Count</span>
                <span class="n">let</span> <span class="n">v</span> <span class="o">=</span> <span class="n">fresh_var</span> <span class="n">scope</span>
                <span class="n">ty_init</span> <span class="n">scope</span> <span class="n">env</span> <span class="n">v</span> <span class="n">t</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">Count</span> <span class="o">&amp;&amp;</span> <span class="n">has_metavars</span> <span class="n">v</span> <span class="n">then</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">range_of_texpr</span> <span class="n">t</span><span class="p">,</span> <span class="n">RecursiveAnnotationHasMetavars</span> <span class="n">v</span><span class="p">)</span>
                <span class="n">v</span>
            <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">RawFun</span><span class="p">(</span><span class="n">_</span><span class="p">,[(</span><span class="n">PatAnnot</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="o">|</span> <span class="n">PatDyn</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">PatAnnot</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">t</span><span class="p">))),</span><span class="n">body</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">TyFun</span><span class="p">(</span><span class="n">f</span> <span class="n">t</span><span class="p">,</span> <span class="n">term_annotations</span> <span class="n">scope</span> <span class="n">env</span> <span class="n">body</span><span class="p">,</span><span class="n">FT_Vanilla</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">RawFun</span><span class="p">(</span><span class="n">_</span><span class="p">,[</span><span class="n">pat</span><span class="p">,</span><span class="n">body</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">range_of_pattern</span> <span class="n">pat</span><span class="p">,</span> <span class="n">ExpectedAnnotation</span><span class="p">);</span> <span class="n">TyFun</span><span class="p">(</span><span class="n">fresh_var</span> <span class="n">scope</span><span class="p">,</span> <span class="n">term_annotations</span> <span class="n">scope</span> <span class="n">env</span> <span class="n">body</span><span class="p">,</span><span class="n">FT_Vanilla</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">RawFun</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ExpectedSinglePattern</span><span class="p">);</span> <span class="n">TyFun</span><span class="p">(</span><span class="n">fresh_var</span> <span class="n">scope</span><span class="p">,</span> <span class="n">fresh_var</span> <span class="n">scope</span><span class="p">,</span> <span class="n">FT_Vanilla</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">RawJoinPoint</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">RawAnnot</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">t</span><span class="p">),</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">RawAnnot</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">t</span>
            <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">range_of_expr</span> <span class="n">x</span><span class="p">,</span><span class="n">ExpectedAnnotation</span><span class="p">);</span> <span class="n">fresh_var</span> <span class="n">scope</span>
        <span class="n">let</span> <span class="n">scope</span> <span class="o">=</span> <span class="n">scope</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">let</span> <span class="n">has_foralls</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">exists</span> <span class="p">(</span><span class="n">function</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">RawForall</span> <span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">true</span> <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">false</span><span class="p">)</span> <span class="n">l</span><span class="s1">'</span>
        <span class="n">let</span> <span class="n">l</span><span class="p">,</span><span class="n">m</span> <span class="o">=</span>
            <span class="k">if</span> <span class="n">has_foralls</span> <span class="n">then</span>
                <span class="n">List</span><span class="o">.</span><span class="n">mapFold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">name</span><span class="p">),</span><span class="n">body</span><span class="p">)</span> <span class="o">-&gt;</span>
                    <span class="n">let</span> <span class="nb">vars</span><span class="p">,</span><span class="n">body</span> <span class="o">=</span> <span class="n">foralls_get</span> <span class="n">body</span>
                    <span class="nb">vars</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">Map</span><span class="o">.</span><span class="n">containsKey</span> <span class="p">(</span><span class="n">typevar_name</span> <span class="n">x</span><span class="p">)</span> <span class="n">env</span><span class="o">.</span><span class="n">ty</span> <span class="n">then</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">range_of_typevar</span> <span class="n">x</span><span class="p">,</span><span class="n">ShadowedForall</span><span class="p">))</span>
                    <span class="n">let</span> <span class="nb">vars</span><span class="p">,</span> <span class="n">env_ty</span> <span class="o">=</span> <span class="n">typevars</span> <span class="n">scope</span> <span class="n">env</span> <span class="nb">vars</span>
                    <span class="n">let</span> <span class="n">body_var</span> <span class="o">=</span> <span class="n">term_annotations</span> <span class="n">scope</span> <span class="p">{</span><span class="n">env</span> <span class="k">with</span> <span class="n">ty</span> <span class="o">=</span> <span class="n">env_ty</span><span class="p">}</span> <span class="n">body</span>
                    <span class="n">let</span> <span class="n">term</span> <span class="n">env</span> <span class="o">=</span> <span class="n">term</span> <span class="n">scope</span> <span class="p">{</span><span class="n">env</span> <span class="k">with</span> <span class="n">ty</span> <span class="o">=</span> <span class="n">env_ty</span><span class="p">}</span> <span class="n">body_var</span> <span class="n">body</span>
                    <span class="n">let</span> <span class="n">gen</span> <span class="n">env</span> <span class="p">:</span> <span class="n">InferEnv</span> <span class="o">=</span>
                        <span class="n">let</span> <span class="n">t</span> <span class="o">=</span> <span class="n">generalize</span> <span class="n">r</span> <span class="n">scope</span> <span class="nb">vars</span> <span class="n">body_var</span>
                        <span class="n">generalized_statements</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">body</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
                        <span class="n">hover_types</span><span class="o">.</span><span class="n">AddHover</span><span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">t</span><span class="p">,</span><span class="s2">""</span><span class="p">))</span>
                        <span class="p">{</span><span class="n">env</span> <span class="k">with</span> <span class="n">term</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">name</span> <span class="n">t</span> <span class="n">env</span><span class="o">.</span><span class="n">term</span><span class="p">}</span>
                    <span class="n">let</span> <span class="n">ty</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">TyForall</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">s</span><span class="p">))</span> <span class="nb">vars</span> <span class="n">body_var</span> <span class="o">|&gt;</span> <span class="n">term_subst</span>
                    <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">gen</span><span class="p">),</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">name</span> <span class="n">ty</span> <span class="n">s</span>
                    <span class="p">)</span> <span class="n">env</span><span class="o">.</span><span class="n">term</span> <span class="n">l</span><span class="s1">'</span>
            <span class="k">else</span>
                <span class="n">List</span><span class="o">.</span><span class="n">mapFold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">name</span><span class="p">),</span><span class="n">body</span><span class="p">)</span> <span class="o">-&gt;</span>
                    <span class="n">let</span> <span class="n">body_var</span> <span class="o">=</span> <span class="n">fresh_var</span> <span class="n">scope</span>
                    <span class="n">let</span> <span class="n">term</span> <span class="n">env</span> <span class="o">=</span> <span class="n">term</span> <span class="n">scope</span> <span class="n">env</span> <span class="n">body_var</span> <span class="n">body</span>
                    <span class="n">let</span> <span class="n">gen</span> <span class="n">env</span> <span class="p">:</span> <span class="n">InferEnv</span> <span class="o">=</span>
                        <span class="n">let</span> <span class="n">t</span> <span class="o">=</span> <span class="n">generalize</span> <span class="n">r</span> <span class="n">scope</span> <span class="p">[]</span> <span class="n">body_var</span>
                        <span class="n">generalized_statements</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">body</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
                        <span class="n">hover_types</span><span class="o">.</span><span class="n">AddHover</span><span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">t</span><span class="p">,</span><span class="s2">""</span><span class="p">))</span>
                        <span class="p">{</span><span class="n">env</span> <span class="k">with</span> <span class="n">term</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">name</span> <span class="n">t</span> <span class="n">env</span><span class="o">.</span><span class="n">term</span><span class="p">}</span>
                    <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">gen</span><span class="p">),</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">name</span> <span class="n">body_var</span> <span class="n">s</span>
                    <span class="p">)</span> <span class="n">env</span><span class="o">.</span><span class="n">term</span> <span class="n">l</span><span class="s1">'</span>
        <span class="n">let</span> <span class="n">_</span> <span class="o">=</span>
            <span class="n">let</span> <span class="n">env</span> <span class="o">=</span> <span class="p">{</span><span class="n">env</span> <span class="k">with</span> <span class="n">term</span> <span class="o">=</span> <span class="n">m</span><span class="p">}</span>
            <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">term</span> <span class="n">env</span><span class="p">)</span> <span class="n">l</span>
        <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">env</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">gen</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gen</span> <span class="n">env</span><span class="p">)</span> <span class="n">env</span> <span class="n">l</span>
    <span class="ow">and</span> <span class="n">ty_init</span> <span class="n">scope</span> <span class="n">env</span> <span class="n">s</span> <span class="n">x</span> <span class="o">=</span> 
        <span class="n">ty</span> <span class="n">scope</span> <span class="n">env</span> <span class="n">s</span> <span class="n">x</span>
        <span class="n">assert_foralls_used</span> <span class="n">errors</span> <span class="p">(</span><span class="n">range_of_texpr</span> <span class="n">x</span><span class="p">)</span> <span class="n">s</span>
    <span class="ow">and</span> <span class="n">ty</span> <span class="n">scope</span> <span class="n">env</span> <span class="n">s</span> <span class="n">x</span> <span class="o">=</span> <span class="n">ty</span><span class="s1">' scope false env s x</span>
    <span class="ow">and</span> <span class="n">ty</span><span class="s1">' scope is_in_left_apply (env : InferEnv) s x =</span>
        <span class="n">let</span> <span class="n">f</span> <span class="n">s</span> <span class="n">x</span> <span class="o">=</span> <span class="n">ty</span> <span class="n">scope</span> <span class="n">env</span> <span class="n">s</span> <span class="n">x</span>
        <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">RawTTypecase</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: Type level typecase should not appear in the top down segment."</span>
        <span class="o">|</span> <span class="n">RawTWildcard</span> <span class="n">r</span> <span class="o">-&gt;</span> <span class="n">hover_types</span><span class="o">.</span><span class="n">AddHover</span><span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">s</span><span class="p">,</span><span class="s2">""</span><span class="p">))</span>
        <span class="o">|</span> <span class="n">RawTArray</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">v</span> <span class="o">=</span> <span class="n">fresh_var</span> <span class="n">scope</span>
            <span class="n">unify</span> <span class="n">r</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyArray</span> <span class="n">v</span><span class="p">)</span>
            <span class="n">f</span> <span class="n">v</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">RawTVar</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">v_ty</span> <span class="n">env</span> <span class="n">x</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">Some</span> <span class="p">(</span><span class="n">TyModule</span> <span class="n">_</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span> <span class="n">when</span> <span class="n">is_in_left_apply</span> <span class="o">=</span> <span class="n">false</span> <span class="o">-&gt;</span> <span class="n">hover_types</span><span class="o">.</span><span class="n">AddHover</span><span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">m</span><span class="p">,</span><span class="s2">""</span><span class="p">));</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">ModuleMustBeImmediatelyApplied</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">Some</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">unify</span> <span class="n">r</span> <span class="n">s</span> <span class="n">x</span><span class="p">;</span> <span class="n">hover_types</span><span class="o">.</span><span class="n">AddHover</span><span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">x</span><span class="p">,</span><span class="s2">""</span><span class="p">))</span>
            <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">UnboundVariable</span> <span class="n">x</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawTB</span> <span class="n">r</span> <span class="o">-&gt;</span> <span class="n">unify</span> <span class="n">r</span> <span class="n">s</span> <span class="n">TyB</span>
        <span class="o">|</span> <span class="n">RawTLit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">unify</span> <span class="n">r</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyLit</span> <span class="n">x</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawTSymbol</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">unify</span> <span class="n">r</span> <span class="n">s</span> <span class="p">(</span><span class="n">TySymbol</span> <span class="n">x</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawTPrim</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">unify</span> <span class="n">r</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyPrim</span> <span class="n">x</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawTPair</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">q</span><span class="p">,</span><span class="n">w</span> <span class="o">=</span> <span class="n">fresh_var</span> <span class="n">scope</span><span class="p">,</span> <span class="n">fresh_var</span> <span class="n">scope</span>
            <span class="n">unify</span> <span class="n">r</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyPair</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">w</span><span class="p">))</span>
            <span class="n">f</span> <span class="n">q</span> <span class="n">a</span><span class="p">;</span> <span class="n">f</span> <span class="n">w</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">RawTFun</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">q</span><span class="p">,</span><span class="n">w</span> <span class="o">=</span> <span class="n">fresh_var</span> <span class="n">scope</span><span class="p">,</span> <span class="n">fresh_var</span> <span class="n">scope</span>
            <span class="n">unify</span> <span class="n">r</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyFun</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">t</span><span class="p">))</span>
            <span class="n">f</span> <span class="n">q</span> <span class="n">a</span><span class="p">;</span> <span class="n">f</span> <span class="n">w</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">RawTRecord</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">l</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">l</span><span class="s1">' = Map.map (fun _ _ -&gt; fresh_var scope) l</span>
            <span class="n">unify</span> <span class="n">r</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyRecord</span> <span class="n">l</span><span class="s1">')</span>
            <span class="n">Map</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">k</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">s</span> <span class="n">l</span><span class="o">.</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="n">l</span><span class="s1">'</span>
        <span class="o">|</span> <span class="n">RawTUnion</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">lay</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">l</span><span class="s1">' = Map.map (fun _ (is_gadt,_) -&gt; is_gadt, fresh_var scope) l</span>
            <span class="n">unify</span> <span class="n">r</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyUnion</span><span class="p">(</span><span class="n">l</span><span class="s1">',lay))</span>
            <span class="n">Map</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">k</span> <span class="p">(</span><span class="n">is_gadt</span><span class="p">,</span><span class="n">s</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">snd</span> <span class="n">l</span><span class="o">.</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">in</span> <span class="k">if</span> <span class="n">is_gadt</span> <span class="n">then</span> <span class="n">ty</span> <span class="n">scope</span> <span class="p">{</span><span class="n">env</span> <span class="k">with</span> <span class="n">ty</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">}</span> <span class="n">s</span> <span class="n">x</span> <span class="k">else</span> <span class="n">f</span> <span class="n">s</span> <span class="n">x</span><span class="p">)</span> <span class="n">l</span><span class="s1">'</span>
        <span class="o">|</span> <span class="n">RawTExists</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">typevar_to_var</span> <span class="n">scope</span> <span class="n">env</span><span class="o">.</span><span class="n">constraints</span><span class="p">)</span> <span class="n">a</span>
            <span class="n">let</span> <span class="n">body_var</span> <span class="o">=</span> <span class="n">fresh_var</span> <span class="n">scope</span>
            <span class="n">ty</span> <span class="n">scope</span> <span class="p">{</span><span class="n">env</span> <span class="k">with</span> <span class="n">ty</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="p">(</span><span class="n">tyvar</span> <span class="n">a</span><span class="p">)</span> <span class="n">s</span><span class="p">)</span> <span class="n">env</span><span class="o">.</span><span class="n">ty</span> <span class="n">a</span><span class="p">}</span> <span class="n">body_var</span> <span class="n">b</span>
            <span class="n">unify</span> <span class="n">r</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyExists</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">body_var</span><span class="p">))</span>
        <span class="o">|</span> <span class="n">RawTForall</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">typevar_to_var</span> <span class="n">scope</span> <span class="n">env</span><span class="o">.</span><span class="n">constraints</span> <span class="n">a</span>
            <span class="n">let</span> <span class="n">body_var</span> <span class="o">=</span> <span class="n">fresh_var</span> <span class="n">scope</span>
            <span class="n">ty</span> <span class="n">scope</span> <span class="p">{</span><span class="n">env</span> <span class="k">with</span> <span class="n">ty</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="p">(</span><span class="n">tyvar</span> <span class="n">a</span><span class="p">)</span> <span class="n">env</span><span class="o">.</span><span class="n">ty</span><span class="p">}</span> <span class="n">body_var</span> <span class="n">b</span>
            <span class="n">unify</span> <span class="n">r</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyForall</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">body_var</span><span class="p">))</span>
        <span class="o">|</span> <span class="n">RawTApply</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="s1">',b) -&gt;</span>
            <span class="n">let</span> <span class="sa">f</span><span class="s1">' b k x = let v = fresh_var'</span> <span class="n">scope</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ty</span><span class="s1">' scope b env v x; visit_t v</span>
            <span class="k">match</span> <span class="sa">f</span><span class="s1">' true (fresh_kind ()) a'</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">TyModule</span> <span class="n">l</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="sa">f</span><span class="s1">' false KindType b with</span>
                <span class="o">|</span> <span class="n">TySymbol</span> <span class="n">x</span> <span class="o">-&gt;</span>
                    <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">x</span> <span class="n">l</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">Some</span> <span class="p">(</span><span class="n">TyModule</span> <span class="n">_</span> <span class="k">as</span> <span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span>
                        <span class="k">if</span> <span class="n">is_in_left_apply</span> <span class="n">then</span> 
                            <span class="n">unify</span> <span class="n">r</span> <span class="n">s</span> <span class="n">a</span>
                            <span class="k">match</span><span class="w"> </span><span class="n">b</span> <span class="k">with</span> <span class="n">RawTSymbol</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="k">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">hover_types</span><span class="o">.</span><span class="n">AddHover</span><span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">a</span><span class="p">,</span><span class="s2">""</span><span class="p">))</span> <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="p">()</span>
                        <span class="k">else</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">ModuleMustBeImmediatelyApplied</span><span class="p">)</span>
                    <span class="o">|</span> <span class="n">Some</span> <span class="n">a</span> <span class="o">-&gt;</span> 
                        <span class="n">unify</span> <span class="n">r</span> <span class="n">s</span> <span class="n">a</span>
                        <span class="k">match</span> <span class="n">b</span> <span class="k">with</span>
                        <span class="o">|</span> <span class="n">RawTSymbol</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span>
                            <span class="n">let</span> <span class="n">com</span> <span class="o">=</span> <span class="n">match</span> <span class="n">a</span> <span class="k">with</span> <span class="n">TyComment</span><span class="p">(</span><span class="n">com</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">com</span> <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="s2">""</span>
                            <span class="n">hover_types</span><span class="o">.</span><span class="n">AddHover</span><span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">a</span><span class="p">,</span><span class="n">com</span><span class="p">))</span>
                        <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="p">()</span>
                    <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">ModuleIndexFailed</span> <span class="n">x</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">ExpectedSymbolAsRecordKey</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">TyInl</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">body</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">v</span> <span class="o">=</span> <span class="n">fresh_var</span><span class="s1">' scope a.kind in f v b; unify r s (subst [a,v] body)</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">q</span><span class="p">,</span><span class="n">w</span> <span class="o">=</span> <span class="n">fresh_kind</span><span class="p">(),</span> <span class="n">fresh_kind</span><span class="p">()</span>
                <span class="n">unify_kind</span> <span class="p">(</span><span class="n">range_of_texpr</span> <span class="n">a</span><span class="s1">') (tt top_env a) (KindFun(q,w))</span>
                <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">fresh_var</span><span class="s1">' scope q</span>
                <span class="n">f</span> <span class="n">x</span> <span class="n">b</span>
                <span class="n">unify</span> <span class="n">r</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyApply</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">w</span><span class="p">))</span>
        <span class="o">|</span> <span class="n">RawTTerm</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">assert_bound_vars</span> <span class="n">env</span> <span class="n">a</span><span class="p">;</span> <span class="n">unify</span> <span class="n">r</span> <span class="n">s</span> <span class="p">(</span><span class="n">TySymbol</span> <span class="s2">"&lt;term&gt;"</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawTMacro</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">function</span>
                <span class="o">|</span> <span class="n">RawMacroText</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TMText</span> <span class="n">a</span>
                <span class="o">|</span> <span class="n">RawMacroTerm</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: Term vars should never appear at the type level."</span>
                <span class="o">|</span> <span class="n">RawMacroType</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">RawMacroTypeLit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">v</span> <span class="o">=</span> <span class="n">fresh_var</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">f</span> <span class="n">v</span> <span class="n">a</span><span class="p">;</span> <span class="n">TMVar</span> <span class="n">v</span>
                <span class="p">)</span> <span class="n">a</span>
            <span class="o">|&gt;</span> <span class="n">TyMacro</span> <span class="o">|&gt;</span> <span class="n">unify</span> <span class="n">r</span> <span class="n">s</span>
        <span class="o">|</span> <span class="n">RawTLayout</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">v</span> <span class="o">=</span> <span class="n">fresh_var</span> <span class="n">scope</span>
            <span class="n">unify</span> <span class="n">r</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyLayout</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">b</span><span class="p">))</span>
            <span class="n">f</span> <span class="n">v</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">RawTFilledNominal</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: RawTNominal should be filled in by the inferencer."</span>
        <span class="o">|</span> <span class="n">RawTMetaVar</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: This particular metavar is only for typecase's clauses. This happens during the bottom-up segment."</span>
    <span class="ow">and</span> <span class="n">pattern</span> <span class="p">(</span><span class="n">scope</span> <span class="p">:</span> <span class="n">InferScope</span><span class="p">)</span> <span class="p">(</span><span class="n">env</span> <span class="p">:</span> <span class="n">InferEnv</span><span class="p">)</span> <span class="n">s</span> <span class="n">a</span> <span class="p">:</span> <span class="n">T</span> <span class="n">option</span> <span class="n">ref</span> <span class="n">ResizeArray</span> <span class="o">*</span> <span class="p">(</span><span class="n">T</span> <span class="o">*</span> <span class="n">T</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">T</span><span class="p">)</span> <span class="n">ResizeArray</span> <span class="o">*</span> <span class="p">(</span><span class="n">InferScope</span> <span class="o">*</span> <span class="n">InferEnv</span><span class="p">)</span> <span class="o">=</span> 
        <span class="n">let</span> <span class="n">gadt_links</span> <span class="o">=</span> <span class="n">ResizeArray</span><span class="p">()</span>
        <span class="n">let</span> <span class="n">gadt_typecases</span> <span class="o">=</span> <span class="n">ResizeArray</span><span class="p">()</span>
        <span class="n">let</span> <span class="n">term_vars</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Structural</span><span class="p">)</span>
        <span class="n">let</span> <span class="n">ty_vars</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Structural</span><span class="p">)</span>
        <span class="n">let</span> <span class="n">mutable</span> <span class="n">scope</span> <span class="o">=</span> <span class="n">scope</span>
        <span class="n">let</span> <span class="n">update_env</span> <span class="p">()</span> <span class="o">=</span>
            <span class="n">scope</span><span class="p">,</span>
            <span class="p">{</span><span class="n">env</span> <span class="k">with</span>
                <span class="n">ty</span> <span class="o">=</span> <span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">ty</span><span class="p">,</span><span class="n">ty_vars</span><span class="p">)</span> <span class="o">||&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">x</span><span class="o">.</span><span class="n">Key</span> <span class="n">x</span><span class="o">.</span><span class="n">Value</span> <span class="n">s</span><span class="p">)</span>
                <span class="n">term</span> <span class="o">=</span> <span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">term</span><span class="p">,</span><span class="n">term_vars</span><span class="p">)</span> <span class="o">||&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">x</span><span class="o">.</span><span class="n">Key</span> <span class="n">x</span><span class="o">.</span><span class="n">Value</span> <span class="n">s</span><span class="p">)</span>
                <span class="p">}</span>
        <span class="n">let</span> <span class="n">ho_make</span> <span class="p">(</span><span class="n">i</span> <span class="p">:</span> <span class="n">GlobalId</span><span class="p">)</span> <span class="p">(</span><span class="n">l</span> <span class="p">:</span> <span class="n">Var</span> <span class="nb">list</span><span class="p">)</span> <span class="o">=</span>
            <span class="n">let</span> <span class="n">h</span> <span class="o">=</span> <span class="n">TyNominal</span> <span class="n">i</span>
            <span class="n">let</span> <span class="n">l</span><span class="s1">' = List.map (fun (x : Var) -&gt; x, fresh_subst_var scope x.constraints x.kind) l</span>
            <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">match</span> <span class="n">tt</span> <span class="n">top_env</span> <span class="n">s</span> <span class="k">with</span> <span class="n">KindFun</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TyApply</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"impossible"</span><span class="p">)</span> <span class="n">h</span> <span class="n">l</span><span class="s1">', l'</span>
        <span class="n">let</span> <span class="n">rec</span> <span class="n">ho_index</span> <span class="n">x</span> <span class="o">=</span>
            <span class="k">match</span> <span class="n">visit_t</span> <span class="n">x</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">TyApply</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ho_index</span> <span class="n">a</span> 
            <span class="o">|</span> <span class="n">TyNominal</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">ValueSome</span> <span class="n">i</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">ValueNone</span>
        <span class="n">let</span> <span class="n">rec</span> <span class="n">ho_fun</span> <span class="n">x</span> <span class="o">=</span> 
            <span class="k">match</span> <span class="n">visit_t</span> <span class="n">x</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">TyFun</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyForall</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ho_fun</span> <span class="n">a</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">ho_index</span> <span class="n">a</span>
        <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="n">s</span> <span class="n">x</span> <span class="p">:</span> <span class="n">unit</span> <span class="o">=</span>
            <span class="n">let</span> <span class="n">f</span> <span class="o">=</span> <span class="n">loop</span>
            <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">PatFilledDefaultValue</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: PatDefaultValueFilled should not appear during inference."</span>
            <span class="o">|</span> <span class="n">PatB</span> <span class="n">r</span> <span class="o">-&gt;</span> <span class="n">unify</span> <span class="n">r</span> <span class="n">s</span> <span class="n">TyB</span>
            <span class="o">|</span> <span class="n">PatE</span> <span class="n">r</span> <span class="o">-&gt;</span> <span class="n">hover_types</span><span class="o">.</span><span class="n">AddHover</span><span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">s</span><span class="p">,</span><span class="s2">""</span><span class="p">))</span>
            <span class="o">|</span> <span class="n">PatVar</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">term_vars</span><span class="o">.</span><span class="n">TryGetValue</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">true</span><span class="p">,</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">unify</span> <span class="n">r</span> <span class="n">s</span> <span class="n">v</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">term_vars</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
                <span class="n">hover_types</span><span class="o">.</span><span class="n">AddHover</span><span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">s</span><span class="p">,</span><span class="s2">""</span><span class="p">))</span>
            <span class="o">|</span> <span class="n">PatDyn</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">s</span> <span class="n">a</span>
            <span class="o">|</span> <span class="n">PatAnnot</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ty_init</span> <span class="n">scope</span> <span class="n">env</span> <span class="n">s</span> <span class="n">b</span><span class="p">;</span> <span class="n">f</span> <span class="n">s</span> <span class="n">a</span>
            <span class="o">|</span> <span class="n">PatWhen</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> 
                <span class="n">f</span> <span class="n">s</span> <span class="n">a</span>
                <span class="n">let</span> <span class="n">scope</span><span class="p">,</span><span class="n">env</span> <span class="o">=</span> <span class="n">update_env</span><span class="p">()</span>
                <span class="n">term</span> <span class="n">scope</span> <span class="n">env</span> <span class="p">(</span><span class="n">TyPrim</span> <span class="n">BoolT</span><span class="p">)</span> <span class="n">b</span>
            <span class="o">|</span> <span class="n">PatPair</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">q</span><span class="p">,</span><span class="n">w</span> <span class="o">=</span> <span class="n">fresh_var</span> <span class="n">scope</span><span class="p">,</span> <span class="n">fresh_var</span> <span class="n">scope</span>
                <span class="n">unify</span> <span class="n">r</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyPair</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">w</span><span class="p">))</span>
                <span class="n">loop</span> <span class="n">q</span> <span class="n">a</span><span class="p">;</span> <span class="n">loop</span> <span class="n">w</span> <span class="n">b</span>
            <span class="o">|</span> <span class="n">PatSymbol</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">unify</span> <span class="n">r</span> <span class="n">s</span> <span class="p">(</span><span class="n">TySymbol</span> <span class="n">a</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">PatOr</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="n">PatAnd</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="n">s</span> <span class="n">a</span><span class="p">;</span> <span class="n">loop</span> <span class="n">s</span> <span class="n">b</span>
            <span class="o">|</span> <span class="n">PatValue</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">unify</span> <span class="n">r</span> <span class="n">s</span> <span class="p">(</span><span class="n">lit</span> <span class="n">a</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">PatDefaultValue</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> 
                <span class="n">annotations</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">x</span><span class="p">,(</span><span class="n">r</span><span class="p">,</span><span class="n">s</span><span class="p">))</span>
                <span class="n">unify</span> <span class="n">r</span> <span class="n">s</span> <span class="p">(</span><span class="n">fresh_subst_var</span> <span class="n">scope</span> <span class="p">(</span><span class="n">Set</span><span class="o">.</span><span class="n">singleton</span> <span class="n">CNumber</span><span class="p">)</span> <span class="n">KindType</span><span class="p">)</span>
                <span class="n">hover_types</span><span class="o">.</span><span class="n">AddHover</span><span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">s</span><span class="p">,</span><span class="s2">""</span><span class="p">))</span>
            <span class="o">|</span> <span class="n">PatRecordMembers</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">l</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">l</span> <span class="o">=</span>
                    <span class="n">List</span><span class="o">.</span><span class="n">choose</span> <span class="p">(</span><span class="n">function</span>
                        <span class="o">|</span> <span class="n">PatRecordMembersSymbol</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Some</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
                        <span class="o">|</span> <span class="n">PatRecordMembersInjectVar</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
                            <span class="k">match</span> <span class="n">v_term</span> <span class="n">env</span> <span class="n">a</span> <span class="k">with</span>
                            <span class="o">|</span> <span class="n">Some</span> <span class="p">(</span><span class="n">com</span><span class="p">,</span><span class="n">TySymbol</span> <span class="n">a</span> <span class="o">&amp;</span> <span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">hover_types</span><span class="o">.</span><span class="n">AddHover</span><span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">x</span><span class="p">,</span><span class="n">com</span><span class="p">));</span> <span class="n">Some</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
                            <span class="o">|</span> <span class="n">Some</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ExpectedSymbolAsRecordKey</span> <span class="n">x</span><span class="p">);</span> <span class="kc">None</span>
                            <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">UnboundVariable</span> <span class="n">a</span><span class="p">);</span> <span class="kc">None</span>
                        <span class="p">)</span> <span class="n">l</span>
                <span class="k">match</span> <span class="n">visit_t</span> <span class="n">s</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">TyRecord</span> <span class="n">l</span><span class="s1">' as s -&gt;</span>
                    <span class="n">let</span> <span class="n">l</span><span class="p">,</span> <span class="n">missing</span> <span class="o">=</span>
                        <span class="n">List</span><span class="o">.</span><span class="n">mapFoldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="n">missing</span> <span class="o">-&gt;</span>
                            <span class="k">match</span> <span class="n">l</span><span class="s1">' |&gt; Map.tryPick (fun (i, k) v -&gt; if k = a then Some (i, v) else None) with</span>
                            <span class="o">|</span> <span class="n">Some</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">b</span><span class="p">),</span> <span class="n">missing</span>
                            <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">fresh_var</span> <span class="n">scope</span><span class="p">,</span><span class="n">b</span><span class="p">),</span> <span class="n">a</span> <span class="p">::</span> <span class="n">missing</span>
                            <span class="p">)</span> <span class="n">l</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="n">List</span><span class="o">.</span><span class="n">isEmpty</span> <span class="n">missing</span> <span class="o">=</span> <span class="n">false</span> <span class="n">then</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">MissingRecordFieldsInPattern</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">missing</span><span class="p">))</span>
                    <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="n">a</span> <span class="n">b</span><span class="p">)</span> <span class="n">l</span>
                <span class="o">|</span> <span class="n">s</span> <span class="o">-&gt;</span>
                    <span class="n">let</span> <span class="n">l</span> <span class="o">=</span>
                        <span class="n">List</span><span class="o">.</span><span class="n">mapi</span> <span class="p">(</span><span class="n">fun</span> <span class="n">i</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> 
                            <span class="n">let</span> <span class="n">v</span> <span class="o">=</span> <span class="n">fresh_var</span> <span class="n">scope</span>
                            <span class="n">loop</span> <span class="n">v</span> <span class="n">b</span>
                            <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">a</span><span class="p">),</span> <span class="n">v</span>
                            <span class="p">)</span> <span class="n">l</span>
                    <span class="n">unify</span> <span class="n">r</span> <span class="n">s</span> <span class="p">(</span><span class="n">l</span> <span class="o">|&gt;</span> <span class="n">Map</span> <span class="o">|&gt;</span> <span class="n">TyRecord</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">PatExists</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">l</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">Map</span><span class="o">.</span><span class="n">containsKey</span> <span class="n">name</span> <span class="n">env</span><span class="o">.</span><span class="n">ty</span> <span class="n">then</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">ShadowedExists</span><span class="p">))</span>
                <span class="k">match</span> <span class="n">visit_t</span> <span class="n">s</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">TyExists</span><span class="p">(</span><span class="n">type_var_list</span><span class="p">,</span><span class="n">type_body</span><span class="p">)</span> <span class="o">-&gt;</span>
                    <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">Length</span> <span class="o">=</span> <span class="n">type_var_list</span><span class="o">.</span><span class="n">Length</span> <span class="n">then</span>
                        <span class="n">scope</span> <span class="o">&lt;-</span> <span class="n">scope</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="n">let</span> <span class="nb">vars</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">type_var_list</span><span class="p">)</span> <span class="o">||&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map2</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">name</span><span class="p">)</span> <span class="n">l</span> <span class="o">-&gt;</span> 
                            <span class="n">memoize</span> <span class="n">ty_vars</span> <span class="p">(</span><span class="n">fun</span> <span class="n">name</span> <span class="o">-&gt;</span> <span class="n">tyvar</span> <span class="p">{</span><span class="n">l</span> <span class="k">with</span> <span class="n">scope</span><span class="o">=</span><span class="n">scope</span><span class="p">;</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">})</span> <span class="n">name</span>
                            <span class="p">)</span>
                        <span class="n">loop</span> <span class="p">(</span><span class="n">subst</span> <span class="p">(</span><span class="n">List</span><span class="o">.</span><span class="n">zip</span> <span class="n">type_var_list</span> <span class="nb">vars</span><span class="p">)</span> <span class="n">type_body</span><span class="p">)</span> <span class="n">p</span>
                    <span class="k">else</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">UnexpectedNumberOfArgumentsInExistsPattern</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">Length</span><span class="p">,</span><span class="n">type_var_list</span><span class="o">.</span><span class="n">Length</span><span class="p">))</span>
                <span class="o">|</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ExpectedExistentialInPattern</span> <span class="n">s</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">PatUnbox</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">assume</span> <span class="n">i</span> <span class="o">=</span>
                    <span class="n">let</span> <span class="n">n</span> <span class="o">=</span> <span class="n">top_env</span><span class="o">.</span><span class="n">nominals</span><span class="o">.</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">match</span> <span class="n">n</span><span class="o">.</span><span class="n">body</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">TyUnion</span><span class="p">(</span><span class="n">cases</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span>
                        <span class="n">let</span> <span class="n">x</span><span class="p">,</span><span class="n">m</span> <span class="o">=</span> <span class="n">ho_make</span> <span class="n">i</span> <span class="n">n</span><span class="o">.</span><span class="n">vars</span>
                        <span class="n">unify</span> <span class="n">r</span> <span class="n">s</span> <span class="n">x</span>
                        <span class="k">match</span><span class="w"> </span><span class="n">Map</span><span class="o">.</span><span class="n">tryPick</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="k">_</span><span class="p">,</span> <span class="n">name</span><span class="s1">') v -&gt; if name = name'</span> <span class="n">then</span> <span class="n">Some</span> <span class="n">v</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span> <span class="n">cases</span> <span class="k">with</span>
                        <span class="o">|</span> <span class="n">Some</span> <span class="p">(</span><span class="n">is_gadt</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">-&gt;</span> 
                            <span class="k">if</span> <span class="n">is_gadt</span> <span class="n">then</span> 
                                <span class="n">scope</span> <span class="o">&lt;-</span> <span class="n">scope</span> <span class="o">+</span> <span class="mi">1</span>
                                <span class="n">let</span> <span class="n">forall_vars</span><span class="p">,</span><span class="n">body</span><span class="p">,</span><span class="n">specialized_constructor</span> <span class="o">=</span> <span class="n">gadt_extract</span> <span class="n">scope</span> <span class="n">v</span>
                                <span class="n">gadt_typecases</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">forall_vars</span><span class="p">,</span> <span class="n">specialized_constructor</span><span class="p">)</span>
                                <span class="k">match</span><span class="w"> </span><span class="n">a</span> <span class="k">with</span> <span class="n">PatE</span> <span class="sa">r</span><span class="s1">' when r = r'</span> <span class="o">-&gt;</span> <span class="p">()</span> <span class="o">|</span> <span class="k">_</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="n">body</span> <span class="n">a</span> <span class="o">//</span> <span class="n">This</span> <span class="n">check</span> <span class="k">for</span> <span class="n">PatE</span> <span class="ow">is</span> <span class="n">so</span> <span class="n">the</span> <span class="n">hovers</span> <span class="k">for</span> <span class="n">it</span> <span class="n">don</span><span class="s1">'t overwrite the main pattern.</span>
                                <span class="n">unify_gadt</span> <span class="p">(</span><span class="n">Some</span> <span class="n">gadt_links</span><span class="p">)</span> <span class="n">r</span> <span class="n">s</span> <span class="n">specialized_constructor</span>
                            <span class="k">else</span>
                                <span class="k">match</span><span class="w"> </span><span class="n">a</span> <span class="k">with</span> <span class="n">PatE</span> <span class="sa">r</span><span class="s1">' when r = r'</span> <span class="o">-&gt;</span> <span class="p">()</span> <span class="o">|</span> <span class="k">_</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="p">(</span><span class="n">subst</span> <span class="n">m</span> <span class="n">v</span><span class="p">)</span> <span class="n">a</span>
                            <span class="n">hover_types</span><span class="o">.</span><span class="n">AddHover</span><span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">s</span><span class="p">,</span><span class="s2">""</span><span class="p">))</span>
                        <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">CasePatternNotFoundForType</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">name</span><span class="p">));</span> <span class="n">f</span> <span class="p">(</span><span class="n">fresh_var</span> <span class="n">scope</span><span class="p">)</span> <span class="n">a</span>
                    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">NominalInPatternUnbox</span> <span class="n">i</span><span class="p">);</span> <span class="n">f</span> <span class="p">(</span><span class="n">fresh_var</span> <span class="n">scope</span><span class="p">)</span> <span class="n">a</span>
                <span class="k">match</span> <span class="n">ho_index</span> <span class="n">s</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">ValueSome</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">assume</span> <span class="n">i</span>
                <span class="o">|</span> <span class="n">ValueNone</span> <span class="o">-&gt;</span>
                    <span class="k">match</span> <span class="n">v_term</span> <span class="n">env</span> <span class="n">name</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">Some</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span>
                        <span class="k">match</span> <span class="n">ho_fun</span> <span class="n">x</span> <span class="k">with</span>
                        <span class="o">|</span> <span class="n">ValueSome</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">assume</span> <span class="n">i</span>
                        <span class="o">|</span> <span class="n">ValueNone</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">CannotInferCasePatternFromTermInEnv</span> <span class="n">x</span><span class="p">);</span> <span class="n">f</span> <span class="p">(</span><span class="n">fresh_var</span> <span class="n">scope</span><span class="p">)</span> <span class="n">a</span>
                    <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">CasePatternNotFound</span> <span class="n">name</span><span class="p">);</span> <span class="n">f</span> <span class="p">(</span><span class="n">fresh_var</span> <span class="n">scope</span><span class="p">)</span> <span class="n">a</span>
            <span class="o">|</span> <span class="n">PatNominal</span><span class="p">(</span><span class="n">_</span><span class="p">,(</span><span class="n">r</span><span class="p">,</span><span class="n">name</span><span class="p">),</span><span class="n">l</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">v_ty</span> <span class="n">env</span> <span class="n">name</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">Some</span> <span class="n">x</span> <span class="o">-&gt;</span>
                    <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="n">r</span> <span class="n">x</span> <span class="o">=</span> <span class="n">function</span>
                        <span class="o">|</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">name</span><span class="p">)</span> <span class="p">::</span> <span class="n">l</span> <span class="o">-&gt;</span>
                            <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
                            <span class="o">|</span> <span class="n">TyModule</span> <span class="n">x</span> <span class="o">-&gt;</span>
                                <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">name</span> <span class="n">x</span> <span class="k">with</span>
                                <span class="o">|</span> <span class="n">Some</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="n">r</span> <span class="n">x</span> <span class="n">l</span>
                                <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">ModuleIndexFailed</span> <span class="n">name</span><span class="p">);</span> <span class="n">f</span> <span class="p">(</span><span class="n">fresh_var</span> <span class="n">scope</span><span class="p">)</span> <span class="n">a</span>
                            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span>
                                <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">ExpectedModule</span> <span class="n">x</span><span class="p">);</span> <span class="n">f</span> <span class="p">(</span><span class="n">fresh_var</span> <span class="n">scope</span><span class="p">)</span> <span class="n">a</span>
                        <span class="o">|</span> <span class="p">[]</span> <span class="o">-&gt;</span>
                            <span class="k">match</span> <span class="n">ho_index</span> <span class="n">x</span> <span class="k">with</span>
                            <span class="o">|</span> <span class="n">ValueSome</span> <span class="n">i</span> <span class="o">-&gt;</span>
                                <span class="n">let</span> <span class="n">n</span> <span class="o">=</span> <span class="n">top_env</span><span class="o">.</span><span class="n">nominals</span><span class="o">.</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                                <span class="k">match</span> <span class="n">n</span><span class="o">.</span><span class="n">body</span> <span class="k">with</span>
                                <span class="o">|</span> <span class="n">TyUnion</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">UnionInPatternNominal</span> <span class="n">i</span><span class="p">);</span> <span class="n">f</span> <span class="p">(</span><span class="n">fresh_var</span> <span class="n">scope</span><span class="p">)</span> <span class="n">a</span>
                                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">x</span><span class="p">,</span><span class="n">m</span> <span class="o">=</span> <span class="n">ho_make</span> <span class="n">i</span> <span class="n">n</span><span class="o">.</span><span class="n">vars</span> <span class="ow">in</span> <span class="n">unify</span> <span class="n">r</span> <span class="n">s</span> <span class="n">x</span><span class="p">;</span> <span class="n">f</span> <span class="p">(</span><span class="n">subst</span> <span class="n">m</span> <span class="n">n</span><span class="o">.</span><span class="n">body</span><span class="p">)</span> <span class="n">a</span>
                            <span class="o">|</span> <span class="n">ValueNone</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">TypeInEnvIsNotNominal</span> <span class="n">x</span><span class="p">);</span> <span class="n">f</span> <span class="p">(</span><span class="n">fresh_var</span> <span class="n">scope</span><span class="p">)</span> <span class="n">a</span>
                    <span class="n">loop</span> <span class="n">r</span> <span class="n">x</span> <span class="n">l</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">UnboundVariable</span> <span class="n">name</span><span class="p">);</span> <span class="n">f</span> <span class="p">(</span><span class="n">fresh_var</span> <span class="n">scope</span><span class="p">)</span> <span class="n">a</span>
            <span class="o">|</span> <span class="n">PatArray</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">v</span> <span class="o">=</span> <span class="n">fresh_var</span> <span class="n">scope</span>
                <span class="n">unify</span> <span class="n">r</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyArray</span> <span class="n">v</span><span class="p">)</span>
                <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="n">v</span> <span class="n">x</span><span class="p">)</span> <span class="n">a</span>
        <span class="n">loop</span> <span class="n">s</span> <span class="n">a</span>
        <span class="n">gadt_links</span><span class="p">,</span> <span class="n">gadt_typecases</span><span class="p">,</span> <span class="n">update_env</span><span class="p">()</span>

    <span class="n">let</span> <span class="n">nominal_term</span> <span class="n">global_id</span> <span class="n">tt</span> <span class="n">name</span> <span class="nb">vars</span> <span class="n">v</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">constructor</span> <span class="n">body</span> <span class="o">=</span>
            <span class="n">let</span> <span class="n">t</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">k</span> <span class="o">=</span> <span class="n">trim_kind</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">TyApply</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">tyvar</span> <span class="n">b</span><span class="p">,</span><span class="n">k</span><span class="p">),</span><span class="n">k</span><span class="p">)</span> <span class="p">(</span><span class="n">TyNominal</span> <span class="n">global_id</span><span class="p">,</span><span class="n">tt</span><span class="p">)</span> <span class="nb">vars</span>
            <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">match</span> <span class="n">body</span> <span class="k">with</span> <span class="n">TyB</span> <span class="o">-&gt;</span> <span class="n">t</span> <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">TyFun</span><span class="p">(</span><span class="n">body</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">FT_Vanilla</span><span class="p">)</span>
            <span class="n">List</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="n">var</span> <span class="n">ty</span> <span class="o">-&gt;</span> <span class="n">TyForall</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="n">ty</span><span class="p">))</span> <span class="nb">vars</span> <span class="n">x</span>
        <span class="k">match</span> <span class="n">v</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">TyUnion</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">name</span><span class="p">)</span> <span class="p">(</span><span class="n">is_gadt</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">name</span> <span class="p">(</span><span class="k">if</span> <span class="n">is_gadt</span> <span class="n">then</span> <span class="n">v</span> <span class="k">else</span> <span class="n">constructor</span> <span class="n">v</span><span class="p">)</span> <span class="n">s</span><span class="p">)</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span> <span class="n">l</span>
        <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">name</span> <span class="p">(</span><span class="n">constructor</span> <span class="n">v</span><span class="p">)</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>

    <span class="n">let</span> <span class="n">psucc</span> <span class="o">=</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">Job</span><span class="o">.</span><span class="n">thunk</span> <span class="o">&gt;&gt;</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">Hopac</span><span class="o">.</span><span class="n">memo</span>
    <span class="n">let</span> <span class="n">pfail</span> <span class="o">=</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">Promise</span><span class="o">.</span><span class="n">Now</span><span class="o">.</span><span class="n">withFailure</span> <span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">Exception</span> <span class="s2">"Compiler error: Tried to read from a FilledTop that has errors."</span><span class="p">)</span>

    <span class="n">let</span> <span class="n">top_env_nominal</span> <span class="n">top_env</span> <span class="p">(</span><span class="n">global_id</span> <span class="p">:</span> <span class="n">GlobalId</span><span class="p">)</span> <span class="n">tt</span> <span class="n">name</span> <span class="nb">vars</span> <span class="n">v</span> <span class="p">:</span> <span class="n">TopEnv</span> <span class="o">=</span>
        <span class="p">{</span> <span class="n">top_env</span> <span class="k">with</span>
            <span class="n">nominals_next_tag</span> <span class="o">=</span> <span class="nb">max</span> <span class="n">top_env</span><span class="o">.</span><span class="n">nominals_next_tag</span> <span class="n">global_id</span><span class="o">.</span><span class="n">tag</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">nominals_aux</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">global_id</span> <span class="p">{</span><span class="o">|</span><span class="n">kind</span><span class="o">=</span><span class="n">tt</span><span class="p">;</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">|</span><span class="p">}</span> <span class="n">top_env</span><span class="o">.</span><span class="n">nominals_aux</span>
            <span class="n">nominals</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">global_id</span> <span class="p">{</span><span class="o">|</span><span class="nb">vars</span><span class="o">=</span><span class="nb">vars</span><span class="p">;</span> <span class="n">body</span><span class="o">=</span><span class="n">v</span><span class="o">|</span><span class="p">}</span> <span class="n">top_env</span><span class="o">.</span><span class="n">nominals</span>
            <span class="n">term</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="p">(</span><span class="n">nominal_term</span> <span class="n">global_id</span> <span class="n">tt</span> <span class="n">name</span> <span class="nb">vars</span> <span class="n">v</span><span class="p">)</span> <span class="n">top_env</span><span class="o">.</span><span class="n">term</span>
            <span class="n">ty</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">name</span> <span class="p">(</span><span class="n">TyNominal</span> <span class="n">global_id</span><span class="p">)</span> <span class="n">top_env</span><span class="o">.</span><span class="n">ty</span>
            <span class="p">}</span>

    <span class="n">let</span> <span class="n">rec</span> <span class="n">typevar</span> <span class="o">=</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">RawKindWildcard</span> <span class="o">|</span> <span class="n">RawKindStar</span> <span class="o">-&gt;</span> <span class="n">KindType</span>
        <span class="o">|</span> <span class="n">RawKindFun</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">KindFun</span><span class="p">(</span><span class="n">typevar</span> <span class="n">a</span><span class="p">,</span> <span class="n">typevar</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">hovars</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">HoVar</span> <span class="nb">list</span><span class="p">)</span> <span class="o">=</span>
        <span class="n">List</span><span class="o">.</span><span class="n">mapFold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="p">(</span><span class="n">_</span><span class="p">,(</span><span class="n">n</span><span class="p">,</span><span class="n">t</span><span class="p">))</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">v</span> <span class="o">=</span> <span class="p">{</span><span class="n">scope</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">kind</span><span class="o">=</span><span class="n">typevar</span> <span class="n">t</span><span class="p">;</span> <span class="n">name</span><span class="o">=</span><span class="n">n</span><span class="p">;</span> <span class="n">constraints</span><span class="o">=</span><span class="n">Set</span><span class="o">.</span><span class="n">empty</span><span class="p">}</span>
            <span class="n">v</span><span class="p">,</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">n</span> <span class="p">(</span><span class="n">tyvar</span> <span class="n">v</span><span class="p">)</span> <span class="n">s</span>
            <span class="p">)</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span> <span class="n">x</span>

    <span class="n">let</span> <span class="n">scope</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">let</span> <span class="n">bundle_nominal_rec</span> <span class="n">l</span><span class="s1">' =</span>
        <span class="n">let</span> <span class="n">l</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span>
            <span class="n">List</span><span class="o">.</span><span class="n">mapFold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">i</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="nb">vars</span><span class="p">,</span><span class="n">body</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">l</span><span class="p">,</span><span class="n">env</span> <span class="o">=</span> <span class="n">hovars</span> <span class="nb">vars</span>
                <span class="n">let</span> <span class="n">tt</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">Var</span><span class="p">)</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">KindFun</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span><span class="n">s</span><span class="p">))</span> <span class="n">l</span> <span class="n">KindType</span>
                <span class="p">(</span><span class="n">at_tag</span> <span class="n">i</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">env</span><span class="p">,</span><span class="n">tt</span><span class="p">,</span><span class="n">body</span><span class="p">),</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
                <span class="p">)</span> <span class="n">top_env</span><span class="o">.</span><span class="n">nominals_next_tag</span> <span class="n">l</span><span class="s1">'</span>

        <span class="n">top_env</span> <span class="o">&lt;-</span>
            <span class="p">{</span><span class="n">top_env</span> <span class="k">with</span> 
                <span class="n">nominals_aux</span> <span class="o">=</span> <span class="p">(</span><span class="n">top_env</span><span class="o">.</span><span class="n">nominals_aux</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="o">||&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="p">(</span><span class="n">i</span><span class="p">,(</span><span class="n">_</span><span class="p">,</span><span class="n">name</span><span class="p">),</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">tt</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">i</span> <span class="p">{</span><span class="o">|</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">;</span> <span class="n">kind</span><span class="o">=</span><span class="n">tt</span><span class="o">|</span><span class="p">}</span> <span class="n">s</span><span class="p">)</span>
                <span class="n">ty</span> <span class="o">=</span> <span class="p">(</span><span class="n">top_env</span><span class="o">.</span><span class="n">ty</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="o">||&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="p">(</span><span class="n">i</span><span class="p">,(</span><span class="n">_</span><span class="p">,</span><span class="n">name</span><span class="p">),</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">name</span> <span class="p">(</span><span class="n">TyNominal</span> <span class="n">i</span><span class="p">)</span> <span class="n">s</span><span class="p">)</span> 
                <span class="p">}</span>
        
        <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">top_env</span> <span class="p">(</span><span class="n">global_id</span><span class="p">,(</span><span class="n">r</span><span class="p">,</span><span class="n">name</span><span class="p">),</span><span class="nb">vars</span><span class="p">,</span><span class="n">env_ty</span><span class="p">,</span><span class="n">tt</span><span class="p">,</span><span class="n">body</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">v</span> <span class="o">=</span> <span class="n">fresh_var</span> <span class="n">scope</span>
            <span class="n">ty_init</span> <span class="n">scope</span> <span class="p">{</span><span class="n">term</span><span class="o">=</span><span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">;</span> <span class="n">ty</span><span class="o">=</span><span class="n">env_ty</span><span class="p">;</span> <span class="n">constraints</span><span class="o">=</span><span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">}</span> <span class="n">v</span> <span class="n">body</span>
            <span class="n">let</span> <span class="n">v</span> <span class="o">=</span> <span class="n">term_subst</span> <span class="n">v</span>
            <span class="n">validate_nominal</span> <span class="n">errors</span> <span class="n">global_id</span> <span class="n">body</span> <span class="n">v</span>
            <span class="n">top_env_nominal</span> <span class="n">top_env</span> <span class="n">global_id</span> <span class="n">tt</span> <span class="n">name</span> <span class="nb">vars</span> <span class="n">v</span>
            <span class="p">)</span> <span class="n">top_env_emptyInfer</span> <span class="n">l</span>

    <span class="k">match</span> <span class="n">expr</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">BundleType</span><span class="p">(</span><span class="n">q</span><span class="p">,(</span><span class="n">r</span><span class="p">,</span><span class="n">name</span><span class="p">),</span><span class="nb">vars</span><span class="s1">',expr) -&gt;</span>
        <span class="n">let</span> <span class="nb">vars</span><span class="p">,</span><span class="n">env_ty</span> <span class="o">=</span> <span class="n">hovars</span> <span class="nb">vars</span><span class="s1">'</span>
        <span class="n">let</span> <span class="n">v</span> <span class="o">=</span> <span class="n">fresh_var</span> <span class="n">scope</span>
        <span class="n">ty_init</span> <span class="n">scope</span> <span class="p">{</span><span class="n">term</span><span class="o">=</span><span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">;</span> <span class="n">ty</span><span class="o">=</span><span class="n">env_ty</span><span class="p">;</span> <span class="n">constraints</span><span class="o">=</span><span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">}</span> <span class="n">v</span> <span class="n">expr</span>
        <span class="n">let</span> <span class="n">t</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">TyInl</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">s</span><span class="p">))</span> <span class="nb">vars</span> <span class="p">(</span><span class="n">term_subst</span> <span class="n">v</span><span class="p">)</span>
        <span class="n">hover_types</span><span class="o">.</span><span class="n">AddHover</span><span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">t</span><span class="p">,</span><span class="s2">""</span><span class="p">))</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">Count</span> <span class="n">then</span> <span class="n">psucc</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="n">FType</span><span class="p">(</span><span class="n">q</span><span class="p">,(</span><span class="n">r</span><span class="p">,</span><span class="n">name</span><span class="p">),</span><span class="nb">vars</span><span class="s1">',expr)), AInclude {top_env_emptyInfer with ty = Map.add name t Map.empty}</span>
        <span class="k">else</span> <span class="n">pfail</span><span class="p">,</span> <span class="n">AInclude</span> <span class="n">top_env_emptyInfer</span>
    <span class="o">|</span> <span class="n">BundleNominal</span><span class="p">(</span><span class="n">q</span><span class="p">,(</span><span class="n">r</span><span class="p">,</span><span class="n">name</span><span class="p">),</span><span class="nb">vars</span><span class="s1">',expr) -&gt;</span>
        <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">bundle_nominal_rec</span> <span class="p">[</span><span class="n">q</span><span class="p">,(</span><span class="n">r</span><span class="p">,</span><span class="n">name</span><span class="p">),</span><span class="nb">vars</span><span class="s1">',expr]</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">Count</span> <span class="n">then</span> <span class="n">psucc</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="n">FNominal</span><span class="p">(</span><span class="n">q</span><span class="p">,(</span><span class="n">r</span><span class="p">,</span><span class="n">name</span><span class="p">),</span><span class="nb">vars</span><span class="s1">',expr)), AInclude x</span>
        <span class="k">else</span> <span class="n">pfail</span><span class="p">,</span> <span class="n">AInclude</span> <span class="n">top_env_emptyInfer</span>
    <span class="o">|</span> <span class="n">BundleNominalRec</span> <span class="n">l</span> <span class="o">-&gt;</span>
        <span class="n">let</span> <span class="n">_</span> <span class="o">=</span> <span class="o">//</span> <span class="n">Checks</span> <span class="n">that</span> <span class="n">mutually</span> <span class="n">recursive</span> <span class="n">unions</span> <span class="n">do</span> <span class="ow">not</span> <span class="n">have</span> <span class="n">duplicates</span><span class="o">.</span>
            <span class="n">let</span> <span class="n">h</span> <span class="o">=</span> <span class="n">HashSet</span><span class="p">()</span>
            <span class="n">l</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">RawTUnion</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">l</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">k</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">Add</span> <span class="n">k</span> <span class="o">=</span> <span class="n">false</span> <span class="n">then</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">range_of_texpr</span> <span class="p">(</span><span class="n">snd</span> <span class="n">v</span><span class="p">),</span><span class="n">DuplicateKeyInRecUnion</span><span class="p">))</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="p">()</span>
                <span class="p">)</span>
        <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">bundle_nominal_rec</span> <span class="n">l</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">Count</span> <span class="n">then</span> <span class="n">psucc</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="n">FNominalRec</span> <span class="n">l</span><span class="p">),</span> <span class="n">AInclude</span> <span class="n">x</span>
        <span class="k">else</span> <span class="n">pfail</span><span class="p">,</span> <span class="n">AInclude</span> <span class="n">top_env_emptyInfer</span>
    <span class="o">|</span> <span class="n">BundlePrototype</span><span class="p">(</span><span class="n">com</span><span class="p">,</span><span class="n">r</span><span class="p">,(</span><span class="sa">r</span><span class="s1">',name),(w,var_init),vars'</span><span class="p">,</span><span class="n">expr</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="n">let</span> <span class="n">i</span> <span class="o">=</span> <span class="n">at_tag</span> <span class="n">top_env</span><span class="s1">'.prototypes_next_tag</span>
        <span class="n">let</span> <span class="n">cons</span> <span class="o">=</span> <span class="n">CPrototype</span> <span class="n">i</span>
        <span class="n">let</span> <span class="n">scope</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">let</span> <span class="nb">vars</span><span class="p">,</span><span class="n">env_ty</span> <span class="o">=</span> <span class="n">typevars</span> <span class="n">scope</span> <span class="p">{</span><span class="n">term</span><span class="o">=</span><span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">;</span> <span class="n">constraints</span><span class="o">=</span><span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">;</span> <span class="n">ty</span><span class="o">=</span><span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">}</span> <span class="nb">vars</span><span class="s1">'</span>
        <span class="n">let</span> <span class="n">kind</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">k</span> <span class="p">:</span> <span class="n">Var</span><span class="p">)</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">KindFun</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span><span class="n">s</span><span class="p">))</span> <span class="nb">vars</span> <span class="n">KindType</span>
        <span class="n">let</span> <span class="n">v</span><span class="s1">' = {scope=scope; constraints=Set.singleton cons; name=var_init; kind=kind}</span>
        <span class="n">let</span> <span class="n">env_ty</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">var_init</span> <span class="p">(</span><span class="n">tyvar</span> <span class="n">v</span><span class="s1">') env_ty</span>
        <span class="n">let</span> <span class="nb">vars</span> <span class="o">=</span> <span class="n">v</span><span class="s1">' :: vars</span>
        <span class="n">let</span> <span class="n">v</span> <span class="o">=</span> <span class="n">fresh_var</span> <span class="n">scope</span>
        <span class="n">ty_init</span> <span class="n">scope</span> <span class="p">{</span><span class="n">term</span><span class="o">=</span><span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">;</span> <span class="n">ty</span><span class="o">=</span><span class="n">env_ty</span><span class="p">;</span> <span class="n">constraints</span><span class="o">=</span><span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">}</span> <span class="n">v</span> <span class="n">expr</span>
        <span class="n">let</span> <span class="n">body</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="n">a</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">TyForall</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span> <span class="nb">vars</span> <span class="p">(</span><span class="n">term_subst</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">Count</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">assert_foralls_used</span> <span class="n">errors</span> <span class="sa">r</span><span class="s1">' body; 0 = errors.Count) then</span>
            <span class="n">let</span> <span class="n">x</span> <span class="o">=</span>
                <span class="p">{</span> <span class="n">top_env_emptyInfer</span> <span class="k">with</span>
                    <span class="n">prototypes_next_tag</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">tag</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">prototypes</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">i</span> <span class="p">{</span><span class="o">|</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">;</span> <span class="n">signature</span><span class="o">=</span><span class="n">body</span><span class="p">;</span> <span class="n">kind</span><span class="o">=</span><span class="n">v</span><span class="s1">'.kind|} Map.empty</span>
                    <span class="n">term</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">name</span> <span class="p">(</span><span class="k">if</span> <span class="n">com</span> <span class="o">&lt;&gt;</span> <span class="s2">""</span> <span class="n">then</span> <span class="n">TyComment</span><span class="p">(</span><span class="n">com</span><span class="p">,</span><span class="n">body</span><span class="p">)</span> <span class="k">else</span> <span class="n">body</span><span class="p">)</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
                    <span class="n">constraints</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">name</span> <span class="p">(</span><span class="n">C</span> <span class="n">cons</span><span class="p">)</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
                    <span class="p">}</span>
            <span class="n">psucc</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="n">FPrototype</span><span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="sa">r</span><span class="s1">',name),(w,var_init),vars'</span><span class="p">,</span><span class="n">expr</span><span class="p">)),</span> <span class="n">AInclude</span> <span class="n">x</span>
        <span class="k">else</span> <span class="n">pfail</span><span class="p">,</span> <span class="n">AInclude</span> <span class="n">top_env_emptyInfer</span>
    <span class="o">|</span> <span class="n">BundleInl</span><span class="p">(</span><span class="n">com</span><span class="p">,</span><span class="n">q</span><span class="p">,(</span><span class="n">_</span><span class="p">,</span><span class="n">name</span> <span class="k">as</span> <span class="n">w</span><span class="p">),</span><span class="n">a</span><span class="p">,</span><span class="n">true</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="n">let</span> <span class="n">env</span> <span class="o">=</span> <span class="n">inl</span> <span class="n">scope</span> <span class="p">{</span><span class="n">term</span><span class="o">=</span><span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">;</span> <span class="n">ty</span><span class="o">=</span><span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">;</span> <span class="n">constraints</span><span class="o">=</span><span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">}</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
        <span class="n">let</span> <span class="n">term</span> <span class="o">=</span>
            <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">com</span> <span class="o">&lt;&gt;</span> <span class="s2">""</span> <span class="n">then</span> <span class="n">TyComment</span><span class="p">(</span><span class="n">com</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span>
        <span class="p">(</span><span class="k">if</span> <span class="mi">0</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">Count</span> <span class="n">then</span> <span class="n">psucc</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="n">FInl</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">fill</span> <span class="n">q</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span> <span class="n">a</span><span class="p">))</span> <span class="k">else</span> <span class="n">pfail</span><span class="p">),</span>
        <span class="n">AInclude</span> <span class="p">{</span> <span class="n">top_env_emptyInfer</span> <span class="k">with</span> <span class="n">term</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">name</span> <span class="n">term</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">}</span>
    <span class="o">|</span> <span class="n">BundleInl</span><span class="p">(</span><span class="n">com</span><span class="p">,</span><span class="n">q</span><span class="p">,(</span><span class="n">_</span><span class="p">,</span><span class="n">name</span> <span class="k">as</span> <span class="n">w</span><span class="p">),</span><span class="n">a</span><span class="p">,</span><span class="n">false</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="n">assert_bound_vars</span> <span class="p">{</span><span class="n">term</span><span class="o">=</span><span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">;</span> <span class="n">ty</span><span class="o">=</span><span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">;</span> <span class="n">constraints</span><span class="o">=</span><span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">}</span> <span class="n">a</span>
        <span class="p">(</span><span class="k">if</span> <span class="mi">0</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">Count</span> <span class="n">then</span> <span class="n">psucc</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="n">FInl</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">a</span><span class="p">))</span> <span class="k">else</span> <span class="n">pfail</span><span class="p">),</span>
        <span class="n">AInclude</span> <span class="p">{</span> <span class="n">top_env_emptyInfer</span> <span class="k">with</span> <span class="n">term</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">name</span> <span class="p">(</span><span class="n">TySymbol</span> <span class="s2">"&lt;real&gt;"</span><span class="p">)</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span> <span class="p">}</span>
    <span class="o">|</span> <span class="n">BundleRecInl</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">is_top_down</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="n">let</span> <span class="n">_</span> <span class="o">=</span>
            <span class="n">let</span> <span class="n">h</span> <span class="o">=</span> <span class="n">HashSet</span><span class="p">()</span>
            <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">),</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">Add</span> <span class="n">n</span> <span class="o">=</span> <span class="n">false</span> <span class="n">then</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">DuplicateRecInlName</span><span class="p">))</span> <span class="n">l</span>
        <span class="n">let</span> <span class="n">env_term</span> <span class="o">=</span>
            <span class="k">if</span> <span class="n">is_top_down</span> <span class="n">then</span>
                <span class="n">let</span> <span class="n">l</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">com</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="n">l</span>
                <span class="p">(</span><span class="n">rec_block</span> <span class="n">scope</span> <span class="p">{</span><span class="n">term</span><span class="o">=</span><span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">;</span> <span class="n">ty</span><span class="o">=</span><span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">;</span> <span class="n">constraints</span><span class="o">=</span><span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">}</span> <span class="n">l</span><span class="p">)</span><span class="o">.</span><span class="n">term</span>
            <span class="k">else</span>
                <span class="n">let</span> <span class="n">env_term</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="p">(</span><span class="n">com</span><span class="p">,</span><span class="n">_</span><span class="p">,(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">a</span> <span class="p">(</span><span class="n">TySymbol</span> <span class="s2">"&lt;real&gt;"</span><span class="p">)</span> <span class="n">s</span><span class="p">)</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span> <span class="n">l</span>
                <span class="n">l</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">com</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">assert_bound_vars</span> <span class="p">{</span><span class="n">term</span> <span class="o">=</span> <span class="n">env_term</span><span class="p">;</span> <span class="n">ty</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">;</span> <span class="n">constraints</span><span class="o">=</span><span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">}</span> <span class="n">x</span><span class="p">)</span>
                <span class="n">env_term</span>
        <span class="n">let</span> <span class="n">filled_top</span> <span class="o">=</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">Count</span> <span class="n">then</span>
                <span class="k">if</span> <span class="n">is_top_down</span> <span class="n">then</span> <span class="n">psucc</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="n">FRecInl</span><span class="p">(</span><span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">fill</span> <span class="n">a</span> <span class="n">env_term</span> <span class="n">c</span><span class="p">)</span> <span class="n">l</span><span class="p">))</span>
                <span class="k">else</span> <span class="n">psucc</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="n">FRecInl</span><span class="p">(</span><span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="n">l</span><span class="p">))</span>
            <span class="k">else</span> <span class="n">pfail</span>
        <span class="n">let</span> <span class="n">env_term</span> <span class="o">=</span>
            <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">env_term</span> <span class="p">(</span><span class="n">com</span><span class="p">,</span><span class="n">_</span><span class="p">,(</span><span class="n">_</span><span class="p">,</span><span class="n">n</span><span class="p">),</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="k">if</span> <span class="n">com</span> <span class="o">&lt;&gt;</span> <span class="s2">""</span> <span class="n">then</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">n</span> <span class="p">(</span><span class="n">TyComment</span><span class="p">(</span><span class="n">com</span><span class="p">,</span> <span class="n">Map</span><span class="o">.</span><span class="n">find</span> <span class="n">n</span> <span class="n">env_term</span><span class="p">))</span> <span class="n">env_term</span> <span class="k">else</span> <span class="n">env_term</span>
                <span class="p">)</span> <span class="n">env_term</span> <span class="n">l</span>
        <span class="n">filled_top</span><span class="p">,</span> <span class="n">AInclude</span> <span class="p">(</span><span class="n">Map</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">k</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">s</span> <span class="k">with</span> <span class="n">term</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">k</span> <span class="n">v</span> <span class="n">s</span><span class="o">.</span><span class="n">term</span><span class="p">})</span> <span class="n">top_env_emptyInfer</span> <span class="n">env_term</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">BundleInstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">prot</span><span class="p">,</span><span class="n">ins</span><span class="p">,</span><span class="nb">vars</span><span class="p">,</span><span class="n">body</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="n">let</span> <span class="n">fail</span> <span class="o">=</span> <span class="n">pfail</span><span class="p">,</span><span class="n">AInclude</span> <span class="n">top_env_emptyInfer</span>
        <span class="n">let</span> <span class="n">assert_no_kind</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="p">((</span><span class="n">r</span><span class="p">,(</span><span class="n">_</span><span class="p">,</span><span class="n">k</span><span class="p">)),</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">match</span> <span class="n">k</span> <span class="k">with</span> <span class="n">RawKindWildcard</span> <span class="o">-&gt;</span> <span class="p">()</span> <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">KindNotAllowedInInstanceForall</span><span class="p">))</span>
        <span class="n">let</span> <span class="n">assert_vars_count</span> <span class="n">vars_count</span> <span class="n">vars_expected</span> <span class="o">=</span> <span class="k">if</span> <span class="n">vars_count</span> <span class="o">&lt;&gt;</span> <span class="n">vars_expected</span> <span class="n">then</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">InstanceCoreVarsShouldMatchTheArityDifference</span><span class="p">(</span><span class="n">vars_count</span><span class="p">,</span><span class="n">vars_expected</span><span class="p">))</span>
        <span class="n">let</span> <span class="n">assert_kind_compatibility</span> <span class="n">got</span> <span class="n">expected</span> <span class="o">=</span>
            <span class="k">try</span> <span class="n">unify_kind</span><span class="s1">' InstanceKindError r got expected</span>
            <span class="k">with</span> <span class="p">:</span><span class="err">?</span> <span class="n">InferTypeErrorException</span> <span class="k">as</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">AddRange</span> <span class="n">e</span><span class="o">.</span><span class="n">Data0</span>
        <span class="n">let</span> <span class="n">assert_kind_arity</span> <span class="n">prot_kind_arity</span> <span class="n">ins_kind_arity</span> <span class="o">=</span> <span class="k">if</span> <span class="n">ins_kind_arity</span> <span class="o">&lt;</span> <span class="n">prot_kind_arity</span> <span class="n">then</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">InstanceArityError</span><span class="p">(</span><span class="n">prot_kind_arity</span><span class="p">,</span><span class="n">ins_kind_arity</span><span class="p">))</span>
        <span class="n">let</span> <span class="n">assert_instance_forall_does_not_shadow_prototype_forall</span> <span class="n">prot_forall_name</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="p">((</span><span class="n">r</span><span class="p">,(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)),</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">a</span> <span class="o">=</span> <span class="n">prot_forall_name</span> <span class="n">then</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">InstanceVarShouldNotMatchAnyOfPrototypes</span><span class="p">))</span> <span class="nb">vars</span>
        <span class="n">let</span> <span class="n">assert_orphan_shadow_check</span> <span class="p">(</span><span class="n">prot_id</span> <span class="p">:</span> <span class="n">GlobalId</span><span class="p">)</span> <span class="p">(</span><span class="n">ins_id</span> <span class="p">:</span> <span class="n">GlobalId</span><span class="p">)</span> <span class="o">=</span>
            <span class="o">//</span> <span class="k">if</span> <span class="n">Map</span><span class="o">.</span><span class="n">containsKey</span> <span class="p">(</span><span class="n">prot_id</span><span class="p">,</span> <span class="n">ins_id</span><span class="p">)</span> <span class="n">top_env</span><span class="o">.</span><span class="n">prototypes_instances</span>
            <span class="o">//</span> <span class="n">then</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">ShadowedInstance</span><span class="p">)</span>
            <span class="p">()</span>
        <span class="n">let</span> <span class="n">assert_orphan_instance_check</span> <span class="p">(</span><span class="n">prot_id</span> <span class="p">:</span> <span class="n">GlobalId</span><span class="p">)</span> <span class="p">(</span><span class="n">ins_id</span> <span class="p">:</span> <span class="n">GlobalId</span><span class="p">)</span> <span class="o">=</span>
            <span class="o">//</span> <span class="k">if</span> <span class="p">(</span><span class="n">prot_id</span><span class="o">.</span><span class="n">package_id</span> <span class="o">=</span> <span class="n">package_id</span> <span class="o">||</span> <span class="n">ins_id</span><span class="o">.</span><span class="n">package_id</span> <span class="o">=</span> <span class="n">package_id</span><span class="p">)</span> <span class="o">=</span> <span class="n">false</span> <span class="n">then</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">OrphanInstance</span><span class="p">)</span>
            <span class="p">()</span>
        <span class="n">let</span> <span class="n">body</span> <span class="n">prot_id</span> <span class="n">ins_id</span> <span class="o">=</span>
            <span class="n">let</span> <span class="n">ins_kind</span><span class="s1">' = top_env.nominals_aux.[ins_id].kind</span>
            <span class="n">let</span> <span class="n">guard</span> <span class="nb">next</span> <span class="o">=</span> <span class="k">if</span> <span class="mi">0</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">Count</span> <span class="n">then</span> <span class="nb">next</span> <span class="p">()</span> <span class="k">else</span> <span class="n">fail</span>
            <span class="n">let</span> <span class="n">ins_kind</span> <span class="o">=</span> <span class="n">kind_get</span> <span class="n">ins_kind</span><span class="s1">'</span>
            <span class="n">let</span> <span class="n">prototype</span> <span class="o">=</span> <span class="n">top_env</span><span class="o">.</span><span class="n">prototypes</span><span class="o">.</span><span class="p">[</span><span class="n">prot_id</span><span class="p">]</span>
            <span class="n">hover_types</span><span class="o">.</span><span class="n">AddHover</span><span class="p">(</span><span class="n">fst</span> <span class="n">prot</span><span class="p">,</span> <span class="p">(</span><span class="n">prototype</span><span class="o">.</span><span class="n">signature</span><span class="p">,</span><span class="s2">""</span><span class="p">))</span> <span class="o">//</span> <span class="n">TODO</span><span class="p">:</span> <span class="n">Add</span> <span class="n">the</span> <span class="n">hover</span> <span class="k">for</span> <span class="n">the</span> <span class="n">instance</span> <span class="n">signature</span><span class="o">.</span>
            <span class="n">let</span> <span class="n">prototype_init_forall_kind</span> <span class="o">=</span> <span class="n">prototype_init_forall_kind</span> <span class="n">prototype</span><span class="o">.</span><span class="n">signature</span>
            <span class="n">let</span> <span class="n">prot_kind</span> <span class="o">=</span> <span class="n">kind_get</span> <span class="n">prototype_init_forall_kind</span>
            <span class="n">assert_kind_arity</span> <span class="n">prot_kind</span><span class="o">.</span><span class="n">arity</span> <span class="n">ins_kind</span><span class="o">.</span><span class="n">arity</span>
            <span class="n">guard</span> <span class="o">&lt;|</span> <span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">vars_expected</span> <span class="o">=</span> <span class="n">ins_kind</span><span class="o">.</span><span class="n">arity</span> <span class="o">-</span> <span class="n">prot_kind</span><span class="o">.</span><span class="n">arity</span>
            <span class="n">assert_kind_compatibility</span> <span class="p">(</span><span class="n">List</span><span class="o">.</span><span class="n">skip</span> <span class="n">vars_expected</span> <span class="n">ins_kind</span><span class="o">.</span><span class="n">args</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">reduceBack</span> <span class="p">(</span><span class="n">fun</span> <span class="n">a</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">KindFun</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)))</span> <span class="n">prototype_init_forall_kind</span>
            <span class="n">guard</span> <span class="o">&lt;|</span> <span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span>
            <span class="n">assert_vars_count</span> <span class="p">(</span><span class="n">List</span><span class="o">.</span><span class="n">length</span> <span class="nb">vars</span><span class="p">)</span> <span class="n">vars_expected</span>
            <span class="n">guard</span> <span class="o">&lt;|</span> <span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span>
            <span class="n">assert_no_kind</span> <span class="nb">vars</span>
            <span class="n">guard</span> <span class="o">&lt;|</span> <span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">ins_vars</span><span class="p">,</span> <span class="n">env_ty</span> <span class="o">=</span>
                <span class="n">List</span><span class="o">.</span><span class="n">mapFold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="p">(((</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">),</span><span class="n">_</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">x</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">-&gt;</span>
                    <span class="n">let</span> <span class="n">v</span> <span class="o">=</span> <span class="p">{</span><span class="n">typevar_to_var</span> <span class="n">scope</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span> <span class="n">x</span> <span class="k">with</span> <span class="n">kind</span> <span class="o">=</span> <span class="n">k</span><span class="p">}</span>
                    <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">tyvar</span> <span class="n">v</span>
                    <span class="n">hover_types</span><span class="o">.</span><span class="n">AddHover</span><span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">x</span><span class="p">,</span><span class="s2">""</span><span class="p">))</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">v</span><span class="o">.</span><span class="n">name</span> <span class="n">x</span> <span class="n">s</span>
                    <span class="p">)</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span> <span class="p">(</span><span class="n">List</span><span class="o">.</span><span class="n">zip</span> <span class="nb">vars</span> <span class="p">(</span><span class="n">List</span><span class="o">.</span><span class="n">take</span> <span class="n">vars_expected</span> <span class="n">ins_kind</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>
            <span class="n">let</span> <span class="n">ins_constraints</span> <span class="o">=</span> <span class="n">ins_vars</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">visit_t</span> <span class="o">&gt;&gt;</span> <span class="n">function</span> <span class="n">TyVar</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">.</span><span class="n">constraints</span> <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"impossible"</span><span class="p">)</span>
            <span class="n">let</span> <span class="n">ins_core</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">(</span><span class="n">b</span> <span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">k</span> <span class="o">=</span> <span class="n">trim_kind</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">TyApply</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">k</span><span class="p">),</span><span class="n">k</span><span class="p">)</span> <span class="p">(</span><span class="n">TyNominal</span> <span class="n">ins_id</span><span class="p">,</span><span class="n">ins_kind</span><span class="s1">') ins_vars</span>
            <span class="n">let</span> <span class="n">env_ty</span><span class="p">,</span> <span class="n">prot_body</span> <span class="o">=</span>
                <span class="k">match</span> <span class="n">foralls_ty_get</span> <span class="n">prototype</span><span class="o">.</span><span class="n">signature</span> <span class="k">with</span>
                <span class="o">|</span> <span class="p">(</span><span class="n">prot_core</span> <span class="p">::</span> <span class="n">prot_foralls</span><span class="p">),</span> <span class="n">prot_body</span> <span class="o">-&gt;</span>
                    <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">ty</span> <span class="n">x</span> <span class="o">-&gt;</span>
                        <span class="n">assert_instance_forall_does_not_shadow_prototype_forall</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span>
                        <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="p">(</span><span class="n">tyvar</span> <span class="n">x</span><span class="p">)</span> <span class="n">ty</span><span class="p">)</span> <span class="n">env_ty</span> <span class="n">prot_foralls</span><span class="p">,</span>
                    <span class="n">let</span> <span class="n">prot_body</span> <span class="o">=</span> <span class="n">subst</span> <span class="p">[</span><span class="n">prot_core</span><span class="p">,</span> <span class="n">ins_core</span><span class="p">]</span> <span class="n">prot_body</span>
                    <span class="n">let</span> <span class="n">_</span> <span class="o">=</span>
                        <span class="n">List</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">TyForall</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">s</span><span class="p">))</span> <span class="n">prot_foralls</span> <span class="n">prot_body</span>
                        <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">match</span> <span class="n">visit_t</span> <span class="n">x</span> <span class="k">with</span> <span class="n">TyVar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TyForall</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">s</span><span class="p">)</span> <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"impossible"</span><span class="p">)</span> <span class="n">ins_vars</span>
                        <span class="o">|&gt;</span> <span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">generalized_statements</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">body</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
                    <span class="n">prot_body</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"impossible"</span>
            <span class="n">assert_orphan_shadow_check</span> <span class="n">prot_id</span> <span class="n">ins_id</span>
            <span class="n">assert_orphan_instance_check</span> <span class="n">prot_id</span> <span class="n">ins_id</span>
            <span class="n">guard</span> <span class="o">&lt;|</span> <span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span>
            <span class="n">top_env</span> <span class="o">&lt;-</span> <span class="p">{</span><span class="n">top_env</span> <span class="k">with</span> <span class="n">prototypes_instances</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="p">(</span><span class="n">prot_id</span><span class="p">,</span><span class="n">ins_id</span><span class="p">)</span> <span class="n">ins_constraints</span> <span class="n">top_env</span><span class="o">.</span><span class="n">prototypes_instances</span><span class="p">}</span>
            <span class="n">term</span> <span class="n">scope</span> <span class="p">{</span><span class="n">term</span><span class="o">=</span><span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">;</span> <span class="n">ty</span><span class="o">=</span><span class="n">env_ty</span><span class="p">;</span> <span class="n">constraints</span><span class="o">=</span><span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">}</span> <span class="n">prot_body</span> <span class="n">body</span>
            <span class="p">(</span><span class="k">if</span> <span class="mi">0</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">Count</span> <span class="n">then</span> <span class="n">psucc</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="n">FInstance</span><span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">fst</span> <span class="n">prot</span><span class="p">,</span> <span class="n">prot_id</span><span class="p">),(</span><span class="n">fst</span> <span class="n">ins</span><span class="p">,</span> <span class="n">ins_id</span><span class="p">),</span><span class="n">fill</span> <span class="n">r</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span> <span class="n">body</span><span class="p">))</span> <span class="k">else</span> <span class="n">pfail</span><span class="p">),</span>
            <span class="n">AInclude</span> <span class="p">{</span><span class="n">top_env_emptyInfer</span> <span class="k">with</span> <span class="n">prototypes_instances</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="p">(</span><span class="n">prot_id</span><span class="p">,</span><span class="n">ins_id</span><span class="p">)</span> <span class="n">ins_constraints</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">}</span>

        <span class="n">let</span> <span class="n">fake</span> <span class="n">_</span> <span class="o">=</span> <span class="n">fail</span>
        <span class="n">let</span> <span class="n">check_ins</span> <span class="n">on_succ</span> <span class="o">=</span>
            <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="p">(</span><span class="n">snd</span> <span class="n">ins</span><span class="p">)</span> <span class="n">top_env</span><span class="o">.</span><span class="n">ty</span> <span class="k">with</span>
            <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">fst</span> <span class="n">ins</span><span class="p">,</span> <span class="n">UnboundVariable</span> <span class="p">(</span><span class="n">snd</span> <span class="n">ins</span><span class="p">));</span> <span class="n">fail</span>
            <span class="o">|</span> <span class="n">Some</span><span class="p">(</span><span class="n">TyNominal</span> <span class="n">i</span><span class="s1">') -&gt; on_succ i'</span>
            <span class="o">|</span> <span class="n">Some</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">fst</span> <span class="n">ins</span><span class="p">,</span> <span class="n">ExpectedHigherOrder</span> <span class="n">x</span><span class="p">);</span> <span class="n">fail</span>
        <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="p">(</span><span class="n">snd</span> <span class="n">prot</span><span class="p">)</span> <span class="n">top_env</span><span class="o">.</span><span class="n">constraints</span> <span class="k">with</span>
        <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">fst</span> <span class="n">prot</span><span class="p">,</span> <span class="n">UnboundVariable</span> <span class="p">(</span><span class="n">snd</span> <span class="n">prot</span><span class="p">));</span> <span class="n">check_ins</span> <span class="n">fake</span>
        <span class="o">|</span> <span class="n">Some</span><span class="p">(</span><span class="n">C</span> <span class="p">(</span><span class="n">CPrototype</span> <span class="n">i</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">check_ins</span> <span class="p">(</span><span class="n">body</span> <span class="n">i</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">Some</span><span class="p">(</span><span class="n">C</span> <span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">fst</span> <span class="n">prot</span><span class="p">,</span> <span class="n">ExpectedPrototypeConstraint</span> <span class="n">x</span><span class="p">);</span> <span class="n">check_ins</span> <span class="n">fake</span>
        <span class="o">|</span> <span class="n">Some</span><span class="p">(</span><span class="n">M</span> <span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">fst</span> <span class="n">prot</span><span class="p">,</span> <span class="n">ExpectedPrototypeInsteadOfModule</span><span class="p">);</span> <span class="n">check_ins</span> <span class="n">fake</span>
    <span class="o">|</span> <span class="n">BundleOpen</span><span class="p">(</span><span class="n">q</span><span class="p">,(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="k">match</span> <span class="n">module_openInfer</span> <span class="p">(</span><span class="n">Some</span> <span class="n">hover_types</span><span class="p">)</span> <span class="p">(</span><span class="n">loc_env</span> <span class="n">top_env</span><span class="p">)</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span> <span class="n">r</span> <span class="n">a</span> <span class="n">b</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">psucc</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="n">FOpen</span><span class="p">(</span><span class="n">q</span><span class="p">,(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)),</span> <span class="n">AOpen</span> <span class="p">{</span><span class="n">top_env_emptyInfer</span> <span class="k">with</span> <span class="n">term</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">term</span><span class="p">;</span> <span class="n">ty</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">ty</span><span class="p">;</span> <span class="n">constraints</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">constraints</span><span class="p">}</span>
        <span class="o">|</span> <span class="n">Result</span><span class="o">.</span><span class="n">Error</span> <span class="n">er</span> <span class="o">-&gt;</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">er</span><span class="p">);</span> <span class="n">pfail</span><span class="p">,</span> <span class="n">AOpen</span> <span class="n">top_env_emptyInfer</span>
    <span class="o">|&gt;</span> <span class="n">fun</span> <span class="p">(</span><span class="n">filled_top</span><span class="p">,</span> <span class="n">top_env_additions</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">Count</span> <span class="n">then</span>
            <span class="n">annotations</span> <span class="o">|&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">KeyValue</span><span class="p">(</span><span class="n">_</span><span class="p">,(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">)))</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">has_metavars</span> <span class="n">x</span> <span class="n">then</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ValueRestriction</span> <span class="n">x</span><span class="p">))</span>
        <span class="p">{</span>
        <span class="n">filled_top</span> <span class="o">=</span> <span class="n">filled_top</span>
        <span class="n">top_env_additions</span> <span class="o">=</span> <span class="n">top_env_additions</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">bundle_range</span> <span class="n">expr</span> <span class="o">|&gt;</span> <span class="n">fst</span> <span class="o">|&gt;</span> <span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">.</span><span class="n">line</span>
        <span class="n">hovers</span> <span class="o">=</span> <span class="n">hover_types</span><span class="o">.</span><span class="n">ToArray</span><span class="p">()</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">a</span><span class="p">,(</span><span class="n">b</span><span class="p">,</span><span class="n">com</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="p">,</span> <span class="n">let</span> <span class="n">b</span> <span class="o">=</span> <span class="n">show_t</span> <span class="n">top_env</span> <span class="n">b</span> <span class="ow">in</span> <span class="k">if</span> <span class="n">com</span> <span class="o">&lt;&gt;</span> <span class="s2">""</span> <span class="n">then</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="se">\n</span><span class="s2">---</span><span class="se">\n</span><span class="si">%s</span><span class="s2">"</span> <span class="n">b</span> <span class="n">com</span> <span class="k">else</span> <span class="n">b</span><span class="p">)</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="n">errors</span> <span class="o">|&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">toList</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="p">,</span> <span class="n">show_type_error</span> <span class="n">top_env</span> <span class="n">b</span><span class="p">)</span>
        <span class="p">}</span>

<span class="n">let</span> <span class="n">base_types</span> <span class="p">(</span><span class="n">default_env</span> <span class="p">:</span> <span class="n">DefaultEnv</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">var</span> <span class="n">name</span> <span class="o">=</span> <span class="p">{</span><span class="n">scope</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">kind</span><span class="o">=</span><span class="n">KindType</span><span class="p">;</span> <span class="n">constraints</span><span class="o">=</span><span class="n">Set</span><span class="o">.</span><span class="n">empty</span><span class="p">;</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">}</span> 
    <span class="n">let</span> <span class="n">inline</span> <span class="n">inl</span> <span class="n">f</span> <span class="o">=</span> <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">var</span> <span class="s2">"x"</span> <span class="ow">in</span> <span class="n">TyInl</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">f</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">inline</span> <span class="n">inl2</span> <span class="n">f</span> <span class="o">=</span> <span class="n">let</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">var</span> <span class="s2">"x"</span><span class="p">,</span> <span class="n">var</span> <span class="s2">"y"</span> <span class="ow">in</span> <span class="n">TyInl</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">TyInl</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">f</span> <span class="n">x</span> <span class="n">y</span><span class="p">))</span>
    <span class="p">[</span>
    <span class="s2">"i8"</span><span class="p">,</span> <span class="n">TyPrim</span> <span class="n">Int8T</span>
    <span class="s2">"i16"</span><span class="p">,</span> <span class="n">TyPrim</span> <span class="n">Int16T</span>
    <span class="s2">"i32"</span><span class="p">,</span> <span class="n">TyPrim</span> <span class="n">Int32T</span>
    <span class="s2">"i64"</span><span class="p">,</span> <span class="n">TyPrim</span> <span class="n">Int64T</span>
    <span class="s2">"u8"</span><span class="p">,</span> <span class="n">TyPrim</span> <span class="n">UInt8T</span>
    <span class="s2">"u16"</span><span class="p">,</span> <span class="n">TyPrim</span> <span class="n">UInt16T</span>
    <span class="s2">"u32"</span><span class="p">,</span> <span class="n">TyPrim</span> <span class="n">UInt32T</span>
    <span class="s2">"u64"</span><span class="p">,</span> <span class="n">TyPrim</span> <span class="n">UInt64T</span>
    <span class="s2">"f32"</span><span class="p">,</span> <span class="n">TyPrim</span> <span class="n">Float32T</span>
    <span class="s2">"f64"</span><span class="p">,</span> <span class="n">TyPrim</span> <span class="n">Float64T</span>
    <span class="s2">"string"</span><span class="p">,</span> <span class="n">TyPrim</span> <span class="n">StringT</span>
    <span class="s2">"bool"</span><span class="p">,</span> <span class="n">TyPrim</span> <span class="n">BoolT</span>
    <span class="s2">"char"</span><span class="p">,</span> <span class="n">TyPrim</span> <span class="n">CharT</span>
    <span class="s2">"array_base"</span><span class="p">,</span> <span class="n">inl</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">TyArray</span><span class="p">(</span><span class="n">tyvar</span> <span class="n">x</span><span class="p">))</span>
    <span class="s2">"heap"</span><span class="p">,</span> <span class="n">inl</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">TyLayout</span><span class="p">(</span><span class="n">tyvar</span> <span class="n">x</span><span class="p">,</span><span class="n">Layout</span><span class="o">.</span><span class="n">Heap</span><span class="p">))</span>
    <span class="s2">"mut"</span><span class="p">,</span> <span class="n">inl</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">TyLayout</span><span class="p">(</span><span class="n">tyvar</span> <span class="n">x</span><span class="p">,</span><span class="n">Layout</span><span class="o">.</span><span class="n">HeapMutable</span><span class="p">))</span>
    <span class="s2">"stack_mut"</span><span class="p">,</span> <span class="n">inl</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">TyLayout</span><span class="p">(</span><span class="n">tyvar</span> <span class="n">x</span><span class="p">,</span><span class="n">Layout</span><span class="o">.</span><span class="n">StackMutable</span><span class="p">))</span>
    <span class="s2">"fptr"</span><span class="p">,</span> <span class="n">inl2</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="n">y</span> <span class="o">-&gt;</span> <span class="n">TyFun</span><span class="p">(</span><span class="n">tyvar</span> <span class="n">x</span><span class="p">,</span><span class="n">tyvar</span> <span class="n">y</span><span class="p">,</span><span class="n">FT_Pointer</span><span class="p">))</span>
    <span class="s2">"closure"</span><span class="p">,</span> <span class="n">inl2</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="n">y</span> <span class="o">-&gt;</span> <span class="n">TyFun</span><span class="p">(</span><span class="n">tyvar</span> <span class="n">x</span><span class="p">,</span><span class="n">tyvar</span> <span class="n">y</span><span class="p">,</span><span class="n">FT_Closure</span><span class="p">))</span>
    <span class="s2">"int"</span><span class="p">,</span> <span class="n">TyPrim</span> <span class="n">default_env</span><span class="o">.</span><span class="n">default_int</span>
    <span class="s2">"uint"</span><span class="p">,</span> <span class="n">TyPrim</span> <span class="n">default_env</span><span class="o">.</span><span class="n">default_uint</span>
    <span class="s2">"float"</span><span class="p">,</span> <span class="n">TyPrim</span> <span class="n">default_env</span><span class="o">.</span><span class="n">default_float</span>
    <span class="p">]</span>

<span class="n">let</span> <span class="n">top_env_defaultInfer</span> <span class="n">default_env</span> <span class="p">:</span> <span class="n">TopEnv</span> <span class="o">=</span>
    <span class="o">//</span> <span class="n">Note</span><span class="p">:</span> <span class="err">`</span><span class="n">top_env_default</span><span class="err">`</span> <span class="n">should</span> <span class="n">have</span> <span class="n">no</span> <span class="n">nominals</span><span class="p">,</span> <span class="n">prototypes</span> <span class="ow">or</span> <span class="n">terms</span><span class="o">.</span>
    <span class="p">{</span><span class="n">top_env_emptyInfer</span> <span class="k">with</span>
        <span class="n">ty</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">ofList</span> <span class="p">(</span><span class="n">base_types</span> <span class="n">default_env</span><span class="p">)</span>
        <span class="n">constraints</span> <span class="o">=</span>
            <span class="p">[</span>
            <span class="s2">"uint"</span><span class="p">,</span> <span class="n">CUInt</span>
            <span class="s2">"sint"</span><span class="p">,</span> <span class="n">CSInt</span>
            <span class="s2">"int"</span><span class="p">,</span> <span class="n">CInt</span>
            <span class="s2">"float"</span><span class="p">,</span> <span class="n">CFloat</span>
            <span class="s2">"number"</span><span class="p">,</span> <span class="n">CNumber</span>
            <span class="s2">"prim"</span><span class="p">,</span> <span class="n">CPrim</span>
            <span class="s2">"record"</span><span class="p">,</span> <span class="n">CRecord</span>
            <span class="s2">"symbol"</span><span class="p">,</span> <span class="n">CSymbol</span>
            <span class="p">]</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">ofList</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">C</span><span class="p">)</span>
        <span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=42">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="PartEvalPrepass">PartEvalPrepass<a class="anchor-link" href="#PartEvalPrepass"></a></h2>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=43">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="nb">type</span> <span class="n">Id</span> <span class="o">=</span> <span class="n">int32</span>
<span class="nb">type</span> <span class="n">ScopeEnv</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span><span class="n">free_vars</span> <span class="p">:</span> <span class="nb">int</span> <span class="p">[];</span> <span class="n">stack_size</span> <span class="p">:</span> <span class="nb">int</span><span class="o">|</span><span class="p">}</span>
<span class="nb">type</span> <span class="n">Scope</span> <span class="o">=</span> <span class="p">{</span><span class="n">term</span> <span class="p">:</span> <span class="n">ScopeEnv</span><span class="p">;</span> <span class="n">ty</span> <span class="p">:</span> <span class="n">ScopeEnv</span><span class="p">}</span>
<span class="nb">type</span> <span class="n">Range</span> <span class="o">=</span> <span class="p">{</span><span class="n">path</span> <span class="p">:</span> <span class="n">string</span><span class="p">;</span> <span class="nb">range</span> <span class="p">:</span> <span class="n">VSCRange</span><span class="p">}</span>

<span class="nb">type</span> <span class="n">Macro</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">MText</span> <span class="n">of</span> <span class="n">string</span>
    <span class="o">|</span> <span class="n">MTerm</span> <span class="n">of</span> <span class="n">E</span>
    <span class="o">|</span> <span class="n">MType</span> <span class="n">of</span> <span class="n">TPrepass</span>
    <span class="o">|</span> <span class="n">MLitType</span> <span class="n">of</span> <span class="n">TPrepass</span>
<span class="ow">and</span> <span class="n">TypeMacro</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">TMText</span> <span class="n">of</span> <span class="n">string</span>
    <span class="o">|</span> <span class="n">TMType</span> <span class="n">of</span> <span class="n">TPrepass</span>
    <span class="o">|</span> <span class="n">TMLitType</span> <span class="n">of</span> <span class="n">TPrepass</span>
<span class="ow">and</span> <span class="n">RecordWith</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">RSymbol</span> <span class="n">of</span> <span class="p">(</span><span class="n">Range</span> <span class="o">*</span> <span class="n">string</span><span class="p">)</span> <span class="o">*</span> <span class="n">E</span>
    <span class="o">|</span> <span class="n">RSymbolModify</span> <span class="n">of</span> <span class="p">(</span><span class="n">Range</span> <span class="o">*</span> <span class="n">string</span><span class="p">)</span> <span class="o">*</span> <span class="n">E</span>
    <span class="o">|</span> <span class="n">RVar</span> <span class="n">of</span> <span class="p">(</span><span class="n">Range</span> <span class="o">*</span> <span class="n">E</span><span class="p">)</span> <span class="o">*</span> <span class="n">E</span>
    <span class="o">|</span> <span class="n">RVarModify</span> <span class="n">of</span> <span class="p">(</span><span class="n">Range</span> <span class="o">*</span> <span class="n">E</span><span class="p">)</span> <span class="o">*</span> <span class="n">E</span>
<span class="ow">and</span> <span class="n">RecordWithout</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">WSymbol</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">string</span>
    <span class="o">|</span> <span class="n">WVar</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">E</span>
<span class="ow">and</span> <span class="n">PatRecordMemberPrepass</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">Symbol</span> <span class="n">of</span> <span class="p">(</span><span class="n">Range</span> <span class="o">*</span> <span class="n">string</span><span class="p">)</span> <span class="o">*</span> <span class="n">Id</span>
    <span class="o">|</span> <span class="n">Var</span> <span class="n">of</span> <span class="p">(</span><span class="n">Range</span> <span class="o">*</span> <span class="n">E</span><span class="p">)</span> <span class="o">*</span> <span class="n">Id</span>
<span class="ow">and</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ReferenceEquality</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">E</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">EFun</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">Id</span> <span class="o">*</span> <span class="n">E</span> <span class="o">*</span> <span class="n">TPrepass</span> <span class="n">option</span>
    <span class="o">|</span> <span class="n">EFun</span><span class="s1">' of Range * Scope * Id * E * TPrepass option</span>
    <span class="o">|</span> <span class="n">EForall</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">Id</span> <span class="o">*</span> <span class="n">E</span>
    <span class="o">|</span> <span class="n">EForall</span><span class="s1">' of Range * Scope * Id * E</span>
    <span class="o">|</span> <span class="n">ERecursiveFun</span><span class="s1">' of Range * Scope * Id * E ref * TPrepass option</span>
    <span class="o">|</span> <span class="n">ERecursiveForall</span><span class="s1">' of Range * Scope * Id * E ref</span>
    <span class="o">|</span> <span class="n">ERecursive</span> <span class="n">of</span> <span class="n">E</span> <span class="n">ref</span> <span class="o">//</span> <span class="n">For</span> <span class="k">global</span> <span class="n">mutually</span> <span class="n">recursive</span> <span class="n">functions</span>
    <span class="o">|</span> <span class="n">EPatternRef</span> <span class="n">of</span> <span class="n">E</span> <span class="n">ref</span>
    <span class="o">|</span> <span class="n">EJoinPoint</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">E</span> <span class="o">*</span> <span class="n">TPrepass</span> <span class="n">option</span> <span class="o">*</span> <span class="n">backend</span><span class="p">:</span> <span class="p">(</span><span class="n">Range</span> <span class="o">*</span> <span class="n">string</span><span class="p">)</span> <span class="n">option</span> <span class="o">*</span> <span class="n">name</span><span class="p">:</span> <span class="n">string</span> <span class="n">option</span>
    <span class="o">|</span> <span class="n">EJoinPoint</span><span class="s1">' of Range * Scope * E * TPrepass option * backend: (Range * string) option * name: string option</span>
    <span class="o">|</span> <span class="n">EB</span> <span class="n">of</span> <span class="n">Range</span>
    <span class="o">|</span> <span class="n">EV</span> <span class="n">of</span> <span class="n">Id</span>
    <span class="o">|</span> <span class="n">ELit</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">Literal</span>
    <span class="o">|</span> <span class="n">EDefaultLit</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">string</span> <span class="o">*</span> <span class="n">TPrepass</span>
    <span class="o">|</span> <span class="n">ESymbol</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">string</span>
    <span class="o">|</span> <span class="n">EType</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">TPrepass</span>
    <span class="o">|</span> <span class="n">EApply</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">E</span> <span class="o">*</span> <span class="n">E</span>
    <span class="o">|</span> <span class="n">EArray</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">E</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">TPrepass</span>
    <span class="o">|</span> <span class="n">ETypeApply</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">E</span> <span class="o">*</span> <span class="n">TPrepass</span>
    <span class="o">|</span> <span class="n">ERecBlock</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="p">(</span><span class="n">Id</span> <span class="o">*</span> <span class="n">E</span><span class="p">)</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">on_succ</span><span class="p">:</span> <span class="n">E</span>
    <span class="o">|</span> <span class="n">ERecordWith</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="p">(</span><span class="n">Range</span> <span class="o">*</span> <span class="n">E</span><span class="p">)</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">RecordWith</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">RecordWithout</span> <span class="nb">list</span>
    <span class="o">|</span> <span class="n">EModule</span> <span class="n">of</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span>
    <span class="o">|</span> <span class="n">EOp</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">Op</span> <span class="o">*</span> <span class="n">E</span> <span class="nb">list</span>
    <span class="o">|</span> <span class="n">EPatternMiss</span> <span class="n">of</span> <span class="n">E</span>
    <span class="o">|</span> <span class="n">ETypePatternMiss</span> <span class="n">of</span> <span class="n">TPrepass</span>
    <span class="o">|</span> <span class="n">EAnnot</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">E</span> <span class="o">*</span> <span class="n">TPrepass</span>
    <span class="o">|</span> <span class="n">EIfThenElse</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">E</span> <span class="o">*</span> <span class="n">E</span> <span class="o">*</span> <span class="n">E</span>
    <span class="o">|</span> <span class="n">EIfThen</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">E</span> <span class="o">*</span> <span class="n">E</span>
    <span class="o">|</span> <span class="n">EPair</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">E</span> <span class="o">*</span> <span class="n">E</span>
    <span class="o">|</span> <span class="n">ESeq</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">E</span> <span class="o">*</span> <span class="n">E</span>
    <span class="o">|</span> <span class="n">EMutableSet</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">E</span> <span class="o">*</span> <span class="p">(</span><span class="n">Range</span> <span class="o">*</span> <span class="n">E</span><span class="p">)</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">E</span>
    <span class="o">|</span> <span class="n">EReal</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">E</span>
    <span class="o">|</span> <span class="n">EExists</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">TPrepass</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">E</span>
    <span class="o">|</span> <span class="n">EMacro</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">Macro</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">TPrepass</span>
    <span class="o">|</span> <span class="n">EPrototypeApply</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">prototype_id</span><span class="p">:</span> <span class="n">GlobalId</span> <span class="o">*</span> <span class="n">TPrepass</span>
    <span class="o">|</span> <span class="n">EPatternMemo</span> <span class="n">of</span> <span class="n">E</span>
    <span class="o">|</span> <span class="n">ENominal</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">E</span> <span class="o">*</span> <span class="n">TPrepass</span>
    <span class="o">//</span> <span class="n">Regular</span> <span class="n">pattern</span> <span class="n">matching</span>
    <span class="o">|</span> <span class="n">ELet</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">Id</span> <span class="o">*</span> <span class="n">E</span> <span class="o">*</span> <span class="n">E</span>
    <span class="o">|</span> <span class="n">EUnbox</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">symbol</span><span class="p">:</span> <span class="n">string</span> <span class="o">*</span> <span class="n">Id</span> <span class="o">*</span> <span class="n">body</span><span class="p">:</span> <span class="n">E</span> <span class="o">*</span> <span class="n">on_succ</span><span class="p">:</span> <span class="n">E</span> <span class="o">*</span> <span class="n">on_fail</span><span class="p">:</span> <span class="n">E</span>
    <span class="o">|</span> <span class="n">EExistsTest</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">bind</span><span class="p">:</span> <span class="n">Id</span> <span class="o">*</span> <span class="n">pat_type</span><span class="p">:</span> <span class="n">Id</span> <span class="p">[]</span> <span class="o">*</span> <span class="n">pat</span><span class="p">:</span> <span class="n">Id</span> <span class="o">*</span> <span class="n">on_succ</span><span class="p">:</span> <span class="n">E</span> <span class="o">*</span> <span class="n">on_fail</span><span class="p">:</span> <span class="n">E</span>
    <span class="o">|</span> <span class="n">EPairTest</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">bind</span><span class="p">:</span> <span class="n">Id</span> <span class="o">*</span> <span class="n">pat1</span><span class="p">:</span> <span class="n">Id</span> <span class="o">*</span> <span class="n">pat2</span><span class="p">:</span> <span class="n">Id</span> <span class="o">*</span> <span class="n">on_succ</span><span class="p">:</span> <span class="n">E</span> <span class="o">*</span> <span class="n">on_fail</span><span class="p">:</span> <span class="n">E</span>
    <span class="o">|</span> <span class="n">ESymbolTest</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">string</span> <span class="o">*</span> <span class="n">bind</span><span class="p">:</span> <span class="n">Id</span> <span class="o">*</span> <span class="n">on_succ</span><span class="p">:</span> <span class="n">E</span> <span class="o">*</span> <span class="n">on_fail</span><span class="p">:</span> <span class="n">E</span>
    <span class="o">|</span> <span class="n">ERecordTest</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">PatRecordMemberPrepass</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">bind</span><span class="p">:</span> <span class="n">Id</span> <span class="o">*</span> <span class="n">on_succ</span><span class="p">:</span> <span class="n">E</span> <span class="o">*</span> <span class="n">on_fail</span><span class="p">:</span> <span class="n">E</span>
    <span class="o">|</span> <span class="n">EAnnotTest</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">TPrepass</span> <span class="o">*</span> <span class="n">bind</span><span class="p">:</span> <span class="n">Id</span> <span class="o">*</span> <span class="n">on_succ</span><span class="p">:</span> <span class="n">E</span> <span class="o">*</span> <span class="n">on_fail</span><span class="p">:</span> <span class="n">E</span>
    <span class="o">|</span> <span class="n">EUnitTest</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">bind</span><span class="p">:</span> <span class="n">Id</span> <span class="o">*</span> <span class="n">on_succ</span><span class="p">:</span> <span class="n">E</span> <span class="o">*</span> <span class="n">on_fail</span><span class="p">:</span> <span class="n">E</span>
    <span class="o">|</span> <span class="n">ENominalTest</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">TPrepass</span> <span class="o">*</span> <span class="n">bind</span><span class="p">:</span> <span class="n">Id</span> <span class="o">*</span> <span class="n">pat</span><span class="p">:</span> <span class="n">Id</span> <span class="o">*</span> <span class="n">on_succ</span><span class="p">:</span> <span class="n">E</span> <span class="o">*</span> <span class="n">on_fail</span><span class="p">:</span> <span class="n">E</span>
    <span class="o">|</span> <span class="n">ELitTest</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">Literal</span> <span class="o">*</span> <span class="n">bind</span><span class="p">:</span> <span class="n">Id</span> <span class="o">*</span> <span class="n">on_succ</span><span class="p">:</span> <span class="n">E</span> <span class="o">*</span> <span class="n">on_fail</span><span class="p">:</span> <span class="n">E</span>
    <span class="o">|</span> <span class="n">EDefaultLitTest</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">string</span> <span class="o">*</span> <span class="n">TPrepass</span> <span class="o">*</span> <span class="n">bind</span><span class="p">:</span> <span class="n">Id</span> <span class="o">*</span> <span class="n">on_succ</span><span class="p">:</span> <span class="n">E</span> <span class="o">*</span> <span class="n">on_fail</span><span class="p">:</span> <span class="n">E</span>
    <span class="o">|</span> <span class="n">ETypecase</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">TPrepass</span> <span class="o">*</span> <span class="p">(</span><span class="n">TPrepass</span> <span class="o">*</span> <span class="n">E</span><span class="p">)</span> <span class="nb">list</span>
<span class="ow">and</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ReferenceEquality</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">TPrepass</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">TForall</span><span class="s1">' of Range * Scope * Id * TPrepass</span>
    <span class="o">|</span> <span class="n">TForall</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">Id</span> <span class="o">*</span> <span class="n">TPrepass</span>
    <span class="o">|</span> <span class="n">TArrow</span><span class="s1">' of Scope * Id * TPrepass</span>
    <span class="o">|</span> <span class="n">TArrow</span> <span class="n">of</span> <span class="n">Id</span> <span class="o">*</span> <span class="n">TPrepass</span>
    <span class="o">|</span> <span class="n">TExists</span>
    <span class="o">|</span> <span class="n">TJoinPoint</span><span class="s1">' of Range * Scope * TPrepass</span>
    <span class="o">|</span> <span class="n">TJoinPoint</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">TPrepass</span>
    <span class="o">|</span> <span class="n">TPatternRef</span> <span class="n">of</span> <span class="n">TPrepass</span> <span class="n">ref</span>
    <span class="o">|</span> <span class="n">TB</span> <span class="n">of</span> <span class="n">Range</span>
    <span class="o">|</span> <span class="n">TLit</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">Literal</span>
    <span class="o">|</span> <span class="n">TV</span> <span class="n">of</span> <span class="n">Id</span>
    <span class="o">|</span> <span class="n">TPair</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">TPrepass</span> <span class="o">*</span> <span class="n">TPrepass</span>
    <span class="o">|</span> <span class="n">TFun</span> <span class="n">of</span> <span class="n">TPrepass</span> <span class="o">*</span> <span class="n">TPrepass</span> <span class="o">*</span> <span class="n">FunType</span>
    <span class="o">|</span> <span class="n">TRecord</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">Map</span><span class="o">&lt;</span><span class="nb">int</span> <span class="o">*</span> <span class="n">string</span><span class="p">,</span><span class="n">TPrepass</span><span class="o">&gt;</span>
    <span class="o">|</span> <span class="n">TModule</span> <span class="n">of</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="n">TPrepass</span><span class="o">&gt;</span>
    <span class="o">|</span> <span class="n">TUnion</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="p">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="nb">int</span> <span class="o">*</span> <span class="n">string</span><span class="p">,</span><span class="n">TPrepass</span> <span class="o">*</span> <span class="n">TPrepass</span> <span class="n">option</span><span class="o">&gt;</span> <span class="o">*</span> <span class="n">UnionLayout</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">TSymbol</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">string</span>
    <span class="o">|</span> <span class="n">TApply</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">TPrepass</span> <span class="o">*</span> <span class="n">TPrepass</span>
    <span class="o">|</span> <span class="n">TPrim</span> <span class="n">of</span> <span class="n">PrimitiveType</span>
    <span class="o">|</span> <span class="n">TTerm</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">E</span>
    <span class="o">|</span> <span class="n">TMacro</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">TypeMacro</span> <span class="nb">list</span>
    <span class="o">|</span> <span class="n">TNominal</span> <span class="n">of</span> <span class="n">GlobalId</span>
    <span class="o">|</span> <span class="n">TArray</span> <span class="n">of</span> <span class="n">TPrepass</span>
    <span class="o">|</span> <span class="n">TLayout</span> <span class="n">of</span> <span class="n">TPrepass</span> <span class="o">*</span> <span class="n">Layout</span>
    <span class="o">|</span> <span class="n">TMetaV</span> <span class="n">of</span> <span class="n">Id</span>
    <span class="o">|</span> <span class="n">TTypecase</span> <span class="n">of</span> <span class="n">Range</span> <span class="o">*</span> <span class="n">TPrepass</span> <span class="o">*</span> <span class="p">(</span><span class="n">TPrepass</span> <span class="o">*</span> <span class="n">TPrepass</span><span class="p">)</span> <span class="nb">list</span>

<span class="n">module</span> <span class="n">Printable</span> <span class="o">=</span>
    <span class="nb">type</span> <span class="n">PMacro</span> <span class="o">=</span>
        <span class="o">|</span> <span class="n">MText</span> <span class="n">of</span> <span class="n">string</span>
        <span class="o">|</span> <span class="n">MTerm</span> <span class="n">of</span> <span class="n">PE</span>
        <span class="o">|</span> <span class="n">MType</span> <span class="n">of</span> <span class="n">PT</span>
        <span class="o">|</span> <span class="n">MLitType</span> <span class="n">of</span> <span class="n">PT</span>
    <span class="ow">and</span> <span class="n">PTypeMacro</span> <span class="o">=</span>
        <span class="o">|</span> <span class="n">TMText</span> <span class="n">of</span> <span class="n">string</span>
        <span class="o">|</span> <span class="n">TMType</span> <span class="n">of</span> <span class="n">PT</span>
        <span class="o">|</span> <span class="n">TMLitType</span> <span class="n">of</span> <span class="n">PT</span>
    <span class="ow">and</span> <span class="n">PRecordWith</span> <span class="o">=</span>
        <span class="o">|</span> <span class="n">RSymbol</span> <span class="n">of</span> <span class="n">string</span> <span class="o">*</span> <span class="n">PE</span>
        <span class="o">|</span> <span class="n">RSymbolModify</span> <span class="n">of</span> <span class="n">string</span> <span class="o">*</span> <span class="n">PE</span>
        <span class="o">|</span> <span class="n">RVar</span> <span class="n">of</span> <span class="n">PE</span> <span class="o">*</span> <span class="n">PE</span>
        <span class="o">|</span> <span class="n">RVarModify</span> <span class="n">of</span> <span class="n">PE</span> <span class="o">*</span> <span class="n">PE</span>
    <span class="ow">and</span> <span class="n">PRecordWithout</span> <span class="o">=</span>
        <span class="o">|</span> <span class="n">WSymbol</span> <span class="n">of</span> <span class="n">string</span>
        <span class="o">|</span> <span class="n">WVar</span> <span class="n">of</span> <span class="n">PE</span>
    <span class="ow">and</span> <span class="n">PPatRecordMember</span> <span class="o">=</span>
        <span class="o">|</span> <span class="n">Symbol</span> <span class="n">of</span> <span class="n">string</span> <span class="o">*</span> <span class="n">Id</span>
        <span class="o">|</span> <span class="n">Var</span> <span class="n">of</span> <span class="n">PE</span> <span class="o">*</span> <span class="n">Id</span>
    <span class="ow">and</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ReferenceEquality</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">PE</span> <span class="o">=</span>
        <span class="o">|</span> <span class="n">EFun</span><span class="s1">' of Scope * Id * PE * PT option</span>
        <span class="o">|</span> <span class="n">EForall</span><span class="s1">' of Scope * Id * PE</span>
        <span class="o">|</span> <span class="n">ERecursiveFun</span><span class="s1">' of Scope * Id * PE * PT option</span>
        <span class="o">|</span> <span class="n">ERecursiveForall</span><span class="s1">' of Scope * Id * PE</span>
        <span class="o">|</span> <span class="n">ERecursive</span> <span class="n">of</span> <span class="n">PE</span>
        <span class="o">|</span> <span class="n">EJoinPoint</span> <span class="n">of</span> <span class="n">PE</span> <span class="o">*</span> <span class="n">PT</span> <span class="n">option</span> <span class="o">*</span> <span class="n">string</span> <span class="n">option</span>
        <span class="o">|</span> <span class="n">EJoinPoint</span><span class="s1">' of Scope * PE * PT option * string option</span>
        <span class="o">|</span> <span class="n">EArray</span> <span class="n">of</span> <span class="n">PE</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">PT</span>
        <span class="o">|</span> <span class="n">EFun</span> <span class="n">of</span> <span class="n">Id</span> <span class="o">*</span> <span class="n">PE</span> <span class="o">*</span> <span class="n">PT</span> <span class="n">option</span>
        <span class="o">|</span> <span class="n">EForall</span> <span class="n">of</span> <span class="n">Id</span> <span class="o">*</span> <span class="n">PE</span>
        <span class="o">|</span> <span class="n">EB</span>
        <span class="o">|</span> <span class="n">EV</span> <span class="n">of</span> <span class="n">Id</span>
        <span class="o">|</span> <span class="n">ELit</span> <span class="n">of</span> <span class="n">Literal</span>
        <span class="o">|</span> <span class="n">EDefaultLit</span> <span class="n">of</span> <span class="n">string</span> <span class="o">*</span> <span class="n">PT</span>
        <span class="o">|</span> <span class="n">ESymbol</span> <span class="n">of</span> <span class="n">string</span>
        <span class="o">|</span> <span class="n">EType</span> <span class="n">of</span> <span class="n">PT</span>
        <span class="o">|</span> <span class="n">EApply</span> <span class="n">of</span> <span class="n">PE</span> <span class="o">*</span> <span class="n">PE</span>
        <span class="o">|</span> <span class="n">ETypeApply</span> <span class="n">of</span> <span class="n">PE</span> <span class="o">*</span> <span class="n">PT</span>
        <span class="o">|</span> <span class="n">ERecBlock</span> <span class="n">of</span> <span class="p">(</span><span class="n">Id</span> <span class="o">*</span> <span class="n">PE</span><span class="p">)</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">on_succ</span><span class="p">:</span> <span class="n">PE</span>
        <span class="o">|</span> <span class="n">ERecordWith</span> <span class="n">of</span> <span class="n">PE</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">PRecordWith</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">PRecordWithout</span> <span class="nb">list</span>
        <span class="o">|</span> <span class="n">EModule</span> <span class="n">of</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">PE</span><span class="o">&gt;</span>
        <span class="o">|</span> <span class="n">EOp</span> <span class="n">of</span> <span class="n">Op</span> <span class="o">*</span> <span class="n">PE</span> <span class="nb">list</span>
        <span class="o">|</span> <span class="n">EPatternMiss</span> <span class="n">of</span> <span class="n">PE</span>
        <span class="o">|</span> <span class="n">ETypePatternMiss</span> <span class="n">of</span> <span class="n">PT</span>
        <span class="o">|</span> <span class="n">EAnnot</span> <span class="n">of</span> <span class="n">PE</span> <span class="o">*</span> <span class="n">PT</span>
        <span class="o">|</span> <span class="n">EIfThenElse</span> <span class="n">of</span> <span class="n">PE</span> <span class="o">*</span> <span class="n">PE</span> <span class="o">*</span> <span class="n">PE</span>
        <span class="o">|</span> <span class="n">EIfThen</span> <span class="n">of</span> <span class="n">PE</span> <span class="o">*</span> <span class="n">PE</span>
        <span class="o">|</span> <span class="n">EPair</span> <span class="n">of</span> <span class="n">PE</span> <span class="o">*</span> <span class="n">PE</span>
        <span class="o">|</span> <span class="n">ESeq</span> <span class="n">of</span> <span class="n">PE</span> <span class="o">*</span> <span class="n">PE</span>
        <span class="o">|</span> <span class="n">EHeapMutableSet</span> <span class="n">of</span> <span class="n">PE</span> <span class="o">*</span> <span class="n">PE</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">PE</span>
        <span class="o">|</span> <span class="n">EReal</span> <span class="n">of</span> <span class="n">PE</span>
        <span class="o">|</span> <span class="n">EExists</span> <span class="n">of</span> <span class="n">PT</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">PE</span>
        <span class="o">|</span> <span class="n">EMacro</span> <span class="n">of</span> <span class="n">PMacro</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">PT</span>
        <span class="o">|</span> <span class="n">EPrototypeApply</span> <span class="n">of</span> <span class="n">prototype_id</span><span class="p">:</span> <span class="n">GlobalId</span> <span class="o">*</span> <span class="n">PT</span>
        <span class="o">|</span> <span class="n">EPatternMemo</span> <span class="n">of</span> <span class="n">PE</span>
        <span class="o">|</span> <span class="n">ENominal</span> <span class="n">of</span> <span class="n">PE</span> <span class="o">*</span> <span class="n">PT</span>
        <span class="o">//</span> <span class="n">Regular</span> <span class="n">pattern</span> <span class="n">matching</span>
        <span class="o">|</span> <span class="n">ELet</span> <span class="n">of</span> <span class="n">Id</span> <span class="o">*</span> <span class="n">PE</span> <span class="o">*</span> <span class="n">PE</span>
        <span class="o">|</span> <span class="n">EUnbox</span> <span class="n">of</span> <span class="n">Id</span> <span class="o">*</span> <span class="n">string</span> <span class="o">*</span> <span class="n">PE</span> <span class="o">*</span> <span class="n">PE</span> <span class="o">*</span> <span class="n">PE</span>
        <span class="o">|</span> <span class="n">EExistsTest</span> <span class="n">of</span> <span class="n">bind</span><span class="p">:</span> <span class="n">Id</span> <span class="o">*</span> <span class="n">pat_type</span><span class="p">:</span> <span class="n">Id</span> <span class="p">[]</span> <span class="o">*</span> <span class="n">pat</span><span class="p">:</span> <span class="n">Id</span> <span class="o">*</span> <span class="n">on_succ</span><span class="p">:</span> <span class="n">PE</span> <span class="o">*</span> <span class="n">on_fail</span><span class="p">:</span> <span class="n">PE</span>
        <span class="o">|</span> <span class="n">EPairTest</span> <span class="n">of</span> <span class="n">bind</span><span class="p">:</span> <span class="n">Id</span> <span class="o">*</span> <span class="n">pat1</span><span class="p">:</span> <span class="n">Id</span> <span class="o">*</span> <span class="n">pat2</span><span class="p">:</span> <span class="n">Id</span> <span class="o">*</span> <span class="n">on_succ</span><span class="p">:</span> <span class="n">PE</span> <span class="o">*</span> <span class="n">on_fail</span><span class="p">:</span> <span class="n">PE</span>
        <span class="o">|</span> <span class="n">ESymbolTest</span> <span class="n">of</span> <span class="n">string</span> <span class="o">*</span> <span class="n">bind</span><span class="p">:</span> <span class="n">Id</span> <span class="o">*</span> <span class="n">on_succ</span><span class="p">:</span> <span class="n">PE</span> <span class="o">*</span> <span class="n">on_fail</span><span class="p">:</span> <span class="n">PE</span>
        <span class="o">|</span> <span class="n">ERecordTest</span> <span class="n">of</span> <span class="n">PPatRecordMember</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">bind</span><span class="p">:</span> <span class="n">Id</span> <span class="o">*</span> <span class="n">on_succ</span><span class="p">:</span> <span class="n">PE</span> <span class="o">*</span> <span class="n">on_fail</span><span class="p">:</span> <span class="n">PE</span>
        <span class="o">|</span> <span class="n">EAnnotTest</span> <span class="n">of</span> <span class="n">PT</span> <span class="o">*</span> <span class="n">bind</span><span class="p">:</span> <span class="n">Id</span> <span class="o">*</span> <span class="n">on_succ</span><span class="p">:</span> <span class="n">PE</span> <span class="o">*</span> <span class="n">on_fail</span><span class="p">:</span> <span class="n">PE</span>
        <span class="o">|</span> <span class="n">EUnitTest</span> <span class="n">of</span> <span class="n">bind</span><span class="p">:</span> <span class="n">Id</span> <span class="o">*</span> <span class="n">on_succ</span><span class="p">:</span> <span class="n">PE</span> <span class="o">*</span> <span class="n">on_fail</span><span class="p">:</span> <span class="n">PE</span>
        <span class="o">|</span> <span class="n">ENominalTest</span> <span class="n">of</span> <span class="n">PT</span> <span class="o">*</span> <span class="n">bind</span><span class="p">:</span> <span class="n">Id</span> <span class="o">*</span> <span class="n">pat</span><span class="p">:</span> <span class="n">Id</span> <span class="o">*</span> <span class="n">on_succ</span><span class="p">:</span> <span class="n">PE</span> <span class="o">*</span> <span class="n">on_fail</span><span class="p">:</span> <span class="n">PE</span>
        <span class="o">|</span> <span class="n">ELitTest</span> <span class="n">of</span> <span class="n">Literal</span> <span class="o">*</span> <span class="n">bind</span><span class="p">:</span> <span class="n">Id</span> <span class="o">*</span> <span class="n">on_succ</span><span class="p">:</span> <span class="n">PE</span> <span class="o">*</span> <span class="n">on_fail</span><span class="p">:</span> <span class="n">PE</span>
        <span class="o">|</span> <span class="n">EDefaultLitTest</span> <span class="n">of</span> <span class="n">string</span> <span class="o">*</span> <span class="n">PT</span> <span class="o">*</span> <span class="n">bind</span><span class="p">:</span> <span class="n">Id</span> <span class="o">*</span> <span class="n">on_succ</span><span class="p">:</span> <span class="n">PE</span> <span class="o">*</span> <span class="n">on_fail</span><span class="p">:</span> <span class="n">PE</span>
        <span class="o">|</span> <span class="n">ETypecase</span> <span class="n">of</span> <span class="n">PT</span> <span class="o">*</span> <span class="p">(</span><span class="n">PT</span> <span class="o">*</span> <span class="n">PE</span><span class="p">)</span> <span class="nb">list</span>
        <span class="o">|</span> <span class="n">EOmmitedRecursive</span>
    <span class="ow">and</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ReferenceEquality</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">PT</span> <span class="o">=</span>
        <span class="o">|</span> <span class="n">TTypecase</span> <span class="n">of</span> <span class="n">PT</span> <span class="o">*</span> <span class="p">(</span><span class="n">PT</span> <span class="o">*</span> <span class="n">PT</span><span class="p">)</span> <span class="nb">list</span>
        <span class="o">|</span> <span class="n">TForall</span><span class="s1">' of Scope * Id * PT</span>
        <span class="o">|</span> <span class="n">TForall</span> <span class="n">of</span> <span class="n">Id</span> <span class="o">*</span> <span class="n">PT</span>
        <span class="o">|</span> <span class="n">TArrow</span><span class="s1">' of Scope * Id * PT</span>
        <span class="o">|</span> <span class="n">TArrow</span> <span class="n">of</span> <span class="n">Id</span> <span class="o">*</span> <span class="n">PT</span>
        <span class="o">|</span> <span class="n">TExists</span>
        <span class="o">|</span> <span class="n">TJoinPoint</span><span class="s1">' of Scope * PT</span>
        <span class="o">|</span> <span class="n">TJoinPoint</span> <span class="n">of</span> <span class="n">PT</span>
        <span class="o">|</span> <span class="n">TB</span>
        <span class="o">|</span> <span class="n">TLit</span> <span class="n">of</span> <span class="n">Literal</span>
        <span class="o">|</span> <span class="n">TV</span> <span class="n">of</span> <span class="n">Id</span>
        <span class="o">|</span> <span class="n">TMetaV</span> <span class="n">of</span> <span class="n">Id</span>
        <span class="o">|</span> <span class="n">TPair</span> <span class="n">of</span> <span class="n">PT</span> <span class="o">*</span> <span class="n">PT</span>
        <span class="o">|</span> <span class="n">TFun</span> <span class="n">of</span> <span class="n">PT</span> <span class="o">*</span> <span class="n">PT</span> <span class="o">*</span> <span class="n">FunType</span>
        <span class="o">|</span> <span class="n">TFunPtr</span> <span class="n">of</span> <span class="n">PT</span> <span class="o">*</span> <span class="n">PT</span>
        <span class="o">|</span> <span class="n">TRecord</span> <span class="n">of</span> <span class="n">Map</span><span class="o">&lt;</span><span class="nb">int</span> <span class="o">*</span> <span class="n">string</span><span class="p">,</span><span class="n">PT</span><span class="o">&gt;</span>
        <span class="o">|</span> <span class="n">TModule</span> <span class="n">of</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="n">PT</span><span class="o">&gt;</span>
        <span class="o">|</span> <span class="n">TUnion</span> <span class="n">of</span> <span class="n">Map</span><span class="o">&lt;</span><span class="nb">int</span> <span class="o">*</span> <span class="n">string</span><span class="p">,</span><span class="n">PT</span><span class="o">&gt;</span> <span class="o">*</span> <span class="n">UnionLayout</span>
        <span class="o">|</span> <span class="n">TSymbol</span> <span class="n">of</span> <span class="n">string</span>
        <span class="o">|</span> <span class="n">TApply</span> <span class="n">of</span> <span class="n">PT</span> <span class="o">*</span> <span class="n">PT</span>
        <span class="o">|</span> <span class="n">TPrim</span> <span class="n">of</span> <span class="n">PrimitiveType</span>
        <span class="o">|</span> <span class="n">TTerm</span> <span class="n">of</span> <span class="n">PE</span>
        <span class="o">|</span> <span class="n">TMacro</span> <span class="n">of</span> <span class="n">PTypeMacro</span> <span class="nb">list</span>
        <span class="o">|</span> <span class="n">TNominal</span> <span class="n">of</span> <span class="n">GlobalId</span>
        <span class="o">|</span> <span class="n">TArray</span> <span class="n">of</span> <span class="n">PT</span>
        <span class="o">|</span> <span class="n">TLayout</span> <span class="n">of</span> <span class="n">PT</span> <span class="o">*</span> <span class="n">Layout</span>

    <span class="n">let</span> <span class="nb">eval</span> <span class="n">x</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">recs</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">Generic</span><span class="o">.</span><span class="n">HashSet</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Reference</span><span class="p">)</span>
        <span class="n">let</span> <span class="n">rec</span> <span class="n">term</span> <span class="o">=</span> <span class="n">function</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">ETypecase</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ETypecase</span><span class="p">(</span><span class="n">ty</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ty</span> <span class="n">a</span><span class="p">,</span> <span class="n">term</span> <span class="n">b</span><span class="p">))</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">EPatternRef</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">term</span> <span class="n">a</span><span class="o">.</span><span class="n">Value</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">EFun</span><span class="s1">'(_,a,b,c,d) -&gt; EFun'</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">term</span> <span class="n">c</span><span class="p">,</span><span class="n">Option</span><span class="o">.</span><span class="n">map</span> <span class="n">ty</span> <span class="n">d</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">EForall</span><span class="s1">'(_,a,b,c) -&gt; EForall'</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">term</span> <span class="n">c</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">EArray</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EArray</span><span class="p">(</span><span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="n">term</span> <span class="n">a</span><span class="p">,</span><span class="n">ty</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">ERecursiveFun</span><span class="s1">'(_,a,b,c,d) -&gt; </span>
                <span class="n">let</span> <span class="n">r</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Value</span>
                <span class="n">let</span> <span class="n">r</span> <span class="o">=</span> <span class="k">if</span> <span class="n">recs</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="n">then</span> <span class="n">term</span> <span class="n">r</span> <span class="k">else</span> <span class="n">EOmmitedRecursive</span>
                <span class="n">ERecursiveFun</span><span class="s1">'(a,b,r,Option.map ty d)</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">ERecursiveForall</span><span class="s1">'(_,a,b,c) -&gt; </span>
                <span class="n">let</span> <span class="n">r</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Value</span>
                <span class="n">let</span> <span class="n">r</span> <span class="o">=</span> <span class="k">if</span> <span class="n">recs</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="n">then</span> <span class="n">term</span> <span class="n">r</span> <span class="k">else</span> <span class="n">EOmmitedRecursive</span>
                <span class="n">ERecursiveForall</span><span class="s1">'(a,b,r)</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">ERecursive</span> <span class="n">a</span> <span class="o">-&gt;</span> 
                <span class="n">let</span> <span class="n">r</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">Value</span>
                <span class="k">if</span> <span class="n">isNull</span> <span class="p">(</span><span class="n">box</span> <span class="n">r</span><span class="p">)</span> <span class="n">then</span> <span class="n">EOmmitedRecursive</span>
                <span class="k">else</span>
                    <span class="n">let</span> <span class="n">r</span> <span class="o">=</span> <span class="k">if</span> <span class="n">recs</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="n">then</span> <span class="n">term</span> <span class="n">r</span> <span class="k">else</span> <span class="n">EOmmitedRecursive</span>
                    <span class="n">ERecursive</span> <span class="n">r</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">EJoinPoint</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EJoinPoint</span><span class="p">(</span><span class="n">term</span> <span class="n">a</span><span class="p">,</span><span class="n">Option</span><span class="o">.</span><span class="n">map</span> <span class="n">ty</span> <span class="n">b</span><span class="p">,</span><span class="n">Option</span><span class="o">.</span><span class="n">map</span> <span class="n">snd</span> <span class="n">d</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">EJoinPoint</span><span class="s1">'(_,a,b,c,d,_) -&gt; EJoinPoint'</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">term</span> <span class="n">b</span><span class="p">,</span><span class="n">Option</span><span class="o">.</span><span class="n">map</span> <span class="n">ty</span> <span class="n">c</span><span class="p">,</span><span class="n">Option</span><span class="o">.</span><span class="n">map</span> <span class="n">snd</span> <span class="n">d</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">EFun</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EFun</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">term</span> <span class="n">b</span><span class="p">,</span><span class="n">Option</span><span class="o">.</span><span class="n">map</span> <span class="n">ty</span> <span class="n">c</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">EForall</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EForall</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">term</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">EB</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">EB</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">EV</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">EV</span> <span class="n">i</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">ELit</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ELit</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">EDefaultLit</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EDefaultLit</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">ty</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">ESymbol</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ESymbol</span> <span class="n">a</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">EType</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EType</span><span class="p">(</span><span class="n">ty</span> <span class="n">a</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">EApply</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EApply</span><span class="p">(</span><span class="n">term</span> <span class="n">a</span><span class="p">,</span><span class="n">term</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">ETypeApply</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ETypeApply</span><span class="p">(</span><span class="n">term</span> <span class="n">a</span><span class="p">,</span><span class="n">ty</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">ERecBlock</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ERecBlock</span><span class="p">(</span><span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="p">,</span> <span class="n">term</span> <span class="n">b</span><span class="p">)</span> <span class="n">a</span><span class="p">,</span><span class="n">term</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">ERecordWith</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">term</span> <span class="n">a</span><span class="p">)</span>
                <span class="n">let</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">function</span>
                    <span class="o">|</span> <span class="n">RecordWith</span><span class="o">.</span><span class="n">RSymbol</span><span class="p">((</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RSymbol</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">term</span> <span class="n">b</span><span class="p">)</span>
                    <span class="o">|</span> <span class="n">RecordWith</span><span class="o">.</span><span class="n">RSymbolModify</span><span class="p">((</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RSymbolModify</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">term</span> <span class="n">b</span><span class="p">)</span>
                    <span class="o">|</span> <span class="n">RecordWith</span><span class="o">.</span><span class="n">RVar</span><span class="p">((</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RVar</span><span class="p">(</span><span class="n">term</span> <span class="n">a</span><span class="p">,</span><span class="n">term</span> <span class="n">b</span><span class="p">)</span>
                    <span class="o">|</span> <span class="n">RecordWith</span><span class="o">.</span><span class="n">RVarModify</span><span class="p">((</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RVarModify</span><span class="p">(</span><span class="n">term</span> <span class="n">a</span><span class="p">,</span><span class="n">term</span> <span class="n">b</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">let</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">function</span>
                    <span class="o">|</span> <span class="n">RecordWithout</span><span class="o">.</span><span class="n">WSymbol</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WSymbol</span> <span class="n">a</span>
                    <span class="o">|</span> <span class="n">RecordWithout</span><span class="o">.</span><span class="n">WVar</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WVar</span><span class="p">(</span><span class="n">term</span> <span class="n">a</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">ERecordWith</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">EModule</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">EModule</span><span class="p">(</span><span class="n">Map</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">term</span><span class="p">)</span> <span class="n">a</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EOp</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="n">term</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">EPatternMiss</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">EPatternMiss</span><span class="p">(</span><span class="n">term</span> <span class="n">a</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">ETypePatternMiss</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">ETypePatternMiss</span><span class="p">(</span><span class="n">ty</span> <span class="n">a</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">EAnnot</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EAnnot</span><span class="p">(</span><span class="n">term</span> <span class="n">a</span><span class="p">,</span><span class="n">ty</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">EIfThenElse</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EIfThenElse</span><span class="p">(</span><span class="n">term</span> <span class="n">a</span><span class="p">,</span><span class="n">term</span> <span class="n">b</span><span class="p">,</span><span class="n">term</span> <span class="n">c</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">EIfThen</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EIfThen</span><span class="p">(</span><span class="n">term</span> <span class="n">a</span><span class="p">,</span><span class="n">term</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">EPair</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EPair</span><span class="p">(</span><span class="n">term</span> <span class="n">a</span><span class="p">,</span><span class="n">term</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">ESeq</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ESeq</span><span class="p">(</span><span class="n">term</span> <span class="n">a</span><span class="p">,</span><span class="n">term</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">EMutableSet</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EHeapMutableSet</span><span class="p">(</span><span class="n">term</span> <span class="n">a</span><span class="p">,</span><span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">snd</span> <span class="o">&gt;&gt;</span> <span class="n">term</span><span class="p">)</span> <span class="n">b</span><span class="p">,</span><span class="n">term</span> <span class="n">c</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">EReal</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EReal</span><span class="p">(</span><span class="n">term</span> <span class="n">a</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">EExists</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EExists</span><span class="p">(</span><span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="n">ty</span> <span class="n">a</span><span class="p">,</span> <span class="n">term</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">EMacro</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">function</span>
                    <span class="o">|</span> <span class="n">Macro</span><span class="o">.</span><span class="n">MText</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">MText</span> <span class="n">a</span>
                    <span class="o">|</span> <span class="n">Macro</span><span class="o">.</span><span class="n">MTerm</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">MTerm</span><span class="p">(</span><span class="n">term</span> <span class="n">a</span><span class="p">)</span>
                    <span class="o">|</span> <span class="n">Macro</span><span class="o">.</span><span class="n">MType</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">MType</span><span class="p">(</span><span class="n">ty</span> <span class="n">a</span><span class="p">)</span>
                    <span class="o">|</span> <span class="n">Macro</span><span class="o">.</span><span class="n">MLitType</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">MLitType</span><span class="p">(</span><span class="n">ty</span> <span class="n">a</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">EMacro</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">ty</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">EPrototypeApply</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EPrototypeApply</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">ty</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">EPatternMemo</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">EPatternMemo</span><span class="p">(</span><span class="n">term</span> <span class="n">a</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">ENominal</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ENominal</span><span class="p">(</span><span class="n">term</span> <span class="n">a</span><span class="p">,</span><span class="n">ty</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">//</span> <span class="n">Regular</span> <span class="n">pattern</span> <span class="n">matching</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">ELet</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ELet</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">term</span> <span class="n">b</span><span class="p">,</span><span class="n">term</span> <span class="n">c</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">EUnbox</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EUnbox</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">term</span> <span class="n">b</span><span class="p">,</span><span class="n">term</span> <span class="n">c</span><span class="p">,</span><span class="n">term</span> <span class="n">d</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">EExistsTest</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">e</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EExistsTest</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">term</span> <span class="n">d</span><span class="p">,</span><span class="n">term</span> <span class="n">e</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">EPairTest</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">e</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EPairTest</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">term</span> <span class="n">d</span><span class="p">,</span><span class="n">term</span> <span class="n">e</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">ESymbolTest</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ESymbolTest</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">term</span> <span class="n">c</span><span class="p">,</span><span class="n">term</span> <span class="n">d</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">ERecordTest</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">function</span>
                    <span class="o">|</span> <span class="n">PatRecordMemberPrepass</span><span class="o">.</span><span class="n">Symbol</span><span class="p">((</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Symbol</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
                    <span class="o">|</span> <span class="n">PatRecordMemberPrepass</span><span class="o">.</span><span class="n">Var</span><span class="p">((</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Var</span><span class="p">(</span><span class="n">term</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">ERecordTest</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">term</span> <span class="n">c</span><span class="p">,</span><span class="n">term</span> <span class="n">d</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">EAnnotTest</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EAnnotTest</span><span class="p">(</span><span class="n">ty</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">term</span> <span class="n">c</span><span class="p">,</span><span class="n">term</span> <span class="n">d</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">EUnitTest</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EUnitTest</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">term</span> <span class="n">b</span><span class="p">,</span><span class="n">term</span> <span class="n">c</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">ENominalTest</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">e</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ENominalTest</span><span class="p">(</span><span class="n">ty</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">term</span> <span class="n">d</span><span class="p">,</span><span class="n">term</span> <span class="n">e</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">ELitTest</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ELitTest</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">term</span> <span class="n">c</span><span class="p">,</span><span class="n">term</span> <span class="n">d</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">E</span><span class="o">.</span><span class="n">EDefaultLitTest</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">e</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EDefaultLitTest</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">ty</span> <span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">term</span> <span class="n">d</span><span class="p">,</span><span class="n">term</span> <span class="n">e</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">ty</span> <span class="o">=</span> <span class="n">function</span>
            <span class="o">|</span> <span class="n">TPrepass</span><span class="o">.</span><span class="n">TTypecase</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TTypecase</span><span class="p">(</span><span class="n">ty</span> <span class="n">a</span><span class="p">,</span><span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ty</span> <span class="n">a</span><span class="p">,</span> <span class="n">ty</span> <span class="n">b</span><span class="p">)</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">TPrepass</span><span class="o">.</span><span class="n">TPatternRef</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">ty</span> <span class="n">a</span><span class="o">.</span><span class="n">Value</span>
            <span class="o">|</span> <span class="n">TPrepass</span><span class="o">.</span><span class="n">TForall</span><span class="s1">'(_,a,b,c) -&gt; TForall'</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">ty</span> <span class="n">c</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">TPrepass</span><span class="o">.</span><span class="n">TForall</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TForall</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">ty</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">TPrepass</span><span class="o">.</span><span class="n">TArrow</span><span class="s1">'(a,b,c) -&gt; TArrow'</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">ty</span> <span class="n">c</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">TPrepass</span><span class="o">.</span><span class="n">TArrow</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TArrow</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">ty</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">TPrepass</span><span class="o">.</span><span class="n">TExists</span> <span class="o">-&gt;</span> <span class="n">TExists</span>
            <span class="o">|</span> <span class="n">TPrepass</span><span class="o">.</span><span class="n">TJoinPoint</span><span class="s1">'(_,a,b) -&gt; TJoinPoint'</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">ty</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">TPrepass</span><span class="o">.</span><span class="n">TJoinPoint</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TJoinPoint</span><span class="p">(</span><span class="n">ty</span> <span class="n">a</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">TPrepass</span><span class="o">.</span><span class="n">TB</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">TB</span>
            <span class="o">|</span> <span class="n">TPrepass</span><span class="o">.</span><span class="n">TLit</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TLit</span> <span class="n">x</span>
            <span class="o">|</span> <span class="n">TPrepass</span><span class="o">.</span><span class="n">TV</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">TV</span> <span class="n">a</span>
            <span class="o">|</span> <span class="n">TPrepass</span><span class="o">.</span><span class="n">TMetaV</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">TMetaV</span> <span class="n">a</span>
            <span class="o">|</span> <span class="n">TPrepass</span><span class="o">.</span><span class="n">TPair</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TPair</span><span class="p">(</span><span class="n">ty</span> <span class="n">a</span><span class="p">,</span><span class="n">ty</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">TPrepass</span><span class="o">.</span><span class="n">TFun</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TFun</span><span class="p">(</span><span class="n">ty</span> <span class="n">a</span><span class="p">,</span><span class="n">ty</span> <span class="n">b</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">TPrepass</span><span class="o">.</span><span class="n">TRecord</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TRecord</span><span class="p">(</span><span class="n">Map</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">ty</span><span class="p">)</span> <span class="n">a</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">TPrepass</span><span class="o">.</span><span class="n">TModule</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">TModule</span><span class="p">(</span><span class="n">Map</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">ty</span><span class="p">)</span> <span class="n">a</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">TPrepass</span><span class="o">.</span><span class="n">TUnion</span><span class="p">(</span><span class="n">_</span><span class="p">,(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">TUnion</span><span class="p">(</span><span class="n">Map</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">ty</span> <span class="p">(</span><span class="n">fst</span> <span class="n">x</span><span class="p">))</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">TPrepass</span><span class="o">.</span><span class="n">TSymbol</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TSymbol</span> <span class="n">a</span>
            <span class="o">|</span> <span class="n">TPrepass</span><span class="o">.</span><span class="n">TApply</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TApply</span><span class="p">(</span><span class="n">ty</span> <span class="n">a</span><span class="p">,</span> <span class="n">ty</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">TPrepass</span><span class="o">.</span><span class="n">TPrim</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">TPrim</span> <span class="n">a</span>
            <span class="o">|</span> <span class="n">TPrepass</span><span class="o">.</span><span class="n">TTerm</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TTerm</span><span class="p">(</span><span class="n">term</span> <span class="n">a</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">TPrepass</span><span class="o">.</span><span class="n">TMacro</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> 
                <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">function</span>
                    <span class="o">|</span> <span class="n">TypeMacro</span><span class="o">.</span><span class="n">TMText</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">TMText</span> <span class="n">a</span>
                    <span class="o">|</span> <span class="n">TypeMacro</span><span class="o">.</span><span class="n">TMType</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">TMType</span><span class="p">(</span><span class="n">ty</span> <span class="n">a</span><span class="p">)</span>
                    <span class="o">|</span> <span class="n">TypeMacro</span><span class="o">.</span><span class="n">TMLitType</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">TMLitType</span><span class="p">(</span><span class="n">ty</span> <span class="n">a</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">TMacro</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">TPrepass</span><span class="o">.</span><span class="n">TNominal</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">TNominal</span> <span class="n">a</span>
            <span class="o">|</span> <span class="n">TPrepass</span><span class="o">.</span><span class="n">TArray</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">TArray</span><span class="p">(</span><span class="n">ty</span> <span class="n">a</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">TPrepass</span><span class="o">.</span><span class="n">TLayout</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TLayout</span><span class="p">(</span><span class="n">ty</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>

        <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">Choice1Of2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">ret</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ret</span> <span class="p">(</span><span class="n">term</span> <span class="n">x</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">Choice2Of2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">ret</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ret</span> <span class="p">(</span><span class="n">ty</span> <span class="n">x</span><span class="p">)</span>

<span class="o">//</span> <span class="nb">open</span> <span class="n">FSharpx</span><span class="o">.</span><span class="n">Collections</span>
<span class="nb">type</span> <span class="n">PrepassTopEnv</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">prototypes_next_tag</span> <span class="p">:</span> <span class="nb">int</span>
    <span class="n">prototypes_instances</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">GlobalId</span> <span class="o">*</span> <span class="n">GlobalId</span><span class="p">,</span><span class="n">E</span><span class="o">&gt;</span>
    <span class="n">nominals_next_tag</span> <span class="p">:</span> <span class="nb">int</span>
    <span class="n">nominals</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">GlobalId</span><span class="p">,{</span><span class="o">|</span><span class="n">body</span> <span class="p">:</span> <span class="n">TPrepass</span><span class="p">;</span> <span class="n">name</span> <span class="p">:</span> <span class="n">string</span><span class="o">|</span><span class="p">}</span><span class="o">&gt;</span>
    <span class="n">term</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="n">E</span><span class="o">&gt;</span>
    <span class="n">ty</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="n">TPrepass</span><span class="o">&gt;</span>
    <span class="p">}</span>

<span class="n">let</span> <span class="n">top_env_emptyPrepass</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">prototypes_next_tag</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">prototypes_instances</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
    <span class="n">nominals_next_tag</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">nominals</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
    <span class="n">term</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
    <span class="n">ty</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
    <span class="p">}</span>

<span class="n">let</span> <span class="n">unionPrepass</span> <span class="n">small</span> <span class="n">big</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">prototypes_next_tag</span> <span class="o">=</span> <span class="nb">max</span> <span class="n">small</span><span class="o">.</span><span class="n">prototypes_next_tag</span> <span class="n">big</span><span class="o">.</span><span class="n">prototypes_next_tag</span>
    <span class="n">prototypes_instances</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">small</span><span class="o">.</span><span class="n">prototypes_instances</span> <span class="n">big</span><span class="o">.</span><span class="n">prototypes_instances</span>
    <span class="n">nominals_next_tag</span> <span class="o">=</span> <span class="nb">max</span> <span class="n">small</span><span class="o">.</span><span class="n">nominals_next_tag</span> <span class="n">big</span><span class="o">.</span><span class="n">nominals_next_tag</span>
    <span class="n">nominals</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">small</span><span class="o">.</span><span class="n">nominals</span> <span class="n">big</span><span class="o">.</span><span class="n">nominals</span>
    <span class="n">term</span> <span class="o">=</span>
        <span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="n">k</span> <span class="n">v</span> <span class="n">s</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">v</span> <span class="o">=</span>
                <span class="k">match</span> <span class="n">v</span><span class="p">,</span> <span class="n">s</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">k</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">EModule</span> <span class="n">x</span><span class="p">,</span> <span class="n">Some</span> <span class="p">(</span><span class="n">EModule</span> <span class="n">x</span><span class="s1">') -&gt; Map.foldBack Map.add x x'</span> <span class="o">|&gt;</span> <span class="n">EModule</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">v</span>
            <span class="n">s</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">k</span> <span class="n">v</span>
        <span class="p">)</span> <span class="n">small</span><span class="o">.</span><span class="n">term</span> <span class="n">big</span><span class="o">.</span><span class="n">term</span>
    <span class="n">ty</span> <span class="o">=</span>
        <span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="n">k</span> <span class="n">v</span> <span class="n">s</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">v</span> <span class="o">=</span>
                <span class="k">match</span> <span class="n">v</span><span class="p">,</span> <span class="n">s</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">k</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">TModule</span> <span class="n">x</span><span class="p">,</span> <span class="n">Some</span> <span class="p">(</span><span class="n">TModule</span> <span class="n">x</span><span class="s1">') -&gt; Map.foldBack Map.add x x'</span> <span class="o">|&gt;</span> <span class="n">TModule</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">v</span>
            <span class="n">s</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">k</span> <span class="n">v</span>
        <span class="p">)</span> <span class="n">small</span><span class="o">.</span><span class="n">ty</span> <span class="n">big</span><span class="o">.</span><span class="n">ty</span>
    <span class="p">}</span>
    
<span class="n">let</span> <span class="n">in_modulePrepass</span> <span class="n">m</span> <span class="p">(</span><span class="n">a</span> <span class="p">:</span> <span class="n">PrepassTopEnv</span><span class="p">)</span> <span class="o">=</span>
    <span class="p">{</span><span class="n">a</span> <span class="k">with</span> 
        <span class="n">ty</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">m</span> <span class="p">(</span><span class="n">TModule</span> <span class="n">a</span><span class="o">.</span><span class="n">ty</span><span class="p">)</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
        <span class="n">term</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">m</span> <span class="p">(</span><span class="n">EModule</span> <span class="n">a</span><span class="o">.</span><span class="n">term</span><span class="p">)</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
        <span class="p">}</span>

<span class="nb">open</span> <span class="n">System</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">Generic</span>

<span class="nb">type</span> <span class="n">PropagatedVarsEnv</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span><span class="nb">vars</span> <span class="p">:</span> <span class="n">Set</span><span class="o">&lt;</span><span class="nb">int</span><span class="o">&gt;</span><span class="p">;</span> <span class="nb">range</span> <span class="p">:</span> <span class="p">(</span><span class="nb">int</span> <span class="o">*</span> <span class="nb">int</span><span class="p">)</span> <span class="n">option</span><span class="o">|</span><span class="p">}</span>
<span class="nb">type</span> <span class="n">PropagatedVars</span> <span class="o">=</span> <span class="p">{</span><span class="n">term</span> <span class="p">:</span> <span class="n">PropagatedVarsEnv</span><span class="p">;</span> <span class="n">ty</span> <span class="p">:</span> <span class="n">PropagatedVarsEnv</span><span class="p">}</span>

<span class="o">//</span> <span class="n">Attaches</span> <span class="n">scopes</span> <span class="n">to</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">nodes</span><span class="o">.</span>
<span class="n">let</span> <span class="n">propagate</span> <span class="n">x</span> <span class="o">=</span>
    <span class="n">let</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Reference</span><span class="p">)</span>
    <span class="n">let</span> <span class="p">(</span><span class="o">+*</span><span class="p">)</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> 
        <span class="k">match</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">Some</span><span class="p">(</span><span class="nb">min</span><span class="s1">',max'</span><span class="p">),</span> <span class="n">Some</span><span class="p">(</span><span class="nb">min</span><span class="s1">''</span><span class="p">,</span><span class="nb">max</span><span class="s1">''</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Some</span><span class="p">(</span><span class="nb">min</span> <span class="nb">min</span><span class="s1">' min'', max max'</span> <span class="nb">max</span><span class="s1">''</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">Some</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">),</span> <span class="n">_</span> <span class="o">|</span> <span class="n">_</span><span class="p">,</span> <span class="n">Some</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Some</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="kc">None</span>
    <span class="n">let</span> <span class="p">(</span><span class="o">+</span><span class="p">)</span> <span class="p">(</span><span class="n">a</span> <span class="p">:</span> <span class="n">PropagatedVars</span><span class="p">)</span> <span class="p">(</span><span class="n">b</span> <span class="p">:</span> <span class="n">PropagatedVars</span><span class="p">)</span> <span class="p">:</span> <span class="n">PropagatedVars</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">term</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span><span class="nb">vars</span> <span class="o">=</span> <span class="n">Set</span><span class="o">.</span><span class="n">union</span> <span class="n">a</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">vars</span> <span class="n">b</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">vars</span><span class="p">;</span> <span class="nb">range</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">range</span> <span class="o">+*</span> <span class="n">b</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">range</span> <span class="o">|</span><span class="p">}</span> 
        <span class="n">ty</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span><span class="nb">vars</span> <span class="o">=</span> <span class="n">Set</span><span class="o">.</span><span class="n">union</span> <span class="n">a</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="n">vars</span> <span class="n">b</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="n">vars</span><span class="p">;</span> <span class="nb">range</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="n">range</span> <span class="o">+*</span> <span class="n">b</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="n">range</span> <span class="o">|</span><span class="p">}</span> 
        <span class="p">}</span>
    <span class="n">let</span> <span class="p">(</span><span class="o">-*</span><span class="p">)</span> <span class="n">a</span> <span class="n">i</span> <span class="o">=</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="n">then</span> 
            <span class="k">match</span> <span class="n">a</span> <span class="k">with</span> 
            <span class="o">|</span> <span class="n">Some</span><span class="p">(</span><span class="nb">min</span><span class="s1">',max'</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Some</span><span class="p">(</span><span class="nb">min</span> <span class="nb">min</span><span class="s1">' i, max max'</span> <span class="n">i</span><span class="p">)</span>
            <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">Some</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">else</span> <span class="n">a</span> <span class="o">//</span> <span class="n">Recursive</span> <span class="nb">vars</span> <span class="n">are</span> <span class="n">negative</span> <span class="ow">and</span> <span class="n">get</span> <span class="n">inlined</span> <span class="n">so</span> <span class="n">they</span> <span class="n">should</span> <span class="n">be</span> <span class="n">ignored</span> <span class="n">when</span> <span class="n">calculating</span> <span class="n">the</span> <span class="nb">range</span> <span class="n">of</span> <span class="n">a</span> <span class="n">scope</span><span class="o">.</span>
    <span class="n">let</span> <span class="p">(</span><span class="o">-</span><span class="p">)</span> <span class="p">(</span><span class="n">a</span> <span class="p">:</span> <span class="n">PropagatedVars</span><span class="p">)</span> <span class="n">i</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span> <span class="k">with</span> <span class="n">term</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span><span class="nb">vars</span> <span class="o">=</span> <span class="n">Set</span><span class="o">.</span><span class="n">remove</span> <span class="n">i</span> <span class="n">a</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">vars</span><span class="p">;</span> <span class="nb">range</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">range</span> <span class="o">-*</span> <span class="n">i</span> <span class="o">|</span><span class="p">}</span> <span class="p">}</span>
    <span class="n">let</span> <span class="p">(</span><span class="o">-.</span><span class="p">)</span> <span class="p">(</span><span class="n">a</span> <span class="p">:</span> <span class="n">PropagatedVars</span><span class="p">)</span> <span class="n">i</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span> <span class="k">with</span> <span class="n">ty</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span><span class="nb">vars</span> <span class="o">=</span> <span class="n">Set</span><span class="o">.</span><span class="n">remove</span> <span class="n">i</span> <span class="n">a</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="n">vars</span><span class="p">;</span> <span class="nb">range</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="n">range</span> <span class="o">-*</span> <span class="n">i</span> <span class="o">|</span><span class="p">}</span> <span class="p">}</span>
    <span class="n">let</span> <span class="n">empty</span><span class="s1">' term ty = let f x = {|vars = x; range=None|} in {term = f term; ty = f ty}</span>
    <span class="n">let</span> <span class="n">empty</span> <span class="o">=</span> <span class="n">empty</span><span class="s1">' Set.empty Set.empty</span>
    <span class="n">let</span> <span class="n">singleton_term</span> <span class="n">i</span> <span class="o">=</span> <span class="n">empty</span><span class="s1">' (Set.singleton i) Set.empty</span>
    <span class="n">let</span> <span class="n">singleton_ty</span> <span class="n">i</span> <span class="o">=</span> <span class="n">empty</span><span class="s1">' Set.empty (Set.singleton i)</span>

    <span class="n">let</span> <span class="n">scope_dict</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="n">obj</span><span class="p">,</span><span class="n">_</span><span class="o">&gt;</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Reference</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">scope</span> <span class="n">x</span> <span class="p">(</span><span class="n">v</span> <span class="p">:</span> <span class="n">PropagatedVars</span><span class="p">)</span> <span class="o">=</span> <span class="n">scope_dict</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">v</span><span class="p">);</span> <span class="n">empty</span><span class="s1">' v.term.vars v.ty.vars</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">term</span> <span class="n">x</span> <span class="o">=</span>
        <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">EFun</span><span class="s1">' _ | EForall'</span> <span class="n">_</span> <span class="o">|</span> <span class="n">ERecursiveFun</span><span class="s1">' _ | ERecursiveForall'</span> <span class="n">_</span> <span class="o">|</span> <span class="n">ERecursive</span> <span class="n">_</span> <span class="o">|</span> <span class="n">EJoinPoint</span><span class="s1">' _ | EModule _ | ESymbol _ | ELit _ | EB _ -&gt; empty</span>
        <span class="o">|</span> <span class="n">EPatternRef</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">term</span> <span class="n">a</span><span class="o">.</span><span class="n">Value</span>
        <span class="o">|</span> <span class="n">EV</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">singleton_term</span> <span class="n">i</span>
        <span class="o">|</span> <span class="n">EPrototypeApply</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">EType</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">ETypePatternMiss</span> <span class="n">a</span> <span class="o">|</span> <span class="n">EDefaultLit</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ty</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">ESeq</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="n">EPair</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="n">EIfThen</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="n">EApply</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">term</span> <span class="n">a</span> <span class="o">+</span> <span class="n">term</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">EArray</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">s</span> <span class="o">+</span> <span class="n">term</span> <span class="n">x</span><span class="p">)</span> <span class="p">(</span><span class="n">ty</span> <span class="n">b</span><span class="p">)</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">ENominal</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="n">EAnnot</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="n">ETypeApply</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">term</span> <span class="n">a</span> <span class="o">+</span> <span class="n">ty</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">EForall</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">scope</span> <span class="n">x</span> <span class="p">(</span><span class="n">term</span> <span class="n">a</span> <span class="o">-.</span> <span class="n">i</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EJoinPoint</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">scope</span> <span class="n">x</span> <span class="p">(</span><span class="n">match</span> <span class="n">t</span> <span class="k">with</span> <span class="n">Some</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">term</span> <span class="n">a</span> <span class="o">+</span> <span class="n">ty</span> <span class="n">t</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">term</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EFun</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">scope</span> <span class="n">x</span> <span class="p">(</span><span class="n">match</span> <span class="n">t</span> <span class="k">with</span> <span class="n">Some</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">term</span> <span class="n">a</span> <span class="o">-</span> <span class="n">i</span> <span class="o">+</span> <span class="n">ty</span> <span class="n">t</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">term</span> <span class="n">a</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">ERecBlock</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">on_succ</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">body</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">s</span> <span class="o">+</span> <span class="n">term</span> <span class="n">body</span><span class="p">)</span> <span class="p">(</span><span class="n">term</span> <span class="n">on_succ</span><span class="p">)</span> <span class="n">l</span>
            <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="p">(</span><span class="nb">id</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">s</span> <span class="o">-</span> <span class="nb">id</span><span class="p">)</span> <span class="n">s</span> <span class="n">l</span>
        <span class="o">|</span> <span class="n">ERecordWith</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">fold</span> <span class="n">f</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="n">f</span> <span class="n">b</span> <span class="n">a</span>
            <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">s</span> <span class="o">+</span> <span class="n">term</span> <span class="n">a</span><span class="p">)</span> <span class="n">empty</span> <span class="n">a</span>
            <span class="o">|&gt;</span> <span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">function</span>
                    <span class="o">|</span> <span class="n">RSymbolModify</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">RSymbol</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">s</span> <span class="o">+</span> <span class="n">term</span> <span class="n">a</span>
                    <span class="o">|</span> <span class="n">RVar</span><span class="p">((</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="n">RVarModify</span><span class="p">((</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">s</span> <span class="o">+</span> <span class="n">term</span> <span class="n">a</span> <span class="o">+</span> <span class="n">term</span> <span class="n">b</span>
                    <span class="p">)</span> <span class="n">b</span>
            <span class="o">|&gt;</span> <span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">function</span>
                <span class="o">|</span> <span class="n">WSymbol</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">s</span>
                <span class="o">|</span> <span class="n">WVar</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">s</span> <span class="o">+</span> <span class="n">term</span> <span class="n">a</span>
                <span class="p">)</span> <span class="n">c</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">s</span> <span class="o">+</span> <span class="n">term</span> <span class="n">a</span><span class="p">)</span> <span class="n">empty</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">EMutableSet</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">term</span> <span class="n">a</span> <span class="o">+</span> <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">s</span> <span class="o">+</span> <span class="n">term</span> <span class="n">a</span><span class="p">)</span> <span class="n">empty</span> <span class="n">b</span> <span class="o">+</span> <span class="n">term</span> <span class="n">c</span>
        <span class="o">|</span> <span class="n">EIfThenElse</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">term</span> <span class="n">a</span> <span class="o">+</span> <span class="n">term</span> <span class="n">b</span> <span class="o">+</span> <span class="n">term</span> <span class="n">c</span>
        <span class="o">|</span> <span class="n">EExists</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">s</span> <span class="o">+</span> <span class="n">ty</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">term</span> <span class="n">b</span><span class="p">)</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">EPatternMiss</span> <span class="n">a</span> <span class="o">|</span> <span class="n">EReal</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">term</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">EMacro</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">function</span> <span class="n">MLitType</span> <span class="n">x</span> <span class="o">|</span> <span class="n">MType</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">s</span> <span class="o">+</span> <span class="n">ty</span> <span class="n">x</span> <span class="o">|</span> <span class="n">MTerm</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">s</span> <span class="o">+</span> <span class="n">term</span> <span class="n">x</span> <span class="o">|</span> <span class="n">MText</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="p">)</span> <span class="p">(</span><span class="n">ty</span> <span class="n">b</span><span class="p">)</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">EPatternMemo</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">memoize</span> <span class="nb">dict</span> <span class="n">term</span> <span class="n">a</span>
        <span class="o">//</span> <span class="n">Regular</span> <span class="n">pattern</span> <span class="n">matching</span>
        <span class="o">|</span> <span class="n">ELet</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">bind</span><span class="p">,</span><span class="n">body</span><span class="p">,</span><span class="n">on_succ</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">term</span> <span class="n">on_succ</span> <span class="o">-</span> <span class="n">bind</span> <span class="o">+</span> <span class="n">term</span> <span class="n">body</span>
        <span class="o">|</span> <span class="n">EUnbox</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">bind</span><span class="p">,</span><span class="n">body</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">term</span> <span class="n">on_succ</span> <span class="o">-</span> <span class="n">bind</span> <span class="o">+</span> <span class="n">term</span> <span class="n">body</span> <span class="o">+</span> <span class="n">term</span> <span class="n">on_fail</span>
        <span class="o">|</span> <span class="n">EExistsTest</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">bind</span><span class="p">,</span><span class="n">pat_type</span><span class="p">,</span><span class="n">pat</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">singleton_term</span> <span class="n">bind</span> <span class="o">+</span> <span class="p">(</span><span class="n">Array</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="o">-.</span><span class="p">)</span> <span class="p">(</span><span class="n">term</span> <span class="n">on_succ</span><span class="p">)</span> <span class="n">pat_type</span> <span class="o">-</span> <span class="n">pat</span><span class="p">)</span> <span class="o">+</span> <span class="n">term</span> <span class="n">on_fail</span>
        <span class="o">|</span> <span class="n">EPairTest</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">bind</span><span class="p">,</span><span class="n">pat1</span><span class="p">,</span><span class="n">pat2</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">singleton_term</span> <span class="n">bind</span> <span class="o">+</span> <span class="p">(</span><span class="n">term</span> <span class="n">on_succ</span> <span class="o">-</span> <span class="n">pat1</span> <span class="o">-</span> <span class="n">pat2</span><span class="p">)</span> <span class="o">+</span> <span class="n">term</span> <span class="n">on_fail</span>
        <span class="o">|</span> <span class="n">ESymbolTest</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">bind</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span> 
        <span class="o">|</span> <span class="n">EUnitTest</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">bind</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span> 
        <span class="o">|</span> <span class="n">ELitTest</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">bind</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">singleton_term</span> <span class="n">bind</span> <span class="o">+</span> <span class="n">term</span> <span class="n">on_succ</span> <span class="o">+</span> <span class="n">term</span> <span class="n">on_fail</span>
        <span class="o">|</span> <span class="n">ERecordTest</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">bind</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">on_succ_and_injects</span> <span class="o">=</span>
                <span class="n">let</span> <span class="n">on_succ</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="p">(</span><span class="n">Symbol</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">Var</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">s</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">term</span> <span class="n">on_succ</span><span class="p">)</span> <span class="n">a</span>
                <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">function</span> <span class="n">Var</span><span class="p">((</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">s</span> <span class="o">+</span> <span class="n">term</span> <span class="n">a</span> <span class="o">|</span> <span class="n">Symbol</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="p">)</span> <span class="n">on_succ</span> <span class="n">a</span> <span class="o">//</span> <span class="n">Though</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">less</span> <span class="n">efficient</span><span class="p">,</span> <span class="n">I</span> <span class="n">am</span> <span class="n">using</span> <span class="n">two</span> <span class="n">passes</span> <span class="n">here</span> <span class="n">to</span> <span class="n">guard</span> <span class="n">against</span> <span class="n">future</span> <span class="n">changes</span> <span class="n">to</span> <span class="n">pattern</span> <span class="n">compilation</span> <span class="n">breaking</span> <span class="n">this</span> <span class="n">part</span> <span class="n">by</span> <span class="n">accident</span><span class="o">.</span>
            <span class="n">singleton_term</span> <span class="n">bind</span> <span class="o">+</span> <span class="n">term</span> <span class="n">on_fail</span> <span class="o">+</span> <span class="n">on_succ_and_injects</span>
        <span class="o">|</span> <span class="n">EDefaultLitTest</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">bind</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EAnnotTest</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">bind</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">singleton_term</span> <span class="n">bind</span> <span class="o">+</span> <span class="n">ty</span> <span class="n">t</span> <span class="o">+</span> <span class="n">term</span> <span class="n">on_succ</span> <span class="o">+</span> <span class="n">term</span> <span class="n">on_fail</span>
        <span class="o">|</span> <span class="n">ENominalTest</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">bind</span><span class="p">,</span><span class="n">pat</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">singleton_term</span> <span class="n">bind</span> <span class="o">+</span> <span class="n">ty</span> <span class="n">t</span> <span class="o">+</span> <span class="p">(</span><span class="n">term</span> <span class="n">on_succ</span> <span class="o">-</span> <span class="n">pat</span><span class="p">)</span> <span class="o">+</span> <span class="n">term</span> <span class="n">on_fail</span>
        <span class="o">|</span> <span class="n">ETypecase</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> 
            <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> 
                <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">ty</span> <span class="n">a</span>
                <span class="n">let</span> <span class="n">mutable</span> <span class="n">b</span> <span class="o">=</span> <span class="n">term</span> <span class="n">b</span>
                <span class="k">match</span> <span class="n">a</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="n">range</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">Some</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">a</span><span class="s1">') -&gt; for i=a to a'</span> <span class="n">do</span> <span class="n">b</span> <span class="o">&lt;-</span> <span class="n">b</span> <span class="o">-.</span> <span class="n">i</span>
                <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="p">()</span>
                <span class="n">s</span> <span class="o">+</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
                <span class="p">)</span> <span class="p">(</span><span class="n">ty</span> <span class="n">a</span><span class="p">)</span> <span class="n">b</span>
    <span class="ow">and</span> <span class="n">ty</span> <span class="o">=</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">TExists</span> <span class="o">|</span> <span class="n">TJoinPoint</span><span class="s1">' _ | TForall'</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TArrow</span><span class="s1">' _ | TSymbol _ | TPrim _ | TNominal _ | TLit _ | TB _ -&gt; empty</span>
        <span class="o">|</span> <span class="n">TTypecase</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> 
            <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> 
                <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">ty</span> <span class="n">a</span>
                <span class="n">let</span> <span class="n">mutable</span> <span class="n">b</span> <span class="o">=</span> <span class="n">ty</span> <span class="n">b</span>
                <span class="k">match</span> <span class="n">a</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="n">range</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">Some</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">a</span><span class="s1">') -&gt; for i=a to a'</span> <span class="n">do</span> <span class="n">b</span> <span class="o">&lt;-</span> <span class="n">b</span> <span class="o">-.</span> <span class="n">i</span>
                <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="p">()</span>
                <span class="n">s</span> <span class="o">+</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
                <span class="p">)</span> <span class="p">(</span><span class="n">ty</span> <span class="n">a</span><span class="p">)</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">TPatternRef</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">ty</span> <span class="n">a</span><span class="o">.</span><span class="n">Value</span>
        <span class="o">|</span> <span class="n">TV</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">singleton_ty</span> <span class="n">i</span>
        <span class="o">|</span> <span class="n">TMetaV</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">empty</span> <span class="k">with</span> <span class="n">ty</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span><span class="n">empty</span><span class="o">.</span><span class="n">ty</span> <span class="k">with</span> <span class="nb">range</span> <span class="o">=</span> <span class="n">Some</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="o">|</span><span class="p">}</span> <span class="p">}</span>
        <span class="o">|</span> <span class="n">TApply</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="n">TPair</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="n">TFun</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ty</span> <span class="n">a</span> <span class="o">+</span> <span class="n">ty</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">TUnion</span><span class="p">(</span><span class="n">_</span><span class="p">,(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">k</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">s</span> <span class="o">+</span> <span class="n">ty</span> <span class="n">a</span> <span class="o">+</span> <span class="p">(</span><span class="n">Option</span><span class="o">.</span><span class="n">map</span> <span class="n">ty</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">Option</span><span class="o">.</span><span class="n">defaultValue</span> <span class="n">empty</span><span class="p">))</span> <span class="n">empty</span>
        <span class="o">|</span> <span class="n">TRecord</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">k</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">s</span> <span class="o">+</span> <span class="n">ty</span> <span class="n">v</span><span class="p">)</span> <span class="n">empty</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">TModule</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">k</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">s</span> <span class="o">+</span> <span class="n">ty</span> <span class="n">v</span><span class="p">)</span> <span class="n">empty</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">TTerm</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">term</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">TMacro</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">function</span> <span class="n">TMText</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">s</span> <span class="o">|</span> <span class="n">TMLitType</span> <span class="n">x</span> <span class="o">|</span> <span class="n">TMType</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">s</span> <span class="o">+</span> <span class="n">ty</span> <span class="n">x</span><span class="p">)</span> <span class="n">empty</span>
        <span class="o">|</span> <span class="n">TForall</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">TArrow</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="k">as</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">scope</span> <span class="n">x</span> <span class="p">(</span><span class="n">ty</span> <span class="n">a</span> <span class="o">-.</span> <span class="n">i</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TJoinPoint</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="k">as</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">scope</span> <span class="n">x</span> <span class="p">(</span><span class="n">ty</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TArray</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">TLayout</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ty</span> <span class="n">a</span>
    
    <span class="n">let</span> <span class="n">_</span> <span class="o">=</span> <span class="n">match</span> <span class="n">x</span> <span class="k">with</span> <span class="n">Choice1Of2</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">term</span> <span class="n">x</span> <span class="o">|</span> <span class="n">Choice2Of2</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">ty</span> <span class="n">x</span>
    <span class="n">scope_dict</span>

<span class="nb">type</span> <span class="n">ResolveEnvValue</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span><span class="n">term</span> <span class="p">:</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Id</span><span class="o">&gt;</span><span class="p">;</span> <span class="n">ty</span> <span class="p">:</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Id</span><span class="o">&gt;</span> <span class="o">|</span><span class="p">}</span>
<span class="nb">type</span> <span class="n">ResolveEnv</span> <span class="o">=</span> <span class="n">Map</span><span class="o">&lt;</span><span class="nb">int</span><span class="p">,</span> <span class="n">ResolveEnvValue</span><span class="o">&gt;</span>
<span class="n">let</span> <span class="n">resolve_recursive_free_vars</span> <span class="n">env</span> <span class="o">=</span>
    <span class="n">Map</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">env</span> <span class="p">:</span> <span class="n">ResolveEnv</span><span class="p">)</span> <span class="n">k</span> <span class="n">v</span> <span class="o">-&gt;</span>
        <span class="n">let</span> <span class="n">has_visited</span> <span class="o">=</span> <span class="n">HashSet</span><span class="p">()</span>
        <span class="n">let</span> <span class="n">rec</span> <span class="n">f</span> <span class="p">(</span><span class="n">s</span> <span class="p">:</span> <span class="n">ResolveEnvValue</span><span class="p">)</span> <span class="n">k</span> <span class="n">v</span> <span class="o">=</span> 
            <span class="k">if</span> <span class="n">has_visited</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="n">then</span> 
                <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">Set</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">k</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="n">then</span> <span class="n">f</span> <span class="n">s</span> <span class="n">k</span> <span class="n">env</span><span class="o">.</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">else</span> <span class="p">{</span><span class="o">|</span><span class="n">s</span> <span class="k">with</span> <span class="n">term</span> <span class="o">=</span> <span class="n">Set</span><span class="o">.</span><span class="n">add</span> <span class="n">k</span> <span class="n">s</span><span class="o">.</span><span class="n">term</span><span class="o">|</span><span class="p">})</span> <span class="n">s</span> <span class="n">v</span><span class="o">.</span><span class="n">term</span>
                <span class="n">Set</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">k</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="o">|</span><span class="n">s</span> <span class="k">with</span> <span class="n">ty</span> <span class="o">=</span> <span class="n">Set</span><span class="o">.</span><span class="n">add</span> <span class="n">k</span> <span class="n">s</span><span class="o">.</span><span class="n">ty</span><span class="o">|</span><span class="p">})</span> <span class="n">s</span> <span class="n">v</span><span class="o">.</span><span class="n">ty</span>
            <span class="k">else</span> <span class="n">s</span>
        <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">k</span> <span class="p">(</span><span class="n">f</span> <span class="p">{</span><span class="o">|</span><span class="n">term</span><span class="o">=</span><span class="n">Set</span><span class="o">.</span><span class="n">empty</span><span class="p">;</span> <span class="n">ty</span><span class="o">=</span><span class="n">Set</span><span class="o">.</span><span class="n">empty</span><span class="o">|</span><span class="p">}</span> <span class="n">k</span> <span class="n">v</span><span class="p">)</span> <span class="n">env</span>
        <span class="p">)</span> <span class="n">env</span> <span class="n">env</span>

<span class="n">let</span> <span class="n">resolve</span> <span class="p">(</span><span class="n">scope</span> <span class="p">:</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="n">obj</span><span class="p">,</span><span class="n">PropagatedVars</span><span class="o">&gt;</span><span class="p">)</span> <span class="n">x</span> <span class="o">=</span>
    <span class="n">let</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Reference</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">subst</span><span class="s1">' (env : ResolveEnv) (x : PropagatedVars) : PropagatedVars = </span>
        <span class="n">let</span> <span class="n">f</span> <span class="p">(</span><span class="n">s</span> <span class="p">:</span> <span class="n">ResolveEnvValue</span><span class="p">)</span> <span class="n">x</span> <span class="o">=</span> 
            <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="n">then</span> 
                <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">x</span> <span class="n">env</span> <span class="k">with</span> 
                <span class="o">|</span> <span class="n">Some</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="o">|</span><span class="n">term</span><span class="o">=</span><span class="n">Set</span><span class="o">.</span><span class="n">union</span> <span class="n">s</span><span class="o">.</span><span class="n">term</span> <span class="n">x</span><span class="o">.</span><span class="n">term</span><span class="p">;</span> <span class="n">ty</span><span class="o">=</span><span class="n">Set</span><span class="o">.</span><span class="n">union</span> <span class="n">s</span><span class="o">.</span><span class="n">ty</span> <span class="n">x</span><span class="o">.</span><span class="n">ty</span><span class="o">|</span><span class="p">}</span>
                <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="o">|</span><span class="n">s</span> <span class="k">with</span> <span class="n">term</span><span class="o">=</span><span class="n">Set</span><span class="o">.</span><span class="n">add</span> <span class="n">x</span> <span class="n">s</span><span class="o">.</span><span class="n">term</span><span class="o">|</span><span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span><span class="o">|</span><span class="n">s</span> <span class="k">with</span> <span class="n">term</span><span class="o">=</span><span class="n">Set</span><span class="o">.</span><span class="n">add</span> <span class="n">x</span> <span class="n">s</span><span class="o">.</span><span class="n">term</span><span class="o">|</span><span class="p">}</span>
        <span class="n">let</span> <span class="n">fv</span> <span class="o">=</span> <span class="n">Set</span><span class="o">.</span><span class="n">fold</span> <span class="n">f</span> <span class="p">{</span><span class="o">|</span><span class="n">term</span><span class="o">=</span><span class="n">Set</span><span class="o">.</span><span class="n">empty</span><span class="p">;</span> <span class="n">ty</span><span class="o">=</span><span class="n">Set</span><span class="o">.</span><span class="n">empty</span><span class="o">|</span><span class="p">}</span> <span class="n">x</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">vars</span>
        <span class="p">{</span><span class="n">term</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span><span class="n">x</span><span class="o">.</span><span class="n">term</span> <span class="k">with</span> <span class="nb">vars</span> <span class="o">=</span> <span class="n">fv</span><span class="o">.</span><span class="n">term</span><span class="o">|</span><span class="p">};</span> <span class="n">ty</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span><span class="n">x</span><span class="o">.</span><span class="n">ty</span> <span class="k">with</span> <span class="nb">vars</span> <span class="o">=</span> <span class="n">Set</span><span class="o">.</span><span class="n">union</span> <span class="n">fv</span><span class="o">.</span><span class="n">ty</span> <span class="n">x</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="n">vars</span><span class="o">|</span><span class="p">}</span> <span class="p">}</span>
    <span class="n">let</span> <span class="n">subst</span> <span class="n">env</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">obj</span><span class="p">)</span> <span class="o">=</span> <span class="n">match</span> <span class="n">scope</span><span class="o">.</span><span class="n">TryGetValue</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">with</span> <span class="n">true</span><span class="p">,</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">scope</span><span class="o">.</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">subst</span><span class="s1">' env v | _ -&gt; ()</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">term</span> <span class="p">(</span><span class="n">env</span> <span class="p">:</span> <span class="n">ResolveEnv</span><span class="p">)</span> <span class="n">x</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">f</span> <span class="o">=</span> <span class="n">term</span> <span class="n">env</span>
        <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">EForall</span><span class="s1">' _ | EFun'</span> <span class="n">_</span> <span class="o">|</span> <span class="n">ERecursiveForall</span><span class="s1">' _ | ERecursiveFun'</span> <span class="n">_</span> <span class="o">|</span> <span class="n">ERecursive</span> <span class="n">_</span> <span class="o">|</span> <span class="n">EJoinPoint</span><span class="s1">' _ | EModule _ | EV _ | ESymbol _ | ELit _ | EB _ -&gt; ()</span>
        <span class="o">|</span> <span class="n">EPatternRef</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span><span class="o">.</span><span class="n">Value</span>
        <span class="o">|</span> <span class="n">EDefaultLit</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">EPrototypeApply</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">EType</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">ETypePatternMiss</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">ty</span> <span class="n">env</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">EJoinPoint</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">EFun</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">subst</span> <span class="n">env</span> <span class="n">x</span><span class="p">;</span> <span class="n">f</span> <span class="n">a</span><span class="p">;</span> <span class="n">Option</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">ty</span> <span class="n">env</span><span class="p">)</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">EForall</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">subst</span> <span class="n">env</span> <span class="n">x</span><span class="p">;</span> <span class="n">f</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">ERecBlock</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="o">//</span> <span class="n">Goes</span> <span class="n">over</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">functions</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">recursive</span> <span class="n">block</span><span class="p">,</span> <span class="n">resolving</span> <span class="n">them</span><span class="o">.</span>
            <span class="o">//</span> <span class="n">The</span> <span class="n">reason</span> <span class="n">why</span> <span class="n">this</span> <span class="ow">is</span> <span class="n">sound</span> <span class="ow">is</span> <span class="n">because</span> <span class="n">the</span> <span class="n">outer</span> <span class="n">blocks</span> <span class="n">are</span> <span class="n">progressively</span> <span class="n">resolved</span> <span class="k">as</span> <span class="n">they</span> <span class="n">go</span> <span class="ow">in</span><span class="o">.</span>
            <span class="n">let</span> <span class="n">env</span> <span class="o">=</span> 
                <span class="n">let</span> <span class="n">l</span> <span class="o">=</span>
                    <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="p">(</span><span class="nb">id</span><span class="p">,</span><span class="n">body</span><span class="p">)</span> <span class="o">-&gt;</span>
                        <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">subst</span><span class="s1">' env scope.[body]</span>
                        <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="nb">id</span> <span class="p">{</span><span class="o">|</span><span class="n">term</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">vars</span><span class="p">;</span> <span class="n">ty</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="n">vars</span><span class="o">|</span><span class="p">}</span> <span class="n">s</span>
                        <span class="p">)</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span> <span class="n">a</span>
                    <span class="o">|&gt;</span> <span class="n">resolve_recursive_free_vars</span>
                <span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">l</span> <span class="n">env</span>
            <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="nb">id</span><span class="p">,</span><span class="n">body</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">scope</span><span class="o">.</span><span class="p">[</span><span class="n">body</span><span class="p">]</span> <span class="o">&lt;-</span> 
                    <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>
                    <span class="n">let</span> <span class="n">v</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="p">[</span><span class="n">body</span><span class="p">]</span>
                    <span class="p">{</span><span class="n">term</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">.</span><span class="n">term</span> <span class="k">with</span> <span class="nb">vars</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">term</span> <span class="o">|</span><span class="p">};</span> <span class="n">ty</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">.</span><span class="n">ty</span> <span class="k">with</span> <span class="nb">vars</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">ty</span><span class="o">|</span><span class="p">}</span> <span class="p">}</span>
                <span class="n">term</span> <span class="n">env</span> <span class="n">body</span>
                <span class="p">)</span>
            <span class="n">term</span> <span class="n">env</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">ERecordWith</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">snd</span> <span class="o">&gt;&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="n">a</span>
            <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">function</span>
                <span class="o">|</span> <span class="n">RSymbolModify</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">RSymbol</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span>
                <span class="o">|</span> <span class="n">RVarModify</span><span class="p">((</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="n">RVar</span><span class="p">((</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span><span class="p">;</span> <span class="n">f</span> <span class="n">b</span><span class="p">)</span>
            <span class="n">c</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">function</span> 
                <span class="o">|</span> <span class="n">WSymbol</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="p">()</span>
                <span class="o">|</span> <span class="n">WVar</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">ENominal</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="n">ETypeApply</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="n">EAnnot</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span><span class="p">;</span> <span class="n">ty</span> <span class="n">env</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="n">f</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">EExists</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">ty</span> <span class="n">env</span><span class="p">)</span> <span class="n">a</span><span class="p">;</span> <span class="n">f</span> <span class="n">b</span> 
        <span class="o">|</span> <span class="n">EPatternMiss</span> <span class="n">a</span> <span class="o">|</span> <span class="n">EReal</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">EArray</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="n">f</span> <span class="n">a</span><span class="p">;</span> <span class="n">ty</span> <span class="n">env</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">EExistsTest</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EUnitTest</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="n">ESymbolTest</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="n">EPairTest</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="n">ELitTest</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">ELet</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="n">EIfThen</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="n">EPair</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="n">ESeq</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="n">EApply</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span><span class="p">;</span> <span class="n">f</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">EMutableSet</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span><span class="p">;</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">snd</span> <span class="o">&gt;&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="n">b</span><span class="p">;</span> <span class="n">f</span> <span class="n">c</span>
        <span class="o">|</span> <span class="n">EUnbox</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">|</span> <span class="n">EIfThenElse</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span><span class="p">;</span> <span class="n">f</span> <span class="n">b</span><span class="p">;</span> <span class="n">f</span> <span class="n">c</span>
        <span class="o">|</span> <span class="n">EMacro</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">function</span> <span class="n">MLitType</span> <span class="n">a</span> <span class="o">|</span> <span class="n">MType</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">ty</span> <span class="n">env</span> <span class="n">a</span> <span class="o">|</span> <span class="n">MTerm</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span> <span class="o">|</span> <span class="n">MText</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="p">())</span>
            <span class="n">ty</span> <span class="n">env</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">EPatternMemo</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">memoize</span> <span class="nb">dict</span> <span class="n">f</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">ERecordTest</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> 
            <span class="n">l</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">function</span> <span class="n">Symbol</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="p">()</span> <span class="o">|</span> <span class="n">Var</span><span class="p">((</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span><span class="p">)</span>
            <span class="n">f</span> <span class="n">a</span><span class="p">;</span> <span class="n">f</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">EDefaultLitTest</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="n">ENominalTest</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="n">EAnnotTest</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ty</span> <span class="n">env</span> <span class="n">t</span><span class="p">;</span> <span class="n">f</span> <span class="n">a</span><span class="p">;</span> <span class="n">f</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">ETypecase</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ty</span> <span class="n">env</span> <span class="n">a</span><span class="p">;</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ty</span> <span class="n">env</span> <span class="n">a</span><span class="p">;</span> <span class="n">term</span> <span class="n">env</span> <span class="n">b</span><span class="p">)</span>

    <span class="ow">and</span> <span class="n">ty</span> <span class="p">(</span><span class="n">env</span> <span class="p">:</span> <span class="n">ResolveEnv</span><span class="p">)</span> <span class="n">x</span> <span class="o">=</span> 
        <span class="n">let</span> <span class="n">f</span> <span class="o">=</span> <span class="n">ty</span> <span class="n">env</span>
        <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">TExists</span> <span class="o">|</span> <span class="n">TJoinPoint</span><span class="s1">' _ | TForall'</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TArrow</span><span class="s1">' _ | TNominal _ | TPrim _ | TSymbol _ | TV _ | TMetaV _ | TLit _ | TB _ -&gt; ()</span>
        <span class="o">|</span> <span class="n">TTypecase</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ty</span> <span class="n">env</span> <span class="n">a</span><span class="p">;</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ty</span> <span class="n">env</span> <span class="n">a</span><span class="p">;</span> <span class="n">ty</span> <span class="n">env</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TPatternRef</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span><span class="o">.</span><span class="n">Value</span>
        <span class="o">|</span> <span class="n">TForall</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TArrow</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">subst</span> <span class="n">env</span> <span class="n">x</span><span class="p">;</span> <span class="n">f</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">TApply</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="n">TFun</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">TPair</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span><span class="p">;</span> <span class="n">f</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">TUnion</span><span class="p">(</span><span class="n">_</span><span class="p">,(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span><span class="p">;</span> <span class="n">Option</span><span class="o">.</span><span class="n">iter</span> <span class="n">f</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TRecord</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">TModule</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">TTerm</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">term</span> <span class="n">env</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">TMacro</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">function</span> <span class="n">TMText</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="p">()</span> <span class="o">|</span> <span class="n">TMLitType</span> <span class="n">a</span> <span class="o">|</span> <span class="n">TMType</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TJoinPoint</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">TLayout</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">TArray</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span>

    <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">Choice1Of2</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">term</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">Choice2Of2</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">ty</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span> <span class="n">x</span>

<span class="nb">type</span> <span class="n">LowerSubEnv</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span><span class="n">var</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="o">&gt;</span><span class="p">;</span> <span class="n">adj</span> <span class="p">:</span> <span class="nb">int</span><span class="o">|</span><span class="p">}</span>
<span class="nb">type</span> <span class="n">LowerEnv</span> <span class="o">=</span> <span class="p">{</span><span class="n">term</span> <span class="p">:</span> <span class="n">LowerSubEnv</span><span class="p">;</span> <span class="n">ty</span> <span class="p">:</span> <span class="n">LowerSubEnv</span> <span class="p">}</span>
<span class="nb">type</span> <span class="n">LowerEnvRec</span> <span class="o">=</span> <span class="n">Map</span><span class="o">&lt;</span><span class="nb">int</span><span class="p">,</span><span class="n">LowerEnv</span> <span class="o">-&gt;</span> <span class="n">E</span><span class="o">&gt;</span>
<span class="n">let</span> <span class="n">lower</span> <span class="p">(</span><span class="n">scope</span> <span class="p">:</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="n">obj</span><span class="p">,</span><span class="n">PropagatedVars</span><span class="o">&gt;</span><span class="p">)</span> <span class="n">x</span> <span class="o">=</span>
    <span class="n">let</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Reference</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">scope</span> <span class="p">(</span><span class="n">env</span> <span class="p">:</span> <span class="n">LowerEnv</span><span class="p">)</span> <span class="n">x</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">v</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
        <span class="n">let</span> <span class="n">fv</span> <span class="n">v</span> <span class="n">env</span> <span class="o">=</span> <span class="n">v</span> <span class="o">|&gt;</span> <span class="n">Set</span><span class="o">.</span><span class="n">toArray</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">find</span> <span class="n">i</span> <span class="n">env</span><span class="p">)</span>
        <span class="n">let</span> <span class="n">sz</span> <span class="o">=</span> <span class="n">function</span> <span class="n">Some</span><span class="p">(</span><span class="nb">min</span><span class="s1">',max'</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">max</span><span class="s1">' - min'</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="mi">0</span>
        <span class="n">let</span> <span class="n">scope</span> <span class="p">:</span> <span class="n">Scope</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">term</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span><span class="n">free_vars</span> <span class="o">=</span> <span class="n">fv</span> <span class="n">v</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">vars</span> <span class="n">env</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">var</span><span class="p">;</span> <span class="n">stack_size</span> <span class="o">=</span> <span class="n">sz</span> <span class="n">v</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">range</span><span class="o">|</span><span class="p">}</span>
            <span class="n">ty</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span><span class="n">free_vars</span> <span class="o">=</span> <span class="n">fv</span> <span class="n">v</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="n">vars</span> <span class="n">env</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="n">var</span><span class="p">;</span> <span class="n">stack_size</span> <span class="o">=</span> <span class="n">sz</span> <span class="n">v</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="n">range</span><span class="o">|</span><span class="p">}</span>
            <span class="p">}</span>

        <span class="n">let</span> <span class="nb">vars</span> <span class="n">v</span> <span class="o">=</span> <span class="n">Set</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">x</span> <span class="n">i</span> <span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="n">v</span> <span class="o">|&gt;</span> <span class="n">fst</span>
        <span class="n">let</span> <span class="n">adj</span> <span class="nb">len</span> <span class="o">=</span> <span class="n">function</span> <span class="n">Some</span><span class="p">(</span><span class="nb">min</span><span class="s1">',_) -&gt; len - min'</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="mi">0</span>
        <span class="n">let</span> <span class="n">env</span> <span class="p">:</span> <span class="n">LowerEnv</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">term</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span><span class="n">var</span> <span class="o">=</span> <span class="nb">vars</span> <span class="n">v</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">vars</span><span class="p">;</span> <span class="n">adj</span> <span class="o">=</span> <span class="n">adj</span> <span class="n">scope</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">free_vars</span><span class="o">.</span><span class="n">Length</span> <span class="n">v</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">range</span><span class="o">|</span><span class="p">}</span>
            <span class="n">ty</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span><span class="n">var</span> <span class="o">=</span> <span class="nb">vars</span> <span class="n">v</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="n">vars</span><span class="p">;</span> <span class="n">adj</span> <span class="o">=</span> <span class="n">adj</span> <span class="n">scope</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="n">free_vars</span><span class="o">.</span><span class="n">Length</span> <span class="n">v</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="n">range</span><span class="o">|</span><span class="p">}</span>
            <span class="p">}</span>

        <span class="n">scope</span><span class="p">,</span> <span class="n">env</span>

    <span class="n">let</span> <span class="n">adj_term</span> <span class="p">(</span><span class="n">env</span> <span class="p">:</span> <span class="n">LowerEnv</span><span class="p">)</span> <span class="n">i</span> <span class="o">=</span> 
        <span class="n">let</span> <span class="n">i</span><span class="s1">' = i + env.term.adj</span>
        <span class="n">i</span><span class="s1">', {env with term = {|env.term with var = Map.add i i'</span> <span class="n">env</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">var</span><span class="o">|</span><span class="p">}}</span>
    <span class="n">let</span> <span class="n">adj_ty</span> <span class="p">(</span><span class="n">env</span> <span class="p">:</span> <span class="n">LowerEnv</span><span class="p">)</span> <span class="n">i</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">i</span><span class="s1">' = i + env.ty.adj</span>
        <span class="n">i</span><span class="s1">', {env with ty = {|env.ty with var = Map.add i i'</span> <span class="n">env</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="n">var</span><span class="o">|</span><span class="p">}}</span>

    <span class="n">let</span> <span class="n">rec</span> <span class="n">term</span> <span class="p">(</span><span class="n">env_rec</span> <span class="p">:</span> <span class="n">LowerEnvRec</span><span class="p">)</span> <span class="p">(</span><span class="n">env</span> <span class="p">:</span> <span class="n">LowerEnv</span><span class="p">)</span> <span class="n">x</span> <span class="o">=</span> 
        <span class="n">let</span> <span class="n">f</span> <span class="o">=</span> <span class="n">term</span> <span class="n">env_rec</span> <span class="n">env</span>
        <span class="n">let</span> <span class="n">g</span> <span class="o">=</span> <span class="n">ty</span> <span class="n">env_rec</span>
        <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">EForall</span><span class="s1">' _ | EJoinPoint'</span> <span class="n">_</span> <span class="o">|</span> <span class="n">EFun</span><span class="s1">' _ | ERecursiveForall'</span> <span class="n">_</span> <span class="o">|</span> <span class="n">ERecursiveFun</span><span class="s1">' _ | ERecursive _ | EModule _ | ESymbol _ | ELit _ | EB _ -&gt; x</span>
        <span class="o">|</span> <span class="n">EPatternRef</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span><span class="o">.</span><span class="n">Value</span>
        <span class="o">|</span> <span class="n">EFun</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">pat</span><span class="p">,</span><span class="n">body</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="o">-&gt;</span> 
            <span class="n">let</span> <span class="n">scope</span><span class="p">,</span> <span class="n">env</span> <span class="o">=</span> <span class="n">scope</span> <span class="n">env</span> <span class="n">x</span> 
            <span class="n">let</span> <span class="n">pat</span><span class="p">,</span> <span class="n">env</span> <span class="o">=</span> <span class="n">adj_term</span> <span class="n">env</span> <span class="n">pat</span>
            <span class="k">assert</span> <span class="p">(</span><span class="n">scope</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">free_vars</span><span class="o">.</span><span class="n">Length</span> <span class="o">=</span> <span class="n">pat</span><span class="p">)</span>
            <span class="n">EFun</span><span class="s1">'(r,scope,pat,term env_rec env body,Option.map (g env) t)</span>
        <span class="o">|</span> <span class="n">EForall</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">pat</span><span class="p">,</span><span class="n">body</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">scope</span><span class="p">,</span> <span class="n">env</span> <span class="o">=</span> <span class="n">scope</span> <span class="n">env</span> <span class="n">x</span> 
            <span class="n">let</span> <span class="n">pat</span><span class="p">,</span> <span class="n">env</span> <span class="o">=</span> <span class="n">adj_ty</span> <span class="n">env</span> <span class="n">pat</span>
            <span class="k">assert</span> <span class="p">(</span><span class="n">scope</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="n">free_vars</span><span class="o">.</span><span class="n">Length</span> <span class="o">=</span> <span class="n">pat</span><span class="p">)</span>
            <span class="n">EForall</span><span class="s1">'(r,scope,pat,term env_rec env body)</span>
        <span class="o">|</span> <span class="n">EJoinPoint</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">body</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">name</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">scope</span><span class="p">,</span> <span class="n">env</span> <span class="o">=</span> <span class="n">scope</span> <span class="n">env</span> <span class="n">x</span> 
            <span class="n">EJoinPoint</span><span class="s1">'(r,scope,term env_rec env body,Option.map (g env) t,q,name)</span>
        <span class="o">|</span> <span class="n">EV</span> <span class="n">i</span> <span class="n">when</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">EV</span> <span class="n">env</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="o">|</span> <span class="n">EV</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">env_rec</span><span class="o">.</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="n">env</span>
        <span class="o">|</span> <span class="n">EDefaultLit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EDefaultLit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">g</span> <span class="n">env</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EType</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EType</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">g</span> <span class="n">env</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">ETypePatternMiss</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">ETypePatternMiss</span><span class="p">(</span><span class="n">g</span> <span class="n">env</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EApply</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EApply</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">ETypeApply</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ETypeApply</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">g</span> <span class="n">env</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">ENominal</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ENominal</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">g</span> <span class="n">env</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">ERecBlock</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">l</span><span class="p">,</span><span class="n">env_rec</span> <span class="o">=</span>
                <span class="n">List</span><span class="o">.</span><span class="n">mapFold</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">env_rec</span> <span class="p">:</span> <span class="n">LowerEnvRec</span><span class="p">)</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">body</span><span class="p">)</span> <span class="o">-&gt;</span>
                    <span class="n">let</span> <span class="n">re</span> <span class="o">=</span> <span class="n">ref</span> <span class="n">Unchecked</span><span class="o">.</span><span class="n">defaultof</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;</span>
                    <span class="n">let</span> <span class="nb">eval</span> <span class="n">env_rec</span> <span class="o">=</span> 
                        <span class="n">let</span> <span class="n">_</span><span class="p">,</span><span class="n">env</span> <span class="o">=</span> <span class="n">scope</span> <span class="n">env</span> <span class="n">body</span>
                        <span class="n">re</span><span class="o">.</span><span class="n">Value</span> <span class="o">&lt;-</span>
                            <span class="k">match</span> <span class="n">body</span> <span class="k">with</span>
                            <span class="o">|</span> <span class="n">EFun</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">body</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span>
                                <span class="n">let</span> <span class="n">_</span><span class="p">,</span><span class="n">env</span> <span class="o">=</span> <span class="n">adj_term</span> <span class="n">env</span> <span class="n">i</span>
                                <span class="n">term</span> <span class="n">env_rec</span> <span class="n">env</span> <span class="n">body</span>
                            <span class="o">|</span> <span class="n">EForall</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">body</span><span class="p">)</span> <span class="o">-&gt;</span> 
                                <span class="n">let</span> <span class="n">_</span><span class="p">,</span><span class="n">env</span> <span class="o">=</span> <span class="n">adj_ty</span> <span class="n">env</span> <span class="n">i</span>
                                <span class="n">term</span> <span class="n">env_rec</span> <span class="n">env</span> <span class="n">body</span>
                            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: Expected a fun or a forall."</span>
                    <span class="n">let</span> <span class="n">body</span> <span class="n">env</span> <span class="o">=</span>
                        <span class="n">let</span> <span class="n">scope</span><span class="p">,</span><span class="n">env</span> <span class="o">=</span> <span class="n">scope</span> <span class="n">env</span> <span class="n">body</span>
                        <span class="k">match</span> <span class="n">body</span> <span class="k">with</span>
                        <span class="o">|</span> <span class="n">EFun</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">d</span><span class="p">)</span> <span class="o">-&gt;</span> 
                            <span class="n">let</span> <span class="n">i</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">adj_term</span> <span class="n">env</span> <span class="n">i</span>
                            <span class="n">ERecursiveFun</span><span class="s1">'(r,scope,i,re,d)</span>
                        <span class="o">|</span> <span class="n">EForall</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> 
                            <span class="n">let</span> <span class="n">i</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">adj_ty</span> <span class="n">env</span> <span class="n">i</span>
                            <span class="n">ERecursiveForall</span><span class="s1">'(r,scope,i,re)</span>
                        <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: Expected a fun or a forall."</span>
                    <span class="nb">eval</span><span class="p">,</span><span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">i</span> <span class="n">body</span> <span class="n">env_rec</span>
                    <span class="p">)</span> <span class="n">env_rec</span> <span class="n">a</span>
            <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="nb">eval</span> <span class="o">-&gt;</span> <span class="nb">eval</span> <span class="n">env_rec</span><span class="p">)</span> <span class="n">l</span>
            <span class="n">term</span> <span class="n">env_rec</span> <span class="n">env</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">ERecordWith</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">r</span><span class="p">,</span> <span class="n">f</span> <span class="n">a</span><span class="p">)</span> <span class="n">a</span>
            <span class="n">let</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">function</span>
                <span class="o">|</span> <span class="n">RSymbol</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RSymbol</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">RSymbolModify</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RSymbolModify</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">RVar</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RVar</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">),</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">RVarModify</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RVarModify</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">),</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">let</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">function</span>
                <span class="o">|</span> <span class="n">WSymbol</span> <span class="n">_</span> <span class="k">as</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span>
                <span class="o">|</span> <span class="n">WVar</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WVar</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">ERecordWith</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EOp</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="n">f</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EAnnot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EAnnot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">g</span> <span class="n">env</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EIfThenElse</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EIfThenElse</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">,</span><span class="n">f</span> <span class="n">c</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EIfThen</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EIfThen</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EArray</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EArray</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="n">f</span> <span class="n">a</span><span class="p">,</span> <span class="n">g</span> <span class="n">env</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EPair</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EPair</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">ESeq</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ESeq</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EMutableSet</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EMutableSet</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="p">,</span> <span class="n">f</span> <span class="n">b</span><span class="p">)</span> <span class="n">b</span><span class="p">,</span><span class="n">f</span> <span class="n">c</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EPatternMiss</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">EPatternMiss</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EReal</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EReal</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EExists</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EExists</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">g</span> <span class="n">env</span><span class="p">)</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EMacro</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> 
            <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">function</span>
                <span class="o">|</span> <span class="n">MText</span> <span class="n">_</span> <span class="k">as</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span>
                <span class="o">|</span> <span class="n">MLitType</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">MLitType</span><span class="p">(</span><span class="n">g</span> <span class="n">env</span> <span class="n">a</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">MType</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">MType</span><span class="p">(</span><span class="n">g</span> <span class="n">env</span> <span class="n">a</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">MTerm</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">MTerm</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">EMacro</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">g</span> <span class="n">env</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EPrototypeApply</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EPrototypeApply</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">g</span> <span class="n">env</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EPatternMemo</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">memoize</span> <span class="nb">dict</span> <span class="n">f</span> <span class="n">x</span>
        <span class="o">//</span> <span class="n">Regular</span> <span class="n">pattern</span> <span class="n">matching</span>
        <span class="o">|</span> <span class="n">ELet</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">pat</span><span class="p">,</span><span class="n">body</span><span class="p">,</span><span class="n">on_succ</span><span class="p">)</span> <span class="o">-&gt;</span> 
            <span class="n">let</span> <span class="n">body</span> <span class="o">=</span> <span class="n">term</span> <span class="n">env_rec</span> <span class="n">env</span> <span class="n">body</span>
            <span class="n">let</span> <span class="n">pat</span><span class="p">,</span><span class="n">env</span> <span class="o">=</span> <span class="n">adj_term</span> <span class="n">env</span> <span class="n">pat</span>
            <span class="n">let</span> <span class="n">on_succ</span> <span class="o">=</span> <span class="n">term</span> <span class="n">env_rec</span> <span class="n">env</span> <span class="n">on_succ</span>
            <span class="n">ELet</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">pat</span><span class="p">,</span><span class="n">body</span><span class="p">,</span><span class="n">on_succ</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EUnbox</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">pat</span><span class="p">,</span><span class="n">body</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">body</span> <span class="o">=</span> <span class="n">term</span> <span class="n">env_rec</span> <span class="n">env</span> <span class="n">body</span>
            <span class="n">let</span> <span class="n">on_fail</span> <span class="o">=</span> <span class="n">term</span> <span class="n">env_rec</span> <span class="n">env</span> <span class="n">on_fail</span>
            <span class="n">let</span> <span class="n">pat</span><span class="p">,</span><span class="n">env</span> <span class="o">=</span> <span class="n">adj_term</span> <span class="n">env</span> <span class="n">pat</span>
            <span class="n">let</span> <span class="n">on_succ</span> <span class="o">=</span> <span class="n">term</span> <span class="n">env_rec</span> <span class="n">env</span> <span class="n">on_succ</span>
            <span class="n">EUnbox</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">pat</span><span class="p">,</span><span class="n">body</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EPairTest</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">pat1</span><span class="p">,</span><span class="n">pat2</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span> <span class="o">-&gt;</span> 
            <span class="n">let</span> <span class="n">on_fail</span> <span class="o">=</span> <span class="n">term</span> <span class="n">env_rec</span> <span class="n">env</span> <span class="n">on_fail</span>
            <span class="n">let</span> <span class="n">i</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">let</span> <span class="n">pat1</span><span class="p">,</span><span class="n">env</span> <span class="o">=</span> <span class="n">adj_term</span> <span class="n">env</span> <span class="n">pat1</span>
            <span class="n">let</span> <span class="n">pat2</span><span class="p">,</span><span class="n">env</span> <span class="o">=</span> <span class="n">adj_term</span> <span class="n">env</span> <span class="n">pat2</span>
            <span class="n">let</span> <span class="n">on_succ</span> <span class="o">=</span> <span class="n">term</span> <span class="n">env_rec</span> <span class="n">env</span> <span class="n">on_succ</span>
            <span class="n">EPairTest</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">pat1</span><span class="p">,</span><span class="n">pat2</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EExistsTest</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">pat_type</span><span class="p">,</span><span class="n">pat</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span> <span class="o">-&gt;</span> 
            <span class="n">let</span> <span class="n">on_fail</span> <span class="o">=</span> <span class="n">term</span> <span class="n">env_rec</span> <span class="n">env</span> <span class="n">on_fail</span>
            <span class="n">let</span> <span class="n">i</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">let</span> <span class="n">pat</span><span class="p">,</span><span class="n">env</span> <span class="o">=</span> <span class="n">adj_term</span> <span class="n">env</span> <span class="n">pat</span>
            <span class="n">let</span> <span class="n">pat_type</span><span class="p">,</span><span class="n">env</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">mapFold</span> <span class="n">adj_ty</span> <span class="n">env</span> <span class="n">pat_type</span>
            <span class="n">let</span> <span class="n">on_succ</span> <span class="o">=</span> <span class="n">term</span> <span class="n">env_rec</span> <span class="n">env</span> <span class="n">on_succ</span>
            <span class="n">EExistsTest</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">pat_type</span><span class="p">,</span><span class="n">pat</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">ESymbolTest</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span> <span class="o">-&gt;</span> 
            <span class="n">let</span> <span class="n">on_fail</span> <span class="o">=</span> <span class="n">term</span> <span class="n">env_rec</span> <span class="n">env</span> <span class="n">on_fail</span>
            <span class="n">let</span> <span class="n">i</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">let</span> <span class="n">on_succ</span> <span class="o">=</span> <span class="n">term</span> <span class="n">env_rec</span> <span class="n">env</span> <span class="n">on_succ</span>
            <span class="n">ESymbolTest</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">ERecordTest</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">on_fail</span> <span class="o">=</span> <span class="n">term</span> <span class="n">env_rec</span> <span class="n">env</span> <span class="n">on_fail</span>
            <span class="n">let</span> <span class="n">b</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">let</span> <span class="n">a</span><span class="p">,</span> <span class="n">env</span> <span class="o">=</span> 
                <span class="n">List</span><span class="o">.</span><span class="n">mapFold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">env</span> <span class="n">x</span> <span class="o">-&gt;</span>
                    <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">Symbol</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">b</span><span class="p">,</span><span class="n">env</span> <span class="o">=</span> <span class="n">adj_term</span> <span class="n">env</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">Symbol</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">),</span> <span class="n">env</span>
                    <span class="o">|</span> <span class="n">Var</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">b</span><span class="p">,</span><span class="n">env</span> <span class="o">=</span> <span class="n">adj_term</span> <span class="n">env</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">Var</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">),</span> <span class="n">env</span>
                    <span class="p">)</span> <span class="n">env</span> <span class="n">a</span>
            <span class="n">ERecordTest</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">term</span> <span class="n">env_rec</span> <span class="n">env</span> <span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EAnnotTest</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EAnnotTest</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">g</span> <span class="n">env</span> <span class="n">a</span><span class="p">,</span><span class="n">env</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">f</span> <span class="n">on_succ</span><span class="p">,</span><span class="n">f</span> <span class="n">on_fail</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">ELitTest</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ELitTest</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">env</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">f</span> <span class="n">on_succ</span><span class="p">,</span><span class="n">f</span> <span class="n">on_fail</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EUnitTest</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EUnitTest</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">env</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">f</span> <span class="n">on_succ</span><span class="p">,</span><span class="n">f</span> <span class="n">on_fail</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">ENominalTest</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">pat</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">on_fail</span> <span class="o">=</span> <span class="n">term</span> <span class="n">env_rec</span> <span class="n">env</span> <span class="n">on_fail</span>
            <span class="n">let</span> <span class="n">i</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">let</span> <span class="n">pat</span><span class="p">,</span> <span class="n">env</span> <span class="o">=</span> <span class="n">adj_term</span> <span class="n">env</span> <span class="n">pat</span>
            <span class="n">let</span> <span class="n">on_succ</span> <span class="o">=</span> <span class="n">term</span> <span class="n">env_rec</span> <span class="n">env</span> <span class="n">on_succ</span>
            <span class="n">ENominalTest</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">g</span> <span class="n">env</span> <span class="n">a</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">pat</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EDefaultLitTest</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EDefaultLitTest</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">g</span> <span class="n">env</span> <span class="n">b</span><span class="p">,</span><span class="n">env</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">f</span> <span class="n">on_succ</span><span class="p">,</span><span class="n">f</span> <span class="n">on_fail</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">ETypecase</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> 
            <span class="n">let</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> 
                <span class="n">let</span> <span class="n">metavars</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">()</span>
                <span class="n">let</span> <span class="n">mutable</span> <span class="n">env_case</span> <span class="o">=</span> <span class="n">env</span>
                <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> 
                    <span class="n">ty</span><span class="s1">' (memoize metavars (fun i -&gt;</span>
                        <span class="n">let</span> <span class="n">i</span><span class="p">,</span> <span class="n">env</span> <span class="o">=</span> <span class="n">adj_ty</span> <span class="n">env_case</span> <span class="n">i</span>
                        <span class="n">env_case</span> <span class="o">&lt;-</span> <span class="n">env</span>
                        <span class="n">TMetaV</span> <span class="n">i</span>
                        <span class="p">))</span> <span class="n">env_rec</span> <span class="n">env_case</span> <span class="n">a</span>
                <span class="n">a</span><span class="p">,</span> <span class="n">term</span> <span class="n">env_rec</span> <span class="n">env_case</span> <span class="n">b</span>
                <span class="p">)</span>
            <span class="n">ETypecase</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">g</span> <span class="n">env</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
    <span class="ow">and</span> <span class="n">ty</span> <span class="n">env_rec</span> <span class="n">env</span> <span class="n">x</span> <span class="o">=</span> <span class="n">ty</span><span class="s1">' (fun _ -&gt; failwith "Compiler error: TMetaV should not appear here.") env_rec env x</span>
    <span class="ow">and</span> <span class="n">ty</span><span class="s1">' case_tmetav env_rec env x =</span>
        <span class="n">let</span> <span class="n">f</span> <span class="o">=</span> <span class="n">ty</span><span class="s1">' case_tmetav env_rec env</span>
        <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">TMetaV</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">case_tmetav</span> <span class="n">i</span>
        <span class="o">|</span> <span class="n">TExists</span> <span class="o">|</span> <span class="n">TJoinPoint</span><span class="s1">' _ | TForall'</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TArrow</span><span class="s1">' _ | TNominal  _ | TPrim _ | TSymbol _ | TLit _ | TB _ as x -&gt; x</span>
        <span class="o">|</span> <span class="n">TTypecase</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> 
            <span class="n">let</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> 
                <span class="n">let</span> <span class="n">metavars</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">()</span>
                <span class="n">let</span> <span class="n">mutable</span> <span class="n">env_case</span> <span class="o">=</span> <span class="n">env</span>
                <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> 
                    <span class="n">ty</span><span class="s1">' (memoize metavars (fun i -&gt;</span>
                        <span class="n">let</span> <span class="n">i</span><span class="p">,</span> <span class="n">env</span> <span class="o">=</span> <span class="n">adj_ty</span> <span class="n">env_case</span> <span class="n">i</span>
                        <span class="n">env_case</span> <span class="o">&lt;-</span> <span class="n">env</span>
                        <span class="n">TMetaV</span> <span class="n">i</span>
                        <span class="p">))</span> <span class="n">env_rec</span> <span class="n">env_case</span> <span class="n">a</span>
                <span class="n">a</span><span class="p">,</span> <span class="n">ty</span> <span class="n">env_rec</span> <span class="n">env_case</span> <span class="n">b</span>
                <span class="p">)</span>
            <span class="n">TTypecase</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">ty</span> <span class="n">env_rec</span> <span class="n">env</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TPatternRef</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span><span class="o">.</span><span class="n">Value</span>
        <span class="o">|</span> <span class="n">TJoinPoint</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="k">as</span> <span class="n">x</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">scope</span><span class="p">,</span> <span class="n">env</span> <span class="o">=</span> <span class="n">scope</span> <span class="n">env</span> <span class="n">x</span>
            <span class="n">TJoinPoint</span><span class="s1">'(r,scope,ty env_rec env a)</span>
        <span class="o">|</span> <span class="n">TForall</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="k">as</span> <span class="n">x</span> <span class="o">-&gt;</span>  
            <span class="n">let</span> <span class="n">scope</span><span class="p">,</span> <span class="n">env</span> <span class="o">=</span> <span class="n">scope</span> <span class="n">env</span> <span class="n">x</span>
            <span class="n">let</span> <span class="n">a</span><span class="p">,</span> <span class="n">env</span> <span class="o">=</span> <span class="n">adj_ty</span> <span class="n">env</span> <span class="n">a</span>
            <span class="n">TForall</span><span class="s1">'(r,scope,a,ty env_rec env b)</span>
        <span class="o">|</span> <span class="n">TArrow</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="k">as</span> <span class="n">x</span> <span class="o">-&gt;</span>  
            <span class="n">let</span> <span class="n">scope</span><span class="p">,</span> <span class="n">env</span> <span class="o">=</span> <span class="n">scope</span> <span class="n">env</span> <span class="n">x</span>
            <span class="n">let</span> <span class="n">a</span><span class="p">,</span> <span class="n">env</span> <span class="o">=</span> <span class="n">adj_ty</span> <span class="n">env</span> <span class="n">a</span>
            <span class="n">TArrow</span><span class="s1">'(scope,a,ty env_rec env b)</span>
        <span class="o">|</span> <span class="n">TV</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">TV</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="o">|</span> <span class="n">TPair</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TPair</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TFun</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TFun</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TRecord</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TRecord</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">Map</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TModule</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">TModule</span><span class="p">(</span><span class="n">Map</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TUnion</span><span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">TUnion</span><span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">Map</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span><span class="p">,</span> <span class="n">Option</span><span class="o">.</span><span class="n">map</span> <span class="n">f</span> <span class="n">b</span><span class="p">)</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span>
        <span class="o">|</span> <span class="n">TApply</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TApply</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TTerm</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TTerm</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">term</span> <span class="n">env_rec</span> <span class="n">env</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TMacro</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">function</span> 
                <span class="o">|</span> <span class="n">TMText</span> <span class="n">_</span> <span class="k">as</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span>
                <span class="o">|</span> <span class="n">TMType</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">TMType</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">TMLitType</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">TMLitType</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">TMacro</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TArray</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TArray</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TLayout</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TLayout</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">env</span> <span class="p">:</span> <span class="n">LowerEnv</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">term</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span><span class="n">var</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">;</span> <span class="n">adj</span> <span class="o">=</span> <span class="mi">0</span><span class="o">|</span><span class="p">}</span>
        <span class="n">ty</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span><span class="n">var</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">;</span> <span class="n">adj</span> <span class="o">=</span> <span class="mi">0</span><span class="o">|</span><span class="p">}</span>
        <span class="p">}</span>
    <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">Choice1Of2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">ret</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ret</span> <span class="p">(</span><span class="n">term</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span> <span class="n">env</span> <span class="n">x</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">Choice2Of2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">ret</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ret</span> <span class="p">(</span><span class="n">ty</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span> <span class="n">env</span> <span class="n">x</span><span class="p">)</span>

<span class="nb">type</span> <span class="n">Env___</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">term</span> <span class="p">:</span> <span class="p">{</span><span class="o">|</span> <span class="n">env</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="n">E</span><span class="o">&gt;</span><span class="p">;</span> <span class="n">i</span> <span class="p">:</span> <span class="n">Id</span><span class="p">;</span> <span class="n">i_rec</span> <span class="p">:</span> <span class="n">Id</span> <span class="o">|</span><span class="p">}</span>
    <span class="n">ty</span> <span class="p">:</span> <span class="p">{</span><span class="o">|</span> <span class="n">env</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="n">TPrepass</span><span class="o">&gt;</span><span class="p">;</span> <span class="n">i</span> <span class="p">:</span> <span class="n">Id</span> <span class="o">|</span><span class="p">}</span>
    <span class="p">}</span>
<span class="nb">type</span> <span class="n">PartEvalPrepassEnv</span> <span class="o">=</span> <span class="n">Env___</span>

<span class="n">let</span> <span class="n">add_term</span> <span class="p">(</span><span class="n">e</span> <span class="p">:</span> <span class="n">PartEvalPrepassEnv</span><span class="p">)</span> <span class="n">k</span> <span class="n">v</span> <span class="o">=</span> <span class="n">let</span> <span class="n">term</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">term</span> <span class="ow">in</span> <span class="p">{</span><span class="n">e</span> <span class="k">with</span> <span class="n">term</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span><span class="n">term</span> <span class="k">with</span> <span class="n">i</span> <span class="o">=</span> <span class="n">term</span><span class="o">.</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">env</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">k</span> <span class="n">v</span> <span class="n">term</span><span class="o">.</span><span class="n">env</span><span class="o">|</span><span class="p">}</span> <span class="p">}</span>
<span class="n">let</span> <span class="n">add_term_rec</span> <span class="p">(</span><span class="n">e</span> <span class="p">:</span> <span class="n">PartEvalPrepassEnv</span><span class="p">)</span> <span class="n">k</span> <span class="n">v</span> <span class="o">=</span> <span class="n">let</span> <span class="n">term</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">term</span> <span class="ow">in</span> <span class="p">{</span><span class="n">e</span> <span class="k">with</span> <span class="n">term</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span><span class="n">term</span> <span class="k">with</span> <span class="n">i_rec</span> <span class="o">=</span> <span class="n">term</span><span class="o">.</span><span class="n">i_rec</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">env</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">k</span> <span class="n">v</span> <span class="n">term</span><span class="o">.</span><span class="n">env</span><span class="o">|</span><span class="p">}</span> <span class="p">}</span>
<span class="n">let</span> <span class="n">add_ty</span> <span class="p">(</span><span class="n">e</span> <span class="p">:</span> <span class="n">PartEvalPrepassEnv</span><span class="p">)</span> <span class="n">k</span> <span class="n">v</span> <span class="o">=</span> <span class="n">let</span> <span class="n">ty</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">ty</span> <span class="ow">in</span> <span class="p">{</span><span class="n">e</span> <span class="k">with</span> <span class="n">ty</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span><span class="n">ty</span> <span class="k">with</span> <span class="n">i</span> <span class="o">=</span> <span class="n">ty</span><span class="o">.</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">env</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">k</span> <span class="n">v</span> <span class="n">ty</span><span class="o">.</span><span class="n">env</span><span class="o">|</span><span class="p">}</span> <span class="p">}</span>
<span class="n">let</span> <span class="n">add_wildcard</span> <span class="p">(</span><span class="n">e</span> <span class="p">:</span> <span class="n">PartEvalPrepassEnv</span><span class="p">)</span> <span class="o">=</span> <span class="n">let</span> <span class="n">ty</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">ty</span> <span class="ow">in</span> <span class="p">{</span><span class="n">e</span> <span class="k">with</span> <span class="n">ty</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span><span class="n">ty</span> <span class="k">with</span> <span class="n">i</span> <span class="o">=</span> <span class="n">ty</span><span class="o">.</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">|</span><span class="p">}</span> <span class="p">}</span>

<span class="n">let</span> <span class="n">add_term_var</span> <span class="p">(</span><span class="n">e</span> <span class="p">:</span> <span class="n">PartEvalPrepassEnv</span><span class="p">)</span> <span class="n">k</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">i</span><span class="p">,</span> <span class="n">add_term</span> <span class="n">e</span> <span class="n">k</span> <span class="p">(</span><span class="n">EV</span> <span class="n">e</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
<span class="n">let</span> <span class="n">fresh_term_var</span> <span class="p">(</span><span class="n">e</span> <span class="p">:</span> <span class="n">PartEvalPrepassEnv</span><span class="p">)</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">let</span> <span class="n">term</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">term</span> <span class="ow">in</span> <span class="p">{</span><span class="n">e</span> <span class="k">with</span> <span class="n">term</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span><span class="n">term</span> <span class="k">with</span> <span class="n">i</span> <span class="o">=</span> <span class="n">term</span><span class="o">.</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">|</span><span class="p">}</span> <span class="p">})</span>
<span class="n">let</span> <span class="n">fresh_ty_var</span> <span class="p">(</span><span class="n">e</span> <span class="p">:</span> <span class="n">PartEvalPrepassEnv</span><span class="p">)</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">let</span> <span class="n">ty</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">ty</span> <span class="ow">in</span> <span class="p">{</span><span class="n">e</span> <span class="k">with</span> <span class="n">ty</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span><span class="n">ty</span> <span class="k">with</span> <span class="n">i</span> <span class="o">=</span> <span class="n">ty</span><span class="o">.</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">|</span><span class="p">}</span> <span class="p">})</span>
<span class="n">let</span> <span class="n">add_term_rec_var</span> <span class="p">(</span><span class="n">e</span> <span class="p">:</span> <span class="n">PartEvalPrepassEnv</span><span class="p">)</span> <span class="n">k</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">i_rec</span><span class="p">,</span> <span class="n">add_term_rec</span> <span class="n">e</span> <span class="n">k</span> <span class="p">(</span><span class="n">EV</span> <span class="n">e</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">i_rec</span><span class="p">)</span>
<span class="n">let</span> <span class="n">add_ty_var</span> <span class="p">(</span><span class="n">e</span> <span class="p">:</span> <span class="n">PartEvalPrepassEnv</span><span class="p">)</span> <span class="n">k</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="n">i</span><span class="p">,</span> <span class="n">add_ty</span> <span class="n">e</span> <span class="n">k</span> <span class="p">(</span><span class="n">TV</span> <span class="n">e</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="n">i</span><span class="p">)</span>
<span class="n">let</span> <span class="n">add_ty_wildcard</span> <span class="p">(</span><span class="n">e</span> <span class="p">:</span> <span class="n">PartEvalPrepassEnv</span><span class="p">)</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="n">i</span><span class="p">,</span> <span class="n">add_wildcard</span> <span class="n">e</span>

<span class="n">let</span> <span class="n">process_term</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">E</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">scope</span> <span class="o">=</span> <span class="n">propagate</span> <span class="p">(</span><span class="n">Choice1Of2</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">resolve</span> <span class="n">scope</span> <span class="p">(</span><span class="n">Choice1Of2</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">lower</span> <span class="n">scope</span> <span class="p">(</span><span class="n">Choice1Of2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="nb">id</span><span class="p">))</span>

<span class="n">let</span> <span class="n">process_ty</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">TPrepass</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">scope</span> <span class="o">=</span> <span class="n">propagate</span> <span class="p">(</span><span class="n">Choice2Of2</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">resolve</span> <span class="n">scope</span> <span class="p">(</span><span class="n">Choice2Of2</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">lower</span> <span class="n">scope</span> <span class="p">(</span><span class="n">Choice2Of2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="nb">id</span><span class="p">))</span>

<span class="n">let</span> <span class="n">module_openPrepass</span> <span class="p">(</span><span class="n">top_env</span> <span class="p">:</span> <span class="n">PrepassTopEnv</span><span class="p">)</span> <span class="n">env</span> <span class="n">a</span> <span class="n">l</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> 
        <span class="k">match</span> <span class="n">top_env</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="p">[</span><span class="n">snd</span> <span class="n">a</span><span class="p">],</span> <span class="n">top_env</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="p">[</span><span class="n">snd</span> <span class="n">a</span><span class="p">]</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">EModule</span> <span class="n">a</span><span class="p">,</span> <span class="n">TModule</span> <span class="n">b</span> <span class="o">-&gt;</span>
            <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">find</span> <span class="n">x</span> <span class="n">a</span><span class="p">,</span> <span class="n">Map</span><span class="o">.</span><span class="n">find</span> <span class="n">x</span> <span class="n">b</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">EModule</span> <span class="n">a</span><span class="p">,</span> <span class="n">TModule</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: Module open's symbol index should have been validated."</span>
                <span class="p">)</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="n">l</span>
        <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: Module open should have been validated."</span>
    <span class="p">{</span>
    <span class="n">term</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span><span class="n">env</span><span class="o">.</span><span class="n">term</span> <span class="k">with</span> <span class="n">env</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">a</span> <span class="n">env</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">env</span><span class="o">|</span><span class="p">}</span>
    <span class="n">ty</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span><span class="n">env</span><span class="o">.</span><span class="n">ty</span> <span class="k">with</span> <span class="n">env</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">b</span> <span class="n">env</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="n">env</span><span class="o">|</span><span class="p">}</span>
    <span class="p">}</span>

<span class="n">let</span> <span class="n">prepassPrepass</span> <span class="n">package_id</span> <span class="n">module_id</span> <span class="n">path</span> <span class="p">(</span><span class="n">top_env</span> <span class="p">:</span> <span class="n">PrepassTopEnv</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">p</span> <span class="n">r</span> <span class="o">=</span> <span class="p">{</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">;</span> <span class="nb">range</span><span class="o">=</span><span class="n">r</span><span class="p">}</span>
    <span class="n">let</span> <span class="n">at_tag</span> <span class="n">i</span> <span class="o">=</span> <span class="p">{</span> <span class="n">package_id</span> <span class="o">=</span> <span class="n">package_id</span><span class="p">;</span> <span class="n">module_id</span> <span class="o">=</span> <span class="n">module_id</span><span class="p">;</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">i</span> <span class="p">}</span>
    <span class="n">let</span> <span class="n">v_term</span> <span class="p">(</span><span class="n">env</span> <span class="p">:</span> <span class="n">PartEvalPrepassEnv</span><span class="p">)</span> <span class="n">x</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">x</span> <span class="n">env</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">env</span> <span class="o">|&gt;</span> <span class="n">Option</span><span class="o">.</span><span class="n">defaultWith</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="n">top_env</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
    <span class="n">let</span> <span class="n">v_ty</span> <span class="p">(</span><span class="n">env</span> <span class="p">:</span> <span class="n">PartEvalPrepassEnv</span><span class="p">)</span> <span class="n">x</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">x</span> <span class="n">env</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="n">env</span> <span class="o">|&gt;</span> <span class="n">Option</span><span class="o">.</span><span class="n">defaultWith</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="n">top_env</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
    
    <span class="o">//</span> <span class="n">The</span> <span class="n">functions</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">block</span> <span class="n">are</span> <span class="n">basically</span> <span class="n">renaming</span> <span class="n">string</span> <span class="nb">id</span> <span class="n">to</span> <span class="nb">int</span> <span class="n">ids</span><span class="p">,</span> <span class="ow">in</span> <span class="n">addition</span> <span class="n">to</span> <span class="n">pattern</span> <span class="n">compilation</span><span class="o">.</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">compile_pattern</span> <span class="p">(</span><span class="nb">id</span> <span class="p">:</span> <span class="n">Id</span><span class="p">)</span> <span class="p">(</span><span class="n">env</span> <span class="p">:</span> <span class="n">PartEvalPrepassEnv</span><span class="p">)</span> <span class="p">(</span><span class="n">clauses</span> <span class="p">:</span> <span class="p">(</span><span class="n">Pattern</span> <span class="o">*</span> <span class="n">RawExpr</span><span class="p">)</span> <span class="nb">list</span><span class="p">)</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">mutable</span> <span class="n">term_var_count</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">i</span>
        <span class="n">let</span> <span class="n">mutable</span> <span class="n">ty_var_count</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="n">i</span>
        <span class="n">let</span> <span class="n">patvar</span> <span class="p">()</span> <span class="o">=</span> <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">term_var_count</span> <span class="ow">in</span> <span class="n">term_var_count</span> <span class="o">&lt;-</span> <span class="n">term_var_count</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">x</span>
        <span class="n">let</span> <span class="n">ty_patvar</span> <span class="p">()</span> <span class="o">=</span> <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">ty_var_count</span> <span class="ow">in</span> <span class="n">ty_var_count</span> <span class="o">&lt;-</span> <span class="n">ty_var_count</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">x</span>
        <span class="n">let</span> <span class="n">loop</span> <span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="n">on_succ</span><span class="p">)</span> <span class="n">on_fail</span> <span class="o">=</span>
            <span class="n">let</span> <span class="n">mutable</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
            <span class="n">let</span> <span class="n">mutable</span> <span class="n">dict_type</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
            <span class="n">let</span> <span class="n">pat_refs_term</span> <span class="o">=</span> <span class="n">ResizeArray</span><span class="p">()</span>
            <span class="o">//</span><span class="n">let</span> <span class="n">pat_ref_term</span> <span class="n">x</span> <span class="o">=</span> <span class="n">let</span> <span class="n">re</span> <span class="o">=</span> <span class="n">ref</span> <span class="n">Unchecked</span><span class="o">.</span><span class="n">defaultof</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="n">pat_refs_term</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="nb">dict</span><span class="p">,</span><span class="n">re</span><span class="p">);</span> <span class="n">EPatternRef</span> <span class="n">re</span>
            <span class="n">let</span> <span class="n">pat_ref_term</span><span class="s1">' x k =</span>
                <span class="n">let</span> <span class="n">re</span> <span class="o">=</span> <span class="n">ref</span> <span class="n">Unchecked</span><span class="o">.</span><span class="n">defaultof</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;</span>
                <span class="n">let</span> <span class="n">r</span> <span class="o">=</span> <span class="n">k</span> <span class="p">(</span><span class="n">EPatternRef</span> <span class="n">re</span><span class="p">)</span>
                <span class="n">pat_refs_term</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">x</span><span class="p">,(</span><span class="nb">dict</span><span class="p">,</span><span class="n">dict_type</span><span class="p">),</span><span class="n">re</span><span class="p">)</span>
                <span class="n">r</span>
            <span class="n">let</span> <span class="n">pat_refs_ty</span> <span class="o">=</span> <span class="n">ResizeArray</span><span class="p">()</span>
            <span class="n">let</span> <span class="n">pat_ref_ty</span> <span class="n">x</span> <span class="o">=</span> <span class="n">let</span> <span class="n">re</span> <span class="o">=</span> <span class="n">ref</span> <span class="n">Unchecked</span><span class="o">.</span><span class="n">defaultof</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="n">pat_refs_ty</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">x</span><span class="p">,(</span><span class="nb">dict</span><span class="p">,</span><span class="n">dict_type</span><span class="p">),</span><span class="n">re</span><span class="p">);</span> <span class="n">TPatternRef</span> <span class="n">re</span>
            <span class="n">let</span> <span class="n">rec</span> <span class="n">cp</span> <span class="nb">id</span> <span class="n">pat</span> <span class="n">on_succ</span> <span class="n">on_fail</span> <span class="o">=</span>
                <span class="n">let</span> <span class="n">v</span> <span class="n">x</span> <span class="o">=</span>
                    <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">x</span> <span class="nb">dict</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">Some</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span>
                    <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">v</span> <span class="o">=</span> <span class="n">patvar</span><span class="p">()</span> <span class="ow">in</span> <span class="nb">dict</span> <span class="o">&lt;-</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">x</span> <span class="n">v</span> <span class="nb">dict</span><span class="p">;</span> <span class="n">v</span>
                <span class="n">let</span> <span class="n">tv</span> <span class="n">x</span> <span class="o">=</span>
                    <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">x</span> <span class="n">dict_type</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">Some</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span>
                    <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">v</span> <span class="o">=</span> <span class="n">ty_patvar</span><span class="p">()</span> <span class="ow">in</span> <span class="n">dict_type</span> <span class="o">&lt;-</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">x</span> <span class="n">v</span> <span class="n">dict_type</span><span class="p">;</span> <span class="n">v</span>
                <span class="n">let</span> <span class="n">step</span> <span class="n">pat</span> <span class="n">on_succ</span> <span class="o">=</span>
                    <span class="k">match</span> <span class="n">pat</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">PatVar</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">v</span> <span class="n">x</span><span class="p">,</span> <span class="n">on_succ</span>
                    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="nb">id</span> <span class="o">=</span> <span class="n">patvar</span><span class="p">()</span> <span class="ow">in</span> <span class="nb">id</span><span class="p">,</span> <span class="n">cp</span> <span class="nb">id</span> <span class="n">pat</span> <span class="n">on_succ</span> <span class="n">on_fail</span>
                <span class="k">match</span> <span class="n">pat</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">PatDefaultValue</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: The default value should be filled."</span>
                <span class="o">|</span> <span class="n">PatE</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">on_succ</span>
                <span class="o">|</span> <span class="n">PatB</span> <span class="n">r</span> <span class="o">-&gt;</span> <span class="n">EUnitTest</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="nb">id</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">PatVar</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ELet</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">v</span> <span class="n">a</span><span class="p">,</span><span class="n">EV</span> <span class="nb">id</span><span class="p">,</span><span class="n">on_succ</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">PatAnnot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EAnnotTest</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">pat_ref_ty</span> <span class="n">b</span><span class="p">,</span><span class="nb">id</span><span class="p">,</span><span class="n">cp</span> <span class="nb">id</span> <span class="n">a</span> <span class="n">on_succ</span> <span class="n">on_fail</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">PatPair</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> 
                    <span class="o">//</span> <span class="n">Evaling</span> <span class="n">the</span> <span class="n">b</span> <span class="n">then</span> <span class="n">a</span> <span class="n">causes</span> <span class="n">the</span> <span class="n">call</span> <span class="n">args</span> <span class="n">to</span> <span class="n">be</span> <span class="n">rotated</span> <span class="ow">in</span> <span class="n">join</span> <span class="n">points</span> <span class="n">during</span> <span class="n">peval</span><span class="o">.</span> 
                    <span class="o">//</span> <span class="n">This</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">a</span> <span class="n">problem</span><span class="p">,</span> <span class="n">but</span> <span class="n">it</span> <span class="n">might</span> <span class="n">be</span> <span class="n">surprising</span> <span class="k">if</span> <span class="n">you</span> <span class="n">aren</span><span class="s1">'t aware why that is happening.</span>
                    <span class="o">//</span> <span class="n">Swapping</span> <span class="n">the</span> <span class="nb">next</span> <span class="n">two</span> <span class="n">statements</span> <span class="n">would</span> <span class="n">fix</span> <span class="n">it</span> <span class="k">for</span> <span class="n">pairs</span><span class="o">.</span>
                    <span class="n">let</span> <span class="n">b</span><span class="p">,</span><span class="n">on_succ</span> <span class="o">=</span> <span class="n">step</span> <span class="n">b</span> <span class="n">on_succ</span>
                    <span class="n">let</span> <span class="n">a</span><span class="p">,</span><span class="n">on_succ</span> <span class="o">=</span> <span class="n">step</span> <span class="n">a</span> <span class="n">on_succ</span>
                    <span class="n">EPairTest</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="nb">id</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">PatExists</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> 
                    <span class="n">let</span> <span class="n">pat_type</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">snd</span> <span class="o">&gt;&gt;</span> <span class="n">tv</span><span class="p">)</span> <span class="n">l</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">toArray</span>
                    <span class="n">let</span> <span class="n">pat</span><span class="p">,</span><span class="n">on_succ</span> <span class="o">=</span> <span class="n">step</span> <span class="n">b</span> <span class="n">on_succ</span>
                    <span class="n">EExistsTest</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="nb">id</span><span class="p">,</span><span class="n">pat_type</span><span class="p">,</span><span class="n">pat</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">PatArray</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span>
                    <span class="n">let</span> <span class="n">r</span> <span class="o">=</span> <span class="n">p</span> <span class="n">r</span>
                    <span class="n">let</span> <span class="n">ar_ids</span><span class="p">,</span><span class="n">on_succ</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">mapFoldBack</span> <span class="n">step</span> <span class="n">a</span> <span class="n">on_succ</span>
                    <span class="n">let</span> <span class="n">a_length</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">length</span> <span class="n">a</span>
                    <span class="n">let</span> <span class="n">on_succ</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> 
                        <span class="n">List</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="nb">id</span><span class="s1">' (on_succ,i) -&gt; </span>
                            <span class="n">ELet</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="nb">id</span><span class="s1">',EOp(r,ArrayIndex,[EV id; ELit(r,LitInt32 i)]),on_succ), i-1</span>
                            <span class="p">)</span> <span class="n">ar_ids</span> <span class="p">(</span><span class="n">on_succ</span><span class="p">,</span> <span class="n">a_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">let</span> <span class="n">id_length</span> <span class="o">=</span> <span class="n">EOp</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">ArrayLength</span><span class="p">,[</span><span class="n">EType</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">TPrim</span> <span class="n">UInt64T</span><span class="p">);</span> <span class="n">EV</span> <span class="nb">id</span><span class="p">])</span>
                    <span class="n">let</span> <span class="n">pat_length</span> <span class="o">=</span> <span class="n">ELit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">LitUInt64</span><span class="p">(</span><span class="n">uint64</span> <span class="n">a_length</span><span class="p">))</span>
                    <span class="n">EIfThenElse</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">EOp</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">EQ</span><span class="p">,[</span><span class="n">id_length</span><span class="p">;</span><span class="n">pat_length</span><span class="p">]),</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">PatSymbol</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ESymbolTest</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="nb">id</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">PatRecordMembers</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">items</span><span class="p">)</span> <span class="o">-&gt;</span>
                    <span class="n">let</span> <span class="n">inject_vars</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Reference</span><span class="p">)</span>
                    <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">function</span>
                        <span class="o">|</span> <span class="n">PatRecordMembersSymbol</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="p">()</span>
                        <span class="o">|</span> <span class="n">PatRecordMembersInjectVar</span><span class="p">((</span><span class="n">_</span><span class="p">,</span><span class="n">var</span><span class="p">),</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> 
                            <span class="k">match</span> <span class="nb">dict</span><span class="o">.</span><span class="n">TryGetValue</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="k">with</span>
                            <span class="o">|</span> <span class="n">true</span><span class="p">,</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">inject_vars</span><span class="o">.</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">EV</span> <span class="n">x</span>
                            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">inject_vars</span><span class="o">.</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">v_term</span> <span class="n">env</span> <span class="n">var</span>
                        <span class="p">)</span> <span class="n">items</span>
                    <span class="n">let</span> <span class="n">binds</span><span class="p">,</span> <span class="n">on_succ</span> <span class="o">=</span>
                        <span class="n">List</span><span class="o">.</span><span class="n">mapFoldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="n">item</span> <span class="n">on_succ</span> <span class="o">-&gt;</span>
                            <span class="k">match</span> <span class="n">item</span> <span class="k">with</span>
                            <span class="o">|</span> <span class="n">PatRecordMembersSymbol</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">keyword</span><span class="p">),</span><span class="n">name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">arg</span><span class="p">,</span> <span class="n">on_succ</span> <span class="o">=</span> <span class="n">step</span> <span class="n">name</span> <span class="n">on_succ</span> <span class="ow">in</span> <span class="n">Symbol</span><span class="p">((</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">keyword</span><span class="p">),</span><span class="n">arg</span><span class="p">),</span> <span class="n">on_succ</span>
                            <span class="o">|</span> <span class="n">PatRecordMembersInjectVar</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">var</span><span class="p">),</span><span class="n">name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">arg</span><span class="p">,</span> <span class="n">on_succ</span> <span class="o">=</span> <span class="n">step</span> <span class="n">name</span> <span class="n">on_succ</span> <span class="ow">in</span> <span class="n">Var</span><span class="p">((</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">inject_vars</span><span class="o">.</span><span class="p">[</span><span class="n">var</span><span class="p">]),</span><span class="n">arg</span><span class="p">),</span> <span class="n">on_succ</span>
                            <span class="p">)</span> <span class="n">items</span> <span class="n">on_succ</span>
                    <span class="n">ERecordTest</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">binds</span><span class="p">,</span><span class="nb">id</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">PatOr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">on_succ</span> <span class="o">=</span> <span class="n">EPatternMemo</span> <span class="n">on_succ</span> <span class="ow">in</span> <span class="n">cp</span> <span class="nb">id</span> <span class="n">a</span> <span class="n">on_succ</span> <span class="p">(</span><span class="n">cp</span> <span class="nb">id</span> <span class="n">b</span> <span class="n">on_succ</span> <span class="n">on_fail</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">PatAnd</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">on_fail</span> <span class="o">=</span> <span class="n">EPatternMemo</span> <span class="n">on_fail</span> <span class="ow">in</span> <span class="n">cp</span> <span class="nb">id</span> <span class="n">a</span> <span class="p">(</span><span class="n">cp</span> <span class="nb">id</span> <span class="n">b</span> <span class="n">on_succ</span> <span class="n">on_fail</span><span class="p">)</span> <span class="n">on_fail</span>
                <span class="o">|</span> <span class="n">PatValue</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ELitTest</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="nb">id</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">PatWhen</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">p</span><span class="s1">',e) -&gt; pat_ref_term'</span> <span class="n">e</span> <span class="p">(</span><span class="n">fun</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">cp</span> <span class="nb">id</span> <span class="n">p</span><span class="s1">' (EIfThenElse(p r, e, on_succ, on_fail)) on_fail)</span>
                <span class="o">|</span> <span class="n">PatNominal</span><span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">l</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> 
                    <span class="n">let</span> <span class="nb">id</span><span class="s1">', on_succ = step b on_succ</span>
                    <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="p">(</span><span class="sa">r</span><span class="s1">',x) -&gt; TApply(p (r +. r'</span><span class="p">),</span><span class="n">s</span><span class="p">,</span><span class="n">TSymbol</span><span class="p">(</span><span class="n">p</span> <span class="sa">r</span><span class="s1">',x))) (v_ty env a) l</span>
                    <span class="n">ENominalTest</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="nb">id</span><span class="p">,</span><span class="nb">id</span><span class="s1">',on_succ,on_fail)</span>
                <span class="o">|</span> <span class="n">PatFilledDefaultValue</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EDefaultLitTest</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">pat_ref_ty</span> <span class="n">b</span><span class="p">,</span><span class="nb">id</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">PatDyn</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="nb">id</span><span class="s1">' = patvar() in ELet(p r,id'</span><span class="p">,</span><span class="n">EOp</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">Dyn</span><span class="p">,[</span><span class="n">EV</span> <span class="nb">id</span><span class="p">]),</span><span class="n">cp</span> <span class="nb">id</span><span class="s1">' a on_succ on_fail)</span>
                <span class="o">|</span> <span class="n">PatUnbox</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="nb">id</span><span class="s1">' = patvar() in EUnbox(p r,q,id'</span><span class="p">,</span><span class="n">EV</span> <span class="nb">id</span><span class="p">,</span><span class="n">cp</span> <span class="nb">id</span><span class="s1">' a on_succ on_fail,on_fail)</span>
            <span class="p">(</span><span class="n">pat_refs_term</span><span class="p">,</span> <span class="n">pat_refs_ty</span><span class="p">),</span> <span class="n">pat_ref_term</span><span class="s1">' on_succ (fun on_succ -&gt; cp id pat on_succ (EPatternMemo on_fail))</span>

        <span class="n">let</span> <span class="n">l</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">mapFoldBack</span> <span class="n">loop</span> <span class="n">clauses</span> <span class="p">(</span><span class="n">EPatternMiss</span><span class="p">(</span><span class="n">EV</span> <span class="nb">id</span><span class="p">))</span>
        <span class="n">l</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">terms</span><span class="p">,</span><span class="n">tys</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="o">//</span> <span class="n">The</span> <span class="n">reason</span> <span class="n">I</span> <span class="n">am</span> <span class="ow">not</span> <span class="n">evaling</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">place</span> <span class="ow">is</span> <span class="n">because</span> <span class="n">of</span> <span class="n">the</span> <span class="n">var</span> <span class="n">count</span> <span class="n">which</span> <span class="ow">is</span> <span class="n">mutable</span><span class="o">.</span> <span class="n">I</span> <span class="n">need</span> <span class="n">to</span> <span class="n">deal</span> <span class="k">with</span> <span class="n">the</span> <span class="n">patterns</span> <span class="n">first</span> <span class="n">before</span> <span class="n">replacing</span> <span class="n">the</span> <span class="n">strings</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">body</span><span class="o">.</span>
            <span class="n">let</span> <span class="n">env</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span><span class="n">dict_type</span><span class="p">)</span> <span class="o">=</span> 
                <span class="p">{</span><span class="n">env</span> <span class="k">with</span> 
                    <span class="n">term</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span><span class="n">env</span><span class="o">.</span><span class="n">term</span> <span class="k">with</span> <span class="n">i</span><span class="o">=</span><span class="n">term_var_count</span><span class="p">;</span> <span class="n">env</span><span class="o">=</span><span class="nb">dict</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">k</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">k</span> <span class="p">(</span><span class="n">EV</span> <span class="n">v</span><span class="p">)</span> <span class="n">s</span><span class="p">)</span> <span class="n">env</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">env</span><span class="o">|</span><span class="p">}</span> 
                    <span class="n">ty</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span><span class="n">env</span><span class="o">.</span><span class="n">ty</span> <span class="k">with</span> <span class="n">i</span><span class="o">=</span><span class="n">ty_var_count</span><span class="p">;</span> <span class="n">env</span><span class="o">=</span><span class="n">dict_type</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">k</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">k</span> <span class="p">(</span><span class="n">TV</span> <span class="n">v</span><span class="p">)</span> <span class="n">s</span><span class="p">)</span> <span class="n">env</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="n">env</span><span class="o">|</span><span class="p">}</span> 
                    <span class="p">}</span>
            <span class="n">terms</span> <span class="o">|&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="nb">dict</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">b</span><span class="o">.</span><span class="n">Value</span> <span class="o">&lt;-</span> <span class="n">term</span> <span class="p">(</span><span class="n">env</span> <span class="nb">dict</span><span class="p">)</span> <span class="n">a</span><span class="p">)</span>
            <span class="n">tys</span> <span class="o">|&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="nb">dict</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">b</span><span class="o">.</span><span class="n">Value</span> <span class="o">&lt;-</span> <span class="n">ty</span> <span class="p">(</span><span class="n">env</span> <span class="nb">dict</span><span class="p">)</span> <span class="n">a</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">e</span>
    <span class="ow">and</span> <span class="n">pattern_match</span> <span class="p">(</span><span class="n">env</span> <span class="p">:</span> <span class="n">PartEvalPrepassEnv</span><span class="p">)</span> <span class="n">r</span> <span class="n">body</span> <span class="n">clauses</span> <span class="o">=</span>
        <span class="k">match</span> <span class="n">clauses</span> <span class="k">with</span>
        <span class="o">|</span> <span class="p">[</span><span class="n">PatVar</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">),</span> <span class="n">on_succ</span><span class="p">]</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="nb">id</span><span class="p">,</span><span class="n">env</span> <span class="o">=</span> <span class="n">add_term_var</span> <span class="n">env</span> <span class="n">x</span>
            <span class="n">ELet</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="nb">id</span><span class="p">,</span><span class="n">body</span><span class="p">,</span><span class="n">term</span> <span class="n">env</span> <span class="n">on_succ</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="nb">id</span><span class="p">,</span><span class="n">env</span> <span class="o">=</span> <span class="n">fresh_term_var</span> <span class="n">env</span>
            <span class="n">ELet</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="nb">id</span><span class="p">,</span><span class="n">body</span><span class="p">,</span><span class="n">compile_pattern</span> <span class="nb">id</span> <span class="n">env</span> <span class="n">clauses</span><span class="p">)</span>
    <span class="ow">and</span> <span class="n">pattern_function</span> <span class="n">env</span> <span class="n">r</span> <span class="n">clauses</span> <span class="n">annot</span> <span class="o">=</span>
        <span class="k">match</span> <span class="n">clauses</span> <span class="k">with</span>
        <span class="o">|</span> <span class="p">[</span><span class="n">PatVar</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">),</span> <span class="n">on_succ</span><span class="p">]</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="nb">id</span><span class="p">,</span><span class="n">env</span> <span class="o">=</span> <span class="n">add_term_var</span> <span class="n">env</span> <span class="n">x</span>
            <span class="n">EFun</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="nb">id</span><span class="p">,</span><span class="n">term</span> <span class="n">env</span> <span class="n">on_succ</span><span class="p">,</span><span class="n">annot</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="nb">id</span><span class="p">,</span><span class="n">env</span> <span class="o">=</span> <span class="n">fresh_term_var</span> <span class="n">env</span>
            <span class="n">EFun</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="nb">id</span><span class="p">,</span><span class="n">compile_pattern</span> <span class="nb">id</span> <span class="n">env</span> <span class="n">clauses</span><span class="p">,</span><span class="n">annot</span><span class="p">)</span>
    <span class="ow">and</span> <span class="n">ty</span> <span class="n">env</span> <span class="n">x</span> <span class="o">=</span> <span class="n">ty</span><span class="s1">' (fun _ -&gt; failwith "Compiler error: RawTMetaVar should not appear here.") env x</span>
    <span class="ow">and</span> <span class="n">ty</span><span class="s1">' case_metavar (env : PartEvalPrepassEnv) x =</span>
        <span class="n">let</span> <span class="n">f</span> <span class="o">=</span> <span class="n">ty</span><span class="s1">' case_metavar env</span>
        <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">RawTMetaVar</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">case_metavar</span> <span class="p">(</span><span class="n">Some</span> <span class="n">name</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawTWildcard</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">case_metavar</span> <span class="kc">None</span>
        <span class="o">|</span> <span class="n">RawTForall</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="nb">id</span><span class="p">,</span> <span class="n">env</span> <span class="o">=</span> <span class="n">add_ty_var</span> <span class="n">env</span> <span class="p">(</span><span class="n">typevar_name</span> <span class="n">a</span><span class="p">)</span>
            <span class="n">TForall</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="nb">id</span><span class="p">,</span><span class="n">ty</span><span class="s1">' case_metavar env b)</span>
        <span class="o">|</span> <span class="n">RawTB</span> <span class="n">r</span> <span class="o">-&gt;</span> <span class="n">TB</span> <span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawTLit</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TLit</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawTVar</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">v_ty</span> <span class="n">env</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">RawTPair</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TPair</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawTFun</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TFun</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawTExists</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TExists</span>
        <span class="o">|</span> <span class="n">RawTRecord</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">l</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TRecord</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">Map</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="n">l</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawTUnion</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">this</span><span class="p">)</span> <span class="o">-&gt;</span> 
            <span class="n">let</span> <span class="n">rec</span> <span class="n">subst_vars_with_metavars</span> <span class="nb">vars</span> <span class="n">a</span> <span class="o">=</span>
                <span class="n">let</span> <span class="n">f</span> <span class="o">=</span> <span class="n">subst_vars_with_metavars</span> <span class="nb">vars</span>
                <span class="k">match</span> <span class="n">a</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">RawTTypecase</span> <span class="n">_</span> <span class="o">|</span> <span class="n">RawTUnion</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: Not expecting typecase or union here."</span>
                <span class="o">|</span> <span class="n">RawTVar</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">List</span><span class="o">.</span><span class="n">contains</span> <span class="n">n</span> <span class="nb">vars</span> <span class="n">then</span> <span class="n">RawTMetaVar</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="k">else</span> <span class="n">a</span>
                <span class="o">|</span> <span class="n">RawTPrim</span> <span class="n">_</span> <span class="o">|</span> <span class="n">RawTFilledNominal</span> <span class="n">_</span> <span class="o">|</span> <span class="n">RawTTerm</span> <span class="n">_</span> <span class="o">|</span> <span class="n">RawTSymbol</span> <span class="n">_</span> <span class="o">|</span> <span class="n">RawTLit</span> <span class="n">_</span> <span class="o">|</span> <span class="n">RawTMetaVar</span> <span class="n">_</span> <span class="o">|</span> <span class="n">RawTB</span> <span class="n">_</span> <span class="o">|</span> <span class="n">RawTWildcard</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">a</span>
                <span class="o">|</span> <span class="n">RawTPair</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawTPair</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">RawTFun</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawTFun</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">RawTArray</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawTArray</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">RawTRecord</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawTRecord</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">Map</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="n">a</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">RawTApply</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawTApply</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">RawTForall</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawTForall</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">subst_vars_with_metavars</span> <span class="p">(</span><span class="n">List</span><span class="o">.</span><span class="n">removeAt</span> <span class="p">(</span><span class="n">List</span><span class="o">.</span><span class="n">findIndex</span> <span class="p">((</span><span class="o">=</span><span class="p">)</span> <span class="p">(</span><span class="n">typevar_name</span> <span class="n">a</span><span class="p">))</span> <span class="nb">vars</span><span class="p">)</span> <span class="nb">vars</span><span class="p">)</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">RawTExists</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> 
                    <span class="n">let</span> <span class="n">f</span> <span class="nb">vars</span> <span class="n">a</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">removeAt</span> <span class="p">(</span><span class="n">List</span><span class="o">.</span><span class="n">findIndex</span> <span class="p">((</span><span class="o">=</span><span class="p">)</span> <span class="p">(</span><span class="n">typevar_name</span> <span class="n">a</span><span class="p">))</span> <span class="nb">vars</span><span class="p">)</span> <span class="nb">vars</span>
                    <span class="n">RawTExists</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">subst_vars_with_metavars</span> <span class="p">(</span><span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="n">f</span> <span class="nb">vars</span> <span class="n">a</span><span class="p">)</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">RawTMacro</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> 
                    <span class="n">let</span> <span class="n">f</span> <span class="o">=</span> <span class="n">function</span> <span class="p">(</span><span class="n">RawMacroText</span> <span class="n">_</span> <span class="o">|</span> <span class="n">RawMacroTerm</span> <span class="n">_</span> <span class="o">|</span> <span class="n">RawMacroTypeLit</span> <span class="n">_</span><span class="p">)</span> <span class="k">as</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="o">|</span> <span class="n">RawMacroType</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawMacroType</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span>
                    <span class="n">RawTMacro</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="n">f</span> <span class="n">a</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">RawTLayout</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawTLayout</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>

            <span class="n">let</span> <span class="n">make_typecase</span> <span class="n">x</span> <span class="o">=</span>
                <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="nb">vars</span> <span class="n">x</span> <span class="o">=</span>
                    <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">RawTForall</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="p">(</span><span class="n">typevar_name</span> <span class="n">a</span> <span class="p">::</span> <span class="nb">vars</span><span class="p">)</span> <span class="n">b</span>
                    <span class="o">|</span> <span class="n">RawTFun</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawTTypecase</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">this</span><span class="p">,[</span><span class="n">subst_vars_with_metavars</span> <span class="nb">vars</span> <span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">])</span>
                    <span class="o">|</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">r</span> <span class="o">=</span> <span class="n">range_of_texpr</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">RawTTypecase</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">this</span><span class="p">,[</span><span class="n">subst_vars_with_metavars</span> <span class="nb">vars</span> <span class="n">b</span><span class="p">,</span><span class="n">RawTB</span> <span class="n">r</span><span class="p">])</span>
                <span class="n">loop</span> <span class="p">[]</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">f</span>
            <span class="n">TUnion</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,(</span><span class="n">Map</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="p">(</span><span class="n">is_gadt</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">x</span><span class="p">,</span> <span class="k">if</span> <span class="n">is_gadt</span> <span class="n">then</span> <span class="n">Some</span> <span class="p">(</span><span class="n">make_typecase</span> <span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span>
        <span class="o">|</span> <span class="n">RawTTypecase</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">e</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">metavars</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">()</span>
                <span class="n">let</span> <span class="n">mutable</span> <span class="n">env_case</span> <span class="o">=</span> <span class="n">env</span>
                <span class="n">let</span> <span class="n">t</span> <span class="o">=</span> 
                    <span class="n">let</span> <span class="n">f</span> <span class="p">(</span><span class="nb">id</span><span class="p">,</span><span class="n">env</span><span class="p">)</span> <span class="o">=</span> <span class="n">env_case</span> <span class="o">&lt;-</span> <span class="n">env</span><span class="p">;</span> <span class="n">TMetaV</span> <span class="nb">id</span>
                    <span class="n">ty</span><span class="s1">' (function</span>
                        <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">add_ty_wildcard</span> <span class="n">env_case</span> <span class="o">|&gt;</span> <span class="n">f</span>
                        <span class="o">|</span> <span class="n">Some</span> <span class="n">name</span> <span class="o">-&gt;</span> <span class="n">memoize</span> <span class="n">metavars</span> <span class="p">(</span><span class="n">add_ty_var</span> <span class="n">env_case</span> <span class="o">&gt;&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="n">name</span>
                        <span class="p">)</span> <span class="n">env</span> <span class="n">t</span>
                <span class="n">t</span><span class="p">,</span> <span class="n">ty</span> <span class="n">env_case</span> <span class="n">e</span>
                <span class="p">)</span>
            <span class="n">TTypecase</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">ty</span> <span class="n">env</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawTSymbol</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TSymbol</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawTApply</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">f</span> <span class="n">a</span><span class="p">,</span> <span class="n">f</span> <span class="n">b</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">TRecord</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="s1">') &amp; a, TSymbol(_,b'</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">b</span> <span class="o">-&gt;</span>

                <span class="k">match</span><span class="w"> </span><span class="n">a</span><span class="s1">' |&gt; Map.tryPick (fun (</span><span class="k">_</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">k</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">' then Some v else None) with</span>
                <span class="o">|</span> <span class="n">Some</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span>
                <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">TApply</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">//</span> <span class="n">TODO</span><span class="p">:</span> <span class="n">Will</span> <span class="n">be</span> <span class="n">an</span> <span class="n">error</span> <span class="n">during</span> <span class="n">partial</span> <span class="n">evaluation</span> <span class="n">time</span><span class="o">.</span> <span class="n">Could</span> <span class="n">be</span> <span class="n">substituted</span> <span class="k">for</span> <span class="n">an</span> <span class="n">exception</span> <span class="n">here</span><span class="p">,</span> <span class="n">but</span> <span class="n">I</span> <span class="n">do</span> <span class="ow">not</span> <span class="n">want</span> <span class="n">to</span> <span class="n">have</span> <span class="n">errors</span> <span class="n">during</span> <span class="n">the</span> <span class="n">prepass</span><span class="o">.</span>
            <span class="o">|</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">-&gt;</span> <span class="n">TApply</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawTPrim</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TPrim</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawTTerm</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TTerm</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">term</span> <span class="n">env</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawTMacro</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">l</span><span class="p">)</span> <span class="o">-&gt;</span> 
            <span class="n">let</span> <span class="n">f</span> <span class="o">=</span> <span class="n">function</span>
                <span class="o">|</span> <span class="n">RawMacroText</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TMText</span> <span class="n">a</span>
                <span class="o">|</span> <span class="n">RawMacroType</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TMType</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">RawMacroTypeLit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TMLitType</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">RawMacroTerm</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: Term vars should not appear on the type level."</span>
            <span class="n">TMacro</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="n">f</span> <span class="n">l</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawTArray</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TArray</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawTFilledNominal</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TNominal</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">RawTLayout</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TLayout</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
    <span class="ow">and</span> <span class="n">term</span> <span class="n">env</span> <span class="n">x</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">f</span> <span class="o">=</span> <span class="n">term</span> <span class="n">env</span>
        <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">RawDefaultLit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: Default values should have been annotated in `fill` by prepass time."</span>
        <span class="o">|</span> <span class="n">RawAnnot</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">RawDefaultLit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EDefaultLit</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">ty</span> <span class="n">env</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawAnnot</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">RawLit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EDefaultLit</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">LitToString</span><span class="p">(),</span><span class="n">ty</span> <span class="n">env</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawB</span> <span class="n">r</span> <span class="o">-&gt;</span> <span class="n">EB</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawV</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">v_term</span> <span class="n">env</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">RawLit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ELit</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawSymbol</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ESymbol</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawType</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EType</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">ty</span> <span class="n">env</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawMatch</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pattern_match</span> <span class="n">env</span> <span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">)</span> <span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">RawFun</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pattern_function</span> <span class="n">env</span> <span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">)</span> <span class="n">a</span> <span class="kc">None</span>
        <span class="o">|</span> <span class="n">RawAnnot</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">RawFun</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">t</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pattern_function</span> <span class="n">env</span> <span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">)</span> <span class="n">a</span> <span class="p">(</span><span class="n">Some</span> <span class="p">(</span><span class="n">ty</span> <span class="n">env</span> <span class="n">t</span><span class="p">))</span>
        <span class="o">|</span> <span class="n">RawArray</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: The array should have been annotated in `fill` by prepass time."</span>
        <span class="o">|</span> <span class="n">RawAnnot</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">RawArray</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EArray</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">ty</span> <span class="n">env</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawTypecase</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">e</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">metavars</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">()</span>
                <span class="n">let</span> <span class="n">mutable</span> <span class="n">env_case</span> <span class="o">=</span> <span class="n">env</span>
                <span class="n">let</span> <span class="n">t</span> <span class="o">=</span> 
                    <span class="n">let</span> <span class="n">f</span> <span class="p">(</span><span class="nb">id</span><span class="p">,</span><span class="n">env</span><span class="p">)</span> <span class="o">=</span> <span class="n">env_case</span> <span class="o">&lt;-</span> <span class="n">env</span><span class="p">;</span> <span class="n">TMetaV</span> <span class="nb">id</span>
                    <span class="n">ty</span><span class="s1">' (function</span>
                        <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">add_ty_wildcard</span> <span class="n">env_case</span> <span class="o">|&gt;</span> <span class="n">f</span>
                        <span class="o">|</span> <span class="n">Some</span> <span class="n">name</span> <span class="o">-&gt;</span> <span class="n">memoize</span> <span class="n">metavars</span> <span class="p">(</span><span class="n">add_ty_var</span> <span class="n">env_case</span> <span class="o">&gt;&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="n">name</span>
                        <span class="p">)</span> <span class="n">env</span> <span class="n">t</span>
                <span class="n">t</span><span class="p">,</span> <span class="n">term</span> <span class="n">env_case</span> <span class="n">e</span>
                <span class="p">)</span>
            <span class="n">ETypecase</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">ty</span> <span class="n">env</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawFilledForall</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawForall</span><span class="p">(</span><span class="n">r</span><span class="p">,((</span><span class="n">_</span><span class="p">,(</span><span class="n">name</span><span class="p">,</span><span class="n">_</span><span class="p">)),</span><span class="n">_</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> 
            <span class="n">let</span> <span class="nb">id</span><span class="p">,</span> <span class="n">env</span> <span class="o">=</span> <span class="n">add_ty_var</span> <span class="n">env</span> <span class="n">name</span>
            <span class="n">EForall</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="nb">id</span><span class="p">,</span><span class="n">term</span> <span class="n">env</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawRecBlock</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">on_succ</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">l</span><span class="p">,</span><span class="n">env</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">mapFold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">env</span> <span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">name</span><span class="p">),</span><span class="n">body</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="nb">id</span><span class="p">,</span><span class="n">env</span> <span class="o">=</span> <span class="n">add_term_rec_var</span> <span class="n">env</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">id</span><span class="p">,</span><span class="n">body</span><span class="p">),</span> <span class="n">env</span><span class="p">)</span> <span class="n">env</span> <span class="n">l</span>
            <span class="n">ERecBlock</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="nb">id</span><span class="p">,</span><span class="n">body</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">id</span><span class="p">,</span> <span class="n">term</span> <span class="n">env</span> <span class="n">body</span><span class="p">)</span> <span class="n">l</span><span class="p">,</span><span class="n">term</span> <span class="n">env</span> <span class="n">on_succ</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawRecordWith</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">p</span> <span class="p">(</span><span class="n">range_of_expr</span> <span class="n">a</span><span class="p">),</span> <span class="n">f</span> <span class="n">a</span><span class="p">)</span> <span class="n">a</span>
            <span class="n">let</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">function</span>
                <span class="o">|</span> <span class="n">RawRecordWithSymbol</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RSymbol</span><span class="p">((</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">RawRecordWithSymbolModify</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RSymbolModify</span><span class="p">((</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">RawRecordWithInjectVar</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RVar</span><span class="p">((</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">v_term</span> <span class="n">env</span> <span class="n">a</span><span class="p">),</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">RawRecordWithInjectVarModify</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RVarModify</span><span class="p">((</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">v_term</span> <span class="n">env</span> <span class="n">a</span><span class="p">),</span><span class="n">f</span> <span class="n">b</span><span class="p">))</span>
            <span class="n">let</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">function</span>
                <span class="o">|</span> <span class="n">RawRecordWithoutSymbol</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WSymbol</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">RawRecordWithoutInjectVar</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WVar</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">v_term</span> <span class="n">env</span> <span class="n">a</span><span class="p">))</span>
            <span class="n">ERecordWith</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawOp</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EOp</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="n">f</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawJoinPoint</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EJoinPoint</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="n">Option</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="sa">r</span><span class="s1">',w) -&gt; p r'</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> <span class="n">q</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawAnnot</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">RawJoinPoint</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">name</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EJoinPoint</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">Some</span> <span class="p">(</span><span class="n">ty</span> <span class="n">env</span> <span class="n">b</span><span class="p">),</span><span class="n">Option</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="sa">r</span><span class="s1">',w) -&gt; p r'</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> <span class="n">q</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawOpen</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">on_succ</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">term</span> <span class="p">(</span><span class="n">module_openPrepass</span> <span class="n">top_env</span> <span class="n">env</span> <span class="n">a</span> <span class="n">l</span><span class="p">)</span> <span class="n">on_succ</span>
        <span class="o">|</span> <span class="n">RawApply</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="o">=</span> <span class="n">function</span>
                <span class="o">|</span> <span class="n">EModule</span> <span class="n">a</span><span class="s1">' &amp; a, EPair(_,ESymbol(_, b'</span><span class="p">),</span><span class="sa">b</span><span class="s1">''</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">b</span> <span class="o">-&gt;</span>
                    <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="sa">b</span><span class="s1">' a'</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">Some</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="sa">b</span><span class="s1">''</span><span class="p">)</span>
                    <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">EApply</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">//</span> <span class="n">TODO</span><span class="p">:</span> <span class="n">Will</span> <span class="n">be</span> <span class="n">an</span> <span class="n">error</span> <span class="n">during</span> <span class="n">partial</span> <span class="n">evaluation</span> <span class="n">time</span><span class="o">.</span> <span class="n">Could</span> <span class="n">be</span> <span class="n">substituted</span> <span class="k">for</span> <span class="n">an</span> <span class="n">exception</span> <span class="n">here</span><span class="p">,</span> <span class="n">but</span> <span class="n">I</span> <span class="n">do</span> <span class="ow">not</span> <span class="n">want</span> <span class="n">to</span> <span class="n">have</span> <span class="n">errors</span> <span class="n">during</span> <span class="n">the</span> <span class="n">prepass</span><span class="o">.</span>
                <span class="o">|</span> <span class="n">EModule</span> <span class="n">a</span><span class="s1">' &amp; a, ESymbol(_,b'</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">b</span> <span class="o">-&gt;</span>
                    <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="sa">b</span><span class="s1">' a'</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">Some</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span>
                    <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">EApply</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">//</span> <span class="n">TODO</span><span class="p">:</span> <span class="n">Ditto</span><span class="o">.</span>
                <span class="o">|</span> <span class="n">a</span><span class="p">,</span><span class="n">EType</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ETypeApply</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">-&gt;</span> <span class="n">EApply</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
            <span class="n">loop</span> <span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span> <span class="n">f</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawIfThenElse</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EIfThenElse</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">,</span><span class="n">f</span> <span class="n">c</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawIfThen</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EIfThen</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawPair</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EPair</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawSeq</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ESeq</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawHeapMutableSet</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EMutableSet</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">p</span> <span class="p">(</span><span class="n">range_of_expr</span> <span class="n">a</span><span class="p">),</span> <span class="n">f</span> <span class="n">a</span><span class="p">)</span> <span class="n">b</span><span class="p">,</span><span class="n">f</span> <span class="n">c</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawReal</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">RawExists</span><span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">_</span><span class="p">,</span><span class="n">Some</span> <span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EExists</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">ty</span> <span class="n">env</span><span class="p">)</span> <span class="n">a</span><span class="p">,</span> <span class="n">f</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawExists</span><span class="p">(</span><span class="n">_</span><span class="p">,(</span><span class="n">_</span><span class="p">,</span><span class="kc">None</span><span class="p">),</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: The exists' vars should have been added during `fill`."</span>
        <span class="o">|</span> <span class="n">RawMacro</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: The macro's annotation should have been added during `fill`."</span>
        <span class="o">|</span> <span class="n">RawAnnot</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">RawMacro</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">function</span>
                <span class="o">|</span> <span class="n">RawMacroText</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MText</span> <span class="n">a</span>
                <span class="o">|</span> <span class="n">RawMacroTerm</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MTerm</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">RawMacroType</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MType</span><span class="p">(</span><span class="n">ty</span> <span class="n">env</span> <span class="n">a</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">RawMacroTypeLit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MLitType</span><span class="p">(</span><span class="n">ty</span> <span class="n">env</span> <span class="n">a</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">EMacro</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">ty</span> <span class="n">env</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">RawMissingBody</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: The missing body cases should have been validated."</span>
        <span class="o">|</span> <span class="n">RawAnnot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EAnnot</span><span class="p">(</span><span class="n">p</span> <span class="n">r</span><span class="p">,</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">ty</span> <span class="n">env</span> <span class="n">b</span><span class="p">)</span>

    <span class="n">let</span> <span class="n">env</span> <span class="p">:</span> <span class="n">PartEvalPrepassEnv</span> <span class="o">=</span>
        <span class="p">{</span>
        <span class="n">term</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span><span class="n">env</span><span class="o">=</span><span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">;</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i_rec</span><span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">|</span><span class="p">}</span>
        <span class="n">ty</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span><span class="n">env</span><span class="o">=</span><span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">;</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">|</span><span class="p">}</span>
        <span class="p">}</span>
        
    <span class="n">let</span> <span class="n">eval_type</span> <span class="p">((</span><span class="n">r</span><span class="p">,(</span><span class="n">name</span><span class="p">,</span><span class="n">kind</span><span class="p">))</span> <span class="p">:</span> <span class="n">HoVar</span><span class="p">)</span> <span class="n">on_succ</span> <span class="n">env</span> <span class="o">=</span>
        <span class="n">let</span> <span class="nb">id</span><span class="p">,</span> <span class="n">env</span> <span class="o">=</span> <span class="n">add_ty_var</span> <span class="n">env</span> <span class="n">name</span>
        <span class="n">TArrow</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span><span class="n">on_succ</span> <span class="n">env</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">eval_type</span><span class="s1">' env l body = List.foldBack eval_type l body env |&gt; process_ty</span>

    <span class="p">{</span><span class="o">|</span>
    <span class="n">base_type</span> <span class="o">=</span> <span class="n">process_ty</span>
    <span class="n">filled_top</span> <span class="o">=</span> <span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span>
        <span class="n">let</span> <span class="n">nominal_rec</span> <span class="n">l</span> <span class="o">=</span>
            <span class="n">let</span> <span class="n">env</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> 
                <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">env</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">_</span><span class="p">,</span><span class="n">name</span><span class="p">),</span><span class="n">l</span><span class="p">,</span><span class="n">body</span><span class="p">)</span> <span class="o">-&gt;</span> 
                    <span class="n">add_ty</span> <span class="n">env</span> <span class="n">name</span> <span class="p">(</span><span class="n">TNominal</span> <span class="p">(</span><span class="n">at_tag</span> <span class="n">i</span><span class="p">)),</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
                    <span class="p">)</span> <span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">top_env</span><span class="o">.</span><span class="n">nominals_next_tag</span><span class="p">)</span> <span class="n">l</span>
            <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">term</span><span class="p">,</span><span class="n">ty</span><span class="s1">',nominals,i) (r, (_,name),l,body) -&gt; </span>
                <span class="n">let</span> <span class="n">r</span> <span class="o">=</span> <span class="n">p</span> <span class="n">r</span>
                <span class="n">let</span> <span class="n">at_tag_i</span> <span class="o">=</span> <span class="n">at_tag</span> <span class="n">i</span>
                <span class="n">let</span> <span class="n">nom</span> <span class="o">=</span> <span class="n">TNominal</span> <span class="n">at_tag_i</span>
                <span class="n">let</span> <span class="n">bodyt</span> <span class="o">=</span> <span class="n">eval_type</span><span class="s1">' env l (fun env -&gt; TJoinPoint(p (range_of_texpr body), ty env body))</span>
                <span class="n">let</span> <span class="n">term</span> <span class="o">=</span>
                    <span class="k">match</span> <span class="n">body</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">RawTUnion</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> 
                        <span class="n">Map</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">term</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">name</span><span class="p">)</span> <span class="p">(</span><span class="n">is_gadt</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span>
                            <span class="k">if</span> <span class="n">is_gadt</span> <span class="n">then</span>
                                <span class="n">let</span> <span class="n">rec</span> <span class="n">loop_outer</span> <span class="o">=</span> <span class="n">function</span>
                                    <span class="o">|</span> <span class="n">TArrow</span><span class="s1">'(_,_,t) -&gt; loop_outer t // GADTs have the foralls in their cases'</span> <span class="nb">type</span><span class="p">,</span> <span class="ow">not</span> <span class="n">here</span><span class="o">.</span>
                                    <span class="o">|</span> <span class="n">TJoinPoint</span><span class="s1">'(r,_,TUnion(_,(l,_))) -&gt; </span>
                                        <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="nb">vars</span> <span class="o">=</span> <span class="n">function</span>
                                            <span class="o">|</span> <span class="n">TForall</span><span class="s1">'(r,scope,id,t) -&gt; EForall(r,id,loop (id :: vars) t)</span>
                                            <span class="o">|</span> <span class="n">TFun</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">t</span><span class="s1">',_) -&gt; EFun(r,0,ENominal(r,EPair(r,ESymbol(r,name),EV 0),t'</span><span class="p">),</span><span class="n">Some</span><span class="p">(</span><span class="n">TFun</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">t</span><span class="s1">',FT_Vanilla)))</span>
                                            <span class="o">|</span> <span class="n">t</span><span class="s1">' -&gt; ENominal(r,EPair(r,ESymbol(r,name),EB r),t'</span><span class="p">)</span>
                                        <span class="n">let</span> <span class="n">t</span> <span class="o">=</span> <span class="n">l</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">pick</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">k</span> <span class="o">=</span> <span class="n">name</span> <span class="n">then</span> <span class="n">Some</span> <span class="n">v</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">fst</span>
                                        <span class="n">loop</span> <span class="p">[]</span> <span class="n">t</span>
                                    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: Expected a join point with a gadt union."</span>
                                <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">name</span> <span class="p">(</span><span class="n">loop_outer</span> <span class="n">bodyt</span> <span class="o">|&gt;</span> <span class="n">process_term</span><span class="p">)</span> <span class="n">term</span>
                            <span class="k">else</span>
                                <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="nb">vars</span> <span class="o">=</span> <span class="n">function</span>
                                    <span class="o">|</span> <span class="n">TArrow</span><span class="s1">'(scope,id,t) -&gt; EForall(r,id,loop (id :: vars) t)</span>
                                    <span class="o">|</span> <span class="n">TJoinPoint</span><span class="s1">'(r,_,TUnion(_,(l,_))) -&gt; </span>
                                        <span class="n">let</span> <span class="n">t</span> <span class="o">=</span> <span class="n">l</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">pick</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">k</span> <span class="o">=</span> <span class="n">name</span> <span class="n">then</span> <span class="n">Some</span> <span class="n">v</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">fst</span>
                                        <span class="n">let</span> <span class="n">t</span><span class="s1">' = List.foldBack (fun id nom -&gt; TApply(r,nom,TV id)) vars nom</span>
                                        <span class="k">match</span> <span class="n">t</span> <span class="k">with</span>
                                        <span class="o">|</span> <span class="n">TB</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">ENominal</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">EPair</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">ESymbol</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">name</span><span class="p">),</span><span class="n">EB</span> <span class="n">r</span><span class="p">),</span><span class="n">t</span><span class="s1">')</span>
                                        <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">EFun</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ENominal</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">EPair</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">ESymbol</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">name</span><span class="p">),</span><span class="n">EV</span> <span class="mi">0</span><span class="p">),</span><span class="n">t</span><span class="s1">'),Some(TFun(t,t'</span><span class="p">,</span><span class="n">FT_Vanilla</span><span class="p">)))</span>
                                    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: Expected a join point with an union."</span>
                                <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">name</span> <span class="p">(</span><span class="n">loop</span> <span class="p">[]</span> <span class="n">bodyt</span> <span class="o">|&gt;</span> <span class="n">process_term</span><span class="p">)</span> <span class="n">term</span>
                            <span class="p">)</span> <span class="n">term</span> <span class="n">l</span>
                    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span>
                        <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="nb">vars</span> <span class="o">=</span> <span class="n">function</span>
                            <span class="o">|</span> <span class="n">TArrow</span><span class="s1">'(scope,id,t) -&gt; EForall(r,id,loop (id :: vars) t)</span>
                            <span class="o">|</span> <span class="n">TJoinPoint</span><span class="s1">'(r,_,t) -&gt; </span>
                                <span class="n">let</span> <span class="n">t</span><span class="s1">' = List.foldBack (fun id nom -&gt; TApply(r,nom,TV id)) vars nom</span>
                                <span class="k">match</span> <span class="n">t</span> <span class="k">with</span>
                                <span class="o">|</span> <span class="n">TB</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">ENominal</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">EB</span> <span class="n">r</span><span class="p">,</span><span class="n">t</span><span class="s1">')</span>
                                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">EFun</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ENominal</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">EV</span> <span class="mi">0</span><span class="p">,</span><span class="n">t</span><span class="s1">'),Some(TFun(t,t'</span><span class="p">,</span><span class="n">FT_Vanilla</span><span class="p">)))</span>                                
                            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: Expected a join point."</span>
                        <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">name</span> <span class="p">(</span><span class="n">loop</span> <span class="p">[]</span> <span class="n">bodyt</span> <span class="o">|&gt;</span> <span class="n">process_term</span><span class="p">)</span> <span class="n">term</span>
                <span class="n">term</span><span class="p">,</span><span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">name</span> <span class="n">nom</span> <span class="n">ty</span><span class="s1">', Map.add at_tag_i {|body=bodyt; name=name|} nominals, i+1</span>
                <span class="p">)</span> <span class="p">(</span><span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">,</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">,</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">,</span> <span class="n">top_env</span><span class="o">.</span><span class="n">nominals_next_tag</span><span class="p">)</span> <span class="n">l</span>
        <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">FType</span><span class="p">(</span><span class="n">_</span><span class="p">,(</span><span class="n">_</span><span class="p">,</span><span class="n">name</span><span class="p">),</span><span class="n">l</span><span class="p">,</span><span class="n">body</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AInclude</span> <span class="p">{</span><span class="n">top_env_emptyPrepass</span> <span class="k">with</span> <span class="n">ty</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">name</span> <span class="p">(</span><span class="n">eval_type</span><span class="s1">' env l (fun env -&gt; ty env body)) Map.empty}</span>
        <span class="o">|</span> <span class="n">FNominal</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">term</span><span class="p">,</span><span class="n">ty</span><span class="p">,</span><span class="n">nominals</span><span class="p">,</span><span class="n">i</span> <span class="o">=</span> <span class="n">nominal_rec</span> <span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">]</span>
            <span class="n">AInclude</span> <span class="p">{</span><span class="n">top_env_emptyPrepass</span> <span class="k">with</span> <span class="n">term</span> <span class="o">=</span> <span class="n">term</span><span class="p">;</span> <span class="n">ty</span> <span class="o">=</span> <span class="n">ty</span><span class="p">;</span> <span class="n">nominals</span> <span class="o">=</span> <span class="n">nominals</span><span class="p">;</span> <span class="n">nominals_next_tag</span><span class="o">=</span><span class="n">i</span><span class="p">}</span>
        <span class="o">|</span> <span class="n">FNominalRec</span> <span class="n">l</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">term</span><span class="p">,</span><span class="n">ty</span><span class="p">,</span><span class="n">nominals</span><span class="p">,</span><span class="n">i</span> <span class="o">=</span> <span class="n">nominal_rec</span> <span class="n">l</span>
            <span class="n">AInclude</span> <span class="p">{</span><span class="n">top_env_emptyPrepass</span> <span class="k">with</span> <span class="n">term</span> <span class="o">=</span> <span class="n">term</span><span class="p">;</span> <span class="n">ty</span> <span class="o">=</span> <span class="n">ty</span><span class="p">;</span> <span class="n">nominals</span> <span class="o">=</span> <span class="n">nominals</span><span class="p">;</span> <span class="n">nominals_next_tag</span><span class="o">=</span><span class="n">i</span><span class="p">}</span>
        <span class="o">|</span> <span class="n">FInl</span><span class="p">(</span><span class="n">_</span><span class="p">,(</span><span class="n">_</span><span class="p">,</span><span class="n">name</span><span class="p">),</span><span class="n">body</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AInclude</span> <span class="p">{</span><span class="n">top_env_emptyPrepass</span> <span class="k">with</span> <span class="n">term</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">name</span> <span class="p">(</span><span class="n">term</span> <span class="n">env</span> <span class="n">body</span> <span class="o">|&gt;</span> <span class="n">process_term</span><span class="p">)</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">}</span>
        <span class="o">|</span> <span class="n">FRecInl</span> <span class="n">l</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">l</span><span class="p">,</span> <span class="n">env</span> <span class="o">=</span> 
                <span class="n">List</span><span class="o">.</span><span class="n">mapFold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">env</span> <span class="p">(</span><span class="n">_</span><span class="p">,(</span><span class="n">_</span><span class="p">,</span><span class="n">name</span><span class="p">),</span><span class="n">_</span> <span class="k">as</span> <span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> 
                    <span class="n">let</span> <span class="n">r</span> <span class="o">=</span> <span class="n">ref</span> <span class="n">Unchecked</span><span class="o">.</span><span class="n">defaultof</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;</span>
                    <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">r</span><span class="p">),</span> <span class="n">add_term_rec</span> <span class="n">env</span> <span class="n">name</span> <span class="p">(</span><span class="n">ERecursive</span> <span class="n">r</span><span class="p">)</span>
                    <span class="p">)</span> <span class="n">env</span> <span class="n">l</span>
            <span class="n">let</span> <span class="n">term</span> <span class="o">=</span> 
                <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">top_env_term</span> <span class="p">((</span><span class="n">_</span><span class="p">,(</span><span class="n">_</span><span class="p">,</span><span class="n">name</span><span class="p">),</span><span class="n">body</span><span class="p">),(</span><span class="n">r</span> <span class="p">:</span> <span class="n">ref</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="p">))</span> <span class="o">-&gt;</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">Value</span> <span class="o">&lt;-</span> <span class="n">term</span> <span class="n">env</span> <span class="n">body</span> <span class="o">|&gt;</span> <span class="n">process_term</span>
                    <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">name</span> <span class="n">r</span><span class="o">.</span><span class="n">Value</span> <span class="n">top_env_term</span>
                    <span class="p">)</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span> <span class="n">l</span>
            <span class="n">AInclude</span> <span class="p">{</span><span class="n">top_env_emptyPrepass</span> <span class="k">with</span> <span class="n">term</span> <span class="o">=</span> <span class="n">term</span><span class="p">}</span>
        <span class="o">|</span> <span class="n">FPrototype</span><span class="p">(</span><span class="n">r</span><span class="p">,(</span><span class="n">_</span><span class="p">,</span><span class="n">name</span><span class="p">),</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">i</span> <span class="o">=</span> <span class="n">at_tag</span> <span class="n">top_env</span><span class="o">.</span><span class="n">prototypes_next_tag</span>
            <span class="n">let</span> <span class="n">r</span> <span class="o">=</span> <span class="n">p</span> <span class="n">r</span>
            <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">EForall</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">EPrototypeApply</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">TV</span> <span class="mi">0</span><span class="p">))</span> <span class="o">|&gt;</span> <span class="n">process_term</span>
            <span class="n">AInclude</span> <span class="p">{</span><span class="n">top_env_emptyPrepass</span> <span class="k">with</span> <span class="n">term</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">name</span> <span class="n">x</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">;</span> <span class="n">prototypes_next_tag</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">tag</span><span class="o">+</span><span class="mi">1</span><span class="p">}</span>
        <span class="o">|</span> <span class="n">FInstance</span><span class="p">(</span><span class="n">_</span><span class="p">,(</span><span class="n">_</span><span class="p">,</span><span class="n">prot_id</span><span class="p">),(</span><span class="n">_</span><span class="p">,</span><span class="n">ins_id</span><span class="p">),</span><span class="n">body</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">AInclude</span> <span class="p">{</span><span class="n">top_env_emptyPrepass</span> <span class="k">with</span> <span class="n">prototypes_instances</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="p">(</span><span class="n">prot_id</span><span class="p">,</span><span class="n">ins_id</span><span class="p">)</span> <span class="p">(</span><span class="n">term</span> <span class="n">env</span> <span class="n">body</span> <span class="o">|&gt;</span> <span class="n">process_term</span><span class="p">)</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">}</span>
        <span class="o">|</span> <span class="n">FOpen</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">module_openPrepass</span> <span class="n">top_env</span> <span class="n">env</span> <span class="n">a</span> <span class="n">b</span>
            <span class="n">AOpen</span> <span class="p">{</span><span class="n">top_env_emptyPrepass</span> <span class="k">with</span> <span class="n">term</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">env</span><span class="p">;</span> <span class="n">ty</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="n">env</span><span class="p">}</span>
    <span class="o">|</span><span class="p">}</span>

<span class="n">let</span> <span class="n">top_env_defaultPrepass</span> <span class="n">default_env</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">convert_infer_to_prepass</span> <span class="n">x</span> <span class="o">=</span> 
        <span class="n">let</span> <span class="n">m</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Reference</span><span class="p">)</span>
        <span class="n">let</span> <span class="n">rec</span> <span class="n">f</span> <span class="o">=</span> <span class="n">function</span>
            <span class="o">|</span> <span class="n">TyVar</span> <span class="p">(</span><span class="n">_</span><span class="p">,{</span><span class="n">contents</span><span class="o">=</span><span class="n">Some</span> <span class="n">x</span><span class="p">})</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">x</span>
            <span class="o">|</span> <span class="n">TyVar</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TV</span> <span class="n">m</span><span class="o">.</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> 
            <span class="o">|</span> <span class="n">TyPrim</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">TPrim</span> <span class="n">x</span>
            <span class="o">|</span> <span class="n">TyArray</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">TArray</span> <span class="p">(</span><span class="n">f</span> <span class="n">x</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">TyLayout</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TLayout</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">TyInl</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">i</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">Count</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">i</span><span class="p">);</span> <span class="n">TArrow</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">TyFun</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TFun</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span> <span class="n">f</span> <span class="n">b</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: The base type in Infer is not supported in the prepass yet."</span>
        <span class="n">f</span> <span class="n">x</span>

    <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">top_env</span> <span class="p">:</span> <span class="n">PrepassTopEnv</span><span class="p">)</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="p">{</span><span class="n">top_env</span> <span class="k">with</span> <span class="n">ty</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">k</span> <span class="p">((</span><span class="n">prepassPrepass</span> <span class="o">-</span><span class="mi">1</span> <span class="mi">0</span> <span class="s2">"&lt;base_types&gt;"</span> <span class="n">top_env</span><span class="p">)</span><span class="o">.</span><span class="n">base_type</span> <span class="p">(</span><span class="n">convert_infer_to_prepass</span> <span class="n">x</span><span class="p">))</span> <span class="n">top_env</span><span class="o">.</span><span class="n">ty</span><span class="p">}</span>
        <span class="p">)</span> <span class="n">top_env_emptyPrepass</span> <span class="p">(</span><span class="n">base_types</span> <span class="n">default_env</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=44">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="PartEval">PartEval<a class="anchor-link" href="#PartEval"></a></h2>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=45">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="o">//</span> <span class="c1">#r @"../../../../../../../.nuget/packages/softcircuits.ordereddictionary/3.2.0/lib/net8.0/SoftCircuits.OrderedDictionary.dll"</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=46">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="o">//</span> <span class="nb">open</span> <span class="n">System</span>
<span class="nb">open</span> <span class="n">System</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">Generic</span>
<span class="o">//</span> <span class="nb">open</span> <span class="n">SoftCircuits</span><span class="o">.</span><span class="n">Collections</span>
<span class="o">//</span> <span class="nb">open</span> <span class="n">Common</span>

<span class="nb">type</span> <span class="n">Tag</span> <span class="o">=</span> <span class="nb">int</span>
<span class="nb">type</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">CustomComparison</span><span class="p">;</span><span class="n">CustomEquality</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">L</span><span class="o">&lt;</span><span class="s1">'a,'</span><span class="n">b</span> <span class="n">when</span> <span class="s1">'a: equality and '</span><span class="n">a</span><span class="p">:</span> <span class="n">comparison</span><span class="o">&gt;</span> <span class="o">=</span> 
    <span class="o">|</span> <span class="n">L</span> <span class="n">of</span> <span class="s1">'a * '</span><span class="n">b</span>

    <span class="n">override</span> <span class="n">a</span><span class="o">.</span><span class="n">Equals</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">=</span>
        <span class="k">match</span> <span class="n">b</span> <span class="k">with</span>
        <span class="o">|</span> <span class="p">:</span><span class="err">?</span> <span class="n">L</span><span class="o">&lt;</span><span class="s1">'a,'</span><span class="n">b</span><span class="o">&gt;</span> <span class="k">as</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">match</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="k">with</span> <span class="n">L</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">),</span> <span class="n">L</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="o">=</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">false</span>
    <span class="n">override</span> <span class="n">a</span><span class="o">.</span><span class="n">GetHashCode</span><span class="p">()</span> <span class="o">=</span> <span class="n">match</span> <span class="n">a</span> <span class="k">with</span> <span class="n">L</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">hash</span> <span class="n">a</span>
    <span class="n">interface</span> <span class="n">System</span><span class="o">.</span><span class="n">IComparable</span> <span class="k">with</span>
        <span class="n">member</span> <span class="n">a</span><span class="o">.</span><span class="n">CompareTo</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">=</span>
            <span class="k">match</span> <span class="n">b</span> <span class="k">with</span>
            <span class="o">|</span> <span class="p">:</span><span class="err">?</span> <span class="n">L</span><span class="o">&lt;</span><span class="s1">'a,'</span><span class="n">b</span><span class="o">&gt;</span> <span class="k">as</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">match</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="k">with</span> <span class="n">L</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">),</span> <span class="n">L</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">compare</span> <span class="n">a</span> <span class="n">b</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="k">raise</span> <span class="o">&lt;|</span> <span class="n">System</span><span class="o">.</span><span class="n">ArgumentException</span> <span class="s2">"Invalid comparison for T."</span>

<span class="nb">type</span> <span class="n">H</span><span class="o">&lt;</span><span class="s1">'a when '</span><span class="n">a</span> <span class="p">:</span> <span class="n">equality</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="s1">'a) = </span>
    <span class="n">let</span> <span class="n">h</span> <span class="o">=</span> <span class="nb">hash</span> <span class="n">x</span>

    <span class="n">member</span> <span class="n">_</span><span class="o">.</span><span class="n">Item</span> <span class="o">=</span> <span class="n">x</span>
    <span class="n">override</span> <span class="n">_</span><span class="o">.</span><span class="n">Equals</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">=</span>
        <span class="k">match</span> <span class="n">b</span> <span class="k">with</span>
        <span class="o">|</span> <span class="p">:</span><span class="err">?</span> <span class="n">H</span><span class="o">&lt;</span><span class="s1">'a&gt; as b -&gt; System.Object.ReferenceEquals(x,b.Item)</span>
        <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">false</span>
    <span class="n">override</span> <span class="n">_</span><span class="o">.</span><span class="n">GetHashCode</span><span class="p">()</span> <span class="o">=</span> <span class="n">h</span>

<span class="nb">type</span> <span class="n">StackSize</span> <span class="o">=</span> <span class="nb">int</span>
<span class="nb">type</span> <span class="n">Nominal</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span><span class="n">body</span> <span class="p">:</span> <span class="n">TPrepass</span><span class="p">;</span> <span class="nb">id</span> <span class="p">:</span> <span class="n">GlobalId</span><span class="p">;</span> <span class="n">name</span> <span class="p">:</span> <span class="n">string</span><span class="o">|</span><span class="p">}</span> <span class="n">ConsedNode</span> <span class="o">//</span> <span class="n">TODO</span><span class="p">:</span> <span class="n">When</span> <span class="n">the</span> <span class="n">time</span> <span class="n">comes</span> <span class="n">to</span> <span class="n">implement</span> <span class="n">incremental</span> <span class="n">compilation</span><span class="p">,</span> <span class="n">make</span> <span class="n">the</span> <span class="err">`</span><span class="n">body</span><span class="err">`</span> <span class="n">field</span> <span class="n">a</span> <span class="n">weak</span> <span class="n">reference</span><span class="o">.</span>
<span class="nb">type</span> <span class="n">PartEvalMacro</span> <span class="o">=</span> <span class="n">Text</span> <span class="n">of</span> <span class="n">string</span> <span class="o">|</span> <span class="n">Type</span> <span class="n">of</span> <span class="n">Ty</span> <span class="o">|</span> <span class="n">TypeLit</span> <span class="n">of</span> <span class="n">Ty</span>
<span class="ow">and</span> <span class="n">Ty</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">YVoid</span>
    <span class="o">|</span> <span class="n">YB</span>
    <span class="o">|</span> <span class="n">YLit</span> <span class="n">of</span> <span class="n">Literal</span>
    <span class="o">|</span> <span class="n">YSymbol</span> <span class="n">of</span> <span class="n">string</span>
    <span class="o">|</span> <span class="n">YPair</span> <span class="n">of</span> <span class="n">Ty</span> <span class="o">*</span> <span class="n">Ty</span>
    <span class="o">|</span> <span class="n">YTypeFunction</span> <span class="n">of</span> <span class="n">body</span> <span class="p">:</span> <span class="n">TPrepass</span> <span class="o">*</span> <span class="n">ty</span> <span class="p">:</span> <span class="n">Ty</span> <span class="p">[]</span> <span class="o">*</span> <span class="n">term_stack_size</span> <span class="p">:</span> <span class="n">StackSize</span> <span class="o">*</span> <span class="n">ty_stack_size</span> <span class="p">:</span> <span class="n">StackSize</span>
    <span class="o">|</span> <span class="n">YExists</span>
    <span class="o">|</span> <span class="n">YForall</span>
    <span class="o">|</span> <span class="n">YRecord</span> <span class="n">of</span> <span class="n">Map</span><span class="o">&lt;</span><span class="nb">int</span> <span class="o">*</span> <span class="n">string</span><span class="p">,</span> <span class="n">Ty</span><span class="o">&gt;</span>
    <span class="o">|</span> <span class="n">YPrim</span> <span class="n">of</span> <span class="n">PrimitiveType</span>
    <span class="o">|</span> <span class="n">YArray</span> <span class="n">of</span> <span class="n">Ty</span>
    <span class="o">|</span> <span class="n">YFun</span> <span class="n">of</span> <span class="n">Ty</span> <span class="o">*</span> <span class="n">Ty</span> <span class="o">*</span> <span class="n">FunType</span>
    <span class="o">|</span> <span class="n">YMacro</span> <span class="n">of</span> <span class="n">PartEvalMacro</span> <span class="nb">list</span>
    <span class="o">|</span> <span class="n">YNominal</span> <span class="n">of</span> <span class="n">Nominal</span>
    <span class="o">|</span> <span class="n">YApply</span> <span class="n">of</span> <span class="n">Ty</span> <span class="o">*</span> <span class="n">Ty</span>
    <span class="o">|</span> <span class="n">YLayout</span> <span class="n">of</span> <span class="n">Ty</span> <span class="o">*</span> <span class="n">Layout</span>
    <span class="o">|</span> <span class="n">YUnion</span> <span class="n">of</span> <span class="n">Union</span>
    <span class="o">|</span> <span class="n">YMetavar</span> <span class="n">of</span> <span class="n">Id</span>
<span class="ow">and</span> <span class="n">Data</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">DB</span>
    <span class="o">|</span> <span class="n">DSymbol</span> <span class="n">of</span> <span class="n">string</span>
    <span class="o">|</span> <span class="n">DTLit</span> <span class="n">of</span> <span class="n">Literal</span>
    <span class="o">|</span> <span class="n">DPair</span> <span class="n">of</span> <span class="n">Data</span> <span class="o">*</span> <span class="n">Data</span>
    <span class="o">|</span> <span class="n">DFunction</span> <span class="n">of</span> <span class="n">body</span> <span class="p">:</span> <span class="n">E</span> <span class="o">*</span> <span class="n">annot</span> <span class="p">:</span> <span class="n">TPrepass</span> <span class="n">option</span> <span class="o">*</span> <span class="n">term</span> <span class="p">:</span> <span class="n">Data</span> <span class="p">[]</span> <span class="o">*</span> <span class="n">ty</span> <span class="p">:</span> <span class="n">Ty</span> <span class="p">[]</span> <span class="o">*</span> <span class="n">term_stack_size</span> <span class="p">:</span> <span class="n">StackSize</span> <span class="o">*</span> <span class="n">ty_stack_size</span> <span class="p">:</span> <span class="n">StackSize</span>
    <span class="o">|</span> <span class="n">DForall</span> <span class="n">of</span> <span class="n">body</span> <span class="p">:</span> <span class="n">E</span> <span class="o">*</span> <span class="n">term</span> <span class="p">:</span> <span class="n">Data</span> <span class="p">[]</span> <span class="o">*</span> <span class="n">ty</span> <span class="p">:</span> <span class="n">Ty</span> <span class="p">[]</span> <span class="o">*</span> <span class="n">term_stack_size</span> <span class="p">:</span> <span class="n">StackSize</span> <span class="o">*</span> <span class="n">ty_stack_size</span> <span class="p">:</span> <span class="n">StackSize</span>
    <span class="o">|</span> <span class="n">DExists</span> <span class="n">of</span> <span class="n">vars_type</span> <span class="p">:</span> <span class="n">Ty</span> <span class="p">[]</span> <span class="o">*</span> <span class="n">term</span> <span class="p">:</span> <span class="n">Data</span>
    <span class="o">|</span> <span class="n">DRecord</span> <span class="n">of</span> <span class="n">Map</span><span class="o">&lt;</span><span class="nb">int</span> <span class="o">*</span> <span class="n">string</span><span class="p">,</span> <span class="n">Data</span><span class="o">&gt;</span>
    <span class="o">|</span> <span class="n">DLit</span> <span class="n">of</span> <span class="n">Literal</span>
    <span class="o">|</span> <span class="n">DUnion</span> <span class="n">of</span> <span class="n">Data</span> <span class="o">*</span> <span class="n">Union</span>
    <span class="o">|</span> <span class="n">DNominal</span> <span class="n">of</span> <span class="n">Data</span> <span class="o">*</span> <span class="n">Ty</span>
    <span class="o">|</span> <span class="n">DV</span> <span class="n">of</span> <span class="n">TyV</span>
    <span class="o">|</span> <span class="n">DHashSet</span> <span class="n">of</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">Data</span><span class="o">&gt;</span>
    <span class="o">|</span> <span class="n">DHashMap</span> <span class="n">of</span> <span class="n">OrderedDictionary</span><span class="o">&lt;</span><span class="n">Data</span><span class="p">,</span><span class="n">Data</span><span class="o">&gt;</span> <span class="o">*</span> <span class="nb">bool</span> <span class="n">ref</span>
<span class="ow">and</span> <span class="n">TyV</span> <span class="o">=</span> <span class="n">L</span><span class="o">&lt;</span><span class="n">Tag</span><span class="p">,</span><span class="n">Ty</span><span class="o">&gt;</span>
<span class="o">//</span> <span class="n">Unions</span> <span class="n">always</span> <span class="n">go</span> <span class="n">through</span> <span class="n">a</span> <span class="n">join</span> <span class="n">point</span> <span class="n">which</span> <span class="n">enables</span> <span class="n">them</span> <span class="n">to</span> <span class="n">be</span> <span class="n">compared</span> <span class="n">via</span> <span class="n">ref</span> <span class="n">eqaulity</span><span class="o">.</span>
<span class="o">//</span> <span class="n">tags</span> <span class="ow">and</span> <span class="n">tag_cases</span> <span class="n">are</span> <span class="n">straightforward</span> <span class="n">mapping</span> <span class="kn">from</span> <span class="nn">cases</span> <span class="k">for</span> <span class="n">the</span> <span class="n">sake</span> <span class="n">of</span> <span class="n">efficiency</span><span class="o">.</span>
<span class="ow">and</span> <span class="n">Union</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span><span class="n">cases</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="nb">int</span> <span class="o">*</span> <span class="n">string</span><span class="p">,</span> <span class="n">Ty</span><span class="o">&gt;</span><span class="p">;</span> <span class="n">layout</span> <span class="p">:</span> <span class="n">UnionLayout</span><span class="p">;</span> <span class="n">tags</span> <span class="p">:</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="nb">int</span><span class="o">&gt;</span><span class="p">;</span> <span class="n">tag_cases</span> <span class="p">:</span> <span class="p">(</span><span class="n">string</span> <span class="o">*</span> <span class="n">Ty</span><span class="p">)</span> <span class="p">[];</span> <span class="n">is_degenerate</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">|</span><span class="p">}</span> <span class="n">H</span>

<span class="nb">type</span> <span class="n">TermVar</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">WV</span> <span class="n">of</span> <span class="n">TyV</span>
    <span class="o">|</span> <span class="n">WLit</span> <span class="n">of</span> <span class="n">Literal</span>

<span class="nb">type</span> <span class="n">RData</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">ReB</span>
    <span class="o">|</span> <span class="n">RePair</span> <span class="n">of</span> <span class="n">ConsedNode</span><span class="o">&lt;</span><span class="n">RData</span> <span class="o">*</span> <span class="n">RData</span><span class="o">&gt;</span>
    <span class="o">|</span> <span class="n">ReSymbol</span> <span class="n">of</span> <span class="n">string</span>
    <span class="o">|</span> <span class="n">ReFunction</span> <span class="n">of</span> <span class="n">ConsedNode</span><span class="o">&lt;</span><span class="n">E</span> <span class="o">*</span> <span class="n">RData</span> <span class="p">[]</span> <span class="o">*</span> <span class="n">Ty</span> <span class="p">[]</span><span class="o">&gt;</span> <span class="o">//</span> <span class="n">T</span> <span class="n">option</span> <span class="ow">and</span> <span class="n">stack</span> <span class="n">sizes</span> <span class="n">are</span> <span class="n">entirely</span> <span class="n">dependent</span> <span class="n">on</span> <span class="n">the</span> <span class="n">body</span><span class="o">.</span> <span class="n">And</span> <span class="n">unlike</span> <span class="ow">in</span> <span class="n">v0</span><span class="mf">.09</span><span class="o">/</span><span class="n">v0</span><span class="mf">.1</span> <span class="n">there</span> <span class="n">are</span> <span class="n">no</span> <span class="n">reified</span> <span class="n">join</span> <span class="n">points</span><span class="o">.</span>
    <span class="o">|</span> <span class="n">ReForall</span> <span class="n">of</span> <span class="n">ConsedNode</span><span class="o">&lt;</span><span class="n">E</span> <span class="o">*</span> <span class="n">RData</span> <span class="p">[]</span> <span class="o">*</span> <span class="n">Ty</span> <span class="p">[]</span><span class="o">&gt;</span>
    <span class="o">|</span> <span class="n">ReExists</span> <span class="n">of</span> <span class="n">ConsedNode</span><span class="o">&lt;</span><span class="n">Ty</span> <span class="p">[]</span> <span class="o">*</span> <span class="n">RData</span><span class="o">&gt;</span>
    <span class="o">|</span> <span class="n">ReRecord</span> <span class="n">of</span> <span class="n">ConsedNode</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="nb">int</span> <span class="o">*</span> <span class="n">string</span><span class="p">,</span> <span class="n">RData</span><span class="o">&gt;&gt;</span>
    <span class="o">|</span> <span class="n">ReLit</span> <span class="n">of</span> <span class="n">Literal</span>
    <span class="o">|</span> <span class="n">ReTLit</span> <span class="n">of</span> <span class="n">Literal</span>
    <span class="o">|</span> <span class="n">ReUnion</span> <span class="n">of</span> <span class="n">ConsedNode</span><span class="o">&lt;</span><span class="n">RData</span> <span class="o">*</span> <span class="n">Union</span><span class="o">&gt;</span>
    <span class="o">|</span> <span class="n">ReNominal</span> <span class="n">of</span> <span class="n">ConsedNode</span><span class="o">&lt;</span><span class="n">RData</span> <span class="o">*</span> <span class="n">Ty</span><span class="o">&gt;</span>
    <span class="o">|</span> <span class="n">ReV</span> <span class="n">of</span> <span class="n">ConsedNode</span><span class="o">&lt;</span><span class="n">Tag</span> <span class="o">*</span> <span class="n">Ty</span><span class="o">&gt;</span>
    <span class="o">|</span> <span class="n">ReHashMap</span> <span class="n">of</span> <span class="n">ConsedNode</span><span class="o">&lt;</span><span class="p">(</span><span class="n">RData</span> <span class="o">*</span> <span class="n">RData</span><span class="p">)[]</span><span class="o">&gt;</span>

<span class="nb">type</span> <span class="n">Trace</span> <span class="o">=</span> <span class="n">Range</span> <span class="nb">list</span>
<span class="nb">type</span> <span class="n">JoinPointKey</span> <span class="o">=</span> 
    <span class="o">|</span> <span class="n">JPMethod</span> <span class="n">of</span> <span class="p">(</span><span class="n">string</span> <span class="n">ConsedNode</span> <span class="o">*</span> <span class="n">E</span><span class="p">)</span> <span class="o">*</span> <span class="n">ConsedNode</span><span class="o">&lt;</span><span class="n">RData</span> <span class="p">[]</span> <span class="o">*</span> <span class="n">Ty</span> <span class="p">[]</span><span class="o">&gt;</span>
    <span class="o">|</span> <span class="n">JPClosure</span> <span class="n">of</span> <span class="p">(</span><span class="n">string</span> <span class="n">ConsedNode</span> <span class="o">*</span> <span class="n">E</span><span class="p">)</span> <span class="o">*</span> <span class="n">ConsedNode</span><span class="o">&lt;</span><span class="n">RData</span> <span class="p">[]</span> <span class="o">*</span> <span class="n">Ty</span> <span class="p">[]</span> <span class="o">*</span> <span class="n">Ty</span><span class="o">&gt;</span>
    
<span class="nb">type</span> <span class="n">JoinPointCall</span> <span class="o">=</span> <span class="n">JoinPointKey</span> <span class="o">*</span> <span class="n">TyV</span> <span class="p">[]</span>

<span class="nb">type</span> <span class="n">CodeMacro</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">CMText</span> <span class="n">of</span> <span class="n">string</span>
    <span class="o">|</span> <span class="n">CMTerm</span> <span class="n">of</span> <span class="n">Data</span>
    <span class="o">|</span> <span class="n">CMType</span> <span class="n">of</span> <span class="n">Ty</span>
    <span class="o">|</span> <span class="n">CMTypeLit</span> <span class="n">of</span> <span class="n">Ty</span>

<span class="nb">type</span> <span class="n">TypedBind</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">TyLet</span> <span class="n">of</span> <span class="n">Data</span> <span class="o">*</span> <span class="n">Trace</span> <span class="o">*</span> <span class="n">TypedOp</span>
    <span class="o">|</span> <span class="n">TyLocalReturnOp</span> <span class="n">of</span> <span class="n">Trace</span> <span class="o">*</span> <span class="n">TypedOp</span> <span class="o">*</span> <span class="n">Data</span>
    <span class="o">|</span> <span class="n">TyLocalReturnData</span> <span class="n">of</span> <span class="n">Data</span> <span class="o">*</span> <span class="n">Trace</span>

<span class="ow">and</span> <span class="n">TypedOp</span> <span class="o">=</span> 
    <span class="o">|</span> <span class="n">TyMacro</span> <span class="n">of</span> <span class="n">CodeMacro</span> <span class="nb">list</span>
    <span class="o">|</span> <span class="n">TyOp</span> <span class="n">of</span> <span class="n">Op</span> <span class="o">*</span> <span class="n">Data</span> <span class="nb">list</span>
    <span class="o">|</span> <span class="n">TyUnionBox</span> <span class="n">of</span> <span class="n">string</span> <span class="o">*</span> <span class="n">Data</span> <span class="o">*</span> <span class="n">Union</span>
    <span class="o">|</span> <span class="n">TyUnionUnbox</span> <span class="n">of</span> <span class="n">TyV</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">Union</span> <span class="o">*</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="n">Data</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">TypedBind</span> <span class="p">[]</span><span class="o">&gt;</span> <span class="o">*</span> <span class="n">TypedBind</span> <span class="p">[]</span> <span class="n">option</span>
    <span class="o">|</span> <span class="n">TyIntSwitch</span> <span class="n">of</span> <span class="n">TyV</span> <span class="o">*</span> <span class="n">TypedBind</span> <span class="p">[]</span> <span class="p">[]</span> <span class="o">*</span> <span class="n">TypedBind</span> <span class="p">[]</span>
    <span class="o">|</span> <span class="n">TyToLayout</span> <span class="n">of</span> <span class="n">Data</span> <span class="o">*</span> <span class="n">Ty</span>
    <span class="o">|</span> <span class="n">TyLayoutIndexAll</span> <span class="n">of</span> <span class="n">TyV</span>
    <span class="o">|</span> <span class="n">TyLayoutIndexByKey</span> <span class="n">of</span> <span class="n">TyV</span> <span class="o">*</span> <span class="n">string</span>
    <span class="o">|</span> <span class="n">TyLayoutMutableSet</span> <span class="n">of</span> <span class="n">TyV</span> <span class="o">*</span> <span class="n">string</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">Data</span>
    <span class="o">|</span> <span class="n">TyFailwith</span> <span class="n">of</span> <span class="n">Ty</span> <span class="o">*</span> <span class="n">Data</span>
    <span class="o">|</span> <span class="n">TyApply</span> <span class="n">of</span> <span class="n">TyV</span> <span class="o">*</span> <span class="n">Data</span>
    <span class="o">|</span> <span class="n">TyConv</span> <span class="n">of</span> <span class="n">Ty</span> <span class="o">*</span> <span class="n">Data</span>
    <span class="o">|</span> <span class="n">TySizeOf</span> <span class="n">of</span> <span class="n">Ty</span>
    <span class="o">|</span> <span class="n">TyArrayLiteral</span> <span class="n">of</span> <span class="n">Ty</span> <span class="o">*</span> <span class="n">Data</span> <span class="nb">list</span>
    <span class="o">|</span> <span class="n">TyArrayCreate</span> <span class="n">of</span> <span class="n">Ty</span> <span class="o">*</span> <span class="n">Data</span>
    <span class="o">|</span> <span class="n">TyArrayLength</span> <span class="n">of</span> <span class="n">Ty</span> <span class="o">*</span> <span class="n">Data</span>
    <span class="o">|</span> <span class="n">TyStringLength</span> <span class="n">of</span> <span class="n">Ty</span> <span class="o">*</span> <span class="n">Data</span>
    <span class="o">|</span> <span class="n">TyIf</span> <span class="n">of</span> <span class="n">cond</span><span class="p">:</span> <span class="n">Data</span> <span class="o">*</span> <span class="n">tr</span><span class="p">:</span> <span class="n">TypedBind</span> <span class="p">[]</span> <span class="o">*</span> <span class="n">fl</span><span class="p">:</span> <span class="n">TypedBind</span> <span class="p">[]</span>
    <span class="o">|</span> <span class="n">TyWhile</span> <span class="n">of</span> <span class="n">cond</span><span class="p">:</span> <span class="n">JoinPointCall</span> <span class="o">*</span> <span class="n">TypedBind</span> <span class="p">[]</span>
    <span class="o">|</span> <span class="n">TyDo</span> <span class="n">of</span> <span class="n">TypedBind</span> <span class="p">[]</span>
    <span class="o">|</span> <span class="n">TyIndent</span> <span class="n">of</span> <span class="n">TypedBind</span> <span class="p">[]</span>
    <span class="o">|</span> <span class="n">TyJoinPoint</span> <span class="n">of</span> <span class="n">JoinPointCall</span>
    <span class="o">|</span> <span class="n">TyBackend</span> <span class="n">of</span> <span class="p">(</span><span class="n">string</span> <span class="n">ConsedNode</span> <span class="o">*</span> <span class="n">E</span><span class="p">)</span> <span class="o">*</span> <span class="n">ConsedNode</span><span class="o">&lt;</span><span class="n">RData</span> <span class="p">[]</span> <span class="o">*</span> <span class="n">Ty</span> <span class="p">[]</span><span class="o">&gt;</span> <span class="o">*</span> <span class="n">Range</span>
<span class="nb">type</span> <span class="n">UnionRewrite</span> <span class="o">=</span> <span class="n">UnionData</span> <span class="n">of</span> <span class="n">string</span> <span class="o">*</span> <span class="n">Data</span> <span class="o">|</span> <span class="n">UnionBlockers</span> <span class="n">of</span> <span class="n">string</span> <span class="n">Set</span>
<span class="nb">type</span> <span class="n">LangEnv</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">trace</span> <span class="p">:</span> <span class="n">Trace</span>
    <span class="n">seq</span> <span class="p">:</span> <span class="n">ResizeArray</span><span class="o">&lt;</span><span class="n">TypedBind</span><span class="o">&gt;</span>
    <span class="n">cse</span> <span class="p">:</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="n">TypedOp</span><span class="p">,</span> <span class="n">Data</span><span class="o">&gt;</span> <span class="nb">list</span>
    <span class="n">unions</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">TyV</span><span class="p">,</span> <span class="n">UnionRewrite</span><span class="o">&gt;</span>
    <span class="n">i</span> <span class="p">:</span> <span class="nb">int</span> <span class="n">ref</span>
    <span class="n">env_global_type</span> <span class="p">:</span> <span class="n">Ty</span> <span class="p">[]</span>
    <span class="n">env_global_term</span> <span class="p">:</span> <span class="n">Data</span> <span class="p">[]</span>
    <span class="n">env_stack_type</span> <span class="p">:</span> <span class="n">Ty</span> <span class="p">[]</span>
    <span class="n">env_stack_term</span> <span class="p">:</span> <span class="n">Data</span> <span class="p">[]</span>
    <span class="n">backend</span> <span class="p">:</span> <span class="n">string</span> <span class="n">ConsedNode</span>
    <span class="nb">globals</span> <span class="p">:</span> <span class="n">ResizeArray</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span>
    <span class="p">}</span>

<span class="nb">type</span> <span class="n">PartEvalTopEnv</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">prototypes_instances</span> <span class="p">:</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="n">GlobalId</span> <span class="o">*</span> <span class="n">GlobalId</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span>
    <span class="n">nominals</span> <span class="p">:</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="n">GlobalId</span><span class="p">,</span> <span class="n">Nominal</span><span class="o">&gt;</span>
    <span class="n">backend</span> <span class="p">:</span> <span class="n">string</span>
    <span class="p">}</span>

<span class="n">exception</span> <span class="n">PartEvalTypeError</span> <span class="n">of</span> <span class="n">Trace</span> <span class="o">*</span> <span class="n">string</span>
<span class="n">let</span> <span class="n">raise_type_error</span> <span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="n">LangEnv</span><span class="p">)</span> <span class="n">x</span> <span class="o">=</span> <span class="k">raise</span> <span class="p">(</span><span class="n">PartEvalTypeError</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">trace</span><span class="p">,</span><span class="n">x</span><span class="p">))</span>

<span class="n">let</span> <span class="n">data_to_rdata</span> <span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="n">LangEnv</span><span class="p">)</span> <span class="p">(</span><span class="n">hc</span> <span class="p">:</span> <span class="n">HashConsTable</span><span class="p">)</span> <span class="n">call_data</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">hc</span> <span class="n">x</span> <span class="o">=</span> <span class="n">hc</span><span class="o">.</span><span class="n">Add</span> <span class="n">x</span>
    <span class="n">let</span> <span class="n">m</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Reference</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">call_args</span> <span class="o">=</span> <span class="n">ResizeArray</span><span class="p">()</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">f</span> <span class="n">x</span> <span class="o">=</span>
        <span class="n">memoize</span> <span class="n">m</span> <span class="p">(</span><span class="n">function</span>
            <span class="o">|</span> <span class="n">DPair</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RePair</span><span class="p">(</span><span class="n">hc</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span> <span class="n">f</span> <span class="n">b</span><span class="p">))</span>
            <span class="o">|</span> <span class="n">DSymbol</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">ReSymbol</span> <span class="n">a</span>
            <span class="o">|</span> <span class="n">DFunction</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ReFunction</span><span class="p">(</span><span class="n">hc</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="n">f</span> <span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">))</span>
            <span class="o">|</span> <span class="n">DForall</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ReFunction</span><span class="p">(</span><span class="n">hc</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="n">f</span> <span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">))</span>
            <span class="o">|</span> <span class="n">DExists</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ReExists</span><span class="p">(</span><span class="n">hc</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">f</span> <span class="n">b</span><span class="p">))</span>
            <span class="o">|</span> <span class="n">DRecord</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">ReRecord</span><span class="p">(</span><span class="n">hc</span><span class="p">(</span><span class="n">Map</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="n">l</span><span class="p">))</span>
            <span class="o">|</span> <span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">ty</span><span class="p">)</span> <span class="k">as</span> <span class="n">t</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">call_args</span><span class="o">.</span><span class="n">Add</span> <span class="n">t</span><span class="p">;</span> <span class="n">ReV</span><span class="p">(</span><span class="n">hc</span> <span class="p">(</span><span class="n">call_args</span><span class="o">.</span><span class="n">Count</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">ty</span><span class="p">))</span>
            <span class="o">|</span> <span class="n">DLit</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">ReLit</span> <span class="n">a</span>
            <span class="o">|</span> <span class="n">DTLit</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">ReTLit</span> <span class="n">a</span>
            <span class="o">|</span> <span class="n">DUnion</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ReUnion</span><span class="p">(</span><span class="n">hc</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span>
            <span class="o">|</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ReNominal</span><span class="p">(</span><span class="n">hc</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span>
            <span class="o">|</span> <span class="n">DB</span> <span class="o">-&gt;</span> <span class="n">ReB</span>
            <span class="o">|</span> <span class="n">DHashMap</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">is_writable</span><span class="p">)</span> <span class="n">when</span> <span class="n">is_writable</span><span class="o">.</span><span class="n">Value</span> <span class="o">=</span> <span class="n">false</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">kv</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">kv</span><span class="o">.</span><span class="n">Key</span><span class="p">,</span> <span class="n">f</span> <span class="n">kv</span><span class="o">.</span><span class="n">Value</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">toArray</span> <span class="o">|&gt;</span> <span class="n">hc</span> <span class="o">|&gt;</span> <span class="n">ReHashMap</span>
            <span class="o">|</span> <span class="n">DHashMap</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">d</span> <span class="s2">"The mutable compile time HashMap needs to be made immutable before it can be passed through a join point."</span>
            <span class="o">|</span> <span class="n">DHashSet</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">d</span> <span class="s2">"The mutable compile-time HashSet cannot be passed through join points."</span>
            <span class="p">)</span> <span class="n">x</span>
    <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="n">f</span> <span class="n">call_data</span>
    <span class="n">call_args</span><span class="o">.</span><span class="n">ToArray</span><span class="p">(),</span><span class="n">x</span>

<span class="o">//</span> <span class="n">This</span> <span class="n">rename</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">consideration</span> <span class="k">for</span> <span class="n">when</span> <span class="n">I</span> <span class="n">do</span> <span class="n">incremental</span> <span class="n">compilation</span><span class="o">.</span>
<span class="o">//</span> <span class="n">In</span> <span class="n">order</span> <span class="n">to</span> <span class="n">allow</span> <span class="n">them</span> <span class="n">to</span> <span class="n">be</span> <span class="n">cleaned</span> <span class="n">by</span> <span class="n">the</span> <span class="n">garbage</span> <span class="n">collection</span><span class="p">,</span> <span class="n">I</span> <span class="n">do</span> <span class="ow">not</span> <span class="n">want</span> <span class="n">the</span> 
<span class="o">//</span> <span class="n">references</span> <span class="n">to</span> <span class="n">unused</span> <span class="n">nodes</span> <span class="n">to</span> <span class="n">end</span> <span class="n">up</span> <span class="ow">in</span> <span class="n">anywhere</span> <span class="n">other</span> <span class="n">than</span> <span class="n">join</span> <span class="n">point</span> <span class="n">keys</span> <span class="p">(</span><span class="n">which</span> <span class="n">will</span> <span class="n">be</span> <span class="n">weak</span><span class="p">)</span><span class="o">.</span>
<span class="n">let</span> <span class="n">rename_global_term</span> <span class="p">(</span><span class="n">s</span> <span class="p">:</span> <span class="n">LangEnv</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">m</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Reference</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">f</span> <span class="n">x</span> <span class="o">=</span>
        <span class="n">memoize</span> <span class="n">m</span> <span class="p">(</span><span class="n">function</span>
            <span class="o">|</span> <span class="n">DPair</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DPair</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span> <span class="n">f</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">DForall</span><span class="p">(</span><span class="n">body</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DForall</span><span class="p">(</span><span class="n">body</span><span class="p">,</span><span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">DFunction</span><span class="p">(</span><span class="n">body</span><span class="p">,</span><span class="n">annot</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DFunction</span><span class="p">(</span><span class="n">body</span><span class="p">,</span><span class="n">annot</span><span class="p">,</span><span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">DExists</span><span class="p">(</span><span class="n">annot</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DExists</span><span class="p">(</span><span class="n">annot</span><span class="p">,</span> <span class="n">f</span> <span class="n">a</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">DRecord</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">DRecord</span><span class="p">(</span><span class="n">Map</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="n">l</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">ty</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">i</span><span class="o">.</span><span class="n">Value</span><span class="p">,</span><span class="n">ty</span><span class="p">))</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">i</span><span class="o">.</span><span class="n">Value</span> <span class="o">&lt;-</span> <span class="n">s</span><span class="o">.</span><span class="n">i</span><span class="o">.</span><span class="n">Value</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">x</span>
            <span class="o">|</span> <span class="n">DUnion</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DUnion</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">DSymbol</span> <span class="n">_</span> <span class="o">|</span> <span class="n">DLit</span> <span class="n">_</span> <span class="o">|</span> <span class="n">DTLit</span> <span class="n">_</span> <span class="o">|</span> <span class="n">DB</span> <span class="k">as</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span>
            <span class="o">|</span> <span class="n">DHashMap</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">is_writable</span><span class="p">)</span> <span class="n">when</span> <span class="n">is_writable</span><span class="o">.</span><span class="n">Value</span> <span class="o">=</span> <span class="n">false</span> <span class="o">-&gt;</span> 
                <span class="n">let</span> <span class="n">q</span> <span class="o">=</span> <span class="n">OrderedDictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Reference</span><span class="p">)</span>
                <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">kv</span> <span class="o">-&gt;</span> <span class="n">q</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">f</span> <span class="n">kv</span><span class="o">.</span><span class="n">Key</span><span class="p">,</span> <span class="n">f</span> <span class="n">kv</span><span class="o">.</span><span class="n">Value</span><span class="p">))</span>
                <span class="n">DHashMap</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">is_writable</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">DHashMap</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="s2">"The mutable compile time HashMap needs to be made immutable before it can be renamed."</span>
            <span class="o">|</span> <span class="n">DHashSet</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="s2">"The mutable compile-time HashSets cannot be renamed."</span>
            <span class="p">)</span> <span class="n">x</span>
    <span class="p">{</span><span class="n">s</span> <span class="k">with</span> <span class="n">env_global_term</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="n">f</span> <span class="n">s</span><span class="o">.</span><span class="n">env_global_term</span><span class="p">}</span>

<span class="n">let</span> <span class="n">data_free_vars</span> <span class="n">call_data</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">m</span> <span class="o">=</span> <span class="n">HashSet</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Reference</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">free_vars</span> <span class="o">=</span> <span class="n">ResizeArray</span><span class="p">()</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">f</span> <span class="n">x</span> <span class="o">=</span>
        <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">Add</span> <span class="n">x</span> <span class="n">then</span>
            <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DPair</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span><span class="p">;</span> <span class="n">f</span> <span class="n">b</span>
            <span class="o">|</span> <span class="n">DForall</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">DFunction</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">iter</span> <span class="n">f</span> <span class="n">a</span>
            <span class="o">|</span> <span class="n">DRecord</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="n">l</span>
            <span class="o">|</span> <span class="n">DV</span><span class="p">(</span><span class="n">L</span> <span class="n">_</span> <span class="k">as</span> <span class="n">t</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">free_vars</span><span class="o">.</span><span class="n">Add</span> <span class="n">t</span>
            <span class="o">|</span> <span class="n">DExists</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">DUnion</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span>
            <span class="o">|</span> <span class="n">DSymbol</span> <span class="n">_</span> <span class="o">|</span> <span class="n">DLit</span> <span class="n">_</span> <span class="o">|</span> <span class="n">DTLit</span> <span class="n">_</span> <span class="o">|</span> <span class="n">DB</span> <span class="o">-&gt;</span> <span class="p">()</span>
            <span class="o">|</span> <span class="n">DHashSet</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">iter</span> <span class="n">f</span> <span class="n">x</span>
            <span class="o">|</span> <span class="n">DHashMap</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">kv</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">kv</span><span class="o">.</span><span class="n">Value</span><span class="p">)</span>
    <span class="n">f</span> <span class="n">call_data</span>
    <span class="n">free_vars</span><span class="o">.</span><span class="n">ToArray</span><span class="p">()</span>

<span class="n">let</span> <span class="n">data_free_vars_replace</span> <span class="n">s</span> <span class="p">(</span><span class="n">d</span> <span class="p">:</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="n">TyV</span><span class="p">,</span><span class="n">TyV</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">Data</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">m</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Reference</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">f</span> <span class="n">x</span> <span class="o">=</span>
        <span class="n">memoize</span> <span class="n">m</span> <span class="p">(</span><span class="n">function</span>
            <span class="o">|</span> <span class="n">DPair</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DPair</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span> <span class="n">f</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">DForall</span><span class="p">(</span><span class="n">body</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DForall</span><span class="p">(</span><span class="n">body</span><span class="p">,</span><span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">DFunction</span><span class="p">(</span><span class="n">body</span><span class="p">,</span><span class="n">annot</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DFunction</span><span class="p">(</span><span class="n">body</span><span class="p">,</span><span class="n">annot</span><span class="p">,</span><span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">DExists</span><span class="p">(</span><span class="n">annot</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DExists</span><span class="p">(</span><span class="n">annot</span><span class="p">,</span> <span class="n">f</span> <span class="n">a</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">DRecord</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">DRecord</span><span class="p">(</span><span class="n">Map</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="n">l</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">DV</span><span class="p">(</span><span class="n">tyv</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DV</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">tyv</span><span class="p">])</span>
            <span class="o">|</span> <span class="n">DUnion</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DUnion</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">DSymbol</span> <span class="n">_</span> <span class="o">|</span> <span class="n">DLit</span> <span class="n">_</span> <span class="o">|</span> <span class="n">DTLit</span> <span class="n">_</span> <span class="o">|</span> <span class="n">DB</span> <span class="k">as</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span>
            <span class="o">|</span> <span class="n">DHashMap</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">is_writable</span><span class="p">)</span> <span class="o">-&gt;</span> 
                <span class="n">let</span> <span class="n">q</span> <span class="o">=</span> <span class="n">OrderedDictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Reference</span><span class="p">)</span>
                <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">kv</span> <span class="o">-&gt;</span> <span class="n">q</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">f</span> <span class="n">kv</span><span class="o">.</span><span class="n">Key</span><span class="p">,</span> <span class="n">f</span> <span class="n">kv</span><span class="o">.</span><span class="n">Value</span><span class="p">))</span>
                <span class="n">DHashMap</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">ref</span> <span class="n">is_writable</span><span class="o">.</span><span class="n">Value</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">DHashSet</span> <span class="n">_</span> <span class="o">-&gt;</span> 
                <span class="n">raise_type_error</span> <span class="n">s</span> <span class="s2">"The mutable compile-time HashSets cannot have their free vars replaced."</span>
            <span class="p">)</span> <span class="n">x</span>
    <span class="n">f</span> <span class="n">x</span>
<span class="n">let</span> <span class="n">inline</span> <span class="p">(</span><span class="o">|</span><span class="n">C</span><span class="o">|</span><span class="p">)</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">_</span> <span class="n">ConsedNode</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">node</span>
<span class="n">let</span> <span class="n">inline</span> <span class="p">(</span><span class="o">|</span><span class="n">C</span><span class="s1">'|) (x : _ ConsedNode) = x.node, x.tag</span>
<span class="n">let</span> <span class="n">rdata_free_vars</span> <span class="n">call_data</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">m</span> <span class="o">=</span> <span class="n">HashSet</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Structural</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">free_vars</span> <span class="o">=</span> <span class="n">ResizeArray</span><span class="p">()</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">g</span> <span class="o">=</span> <span class="n">function</span> <span class="o">//</span> <span class="n">Note</span><span class="p">:</span> <span class="n">Using</span> <span class="n">the</span> <span class="n">same</span> <span class="n">scheme</span> <span class="k">as</span> <span class="ow">in</span> <span class="err">`</span><span class="n">data_free_vars</span><span class="err">`</span> <span class="n">would</span> <span class="n">give</span> <span class="n">wrong</span> <span class="n">results</span> <span class="n">here</span><span class="o">.</span> <span class="n">Comparing</span> <span class="n">the</span> <span class="n">tags</span> <span class="n">instead</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">necessity</span><span class="o">.</span>
        <span class="o">|</span> <span class="n">RePair</span><span class="p">(</span><span class="n">C</span><span class="s1">'((a,b),tag)) -&gt; if m.Add tag then g a; g b</span>
        <span class="o">|</span> <span class="n">ReForall</span><span class="p">(</span><span class="n">C</span><span class="s1">'((_,a,_),tag)) | ReFunction(C'</span><span class="p">((</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">),</span><span class="n">tag</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">Add</span> <span class="n">tag</span> <span class="n">then</span> <span class="n">Array</span><span class="o">.</span><span class="n">iter</span> <span class="n">g</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">ReRecord</span><span class="p">(</span><span class="n">C</span><span class="s1">'(l,tag)) -&gt; if m.Add tag then Map.iter (fun _ -&gt; g) l</span>
        <span class="o">|</span> <span class="n">ReV</span><span class="p">(</span><span class="n">C</span><span class="s1">'((a,b),tag)) -&gt; if m.Add tag then free_vars.Add(L(a,b))</span>
        <span class="o">|</span> <span class="n">ReExists</span><span class="p">(</span><span class="n">C</span><span class="s1">'((_,a),tag)) | ReUnion(C'</span><span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">),</span><span class="n">tag</span><span class="p">))</span> <span class="o">|</span> <span class="n">ReNominal</span><span class="p">(</span><span class="n">C</span><span class="s1">'((a,_),tag)) -&gt; if m.Add tag then g a</span>
        <span class="o">|</span> <span class="n">ReHashMap</span><span class="p">(</span><span class="n">C</span><span class="s1">'(x,tag)) -&gt; if m.Add tag then Array.iter (fun (k,v) -&gt; g k; g v) x</span>
        <span class="o">|</span> <span class="n">ReSymbol</span> <span class="n">_</span> <span class="o">|</span> <span class="n">ReLit</span> <span class="n">_</span> <span class="o">|</span> <span class="n">ReTLit</span> <span class="n">_</span> <span class="o">|</span> <span class="n">ReB</span> <span class="o">-&gt;</span> <span class="p">()</span>
    <span class="n">Array</span><span class="o">.</span><span class="n">iter</span> <span class="n">g</span> <span class="n">call_data</span>
    <span class="n">free_vars</span><span class="o">.</span><span class="n">ToArray</span><span class="p">()</span>

<span class="n">let</span> <span class="n">data_term_vars</span><span class="s1">' call_data =</span>
    <span class="n">let</span> <span class="n">term_vars</span> <span class="o">=</span> <span class="n">ResizeArray</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">f</span> <span class="o">=</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">DPair</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span><span class="p">;</span> <span class="n">f</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">DForall</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">DFunction</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">iter</span> <span class="n">f</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">DRecord</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="n">l</span>
        <span class="o">|</span> <span class="n">DLit</span> <span class="n">_</span> <span class="o">|</span> <span class="n">DV</span> <span class="n">_</span> <span class="k">as</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">term_vars</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">DExists</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">DUnion</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">DSymbol</span> <span class="n">_</span> <span class="o">|</span> <span class="n">DTLit</span> <span class="n">_</span> <span class="o">|</span> <span class="n">DB</span> <span class="o">-&gt;</span> <span class="p">()</span>
        <span class="o">|</span> <span class="n">DHashSet</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">iter</span> <span class="n">f</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">DHashMap</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">kv</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">kv</span><span class="o">.</span><span class="n">Value</span><span class="p">)</span>
    <span class="n">f</span> <span class="n">call_data</span>
    <span class="n">term_vars</span><span class="o">.</span><span class="n">ToArray</span><span class="p">()</span>
    
<span class="n">let</span> <span class="n">data_nominals</span> <span class="n">call_data</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">term_vars</span> <span class="o">=</span> <span class="n">ResizeArray</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">f</span> <span class="o">=</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">DPair</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span><span class="p">;</span> <span class="n">f</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">DForall</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">DFunction</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">iter</span> <span class="n">f</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">DRecord</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="n">l</span>
        <span class="o">|</span> <span class="n">DLit</span> <span class="n">_</span> <span class="o">|</span> <span class="n">DV</span> <span class="n">_</span> 
        <span class="o">|</span> <span class="n">DExists</span> <span class="n">_</span> <span class="o">|</span> <span class="n">DUnion</span> <span class="n">_</span> <span class="o">|</span> <span class="n">DNominal</span> <span class="n">_</span> <span class="k">as</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">term_vars</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">DSymbol</span> <span class="n">_</span> <span class="o">|</span> <span class="n">DTLit</span> <span class="n">_</span> <span class="o">|</span> <span class="n">DB</span> <span class="o">-&gt;</span> <span class="p">()</span>
        <span class="o">|</span> <span class="n">DHashSet</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">iter</span> <span class="n">f</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">DHashMap</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">kv</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">kv</span><span class="o">.</span><span class="n">Value</span><span class="p">)</span>
    <span class="n">f</span> <span class="n">call_data</span>
    <span class="n">term_vars</span><span class="o">.</span><span class="n">ToArray</span><span class="p">()</span>

<span class="n">let</span> <span class="n">data_term_vars</span> <span class="n">call_data</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">term_vars</span> <span class="o">=</span> <span class="n">ResizeArray</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">f</span> <span class="o">=</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">DPair</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span><span class="p">;</span> <span class="n">f</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">DForall</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">DFunction</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">iter</span> <span class="n">f</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">DRecord</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="n">l</span>
        <span class="o">|</span> <span class="n">DLit</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">term_vars</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">WLit</span> <span class="n">x</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">DV</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">term_vars</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">WV</span> <span class="n">x</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">DExists</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">DUnion</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">DSymbol</span> <span class="n">_</span> <span class="o">|</span> <span class="n">DTLit</span> <span class="n">_</span> <span class="o">|</span> <span class="n">DB</span> <span class="o">-&gt;</span> <span class="p">()</span>
        <span class="o">|</span> <span class="n">DHashSet</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">iter</span> <span class="n">f</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">DHashMap</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">kv</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">kv</span><span class="o">.</span><span class="n">Value</span><span class="p">)</span>
    <span class="n">f</span> <span class="n">call_data</span>
    <span class="n">term_vars</span><span class="o">.</span><span class="n">ToArray</span><span class="p">()</span>

<span class="n">let</span> <span class="n">lit_to_primitive_type</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">LitUInt8</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">UInt8T</span>
    <span class="o">|</span> <span class="n">LitUInt16</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">UInt16T</span>
    <span class="o">|</span> <span class="n">LitUInt32</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">UInt32T</span>
    <span class="o">|</span> <span class="n">LitUInt64</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">UInt64T</span>
    <span class="o">|</span> <span class="n">LitInt8</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Int8T</span>
    <span class="o">|</span> <span class="n">LitInt16</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Int16T</span>
    <span class="o">|</span> <span class="n">LitInt32</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Int32T</span>
    <span class="o">|</span> <span class="n">LitInt64</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Int64T</span>
    <span class="o">|</span> <span class="n">LitFloat32</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Float32T</span>
    <span class="o">|</span> <span class="n">LitFloat64</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Float64T</span>   
    <span class="o">|</span> <span class="n">LitBool</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">BoolT</span>
    <span class="o">|</span> <span class="n">LitString</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">StringT</span>
    <span class="o">|</span> <span class="n">LitChar</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">CharT</span>

<span class="n">let</span> <span class="n">lit_to_ty</span> <span class="n">x</span> <span class="o">=</span> <span class="n">lit_to_primitive_type</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">YPrim</span>
<span class="n">let</span> <span class="n">is_tco_compatible</span> <span class="o">=</span> <span class="n">function</span> 
    <span class="o">|</span> <span class="n">TyApply</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyJoinPoint</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyArrayLiteral</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyUnionBox</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyToLayout</span> <span class="n">_</span>
    <span class="o">|</span> <span class="n">TyIf</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyIntSwitch</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyUnionUnbox</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyArrayCreate</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyFailwith</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">true</span> 
    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">false</span>

<span class="n">let</span> <span class="n">seq_apply</span> <span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="n">LangEnv</span><span class="p">)</span> <span class="n">end_dat</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">inline</span> <span class="n">end_</span> <span class="p">()</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">seq</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">TyLocalReturnData</span><span class="p">(</span><span class="n">end_dat</span><span class="p">,</span><span class="n">d</span><span class="o">.</span><span class="n">trace</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">seq</span><span class="o">.</span><span class="n">Count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="n">then</span>
        <span class="k">match</span> <span class="n">d</span><span class="o">.</span><span class="n">seq</span><span class="o">.</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">seq</span><span class="o">.</span><span class="n">Count</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">TyLet</span><span class="p">(</span><span class="n">end_dat</span><span class="s1">',a,b) when System.Object.ReferenceEquals(end_dat,end_dat'</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">is_tco_compatible</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">d</span><span class="o">.</span><span class="n">seq</span><span class="o">.</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">seq</span><span class="o">.</span><span class="n">Count</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">TyLocalReturnOp</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">end_dat</span><span class="s1">')</span>
        <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">end_</span><span class="p">()</span>
    <span class="k">else</span> <span class="n">end_</span><span class="p">()</span>
    <span class="n">d</span><span class="o">.</span><span class="n">seq</span><span class="o">.</span><span class="n">ToArray</span><span class="p">()</span>

<span class="n">let</span> <span class="n">cse_tryfind</span> <span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="n">LangEnv</span><span class="p">)</span> <span class="n">key</span> <span class="o">=</span>
    <span class="n">d</span><span class="o">.</span><span class="n">cse</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">tryPick</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span>
        <span class="k">match</span> <span class="n">x</span><span class="o">.</span><span class="n">TryGetValue</span> <span class="n">key</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">true</span><span class="p">,</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">Some</span> <span class="n">v</span>
        <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="kc">None</span>
        <span class="p">)</span>

<span class="n">let</span> <span class="n">cse_add</span> <span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="n">LangEnv</span><span class="p">)</span> <span class="n">k</span> <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">List</span><span class="o">.</span><span class="n">head</span> <span class="n">d</span><span class="o">.</span><span class="n">cse</span><span class="p">)</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>


<span class="n">let</span> <span class="n">show_ty</span> <span class="n">x</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">f</span> <span class="n">prec</span> <span class="n">x</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="n">prec</span>
        <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">YVoid</span> <span class="o">-&gt;</span> <span class="s2">"void"</span>
        <span class="o">|</span> <span class="n">YB</span> <span class="o">-&gt;</span> <span class="s2">"()"</span>
        <span class="o">|</span> <span class="n">YLit</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">show_lit</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">YPair</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">p</span> <span class="mi">25</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> * </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">f</span> <span class="mi">25</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">f</span> <span class="mi">24</span> <span class="n">b</span><span class="p">))</span>
        <span class="o">|</span> <span class="n">YSymbol</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">".</span><span class="si">%s</span><span class="s2">"</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">YTypeFunction</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">p</span> <span class="mi">0</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"? =&gt; ?"</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">YForall</span> <span class="o">-&gt;</span> <span class="n">p</span> <span class="mi">0</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"forall ?. ?"</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">YExists</span> <span class="o">-&gt;</span> <span class="n">p</span> <span class="mi">0</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"exists ?. ?"</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">YRecord</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"{</span><span class="si">%s</span><span class="s2">}"</span> <span class="p">(</span><span class="n">l</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">toList</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">((</span><span class="n">_</span><span class="p">,</span><span class="n">k</span><span class="p">),</span><span class="n">v</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">"</span> <span class="n">k</span> <span class="p">(</span><span class="n">f</span> <span class="o">-</span><span class="mi">1</span> <span class="n">v</span><span class="p">))</span> <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">"; "</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">YUnion</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"{</span><span class="si">%s</span><span class="s2">}"</span> <span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">Item</span><span class="o">.</span><span class="n">cases</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">toList</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">((</span><span class="n">_</span><span class="p">,</span><span class="n">k</span><span class="p">),</span><span class="n">v</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">"</span> <span class="n">k</span> <span class="p">(</span><span class="n">f</span> <span class="o">-</span><span class="mi">1</span> <span class="n">v</span><span class="p">))</span> <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">" | "</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">YPrim</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">show_primt</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">YArray</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">p</span> <span class="mi">30</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"array_base </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">f</span> <span class="mi">30</span> <span class="n">a</span><span class="p">))</span>
        <span class="o">|</span> <span class="n">YFun</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">FT_Vanilla</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">p</span> <span class="mi">20</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> -&gt; </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">f</span> <span class="mi">20</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">f</span> <span class="mi">19</span> <span class="n">b</span><span class="p">))</span>
        <span class="o">|</span> <span class="n">YFun</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">FT_Pointer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">p</span> <span class="mi">20</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"fptr (</span><span class="si">%s</span><span class="s2"> -&gt; </span><span class="si">%s</span><span class="s2">)"</span> <span class="p">(</span><span class="n">f</span> <span class="mi">20</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">f</span> <span class="mi">19</span> <span class="n">b</span><span class="p">))</span>
        <span class="o">|</span> <span class="n">YFun</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">FT_Closure</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">p</span> <span class="mi">20</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"closure (</span><span class="si">%s</span><span class="s2"> -&gt; </span><span class="si">%s</span><span class="s2">)"</span> <span class="p">(</span><span class="n">f</span> <span class="mi">20</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">f</span> <span class="mi">19</span> <span class="n">b</span><span class="p">))</span>
        <span class="o">|</span> <span class="n">YMacro</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">p</span> <span class="mi">30</span> <span class="p">(</span><span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">function</span> <span class="n">TypeLit</span> <span class="n">a</span> <span class="o">|</span> <span class="n">Type</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="o">-</span><span class="mi">1</span> <span class="n">a</span> <span class="o">|</span> <span class="n">Text</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="p">)</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">""</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">YApply</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">p</span> <span class="mi">30</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">f</span> <span class="mi">29</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">f</span> <span class="mi">30</span> <span class="n">b</span><span class="p">))</span>
        <span class="o">|</span> <span class="n">YLayout</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">p</span> <span class="mi">30</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_layout_type</span> <span class="n">b</span><span class="p">)</span> <span class="p">(</span><span class="n">f</span> <span class="mi">30</span> <span class="n">a</span><span class="p">))</span>
        <span class="o">|</span> <span class="n">YNominal</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">name</span>
        <span class="o">|</span> <span class="n">YMetavar</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="s2">"?"</span>
    <span class="n">f</span> <span class="o">-</span><span class="mi">1</span> <span class="n">x</span>

<span class="n">let</span> <span class="n">show_data</span> <span class="n">x</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">f</span> <span class="n">prec</span> <span class="n">x</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="n">prec</span>
        <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">DB</span> <span class="o">-&gt;</span> <span class="s2">"()"</span>
        <span class="o">|</span> <span class="n">DPair</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">p</span> <span class="mi">25</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">f</span> <span class="mi">25</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">f</span> <span class="mi">24</span> <span class="n">b</span><span class="p">))</span>
        <span class="o">|</span> <span class="n">DSymbol</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">".</span><span class="si">%s</span><span class="s2">"</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">DFunction</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">p</span> <span class="mi">20</span> <span class="s2">"? -&gt; ?"</span>
        <span class="o">|</span> <span class="n">DForall</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">p</span> <span class="mi">0</span> <span class="s2">"forall ?. ?"</span>
        <span class="o">|</span> <span class="n">DExists</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">show_ty</span> <span class="o">&gt;&gt;</span> <span class="n">sprintf</span> <span class="s2">"(</span><span class="si">%s</span><span class="s2">)"</span><span class="p">)</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">" "</span>
            <span class="n">p</span> <span class="mi">0</span> <span class="err">$</span><span class="s2">"exists </span><span class="si">{a}</span><span class="s2">. </span><span class="si">%s</span><span class="s2">{f 0 b}"</span>
        <span class="o">|</span> <span class="n">DRecord</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"{</span><span class="si">%s</span><span class="s2">}"</span> <span class="p">(</span><span class="n">l</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">toList</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">((</span><span class="n">_</span><span class="p">,</span><span class="n">k</span><span class="p">),</span><span class="n">v</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">"</span> <span class="n">k</span> <span class="p">(</span><span class="n">f</span> <span class="o">-</span><span class="mi">1</span> <span class="n">v</span><span class="p">))</span> <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">"; "</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">DLit</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">show_lit</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">DTLit</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"`{show_lit a}"</span>
        <span class="o">|</span> <span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">ty</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">show_ty</span> <span class="n">ty</span>
        <span class="o">|</span> <span class="n">DUnion</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">prec</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">p</span> <span class="mi">0</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">f</span> <span class="mi">0</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">b</span><span class="p">))</span>
        <span class="o">|</span> <span class="n">DHashSet</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">p</span> <span class="mi">0</span> <span class="s2">"&lt;HashSet&gt;"</span>
        <span class="o">|</span> <span class="n">DHashMap</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">p</span> <span class="mi">0</span> <span class="s2">"&lt;HashMap&gt;"</span>

    <span class="n">f</span> <span class="o">-</span><span class="mi">1</span> <span class="n">x</span>

<span class="n">let</span> <span class="n">is_lit</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">DLit</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">true</span>
    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">false</span>

<span class="n">let</span> <span class="n">is_numeric</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">YPrim</span> <span class="p">(</span><span class="n">UInt8T</span> <span class="o">|</span> <span class="n">UInt16T</span> <span class="o">|</span> <span class="n">UInt32T</span> <span class="o">|</span> <span class="n">UInt64T</span> 
        <span class="o">|</span> <span class="n">Int8T</span> <span class="o">|</span> <span class="n">Int16T</span> <span class="o">|</span> <span class="n">Int32T</span> <span class="o">|</span> <span class="n">Int64T</span> 
        <span class="o">|</span> <span class="n">Float32T</span> <span class="o">|</span> <span class="n">Float64T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">true</span>
    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">false</span>

<span class="n">let</span> <span class="n">is_signed_numeric</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">YPrim</span> <span class="p">(</span><span class="n">Int8T</span> <span class="o">|</span> <span class="n">Int16T</span> <span class="o">|</span> <span class="n">Int32T</span> <span class="o">|</span> <span class="n">Int64T</span> <span class="o">|</span> <span class="n">Float32T</span> <span class="o">|</span> <span class="n">Float64T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">true</span>
    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">false</span>

<span class="n">let</span> <span class="n">is_non_float_primitive</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">YPrim</span> <span class="p">(</span><span class="n">Float32T</span> <span class="o">|</span> <span class="n">Float64T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">false</span>
    <span class="o">|</span> <span class="n">YPrim</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">true</span>
    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">false</span>

<span class="n">let</span> <span class="n">is_primitive</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">YPrim</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">true</span>
    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">false</span>

<span class="n">let</span> <span class="n">is_string</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">YPrim</span> <span class="n">StringT</span> <span class="o">-&gt;</span> <span class="n">true</span>
    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">false</span>

<span class="n">let</span> <span class="n">is_char</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">YPrim</span> <span class="n">CharT</span> <span class="o">-&gt;</span> <span class="n">true</span>
    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">false</span>

<span class="n">let</span> <span class="n">is_float</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">YPrim</span> <span class="p">(</span><span class="n">Float32T</span> <span class="o">|</span> <span class="n">Float64T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">true</span>
    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">false</span>

<span class="n">let</span> <span class="n">is_bool</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">YPrim</span> <span class="n">BoolT</span> <span class="o">-&gt;</span> <span class="n">true</span>
    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">false</span>

<span class="n">let</span> <span class="n">is_int</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">YPrim</span> <span class="p">(</span><span class="n">UInt32T</span> <span class="o">|</span> <span class="n">UInt64T</span> <span class="o">|</span> <span class="n">Int32T</span> <span class="o">|</span> <span class="n">Int64T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">true</span>
    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">false</span>

<span class="n">let</span> <span class="n">is_any_int</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">YPrim</span> <span class="p">(</span><span class="n">UInt8T</span> <span class="o">|</span> <span class="n">UInt16T</span> <span class="o">|</span> <span class="n">UInt32T</span> <span class="o">|</span> <span class="n">UInt64T</span> 
        <span class="o">|</span> <span class="n">Int8T</span> <span class="o">|</span> <span class="n">Int16T</span> <span class="o">|</span> <span class="n">Int32T</span> <span class="o">|</span> <span class="n">Int64T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">true</span>
    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">false</span>

<span class="n">let</span> <span class="n">is_int64</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">YPrim</span> <span class="n">Int64T</span> <span class="o">-&gt;</span> <span class="n">true</span>
    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">false</span>

<span class="n">let</span> <span class="n">is_int32</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">YPrim</span> <span class="n">Int32T</span> <span class="o">-&gt;</span> <span class="n">true</span>
    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">false</span>

<span class="n">let</span> <span class="n">is_lit_zero</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">DLit</span> <span class="n">a</span> <span class="o">-&gt;</span>
        <span class="k">match</span> <span class="n">a</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">LitInt8</span> <span class="mi">0</span><span class="n">y</span> <span class="o">|</span> <span class="n">LitInt16</span> <span class="mi">0</span><span class="n">s</span> <span class="o">|</span> <span class="n">LitInt32</span> <span class="mi">0</span> <span class="o">|</span> <span class="n">LitInt64</span> <span class="mi">0</span><span class="n">L</span>
        <span class="o">|</span> <span class="n">LitUInt8</span> <span class="mi">0</span><span class="n">uy</span> <span class="o">|</span> <span class="n">LitUInt16</span> <span class="mi">0</span><span class="n">us</span> <span class="o">|</span> <span class="n">LitUInt32</span> <span class="mi">0</span><span class="n">u</span> <span class="o">|</span> <span class="n">LitUInt64</span> <span class="mi">0</span><span class="n">UL</span>
        <span class="o">|</span> <span class="n">LitFloat32</span> <span class="mf">0.0</span><span class="n">f</span> <span class="o">|</span> <span class="n">LitFloat64</span> <span class="mf">0.0</span> <span class="o">-&gt;</span> <span class="n">true</span>
        <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">false</span>
    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">false</span>

<span class="n">let</span> <span class="n">is_lit_one</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">DLit</span> <span class="n">a</span> <span class="o">-&gt;</span>
        <span class="k">match</span> <span class="n">a</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">LitInt8</span> <span class="mi">1</span><span class="n">y</span> <span class="o">|</span> <span class="n">LitInt16</span> <span class="mi">1</span><span class="n">s</span> <span class="o">|</span> <span class="n">LitInt32</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">LitInt64</span> <span class="mi">1</span><span class="n">L</span>
        <span class="o">|</span> <span class="n">LitUInt8</span> <span class="mi">1</span><span class="n">uy</span> <span class="o">|</span> <span class="n">LitUInt16</span> <span class="mi">1</span><span class="n">us</span> <span class="o">|</span> <span class="n">LitUInt32</span> <span class="mi">1</span><span class="n">u</span> <span class="o">|</span> <span class="n">LitUInt64</span> <span class="mi">1</span><span class="n">UL</span>
        <span class="o">|</span> <span class="n">LitFloat32</span> <span class="mf">1.0</span><span class="n">f</span> <span class="o">|</span> <span class="n">LitFloat64</span> <span class="mf">1.0</span> <span class="o">-&gt;</span> <span class="n">true</span>
        <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">false</span>
    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">false</span>

<span class="n">let</span> <span class="n">is_int_lit_zero</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">DLit</span> <span class="n">a</span> <span class="o">-&gt;</span>
        <span class="k">match</span> <span class="n">a</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">LitInt8</span> <span class="mi">0</span><span class="n">y</span> <span class="o">|</span> <span class="n">LitInt16</span> <span class="mi">0</span><span class="n">s</span> <span class="o">|</span> <span class="n">LitInt32</span> <span class="mi">0</span> <span class="o">|</span> <span class="n">LitInt64</span> <span class="mi">0</span><span class="n">L</span>
        <span class="o">|</span> <span class="n">LitUInt8</span> <span class="mi">0</span><span class="n">uy</span> <span class="o">|</span> <span class="n">LitUInt16</span> <span class="mi">0</span><span class="n">us</span> <span class="o">|</span> <span class="n">LitUInt32</span> <span class="mi">0</span><span class="n">u</span> <span class="o">|</span> <span class="n">LitUInt64</span> <span class="mi">0</span><span class="n">UL</span> <span class="o">-&gt;</span> <span class="n">true</span>
        <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">false</span>
    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">false</span>

<span class="n">let</span> <span class="n">is_int_lit_one</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">DLit</span> <span class="n">a</span> <span class="o">-&gt;</span>
        <span class="k">match</span> <span class="n">a</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">LitInt8</span> <span class="mi">1</span><span class="n">y</span> <span class="o">|</span> <span class="n">LitInt16</span> <span class="mi">1</span><span class="n">s</span> <span class="o">|</span> <span class="n">LitInt32</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">LitInt64</span> <span class="mi">1</span><span class="n">L</span>
        <span class="o">|</span> <span class="n">LitUInt8</span> <span class="mi">1</span><span class="n">uy</span> <span class="o">|</span> <span class="n">LitUInt16</span> <span class="mi">1</span><span class="n">us</span> <span class="o">|</span> <span class="n">LitUInt32</span> <span class="mi">1</span><span class="n">u</span> <span class="o">|</span> <span class="n">LitUInt64</span> <span class="mi">1</span><span class="n">UL</span> <span class="o">-&gt;</span> <span class="n">true</span>
        <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">false</span>
    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">false</span>

<span class="n">let</span> <span class="n">lit_zero</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">YPrim</span> <span class="n">Int8T</span> <span class="o">-&gt;</span> <span class="n">LitInt8</span> <span class="mi">0</span><span class="n">y</span>
    <span class="o">|</span> <span class="n">YPrim</span> <span class="n">Int16T</span> <span class="o">-&gt;</span> <span class="n">LitInt16</span> <span class="mi">0</span><span class="n">s</span>
    <span class="o">|</span> <span class="n">YPrim</span> <span class="n">Int32T</span> <span class="o">-&gt;</span> <span class="n">LitInt32</span> <span class="mi">0</span>
    <span class="o">|</span> <span class="n">YPrim</span> <span class="n">Int64T</span> <span class="o">-&gt;</span> <span class="n">LitInt64</span> <span class="mi">0</span><span class="n">L</span>
    <span class="o">|</span> <span class="n">YPrim</span> <span class="n">UInt8T</span> <span class="o">-&gt;</span> <span class="n">LitUInt8</span> <span class="mi">0</span><span class="n">uy</span>
    <span class="o">|</span> <span class="n">YPrim</span> <span class="n">UInt16T</span> <span class="o">-&gt;</span> <span class="n">LitUInt16</span> <span class="mi">0</span><span class="n">us</span>
    <span class="o">|</span> <span class="n">YPrim</span> <span class="n">UInt32T</span> <span class="o">-&gt;</span> <span class="n">LitUInt32</span> <span class="mi">0</span><span class="n">u</span>
    <span class="o">|</span> <span class="n">YPrim</span> <span class="n">UInt64T</span> <span class="o">-&gt;</span> <span class="n">LitUInt64</span> <span class="mi">0</span><span class="n">UL</span>
    <span class="o">|</span> <span class="n">YPrim</span> <span class="n">Float32T</span> <span class="o">-&gt;</span> <span class="n">LitFloat32</span> <span class="mf">0.0</span><span class="n">f</span>
    <span class="o">|</span> <span class="n">YPrim</span> <span class="n">Float64T</span> <span class="o">-&gt;</span> <span class="n">LitFloat64</span> <span class="mf">0.0</span>
    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: Expected a numeric value."</span>

<span class="n">let</span> <span class="n">vt</span> <span class="n">s</span> <span class="n">i</span> <span class="o">=</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">.</span><span class="n">env_global_type</span><span class="o">.</span><span class="n">Length</span> <span class="n">then</span> <span class="n">s</span><span class="o">.</span><span class="n">env_global_type</span><span class="o">.</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">else</span> <span class="n">s</span><span class="o">.</span><span class="n">env_stack_type</span><span class="o">.</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">s</span><span class="o">.</span><span class="n">env_global_type</span><span class="o">.</span><span class="n">Length</span><span class="p">]</span>
<span class="n">let</span> <span class="n">v</span> <span class="n">s</span> <span class="n">i</span> <span class="o">=</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">.</span><span class="n">env_global_term</span><span class="o">.</span><span class="n">Length</span> <span class="n">then</span> <span class="n">s</span><span class="o">.</span><span class="n">env_global_term</span><span class="o">.</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">else</span> <span class="n">s</span><span class="o">.</span><span class="n">env_stack_term</span><span class="o">.</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">s</span><span class="o">.</span><span class="n">env_global_term</span><span class="o">.</span><span class="n">Length</span><span class="p">]</span>
<span class="n">let</span> <span class="n">add_trace</span> <span class="p">(</span><span class="n">s</span> <span class="p">:</span> <span class="n">LangEnv</span><span class="p">)</span> <span class="n">r</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span> <span class="k">with</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">r</span> <span class="p">::</span> <span class="n">s</span><span class="o">.</span><span class="n">trace</span><span class="p">}</span>
<span class="n">let</span> <span class="n">store_term</span> <span class="p">(</span><span class="n">s</span> <span class="p">:</span> <span class="n">LangEnv</span><span class="p">)</span> <span class="n">i</span> <span class="n">v</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">env_stack_term</span><span class="o">.</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">s</span><span class="o">.</span><span class="n">env_global_term</span><span class="o">.</span><span class="n">Length</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">v</span>
<span class="n">let</span> <span class="n">store_ty</span> <span class="p">(</span><span class="n">s</span> <span class="p">:</span> <span class="n">LangEnv</span><span class="p">)</span> <span class="n">i</span> <span class="n">v</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">env_stack_type</span><span class="o">.</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">s</span><span class="o">.</span><span class="n">env_global_type</span><span class="o">.</span><span class="n">Length</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">v</span>

<span class="n">let</span> <span class="n">is_unify</span> <span class="n">s</span> <span class="n">x</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">is_metavar</span> <span class="o">=</span> <span class="n">HashSet</span><span class="p">()</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">f</span> <span class="o">=</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">YB</span><span class="p">,</span> <span class="n">YB</span> <span class="o">|</span> <span class="n">YExists</span><span class="p">,</span> <span class="n">YExists</span> <span class="o">|</span> <span class="n">YForall</span><span class="p">,</span> <span class="n">YForall</span> <span class="o">-&gt;</span> <span class="n">true</span>
        <span class="o">|</span> <span class="n">YFun</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">t</span><span class="p">),</span> <span class="n">YFun</span><span class="p">(</span><span class="n">a</span><span class="s1">',b'</span><span class="p">,</span><span class="n">t</span><span class="s1">') -&gt; t = t'</span> <span class="o">&amp;&amp;</span> <span class="n">f</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">a</span><span class="s1">') &amp;&amp; f (b,b'</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">YApply</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">),</span> <span class="n">YApply</span><span class="p">(</span><span class="n">a</span><span class="s1">',b'</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">YPair</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">),</span> <span class="n">YPair</span><span class="p">(</span><span class="n">a</span><span class="s1">',b'</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">a</span><span class="s1">') &amp;&amp; f (b,b'</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">YSymbol</span> <span class="n">a</span><span class="p">,</span> <span class="n">YSymbol</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="o">=</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">YTypeFunction</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">),</span> <span class="n">YTypeFunction</span><span class="p">(</span><span class="n">a</span><span class="s1">',b'</span><span class="p">,</span><span class="n">c</span><span class="s1">',d'</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="s1">' &amp;&amp; Array.forall2 (fun b b'</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="sa">b</span><span class="s1">')) b b'</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="s1">' &amp;&amp; d = d'</span>
        <span class="o">|</span> <span class="n">YRecord</span> <span class="n">a</span><span class="p">,</span> <span class="n">YRecord</span> <span class="n">a</span><span class="s1">' -&gt; Map.forall (fun k v'</span> <span class="o">-&gt;</span> <span class="n">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">k</span> <span class="n">a</span> <span class="k">with</span> <span class="n">Some</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="s1">') | None -&gt; false) a'</span>
        <span class="o">|</span> <span class="n">YPrim</span> <span class="n">a</span><span class="p">,</span> <span class="n">YPrim</span> <span class="n">a</span><span class="s1">' -&gt; a = a'</span>
        <span class="o">|</span> <span class="n">YArray</span> <span class="n">a</span><span class="p">,</span> <span class="n">YArray</span> <span class="n">a</span><span class="s1">' -&gt; f (a, a'</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">YMacro</span> <span class="n">a</span><span class="p">,</span> <span class="n">YMacro</span> <span class="n">a</span><span class="s1">' -&gt;</span>
            <span class="n">List</span><span class="o">.</span><span class="n">forall2</span> <span class="p">(</span><span class="n">fun</span> <span class="n">a</span> <span class="n">a</span><span class="s1">' -&gt;</span>
                <span class="k">match</span> <span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="s1">' with</span>
                <span class="o">|</span> <span class="n">Text</span> <span class="n">a</span><span class="p">,</span> <span class="n">Text</span> <span class="n">a</span><span class="s1">' -&gt; a = a'</span>
                <span class="o">|</span> <span class="n">Type</span> <span class="n">a</span><span class="p">,</span> <span class="n">Type</span> <span class="n">a</span><span class="s1">' -&gt; f (a,a'</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">false</span>
                <span class="p">)</span> <span class="n">a</span> <span class="n">a</span><span class="s1">'</span>
        <span class="o">|</span> <span class="n">YNominal</span> <span class="n">a</span><span class="p">,</span> <span class="n">YNominal</span> <span class="n">a</span><span class="s1">' -&gt; a = a'</span>
        <span class="o">|</span> <span class="n">YLayout</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">),</span> <span class="n">YLayout</span><span class="p">(</span><span class="n">a</span><span class="s1">',b'</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">a</span><span class="s1">') &amp;&amp; b = b'</span>
        <span class="o">|</span> <span class="n">YUnion</span> <span class="n">a</span><span class="p">,</span> <span class="n">YUnion</span> <span class="n">a</span><span class="s1">' -&gt; a = a'</span>
        <span class="o">|</span> <span class="n">YLit</span> <span class="n">a</span><span class="p">,</span> <span class="n">YLit</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="o">=</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="n">YMetavar</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">is_metavar</span><span class="o">.</span><span class="n">Add</span> <span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">store_ty</span> <span class="n">s</span> <span class="n">i</span> <span class="n">a</span><span class="p">;</span> <span class="n">true</span><span class="p">))</span> <span class="o">||</span> <span class="n">a</span> <span class="o">=</span> <span class="n">vt</span> <span class="n">s</span> <span class="n">i</span>
        <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">false</span>
    <span class="n">f</span> <span class="n">x</span>

<span class="nb">type</span> <span class="n">PartEvalResult</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">join_point_method</span> <span class="p">:</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="n">string</span> <span class="n">ConsedNode</span> <span class="o">*</span> <span class="n">E</span><span class="p">,</span><span class="n">Dictionary</span><span class="o">&lt;</span><span class="n">ConsedNode</span><span class="o">&lt;</span><span class="n">RData</span> <span class="p">[]</span> <span class="o">*</span> <span class="n">Ty</span> <span class="p">[]</span><span class="o">&gt;</span><span class="p">,</span><span class="n">TypedBind</span> <span class="p">[]</span> <span class="n">option</span> <span class="o">*</span> <span class="n">Ty</span> <span class="n">option</span> <span class="o">*</span> <span class="n">string</span> <span class="n">option</span><span class="o">&gt;</span> <span class="o">*</span> <span class="n">HashConsTable</span><span class="o">&gt;</span>
    <span class="n">join_point_closure</span> <span class="p">:</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="n">string</span> <span class="n">ConsedNode</span> <span class="o">*</span> <span class="n">E</span><span class="p">,</span><span class="n">Dictionary</span><span class="o">&lt;</span><span class="n">ConsedNode</span><span class="o">&lt;</span><span class="n">RData</span> <span class="p">[]</span> <span class="o">*</span> <span class="n">Ty</span> <span class="p">[]</span> <span class="o">*</span> <span class="n">Ty</span><span class="o">&gt;</span><span class="p">,(</span><span class="n">Data</span> <span class="o">*</span> <span class="n">TypedBind</span> <span class="p">[])</span> <span class="n">option</span><span class="o">&gt;</span> <span class="o">*</span> <span class="n">HashConsTable</span><span class="o">&gt;</span>
    <span class="n">ty_to_data</span> <span class="p">:</span> <span class="n">Ty</span> <span class="o">-&gt;</span> <span class="n">Data</span>
    <span class="n">nominal_apply</span> <span class="p">:</span> <span class="n">Ty</span> <span class="o">-&gt;</span> <span class="n">Ty</span>
    <span class="nb">globals</span> <span class="p">:</span> <span class="n">ResizeArray</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span>
    <span class="p">}</span>



<span class="n">let</span> <span class="n">peval</span> <span class="p">(</span><span class="n">env</span> <span class="p">:</span> <span class="n">PartEvalTopEnv</span><span class="p">)</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">E</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">join_point_method</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Structural</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">join_point_closure</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Structural</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">join_point_type</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Structural</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">backend_strings</span> <span class="o">=</span> <span class="n">HashConsTable</span><span class="p">()</span>

    <span class="n">let</span> <span class="n">rec</span> <span class="n">ty_to_data</span> <span class="n">s</span> <span class="n">x</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">f</span> <span class="o">=</span> <span class="n">ty_to_data</span> <span class="n">s</span>
        <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">YVoid</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="s2">"Compiler error: Cannot construct an instance of a void type."</span>
        <span class="o">|</span> <span class="n">YB</span> <span class="o">-&gt;</span> <span class="n">DB</span>
        <span class="o">|</span> <span class="n">YPair</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DPair</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span> <span class="n">f</span> <span class="n">b</span><span class="p">)</span> 
        <span class="o">|</span> <span class="n">YSymbol</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">DSymbol</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">YRecord</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">DRecord</span><span class="p">(</span><span class="n">Map</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="n">l</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">YForall</span> <span class="o">|</span> <span class="n">YExists</span> <span class="o">|</span> <span class="n">YUnion</span> <span class="n">_</span> <span class="o">|</span> <span class="n">YLayout</span> <span class="n">_</span> <span class="o">|</span> <span class="n">YPrim</span> <span class="n">_</span> <span class="o">|</span> <span class="n">YArray</span> <span class="n">_</span> <span class="o">|</span> <span class="n">YFun</span> <span class="n">_</span> <span class="o">|</span> <span class="n">YMacro</span> <span class="n">_</span> <span class="k">as</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">r</span> <span class="o">=</span> <span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">i</span><span class="o">.</span><span class="n">Value</span><span class="p">,</span><span class="n">x</span><span class="p">))</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">i</span><span class="o">.</span><span class="n">Value</span> <span class="o">&lt;-</span> <span class="n">s</span><span class="o">.</span><span class="n">i</span><span class="o">.</span><span class="n">Value</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">r</span>
        <span class="o">|</span> <span class="n">YNominal</span> <span class="n">_</span> <span class="o">|</span> <span class="n">YApply</span> <span class="n">_</span> <span class="k">as</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">nominal_type_apply</span> <span class="n">s</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">ty_to_data</span> <span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">YLit</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">DTLit</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">YTypeFunction</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="s2">"Cannot turn a type function into a runtime variable."</span>
        <span class="o">|</span> <span class="n">YMetavar</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="s2">"Compiler error: Cannot turn a metavar into a runtime variable."</span>
    <span class="ow">and</span> <span class="n">assert_ty_lit</span> <span class="n">s</span> <span class="o">=</span> <span class="n">function</span> 
        <span class="o">|</span> <span class="n">YSymbol</span> <span class="n">_</span> <span class="o">|</span> <span class="n">YLit</span> <span class="n">_</span> <span class="k">as</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">YNominal</span> <span class="n">_</span> <span class="o">|</span> <span class="n">YApply</span> <span class="n">_</span> <span class="k">as</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">nominal_type_apply</span> <span class="n">s</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">assert_ty_lit</span> <span class="n">s</span>
        <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a type literal or a symbol.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">x</span><span class="p">)</span>
    <span class="ow">and</span> <span class="n">push_typedop_no_rewrite</span> <span class="n">d</span> <span class="n">op</span> <span class="n">ret_ty</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">ty_to_data</span> <span class="n">d</span> <span class="n">ret_ty</span>
        <span class="n">d</span><span class="o">.</span><span class="n">seq</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">TyLet</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span><span class="n">d</span><span class="o">.</span><span class="n">trace</span><span class="p">,</span><span class="n">op</span><span class="p">))</span>
        <span class="n">ret</span>
    <span class="ow">and</span> <span class="n">push_typedop</span> <span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="n">LangEnv</span><span class="p">)</span> <span class="n">key</span> <span class="n">ret_ty</span> <span class="o">=</span>
        <span class="k">match</span> <span class="n">cse_tryfind</span> <span class="n">d</span> <span class="n">key</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">Some</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span>
        <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">ty_to_data</span> <span class="n">d</span> <span class="n">ret_ty</span>
            <span class="n">d</span><span class="o">.</span><span class="n">seq</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">TyLet</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">d</span><span class="o">.</span><span class="n">trace</span><span class="p">,</span><span class="n">key</span><span class="p">))</span>
            <span class="n">cse_add</span> <span class="n">d</span> <span class="n">key</span> <span class="n">x</span>
            <span class="n">x</span>
    <span class="ow">and</span> <span class="n">push_op_no_rewrite</span><span class="s1">' (d: LangEnv) op l ret_ty = push_typedop_no_rewrite d (TyOp(op,l)) ret_ty</span>
    <span class="ow">and</span> <span class="n">push_op_no_rewrite</span> <span class="n">d</span> <span class="n">op</span> <span class="n">a</span> <span class="n">ret_ty</span> <span class="o">=</span> <span class="n">push_op_no_rewrite</span><span class="s1">' d op [a] ret_ty</span>
    <span class="ow">and</span> <span class="n">push_binop_no_rewrite</span> <span class="n">d</span> <span class="n">op</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="n">ret_ty</span> <span class="o">=</span> <span class="n">push_op_no_rewrite</span><span class="s1">' d op [a;b] ret_ty</span>
    <span class="ow">and</span> <span class="n">push_triop_no_rewrite</span> <span class="n">d</span> <span class="n">op</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="n">ret_ty</span> <span class="o">=</span> <span class="n">push_op_no_rewrite</span><span class="s1">' d op [a;b;c] ret_ty</span>

    <span class="ow">and</span> <span class="n">push_op</span><span class="s1">' d op a ret_ty = push_typedop d (TyOp(op, a)) ret_ty</span>
    <span class="ow">and</span> <span class="n">push_op</span> <span class="n">d</span> <span class="n">op</span> <span class="n">a</span> <span class="n">ret_ty</span> <span class="o">=</span> <span class="n">push_op</span><span class="s1">' d op [a] ret_ty</span>
    <span class="ow">and</span> <span class="n">push_binop</span> <span class="n">d</span> <span class="n">op</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="n">ret_ty</span> <span class="o">=</span> <span class="n">push_op</span><span class="s1">' d op [a;b] ret_ty</span>
    <span class="ow">and</span> <span class="n">push_triop</span> <span class="n">d</span> <span class="n">op</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="n">ret_ty</span> <span class="o">=</span> <span class="n">push_op</span><span class="s1">' d op [a;b;c] ret_ty</span>
    <span class="ow">and</span> <span class="n">closure_env</span> <span class="n">s</span> <span class="p">(</span><span class="n">body</span><span class="p">,</span><span class="n">annot</span><span class="p">,</span><span class="n">gl_term</span><span class="p">,</span><span class="n">gl_ty</span><span class="p">,</span><span class="n">sz_term</span><span class="p">,</span><span class="n">sz_ty</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">trace</span>
        <span class="n">seq</span> <span class="o">=</span> <span class="n">ResizeArray</span><span class="p">()</span>
        <span class="n">cse</span> <span class="o">=</span> <span class="p">[</span><span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Structural</span><span class="p">)]</span>
        <span class="n">unions</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>
        <span class="n">env_global_type</span> <span class="o">=</span> <span class="n">gl_ty</span>
        <span class="n">env_global_term</span> <span class="o">=</span> <span class="n">gl_term</span>
        <span class="n">env_stack_type</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">zeroCreate</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;</span> <span class="n">sz_ty</span>
        <span class="n">env_stack_term</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">zeroCreate</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;</span> <span class="n">sz_term</span>
        <span class="n">backend</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">backend</span>
        <span class="nb">globals</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">globals</span>
        <span class="p">}</span>
    <span class="ow">and</span> <span class="n">closure_convert</span> <span class="n">s</span> <span class="p">(</span><span class="n">body</span><span class="p">,</span><span class="n">annot</span><span class="p">,</span><span class="n">gl_term</span><span class="p">,</span><span class="n">gl_ty</span><span class="p">,</span><span class="n">sz_term</span><span class="p">,</span><span class="n">sz_ty</span> <span class="k">as</span> <span class="n">args</span><span class="p">)</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">join_point_key</span><span class="p">,</span> <span class="n">call_args</span><span class="p">,</span> <span class="n">fun_ty</span> <span class="o">=</span>
            <span class="n">let</span> <span class="n">s</span> <span class="p">:</span> <span class="n">LangEnv</span> <span class="o">=</span> <span class="n">closure_env</span> <span class="n">s</span> <span class="n">args</span>
            <span class="n">let</span> <span class="n">domain</span><span class="p">,</span> <span class="nb">range</span><span class="p">,</span> <span class="n">fun_ty</span> <span class="o">=</span> 
                <span class="k">match</span> <span class="n">ty</span> <span class="n">s</span> <span class="n">annot</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">YFun</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="k">as</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">x</span>
                <span class="o">|</span> <span class="n">annot</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a function type in annotation during closure conversion. Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">annot</span><span class="p">)</span>
            <span class="n">let</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">hc_table</span> <span class="o">=</span> <span class="n">memoize</span> <span class="n">join_point_closure</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Structural</span><span class="p">),</span> <span class="n">HashConsTable</span><span class="p">())</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">backend</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
            <span class="n">let</span> <span class="n">call_args</span><span class="p">,</span> <span class="n">env_global_value</span> <span class="o">=</span> <span class="n">data_to_rdata</span> <span class="n">s</span> <span class="n">hc_table</span> <span class="n">gl_term</span>
            <span class="n">let</span> <span class="n">join_point_key</span> <span class="o">=</span> <span class="n">hc_table</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">env_global_value</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">env_global_type</span><span class="p">,</span> <span class="n">fun_ty</span><span class="p">)</span>

            <span class="k">match</span> <span class="n">fun_ty</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">YFun</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">FT_Pointer</span><span class="p">)</span> <span class="n">when</span> <span class="n">call_args</span><span class="o">.</span><span class="n">Length</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="s2">"Function pointers shouldn't have any runtime free variables in their environment."</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="p">()</span>

            <span class="k">match</span> <span class="nb">dict</span><span class="o">.</span><span class="n">TryGetValue</span><span class="p">(</span><span class="n">join_point_key</span><span class="p">)</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">true</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="p">()</span>
            <span class="o">|</span> <span class="n">false</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">rename_global_term</span> <span class="n">s</span>
                <span class="n">let</span> <span class="n">domain_data</span> <span class="o">=</span> <span class="n">ty_to_data</span> <span class="n">s</span> <span class="n">domain</span>
                <span class="n">s</span><span class="o">.</span><span class="n">env_stack_term</span><span class="o">.</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">domain_data</span>
                <span class="nb">dict</span><span class="o">.</span><span class="p">[</span><span class="n">join_point_key</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="kc">None</span>
                <span class="n">let</span> <span class="n">seq</span><span class="p">,</span><span class="n">ty</span> <span class="o">=</span> <span class="n">term_scope</span><span class="s1">''</span> <span class="n">s</span> <span class="n">body</span> <span class="p">(</span><span class="n">Some</span> <span class="n">fun_ty</span><span class="p">)</span>
                <span class="nb">dict</span><span class="o">.</span><span class="p">[</span><span class="n">join_point_key</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">Some</span><span class="p">(</span><span class="n">domain_data</span><span class="p">,</span> <span class="n">seq</span><span class="p">)</span>
                <span class="n">let</span> <span class="n">ty</span> <span class="o">=</span>
                    <span class="k">match</span> <span class="n">ty</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">YRecord</span> <span class="n">a</span> <span class="o">-&gt;</span>
                        <span class="n">a</span>
                        <span class="o">|&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">KeyValue</span> <span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span> <span class="n">v</span><span class="p">))</span> <span class="o">-&gt;</span>
                            <span class="n">let</span> <span class="n">i</span> <span class="o">=</span>
                                <span class="k">match</span> <span class="nb">range</span> <span class="k">with</span>
                                <span class="o">|</span> <span class="n">YRecord</span> <span class="n">a</span> <span class="o">-&gt;</span>
                                    <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryPick</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">i</span><span class="s1">', k'</span><span class="p">)</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="s1">' then Some i'</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="kc">None</span>
                                <span class="o">|&gt;</span> <span class="n">Option</span><span class="o">.</span><span class="n">defaultValue</span> <span class="n">i</span>
                            <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span> <span class="n">v</span>
                        <span class="p">)</span>
                        <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">ofSeq</span>
                        <span class="o">|&gt;</span> <span class="n">YRecord</span>
                    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">ty</span>
                <span class="k">if</span> <span class="nb">range</span> <span class="o">&lt;&gt;</span> <span class="n">ty</span> <span class="n">then</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The annotation of the function does not match its body's type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">Expected: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">ty</span><span class="p">)</span> <span class="p">(</span><span class="n">show_ty</span> <span class="nb">range</span><span class="p">)</span>
            <span class="n">join_point_key</span><span class="p">,</span> <span class="n">call_args</span><span class="p">,</span> <span class="n">fun_ty</span>
        <span class="n">push_typedop</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyJoinPoint</span><span class="p">(</span><span class="n">JPClosure</span><span class="p">((</span><span class="n">s</span><span class="o">.</span><span class="n">backend</span><span class="p">,</span><span class="n">body</span><span class="p">),</span><span class="n">join_point_key</span><span class="p">),</span><span class="n">call_args</span><span class="p">))</span> <span class="n">fun_ty</span><span class="p">,</span> <span class="n">fun_ty</span>
    <span class="ow">and</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">x</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">m</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Reference</span><span class="p">)</span>
        <span class="n">let</span> <span class="n">rec</span> <span class="n">f</span> <span class="n">x</span> <span class="o">=</span>
            <span class="n">memoize</span> <span class="n">m</span> <span class="p">(</span><span class="n">function</span>
                <span class="o">|</span> <span class="n">DPair</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">YPair</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span> <span class="n">f</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">DSymbol</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">YSymbol</span> <span class="n">a</span>
                <span class="o">|</span> <span class="n">DRecord</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">YRecord</span><span class="p">(</span><span class="n">Map</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="n">l</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">DUnion</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">YUnion</span> <span class="n">a</span>
                <span class="o">|</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">a</span>
                <span class="o">|</span> <span class="n">DLit</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">lit_to_ty</span> <span class="n">x</span>
                <span class="o">|</span> <span class="n">DTLit</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">YLit</span> <span class="n">x</span>
                <span class="o">|</span> <span class="n">DB</span> <span class="o">-&gt;</span> <span class="n">YB</span>
                <span class="o">|</span> <span class="n">DFunction</span><span class="p">(</span><span class="n">body</span><span class="p">,</span><span class="n">Some</span> <span class="n">annot</span><span class="p">,</span><span class="n">gl_term</span><span class="p">,</span><span class="n">gl_ty</span><span class="p">,</span><span class="n">sz_term</span><span class="p">,</span><span class="n">sz_ty</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ty</span> <span class="p">(</span><span class="n">closure_env</span> <span class="n">s</span> <span class="p">(</span><span class="n">body</span><span class="p">,</span><span class="n">annot</span><span class="p">,</span><span class="n">gl_term</span><span class="p">,</span><span class="n">gl_ty</span><span class="p">,</span><span class="n">sz_term</span><span class="p">,</span><span class="n">sz_ty</span><span class="p">))</span> <span class="n">annot</span>
                <span class="o">|</span> <span class="n">DExists</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">YExists</span>
                <span class="o">|</span> <span class="n">DFunction</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="s2">"Cannot convert a function that is not annotated into a type."</span>
                <span class="o">|</span> <span class="n">DForall</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">YForall</span>
                <span class="o">|</span> <span class="n">DHashSet</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="s2">"Cannot convert a compile time HashSet into a type."</span>
                <span class="o">|</span> <span class="n">DHashMap</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="s2">"Cannot convert a compile time HashMap into a type."</span>
                <span class="p">)</span> <span class="n">x</span>
        <span class="n">f</span> <span class="n">x</span>
    <span class="ow">and</span> <span class="n">dyn</span> <span class="n">do_lit</span> <span class="n">s</span> <span class="n">x</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">m</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Reference</span><span class="p">)</span>
        <span class="n">let</span> <span class="n">mutable</span> <span class="n">dirty</span> <span class="o">=</span> <span class="n">false</span>
        <span class="n">let</span> <span class="n">rec</span> <span class="n">f</span> <span class="n">x</span> <span class="o">=</span>
            <span class="n">memoize</span> <span class="n">m</span> <span class="p">(</span><span class="n">function</span>
                <span class="o">|</span> <span class="n">DPair</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DPair</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span> <span class="n">f</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">DB</span> <span class="o">|</span> <span class="n">DV</span> <span class="n">_</span> <span class="o">|</span> <span class="n">DTLit</span> <span class="n">_</span> <span class="o">|</span> <span class="n">DSymbol</span> <span class="n">_</span> <span class="k">as</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span>
                <span class="o">|</span> <span class="n">DRecord</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">DRecord</span><span class="p">(</span><span class="n">Map</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="n">l</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">DUnion</span><span class="p">(</span><span class="n">DPair</span><span class="p">(</span><span class="n">DSymbol</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">),</span><span class="n">b</span><span class="p">),</span><span class="sa">b</span><span class="s1">') -&gt; dirty &lt;- true; push_typedop_no_rewrite s (TyUnionBox(k,f v,b)) b'</span>
                <span class="o">|</span> <span class="n">DUnion</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="s2">"Compiler error: Malformed union"</span>
                <span class="o">|</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">f</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitString</span> <span class="n">_</span> <span class="k">as</span> <span class="n">v</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dirty</span> <span class="o">&lt;-</span> <span class="n">true</span><span class="p">;</span> <span class="n">push_op</span> <span class="n">s</span> <span class="n">Dyn</span> <span class="n">x</span> <span class="p">(</span><span class="n">lit_to_ty</span> <span class="n">v</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">DLit</span> <span class="n">v</span> <span class="k">as</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">do_lit</span> <span class="n">then</span> <span class="n">dirty</span> <span class="o">&lt;-</span> <span class="n">true</span><span class="p">;</span> <span class="n">push_op_no_rewrite</span> <span class="n">s</span> <span class="n">Dyn</span> <span class="n">x</span> <span class="p">(</span><span class="n">lit_to_ty</span> <span class="n">v</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span>
                <span class="o">|</span> <span class="n">DFunction</span><span class="p">(</span><span class="n">body</span><span class="p">,</span><span class="n">Some</span> <span class="n">annot</span><span class="p">,</span><span class="n">term</span><span class="s1">',ty'</span><span class="p">,</span><span class="n">sz_term</span><span class="p">,</span><span class="n">sz_ty</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">dirty</span> <span class="o">&lt;-</span> <span class="n">true</span><span class="p">;</span> <span class="n">closure_convert</span> <span class="n">s</span> <span class="p">(</span><span class="n">body</span><span class="p">,</span><span class="n">annot</span><span class="p">,</span><span class="n">term</span><span class="s1">',ty'</span><span class="p">,</span><span class="n">sz_term</span><span class="p">,</span><span class="n">sz_ty</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">fst</span>
                <span class="o">|</span> <span class="n">DFunction</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="s2">"Cannot convert a function that is not annotated into a runtime variable."</span>
                <span class="o">|</span> <span class="n">DExists</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="s2">"Cannot dyn an existential into a runtime var."</span>
                <span class="o">|</span> <span class="n">DForall</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="s2">"Cannot dyn a forall into a runtime var."</span>
                <span class="o">|</span> <span class="n">DHashSet</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="s2">"Cannot dyn a compile time HashSet into a runtime var."</span>
                <span class="o">|</span> <span class="n">DHashMap</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="s2">"Cannot dyn a compile time HashMap into a runtime var."</span>
                <span class="p">)</span> <span class="n">x</span>
        <span class="n">let</span> <span class="n">v</span> <span class="o">=</span> <span class="n">f</span> <span class="n">x</span>
        <span class="k">if</span> <span class="n">dirty</span> <span class="n">then</span> <span class="n">v</span> <span class="k">else</span> <span class="n">x</span>
    <span class="ow">and</span> <span class="n">term_real_nominal</span> <span class="n">s</span> <span class="n">x</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span> <span class="k">with</span> <span class="n">seq</span><span class="o">=</span><span class="n">ResizeArray</span><span class="p">();</span> <span class="n">cse</span><span class="o">=</span><span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Structural</span><span class="p">)</span> <span class="p">::</span> <span class="n">s</span><span class="o">.</span><span class="n">cse</span><span class="p">}</span>
        <span class="n">term</span> <span class="n">s</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">data_to_ty</span> <span class="n">s</span>
    <span class="ow">and</span> <span class="n">term_scope</span><span class="s1">''</span> <span class="n">s</span> <span class="n">x</span> <span class="n">fun_ty</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">term</span> <span class="n">s</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">dyn</span> <span class="n">false</span> <span class="n">s</span>
        <span class="n">let</span> <span class="n">x</span> <span class="o">=</span>
            <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DRecord</span> <span class="n">c</span> <span class="o">-&gt;</span>
                <span class="n">c</span>
                <span class="o">|&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">KeyValue</span> <span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span> <span class="n">v</span><span class="p">))</span> <span class="o">-&gt;</span>
                    <span class="n">let</span> <span class="n">i</span> <span class="o">=</span>
                        <span class="k">match</span> <span class="n">fun_ty</span> <span class="k">with</span>
                        <span class="o">|</span> <span class="n">Some</span> <span class="p">(</span><span class="n">YFun</span> <span class="p">(</span><span class="n">YNominal</span> <span class="n">_</span><span class="p">,</span> <span class="n">YRecord</span> <span class="n">a</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">YRecord</span> <span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span>
                            <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryPick</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">i</span><span class="s1">', k'</span><span class="p">)</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="s1">' then Some i'</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="kc">None</span>
                        <span class="o">|&gt;</span> <span class="n">Option</span><span class="o">.</span><span class="n">defaultValue</span> <span class="n">i</span>
                    <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span> <span class="n">v</span>
                <span class="p">)</span>
                <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">ofSeq</span>
                <span class="o">|&gt;</span> <span class="n">DRecord</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">x</span>
        <span class="n">let</span> <span class="n">x_ty</span> <span class="o">=</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">x</span>
        <span class="n">seq_apply</span> <span class="n">s</span> <span class="n">x</span><span class="p">,</span> <span class="n">x_ty</span>
    <span class="ow">and</span> <span class="n">term_scope</span><span class="s1">' s cse x = term_scope'' {s with seq=ResizeArray(); cse=cse :: s.cse} x None</span>
    <span class="ow">and</span> <span class="n">term_scope</span> <span class="n">s</span> <span class="n">x</span> <span class="o">=</span> <span class="n">term_scope</span><span class="s1">' s (Dictionary(HashIdentity.Structural)) x</span>
    <span class="ow">and</span> <span class="n">nominal_type_apply</span> <span class="n">s</span> <span class="n">x</span> <span class="o">=</span>
        <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">YApply</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">nominal_type_apply</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">YTypeFunction</span><span class="p">(</span><span class="n">body</span><span class="p">,</span><span class="n">gl_ty</span><span class="p">,</span><span class="n">sz_term</span><span class="p">,</span><span class="n">sz_ty</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">s</span> <span class="o">=</span>
                    <span class="p">{</span><span class="n">s</span> <span class="k">with</span>
                        <span class="n">env_global_type</span> <span class="o">=</span> <span class="n">gl_ty</span>
                        <span class="n">env_global_term</span> <span class="o">=</span> <span class="p">[</span><span class="o">||</span><span class="p">]</span>
                        <span class="n">env_stack_type</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">zeroCreate</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;</span> <span class="n">sz_ty</span>
                        <span class="n">env_stack_term</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">zeroCreate</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;</span> <span class="n">sz_term</span>
                        <span class="p">}</span>
                <span class="n">s</span><span class="o">.</span><span class="n">env_stack_type</span><span class="o">.</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">b</span>
                <span class="n">ty</span> <span class="n">s</span> <span class="n">body</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a type level function in nominal application.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">YNominal</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">ty</span> <span class="n">s</span> <span class="n">a</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">body</span>
        <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a nominal or a deferred type apply.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">x</span><span class="p">)</span>
    <span class="ow">and</span> <span class="n">ty</span> <span class="n">s</span> <span class="n">x</span> <span class="o">=</span>
        <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">TPatternRef</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: TPatternRef should have been eliminated during the prepass."</span>
        <span class="o">|</span> <span class="n">TForall</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TArrow</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TJoinPoint</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: Should have been transformed during the prepass."</span>
        <span class="o">|</span> <span class="n">TMetaV</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">YMetavar</span> <span class="n">i</span>
        <span class="o">|</span> <span class="n">TArrow</span><span class="s1">'(scope,i,body) -&gt; </span>
            <span class="k">assert</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="n">free_vars</span><span class="o">.</span><span class="n">Length</span><span class="p">)</span>
            <span class="n">YTypeFunction</span><span class="p">(</span><span class="n">body</span><span class="p">,</span><span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">vt</span> <span class="n">s</span><span class="p">)</span> <span class="n">scope</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="n">free_vars</span><span class="p">,</span><span class="n">scope</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">stack_size</span><span class="p">,</span><span class="n">scope</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="n">stack_size</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TForall</span><span class="s1">' _ -&gt; YForall</span>
        <span class="o">|</span> <span class="n">TExists</span> <span class="o">-&gt;</span> <span class="n">YExists</span>
        <span class="o">|</span> <span class="n">TJoinPoint</span><span class="s1">'(r,scope,body) -&gt;</span>
            <span class="n">let</span> <span class="n">env_global_type</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">vt</span> <span class="n">s</span><span class="p">)</span> <span class="n">scope</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="n">free_vars</span>
            <span class="n">let</span> <span class="n">env_global_term</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">v</span> <span class="n">s</span><span class="p">)</span> <span class="n">scope</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">free_vars</span>

            <span class="n">let</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">hc_table</span> <span class="o">=</span> <span class="n">memoize</span> <span class="n">join_point_type</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Structural</span><span class="p">),</span> <span class="n">HashConsTable</span><span class="p">())</span> <span class="n">body</span>
            <span class="n">let</span> <span class="n">join_point_key</span> <span class="o">=</span> <span class="n">hc_table</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">env_global_type</span><span class="p">)</span>
            <span class="k">match</span> <span class="nb">dict</span><span class="o">.</span><span class="n">TryGetValue</span><span class="p">(</span><span class="n">join_point_key</span><span class="p">)</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">true</span><span class="p">,</span> <span class="n">Some</span> <span class="n">ret_ty</span> <span class="o">-&gt;</span> <span class="n">ret_ty</span>
            <span class="o">|</span> <span class="n">true</span><span class="p">,</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="p">(</span><span class="n">add_trace</span> <span class="n">s</span> <span class="n">r</span><span class="p">)</span> <span class="s2">"Type join points must not be unboxed during their definition."</span>
            <span class="o">|</span> <span class="n">false</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span>
                <span class="k">assert</span> <span class="p">(</span><span class="mi">0</span> <span class="o">=</span> <span class="n">scope</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">free_vars</span><span class="o">.</span><span class="n">Length</span><span class="p">)</span>
                <span class="n">let</span> <span class="n">s</span> <span class="p">:</span> <span class="n">LangEnv</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">r</span> <span class="p">::</span> <span class="n">s</span><span class="o">.</span><span class="n">trace</span>
                    <span class="n">seq</span> <span class="o">=</span> <span class="n">ResizeArray</span><span class="p">()</span>
                    <span class="n">cse</span> <span class="o">=</span> <span class="p">[</span><span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Structural</span><span class="p">)]</span>
                    <span class="n">unions</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>
                    <span class="n">env_global_type</span> <span class="o">=</span> <span class="n">env_global_type</span>
                    <span class="n">env_global_term</span> <span class="o">=</span> <span class="n">env_global_term</span>
                    <span class="n">env_stack_type</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">zeroCreate</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;</span> <span class="n">scope</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="n">stack_size</span>
                    <span class="n">env_stack_term</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">zeroCreate</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;</span> <span class="n">scope</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">stack_size</span>
                    <span class="n">backend</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">backend</span>
                    <span class="nb">globals</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">globals</span>
                    <span class="p">}</span>
                <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">rename_global_term</span> <span class="n">s</span>
                <span class="nb">dict</span><span class="o">.</span><span class="p">[</span><span class="n">join_point_key</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="kc">None</span>
                <span class="n">let</span> <span class="n">ret_ty</span> <span class="o">=</span> <span class="n">ty</span> <span class="n">s</span> <span class="n">body</span>
                <span class="nb">dict</span><span class="o">.</span><span class="p">[</span><span class="n">join_point_key</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">Some</span> <span class="n">ret_ty</span>
                <span class="n">ret_ty</span>
        <span class="o">|</span> <span class="n">TB</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">YB</span>
        <span class="o">|</span> <span class="n">TLit</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">YLit</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">TV</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">vt</span> <span class="n">s</span> <span class="n">i</span>
        <span class="o">|</span> <span class="n">TPair</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">YPair</span><span class="p">(</span><span class="n">ty</span> <span class="n">s</span> <span class="n">a</span><span class="p">,</span> <span class="n">ty</span> <span class="n">s</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TFun</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">YFun</span><span class="p">(</span><span class="n">ty</span> <span class="n">s</span> <span class="n">a</span><span class="p">,</span> <span class="n">ty</span> <span class="n">s</span> <span class="n">b</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TModule</span> <span class="n">a</span> <span class="o">-&gt;</span>
            <span class="n">YRecord</span><span class="p">(</span>
                <span class="n">a</span>
                <span class="o">|&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">mapi</span> <span class="p">(</span><span class="n">fun</span> <span class="n">i</span> <span class="p">(</span><span class="n">KeyValue</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span> <span class="p">(</span><span class="n">v</span> <span class="o">|&gt;</span> <span class="n">ty</span> <span class="n">s</span><span class="p">))</span>
                <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">ofSeq</span>
            <span class="p">)</span>
        <span class="o">|</span> <span class="n">TRecord</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">YRecord</span><span class="p">(</span><span class="n">Map</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">ty</span> <span class="n">s</span><span class="p">)</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TUnion</span><span class="p">(</span><span class="n">_</span><span class="p">,(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">tags</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">()</span>
            <span class="n">let</span> <span class="n">tag_cases</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">zeroCreate</span> <span class="p">(</span><span class="n">Map</span><span class="o">.</span><span class="n">count</span> <span class="n">a</span><span class="p">)</span>
            <span class="n">let</span> <span class="n">mutable</span> <span class="n">is_degenerate</span> <span class="o">=</span> <span class="n">true</span>
            <span class="n">let</span> <span class="n">cases</span> <span class="o">=</span>
                <span class="n">Map</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">cases</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="n">v</span> <span class="o">-&gt;</span>
                    <span class="n">let</span> <span class="n">v</span> <span class="o">=</span> <span class="n">Option</span><span class="o">.</span><span class="n">defaultValue</span> <span class="p">(</span><span class="n">fst</span> <span class="n">v</span><span class="p">)</span> <span class="p">(</span><span class="n">snd</span> <span class="n">v</span><span class="p">)</span> <span class="o">//</span> <span class="n">If</span> <span class="n">the</span> <span class="n">union</span> <span class="n">case</span> <span class="ow">is</span> <span class="n">generalized</span><span class="p">,</span> <span class="n">use</span> <span class="n">the</span> <span class="n">specialized</span> <span class="n">destructor</span> <span class="n">instead</span> <span class="n">of</span> <span class="n">the</span> <span class="n">constructor</span> <span class="n">to</span> <span class="n">evaluate</span> <span class="n">the</span> <span class="nb">type</span><span class="o">.</span>
                    <span class="k">match</span> <span class="n">ty</span> <span class="n">s</span> <span class="n">v</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">YVoid</span> <span class="o">-&gt;</span> <span class="n">cases</span>
                    <span class="o">|</span> <span class="n">v</span> <span class="o">-&gt;</span>
                        <span class="n">is_degenerate</span> <span class="o">&lt;-</span> <span class="n">is_degenerate</span> <span class="o">&amp;&amp;</span> <span class="n">match</span> <span class="n">v</span> <span class="k">with</span> <span class="n">YB</span> <span class="o">-&gt;</span> <span class="n">true</span> <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">false</span>
                        <span class="n">tags</span><span class="o">.</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">i</span>
                        <span class="n">tag_cases</span><span class="o">.</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
                        <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="n">v</span> <span class="n">cases</span>
                    <span class="p">)</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span> <span class="n">a</span>
            <span class="n">YUnion</span><span class="p">(</span><span class="n">H</span> <span class="p">{</span><span class="o">|</span><span class="n">cases</span><span class="o">=</span><span class="n">cases</span><span class="p">;</span> <span class="n">layout</span><span class="o">=</span><span class="n">b</span><span class="p">;</span> <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">;</span> <span class="n">tag_cases</span><span class="o">=</span><span class="n">tag_cases</span><span class="p">;</span> <span class="n">is_degenerate</span><span class="o">=</span><span class="n">is_degenerate</span><span class="o">|</span><span class="p">})</span>
        <span class="o">|</span> <span class="n">TTypecase</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">add_trace</span> <span class="n">s</span> <span class="n">r</span>
            <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">ty</span> <span class="n">s</span> <span class="n">a</span>
            <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="o">=</span> <span class="n">function</span>
                <span class="o">|</span> <span class="p">(</span><span class="n">a</span><span class="s1">',b) :: rest -&gt; if is_unify s (a,ty s a'</span><span class="p">)</span> <span class="n">then</span> <span class="n">Some</span><span class="p">(</span><span class="n">ty</span> <span class="n">s</span> <span class="n">b</span><span class="p">)</span> <span class="k">else</span> <span class="n">loop</span> <span class="n">rest</span>
                <span class="o">|</span> <span class="p">[]</span> <span class="o">-&gt;</span> <span class="kc">None</span>
            <span class="k">match</span> <span class="n">loop</span> <span class="n">b</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">Some</span> <span class="n">r</span> <span class="o">-&gt;</span> <span class="n">r</span>
            <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">YVoid</span>
        <span class="o">|</span> <span class="n">TSymbol</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">YSymbol</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">TApply</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">add_trace</span> <span class="n">s</span> <span class="n">r</span>
            <span class="k">match</span> <span class="n">ty</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">YRecord</span> <span class="n">a</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">ty</span> <span class="n">s</span> <span class="n">b</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">YSymbol</span> <span class="n">b</span> <span class="o">-&gt;</span>
                    <span class="k">match</span><span class="w"> </span><span class="n">a</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryPick</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="k">_</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">k</span> <span class="o">=</span> <span class="n">b</span> <span class="n">then</span> <span class="n">Some</span> <span class="n">v</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">Some</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span>
                    <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span>  <span class="s2">"Cannot find key </span><span class="si">%s</span><span class="s2"> in the record."</span> <span class="n">b</span>
                <span class="o">|</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a symbol in the record application.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">YMetavar</span> <span class="n">_</span> <span class="o">|</span> <span class="n">YNominal</span> <span class="n">_</span> <span class="o">|</span> <span class="n">YApply</span> <span class="n">_</span> <span class="k">as</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">YApply</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">ty</span> <span class="n">s</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">YTypeFunction</span><span class="p">(</span><span class="n">body</span><span class="p">,</span><span class="n">gl_ty</span><span class="p">,</span><span class="n">sz_term</span><span class="p">,</span><span class="n">sz_ty</span><span class="p">)</span> <span class="o">-&gt;</span> 
                <span class="n">let</span> <span class="n">b</span> <span class="o">=</span> <span class="n">ty</span> <span class="n">s</span> <span class="n">b</span>
                <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> 
                    <span class="p">{</span><span class="n">s</span> <span class="k">with</span> 
                        <span class="n">env_global_type</span> <span class="o">=</span> <span class="n">gl_ty</span>
                        <span class="n">env_global_term</span> <span class="o">=</span> <span class="p">[</span><span class="o">||</span><span class="p">]</span>
                        <span class="n">env_stack_type</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">zeroCreate</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;</span> <span class="n">sz_ty</span>
                        <span class="n">env_stack_term</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">zeroCreate</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;</span> <span class="n">sz_term</span>
                        <span class="p">}</span>
                <span class="n">s</span><span class="o">.</span><span class="n">env_stack_type</span><span class="o">.</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">b</span>
                <span class="n">ty</span> <span class="n">s</span> <span class="n">body</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a record, nominal or a type function. Or a metavar when in typecase.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TPrim</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">YPrim</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">TTerm</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">term_real_nominal</span> <span class="n">s</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">TMacro</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> 
            <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">add_trace</span> <span class="n">s</span> <span class="n">r</span>
            <span class="n">YMacro</span><span class="p">(</span><span class="n">a</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">function</span> <span class="n">TMText</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">Text</span> <span class="n">a</span> <span class="o">|</span> <span class="n">TMType</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">(</span><span class="n">ty</span> <span class="n">s</span> <span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">TMLitType</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">TypeLit</span><span class="p">(</span><span class="n">ty</span> <span class="n">s</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">assert_ty_lit</span> <span class="n">s</span><span class="p">)))</span>
        <span class="o">|</span> <span class="n">TNominal</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">YNominal</span> <span class="n">env</span><span class="o">.</span><span class="n">nominals</span><span class="o">.</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="o">|</span> <span class="n">TArray</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">YArray</span><span class="p">(</span><span class="n">ty</span> <span class="n">s</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TLayout</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">YLayout</span><span class="p">(</span><span class="n">ty</span> <span class="n">s</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
    <span class="ow">and</span> <span class="n">term</span> <span class="p">(</span><span class="n">s</span> <span class="p">:</span> <span class="n">LangEnv</span><span class="p">)</span> <span class="n">x</span> <span class="o">=</span> 

        <span class="n">let</span> <span class="k">global</span><span class="s1">' =</span>
            <span class="n">let</span> <span class="n">has_added</span> <span class="o">=</span> <span class="n">HashSet</span> <span class="n">s</span><span class="o">.</span><span class="n">globals</span>
            <span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">has_added</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="n">then</span> <span class="n">s</span><span class="o">.</span><span class="n">globals</span><span class="o">.</span><span class="n">Add</span> <span class="n">x</span>

        <span class="n">let</span> <span class="n">term2</span> <span class="n">s</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span><span class="p">,</span> <span class="n">term</span> <span class="n">s</span> <span class="n">b</span>
        <span class="n">let</span> <span class="n">term3</span> <span class="n">s</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="o">=</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span><span class="p">,</span> <span class="n">term</span> <span class="n">s</span> <span class="n">b</span><span class="p">,</span> <span class="n">term</span> <span class="n">s</span> <span class="n">c</span>
        <span class="n">let</span> <span class="n">type_apply</span> <span class="n">s</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span>
            <span class="k">match</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DForall</span><span class="p">(</span><span class="n">body</span><span class="p">,</span><span class="n">gl_term</span><span class="p">,</span><span class="n">gl_ty</span><span class="p">,</span><span class="n">sz_term</span><span class="p">,</span><span class="n">sz_ty</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">s</span> <span class="o">=</span>
                    <span class="p">{</span><span class="n">s</span> <span class="k">with</span> 
                        <span class="n">env_global_type</span> <span class="o">=</span> <span class="n">gl_ty</span>
                        <span class="n">env_global_term</span> <span class="o">=</span> <span class="n">gl_term</span>
                        <span class="n">env_stack_type</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">zeroCreate</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;</span> <span class="n">sz_ty</span>
                        <span class="n">env_stack_term</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">zeroCreate</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;</span> <span class="n">sz_term</span>
                        <span class="p">}</span>
                <span class="n">s</span><span class="o">.</span><span class="n">env_stack_type</span><span class="o">.</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">b</span>
                <span class="n">term</span> <span class="n">s</span> <span class="n">body</span>
            <span class="o">|</span> <span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">YForall</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Cannot apply a runtime forall during the partial evaluation stage."</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a forall.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_data</span> <span class="n">a</span><span class="p">)</span>

        <span class="n">let</span> <span class="n">rec</span> <span class="n">apply</span> <span class="n">s</span> <span class="o">=</span> <span class="n">function</span>
            <span class="o">|</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">DUnion</span> <span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">),</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="s2">"Unions cannot be applied."</span>
            <span class="o">|</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">),</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">apply</span> <span class="n">s</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">DRecord</span> <span class="n">a</span><span class="p">,</span> <span class="n">DSymbol</span> <span class="n">b</span> <span class="o">-&gt;</span>
                <span class="k">match</span><span class="w"> </span><span class="n">a</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryPick</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="k">_</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">k</span> <span class="o">=</span> <span class="n">b</span> <span class="n">then</span> <span class="n">Some</span> <span class="n">v</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">Some</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span>
                <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Cannot find the key </span><span class="si">%s</span><span class="s2"> inside the record."</span> <span class="n">b</span>
            <span class="o">|</span> <span class="n">DFunction</span><span class="p">(</span><span class="n">body</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">gl_term</span><span class="p">,</span><span class="n">gl_ty</span><span class="p">,</span><span class="n">sz_term</span><span class="p">,</span><span class="n">sz_ty</span><span class="p">),</span> <span class="n">b</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">s</span> <span class="p">:</span> <span class="n">LangEnv</span> <span class="o">=</span> 
                    <span class="p">{</span><span class="n">s</span> <span class="k">with</span>
                        <span class="n">env_global_type</span> <span class="o">=</span> <span class="n">gl_ty</span>
                        <span class="n">env_global_term</span> <span class="o">=</span> <span class="n">gl_term</span>
                        <span class="n">env_stack_type</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">zeroCreate</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;</span> <span class="n">sz_ty</span>
                        <span class="n">env_stack_term</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">zeroCreate</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;</span> <span class="n">sz_term</span>
                        <span class="p">}</span>
                <span class="n">s</span><span class="o">.</span><span class="n">env_stack_term</span><span class="o">.</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">b</span>
                <span class="n">term</span> <span class="n">s</span> <span class="n">body</span>
            <span class="o">|</span> <span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">YForall</span><span class="p">)),</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="s2">"Cannot apply a runtime forall, and not with a term. Foralls have to be known at compile time and applied with a type."</span>
            <span class="o">|</span> <span class="n">DForall</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="s2">"Cannot apply a forall with a term."</span>
            <span class="o">|</span> <span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">YFun</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span><span class="nb">range</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">a_ty</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">a</span><span class="p">),</span> <span class="n">b</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">b</span> <span class="o">=</span> <span class="n">dyn</span> <span class="n">false</span> <span class="n">s</span> <span class="n">b</span>
                <span class="n">let</span> <span class="n">b_ty</span> <span class="o">=</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">b</span>
                <span class="k">if</span> <span class="n">domain</span> <span class="o">=</span> <span class="n">b_ty</span> <span class="n">then</span> <span class="n">push_typedop_no_rewrite</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyApply</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span> <span class="nb">range</span>
                <span class="k">else</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Cannot apply an argument of type </span><span class="si">%s</span><span class="s2"> to a function of type: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">b_ty</span><span class="p">)</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a_ty</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">YLayout</span><span class="p">(</span><span class="n">ty</span><span class="p">,</span><span class="n">layout</span><span class="p">))</span> <span class="k">as</span> <span class="n">tyv</span><span class="p">)</span> <span class="k">as</span> <span class="n">a</span><span class="p">,</span> <span class="n">DSymbol</span> <span class="n">b</span> <span class="o">-&gt;</span> 
                <span class="n">let</span> <span class="n">key</span> <span class="o">=</span> <span class="n">TyLayoutIndexByKey</span><span class="p">(</span><span class="n">tyv</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
                <span class="n">let</span> <span class="n">ret_ty</span> <span class="o">=</span> 
                    <span class="k">match</span> <span class="n">ty</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">YRecord</span> <span class="n">r</span> <span class="o">-&gt;</span>
                        <span class="k">match</span> <span class="n">r</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryPick</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">k</span> <span class="o">=</span> <span class="n">b</span> <span class="n">then</span> <span class="n">Some</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span> <span class="k">with</span>
                        <span class="o">|</span> <span class="n">Some</span> <span class="p">(</span><span class="n">_i</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">a</span>
                        <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Cannot find the key </span><span class="si">%s</span><span class="s2"> inside the layout type's record."</span> <span class="n">b</span>
                    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a record inside the layout type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">ty</span><span class="p">)</span>
                <span class="k">match</span> <span class="n">layout</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">Heap</span> <span class="o">|</span> <span class="n">StackMutable</span> <span class="o">|</span> <span class="n">HeapMutable</span> <span class="o">-&gt;</span> <span class="n">push_typedop_no_rewrite</span> <span class="n">s</span> <span class="n">key</span> <span class="n">ret_ty</span>
            <span class="o">|</span> <span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">YLayout</span> <span class="n">_</span><span class="p">)),</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a symbol as the index into the layout type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_data</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">a</span><span class="p">,</span><span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a function, closure, record or a layout type possibly inside a nominal.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_data</span> <span class="n">a</span><span class="p">)</span>

        <span class="n">let</span> <span class="n">rec</span> <span class="n">if_</span> <span class="n">s</span> <span class="n">cond</span> <span class="n">on_succ</span> <span class="n">on_fail</span> <span class="o">=</span> 
            <span class="k">match</span> <span class="n">cond</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitBool</span> <span class="n">true</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">term</span> <span class="n">s</span> <span class="n">on_succ</span>
            <span class="o">|</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitBool</span> <span class="n">false</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">term</span> <span class="n">s</span> <span class="n">on_fail</span>
            <span class="o">|</span> <span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">YPrim</span> <span class="n">BoolT</span> <span class="o">&amp;</span> <span class="n">type_bool</span><span class="p">))</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">lit_tr</span> <span class="o">=</span> <span class="n">DLit</span><span class="p">(</span><span class="n">LitBool</span> <span class="n">true</span><span class="p">)</span>
                <span class="k">match</span> <span class="n">cse_tryfind</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyOp</span><span class="p">(</span><span class="n">EQ</span><span class="p">,</span> <span class="p">[</span><span class="n">cond</span><span class="p">;</span> <span class="n">lit_tr</span><span class="p">]))</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">Some</span> <span class="n">cond</span> <span class="o">-&gt;</span> <span class="n">if_</span> <span class="n">s</span> <span class="n">cond</span> <span class="n">on_succ</span> <span class="n">on_fail</span>
                <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span>
                    <span class="n">let</span> <span class="n">lit_fl</span> <span class="o">=</span> <span class="n">DLit</span><span class="p">(</span><span class="n">LitBool</span> <span class="n">false</span><span class="p">)</span>
                    <span class="n">let</span> <span class="n">add_rewrite_cases</span> <span class="n">is_true</span> <span class="o">=</span> 
                        <span class="n">let</span> <span class="n">cse</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Structural</span><span class="p">)</span>
                        <span class="n">let</span> <span class="n">tr</span><span class="p">,</span><span class="n">fl</span> <span class="o">=</span> <span class="k">if</span> <span class="n">is_true</span> <span class="n">then</span> <span class="n">lit_tr</span><span class="p">,</span> <span class="n">lit_fl</span> <span class="k">else</span> <span class="n">lit_fl</span><span class="p">,</span> <span class="n">lit_tr</span>
                        <span class="n">let</span> <span class="n">inline</span> <span class="n">op</span> <span class="n">op</span> <span class="n">cond</span><span class="s1">' res = cse.Add(TyOp(op,[cond;cond'</span><span class="p">]),</span><span class="n">res</span><span class="p">);</span> <span class="n">cse</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">TyOp</span><span class="p">(</span><span class="n">op</span><span class="p">,[</span><span class="n">cond</span><span class="s1">';cond]),res)</span>
                        <span class="n">op</span> <span class="n">EQ</span> <span class="n">lit_tr</span> <span class="n">tr</span><span class="p">;</span> <span class="n">op</span> <span class="n">NEQ</span> <span class="n">lit_tr</span> <span class="n">fl</span><span class="p">;</span> <span class="n">op</span> <span class="n">EQ</span> <span class="n">lit_fl</span> <span class="n">fl</span><span class="p">;</span> <span class="n">op</span> <span class="n">NEQ</span> <span class="n">lit_fl</span> <span class="n">tr</span>
                        <span class="n">cse</span>
                    <span class="n">let</span> <span class="n">tr</span><span class="p">,</span> <span class="n">type_tr</span> <span class="o">=</span> <span class="n">term_scope</span><span class="s1">' s (add_rewrite_cases true) on_succ</span>
                    <span class="n">let</span> <span class="n">fl</span><span class="p">,</span> <span class="n">type_fl</span> <span class="o">=</span> <span class="n">term_scope</span><span class="s1">' s (add_rewrite_cases false) on_fail</span>
                    <span class="n">let</span> <span class="n">type_tr</span><span class="p">,</span> <span class="n">type_fl</span> <span class="o">=</span>
                        <span class="k">match</span> <span class="n">type_tr</span><span class="p">,</span> <span class="n">type_fl</span> <span class="k">with</span>
                        <span class="o">|</span> <span class="n">YRecord</span> <span class="n">tr</span><span class="p">,</span> <span class="n">YRecord</span> <span class="n">fl</span> <span class="o">-&gt;</span>
                            <span class="n">let</span> <span class="n">tr</span> <span class="o">=</span>
                                <span class="n">tr</span>
                                <span class="o">|&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">KeyValue</span> <span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span> <span class="n">v</span><span class="p">))</span> <span class="o">-&gt;</span>
                                    <span class="n">let</span> <span class="n">i</span> <span class="o">=</span>
                                        <span class="n">fl</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryPick</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">i</span><span class="s1">', k'</span><span class="p">)</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="s1">' then Some i'</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                                        <span class="o">|&gt;</span> <span class="n">Option</span><span class="o">.</span><span class="n">defaultValue</span> <span class="n">i</span>
                                    <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span> <span class="n">v</span>
                                <span class="p">)</span>
                                <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">ofSeq</span>
                                <span class="o">|&gt;</span> <span class="n">YRecord</span>

                            <span class="n">let</span> <span class="n">fl</span> <span class="o">=</span>
                                <span class="n">fl</span>
                                <span class="o">|&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">KeyValue</span> <span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span> <span class="n">v</span><span class="p">))</span> <span class="o">-&gt;</span>
                                    <span class="n">k</span><span class="p">,</span> <span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span> <span class="n">v</span><span class="p">)</span>
                                <span class="p">)</span>
                                <span class="o">|&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">distinctBy</span> <span class="n">fst</span>
                                <span class="o">|&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">map</span> <span class="n">snd</span>
                                <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">ofSeq</span>
                                <span class="o">|&gt;</span> <span class="n">YRecord</span>

                            <span class="n">tr</span><span class="p">,</span> <span class="n">fl</span>

                        <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span>
                            <span class="n">type_tr</span><span class="p">,</span> <span class="n">type_fl</span>

                    <span class="k">if</span> <span class="n">type_tr</span> <span class="o">=</span> <span class="n">type_fl</span> <span class="n">then</span>
                        <span class="k">if</span> <span class="n">tr</span><span class="o">.</span><span class="n">Length</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">fl</span><span class="o">.</span><span class="n">Length</span> <span class="o">=</span> <span class="mi">1</span> <span class="n">then</span>
                            <span class="k">match</span> <span class="n">tr</span><span class="o">.</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fl</span><span class="o">.</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">with</span>
                            <span class="o">|</span> <span class="n">TyLocalReturnOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">tr</span><span class="p">,</span><span class="n">_</span><span class="p">),</span> <span class="n">TyLocalReturnOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">fl</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="n">when</span> <span class="n">tr</span> <span class="o">=</span> <span class="n">fl</span> <span class="o">-&gt;</span> <span class="n">push_typedop_no_rewrite</span> <span class="n">s</span> <span class="n">tr</span> <span class="n">type_tr</span>
                            <span class="o">|</span> <span class="n">TyLocalReturnData</span><span class="p">(</span><span class="n">tr</span><span class="s1">',_), TyLocalReturnData(fl'</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> 
                                <span class="k">match</span> <span class="n">tr</span><span class="s1">', fl'</span> <span class="k">with</span>
                                <span class="o">|</span> <span class="n">tr</span><span class="p">,</span> <span class="n">fl</span> <span class="n">when</span> <span class="n">tr</span> <span class="o">=</span> <span class="n">fl</span> <span class="o">-&gt;</span> <span class="n">tr</span>
                                <span class="o">|</span> <span class="n">DLit</span><span class="p">(</span><span class="n">LitBool</span> <span class="n">false</span><span class="p">),</span> <span class="n">DLit</span><span class="p">(</span><span class="n">LitBool</span> <span class="n">true</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">push_binop</span> <span class="n">s</span> <span class="n">EQ</span> <span class="p">(</span><span class="n">cond</span><span class="p">,</span><span class="n">lit_fl</span><span class="p">)</span> <span class="n">type_bool</span>
                                <span class="o">|</span> <span class="n">DLit</span><span class="p">(</span><span class="n">LitBool</span> <span class="n">false</span><span class="p">),</span> <span class="n">fl</span> <span class="n">when</span> <span class="n">cond</span> <span class="o">=</span> <span class="n">fl</span> <span class="o">-&gt;</span> <span class="n">lit_fl</span>
                                <span class="o">|</span> <span class="n">DLit</span><span class="p">(</span><span class="n">LitBool</span> <span class="n">true</span><span class="p">),</span> <span class="n">fl</span> <span class="o">-&gt;</span> <span class="o">//</span> <span class="n">boolean</span> <span class="ow">or</span>
                                    <span class="k">match</span> <span class="n">fl</span> <span class="k">with</span>
                                    <span class="o">|</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitBool</span> <span class="n">false</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cond</span>
                                    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">cond</span> <span class="o">=</span> <span class="n">fl</span> <span class="n">then</span> <span class="n">cond</span> <span class="k">else</span> <span class="n">push_binop</span> <span class="n">s</span> <span class="n">BoolOr</span> <span class="p">(</span><span class="n">cond</span><span class="p">,</span><span class="n">fl</span><span class="p">)</span> <span class="n">type_bool</span>
                                <span class="o">|</span> <span class="n">tr</span><span class="p">,</span> <span class="n">DLit</span><span class="p">(</span><span class="n">LitBool</span> <span class="n">false</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="o">//</span> <span class="n">boolean</span> <span class="ow">and</span>
                                    <span class="k">match</span> <span class="n">tr</span> <span class="k">with</span>
                                    <span class="o">|</span> <span class="n">DLit</span><span class="p">(</span><span class="n">LitBool</span> <span class="n">true</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cond</span>
                                    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">cond</span> <span class="o">=</span> <span class="n">tr</span> <span class="n">then</span> <span class="n">cond</span> <span class="k">else</span> <span class="n">push_binop</span> <span class="n">s</span> <span class="n">BoolAnd</span> <span class="p">(</span><span class="n">cond</span><span class="p">,</span><span class="n">tr</span><span class="p">)</span> <span class="n">type_bool</span>
                                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">push_typedop_no_rewrite</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyIf</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span><span class="n">tr</span><span class="p">,</span><span class="n">fl</span><span class="p">))</span> <span class="n">type_tr</span>
                            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">push_typedop_no_rewrite</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyIf</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span><span class="n">tr</span><span class="p">,</span><span class="n">fl</span><span class="p">))</span> <span class="n">type_tr</span>
                        <span class="k">else</span> <span class="n">push_typedop_no_rewrite</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyIf</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span><span class="n">tr</span><span class="p">,</span><span class="n">fl</span><span class="p">))</span> <span class="n">type_tr</span>
                    <span class="k">else</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Types in branches of If do not match.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">type_tr</span><span class="p">)</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">type_fl</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">cond</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a bool in conditional.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_data</span> <span class="n">cond</span><span class="p">)</span>

        <span class="n">let</span> <span class="n">eq</span> <span class="n">s</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> 
            <span class="n">let</span> <span class="n">inline</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">=</span> <span class="n">b</span>
            <span class="k">match</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DLit</span> <span class="n">a</span><span class="p">,</span> <span class="n">DLit</span> <span class="n">b</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">LitInt8</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt8</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt16</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt16</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt64</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt8</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt8</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt16</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt16</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt64</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitFloat32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitFloat32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitFloat64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitFloat64</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitString</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitString</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitChar</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitChar</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitBool</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitBool</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The two literals must be equal in type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">a_ty</span><span class="p">)),</span> <span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">_</span><span class="p">))</span> <span class="n">when</span> <span class="n">a</span> <span class="o">=</span> <span class="n">b</span> <span class="o">&amp;&amp;</span> <span class="n">is_non_float_primitive</span> <span class="n">a_ty</span> <span class="o">-&gt;</span> <span class="n">LitBool</span> <span class="n">true</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
            <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">a_ty</span><span class="p">,</span> <span class="n">b_ty</span> <span class="o">=</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">a</span><span class="p">,</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">b</span>
                <span class="k">if</span> <span class="n">a_ty</span> <span class="o">=</span> <span class="n">b_ty</span> <span class="n">then</span>
                    <span class="k">match</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitBool</span> <span class="n">true</span><span class="p">),</span> <span class="n">x</span> <span class="o">|</span> <span class="n">x</span><span class="p">,</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitBool</span> <span class="n">true</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">x</span>
                    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span>
                        <span class="k">if</span> <span class="n">is_primitive</span> <span class="n">a_ty</span> <span class="n">then</span> <span class="n">push_binop</span> <span class="n">s</span> <span class="n">EQ</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="p">(</span><span class="n">YPrim</span> <span class="n">BoolT</span><span class="p">)</span>
                        <span class="k">else</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The type of the two arguments needs to be a primitive type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a_ty</span><span class="p">)</span>
                <span class="k">else</span>
                    <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The two sides need to have the same primitive types.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">."</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a_ty</span><span class="p">)</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">b_ty</span><span class="p">)</span>    
        <span class="n">let</span> <span class="n">default_lit</span> <span class="n">s</span> <span class="p">(</span><span class="n">a</span> <span class="p">:</span> <span class="n">string</span><span class="p">)</span> <span class="n">b</span> <span class="o">=</span>
            <span class="n">let</span> <span class="n">inline</span> <span class="n">f</span> <span class="n">string_to_val</span> <span class="n">val_to_lit</span> <span class="n">val_dsc</span> <span class="o">=</span>
                <span class="k">match</span> <span class="n">string_to_val</span> <span class="n">a</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">true</span><span class="p">,</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">val_to_lit</span> <span class="n">x</span>
                <span class="o">|</span> <span class="n">false</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Cannot parse the literal as: </span><span class="si">%s</span><span class="s2">"</span> <span class="n">val_dsc</span>
            <span class="k">match</span> <span class="n">b</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">YPrim</span> <span class="n">Float32T</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">System</span><span class="o">.</span><span class="n">Single</span><span class="o">.</span><span class="n">TryParse</span> <span class="n">LitFloat32</span> <span class="s2">"f32"</span>
            <span class="o">|</span> <span class="n">YPrim</span> <span class="n">Float64T</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">System</span><span class="o">.</span><span class="n">Double</span><span class="o">.</span><span class="n">TryParse</span> <span class="n">LitFloat64</span> <span class="s2">"f64"</span>
            <span class="o">|</span> <span class="n">YPrim</span> <span class="n">Int8T</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">System</span><span class="o">.</span><span class="n">SByte</span><span class="o">.</span><span class="n">TryParse</span> <span class="n">LitInt8</span> <span class="s2">"i8"</span>
            <span class="o">|</span> <span class="n">YPrim</span> <span class="n">Int16T</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">System</span><span class="o">.</span><span class="n">Int16</span><span class="o">.</span><span class="n">TryParse</span> <span class="n">LitInt16</span> <span class="s2">"i16"</span>
            <span class="o">|</span> <span class="n">YPrim</span> <span class="n">Int32T</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">System</span><span class="o">.</span><span class="n">Int32</span><span class="o">.</span><span class="n">TryParse</span> <span class="n">LitInt32</span> <span class="s2">"i32"</span>
            <span class="o">|</span> <span class="n">YPrim</span> <span class="n">Int64T</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">System</span><span class="o">.</span><span class="n">Int64</span><span class="o">.</span><span class="n">TryParse</span> <span class="n">LitInt64</span> <span class="s2">"i64"</span>
            <span class="o">|</span> <span class="n">YPrim</span> <span class="n">UInt8T</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">System</span><span class="o">.</span><span class="n">Byte</span><span class="o">.</span><span class="n">TryParse</span> <span class="n">LitUInt8</span> <span class="s2">"u8"</span>
            <span class="o">|</span> <span class="n">YPrim</span> <span class="n">UInt16T</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">System</span><span class="o">.</span><span class="n">UInt16</span><span class="o">.</span><span class="n">TryParse</span> <span class="n">LitUInt16</span> <span class="s2">"u16"</span>
            <span class="o">|</span> <span class="n">YPrim</span> <span class="n">UInt32T</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">System</span><span class="o">.</span><span class="n">UInt32</span><span class="o">.</span><span class="n">TryParse</span> <span class="n">LitUInt32</span> <span class="s2">"u32"</span>
            <span class="o">|</span> <span class="n">YPrim</span> <span class="n">UInt64T</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">System</span><span class="o">.</span><span class="n">UInt64</span><span class="o">.</span><span class="n">TryParse</span> <span class="n">LitUInt64</span> <span class="s2">"u64"</span>
            <span class="o">|</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a numberic type (f32,f64,i8,i16,i32,i64,u8,u16,u32,u64) as the type of literal.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">b</span><span class="p">)</span>

        <span class="n">let</span> <span class="n">lit_test</span> <span class="n">s</span> <span class="n">a</span> <span class="n">bind</span> <span class="n">on_succ</span> <span class="n">on_fail</span> <span class="o">=</span>
            <span class="n">let</span> <span class="n">b</span> <span class="o">=</span> <span class="n">v</span> <span class="n">s</span> <span class="n">bind</span>
            <span class="k">if</span> <span class="n">lit_to_ty</span> <span class="n">a</span> <span class="o">=</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">b</span> <span class="n">then</span> <span class="n">if_</span> <span class="n">s</span> <span class="p">(</span><span class="n">eq</span> <span class="n">s</span> <span class="p">(</span><span class="n">DLit</span> <span class="n">a</span><span class="p">)</span> <span class="n">b</span><span class="p">)</span> <span class="n">on_succ</span> <span class="n">on_fail</span>
            <span class="k">else</span> <span class="n">term</span> <span class="n">s</span> <span class="n">on_fail</span>

        <span class="n">let</span> <span class="n">inline</span> <span class="n">nan_guardf32</span> <span class="n">x</span> <span class="o">=</span> <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">Single</span><span class="o">.</span><span class="n">IsNaN</span> <span class="n">x</span> <span class="n">then</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="s2">"A 32-bit floating point operation resulting in a nan detected at compile time."</span> <span class="k">else</span> <span class="n">x</span>
        <span class="n">let</span> <span class="n">inline</span> <span class="n">nan_guardf64</span> <span class="n">x</span> <span class="o">=</span> <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">Double</span><span class="o">.</span><span class="n">IsNaN</span> <span class="n">x</span> <span class="n">then</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="s2">"A 64-bit floating point operation resulting in a nan detected at compile time."</span> <span class="k">else</span> <span class="n">x</span>

        <span class="n">let</span> <span class="n">eforall</span> <span class="p">(</span><span class="n">free_vars</span> <span class="p">:</span> <span class="n">Scope</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">body</span><span class="p">)</span> <span class="o">=</span>
            <span class="k">assert</span> <span class="p">(</span><span class="n">free_vars</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="n">free_vars</span><span class="o">.</span><span class="n">Length</span> <span class="o">=</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">DForall</span><span class="p">(</span><span class="n">body</span><span class="p">,</span><span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">v</span> <span class="n">s</span><span class="p">)</span> <span class="n">free_vars</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">free_vars</span><span class="p">,</span><span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">vt</span> <span class="n">s</span><span class="p">)</span> <span class="n">free_vars</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="n">free_vars</span><span class="p">,</span><span class="n">free_vars</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">stack_size</span><span class="p">,</span><span class="n">free_vars</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="n">stack_size</span><span class="p">)</span>

        <span class="n">let</span> <span class="n">efun</span> <span class="p">(</span><span class="n">free_vars</span> <span class="p">:</span> <span class="n">Scope</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">body</span><span class="p">,</span><span class="n">annot</span><span class="p">)</span> <span class="o">=</span>
            <span class="k">assert</span> <span class="p">(</span><span class="n">free_vars</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">free_vars</span><span class="o">.</span><span class="n">Length</span> <span class="o">=</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">DFunction</span><span class="p">(</span><span class="n">body</span><span class="p">,</span><span class="n">annot</span><span class="p">,</span><span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">v</span> <span class="n">s</span><span class="p">)</span> <span class="n">free_vars</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">free_vars</span><span class="p">,</span><span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">vt</span> <span class="n">s</span><span class="p">)</span> <span class="n">free_vars</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="n">free_vars</span><span class="p">,</span><span class="n">free_vars</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">stack_size</span><span class="p">,</span><span class="n">free_vars</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="n">stack_size</span><span class="p">)</span>

        <span class="n">let</span> <span class="n">enominal</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">=</span>
            <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span>
            <span class="n">let</span> <span class="n">b</span> <span class="o">=</span> <span class="n">ty</span> <span class="n">s</span> <span class="n">b</span>
            <span class="k">match</span> <span class="n">nominal_type_apply</span> <span class="n">s</span> <span class="n">b</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">YUnion</span> <span class="n">h</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">a</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">DPair</span><span class="p">(</span><span class="n">DSymbol</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">-&gt;</span>
                    <span class="n">let</span> <span class="n">v_ty</span> <span class="o">=</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">v</span>
                    <span class="k">match</span><span class="w"> </span><span class="n">Map</span><span class="o">.</span><span class="n">tryPick</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="k">_</span><span class="p">,</span> <span class="n">name</span><span class="s1">') v -&gt; if k = name'</span> <span class="n">then</span> <span class="n">Some</span> <span class="n">v</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span> <span class="n">h</span><span class="o">.</span><span class="n">Item</span><span class="o">.</span><span class="n">cases</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">Some</span> <span class="n">v_ty</span><span class="s1">' when v_ty = v_ty'</span> <span class="o">-&gt;</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">DUnion</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">h</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> 
                    <span class="o">|</span> <span class="n">Some</span> <span class="n">v_ty</span><span class="s1">' -&gt; raise_type_error s &lt;| sprintf "For key </span><span class="si">%s</span><span class="s1">, The type of the value does not match the union case.</span><span class="se">\n</span><span class="s1">Got: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">Expected: </span><span class="si">%s</span><span class="s1">" k (show_ty v_ty) (show_ty v_ty'</span><span class="p">)</span>
                    <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The union does not have key </span><span class="si">%s</span><span class="s2">.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="n">k</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected key/value pair.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_data</span> <span class="n">a</span><span class="p">)</span>
            <span class="o">|</span> <span class="sa">b</span><span class="s1">' -&gt;</span>
                <span class="n">let</span> <span class="n">a</span> <span class="o">=</span>
                    <span class="k">match</span> <span class="n">a</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">DRecord</span> <span class="n">a</span> <span class="o">-&gt;</span>
                        <span class="n">a</span>
                        <span class="o">|&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">KeyValue</span> <span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span> <span class="n">v</span><span class="p">))</span> <span class="o">-&gt;</span>
                            <span class="n">k</span><span class="p">,</span> <span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span> <span class="n">v</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="o">|&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">distinctBy</span> <span class="n">fst</span>
                        <span class="o">|&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">map</span> <span class="n">snd</span>
                        <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">ofSeq</span>
                        <span class="o">|&gt;</span> <span class="n">DRecord</span>
                    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">a</span>

                <span class="n">let</span> <span class="n">a_ty</span> <span class="o">=</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">a</span>

                <span class="k">if</span> <span class="n">a_ty</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">' then DNominal(a,b)</span>
                <span class="k">else</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Type error in nominal constructor.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">Expected: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a_ty</span><span class="p">)</span> <span class="p">(</span><span class="n">show_ty</span> <span class="sa">b</span><span class="s1">')</span>

        <span class="n">let</span> <span class="n">ty_union</span> <span class="n">s</span> <span class="n">x</span> <span class="o">=</span> 
            <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">ty</span> <span class="n">s</span> <span class="n">x</span>
            <span class="k">match</span> <span class="n">nominal_type_apply</span> <span class="n">s</span> <span class="n">x</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">YUnion</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected an union.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">x</span><span class="p">)</span>

        <span class="n">let</span> <span class="n">ty_record</span> <span class="n">s</span> <span class="n">x</span> <span class="o">=</span>
            <span class="k">match</span> <span class="n">ty</span> <span class="n">s</span> <span class="n">x</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">YRecord</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">l</span>
            <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a type record.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">x</span><span class="p">)</span>

        <span class="n">let</span> <span class="n">to_i32</span> <span class="n">x</span> <span class="o">=</span> 
            <span class="k">try</span> 
                <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">LitUInt8</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="n">Convert</span><span class="o">.</span><span class="n">ToInt32</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">LitUInt16</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="n">Convert</span><span class="o">.</span><span class="n">ToInt32</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">LitUInt32</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="n">Convert</span><span class="o">.</span><span class="n">ToInt32</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">LitUInt64</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="n">Convert</span><span class="o">.</span><span class="n">ToInt32</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">LitInt8</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="n">Convert</span><span class="o">.</span><span class="n">ToInt32</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">LitInt16</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="n">Convert</span><span class="o">.</span><span class="n">ToInt32</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">LitInt32</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="n">Convert</span><span class="o">.</span><span class="n">ToInt32</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">LitInt64</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="n">Convert</span><span class="o">.</span><span class="n">ToInt32</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected an int convertible to an i32.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">x</span><span class="p">)</span>
            <span class="k">with</span> <span class="p">:</span><span class="err">?</span> <span class="n">System</span><span class="o">.</span><span class="n">OverflowException</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The literal cannot be converted to an i32 as it is either too small or to big.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">x</span><span class="p">)</span>

        <span class="n">let</span> <span class="n">record2</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="p">(</span><span class="n">a</span><span class="s1">',b'</span><span class="p">)</span> <span class="o">=</span> <span class="n">DRecord</span><span class="p">(</span><span class="n">Map</span><span class="o">.</span><span class="n">empty</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">a</span><span class="s1">' b'</span><span class="p">)</span>
        <span class="n">let</span> <span class="n">record3</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="p">(</span><span class="n">a</span><span class="s1">',b'</span><span class="p">)</span> <span class="p">(</span><span class="n">a</span><span class="s1">''</span><span class="p">,</span><span class="sa">b</span><span class="s1">''</span><span class="p">)</span> <span class="o">=</span> <span class="n">DRecord</span><span class="p">(</span><span class="n">Map</span><span class="o">.</span><span class="n">empty</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">a</span><span class="s1">' b'</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">a</span><span class="s1">''</span> <span class="sa">b</span><span class="s1">''</span><span class="p">)</span>

        <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">EPatternRef</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: EPatternRef should have been eliminated during the prepass."</span>
        <span class="o">|</span> <span class="n">EB</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">DB</span>
        <span class="o">|</span> <span class="n">EV</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">v</span> <span class="n">s</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">ELit</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">ESymbol</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DSymbol</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">EFun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: Raw functions should be transformed during the prepass."</span>
        <span class="o">|</span> <span class="n">EFun</span><span class="s1">'(_,free_vars,i,body,annot) -&gt; efun (free_vars,i,body,annot)</span>
        <span class="o">|</span> <span class="n">ERecursiveFun</span><span class="s1">'(_,free_vars,i,body,annot) -&gt; efun (free_vars,i,body.Value,annot)</span>
        <span class="o">|</span> <span class="n">EForall</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: Raw foralls should be transformed during the prepass."</span>
        <span class="o">|</span> <span class="n">EForall</span><span class="s1">'(_,free_vars,i,body) -&gt; eforall (free_vars,i,body)</span>
        <span class="o">|</span> <span class="n">ERecursiveForall</span><span class="s1">'(_,free_vars,i,body) -&gt; eforall (free_vars,i,body.Value)</span>
        <span class="o">|</span> <span class="n">ERecursive</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span><span class="o">.</span><span class="n">Value</span>
        <span class="o">|</span> <span class="n">ERecBlock</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: Recursive blocks should be inlined and eliminated during the prepass."</span>
        <span class="o">|</span> <span class="n">EJoinPoint</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: Raw join points should be transformed during the prepass."</span>
        <span class="o">|</span> <span class="n">EJoinPoint</span><span class="s1">'(r,scope,body,annot,backend,jp_name) -&gt;</span>
            <span class="n">let</span> <span class="n">env_global_type</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">vt</span> <span class="n">s</span><span class="p">)</span> <span class="n">scope</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="n">free_vars</span>
            <span class="n">let</span> <span class="n">env_global_term</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">v</span> <span class="n">s</span><span class="p">)</span> <span class="n">scope</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">free_vars</span>

            <span class="n">let</span> <span class="n">backend</span><span class="s1">' = match backend with None -&gt; s.backend | Some (_,backend) -&gt; backend_strings.Add backend</span>
            <span class="n">let</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">hc_table</span> <span class="o">=</span> <span class="n">memoize</span> <span class="n">join_point_method</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Structural</span><span class="p">),</span> <span class="n">HashConsTable</span><span class="p">())</span> <span class="p">(</span><span class="n">backend</span><span class="s1">', body)</span>
            <span class="n">let</span> <span class="n">call_args</span><span class="p">,</span> <span class="n">env_global_value</span> <span class="o">=</span> <span class="n">data_to_rdata</span> <span class="n">s</span> <span class="n">hc_table</span> <span class="n">env_global_term</span>
            <span class="n">let</span> <span class="n">join_point_key</span> <span class="o">=</span> <span class="n">hc_table</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">env_global_value</span><span class="p">,</span> <span class="n">env_global_type</span><span class="p">)</span>

            <span class="n">let</span> <span class="n">ret_ty</span> <span class="o">=</span>
                <span class="k">match</span> <span class="nb">dict</span><span class="o">.</span><span class="n">TryGetValue</span><span class="p">(</span><span class="n">join_point_key</span><span class="p">)</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">true</span><span class="p">,</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">Some</span> <span class="n">ret_ty</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ret_ty</span>
                <span class="o">|</span> <span class="n">true</span><span class="p">,</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="p">(</span><span class="n">add_trace</span> <span class="n">s</span> <span class="n">r</span><span class="p">)</span> <span class="s2">"Recursive join points must be annotated."</span>
                <span class="o">|</span> <span class="n">false</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span>
                    <span class="n">let</span> <span class="n">s</span> <span class="p">:</span> <span class="n">LangEnv</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="n">trace</span> <span class="o">=</span> <span class="n">r</span> <span class="p">::</span> <span class="n">s</span><span class="o">.</span><span class="n">trace</span>
                        <span class="n">seq</span> <span class="o">=</span> <span class="n">ResizeArray</span><span class="p">()</span>
                        <span class="n">cse</span> <span class="o">=</span> <span class="p">[</span><span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Structural</span><span class="p">)]</span>
                        <span class="n">unions</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>
                        <span class="n">env_global_type</span> <span class="o">=</span> <span class="n">env_global_type</span>
                        <span class="n">env_global_term</span> <span class="o">=</span> <span class="n">env_global_term</span>
                        <span class="n">env_stack_type</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">zeroCreate</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;</span> <span class="n">scope</span><span class="o">.</span><span class="n">ty</span><span class="o">.</span><span class="n">stack_size</span>
                        <span class="n">env_stack_term</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">zeroCreate</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;</span> <span class="n">scope</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">stack_size</span>
                        <span class="n">backend</span> <span class="o">=</span> <span class="n">backend</span><span class="s1">'</span>
                        <span class="nb">globals</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">globals</span>
                        <span class="p">}</span>
                    <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">rename_global_term</span> <span class="n">s</span>
                    <span class="n">let</span> <span class="n">annot</span> <span class="o">=</span> <span class="n">Option</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">ty</span> <span class="n">s</span><span class="p">)</span> <span class="n">annot</span>
                    <span class="nb">dict</span><span class="o">.</span><span class="p">[</span><span class="n">join_point_key</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">annot</span><span class="p">,</span> <span class="n">jp_name</span><span class="p">)</span>
                    <span class="n">let</span> <span class="n">seq</span><span class="p">,</span><span class="n">ty</span> <span class="o">=</span> <span class="n">term_scope</span><span class="s1">''</span> <span class="n">s</span> <span class="n">body</span> <span class="n">annot</span>
                    <span class="nb">dict</span><span class="o">.</span><span class="p">[</span><span class="n">join_point_key</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="p">(</span><span class="n">Some</span> <span class="n">seq</span><span class="p">,</span> <span class="n">Some</span> <span class="n">ty</span><span class="p">,</span> <span class="n">jp_name</span><span class="p">)</span>
                    <span class="n">annot</span> <span class="o">|&gt;</span> <span class="n">Option</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">annot</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">annot</span> <span class="o">&lt;&gt;</span> <span class="n">ty</span> <span class="n">then</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The annotation of the join point does not match its body's type.Got: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">Expected: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">ty</span><span class="p">)</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">annot</span><span class="p">))</span>
                    <span class="n">ty</span>

            <span class="k">match</span> <span class="n">backend</span> <span class="k">with</span>
            <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">push_typedop_no_rewrite</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyJoinPoint</span><span class="p">(</span><span class="n">JPMethod</span><span class="p">((</span><span class="n">backend</span><span class="s1">',body),join_point_key),call_args)) ret_ty</span>
            <span class="o">|</span> <span class="n">Some</span> <span class="p">(</span><span class="nb">range</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">method_name</span> <span class="o">=</span> <span class="n">push_typedop_no_rewrite</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyBackend</span><span class="p">((</span><span class="n">backend</span><span class="s1">',body),join_point_key,range)) (YPrim Int32T)</span>
                <span class="n">let</span> <span class="n">call_args</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="n">v</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">DPair</span><span class="p">(</span><span class="n">DV</span> <span class="n">v</span><span class="p">,</span><span class="n">s</span><span class="p">))</span> <span class="n">call_args</span> <span class="n">DB</span>
                <span class="n">DPair</span><span class="p">(</span><span class="n">method_name</span><span class="p">,</span> <span class="n">call_args</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EDefaultLit</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">add_trace</span> <span class="n">s</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">default_lit</span> <span class="n">s</span> <span class="n">a</span> <span class="p">(</span><span class="n">ty</span> <span class="n">s</span> <span class="n">b</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
        <span class="o">|</span> <span class="n">EType</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="p">(</span><span class="n">add_trace</span> <span class="n">s</span> <span class="n">r</span><span class="p">)</span> <span class="s2">"Raw types are not allowed on the term level."</span>
        <span class="o">|</span> <span class="n">EApply</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">add_trace</span> <span class="n">s</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">apply</span> <span class="n">s</span> <span class="p">(</span><span class="n">term</span> <span class="n">s</span> <span class="n">a</span><span class="p">,</span> <span class="n">term</span> <span class="n">s</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">ETypeApply</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">add_trace</span> <span class="n">s</span> <span class="n">r</span>
            <span class="n">type_apply</span> <span class="n">s</span> <span class="p">(</span><span class="n">term</span> <span class="n">s</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">ty</span> <span class="n">s</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">ERecordWith</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="nb">vars</span><span class="p">,</span><span class="n">withs</span><span class="p">,</span><span class="n">withouts</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">add_trace</span> <span class="n">s</span> <span class="n">r</span>
            <span class="n">let</span> <span class="nb">map</span> <span class="n">x</span> <span class="o">=</span>
                <span class="n">let</span> <span class="n">fold</span> <span class="n">f</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="n">f</span> <span class="n">b</span> <span class="n">a</span>
                <span class="n">let</span> <span class="n">var</span> <span class="n">r</span> <span class="n">a</span> <span class="o">=</span> 
                    <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">DSymbol</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span>
                    <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="p">(</span><span class="n">add_trace</span> <span class="n">s</span> <span class="n">r</span><span class="p">)</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a symbol.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_data</span> <span class="n">a</span><span class="p">)</span>
                <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">m</span> <span class="n">x</span> <span class="o">-&gt;</span> 
                    <span class="n">let</span> <span class="n">sym</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span>
                        <span class="n">let</span> <span class="n">i</span> <span class="o">=</span>
                            <span class="n">m</span>
                            <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryPick</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="n">_v</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">k</span> <span class="o">=</span> <span class="n">a</span> <span class="n">then</span> <span class="n">Some</span> <span class="n">i</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                            <span class="o">|&gt;</span> <span class="n">Option</span><span class="o">.</span><span class="n">defaultValue</span> <span class="n">m</span><span class="o">.</span><span class="n">Count</span>
                        <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">term</span> <span class="n">s</span> <span class="n">b</span><span class="p">)</span> <span class="n">m</span>
                    <span class="n">let</span> <span class="n">sym_mod</span> <span class="n">r</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> 
                        <span class="k">match</span> <span class="n">m</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryPick</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">k</span> <span class="o">=</span> <span class="n">a</span> <span class="n">then</span> <span class="n">Some</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span> <span class="k">with</span>
                        <span class="o">|</span> <span class="n">Some</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">a</span><span class="s1">') -&gt; Map.add (i, a) (apply s (term s b, a'</span><span class="p">))</span> <span class="n">m</span>
                        <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="p">(</span><span class="n">add_trace</span> <span class="n">s</span> <span class="n">r</span><span class="p">)</span> <span class="s2">"Cannot find key </span><span class="si">%s</span><span class="s2"> in record."</span> <span class="n">a</span>
                    <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">RSymbol</span><span class="p">((</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sym</span> <span class="n">a</span> <span class="n">b</span>
                    <span class="o">|</span> <span class="n">RSymbolModify</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sym_mod</span> <span class="n">r</span> <span class="n">a</span> <span class="n">b</span>
                    <span class="o">|</span> <span class="n">RVar</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sym</span> <span class="p">(</span><span class="n">var</span> <span class="n">r</span> <span class="n">a</span><span class="p">)</span> <span class="n">b</span>
                    <span class="o">|</span> <span class="n">RVarModify</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sym_mod</span> <span class="n">r</span> <span class="p">(</span><span class="n">var</span> <span class="n">r</span> <span class="n">a</span><span class="p">)</span> <span class="n">b</span>
                    <span class="p">)</span> <span class="n">withs</span>
                <span class="o">|&gt;</span> <span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">m</span> <span class="o">-&gt;</span> <span class="n">function</span>
                    <span class="o">|</span> <span class="n">WSymbol</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span>
                        <span class="n">m</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">filter</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">k</span> <span class="o">&lt;&gt;</span> <span class="n">a</span><span class="p">)</span>
                    <span class="o">|</span> <span class="n">WVar</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span>
                        <span class="n">m</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">filter</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">k</span> <span class="o">&lt;&gt;</span> <span class="n">var</span> <span class="n">r</span> <span class="n">a</span><span class="p">)</span>
                    <span class="p">)</span> <span class="n">withouts</span>
            
            <span class="n">let</span> <span class="n">rec</span> <span class="n">dive</span> <span class="n">m</span> <span class="o">=</span> <span class="n">function</span>
                <span class="o">|</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="p">::</span> <span class="n">xs</span> <span class="o">-&gt;</span>
                    <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">add_trace</span> <span class="n">s</span> <span class="n">r</span>
                    <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">x</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">DSymbol</span> <span class="n">b</span> <span class="o">-&gt;</span> 
                        <span class="n">let</span> <span class="n">v</span> <span class="o">=</span>
                            <span class="n">m</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryPick</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">k</span> <span class="o">=</span> <span class="n">b</span> <span class="n">then</span> <span class="n">Some</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">match</span> <span class="n">v</span> <span class="k">with</span>
                        <span class="o">|</span> <span class="n">Some</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DRecord</span> <span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="p">(</span><span class="n">DRecord</span> <span class="p">(</span><span class="n">dive</span> <span class="n">a</span> <span class="n">xs</span><span class="p">))</span> <span class="n">m</span>
                        <span class="o">|</span> <span class="n">Some</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a record as the result of indexing.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_data</span> <span class="p">(</span><span class="n">a</span> <span class="o">|&gt;</span> <span class="n">snd</span><span class="p">))</span>
                        <span class="o">//</span> <span class="n">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">b</span> <span class="n">m</span> <span class="k">with</span>
                        <span class="o">//</span> <span class="o">|</span> <span class="n">Some</span> <span class="p">(</span><span class="n">DRecord</span> <span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">b</span> <span class="p">(</span><span class="n">DRecord</span> <span class="p">(</span><span class="n">dive</span> <span class="n">a</span> <span class="n">xs</span><span class="p">))</span> <span class="n">m</span>
                        <span class="o">//</span> <span class="o">|</span> <span class="n">Some</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a record as the result of indexing.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_data</span> <span class="n">a</span><span class="p">)</span>
                        <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Cannot find the key </span><span class="si">%s</span><span class="s2"> in a record."</span> <span class="n">b</span>
                    <span class="o">|</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a symbol.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_data</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="p">[]</span> <span class="o">-&gt;</span> <span class="n">m</span> <span class="o">|&gt;</span> <span class="nb">map</span>

            <span class="k">match</span> <span class="nb">vars</span> <span class="k">with</span>
            <span class="o">|</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="p">::</span> <span class="n">xs</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">x</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">DRecord</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">dive</span> <span class="n">l</span> <span class="n">xs</span>
                <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a record.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_data</span> <span class="n">a</span><span class="p">)</span>
            <span class="o">|</span> <span class="p">[]</span> <span class="o">-&gt;</span> <span class="nb">map</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
            <span class="o">|&gt;</span> <span class="n">DRecord</span>
        <span class="o">|</span> <span class="n">EPatternMemo</span> <span class="n">_</span> <span class="o">|</span> <span class="n">EReal</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: Should have been eliminated during the prepass."</span>
        <span class="o">|</span> <span class="n">EModule</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">DRecord</span><span class="p">(</span><span class="n">a</span> <span class="o">|&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">KeyValue</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">Count</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span> <span class="p">(</span><span class="n">v</span> <span class="o">|&gt;</span> <span class="n">term</span> <span class="n">s</span><span class="p">))</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">ofSeq</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EPair</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DPair</span><span class="p">(</span><span class="n">term</span> <span class="n">s</span> <span class="n">a</span><span class="p">,</span> <span class="n">term</span> <span class="n">s</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">ESeq</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> 
            <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">add_trace</span> <span class="n">s</span> <span class="n">r</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DB</span> <span class="o">-&gt;</span> <span class="n">term</span> <span class="n">s</span> <span class="n">b</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected unit.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_data</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EAnnot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">add_trace</span> <span class="n">s</span> <span class="n">r</span>
            <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> 
            <span class="n">let</span> <span class="n">a_ty</span> <span class="o">=</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">a</span>
            <span class="n">let</span> <span class="n">b</span> <span class="o">=</span> <span class="n">ty</span> <span class="n">s</span> <span class="n">b</span>
            <span class="k">if</span> <span class="n">a_ty</span> <span class="o">&lt;&gt;</span> <span class="n">b</span> <span class="n">then</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The body does not match the annotation.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">Expected: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a_ty</span><span class="p">)</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">b</span><span class="p">)</span>
            <span class="n">a</span>            
        <span class="o">|</span> <span class="n">EExists</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">add_trace</span> <span class="n">s</span> <span class="n">r</span>
            <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">ty</span> <span class="n">s</span><span class="p">)</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">toArray</span>
            <span class="n">let</span> <span class="n">b</span> <span class="o">=</span> <span class="n">term</span> <span class="n">s</span> <span class="n">b</span>
            <span class="n">DExists</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EPatternMiss</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Pattern miss.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_data</span> <span class="p">(</span><span class="n">term</span> <span class="n">s</span> <span class="n">a</span><span class="p">))</span>
        <span class="o">|</span> <span class="n">ETypePatternMiss</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Pattern miss.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="p">(</span><span class="n">ty</span> <span class="n">s</span> <span class="n">a</span><span class="p">))</span>
        <span class="o">|</span> <span class="n">EIfThenElse</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">cond</span><span class="p">,</span><span class="n">tr</span><span class="p">,</span><span class="n">fl</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">add_trace</span> <span class="n">s</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">if_</span> <span class="n">s</span> <span class="p">(</span><span class="n">term</span> <span class="n">s</span> <span class="n">cond</span><span class="p">)</span> <span class="n">tr</span> <span class="n">fl</span>
        <span class="o">|</span> <span class="n">EIfThen</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">cond</span><span class="p">,</span><span class="n">tr</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">add_trace</span> <span class="n">s</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">if_</span> <span class="n">s</span> <span class="p">(</span><span class="n">term</span> <span class="n">s</span> <span class="n">cond</span><span class="p">)</span> <span class="n">tr</span> <span class="p">(</span><span class="n">EB</span> <span class="n">r</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EMutableSet</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">add_trace</span> <span class="n">s</span> <span class="n">r</span>
            <span class="n">let</span> <span class="n">a</span><span class="p">,</span><span class="n">a_layout_ty</span> <span class="o">=</span>
                <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">YLayout</span><span class="p">(</span><span class="n">a_layout_ty</span><span class="p">,(</span><span class="n">StackMutable</span> <span class="o">|</span> <span class="n">HeapMutable</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="p">,</span><span class="n">a_layout_ty</span>
                <span class="o">|</span> <span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">YLayout</span> <span class="n">_</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="s2">"Expected a mutable layout type, but got an immutable one."</span>
                <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a mutable layout type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_data</span> <span class="n">a</span><span class="p">)</span>
            <span class="n">let</span> <span class="n">b</span> <span class="o">=</span> 
                <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> 
                    <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">b</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">DSymbol</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">r</span><span class="p">,</span><span class="n">b</span>
                    <span class="o">|</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="p">(</span><span class="n">add_trace</span> <span class="n">s</span> <span class="n">r</span><span class="p">)</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a symbol.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_data</span> <span class="n">b</span><span class="p">)</span>
                    <span class="p">)</span> <span class="n">b</span>
            <span class="n">let</span> <span class="n">c_ty</span> <span class="o">=</span>
                <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="sa">r</span><span class="s1">',b) -&gt;</span>
                    <span class="k">match</span> <span class="n">a</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">YRecord</span> <span class="n">a</span> <span class="o">-&gt;</span>
                        <span class="k">match</span><span class="w"> </span><span class="n">a</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryPick</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="k">_</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">k</span> <span class="o">=</span> <span class="n">b</span> <span class="n">then</span> <span class="n">Some</span> <span class="n">v</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span> <span class="k">with</span>
                        <span class="o">|</span> <span class="n">Some</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="sa">r</span><span class="s1">', a</span>
                        <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="p">(</span><span class="n">add_trace</span> <span class="n">s</span> <span class="n">r</span><span class="p">)</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Key </span><span class="si">%s</span><span class="s2"> not found in the layout type."</span> <span class="n">b</span>
                    <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="p">(</span><span class="n">add_trace</span> <span class="n">s</span> <span class="n">r</span><span class="p">)</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a record.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a</span><span class="p">)</span>
                    <span class="p">)</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a_layout_ty</span><span class="p">)</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">snd</span>
            <span class="n">let</span> <span class="n">c</span> <span class="o">=</span> <span class="n">term</span> <span class="n">s</span> <span class="n">c</span> <span class="o">|&gt;</span> <span class="n">dyn</span> <span class="n">false</span> <span class="n">s</span>
            <span class="n">let</span> <span class="n">c</span> <span class="o">=</span>
                <span class="k">match</span> <span class="n">c</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">DRecord</span> <span class="n">c</span> <span class="o">-&gt;</span>
                    <span class="n">c</span>
                    <span class="o">|&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">KeyValue</span> <span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span> <span class="n">v</span><span class="p">))</span> <span class="o">-&gt;</span>
                        <span class="n">let</span> <span class="n">i</span> <span class="o">=</span>
                            <span class="k">match</span> <span class="n">c_ty</span> <span class="k">with</span>
                            <span class="o">|</span> <span class="n">YRecord</span> <span class="n">a</span> <span class="o">-&gt;</span>
                                <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryPick</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">i</span><span class="s1">', k'</span><span class="p">)</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="s1">' then Some i'</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="kc">None</span>
                            <span class="o">|&gt;</span> <span class="n">Option</span><span class="o">.</span><span class="n">defaultValue</span> <span class="n">i</span>
                        <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span> <span class="n">v</span>
                    <span class="p">)</span>
                    <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">ofSeq</span>
                    <span class="o">|&gt;</span> <span class="n">DRecord</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">c</span>
            <span class="n">let</span> <span class="n">c_ty</span><span class="s1">' = data_to_ty s c</span>
            <span class="k">if</span> <span class="n">c_ty</span><span class="s1">' = c_ty then push_typedop_no_rewrite s (TyLayoutMutableSet(a,List.map snd b,c)) YB</span>
            <span class="k">else</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The two side do not have the same type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">Expected: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">c_ty</span><span class="s1">') (show_ty c_ty)</span>
        <span class="o">|</span> <span class="n">EMacro</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">add_trace</span> <span class="n">s</span> <span class="n">r</span>
            <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">function</span> <span class="n">MText</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">CMText</span> <span class="n">x</span> <span class="o">|</span> <span class="n">MTerm</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">CMTerm</span><span class="p">(</span><span class="n">term</span> <span class="n">s</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">dyn</span> <span class="n">false</span> <span class="n">s</span><span class="p">)</span> <span class="o">|</span> <span class="n">MType</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">CMType</span><span class="p">(</span><span class="n">ty</span> <span class="n">s</span> <span class="n">x</span><span class="p">)</span> <span class="o">|</span> <span class="n">MLitType</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">CMTypeLit</span><span class="p">(</span><span class="n">ty</span> <span class="n">s</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">assert_ty_lit</span> <span class="n">s</span><span class="p">))</span>
            <span class="n">push_typedop_no_rewrite</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyMacro</span><span class="p">(</span><span class="n">a</span><span class="p">))</span> <span class="p">(</span><span class="n">ty</span> <span class="n">s</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EPrototypeApply</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">prot_id</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="o">=</span> <span class="n">function</span>
                <span class="o">|</span> <span class="n">YNominal</span> <span class="n">b</span> <span class="o">-&gt;</span>
                    <span class="k">match</span> <span class="n">env</span><span class="o">.</span><span class="n">prototypes_instances</span><span class="o">.</span><span class="n">TryGetValue</span><span class="p">((</span><span class="n">prot_id</span><span class="p">,</span><span class="n">b</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">))</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">true</span><span class="p">,</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="n">term</span> <span class="n">s</span> <span class="n">x</span>
                    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="s2">"An instance of the prototype being applied could be found in the dictionary."</span>
                <span class="o">|</span> <span class="n">YApply</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">type_apply</span> <span class="n">s</span> <span class="p">(</span><span class="n">loop</span> <span class="n">a</span><span class="p">)</span> <span class="n">b</span>
                <span class="o">|</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a nominal or a deferred type apply.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">b</span><span class="p">)</span>
            <span class="n">loop</span> <span class="p">(</span><span class="n">ty</span> <span class="n">s</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">NominalCreate</span><span class="p">,[</span><span class="n">a</span><span class="p">;</span><span class="n">EType</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">b</span><span class="p">)])</span> <span class="o">|</span> <span class="n">ENominal</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">enominal</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EUnbox</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="nb">id</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">add_trace</span> <span class="n">s</span> <span class="n">r</span>
            <span class="n">let</span> <span class="n">run</span> <span class="n">s</span> <span class="n">a</span> <span class="o">=</span> <span class="n">store_term</span> <span class="n">s</span> <span class="nb">id</span> <span class="n">a</span><span class="p">;</span> <span class="n">term</span> <span class="n">s</span> <span class="n">on_succ</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">DUnion</span><span class="p">(</span><span class="n">DPair</span><span class="p">(</span><span class="n">DSymbol</span> <span class="n">k</span><span class="s1">',a),_),_) -&gt; if k = k'</span> <span class="n">then</span> <span class="n">run</span> <span class="n">s</span> <span class="n">a</span> <span class="k">else</span> <span class="n">term</span> <span class="n">s</span> <span class="n">on_fail</span>
            <span class="o">|</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">YUnion</span> <span class="n">h</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">i</span><span class="p">),</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">body</span> <span class="n">blk</span> <span class="o">=</span> 
                    <span class="k">match</span><span class="w"> </span><span class="n">Map</span><span class="o">.</span><span class="n">tryPick</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="k">_</span><span class="p">,</span> <span class="n">name</span><span class="s1">') v -&gt; if k = name'</span> <span class="n">then</span> <span class="n">Some</span> <span class="n">v</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span> <span class="n">h</span><span class="o">.</span><span class="n">Item</span><span class="o">.</span><span class="n">cases</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">Some</span> <span class="n">v</span> <span class="n">when</span> <span class="n">Set</span><span class="o">.</span><span class="n">contains</span> <span class="n">k</span> <span class="n">blk</span> <span class="o">=</span> <span class="n">false</span> <span class="o">-&gt;</span>
                        <span class="n">let</span> <span class="n">on_succ</span><span class="p">,</span> <span class="n">ret_ty</span> <span class="o">=</span> 
                            <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">ty_to_data</span> <span class="n">s</span> <span class="n">v</span>
                            <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span> <span class="k">with</span> <span class="n">unions</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">i</span> <span class="p">(</span><span class="n">UnionData</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">a</span><span class="p">))</span> <span class="n">s</span><span class="o">.</span><span class="n">unions</span><span class="p">;</span> <span class="n">cse</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Structural</span><span class="p">)</span> <span class="p">::</span> <span class="n">s</span><span class="o">.</span><span class="n">cse</span><span class="p">;</span> <span class="n">seq</span> <span class="o">=</span> <span class="n">ResizeArray</span><span class="p">()}</span>
                            <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">run</span> <span class="n">s</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">dyn</span> <span class="n">false</span> <span class="n">s</span>
                            <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">k</span> <span class="p">([</span><span class="n">a</span><span class="p">],</span> <span class="p">(</span><span class="n">seq_apply</span> <span class="n">s</span> <span class="n">x</span><span class="p">))</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">,</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">x</span>
                        <span class="n">let</span> <span class="n">on_succ</span><span class="p">,</span><span class="n">on_fails</span> <span class="o">=</span> 
                            <span class="n">let</span> <span class="n">blk</span> <span class="o">=</span> <span class="n">Set</span><span class="o">.</span><span class="n">add</span> <span class="n">k</span> <span class="n">blk</span>
                            <span class="k">if</span> <span class="n">blk</span><span class="o">.</span><span class="n">Count</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Item</span><span class="o">.</span><span class="n">cases</span><span class="o">.</span><span class="n">Count</span> <span class="n">then</span> <span class="n">on_succ</span><span class="p">,</span> <span class="kc">None</span> <span class="o">//</span> <span class="n">Have</span> <span class="n">to</span> <span class="n">do</span> <span class="n">this</span> <span class="n">otherwise</span> <span class="n">it</span> <span class="n">would</span> <span class="n">have</span> <span class="n">hit</span> <span class="n">EPatternMiss</span>
                            <span class="k">else</span>
                                <span class="n">let</span> <span class="n">on_fails</span><span class="p">,</span> <span class="n">ret_ty</span><span class="s1">' = term_scope {s with unions = Map.add i (UnionBlockers blk) s.unions} on_fail</span>
                                <span class="k">if</span> <span class="n">ret_ty</span> <span class="o">&lt;&gt;</span> <span class="n">ret_ty</span><span class="s1">' then raise_type_error s $"The types of two branches of an union unbox do not match.</span><span class="se">\n</span><span class="s1">Got: {show_ty ret_ty}</span><span class="se">\n</span><span class="s1">And: {show_ty ret_ty'</span><span class="p">}</span><span class="s2">"</span>
                                <span class="k">match</span> <span class="n">on_fails</span> <span class="k">with</span>
                                <span class="o">|</span> <span class="p">[</span><span class="o">|</span><span class="n">TyLocalReturnOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">TyUnionUnbox</span><span class="p">([</span><span class="n">i</span><span class="s1">'],_,on_succ'</span><span class="p">,</span><span class="n">on_fail</span><span class="s1">'),_)|] when i = i'</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">on_succ</span><span class="s1">' on_succ , on_fail'</span>
                                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">on_succ</span><span class="p">,</span> <span class="n">Some</span> <span class="n">on_fails</span>
                        <span class="n">push_typedop_no_rewrite</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyUnionUnbox</span><span class="p">([</span><span class="n">i</span><span class="p">],</span><span class="n">h</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fails</span><span class="p">))</span> <span class="n">ret_ty</span>
                    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">term</span> <span class="n">s</span> <span class="n">on_fail</span>
                <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">i</span> <span class="n">s</span><span class="o">.</span><span class="n">unions</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">Some</span> <span class="p">(</span><span class="n">UnionData</span> <span class="p">(</span><span class="n">k</span><span class="s1">',a)) -&gt; if k = k'</span> <span class="n">then</span> <span class="n">run</span> <span class="n">s</span> <span class="n">a</span> <span class="k">else</span> <span class="n">term</span> <span class="n">s</span> <span class="n">on_fail</span>
                <span class="o">|</span> <span class="n">Some</span> <span class="p">(</span><span class="n">UnionBlockers</span> <span class="n">blk</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">body</span> <span class="n">blk</span>
                <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">body</span> <span class="n">Set</span><span class="o">.</span><span class="n">empty</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">term</span> <span class="n">s</span> <span class="n">on_fail</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">Unbox</span><span class="p">,[</span><span class="n">a</span><span class="p">;</span><span class="n">on_succ</span><span class="p">])</span> <span class="o">-&gt;</span> 
            <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">add_trace</span> <span class="n">s</span> <span class="n">r</span>
            <span class="n">let</span> <span class="n">on_succ</span> <span class="o">=</span> <span class="n">term</span> <span class="n">s</span> <span class="n">on_succ</span>
            <span class="n">let</span> <span class="n">run</span> <span class="n">s</span> <span class="n">a</span> <span class="o">=</span> <span class="n">apply</span> <span class="n">s</span> <span class="p">(</span><span class="n">on_succ</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">DUnion</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">),</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">run</span> <span class="n">s</span> <span class="n">a</span> 
            <span class="o">|</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">YUnion</span> <span class="n">h</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">body</span> <span class="n">blk</span> <span class="o">=</span> 
                    <span class="n">let</span> <span class="n">cases</span><span class="p">,</span> <span class="n">case_ty</span> <span class="o">=</span>
                        <span class="n">Map</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">case_ty</span><span class="p">)</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="n">v</span> <span class="o">-&gt;</span>
                            <span class="k">if</span> <span class="n">Set</span><span class="o">.</span><span class="n">contains</span> <span class="n">k</span> <span class="n">blk</span> <span class="o">=</span> <span class="n">false</span> <span class="n">then</span>
                                <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">ty_to_data</span> <span class="n">s</span> <span class="n">v</span>
                                <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span> <span class="k">with</span> <span class="n">unions</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">i</span> <span class="p">(</span><span class="n">UnionData</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">a</span><span class="p">))</span> <span class="n">s</span><span class="o">.</span><span class="n">unions</span><span class="p">;</span> <span class="n">cse</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Structural</span><span class="p">)</span> <span class="p">::</span> <span class="n">s</span><span class="o">.</span><span class="n">cse</span><span class="p">;</span> <span class="n">seq</span> <span class="o">=</span> <span class="n">ResizeArray</span><span class="p">()}</span>
                                <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">run</span> <span class="n">s</span> <span class="p">(</span><span class="n">DPair</span><span class="p">(</span><span class="n">DSymbol</span> <span class="n">k</span><span class="p">,</span> <span class="n">a</span><span class="p">))</span> <span class="o">|&gt;</span> <span class="n">dyn</span> <span class="n">false</span> <span class="n">s</span>
                                <span class="n">let</span> <span class="n">x_ty</span><span class="s1">' = data_to_ty s x</span>
                                <span class="n">let</span> <span class="n">case_ty</span> <span class="o">=</span> 
                                    <span class="k">match</span> <span class="n">case_ty</span> <span class="k">with</span>
                                    <span class="o">|</span> <span class="n">Some</span> <span class="n">x_ty</span> <span class="n">when</span> <span class="n">x_ty</span><span class="s1">' &lt;&gt; x_ty -&gt; raise_type_error s &lt;| sprintf "One union case for key </span><span class="si">%s</span><span class="s1"> has a different return that the previous one.</span><span class="se">\n</span><span class="s1">Got: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">Expected: </span><span class="si">%s</span><span class="s1">" k (show_ty x_ty'</span><span class="p">)</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">x_ty</span><span class="p">)</span>
                                    <span class="o">|</span> <span class="n">Some</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">case_ty</span>
                                    <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">Some</span> <span class="n">x_ty</span><span class="s1">'</span>
                                <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">k</span> <span class="p">([</span><span class="n">a</span><span class="p">],</span> <span class="n">seq_apply</span> <span class="n">s</span> <span class="n">x</span><span class="p">)</span> <span class="n">m</span><span class="p">,</span> <span class="n">case_ty</span>
                            <span class="k">else</span>
                                <span class="n">m</span><span class="p">,</span> <span class="n">case_ty</span>
                            <span class="p">)</span> <span class="p">(</span><span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span> <span class="n">h</span><span class="o">.</span><span class="n">Item</span><span class="o">.</span><span class="n">cases</span>
                    <span class="n">push_typedop_no_rewrite</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyUnionUnbox</span><span class="p">([</span><span class="n">i</span><span class="p">],</span><span class="n">h</span><span class="p">,</span><span class="n">cases</span><span class="p">,</span><span class="kc">None</span><span class="p">))</span> <span class="p">(</span><span class="n">Option</span><span class="o">.</span><span class="n">get</span> <span class="n">case_ty</span><span class="p">)</span>
                <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">i</span> <span class="n">s</span><span class="o">.</span><span class="n">unions</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">Some</span> <span class="p">(</span><span class="n">UnionData</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">a</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">run</span> <span class="n">s</span> <span class="p">(</span><span class="n">DPair</span><span class="p">(</span><span class="n">DSymbol</span> <span class="n">k</span><span class="p">,</span> <span class="n">a</span><span class="p">))</span>
                <span class="o">|</span> <span class="n">Some</span> <span class="p">(</span><span class="n">UnionBlockers</span> <span class="n">blk</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">body</span> <span class="n">blk</span>
                <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">body</span> <span class="n">Set</span><span class="o">.</span><span class="n">empty</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected an union type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_data</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">Unbox2</span><span class="p">,[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">;</span><span class="n">on_succ</span><span class="p">;</span><span class="n">on_fail</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">add_trace</span> <span class="n">s</span> <span class="n">r</span>
            <span class="n">let</span> <span class="n">on_succ</span> <span class="o">=</span> <span class="n">term</span> <span class="n">s</span> <span class="n">on_succ</span>
            <span class="n">let</span> <span class="n">on_fail</span> <span class="o">=</span> <span class="n">term</span> <span class="n">s</span> <span class="n">on_fail</span>
            <span class="n">let</span> <span class="n">mutable</span> <span class="n">case_ty</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">let</span> <span class="n">s</span><span class="s1">' () = {s with cse = Dictionary(HashIdentity.Structural) :: s.cse; seq = ResizeArray()}</span>
            <span class="n">let</span> <span class="n">assert_case_ty</span> <span class="n">s</span> <span class="n">x</span> <span class="o">=</span>
                <span class="n">let</span> <span class="n">x_ty</span><span class="s1">' = data_to_ty s x</span>
                <span class="k">match</span> <span class="n">case_ty</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">Some</span> <span class="n">x_ty</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">x_ty</span><span class="s1">' &lt;&gt; x_ty then raise_type_error s &lt;| sprintf "One union case has a different return than the previous one.</span><span class="se">\n</span><span class="s1">Got: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">Expected: </span><span class="si">%s</span><span class="s1">" (show_ty x_ty'</span><span class="p">)</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">x_ty</span><span class="p">)</span>
                <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">case_ty</span> <span class="o">&lt;-</span> <span class="n">Some</span> <span class="n">x_ty</span><span class="s1">'</span>
            <span class="n">let</span> <span class="n">run</span> <span class="n">s</span> <span class="n">x</span> <span class="o">=</span>
                <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">apply</span> <span class="n">s</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">dyn</span> <span class="n">false</span> <span class="n">s</span>
                <span class="n">assert_case_ty</span> <span class="n">s</span> <span class="n">x</span>
                <span class="n">seq_apply</span> <span class="n">s</span> <span class="n">x</span>
            <span class="n">let</span> <span class="n">case_on_fail</span> <span class="p">()</span> <span class="o">=</span> <span class="n">run</span> <span class="p">(</span><span class="n">s</span><span class="s1">'()) (on_fail, DB)</span>
            <span class="n">let</span> <span class="n">key_value</span> <span class="o">=</span> <span class="n">function</span>
                <span class="o">|</span> <span class="n">DPair</span><span class="p">(</span><span class="n">DSymbol</span> <span class="n">k</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">k</span><span class="p">,</span> <span class="n">a</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: Malformed union."</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span><span class="p">,</span> <span class="n">term</span> <span class="n">s</span> <span class="n">b</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">DUnion</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">h</span><span class="p">),</span><span class="n">_</span><span class="p">),</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">DUnion</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">h</span><span class="s1">'),_) when h &lt;&gt; h'</span> <span class="o">-&gt;</span>
                <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The two variables have different union types.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="p">(</span><span class="n">YUnion</span> <span class="n">h</span><span class="p">))</span> <span class="p">(</span><span class="n">show_ty</span> <span class="p">(</span><span class="n">YUnion</span> <span class="n">h</span><span class="s1">'))</span>
            <span class="o">|</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">DUnion</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">),</span><span class="n">_</span><span class="p">),</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">DUnion</span><span class="p">(</span><span class="n">a</span><span class="s1">',_),_) -&gt;</span>
                <span class="n">let</span> <span class="n">k</span><span class="p">,</span><span class="n">a</span> <span class="o">=</span> <span class="n">key_value</span> <span class="n">a</span>
                <span class="n">let</span> <span class="n">k</span><span class="s1">',a'</span> <span class="o">=</span> <span class="n">key_value</span> <span class="n">a</span><span class="s1">'</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="s1">' then apply s (on_succ, DPair(DSymbol k, DPair(a, a'</span><span class="p">)))</span>
                <span class="k">else</span> <span class="n">apply</span> <span class="n">s</span> <span class="p">(</span><span class="n">on_fail</span><span class="p">,</span> <span class="n">DB</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">YUnion</span> <span class="n">h</span><span class="p">)),</span><span class="n">_</span><span class="p">),</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">DUnion</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">h</span><span class="s1">'),_) | DNominal(DUnion(_,h),_), DNominal(DV(L(_,YUnion h'</span><span class="p">)),</span><span class="n">_</span><span class="p">)</span> <span class="n">when</span> <span class="n">h</span> <span class="o">&lt;&gt;</span> <span class="n">h</span><span class="s1">' -&gt;</span>
                <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The two variables have different union types.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="p">(</span><span class="n">YUnion</span> <span class="n">h</span><span class="p">))</span> <span class="p">(</span><span class="n">show_ty</span> <span class="p">(</span><span class="n">YUnion</span> <span class="n">h</span><span class="s1">'))</span>
            <span class="o">|</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">YUnion</span> <span class="n">h</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">i</span><span class="p">),</span><span class="n">_</span><span class="p">),</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">DUnion</span><span class="p">(</span><span class="n">a</span><span class="s1">',_),_) -&gt;</span>
                <span class="n">let</span> <span class="n">k</span><span class="p">,</span><span class="n">a</span><span class="s1">' = key_value a'</span>
                <span class="n">let</span> <span class="n">v</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Item</span><span class="o">.</span><span class="n">cases</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">pick</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">name</span><span class="s1">') v -&gt; if k = name'</span> <span class="n">then</span> <span class="n">Some</span> <span class="n">v</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">let</span> <span class="n">case_on_succ</span> <span class="o">=</span>
                    <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="s1">'()</span>
                    <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">ty_to_data</span> <span class="n">s</span> <span class="n">v</span>
                    <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span> <span class="k">with</span> <span class="n">unions</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">i</span> <span class="p">(</span><span class="n">UnionData</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">a</span><span class="p">))</span> <span class="n">s</span><span class="o">.</span><span class="n">unions</span><span class="p">}</span>
                    <span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">run</span> <span class="n">s</span> <span class="p">(</span><span class="n">on_succ</span><span class="p">,</span> <span class="n">DPair</span><span class="p">(</span><span class="n">DSymbol</span> <span class="n">k</span><span class="p">,</span> <span class="n">DPair</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="s1">')))</span>
                <span class="n">push_typedop_no_rewrite</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyUnionUnbox</span><span class="p">([</span><span class="n">i</span><span class="p">],</span><span class="n">h</span><span class="p">,</span><span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">k</span> <span class="n">case_on_succ</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">,</span><span class="n">Some</span> <span class="p">(</span><span class="n">case_on_fail</span><span class="p">())))</span> <span class="p">(</span><span class="n">Option</span><span class="o">.</span><span class="n">get</span> <span class="n">case_ty</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">DUnion</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">),</span><span class="n">_</span><span class="p">),</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">YUnion</span> <span class="n">h</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">i</span><span class="s1">'),_) -&gt;</span>
                <span class="n">let</span> <span class="n">k</span><span class="p">,</span><span class="n">a</span> <span class="o">=</span> <span class="n">key_value</span> <span class="n">a</span>
                <span class="n">let</span> <span class="n">v</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Item</span><span class="o">.</span><span class="n">cases</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">pick</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">name</span><span class="s1">') v -&gt; if k = name'</span> <span class="n">then</span> <span class="n">Some</span> <span class="n">v</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">let</span> <span class="n">case_on_succ</span> <span class="o">=</span>
                    <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="s1">'()</span>
                    <span class="n">let</span> <span class="n">a</span><span class="s1">' = ty_to_data s v</span>
                    <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span> <span class="k">with</span> <span class="n">unions</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">i</span><span class="s1">' (UnionData (k,a'</span><span class="p">))</span> <span class="n">s</span><span class="o">.</span><span class="n">unions</span><span class="p">}</span>
                    <span class="p">[</span><span class="n">a</span><span class="s1">'], run s (on_succ, DPair(DSymbol k, DPair(a, a'</span><span class="p">)))</span>
                <span class="n">push_typedop_no_rewrite</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyUnionUnbox</span><span class="p">([</span><span class="n">i</span><span class="s1">'],h,Map.add k case_on_succ Map.empty,Some (case_on_fail()))) (Option.get case_ty)</span>
            <span class="o">|</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">YUnion</span> <span class="n">h</span> <span class="o">&amp;</span> <span class="n">t</span><span class="p">)),</span><span class="n">_</span><span class="p">),</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">YUnion</span> <span class="n">h</span><span class="s1">' &amp; t'</span><span class="p">)),</span><span class="n">_</span><span class="p">)</span> <span class="n">when</span> <span class="n">h</span> <span class="o">&lt;&gt;</span> <span class="n">h</span><span class="s1">' -&gt; </span>
                <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The two variables have different union types.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">t</span><span class="p">)</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">t</span><span class="s1">')</span>
            <span class="o">|</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">YUnion</span> <span class="n">h</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">i</span><span class="p">),</span><span class="n">_</span><span class="p">),</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">YUnion</span> <span class="n">_</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">i</span><span class="s1">'),_) -&gt;</span>
                <span class="n">let</span> <span class="n">cases_on_succ</span> <span class="o">=</span>
                    <span class="n">Map</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="n">v</span> <span class="o">-&gt;</span>
                        <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="s1">'()</span>
                        <span class="n">let</span> <span class="n">a</span><span class="p">,</span><span class="n">a</span><span class="s1">' = ty_to_data s v, ty_to_data s v</span>
                        <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span> <span class="k">with</span> <span class="n">unions</span> <span class="o">=</span> 
                                            <span class="n">let</span> <span class="n">u</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">unions</span> 
                                            <span class="n">let</span> <span class="n">u</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">i</span> <span class="p">(</span><span class="n">UnionData</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">a</span><span class="p">))</span> <span class="n">u</span>
                                            <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">i</span><span class="s1">' (UnionData (k,a'</span><span class="p">))</span> <span class="n">u</span>
                                            <span class="p">}</span>
                        <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">a</span><span class="s1">'], run s (on_succ, DPair(DSymbol k, DPair(a, a'</span><span class="p">)))</span>
                        <span class="p">)</span> <span class="n">h</span><span class="o">.</span><span class="n">Item</span><span class="o">.</span><span class="n">cases</span>
                    <span class="o">|&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">KeyValue</span> <span class="p">((</span><span class="n">_</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span> <span class="n">v</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                    <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">ofSeq</span>
                <span class="n">push_typedop_no_rewrite</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyUnionUnbox</span><span class="p">([</span><span class="n">i</span><span class="p">;</span><span class="n">i</span><span class="s1">'],h,cases_on_succ,Some (case_on_fail()))) (Option.get case_ty)</span>
            <span class="o">|</span> <span class="n">a</span><span class="p">,</span><span class="n">a</span><span class="s1">' -&gt; raise_type_error s &lt;| sprintf "Expected two union types.</span><span class="se">\n</span><span class="s1">Got: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">And: </span><span class="si">%s</span><span class="s1">" (show_data a) (show_data a'</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">UnionUntag</span><span class="p">,[</span><span class="n">EType</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">t</span><span class="p">);</span><span class="n">a</span><span class="p">;</span><span class="n">on_succ</span><span class="p">;</span><span class="n">on_fail</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">t</span> <span class="o">=</span> <span class="n">ty</span> <span class="n">s</span> <span class="n">t</span>
            <span class="k">match</span> <span class="n">nominal_type_apply</span> <span class="n">s</span> <span class="n">t</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">YUnion</span> <span class="n">h</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Item</span>
                <span class="n">let</span> <span class="n">on_succ</span><span class="p">,</span> <span class="n">on_fail</span> <span class="o">=</span> <span class="n">term</span> <span class="n">s</span> <span class="n">on_succ</span><span class="p">,</span> <span class="n">term</span> <span class="n">s</span> <span class="n">on_fail</span>
                <span class="n">let</span> <span class="n">lit</span> <span class="n">i</span> <span class="o">=</span>
                    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">h</span><span class="o">.</span><span class="n">tag_cases</span><span class="o">.</span><span class="n">Length</span> <span class="n">then</span>
                        <span class="n">let</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">tag_cases</span><span class="o">.</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">type_apply</span> <span class="n">s</span> <span class="p">(</span><span class="n">apply</span> <span class="n">s</span> <span class="p">(</span><span class="n">on_succ</span><span class="p">,</span> <span class="n">DSymbol</span> <span class="n">k</span><span class="p">))</span> <span class="n">v</span>
                    <span class="k">else</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="err">$</span><span class="s2">"Invalid tag 0 &lt;= </span><span class="si">{i}</span><span class="s2"> &lt; </span><span class="si">{h.tag_cases.Length}</span><span class="s2"> in UnionUntag."</span>
                <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">YPrim</span> <span class="n">Int32T</span><span class="p">)</span> <span class="k">as</span> <span class="n">tyv</span><span class="p">)</span> <span class="k">as</span> <span class="n">a</span> <span class="o">-&gt;</span> 
                    <span class="n">let</span> <span class="n">key</span> <span class="o">=</span> <span class="n">TyOp</span><span class="p">(</span><span class="n">UnionUntag</span><span class="p">,[</span><span class="n">a</span><span class="p">])</span>
                    <span class="k">match</span> <span class="n">cse_tryfind</span> <span class="n">s</span> <span class="n">key</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">Some</span><span class="p">(</span><span class="n">DLit</span><span class="p">(</span><span class="n">LitInt32</span> <span class="n">i</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">lit</span> <span class="n">i</span>
                    <span class="o">|</span> <span class="n">Some</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: Expected an 32-bit int."</span>
                    <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span>
                        <span class="n">let</span> <span class="n">on_fail</span><span class="p">,</span> <span class="n">on_fail_ty</span> <span class="o">=</span>
                            <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span> <span class="k">with</span> <span class="n">cse</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Structural</span><span class="p">)</span> <span class="p">::</span> <span class="n">s</span><span class="o">.</span><span class="n">cse</span><span class="p">;</span> <span class="n">seq</span> <span class="o">=</span> <span class="n">ResizeArray</span><span class="p">()}</span>
                            <span class="n">let</span> <span class="n">r</span> <span class="o">=</span> <span class="n">apply</span> <span class="n">s</span> <span class="p">(</span><span class="n">on_fail</span><span class="p">,</span> <span class="n">DB</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">dyn</span> <span class="n">false</span> <span class="n">s</span>
                            <span class="n">seq_apply</span> <span class="n">s</span> <span class="n">r</span><span class="p">,</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">r</span>
                        <span class="n">let</span> <span class="n">on_succ</span> <span class="o">=</span>
                            <span class="n">Array</span><span class="o">.</span><span class="n">mapi</span> <span class="p">(</span><span class="n">fun</span> <span class="n">i</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="o">-&gt;</span>
                                <span class="n">let</span> <span class="n">cse</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Structural</span><span class="p">)</span>
                                <span class="n">cse</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">DLit</span><span class="p">(</span><span class="n">LitInt32</span> <span class="n">i</span><span class="p">))</span>
                                <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span> <span class="k">with</span> <span class="n">cse</span> <span class="o">=</span> <span class="n">cse</span> <span class="p">::</span> <span class="n">s</span><span class="o">.</span><span class="n">cse</span><span class="p">;</span> <span class="n">seq</span> <span class="o">=</span> <span class="n">ResizeArray</span><span class="p">()}</span>
                                <span class="n">let</span> <span class="n">r</span> <span class="o">=</span> <span class="n">type_apply</span> <span class="n">s</span> <span class="p">(</span><span class="n">apply</span> <span class="n">s</span> <span class="p">(</span><span class="n">on_succ</span><span class="p">,</span> <span class="n">DSymbol</span> <span class="n">k</span><span class="p">))</span> <span class="n">v</span> <span class="o">|&gt;</span> <span class="n">dyn</span> <span class="n">false</span> <span class="n">s</span>
                                <span class="n">let</span> <span class="n">r_ty</span> <span class="o">=</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">r</span>
                                <span class="k">if</span> <span class="n">on_fail_ty</span> <span class="o">&lt;&gt;</span> <span class="n">r_ty</span> <span class="n">then</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Return type of the success case does not match the failure one.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">Expected: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">r_ty</span><span class="p">)</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">on_fail_ty</span><span class="p">)</span>
                                <span class="n">seq_apply</span> <span class="n">s</span> <span class="n">r</span>
                                <span class="p">)</span> <span class="n">h</span><span class="o">.</span><span class="n">tag_cases</span>
                        <span class="n">push_typedop_no_rewrite</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyIntSwitch</span><span class="p">(</span><span class="n">tyv</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">))</span> <span class="n">on_fail_ty</span>
                <span class="o">|</span> <span class="n">DLit</span><span class="p">(</span><span class="n">LitInt32</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">lit</span> <span class="n">i</span>
                <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected an i32.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_data</span> <span class="n">a</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected an union type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">t</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">ELet</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">add_trace</span> <span class="n">s</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">store_term</span> <span class="n">s</span> <span class="n">i</span> <span class="p">(</span><span class="n">term</span> <span class="n">s</span> <span class="n">a</span><span class="p">);</span> <span class="n">term</span> <span class="n">s</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">EPairTest</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">bind</span><span class="p">,</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">add_trace</span> <span class="n">s</span> <span class="n">r</span>
            <span class="k">match</span> <span class="n">v</span> <span class="n">s</span> <span class="n">bind</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DPair</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">store_term</span> <span class="n">s</span> <span class="n">p1</span> <span class="n">a</span><span class="p">;</span> <span class="n">store_term</span> <span class="n">s</span> <span class="n">p2</span> <span class="n">b</span><span class="p">;</span> <span class="n">term</span> <span class="n">s</span> <span class="n">on_succ</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">term</span> <span class="n">s</span> <span class="n">on_fail</span>
        <span class="o">|</span> <span class="n">EExistsTest</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">bind</span><span class="p">,</span><span class="n">pat_type</span><span class="p">,</span><span class="n">pat</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">add_trace</span> <span class="n">s</span> <span class="n">r</span>
            <span class="k">match</span> <span class="n">v</span> <span class="n">s</span> <span class="n">bind</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DExists</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">iter2</span> <span class="p">(</span><span class="n">store_ty</span> <span class="n">s</span><span class="p">)</span> <span class="n">pat_type</span> <span class="n">a</span><span class="p">;</span> <span class="n">store_term</span> <span class="n">s</span> <span class="n">pat</span> <span class="n">b</span><span class="p">;</span> <span class="n">term</span> <span class="n">s</span> <span class="n">on_succ</span>
            <span class="o">|</span> <span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">YExists</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="s2">"Runtime existentials cannot be destructured. They are a compile time feature only."</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">term</span> <span class="n">s</span> <span class="n">on_fail</span>
        <span class="o">|</span> <span class="n">ESymbolTest</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">bind</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">add_trace</span> <span class="n">s</span> <span class="n">r</span>
            <span class="k">match</span> <span class="n">v</span> <span class="n">s</span> <span class="n">bind</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DSymbol</span> <span class="n">a</span><span class="s1">' when a = a'</span> <span class="o">-&gt;</span> <span class="n">term</span> <span class="n">s</span> <span class="n">on_succ</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">term</span> <span class="n">s</span> <span class="n">on_fail</span>
        <span class="o">|</span> <span class="n">ERecordTest</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">bind</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">add_trace</span> <span class="n">s</span> <span class="n">r</span>
            <span class="k">match</span> <span class="n">v</span> <span class="n">s</span> <span class="n">bind</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DRecord</span> <span class="n">l</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="o">=</span> <span class="n">function</span>
                    <span class="o">|</span> <span class="n">x</span> <span class="p">::</span> <span class="n">x</span><span class="s1">' -&gt;</span>
                        <span class="n">let</span> <span class="n">sym</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span>
                            <span class="k">match</span><span class="w"> </span><span class="n">l</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryPick</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="k">_</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">k</span> <span class="o">=</span> <span class="n">a</span> <span class="n">then</span> <span class="n">Some</span> <span class="n">v</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span> <span class="k">with</span>
                            <span class="o">|</span> <span class="n">Some</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">store_term</span> <span class="n">s</span> <span class="n">b</span> <span class="n">a</span><span class="p">;</span> <span class="n">loop</span> <span class="n">x</span><span class="s1">'</span>
                            <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">term</span> <span class="n">s</span> <span class="n">on_fail</span>
                        <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
                        <span class="o">|</span> <span class="n">Symbol</span><span class="p">((</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sym</span> <span class="n">a</span> <span class="n">b</span>
                        <span class="o">|</span> <span class="n">Var</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
                            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
                            <span class="o">|</span> <span class="n">DSymbol</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">sym</span> <span class="n">a</span> <span class="n">b</span>
                            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="p">(</span><span class="n">add_trace</span> <span class="n">s</span> <span class="n">r</span><span class="p">)</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a symbol.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_data</span> <span class="n">a</span><span class="p">)</span>
                    <span class="o">|</span> <span class="p">[]</span> <span class="o">-&gt;</span> <span class="n">term</span> <span class="n">s</span> <span class="n">on_succ</span>
                <span class="n">loop</span> <span class="n">a</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">term</span> <span class="n">s</span> <span class="n">on_fail</span>
        <span class="o">|</span> <span class="n">EAnnotTest</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">bind</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">add_trace</span> <span class="n">s</span> <span class="n">r</span> <span class="ow">in</span> <span class="k">if</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="p">(</span><span class="n">v</span> <span class="n">s</span> <span class="n">bind</span><span class="p">)</span> <span class="o">=</span> <span class="n">ty</span> <span class="n">s</span> <span class="n">a</span> <span class="n">then</span> <span class="n">term</span> <span class="n">s</span> <span class="n">on_succ</span> <span class="k">else</span> <span class="n">term</span> <span class="n">s</span> <span class="n">on_fail</span>
        <span class="o">|</span> <span class="n">EUnitTest</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">bind</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">add_trace</span> <span class="n">s</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">match</span> <span class="n">v</span> <span class="n">s</span> <span class="n">bind</span> <span class="k">with</span> <span class="n">DB</span> <span class="o">-&gt;</span> <span class="n">term</span> <span class="n">s</span> <span class="n">on_succ</span> <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">term</span> <span class="n">s</span> <span class="n">on_fail</span>
        <span class="o">|</span> <span class="n">ENominalTest</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">bind</span><span class="p">,</span><span class="n">p1</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">add_trace</span> <span class="n">s</span> <span class="n">r</span>
            <span class="k">match</span> <span class="n">ty</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">YNominal</span> <span class="n">a</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">v</span> <span class="n">s</span> <span class="n">bind</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">DNominal</span><span class="p">((</span><span class="n">DUnion</span> <span class="n">_</span> <span class="o">|</span> <span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">YUnion</span> <span class="n">_</span><span class="p">))),</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="s2">"Got an union in a nominal pattern."</span>
                <span class="o">|</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
                    <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="o">=</span> <span class="n">function</span>
                        <span class="o">|</span> <span class="n">YNominal</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">a</span> <span class="o">=</span> <span class="n">b</span> <span class="n">then</span> <span class="n">store_term</span> <span class="n">s</span> <span class="n">p1</span> <span class="n">v</span><span class="p">;</span> <span class="n">term</span> <span class="n">s</span> <span class="n">on_succ</span> <span class="k">else</span> <span class="n">term</span> <span class="n">s</span> <span class="n">on_fail</span>
                        <span class="o">|</span> <span class="n">YApply</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="n">a</span>
                        <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Compiler error: Expected a deferred type apply or a nominal.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">b</span><span class="p">)</span>
                    <span class="n">loop</span> <span class="n">b</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">term</span> <span class="n">s</span> <span class="n">on_fail</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a nominal on the left side of the pattern.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">ELitTest</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">bind</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">add_trace</span> <span class="n">s</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">lit_test</span> <span class="n">s</span> <span class="n">a</span> <span class="n">bind</span> <span class="n">on_succ</span> <span class="n">on_fail</span>
        <span class="o">|</span> <span class="n">EDefaultLitTest</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">bind</span><span class="p">,</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">add_trace</span> <span class="n">s</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">lit_test</span> <span class="n">s</span> <span class="p">(</span><span class="n">default_lit</span> <span class="n">s</span> <span class="n">a</span> <span class="p">(</span><span class="n">ty</span> <span class="n">s</span> <span class="n">b</span><span class="p">))</span> <span class="n">bind</span> <span class="n">on_succ</span> <span class="n">on_fail</span>
        <span class="o">|</span> <span class="n">ETypecase</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">add_trace</span> <span class="n">s</span> <span class="n">r</span>
            <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">ty</span> <span class="n">s</span> <span class="n">a</span>
            <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="o">=</span> <span class="n">function</span>
                <span class="o">|</span> <span class="p">(</span><span class="n">a</span><span class="s1">',b) :: rest -&gt; if is_unify s (a,ty s a'</span><span class="p">)</span> <span class="n">then</span> <span class="n">Some</span><span class="p">(</span><span class="n">term</span> <span class="n">s</span> <span class="n">b</span><span class="p">)</span> <span class="k">else</span> <span class="n">loop</span> <span class="n">rest</span>
                <span class="o">|</span> <span class="p">[]</span> <span class="o">-&gt;</span> <span class="kc">None</span>
            <span class="k">match</span> <span class="n">loop</span> <span class="n">b</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">Some</span> <span class="n">r</span> <span class="o">-&gt;</span> <span class="n">r</span>
            <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Typecase miss.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">ToFunPtr</span><span class="p">,[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DFunction</span><span class="p">(</span><span class="n">body</span><span class="p">,</span><span class="n">Some</span><span class="p">(</span><span class="n">TFun</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span><span class="nb">range</span><span class="p">,</span><span class="n">_</span><span class="p">)),</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DFunction</span><span class="p">(</span><span class="n">body</span><span class="p">,</span><span class="n">Some</span><span class="p">(</span><span class="n">TFun</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span><span class="nb">range</span><span class="p">,</span><span class="n">FT_Pointer</span><span class="p">)),</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">YFun</span> <span class="n">_</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Cannot convert a runtime function to a closure. The closure conversion should be done on a compile time funciton."</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a function.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_data</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">ToFunClosure</span><span class="p">,[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DFunction</span><span class="p">(</span><span class="n">body</span><span class="p">,</span><span class="n">Some</span><span class="p">(</span><span class="n">TFun</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span><span class="nb">range</span><span class="p">,</span><span class="n">_</span><span class="p">)),</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DFunction</span><span class="p">(</span><span class="n">body</span><span class="p">,</span><span class="n">Some</span><span class="p">(</span><span class="n">TFun</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span><span class="nb">range</span><span class="p">,</span><span class="n">FT_Closure</span><span class="p">)),</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">YFun</span> <span class="n">_</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Cannot convert a runtime function to a function pointer. The pointer conversion should be done on a compile time funciton."</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a function.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_data</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">PragmaUnrollPush</span><span class="p">,[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitInt32</span> <span class="n">_</span><span class="p">)</span> <span class="k">as</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">push_op_no_rewrite</span> <span class="n">s</span> <span class="n">PragmaUnrollPush</span> <span class="n">x</span> <span class="n">YB</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected an i32 literal.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_data</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">PragmaUnrollPop</span><span class="p">,[])</span> <span class="o">-&gt;</span> 
            <span class="n">push_op_no_rewrite</span><span class="s1">' s PragmaUnrollPop [] YB</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">BackendSwitch</span><span class="p">,</span><span class="n">l</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">mutable</span> <span class="n">t</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">let</span> <span class="n">mutable</span> <span class="n">d</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">let</span> <span class="n">validate_type</span> <span class="n">t</span><span class="s1">' =</span>
                <span class="k">match</span> <span class="n">t</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">Some</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;&gt;</span> <span class="n">t</span><span class="s1">' then raise_type_error s $"The backend switch needs to have the same type for all of its branches.</span><span class="se">\n</span><span class="s1">Got: {show_ty t'</span><span class="p">}</span>\<span class="n">nExpected</span><span class="p">:</span> <span class="p">{</span><span class="n">show_ty</span> <span class="n">t</span><span class="p">}</span><span class="s2">"</span>
                <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">t</span> <span class="o">&lt;-</span> <span class="n">Some</span> <span class="n">t</span><span class="s1">'</span>
            <span class="n">l</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">function</span>
                <span class="o">|</span> <span class="n">EPair</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">ELit</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">LitString</span> <span class="n">backend</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> 
                    <span class="o">//</span> <span class="n">The</span> <span class="n">reason</span> <span class="n">why</span> <span class="n">we</span><span class="s1">'re evaling all the branches intead of just one and in this specific order is because otherwise</span>
                    <span class="o">//</span> <span class="nb">compile</span> <span class="n">time</span> <span class="n">hashmaps</span> <span class="n">could</span> <span class="n">make</span> <span class="nb">type</span> <span class="n">inference</span> <span class="n">unsound</span><span class="o">.</span>
                    <span class="k">if</span> <span class="n">backend</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">node</span> <span class="n">then</span> 
                        <span class="n">let</span> <span class="n">d</span><span class="s1">' = term s b</span>
                        <span class="n">validate_type</span> <span class="p">(</span><span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">d</span><span class="s1">')</span>
                        <span class="n">d</span> <span class="o">&lt;-</span> <span class="n">Some</span> <span class="n">d</span><span class="s1">'</span>
                    <span class="k">else</span>
                        <span class="n">let</span> <span class="n">_</span><span class="p">,</span><span class="n">t</span><span class="s1">' = term_scope s b</span>
                        <span class="n">validate_type</span> <span class="n">t</span><span class="s1">'</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="s2">"BackendSwitch should be a list of (string literal,body) pairs."</span>
                <span class="p">)</span>
            <span class="k">match</span> <span class="n">d</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">Some</span> <span class="n">cur</span> <span class="o">-&gt;</span> <span class="n">cur</span> <span class="o">|&gt;</span> <span class="n">dyn</span> <span class="n">true</span> <span class="n">s</span>
            <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="err">$</span><span class="s2">"Cannot find the backend </span><span class="si">{s.backend.node}</span><span class="s2"> in the backend switch op."</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">UsesOriginalTermVars</span><span class="p">,[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">data_term_vars</span><span class="s1">'</span>
            <span class="n">let</span> <span class="n">b</span> <span class="o">=</span> <span class="n">term</span> <span class="n">s</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">data_term_vars</span><span class="s1">'</span>
            <span class="n">let</span> <span class="n">c</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">Length</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">Length</span> <span class="o">&amp;&amp;</span> <span class="n">HashSet</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Reference</span><span class="p">)</span><span class="o">.</span><span class="n">SetEquals</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
            <span class="n">DLit</span><span class="p">(</span><span class="n">LitBool</span> <span class="n">c</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">UsesOriginalNominals</span><span class="p">,[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">data_nominals</span>
            <span class="n">let</span> <span class="n">b</span> <span class="o">=</span> <span class="n">term</span> <span class="n">s</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">data_nominals</span>
            <span class="n">let</span> <span class="n">c</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">Length</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">Length</span> <span class="o">&amp;&amp;</span> <span class="n">HashSet</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Reference</span><span class="p">)</span><span class="o">.</span><span class="n">SetEquals</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
            <span class="n">DLit</span><span class="p">(</span><span class="n">LitBool</span> <span class="n">c</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">While</span><span class="p">,[</span><span class="n">cond</span><span class="p">;</span><span class="n">body</span><span class="p">])</span> <span class="o">-&gt;</span> 
            <span class="k">match</span> <span class="n">term_scope</span> <span class="n">s</span> <span class="n">cond</span> <span class="k">with</span>
            <span class="o">|</span> <span class="p">[</span><span class="o">|</span><span class="n">TyLocalReturnOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">TyJoinPoint</span> <span class="n">cond</span><span class="p">,</span><span class="n">_</span><span class="p">)</span><span class="o">|</span><span class="p">],</span> <span class="n">ty</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">ty</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">YPrim</span> <span class="n">BoolT</span> <span class="o">-&gt;</span> 
                    <span class="k">match</span> <span class="n">term_scope</span> <span class="n">s</span> <span class="n">body</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">body</span><span class="p">,</span> <span class="n">YB</span> <span class="o">&amp;</span> <span class="n">ty</span> <span class="o">-&gt;</span> <span class="n">push_typedop</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyWhile</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span><span class="n">body</span><span class="p">))</span> <span class="n">ty</span>
                    <span class="o">|</span> <span class="n">_</span><span class="p">,</span> <span class="n">ty</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The body of the while loop must be of type unit.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">ty</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The conditional of the while loop must be of type bool.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">ty</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="s2">"The body of the conditional of the while loop must be a solitary join point."</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">Do</span><span class="p">,[</span><span class="n">body</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">term_scope</span> <span class="n">s</span> <span class="n">body</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">body</span><span class="p">,</span> <span class="n">YB</span> <span class="o">&amp;</span> <span class="n">ty</span> <span class="o">-&gt;</span> <span class="n">push_typedop</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyDo</span> <span class="n">body</span><span class="p">)</span> <span class="n">ty</span>
            <span class="o">|</span> <span class="n">_</span><span class="p">,</span> <span class="n">ty</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The body of the do binding must be of type unit.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">ty</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">Indent</span><span class="p">,[</span><span class="n">body</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">body</span><span class="p">,</span> <span class="n">ty</span> <span class="o">=</span> <span class="n">term_scope</span> <span class="n">s</span> <span class="n">body</span>
            <span class="n">push_typedop</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyIndent</span> <span class="n">body</span><span class="p">)</span> <span class="n">ty</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,(</span><span class="n">LayoutToHeap</span> <span class="o">|</span> <span class="n">LayoutToHeapMutable</span> <span class="o">|</span> <span class="n">LayoutToStackMutable</span> <span class="k">as</span> <span class="n">op</span><span class="p">),[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span> 
            <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">dyn</span> <span class="n">false</span> <span class="n">s</span> <span class="p">(</span><span class="n">term</span> <span class="n">s</span> <span class="n">a</span><span class="p">)</span>
            <span class="n">let</span> <span class="n">ty</span> <span class="o">=</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">x</span>
            <span class="n">let</span> <span class="n">layout</span> <span class="o">=</span>
                <span class="k">match</span> <span class="n">op</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">LayoutToHeap</span> <span class="o">-&gt;</span> <span class="n">Heap</span>
                <span class="o">|</span> <span class="n">LayoutToHeapMutable</span> <span class="o">-&gt;</span> <span class="n">HeapMutable</span>
                <span class="o">|</span> <span class="n">LayoutToStackMutable</span> <span class="o">-&gt;</span> <span class="n">StackMutable</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="s2">"Compiler error: Forgot a case in LayoutTo."</span>
            <span class="n">let</span> <span class="n">ret_ty</span> <span class="o">=</span> <span class="n">YLayout</span><span class="p">(</span><span class="n">ty</span><span class="p">,</span><span class="n">layout</span><span class="p">)</span>
            <span class="n">let</span> <span class="n">key</span> <span class="o">=</span> <span class="n">TyToLayout</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">ret_ty</span><span class="p">)</span>
            <span class="n">push_typedop_no_rewrite</span> <span class="n">s</span> <span class="n">key</span> <span class="n">ret_ty</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">LayoutIndex</span><span class="p">,[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span> 
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">YLayout</span><span class="p">(</span><span class="n">ty</span><span class="p">,</span><span class="n">layout</span><span class="p">))</span> <span class="k">as</span> <span class="n">tyv</span><span class="p">)</span> <span class="k">as</span> <span class="n">a</span> <span class="o">-&gt;</span> 
                <span class="k">match</span> <span class="n">layout</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">StackMutable</span> <span class="o">|</span> <span class="n">HeapMutable</span> <span class="o">-&gt;</span> <span class="n">push_typedop_no_rewrite</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyLayoutIndexAll</span> <span class="n">tyv</span><span class="p">)</span> <span class="n">ty</span>
                <span class="o">|</span> <span class="n">Heap</span> <span class="o">-&gt;</span>
                    <span class="k">match</span> <span class="n">ty</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">YRecord</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">DRecord</span><span class="p">(</span><span class="n">Map</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="n">ty</span> <span class="o">-&gt;</span> <span class="n">push_typedop</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyLayoutIndexByKey</span><span class="p">(</span><span class="n">tyv</span><span class="p">,</span><span class="n">b</span><span class="p">))</span> <span class="n">ty</span><span class="p">)</span> <span class="n">l</span><span class="p">)</span>
                    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">push_typedop</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyLayoutIndexAll</span> <span class="n">tyv</span><span class="p">)</span> <span class="n">ty</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a layout type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_data</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">TypeToVar</span><span class="p">,[</span><span class="n">EType</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)])</span> <span class="o">-&gt;</span> <span class="n">push_typedop_no_rewrite</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyOp</span><span class="p">(</span><span class="n">TypeToVar</span><span class="p">,[]))</span> <span class="p">(</span><span class="n">ty</span> <span class="n">s</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">LitToTypeLit</span><span class="p">,[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span> 
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DLit</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">DTLit</span> <span class="n">x</span>
            <span class="o">|</span> <span class="n">DSymbol</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">DSymbol</span> <span class="n">x</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a symbol or a type literal.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_data</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">LitToSymbol</span><span class="p">,[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span> 
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DLit</span> <span class="n">x</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">LitInt8</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">ToString</span><span class="p">(</span><span class="s2">"R"</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">DSymbol</span>
                <span class="o">|</span> <span class="n">LitInt16</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">ToString</span><span class="p">(</span><span class="s2">"R"</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">DSymbol</span>
                <span class="o">|</span> <span class="n">LitInt32</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">ToString</span><span class="p">(</span><span class="s2">"R"</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">DSymbol</span>
                <span class="o">|</span> <span class="n">LitInt64</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">ToString</span><span class="p">(</span><span class="s2">"R"</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">DSymbol</span>
                <span class="o">|</span> <span class="n">LitUInt8</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">ToString</span><span class="p">(</span><span class="s2">"R"</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">DSymbol</span>
                <span class="o">|</span> <span class="n">LitUInt16</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">ToString</span><span class="p">(</span><span class="s2">"R"</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">DSymbol</span>
                <span class="o">|</span> <span class="n">LitUInt32</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">ToString</span><span class="p">(</span><span class="s2">"R"</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">DSymbol</span>
                <span class="o">|</span> <span class="n">LitUInt64</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">ToString</span><span class="p">(</span><span class="s2">"R"</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">DSymbol</span>
                <span class="o">|</span> <span class="n">LitFloat32</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">ToString</span><span class="p">(</span><span class="s2">"R"</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">DSymbol</span>
                <span class="o">|</span> <span class="n">LitFloat64</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">ToString</span><span class="p">(</span><span class="s2">"R"</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">DSymbol</span>
                <span class="o">|</span> <span class="n">LitBool</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">ToString</span><span class="p">()</span> <span class="o">|&gt;</span> <span class="n">DSymbol</span>
                <span class="o">|</span> <span class="n">LitChar</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">ToString</span><span class="p">()</span> <span class="o">|&gt;</span> <span class="n">DSymbol</span>
                <span class="o">|</span> <span class="n">LitString</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">ToString</span><span class="p">()</span> <span class="o">|&gt;</span> <span class="n">DSymbol</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a symbol or a type literal.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_data</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">StringLitToSymbol</span><span class="p">,[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span> 
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DLit</span><span class="p">(</span><span class="n">LitString</span> <span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DSymbol</span> <span class="n">a</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a string literal.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_data</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">SymbolToString</span><span class="p">,[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span> 
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DSymbol</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitString</span> <span class="n">a</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a symbol.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_data</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">TypeToSymbol</span><span class="p">,[</span><span class="n">EType</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)])</span> <span class="o">-&gt;</span> 
            <span class="k">match</span> <span class="n">ty</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">YSymbol</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">DSymbol</span> <span class="n">a</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a symbol.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">TypeLitToLit</span><span class="p">,[</span><span class="n">EType</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)])</span> <span class="o">-&gt;</span> 
            <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="o">=</span> <span class="n">function</span>
                <span class="o">|</span> <span class="n">YLit</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="n">a</span>
                <span class="o">|</span> <span class="n">YSymbol</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">DSymbol</span> <span class="n">a</span>
                <span class="o">|</span> <span class="n">YNominal</span> <span class="n">_</span> <span class="o">|</span> <span class="n">YApply</span> <span class="n">_</span> <span class="k">as</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="p">(</span><span class="n">nominal_type_apply</span> <span class="n">s</span> <span class="n">a</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a type literal or a symbol.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a</span><span class="p">)</span>
            <span class="n">loop</span> <span class="p">(</span><span class="n">ty</span> <span class="n">s</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,(</span><span class="n">TypeToVar</span> <span class="o">|</span> <span class="n">TypeToSymbol</span><span class="p">),[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="s2">"Expected a type."</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">Dyn</span><span class="p">,[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">dyn</span> <span class="n">true</span> <span class="n">s</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">StringLength</span><span class="p">,[</span><span class="n">EType</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">t</span><span class="p">);</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">t</span> <span class="o">=</span> <span class="n">ty</span> <span class="n">s</span> <span class="n">t</span>
            <span class="k">if</span> <span class="n">is_any_int</span> <span class="n">t</span> <span class="o">=</span> <span class="n">false</span> <span class="n">then</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected an int.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">t</span><span class="p">)</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DLit</span><span class="p">(</span><span class="n">LitString</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> 
                <span class="k">match</span> <span class="n">t</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">YPrim</span> <span class="n">Int8T</span> <span class="o">-&gt;</span> <span class="k">try</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitInt8</span> <span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">Convert</span><span class="o">.</span><span class="n">ToSByte</span> <span class="nb">str</span><span class="o">.</span><span class="n">Length</span><span class="p">))</span> <span class="k">with</span> <span class="p">:</span><span class="err">?</span> <span class="n">System</span><span class="o">.</span><span class="n">OverflowException</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Literal conversion to i8 failed as the string length is either too large.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%i</span><span class="s2">"</span> <span class="nb">str</span><span class="o">.</span><span class="n">Length</span>
                <span class="o">|</span> <span class="n">YPrim</span> <span class="n">Int16T</span> <span class="o">-&gt;</span> <span class="k">try</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitInt16</span> <span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">Convert</span><span class="o">.</span><span class="n">ToInt16</span> <span class="nb">str</span><span class="o">.</span><span class="n">Length</span><span class="p">))</span> <span class="k">with</span> <span class="p">:</span><span class="err">?</span> <span class="n">System</span><span class="o">.</span><span class="n">OverflowException</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Literal conversion to i16 failed as the string length is either too large.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%i</span><span class="s2">"</span> <span class="nb">str</span><span class="o">.</span><span class="n">Length</span>
                <span class="o">|</span> <span class="n">YPrim</span> <span class="n">Int32T</span> <span class="o">-&gt;</span> <span class="k">try</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitInt32</span> <span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">Convert</span><span class="o">.</span><span class="n">ToInt32</span> <span class="nb">str</span><span class="o">.</span><span class="n">Length</span><span class="p">))</span> <span class="k">with</span> <span class="p">:</span><span class="err">?</span> <span class="n">System</span><span class="o">.</span><span class="n">OverflowException</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Literal conversion to i32 failed as the string length is either too large.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%i</span><span class="s2">"</span> <span class="nb">str</span><span class="o">.</span><span class="n">Length</span>
                <span class="o">|</span> <span class="n">YPrim</span> <span class="n">Int64T</span> <span class="o">-&gt;</span> <span class="k">try</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitInt64</span> <span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">Convert</span><span class="o">.</span><span class="n">ToInt64</span> <span class="nb">str</span><span class="o">.</span><span class="n">Length</span><span class="p">))</span> <span class="k">with</span> <span class="p">:</span><span class="err">?</span> <span class="n">System</span><span class="o">.</span><span class="n">OverflowException</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Literal conversion to i64 failed as the string length is either too large.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%i</span><span class="s2">"</span> <span class="nb">str</span><span class="o">.</span><span class="n">Length</span>
                <span class="o">|</span> <span class="n">YPrim</span> <span class="n">UInt8T</span> <span class="o">-&gt;</span> <span class="k">try</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitUInt8</span> <span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">Convert</span><span class="o">.</span><span class="n">ToByte</span> <span class="nb">str</span><span class="o">.</span><span class="n">Length</span><span class="p">))</span> <span class="k">with</span> <span class="p">:</span><span class="err">?</span> <span class="n">System</span><span class="o">.</span><span class="n">OverflowException</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Literal conversion to u8 failed as the string length is either too large.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%i</span><span class="s2">"</span> <span class="nb">str</span><span class="o">.</span><span class="n">Length</span>
                <span class="o">|</span> <span class="n">YPrim</span> <span class="n">UInt16T</span> <span class="o">-&gt;</span> <span class="k">try</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitUInt16</span> <span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">Convert</span><span class="o">.</span><span class="n">ToUInt16</span> <span class="nb">str</span><span class="o">.</span><span class="n">Length</span><span class="p">))</span> <span class="k">with</span> <span class="p">:</span><span class="err">?</span> <span class="n">System</span><span class="o">.</span><span class="n">OverflowException</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Literal conversion to u16 failed as the string length is either too large.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%i</span><span class="s2">"</span> <span class="nb">str</span><span class="o">.</span><span class="n">Length</span>
                <span class="o">|</span> <span class="n">YPrim</span> <span class="n">UInt32T</span> <span class="o">-&gt;</span> <span class="k">try</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitUInt32</span> <span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">Convert</span><span class="o">.</span><span class="n">ToUInt32</span> <span class="nb">str</span><span class="o">.</span><span class="n">Length</span><span class="p">))</span> <span class="k">with</span> <span class="p">:</span><span class="err">?</span> <span class="n">System</span><span class="o">.</span><span class="n">OverflowException</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Literal conversion to u32 failed as the string length is either too large.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%i</span><span class="s2">"</span> <span class="nb">str</span><span class="o">.</span><span class="n">Length</span>
                <span class="o">|</span> <span class="n">YPrim</span> <span class="n">UInt64T</span> <span class="o">-&gt;</span> <span class="k">try</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitUInt64</span> <span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">Convert</span><span class="o">.</span><span class="n">ToUInt64</span> <span class="nb">str</span><span class="o">.</span><span class="n">Length</span><span class="p">))</span> <span class="k">with</span> <span class="p">:</span><span class="err">?</span> <span class="n">System</span><span class="o">.</span><span class="n">OverflowException</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Literal conversion to u64 failed as the string length is either too large.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%i</span><span class="s2">"</span> <span class="nb">str</span><span class="o">.</span><span class="n">Length</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"impossible"</span>
            <span class="o">|</span> <span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">YPrim</span> <span class="n">StringT</span><span class="p">))</span> <span class="o">&amp;</span> <span class="nb">str</span> <span class="o">-&gt;</span> <span class="n">push_typedop</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyStringLength</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="nb">str</span><span class="p">))</span> <span class="n">t</span>
            <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a string.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_data</span> <span class="n">x</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">StringIndex</span><span class="p">,[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">term2</span> <span class="n">s</span> <span class="n">a</span> <span class="n">b</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DLit</span><span class="p">(</span><span class="n">LitString</span> <span class="n">a</span><span class="p">),</span> <span class="n">DLit</span> <span class="n">b</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">b</span> <span class="o">=</span> <span class="n">to_i32</span> <span class="n">b</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">b</span> <span class="o">&amp;&amp;</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="n">a</span><span class="o">.</span><span class="n">Length</span> <span class="n">then</span> <span class="n">a</span><span class="o">.</span><span class="p">[</span><span class="nb">int</span> <span class="n">b</span><span class="p">]</span> <span class="o">|&gt;</span> <span class="n">LitChar</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="k">else</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Cannot index into a string of length </span><span class="si">%i</span><span class="s2"> at index </span><span class="si">%i</span><span class="s2">."</span> <span class="n">a</span><span class="o">.</span><span class="n">Length</span> <span class="n">b</span>
            <span class="o">|</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">a</span><span class="p">,</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">b</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">YPrim</span> <span class="n">StringT</span><span class="p">,</span><span class="n">bt</span> <span class="n">when</span> <span class="n">is_any_int</span> <span class="n">bt</span> <span class="o">-&gt;</span> <span class="n">push_binop</span> <span class="n">s</span> <span class="n">StringIndex</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="p">(</span><span class="n">YPrim</span> <span class="n">CharT</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a string and an int as arguments.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">And: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">StringSlice</span><span class="p">,[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">;</span><span class="n">c</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">term3</span> <span class="n">s</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DLit</span><span class="p">(</span><span class="n">LitString</span> <span class="n">a</span><span class="p">),</span> <span class="n">DLit</span> <span class="n">b</span><span class="p">,</span> <span class="n">DLit</span> <span class="n">c</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">b</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span> <span class="n">to_i32</span> <span class="n">b</span><span class="p">,</span> <span class="n">to_i32</span> <span class="n">c</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">b</span> <span class="o">&amp;&amp;</span> <span class="n">b</span> <span class="o">&lt;=</span> <span class="n">c</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="n">a</span><span class="o">.</span><span class="n">Length</span> <span class="n">then</span> <span class="n">a</span><span class="o">.</span><span class="p">[</span><span class="nb">int</span> <span class="n">b</span><span class="o">..</span><span class="n">int</span> <span class="n">c</span><span class="p">]</span> <span class="o">|&gt;</span> <span class="n">LitString</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="k">else</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"String of length </span><span class="si">%i</span><span class="s2">'s slice from </span><span class="si">%i</span><span class="s2"> to </span><span class="si">%i</span><span class="s2"> is invalid."</span> <span class="n">a</span><span class="o">.</span><span class="n">Length</span> <span class="n">b</span> <span class="n">c</span>
            <span class="o">|</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">a</span><span class="p">,</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">b</span><span class="p">,</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">c</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">YPrim</span> <span class="n">StringT</span><span class="p">,</span> <span class="n">bt</span><span class="p">,</span> <span class="n">ct</span> <span class="n">when</span> <span class="n">is_any_int</span> <span class="n">bt</span> <span class="o">&amp;&amp;</span> <span class="n">is_any_int</span> <span class="n">ct</span> <span class="o">-&gt;</span> <span class="n">push_triop</span> <span class="n">s</span> <span class="n">StringSlice</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="p">(</span><span class="n">YPrim</span> <span class="n">StringT</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a string and two ints as arguments.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">And: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">And: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">b</span><span class="p">)</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">c</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EArray</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">ty</span> <span class="n">s</span> <span class="n">b</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">YArray</span> <span class="n">el</span> <span class="k">as</span> <span class="n">b</span> <span class="o">-&gt;</span> 
                <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> 
                    <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> 
                        <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">term</span> <span class="n">s</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">dyn</span> <span class="n">false</span> <span class="n">s</span>
                        <span class="n">let</span> <span class="n">x_ty</span> <span class="o">=</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">x</span>
                        <span class="k">if</span> <span class="n">x_ty</span> <span class="o">=</span> <span class="n">el</span> <span class="n">then</span> <span class="n">x</span> 
                        <span class="k">else</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="err">$</span><span class="s2">"All the elements in the array literal have to be the type {show_ty el}.</span><span class="se">\n</span><span class="s2">Got: {show_ty x_ty}"</span>
                        <span class="p">)</span> <span class="n">a</span>
                <span class="n">push_typedop_no_rewrite</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyArrayLiteral</span><span class="p">(</span><span class="n">el</span><span class="p">,</span><span class="n">a</span><span class="p">))</span> <span class="n">b</span>
            <span class="o">|</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="err">$</span><span class="s2">"Expected an array_base.</span><span class="se">\n</span><span class="s2">Got: {show_ty b}"</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">ArrayCreate</span><span class="p">,[</span><span class="n">EType</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">);</span><span class="n">b</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="n">ty</span> <span class="n">s</span> <span class="n">a</span><span class="p">,</span> <span class="n">term</span> <span class="n">s</span> <span class="n">b</span>
            <span class="k">match</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">b</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">bt</span> <span class="n">when</span> <span class="n">is_any_int</span> <span class="n">bt</span> <span class="o">-&gt;</span> <span class="n">push_typedop_no_rewrite</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyArrayCreate</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span> <span class="p">(</span><span class="n">YArray</span> <span class="n">a</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected an int as the size of the array.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">ArrayLength</span><span class="p">,[</span><span class="n">EType</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">t</span><span class="p">);</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">t</span> <span class="o">=</span> <span class="n">ty</span> <span class="n">s</span> <span class="n">t</span>
            <span class="k">if</span> <span class="n">is_any_int</span> <span class="n">t</span> <span class="o">=</span> <span class="n">false</span> <span class="n">then</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected an int.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">t</span><span class="p">)</span>
            <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span>
            <span class="k">match</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">YArray</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">push_typedop</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyArrayLength</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">a</span><span class="p">))</span> <span class="n">t</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected an array_base.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">ArrayIndex</span><span class="p">,[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">YArray</span> <span class="n">ty</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">a</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">b</span> <span class="o">=</span> <span class="n">term</span> <span class="n">s</span> <span class="n">b</span>
                <span class="k">match</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">b</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">bt</span> <span class="n">when</span> <span class="n">is_any_int</span> <span class="n">bt</span> <span class="o">-&gt;</span> <span class="n">push_binop_no_rewrite</span> <span class="n">s</span> <span class="n">ArrayIndex</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="n">ty</span>
                <span class="o">|</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected an int as the index argumet.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected an array_base.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_data</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">ArrayIndexSet</span><span class="p">,[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">;</span><span class="n">c</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">YArray</span> <span class="n">ty</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">a</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">b</span> <span class="o">=</span> <span class="n">term</span> <span class="n">s</span> <span class="n">b</span>
                <span class="k">match</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">b</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">bt</span> <span class="n">when</span> <span class="n">is_any_int</span> <span class="n">bt</span> <span class="o">-&gt;</span> 
                    <span class="n">let</span> <span class="n">c</span> <span class="o">=</span> <span class="n">term</span> <span class="n">s</span> <span class="n">c</span> <span class="o">|&gt;</span> <span class="n">dyn</span> <span class="n">false</span> <span class="n">s</span>
                    <span class="n">let</span> <span class="n">ty</span><span class="s1">' = data_to_ty s c</span>
                    <span class="k">if</span> <span class="n">ty</span><span class="s1">' = ty then push_triop_no_rewrite s ArrayIndexSet (a,b,c) YB</span>
                    <span class="k">else</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The array and the value being set do not have the same type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">Expected: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">ty</span><span class="s1">') (show_ty ty)</span>
                <span class="o">|</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected an int as the index argumet.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected an array_base.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_data</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">RecordMap</span><span class="p">,[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">term2</span> <span class="n">s</span> <span class="n">a</span> <span class="n">b</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="n">DRecord</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">_i</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">apply</span> <span class="n">s</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">record2</span> <span class="p">((</span><span class="n">l</span><span class="o">.</span><span class="n">Count</span><span class="p">,</span> <span class="s2">"key"</span><span class="p">),</span> <span class="n">DSymbol</span> <span class="n">k</span><span class="p">)</span> <span class="p">(((</span><span class="n">l</span><span class="o">.</span><span class="n">Count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">"value"</span><span class="p">),</span> <span class="n">v</span><span class="p">)))</span> <span class="n">l</span> <span class="o">|&gt;</span> <span class="n">DRecord</span>
            <span class="o">|</span> <span class="n">_</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a record.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_data</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">RecordIter</span><span class="p">,[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">term2</span> <span class="n">s</span> <span class="n">a</span> <span class="n">b</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="n">DRecord</span> <span class="n">l</span> <span class="o">-&gt;</span> 
                <span class="n">Map</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="n">v</span> <span class="o">-&gt;</span>
                    <span class="k">match</span> <span class="n">apply</span> <span class="n">s</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">record2</span> <span class="p">((</span><span class="n">l</span><span class="o">.</span><span class="n">Count</span><span class="p">,</span> <span class="s2">"key"</span><span class="p">),</span> <span class="n">DSymbol</span> <span class="n">k</span><span class="p">)</span> <span class="p">(((</span><span class="n">l</span><span class="o">.</span><span class="n">Count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">"value"</span><span class="p">),</span> <span class="n">v</span><span class="p">))</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">DB</span> <span class="o">-&gt;</span> <span class="p">()</span>
                    <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected an unit value.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_data</span> <span class="n">x</span><span class="p">)</span>
                    <span class="p">)</span> <span class="n">l</span> 
                <span class="n">DB</span>
            <span class="o">|</span> <span class="n">_</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a record.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_data</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">RecordFilter</span><span class="p">,[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">term2</span> <span class="n">s</span> <span class="n">a</span> <span class="n">b</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="n">DRecord</span> <span class="n">l</span> <span class="o">-&gt;</span>
                <span class="n">Map</span><span class="o">.</span><span class="n">filter</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">_i</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="n">v</span> <span class="o">-&gt;</span>
                    <span class="k">match</span> <span class="n">apply</span> <span class="n">s</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">record2</span> <span class="p">((</span><span class="n">l</span><span class="o">.</span><span class="n">Count</span><span class="p">,</span> <span class="s2">"key"</span><span class="p">),</span> <span class="n">DSymbol</span> <span class="n">k</span><span class="p">)</span> <span class="p">(((</span><span class="n">l</span><span class="o">.</span><span class="n">Count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">"value"</span><span class="p">),</span> <span class="n">v</span><span class="p">))</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">DLit</span><span class="p">(</span><span class="n">LitBool</span> <span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">x</span>
                    <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a bool literal.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_data</span> <span class="n">x</span><span class="p">)</span>
                    <span class="p">)</span> <span class="n">l</span>
                <span class="o">|&gt;</span> <span class="n">DRecord</span>
            <span class="o">|</span> <span class="n">_</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a record.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_data</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">RecordFold</span><span class="p">,[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">;</span><span class="n">c</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">term3</span> <span class="n">s</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">DRecord</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">state</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">apply</span> <span class="n">s</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">record3</span> <span class="p">((</span><span class="n">l</span><span class="o">.</span><span class="n">Count</span><span class="p">,</span> <span class="s2">"state"</span><span class="p">),</span> <span class="n">state</span><span class="p">)</span> <span class="p">(((</span><span class="n">l</span><span class="o">.</span><span class="n">Count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">"key"</span><span class="p">),</span> <span class="n">DSymbol</span> <span class="n">k</span><span class="p">)</span> <span class="p">(((</span><span class="n">l</span><span class="o">.</span><span class="n">Count</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">"value"</span><span class="p">),</span> <span class="n">v</span><span class="p">)))</span> <span class="n">state</span> <span class="n">l</span>
            <span class="o">|</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">r</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a record.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_data</span> <span class="n">r</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">RecordFoldBack</span><span class="p">,[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">;</span><span class="n">c</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">term3</span> <span class="n">s</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">DRecord</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="n">v</span> <span class="n">state</span> <span class="o">-&gt;</span> <span class="n">apply</span> <span class="n">s</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">record3</span> <span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="s2">"state"</span><span class="p">),</span> <span class="n">state</span><span class="p">)</span> <span class="p">(((</span><span class="n">l</span><span class="o">.</span><span class="n">Count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">"key"</span><span class="p">),</span> <span class="n">DSymbol</span> <span class="n">k</span><span class="p">)</span> <span class="p">(((</span><span class="n">l</span><span class="o">.</span><span class="n">Count</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">"value"</span><span class="p">),</span> <span class="n">v</span><span class="p">)))</span> <span class="n">l</span> <span class="n">state</span>
            <span class="o">|</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">r</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a record.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_data</span> <span class="n">r</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">RecordLength</span><span class="p">,[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DRecord</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">count</span> <span class="n">l</span> <span class="o">|&gt;</span> <span class="n">LitInt32</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
            <span class="o">|</span> <span class="n">r</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a record.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_data</span> <span class="n">r</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">RecordTypeMap</span><span class="p">,[</span><span class="n">a</span><span class="p">;</span><span class="n">EType</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">b</span><span class="p">)])</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">a</span><span class="p">,</span><span class="n">l</span> <span class="o">=</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span><span class="p">,</span> <span class="n">ty_record</span> <span class="n">s</span> <span class="n">b</span>
            <span class="n">Map</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">_i</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">type_apply</span> <span class="n">s</span> <span class="p">(</span><span class="n">apply</span> <span class="n">s</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">DSymbol</span> <span class="n">k</span><span class="p">))</span> <span class="n">v</span><span class="p">)</span> <span class="n">l</span> <span class="o">|&gt;</span> <span class="n">DRecord</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">RecordTypeIter</span><span class="p">,[</span><span class="n">a</span><span class="p">;</span><span class="n">EType</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">b</span><span class="p">)])</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">a</span><span class="p">,</span><span class="n">l</span> <span class="o">=</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span><span class="p">,</span> <span class="n">ty_record</span> <span class="n">s</span> <span class="n">b</span>
            <span class="n">Map</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">_i</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="n">v</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">type_apply</span> <span class="n">s</span> <span class="p">(</span><span class="n">apply</span> <span class="n">s</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">DSymbol</span> <span class="n">k</span><span class="p">))</span> <span class="n">v</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">DB</span> <span class="o">-&gt;</span> <span class="p">()</span>
                <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected an unit value.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_data</span> <span class="n">x</span><span class="p">)</span>
                <span class="p">)</span> <span class="n">l</span> 
            <span class="n">DB</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">RecordTypeFold</span><span class="p">,[</span><span class="n">f</span><span class="p">;</span><span class="n">state</span><span class="p">;</span><span class="n">EType</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)])</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">f</span><span class="p">,</span><span class="n">state</span><span class="p">,</span><span class="n">l</span> <span class="o">=</span> <span class="n">term</span> <span class="n">s</span> <span class="n">f</span><span class="p">,</span> <span class="n">term</span> <span class="n">s</span> <span class="n">state</span><span class="p">,</span> <span class="n">ty_record</span> <span class="n">s</span> <span class="n">x</span>
            <span class="n">Map</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">state</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">type_apply</span> <span class="n">s</span> <span class="p">(</span><span class="n">apply</span> <span class="n">s</span> <span class="p">((</span><span class="n">apply</span> <span class="n">s</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">state</span><span class="p">),</span> <span class="n">DSymbol</span> <span class="n">k</span><span class="p">)))</span> <span class="n">v</span><span class="p">)</span> <span class="n">state</span> <span class="n">l</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">RecordTypeFoldBack</span><span class="p">,[</span><span class="n">f</span><span class="p">;</span><span class="n">state</span><span class="p">;</span><span class="n">EType</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)])</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">f</span><span class="p">,</span><span class="n">state</span><span class="p">,</span><span class="n">l</span> <span class="o">=</span> <span class="n">term</span> <span class="n">s</span> <span class="n">f</span><span class="p">,</span> <span class="n">term</span> <span class="n">s</span> <span class="n">state</span><span class="p">,</span> <span class="n">ty_record</span> <span class="n">s</span> <span class="n">x</span>
            <span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="n">v</span> <span class="n">state</span> <span class="o">-&gt;</span> <span class="n">apply</span> <span class="n">s</span> <span class="p">((</span><span class="n">type_apply</span> <span class="n">s</span> <span class="p">(</span><span class="n">apply</span> <span class="n">s</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">DSymbol</span> <span class="n">k</span><span class="p">))</span> <span class="n">v</span><span class="p">),</span> <span class="n">state</span><span class="p">))</span> <span class="n">l</span> <span class="n">state</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">RecordTypeLength</span><span class="p">,[</span><span class="n">EType</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)])</span> <span class="o">-&gt;</span>
            <span class="n">Map</span><span class="o">.</span><span class="n">count</span> <span class="p">(</span><span class="n">ty_record</span> <span class="n">s</span> <span class="n">a</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">LitInt32</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">RecordTypeTryFind</span><span class="p">,[</span><span class="n">EType</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">);</span><span class="n">k</span><span class="p">;</span><span class="n">on_succ</span><span class="p">;</span><span class="n">on_fail</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">ty_record</span> <span class="n">s</span> <span class="n">a</span><span class="p">,</span> <span class="n">term</span> <span class="n">s</span> <span class="n">k</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">l</span><span class="p">,</span> <span class="n">DSymbol</span> <span class="n">k</span> <span class="o">-&gt;</span>
                <span class="k">match</span><span class="w"> </span><span class="n">l</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryPick</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="k">_</span><span class="p">,</span> <span class="n">k</span><span class="s1">') v -&gt; if k'</span> <span class="o">=</span> <span class="n">k</span> <span class="n">then</span> <span class="n">Some</span> <span class="n">v</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">Some</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">type_apply</span> <span class="n">s</span> <span class="p">(</span><span class="n">term</span> <span class="n">s</span> <span class="n">on_succ</span><span class="p">)</span> <span class="n">v</span>
                <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">apply</span> <span class="n">s</span> <span class="p">(</span><span class="n">term</span> <span class="n">s</span> <span class="n">on_fail</span><span class="p">,</span> <span class="n">DB</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">_</span><span class="p">,</span> <span class="n">k</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a symbol.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_data</span> <span class="n">k</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">UnionToRecord</span><span class="p">,[</span><span class="n">EType</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">);</span><span class="n">on_succ</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="n">type_apply</span> <span class="n">s</span> <span class="p">(</span><span class="n">term</span> <span class="n">s</span> <span class="n">on_succ</span><span class="p">)</span> <span class="p">(</span><span class="n">YRecord</span> <span class="p">(</span><span class="n">ty_union</span> <span class="n">s</span> <span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">Item</span><span class="o">.</span><span class="n">cases</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">Add</span><span class="p">,[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">])</span> <span class="o">-&gt;</span> 
            <span class="n">let</span> <span class="n">inline</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
            <span class="k">match</span> <span class="n">term2</span> <span class="n">s</span> <span class="n">a</span> <span class="n">b</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DLit</span> <span class="n">a</span><span class="p">,</span> <span class="n">DLit</span> <span class="n">b</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">LitInt8</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt8</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitInt8</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt16</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt16</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitInt16</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitInt32</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt64</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitInt64</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt8</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt8</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitUInt8</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt16</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt16</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitUInt16</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitUInt32</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt64</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitUInt64</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitFloat32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitFloat32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">nan_guardf32</span>  <span class="o">|&gt;</span> <span class="n">LitFloat32</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitFloat64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitFloat64</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">nan_guardf64</span> <span class="o">|&gt;</span> <span class="n">LitFloat64</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The two literals must be both numeric and equal in type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">a_ty</span><span class="p">,</span> <span class="n">b_ty</span> <span class="o">=</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">a</span><span class="p">,</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">b</span> 
                <span class="k">if</span> <span class="n">a_ty</span> <span class="o">=</span> <span class="n">b_ty</span> <span class="n">then</span>
                    <span class="k">if</span> <span class="n">is_lit_zero</span> <span class="n">a</span> <span class="n">then</span> <span class="n">b</span>
                    <span class="k">elif</span> <span class="n">is_lit_zero</span> <span class="n">b</span> <span class="n">then</span> <span class="n">a</span>
                    <span class="k">elif</span> <span class="n">is_numeric</span> <span class="n">a_ty</span> <span class="n">then</span> <span class="n">push_binop</span> <span class="n">s</span> <span class="n">Add</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="n">a_ty</span>
                    <span class="k">else</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The type of the two arguments needs to be a numeric type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a_ty</span><span class="p">)</span>
                <span class="k">else</span>
                    <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The two sides need to have the same numeric types.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">."</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a_ty</span><span class="p">)</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">b_ty</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">Sub</span><span class="p">,[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">inline</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span>
            <span class="k">match</span> <span class="n">term2</span> <span class="n">s</span> <span class="n">a</span> <span class="n">b</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DLit</span> <span class="n">a</span><span class="p">,</span> <span class="n">DLit</span> <span class="n">b</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">LitInt8</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt8</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitInt8</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt16</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt16</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitInt16</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitInt32</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt64</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitInt64</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt8</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt8</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitUInt8</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt16</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt16</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitUInt16</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitUInt32</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt64</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitUInt64</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitFloat32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitFloat32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">nan_guardf32</span>  <span class="o">|&gt;</span> <span class="n">LitFloat32</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitFloat64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitFloat64</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">nan_guardf64</span> <span class="o">|&gt;</span> <span class="n">LitFloat64</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The two literals must be both numeric and equal in type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">a_ty</span><span class="p">,</span> <span class="n">b_ty</span> <span class="o">=</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">a</span><span class="p">,</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">b</span> 
                <span class="k">if</span> <span class="n">a_ty</span> <span class="o">=</span> <span class="n">b_ty</span> <span class="n">then</span>
                    <span class="k">if</span> <span class="n">is_lit_zero</span> <span class="n">a</span> <span class="o">&amp;&amp;</span> <span class="n">is_signed_numeric</span> <span class="n">a_ty</span> <span class="n">then</span> <span class="n">push_op</span> <span class="n">s</span> <span class="n">Neg</span> <span class="n">b</span> <span class="n">b_ty</span>
                    <span class="k">elif</span> <span class="n">is_lit_zero</span> <span class="n">b</span> <span class="n">then</span> <span class="n">a</span>
                    <span class="k">elif</span> <span class="n">is_any_int</span> <span class="n">a_ty</span> <span class="o">&amp;&amp;</span> <span class="n">a</span> <span class="o">=</span> <span class="n">b</span> <span class="n">then</span> <span class="n">DLit</span><span class="p">(</span><span class="n">lit_zero</span> <span class="n">a_ty</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">is_numeric</span> <span class="n">a_ty</span> <span class="n">then</span> <span class="n">push_binop</span> <span class="n">s</span> <span class="n">Sub</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="n">a_ty</span>
                    <span class="k">else</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The type of the two arguments needs to be a numeric type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a_ty</span><span class="p">)</span>
                <span class="k">else</span>
                    <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The two sides need to have the same numeric types.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">."</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a_ty</span><span class="p">)</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">b_ty</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">Mult</span><span class="p">,[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">inline</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span>
            <span class="k">match</span> <span class="n">term2</span> <span class="n">s</span> <span class="n">a</span> <span class="n">b</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DLit</span> <span class="n">a</span><span class="p">,</span> <span class="n">DLit</span> <span class="n">b</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">LitInt8</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt8</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitInt8</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt16</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt16</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitInt16</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitInt32</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt64</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitInt64</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt8</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt8</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitUInt8</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt16</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt16</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitUInt16</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitUInt32</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt64</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitUInt64</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitFloat32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitFloat32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">nan_guardf32</span>  <span class="o">|&gt;</span> <span class="n">LitFloat32</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitFloat64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitFloat64</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">nan_guardf64</span> <span class="o">|&gt;</span> <span class="n">LitFloat64</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The two literals must be both numeric and equal in type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">a_ty</span><span class="p">,</span> <span class="n">b_ty</span> <span class="o">=</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">a</span><span class="p">,</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">b</span> 
                <span class="k">if</span> <span class="n">a_ty</span> <span class="o">=</span> <span class="n">b_ty</span> <span class="n">then</span>
                    <span class="k">if</span> <span class="n">is_int_lit_zero</span> <span class="n">a</span> <span class="o">||</span> <span class="n">is_int_lit_zero</span> <span class="n">b</span> <span class="n">then</span> <span class="n">lit_zero</span> <span class="n">a_ty</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                    <span class="k">elif</span> <span class="n">is_lit_one</span> <span class="n">a</span> <span class="n">then</span> <span class="n">b</span>
                    <span class="k">elif</span> <span class="n">is_lit_one</span> <span class="n">b</span> <span class="n">then</span> <span class="n">a</span>
                    <span class="k">elif</span> <span class="n">is_numeric</span> <span class="n">a_ty</span> <span class="n">then</span> <span class="n">push_binop</span> <span class="n">s</span> <span class="n">Mult</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="n">a_ty</span>
                    <span class="k">else</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The type of the two arguments needs to be a numeric type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a_ty</span><span class="p">)</span>
                <span class="k">else</span>
                    <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The two sides need to have the same numeric types.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">."</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a_ty</span><span class="p">)</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">b_ty</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">Div</span><span class="p">,[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">])</span> <span class="o">-&gt;</span> 
            <span class="n">let</span> <span class="n">inline</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">/</span> <span class="n">b</span>
            <span class="k">try</span>
                <span class="k">match</span> <span class="n">term2</span> <span class="n">s</span> <span class="n">a</span> <span class="n">b</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">DLit</span> <span class="n">a</span><span class="p">,</span> <span class="n">DLit</span> <span class="n">b</span> <span class="o">-&gt;</span>
                    <span class="k">match</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">LitInt8</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt8</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitInt8</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                    <span class="o">|</span> <span class="n">LitInt16</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt16</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitInt16</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                    <span class="o">|</span> <span class="n">LitInt32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitInt32</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                    <span class="o">|</span> <span class="n">LitInt64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt64</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitInt64</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                    <span class="o">|</span> <span class="n">LitUInt8</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt8</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitUInt8</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                    <span class="o">|</span> <span class="n">LitUInt16</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt16</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitUInt16</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                    <span class="o">|</span> <span class="n">LitUInt32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitUInt32</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                    <span class="o">|</span> <span class="n">LitUInt64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt64</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitUInt64</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                    <span class="o">|</span> <span class="n">LitFloat32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitFloat32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">nan_guardf32</span>  <span class="o">|&gt;</span> <span class="n">LitFloat32</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                    <span class="o">|</span> <span class="n">LitFloat64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitFloat64</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">nan_guardf64</span> <span class="o">|&gt;</span> <span class="n">LitFloat64</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                    <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The two literals must be both numeric and equal in type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span>
                    <span class="n">let</span> <span class="n">a_ty</span><span class="p">,</span> <span class="n">b_ty</span> <span class="o">=</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">a</span><span class="p">,</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">b</span> 
                    <span class="k">if</span> <span class="n">a_ty</span> <span class="o">=</span> <span class="n">b_ty</span> <span class="n">then</span>
                        <span class="k">if</span> <span class="n">is_lit_zero</span> <span class="n">b</span> <span class="n">then</span> <span class="k">raise</span> <span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">DivideByZeroException</span><span class="p">())</span>
                        <span class="k">elif</span> <span class="n">is_lit_one</span> <span class="n">b</span> <span class="n">then</span> <span class="n">a</span>
                        <span class="k">elif</span> <span class="n">is_numeric</span> <span class="n">a_ty</span> <span class="n">then</span> <span class="n">push_binop</span> <span class="n">s</span> <span class="n">Div</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="n">a_ty</span>
                        <span class="k">else</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The type of the two arguments needs to be a numeric type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a_ty</span><span class="p">)</span>
                    <span class="k">else</span>
                        <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The two sides need to have the same numeric types.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">."</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a_ty</span><span class="p">)</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">b_ty</span><span class="p">)</span>
            <span class="k">with</span> <span class="p">:</span><span class="err">?</span> <span class="n">System</span><span class="o">.</span><span class="n">DivideByZeroException</span> <span class="o">-&gt;</span>
                <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"An attempt to divide by zero has been detected at compile time."</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">Pow</span><span class="p">,[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">])</span> <span class="o">-&gt;</span> 
            <span class="n">let</span> <span class="n">inline</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">**</span> <span class="n">b</span>
            <span class="k">match</span> <span class="n">term2</span> <span class="n">s</span> <span class="n">a</span> <span class="n">b</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DLit</span> <span class="n">a</span><span class="p">,</span> <span class="n">DLit</span> <span class="n">b</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">LitFloat32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitFloat32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">nan_guardf32</span> <span class="o">|&gt;</span> <span class="n">LitFloat32</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitFloat64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitFloat64</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">nan_guardf64</span> <span class="o">|&gt;</span> <span class="n">LitFloat64</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The two literals must be both float and equal in type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">a_ty</span><span class="p">,</span> <span class="n">b_ty</span> <span class="o">=</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">a</span><span class="p">,</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">b</span> 
                <span class="k">if</span> <span class="n">a_ty</span> <span class="o">=</span> <span class="n">b_ty</span> <span class="o">&amp;&amp;</span> <span class="n">is_float</span> <span class="n">a_ty</span> <span class="n">then</span> <span class="n">push_binop</span> <span class="n">s</span> <span class="n">Pow</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="n">a_ty</span>
                <span class="k">else</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The two sides need to have the same float types.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">."</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a_ty</span><span class="p">)</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">b_ty</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">Mod</span><span class="p">,[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">])</span> <span class="o">-&gt;</span> 
            <span class="n">let</span> <span class="n">inline</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">%</span> <span class="n">b</span>
            <span class="k">try</span>
                <span class="k">match</span> <span class="n">term2</span> <span class="n">s</span> <span class="n">a</span> <span class="n">b</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">DLit</span> <span class="n">a</span><span class="p">,</span> <span class="n">DLit</span> <span class="n">b</span> <span class="o">-&gt;</span>
                    <span class="k">match</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">LitInt8</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt8</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitInt8</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                    <span class="o">|</span> <span class="n">LitInt16</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt16</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitInt16</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                    <span class="o">|</span> <span class="n">LitInt32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitInt32</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                    <span class="o">|</span> <span class="n">LitInt64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt64</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitInt64</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                    <span class="o">|</span> <span class="n">LitUInt8</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt8</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitUInt8</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                    <span class="o">|</span> <span class="n">LitUInt16</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt16</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitUInt16</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                    <span class="o">|</span> <span class="n">LitUInt32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitUInt32</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                    <span class="o">|</span> <span class="n">LitUInt64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt64</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitUInt64</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                    <span class="o">|</span> <span class="n">LitFloat32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitFloat32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">nan_guardf32</span>  <span class="o">|&gt;</span> <span class="n">LitFloat32</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                    <span class="o">|</span> <span class="n">LitFloat64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitFloat64</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">nan_guardf64</span> <span class="o">|&gt;</span> <span class="n">LitFloat64</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                    <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The two literals must be both numeric and equal in type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span>
                    <span class="n">let</span> <span class="n">a_ty</span><span class="p">,</span> <span class="n">b_ty</span> <span class="o">=</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">a</span><span class="p">,</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">b</span> 
                    <span class="k">if</span> <span class="n">a_ty</span> <span class="o">=</span> <span class="n">b_ty</span> <span class="n">then</span>
                        <span class="k">if</span> <span class="n">is_lit_zero</span> <span class="n">b</span> <span class="n">then</span> <span class="k">raise</span> <span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">DivideByZeroException</span><span class="p">())</span>
                        <span class="k">elif</span> <span class="n">is_numeric</span> <span class="n">a_ty</span> <span class="n">then</span> <span class="n">push_binop</span> <span class="n">s</span> <span class="n">Mod</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="n">a_ty</span>
                        <span class="k">else</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The type of the two arguments needs to be a numeric type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a_ty</span><span class="p">)</span>
                    <span class="k">else</span>
                        <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The two sides need to have the same numeric types.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">."</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a_ty</span><span class="p">)</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">b_ty</span><span class="p">)</span>
            <span class="k">with</span> <span class="p">:</span><span class="err">?</span> <span class="n">System</span><span class="o">.</span><span class="n">DivideByZeroException</span> <span class="o">-&gt;</span>
                <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"An attempt to divide by zero has been detected at compile time."</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">LT</span><span class="p">,[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">inline</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">b</span>
            <span class="k">match</span> <span class="n">term2</span> <span class="n">s</span> <span class="n">a</span> <span class="n">b</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DLit</span> <span class="n">a</span><span class="p">,</span> <span class="n">DLit</span> <span class="n">b</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">LitInt8</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt8</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt16</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt16</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt64</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt8</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt8</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt16</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt16</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt64</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitFloat32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitFloat32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitFloat64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitFloat64</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitString</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitString</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitChar</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitChar</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitBool</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitBool</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The two literals must be equal in type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">a_ty</span><span class="p">,</span> <span class="n">b_ty</span> <span class="o">=</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">a</span><span class="p">,</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">b</span> 
                <span class="k">if</span> <span class="n">a_ty</span> <span class="o">=</span> <span class="n">b_ty</span> <span class="n">then</span>
                    <span class="k">if</span> <span class="n">is_primitive</span> <span class="n">a_ty</span> <span class="n">then</span> <span class="n">push_binop</span> <span class="n">s</span> <span class="n">LT</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="p">(</span><span class="n">YPrim</span> <span class="n">BoolT</span><span class="p">)</span>
                    <span class="k">else</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The type of the two arguments needs to be a primitive type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a_ty</span><span class="p">)</span>
                <span class="k">else</span>
                    <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The two sides need to have the same primitive types.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">."</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a_ty</span><span class="p">)</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">b_ty</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">LTE</span><span class="p">,[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">inline</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">&lt;=</span> <span class="n">b</span>
            <span class="k">match</span> <span class="n">term2</span> <span class="n">s</span> <span class="n">a</span> <span class="n">b</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DLit</span> <span class="n">a</span><span class="p">,</span> <span class="n">DLit</span> <span class="n">b</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">LitInt8</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt8</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt16</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt16</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt64</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt8</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt8</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt16</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt16</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt64</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitFloat32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitFloat32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitFloat64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitFloat64</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitString</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitString</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitChar</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitChar</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitBool</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitBool</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The two literals must be equal in type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">a_ty</span><span class="p">,</span> <span class="n">b_ty</span> <span class="o">=</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">a</span><span class="p">,</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">b</span> 
                <span class="k">if</span> <span class="n">a_ty</span> <span class="o">=</span> <span class="n">b_ty</span> <span class="n">then</span>
                    <span class="k">if</span> <span class="n">is_primitive</span> <span class="n">a_ty</span> <span class="n">then</span> <span class="n">push_binop</span> <span class="n">s</span> <span class="n">LTE</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="p">(</span><span class="n">YPrim</span> <span class="n">BoolT</span><span class="p">)</span>
                    <span class="k">else</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The type of the two arguments needs to be a primitive type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a_ty</span><span class="p">)</span>
                <span class="k">else</span>
                    <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The two sides need to have the same primitive types.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">."</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a_ty</span><span class="p">)</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">b_ty</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">GT</span><span class="p">,[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">])</span> <span class="o">-&gt;</span> 
            <span class="n">let</span> <span class="n">inline</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="n">b</span>
            <span class="k">match</span> <span class="n">term2</span> <span class="n">s</span> <span class="n">a</span> <span class="n">b</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DLit</span> <span class="n">a</span><span class="p">,</span> <span class="n">DLit</span> <span class="n">b</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">LitInt8</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt8</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt16</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt16</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt64</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt8</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt8</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt16</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt16</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt64</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitFloat32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitFloat32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitFloat64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitFloat64</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitString</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitString</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitChar</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitChar</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitBool</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitBool</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The two literals must be equal in type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">a_ty</span><span class="p">,</span> <span class="n">b_ty</span> <span class="o">=</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">a</span><span class="p">,</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">b</span> 
                <span class="k">if</span> <span class="n">a_ty</span> <span class="o">=</span> <span class="n">b_ty</span> <span class="n">then</span>
                    <span class="k">if</span> <span class="n">is_primitive</span> <span class="n">a_ty</span> <span class="n">then</span> <span class="n">push_binop</span> <span class="n">s</span> <span class="n">GT</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="p">(</span><span class="n">YPrim</span> <span class="n">BoolT</span><span class="p">)</span>
                    <span class="k">else</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The type of the two arguments needs to be a primitive type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a_ty</span><span class="p">)</span>
                <span class="k">else</span>
                    <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The two sides need to have the same primitive types.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">."</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a_ty</span><span class="p">)</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">b_ty</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">GTE</span><span class="p">,[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">])</span> <span class="o">-&gt;</span> 
            <span class="n">let</span> <span class="n">inline</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">&gt;=</span> <span class="n">b</span>
            <span class="k">match</span> <span class="n">term2</span> <span class="n">s</span> <span class="n">a</span> <span class="n">b</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DLit</span> <span class="n">a</span><span class="p">,</span> <span class="n">DLit</span> <span class="n">b</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">LitInt8</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt8</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt16</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt16</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt64</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt8</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt8</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt16</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt16</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt64</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitFloat32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitFloat32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitFloat64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitFloat64</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitString</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitString</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitChar</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitChar</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitBool</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitBool</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The two literals must be equal in type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">a_ty</span><span class="p">,</span> <span class="n">b_ty</span> <span class="o">=</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">a</span><span class="p">,</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">b</span> 
                <span class="k">if</span> <span class="n">a_ty</span> <span class="o">=</span> <span class="n">b_ty</span> <span class="n">then</span>
                    <span class="k">if</span> <span class="n">is_primitive</span> <span class="n">a_ty</span> <span class="n">then</span> <span class="n">push_binop</span> <span class="n">s</span> <span class="n">GTE</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="p">(</span><span class="n">YPrim</span> <span class="n">BoolT</span><span class="p">)</span>
                    <span class="k">else</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The type of the two arguments needs to be a primitive type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a_ty</span><span class="p">)</span>
                <span class="k">else</span>
                    <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The two sides need to have the same primitive types.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">."</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a_ty</span><span class="p">)</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">b_ty</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">EQ</span><span class="p">,[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">eq</span> <span class="n">s</span> <span class="p">(</span><span class="n">term</span> <span class="n">s</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">term</span> <span class="n">s</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">NEQ</span><span class="p">,[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">inline</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">&lt;&gt;</span> <span class="n">b</span>
            <span class="k">match</span> <span class="n">term2</span> <span class="n">s</span> <span class="n">a</span> <span class="n">b</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DLit</span> <span class="n">a</span><span class="p">,</span> <span class="n">DLit</span> <span class="n">b</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">LitInt8</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt8</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt16</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt16</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt64</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt8</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt8</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt16</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt16</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt64</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitFloat32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitFloat32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitFloat64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitFloat64</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitString</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitString</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitChar</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitChar</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitBool</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitBool</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The two literals must be equal in type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">a_ty</span><span class="p">)),</span> <span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">_</span><span class="p">))</span> <span class="n">when</span> <span class="n">a</span> <span class="o">=</span> <span class="n">b</span> <span class="o">&amp;&amp;</span> <span class="n">is_non_float_primitive</span> <span class="n">a_ty</span> <span class="o">-&gt;</span> <span class="n">LitBool</span> <span class="n">false</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
            <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">a_ty</span><span class="p">,</span> <span class="n">b_ty</span> <span class="o">=</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">a</span><span class="p">,</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">b</span> 
                <span class="k">if</span> <span class="n">a_ty</span> <span class="o">=</span> <span class="n">b_ty</span> <span class="n">then</span>
                    <span class="k">match</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitBool</span> <span class="n">false</span><span class="p">),</span> <span class="n">x</span> <span class="o">|</span> <span class="n">x</span><span class="p">,</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitBool</span> <span class="n">false</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">x</span>
                    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span>
                        <span class="k">if</span> <span class="n">is_primitive</span> <span class="n">a_ty</span> <span class="n">then</span> <span class="n">push_binop</span> <span class="n">s</span> <span class="n">NEQ</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="p">(</span><span class="n">YPrim</span> <span class="n">BoolT</span><span class="p">)</span>
                        <span class="k">else</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The type of the two arguments needs to be a primitive type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a_ty</span><span class="p">)</span>
                <span class="k">else</span>
                    <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The two sides need to have the same primitive types.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">."</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a_ty</span><span class="p">)</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">b_ty</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">BitwiseAnd</span><span class="p">,[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">])</span> <span class="o">-&gt;</span> 
            <span class="n">let</span> <span class="n">inline</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">&amp;&amp;&amp;</span> <span class="n">b</span>
            <span class="k">match</span> <span class="n">term2</span> <span class="n">s</span> <span class="n">a</span> <span class="n">b</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DLit</span> <span class="n">a</span><span class="p">,</span> <span class="n">DLit</span> <span class="n">b</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">LitInt8</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt8</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitInt8</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt16</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt16</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitInt16</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitInt32</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt64</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitInt64</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt8</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt8</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitUInt8</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt16</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt16</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitUInt16</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitUInt32</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt64</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitUInt64</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The two literals must be both ints and equal in type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">a_ty</span><span class="p">,</span> <span class="n">b_ty</span> <span class="o">=</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">a</span><span class="p">,</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">b</span> 
                <span class="k">if</span> <span class="n">a_ty</span> <span class="o">=</span> <span class="n">b_ty</span> <span class="n">then</span>
                    <span class="k">if</span> <span class="n">is_any_int</span> <span class="n">a_ty</span> <span class="n">then</span> <span class="n">push_binop</span> <span class="n">s</span> <span class="n">BitwiseAnd</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="n">a_ty</span>
                    <span class="k">else</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The type of the two arguments needs to be a int type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a_ty</span><span class="p">)</span>
                <span class="k">else</span>
                    <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The two sides need to have the same int types.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">."</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a_ty</span><span class="p">)</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">b_ty</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">BitwiseOr</span><span class="p">,[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">inline</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">|||</span> <span class="n">b</span>
            <span class="k">match</span> <span class="n">term2</span> <span class="n">s</span> <span class="n">a</span> <span class="n">b</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DLit</span> <span class="n">a</span><span class="p">,</span> <span class="n">DLit</span> <span class="n">b</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">LitInt8</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt8</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitInt8</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt16</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt16</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitInt16</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitInt32</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt64</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitInt64</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt8</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt8</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitUInt8</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt16</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt16</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitUInt16</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitUInt32</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt64</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitUInt64</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The two literals must be both ints and equal in type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">a_ty</span><span class="p">,</span> <span class="n">b_ty</span> <span class="o">=</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">a</span><span class="p">,</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">b</span> 
                <span class="k">if</span> <span class="n">a_ty</span> <span class="o">=</span> <span class="n">b_ty</span> <span class="n">then</span>
                    <span class="k">if</span> <span class="n">is_any_int</span> <span class="n">a_ty</span> <span class="n">then</span> <span class="n">push_binop</span> <span class="n">s</span> <span class="n">BitwiseOr</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="n">a_ty</span>
                    <span class="k">else</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The type of the two arguments needs to be a int type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a_ty</span><span class="p">)</span>
                <span class="k">else</span>
                    <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The two sides need to have the same int types.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">."</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a_ty</span><span class="p">)</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">b_ty</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">BitwiseXor</span><span class="p">,[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">inline</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">^^^</span> <span class="n">b</span>
            <span class="k">match</span> <span class="n">term2</span> <span class="n">s</span> <span class="n">a</span> <span class="n">b</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DLit</span> <span class="n">a</span><span class="p">,</span> <span class="n">DLit</span> <span class="n">b</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">LitInt8</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt8</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitInt8</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt16</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt16</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitInt16</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitInt32</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt64</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitInt64</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt8</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt8</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitUInt8</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt16</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt16</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitUInt16</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitUInt32</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitUInt64</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitUInt64</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The two literals must be both ints and equal in type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">a_ty</span><span class="p">,</span> <span class="n">b_ty</span> <span class="o">=</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">a</span><span class="p">,</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">b</span> 
                <span class="k">if</span> <span class="n">a_ty</span> <span class="o">=</span> <span class="n">b_ty</span> <span class="n">then</span>
                    <span class="k">if</span> <span class="n">is_any_int</span> <span class="n">a_ty</span> <span class="n">then</span> <span class="n">push_binop</span> <span class="n">s</span> <span class="n">BitwiseXor</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="n">a_ty</span>
                    <span class="k">else</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The type of the two arguments needs to be a int type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a_ty</span><span class="p">)</span>
                <span class="k">else</span>
                    <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The two sides need to have the same int types.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">."</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a_ty</span><span class="p">)</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">b_ty</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">BitwiseComplement</span><span class="p">,[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">inline</span> <span class="n">op</span> <span class="n">a</span> <span class="o">=</span> <span class="o">~~~</span><span class="n">a</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DLit</span> <span class="n">a</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">a</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">LitInt8</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">LitInt8</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt16</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">LitInt16</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt32</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">LitInt32</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt64</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">LitInt64</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt8</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">LitUInt8</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt16</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">LitUInt16</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt32</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">LitUInt32</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt64</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">LitUInt64</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The literal must be an int.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">a</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">a_ty</span> <span class="o">=</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">a</span>
                <span class="k">if</span> <span class="n">is_any_int</span> <span class="n">a_ty</span> <span class="n">then</span> <span class="n">push_op</span> <span class="n">s</span> <span class="n">BitwiseComplement</span> <span class="n">a</span> <span class="n">a_ty</span>
                <span class="k">else</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The type of the two arguments needs to be a int type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a_ty</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">ShiftLeft</span><span class="p">,[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">])</span> <span class="o">-&gt;</span> 
            <span class="n">let</span> <span class="n">inline</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">&lt;&lt;&lt;</span> <span class="n">b</span>
            <span class="k">match</span> <span class="n">term2</span> <span class="n">s</span> <span class="n">a</span> <span class="n">b</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DLit</span> <span class="n">a</span><span class="p">,</span> <span class="n">DLit</span> <span class="n">b</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">LitInt8</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitInt8</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt16</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitInt16</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitInt32</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitInt64</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt8</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitUInt8</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt16</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitUInt16</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitUInt32</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitUInt64</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The first literal must be an int and the second must be a 32-bit signed int.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">a_ty</span><span class="p">,</span> <span class="n">b_ty</span> <span class="o">=</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">a</span><span class="p">,</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">b</span> 
                <span class="k">if</span> <span class="n">is_any_int</span> <span class="n">a_ty</span> <span class="o">&amp;&amp;</span> <span class="n">is_int32</span> <span class="n">b_ty</span> <span class="n">then</span> <span class="n">push_binop</span> <span class="n">s</span> <span class="n">ShiftLeft</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="n">a_ty</span>
                <span class="k">else</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The type of the first argument must be an int and the second must be a 32-bit signed int.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a_ty</span><span class="p">)</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">b_ty</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">ShiftRight</span><span class="p">,[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">inline</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">b</span>
            <span class="k">match</span> <span class="n">term2</span> <span class="n">s</span> <span class="n">a</span> <span class="n">b</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DLit</span> <span class="n">a</span><span class="p">,</span> <span class="n">DLit</span> <span class="n">b</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">LitInt8</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitInt8</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt16</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitInt16</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitInt32</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitInt64</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt8</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitUInt8</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt16</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitUInt16</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt32</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitUInt32</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitUInt64</span> <span class="n">a</span><span class="p">,</span> <span class="n">LitInt32</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">LitUInt64</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The first literal must be an int and the second must be a 32-bit signed int.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">a_ty</span><span class="p">,</span> <span class="n">b_ty</span> <span class="o">=</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">a</span><span class="p">,</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">b</span> 
                <span class="k">if</span> <span class="n">is_any_int</span> <span class="n">a_ty</span> <span class="o">&amp;&amp;</span> <span class="n">is_int32</span> <span class="n">b_ty</span> <span class="n">then</span> <span class="n">push_binop</span> <span class="n">s</span> <span class="n">ShiftRight</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="n">a_ty</span>
                <span class="k">else</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The type of the first argument must be an int and the second must be a 32-bit signed int.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a_ty</span><span class="p">)</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">b_ty</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">Neg</span><span class="p">,[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">inline</span> <span class="n">op</span> <span class="n">a</span> <span class="o">=</span> <span class="o">-</span><span class="n">a</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DLit</span> <span class="n">a</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">a</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">LitInt8</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">LitInt8</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt16</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">LitInt16</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt32</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">LitInt32</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitInt64</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">LitInt64</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitFloat32</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">LitFloat32</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitFloat64</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">LitFloat64</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The literal must be a signed numeric type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">a</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">a_ty</span> <span class="o">=</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">a</span>
                <span class="k">if</span> <span class="n">is_signed_numeric</span> <span class="n">a_ty</span> <span class="n">then</span> <span class="n">push_op</span> <span class="n">s</span> <span class="n">Neg</span> <span class="n">a</span> <span class="n">a_ty</span>
                <span class="k">else</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The argument must be a signed numeric type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a_ty</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">Tanh</span><span class="p">,[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span> 
            <span class="n">let</span> <span class="n">inline</span> <span class="n">op</span> <span class="n">a</span> <span class="o">=</span> <span class="n">tanh</span> <span class="n">a</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DLit</span> <span class="n">a</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">a</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">LitFloat32</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">nan_guardf32</span> <span class="o">|&gt;</span> <span class="n">LitFloat32</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitFloat64</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">nan_guardf64</span> <span class="o">|&gt;</span> <span class="n">LitFloat64</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The literal must be a float type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">a</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">a_ty</span> <span class="o">=</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">a</span>
                <span class="k">if</span> <span class="n">is_float</span> <span class="n">a_ty</span> <span class="n">then</span> <span class="n">push_op</span> <span class="n">s</span> <span class="n">Tanh</span> <span class="n">a</span> <span class="n">a_ty</span>
                <span class="k">else</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The argument must be a float type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a_ty</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">Log</span><span class="p">,[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">inline</span> <span class="n">op</span> <span class="n">a</span> <span class="o">=</span> <span class="n">log</span> <span class="n">a</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DLit</span> <span class="n">a</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">a</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">LitFloat32</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">nan_guardf32</span> <span class="o">|&gt;</span> <span class="n">LitFloat32</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitFloat64</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">nan_guardf64</span> <span class="o">|&gt;</span> <span class="n">LitFloat64</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The literal must be a float type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">a</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">a_ty</span> <span class="o">=</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">a</span>
                <span class="k">if</span> <span class="n">is_float</span> <span class="n">a_ty</span> <span class="n">then</span> <span class="n">push_op</span> <span class="n">s</span> <span class="n">Log</span> <span class="n">a</span> <span class="n">a_ty</span>
                <span class="k">else</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The argument must be a float type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a_ty</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">Exp</span><span class="p">,[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">inline</span> <span class="n">op</span> <span class="n">a</span> <span class="o">=</span> <span class="n">exp</span> <span class="n">a</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DLit</span> <span class="n">a</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">a</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">LitFloat32</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">nan_guardf32</span> <span class="o">|&gt;</span> <span class="n">LitFloat32</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitFloat64</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">nan_guardf64</span> <span class="o">|&gt;</span> <span class="n">LitFloat64</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The literal must be a float type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">a</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">a_ty</span> <span class="o">=</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">a</span>
                <span class="k">if</span> <span class="n">is_float</span> <span class="n">a_ty</span> <span class="n">then</span> <span class="n">push_op</span> <span class="n">s</span> <span class="n">Exp</span> <span class="n">a</span> <span class="n">a_ty</span>
                <span class="k">else</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The argument must be a float type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a_ty</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">Sqrt</span><span class="p">,[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">inline</span> <span class="n">op</span> <span class="n">a</span> <span class="o">=</span> <span class="n">sqrt</span> <span class="n">a</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DLit</span> <span class="n">a</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">a</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">LitFloat32</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">nan_guardf32</span> <span class="o">|&gt;</span> <span class="n">LitFloat32</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitFloat64</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">nan_guardf64</span> <span class="o">|&gt;</span> <span class="n">LitFloat64</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The literal must be a float type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">a</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">a_ty</span> <span class="o">=</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">a</span>
                <span class="k">if</span> <span class="n">is_float</span> <span class="n">a_ty</span> <span class="n">then</span> <span class="n">push_op</span> <span class="n">s</span> <span class="n">Sqrt</span> <span class="n">a</span> <span class="n">a_ty</span>
                <span class="k">else</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The argument must be a float type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a_ty</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">Sin</span><span class="p">,[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">inline</span> <span class="n">op</span> <span class="n">a</span> <span class="o">=</span> <span class="n">sin</span> <span class="n">a</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DLit</span> <span class="n">a</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">a</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">LitFloat32</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">nan_guardf32</span> <span class="o">|&gt;</span> <span class="n">LitFloat32</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitFloat64</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">nan_guardf64</span> <span class="o">|&gt;</span> <span class="n">LitFloat64</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The literal must be a float type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">a</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">a_ty</span> <span class="o">=</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">a</span>
                <span class="k">if</span> <span class="n">is_float</span> <span class="n">a_ty</span> <span class="n">then</span> <span class="n">push_op</span> <span class="n">s</span> <span class="n">Sin</span> <span class="n">a</span> <span class="n">a_ty</span>
                <span class="k">else</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The argument must be a float type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a_ty</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">Cos</span><span class="p">,[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">inline</span> <span class="n">op</span> <span class="n">a</span> <span class="o">=</span> <span class="n">cos</span> <span class="n">a</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DLit</span> <span class="n">a</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">a</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">LitFloat32</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">nan_guardf32</span> <span class="o">|&gt;</span> <span class="n">LitFloat32</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">LitFloat64</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">nan_guardf64</span> <span class="o">|&gt;</span> <span class="n">LitFloat64</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The literal must be a float type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_lit</span> <span class="n">a</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">a_ty</span> <span class="o">=</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">a</span>
                <span class="k">if</span> <span class="n">is_float</span> <span class="n">a_ty</span> <span class="n">then</span> <span class="n">push_op</span> <span class="n">s</span> <span class="n">Cos</span> <span class="n">a</span> <span class="n">a_ty</span>
                <span class="k">else</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"The argument must be a float type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a_ty</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">Conv</span><span class="p">,[</span><span class="n">EType</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">typ</span><span class="p">);</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">typ</span> <span class="o">=</span> <span class="n">ty</span> <span class="n">s</span> <span class="n">typ</span>
            <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span>
            <span class="n">let</span> <span class="n">at</span> <span class="o">=</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">a</span>
            <span class="k">if</span> <span class="n">typ</span> <span class="o">=</span> <span class="n">at</span> <span class="n">then</span> <span class="n">a</span>
            <span class="k">else</span>
                <span class="n">let</span> <span class="n">inline</span> <span class="n">conv_lit</span> <span class="n">x</span> <span class="o">=</span>
                    <span class="k">match</span> <span class="n">typ</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">YPrim</span> <span class="n">Int8T</span> <span class="o">-&gt;</span> <span class="n">int8</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">LitInt8</span>
                    <span class="o">|</span> <span class="n">YPrim</span> <span class="n">Int16T</span> <span class="o">-&gt;</span> <span class="n">int16</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">LitInt16</span>
                    <span class="o">|</span> <span class="n">YPrim</span> <span class="n">Int32T</span> <span class="o">-&gt;</span> <span class="n">int32</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">LitInt32</span>
                    <span class="o">|</span> <span class="n">YPrim</span> <span class="n">Int64T</span> <span class="o">-&gt;</span> <span class="n">int64</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">LitInt64</span>
                    <span class="o">|</span> <span class="n">YPrim</span> <span class="n">UInt8T</span> <span class="o">-&gt;</span> <span class="n">uint8</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">LitUInt8</span>
                    <span class="o">|</span> <span class="n">YPrim</span> <span class="n">UInt16T</span> <span class="o">-&gt;</span> <span class="n">uint16</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">LitUInt16</span>
                    <span class="o">|</span> <span class="n">YPrim</span> <span class="n">UInt32T</span> <span class="o">-&gt;</span> <span class="n">uint32</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">LitUInt32</span>
                    <span class="o">|</span> <span class="n">YPrim</span> <span class="n">UInt64T</span> <span class="o">-&gt;</span> <span class="n">uint64</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">LitUInt64</span>
                    <span class="o">|</span> <span class="n">YPrim</span> <span class="n">Float32T</span> <span class="o">-&gt;</span> <span class="n">float32</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">LitFloat32</span>
                    <span class="o">|</span> <span class="n">YPrim</span> <span class="n">Float64T</span> <span class="o">-&gt;</span> <span class="nb">float</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">LitFloat64</span>
                    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Cannot convert the literal to the following type: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">typ</span><span class="p">)</span>
                    <span class="o">|&gt;</span> <span class="n">DLit</span>
                <span class="k">match</span> <span class="n">a</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitInt8</span> <span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">conv_lit</span> <span class="n">a</span>
                <span class="o">|</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitInt16</span> <span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">conv_lit</span> <span class="n">a</span>
                <span class="o">|</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitInt32</span> <span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">conv_lit</span> <span class="n">a</span>
                <span class="o">|</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitInt64</span> <span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">conv_lit</span> <span class="n">a</span>
                <span class="o">|</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitUInt8</span> <span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">conv_lit</span> <span class="n">a</span>
                <span class="o">|</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitUInt16</span> <span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">conv_lit</span> <span class="n">a</span>
                <span class="o">|</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitUInt32</span> <span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">conv_lit</span> <span class="n">a</span>
                <span class="o">|</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitUInt64</span> <span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">conv_lit</span> <span class="n">a</span>
                <span class="o">|</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitFloat32</span> <span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">conv_lit</span> <span class="n">a</span>
                <span class="o">|</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitFloat64</span> <span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">conv_lit</span> <span class="n">a</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span>
                    <span class="n">let</span> <span class="n">is_convertible_primt</span> <span class="n">x</span> <span class="o">=</span>
                        <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
                        <span class="o">|</span> <span class="n">YPrim</span> <span class="n">BoolT</span> <span class="o">|</span> <span class="n">YPrim</span> <span class="n">CharT</span> <span class="o">|</span> <span class="n">YPrim</span> <span class="n">StringT</span> <span class="o">-&gt;</span> <span class="n">false</span>
                        <span class="o">|</span> <span class="n">YPrim</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">true</span>
                        <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">false</span>
                    <span class="k">if</span> <span class="n">is_convertible_primt</span> <span class="n">at</span> <span class="o">&amp;&amp;</span> <span class="n">is_convertible_primt</span> <span class="n">typ</span> <span class="n">then</span> <span class="n">push_typedop</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyConv</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span><span class="n">a</span><span class="p">))</span> <span class="n">typ</span>
                    <span class="k">else</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Cannot convert </span><span class="si">%s</span><span class="s2"> to the following type: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_data</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">typ</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">NanIs</span><span class="p">,[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span>
            <span class="k">match</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">YPrim</span> <span class="p">(</span><span class="n">Float32T</span> <span class="o">|</span> <span class="n">Float64T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">push_op</span> <span class="n">s</span> <span class="n">NanIs</span> <span class="n">a</span> <span class="p">(</span><span class="n">YPrim</span> <span class="n">BoolT</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a float in NanIs. Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">Infinity</span><span class="p">,[</span><span class="n">EType</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)])</span> <span class="o">-&gt;</span> 
            <span class="k">match</span> <span class="n">ty</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">YPrim</span> <span class="n">Float32T</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitFloat32</span> <span class="n">infinityf</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">YPrim</span> <span class="n">Float64T</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitFloat64</span> <span class="n">infinity</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="s2">"Expected a float.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">Pi</span><span class="p">,[</span><span class="n">EType</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)])</span> <span class="o">-&gt;</span> 
            <span class="k">match</span> <span class="n">ty</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">YPrim</span> <span class="n">Float32T</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitFloat32</span> <span class="n">System</span><span class="o">.</span><span class="n">Single</span><span class="o">.</span><span class="n">Pi</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">YPrim</span> <span class="n">Float64T</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitFloat64</span> <span class="n">System</span><span class="o">.</span><span class="n">Double</span><span class="o">.</span><span class="n">Pi</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="s2">"Expected a float.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">LitIs</span><span class="p">,[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DLit</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitBool</span> <span class="n">true</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitBool</span> <span class="n">false</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">PrimIs</span><span class="p">,[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">data_to_ty</span> <span class="n">s</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">YPrim</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitBool</span> <span class="n">true</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitBool</span> <span class="n">false</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">SymbolIs</span><span class="p">,[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DSymbol</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitBool</span> <span class="n">true</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitBool</span> <span class="n">false</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">VarIs</span><span class="p">,[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">DV</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">DV</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitBool</span> <span class="n">true</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitBool</span> <span class="n">false</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">UnionIs</span><span class="p">,[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span> 
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">YUnion</span> <span class="n">_</span><span class="p">)),</span> <span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">DUnion</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitBool</span> <span class="n">true</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitBool</span> <span class="n">false</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">HeapUnionIs</span><span class="p">,[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">YUnion</span> <span class="n">x</span><span class="p">)),</span> <span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">DUnion</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">),</span> <span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">x</span><span class="o">.</span><span class="n">Item</span><span class="o">.</span><span class="n">layout</span> <span class="k">with</span> <span class="n">UHeap</span> <span class="o">-&gt;</span> <span class="n">true</span> <span class="o">|</span> <span class="n">UStack</span> <span class="o">-&gt;</span> <span class="n">false</span>
                <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitBool</span> <span class="n">false</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">LayoutIs</span><span class="p">,[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">YLayout</span> <span class="n">_</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitBool</span> <span class="n">true</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitBool</span> <span class="n">false</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">NominalIs</span><span class="p">,[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitBool</span> <span class="n">true</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitBool</span> <span class="n">false</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">FunctionIs</span><span class="p">,[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DFunction</span> <span class="n">_</span> <span class="o">|</span> <span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">YFun</span> <span class="n">_</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitBool</span> <span class="n">true</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitBool</span> <span class="n">false</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">ExistsIs</span><span class="p">,[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DExists</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitBool</span> <span class="n">true</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitBool</span> <span class="n">false</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">PrimTypeIs</span><span class="p">,[</span><span class="n">EType</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">ty</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">YPrim</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitBool</span> <span class="n">true</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitBool</span> <span class="n">false</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">SymbolTypeIs</span><span class="p">,[</span><span class="n">EType</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">ty</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">YSymbol</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitBool</span> <span class="n">true</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitBool</span> <span class="n">false</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">UnionTypeIs</span><span class="p">,[</span><span class="n">EType</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)])</span> <span class="o">-&gt;</span> 
            <span class="k">match</span> <span class="n">ty</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">YNominal</span> <span class="n">_</span> <span class="o">|</span> <span class="n">YApply</span> <span class="n">_</span> <span class="k">as</span> <span class="n">a</span> <span class="o">-&gt;</span> 
                <span class="k">match</span> <span class="n">nominal_type_apply</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">YUnion</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitBool</span> <span class="n">true</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitBool</span> <span class="n">false</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitBool</span> <span class="n">false</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">HeapUnionTypeIs</span><span class="p">,[</span><span class="n">EType</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">ty</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">YNominal</span> <span class="n">_</span> <span class="o">|</span> <span class="n">YApply</span> <span class="n">_</span> <span class="k">as</span> <span class="n">a</span> <span class="o">-&gt;</span> 
                <span class="k">match</span> <span class="n">nominal_type_apply</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">YUnion</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitBool</span> <span class="p">(</span><span class="n">match</span> <span class="n">x</span><span class="o">.</span><span class="n">Item</span><span class="o">.</span><span class="n">layout</span> <span class="k">with</span> <span class="n">UHeap</span> <span class="o">-&gt;</span> <span class="n">true</span> <span class="o">|</span> <span class="n">UStack</span> <span class="o">-&gt;</span> <span class="n">false</span><span class="p">))</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitBool</span> <span class="n">false</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitBool</span> <span class="n">false</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">LayoutTypeIs</span><span class="p">,[</span><span class="n">EType</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">ty</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">YLayout</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitBool</span> <span class="n">true</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitBool</span> <span class="n">false</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">ExistsTypeIs</span><span class="p">,[</span><span class="n">EType</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">ty</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">YExists</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitBool</span> <span class="n">true</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitBool</span> <span class="n">false</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">NominalTypeIs</span><span class="p">,[</span><span class="n">EType</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">ty</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">YNominal</span> <span class="n">_</span> <span class="o">|</span> <span class="n">YApply</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitBool</span> <span class="n">true</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitBool</span> <span class="n">false</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">NominalStrip</span><span class="p">,[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span> 
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">YUnion</span> <span class="n">_</span><span class="p">)),</span> <span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">DUnion</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="s2">"Cannot strip the nominal wrapper from an union."</span>
            <span class="o">|</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">a</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a nominal.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_data</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">NominalTypeApply</span><span class="p">,[</span><span class="n">EType</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)])</span> <span class="o">-&gt;</span> 
            <span class="k">match</span> <span class="n">ty</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">YNominal</span> <span class="n">_</span> <span class="o">|</span> <span class="n">YApply</span> <span class="n">_</span> <span class="k">as</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">DExists</span><span class="p">([</span><span class="o">|</span><span class="n">nominal_type_apply</span> <span class="n">s</span> <span class="n">a</span><span class="o">|</span><span class="p">],</span> <span class="n">DB</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a nominal type.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">ExistsStrip</span><span class="p">,[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span> 
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DExists</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">a</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected an existential.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_data</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">PrototypeHas</span><span class="p">,[</span><span class="n">prot</span><span class="p">;</span> <span class="n">EType</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)])</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">body</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">Nominal</span><span class="p">)</span> <span class="o">=</span>
                <span class="n">let</span> <span class="n">prot_er</span> <span class="p">()</span> <span class="o">=</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="s2">"Expected a forall or a prototype apply."</span>
                <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="o">=</span> <span class="n">function</span>
                    <span class="o">|</span> <span class="n">EForall</span><span class="s1">'(_,_,_,x) -&gt; loop x</span>
                    <span class="o">|</span> <span class="n">EPrototypeApply</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">prot_id</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">env</span><span class="o">.</span><span class="n">prototypes_instances</span><span class="o">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="n">prot_id</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">LitBool</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
                    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">prot_er</span><span class="p">()</span>
                <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">prot</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">DForall</span><span class="p">(</span><span class="n">body</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="n">body</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">prot_er</span><span class="p">()</span>
            <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="o">=</span> <span class="n">function</span>
                <span class="o">|</span> <span class="n">YNominal</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">body</span> <span class="n">x</span>
                <span class="o">|</span> <span class="n">YApply</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="n">l</span>
                <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected a nominal.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_ty</span> <span class="n">a</span><span class="p">)</span>
            <span class="n">loop</span> <span class="p">(</span><span class="n">ty</span> <span class="n">s</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">TypeEq</span><span class="p">,[</span><span class="n">EType</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">);</span><span class="n">EType</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">b</span><span class="p">)])</span> <span class="o">-&gt;</span> <span class="n">DLit</span><span class="p">(</span><span class="n">LitBool</span><span class="p">(</span><span class="n">ty</span> <span class="n">s</span> <span class="n">a</span> <span class="o">=</span> <span class="n">ty</span> <span class="n">s</span> <span class="n">b</span><span class="p">))</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">FailWith</span><span class="p">,[</span><span class="n">EType</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">typ</span><span class="p">);</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">ty</span> <span class="n">s</span> <span class="n">typ</span><span class="p">,</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">typ</span><span class="p">,</span> <span class="p">(</span><span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">YPrim</span> <span class="n">StringT</span><span class="p">))</span> <span class="o">|</span> <span class="n">DLit</span><span class="p">(</span><span class="n">LitString</span> <span class="n">_</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">push_typedop_no_rewrite</span> <span class="n">s</span> <span class="p">(</span><span class="n">TyFailwith</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span><span class="n">a</span><span class="p">))</span> <span class="n">typ</span>
            <span class="o">|</span> <span class="n">_</span><span class="p">,</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="s2">"Expected a string as input to failwith.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_data</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">FailWith</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="s2">"Malformed FailWith"</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">ErrorType</span><span class="p">,[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">show_data</span> <span class="o">|&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">PrintStatic</span><span class="p">,[</span><span class="n">EType</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)])</span> <span class="o">-&gt;</span> <span class="n">printfn</span> <span class="s2">"</span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">ty</span> <span class="n">s</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">show_ty</span><span class="p">);</span> <span class="n">DB</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">PrintStatic</span><span class="p">,[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">printfn</span> <span class="s2">"</span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">show_data</span><span class="p">);</span> <span class="n">DB</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">PrintRaw</span><span class="p">,[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">printfn</span> <span class="s2">"%A"</span> <span class="p">(</span><span class="n">Printable</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">Choice1Of2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="nb">id</span><span class="p">)));</span> <span class="n">DB</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">UnionTag</span><span class="p">,[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="nb">eval</span> <span class="n">k</span> <span class="p">(</span><span class="n">h</span> <span class="p">:</span> <span class="n">Union</span><span class="p">)</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Item</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">|&gt;</span> <span class="n">LitInt32</span> <span class="o">|&gt;</span> <span class="n">DLit</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">YUnion</span> <span class="n">h</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">v</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">a</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">v</span> <span class="n">s</span><span class="o">.</span><span class="n">unions</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">Some</span> <span class="p">(</span><span class="n">UnionData</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">_</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="nb">eval</span> <span class="n">k</span> <span class="n">h</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">push_op</span> <span class="n">s</span> <span class="n">UnionTag</span> <span class="n">a</span> <span class="p">(</span><span class="n">YPrim</span> <span class="n">Int32T</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">DUnion</span><span class="p">(</span><span class="n">DPair</span><span class="p">(</span><span class="n">DSymbol</span> <span class="n">k</span><span class="p">,</span><span class="n">_</span><span class="p">),</span><span class="n">h</span><span class="p">),</span> <span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">eval</span> <span class="n">k</span> <span class="n">h</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Expected an union.</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">show_data</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">Global</span> <span class="o">&amp;</span> <span class="n">op</span><span class="p">,[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitString</span> <span class="n">text</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">a</span> <span class="o">-&gt;</span>
                <span class="o">//</span> <span class="k">if</span> <span class="n">text</span><span class="o">.</span><span class="n">Contains</span> <span class="s2">"import "</span> <span class="o">||</span> <span class="n">text</span><span class="o">.</span><span class="n">Contains</span> <span class="s2">"Fable"</span> <span class="n">then</span>
                <span class="o">//</span>     <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="p">{</span> <span class="n">s</span> <span class="k">with</span> <span class="n">trace</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">seq</span> <span class="o">=</span> <span class="n">ResizeArray</span><span class="p">()</span> <span class="p">}</span>
                <span class="o">//</span>     <span class="n">let</span> <span class="n">l</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">cse</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="n">_</span><span class="o">.</span><span class="n">Count</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">filter</span> <span class="p">((</span><span class="o">=</span><span class="p">)</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">length</span>
                <span class="o">//</span>     <span class="n">Console</span><span class="o">.</span><span class="n">WriteLine</span> <span class="p">(</span><span class="err">$</span><span class="s2">"global / text: </span><span class="si">{text}</span><span class="s2"> / s: %A</span><span class="si">{s}</span><span class="s2"> / l: </span><span class="si">{l}</span><span class="s2">"</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">i</span><span class="o">.</span><span class="n">contents</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="o">.</span><span class="n">cse</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="n">_</span><span class="o">.</span><span class="n">Count</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">filter</span> <span class="p">((</span><span class="o">=</span><span class="p">)</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="n">then</span> <span class="k">global</span><span class="s1">' text</span>
                <span class="n">push_op_no_rewrite</span> <span class="n">s</span> <span class="n">op</span> <span class="n">a</span> <span class="n">YB</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="err">$</span><span class="s2">"Expected a string literal.</span><span class="se">\n</span><span class="s2">Got: {show_data a}"</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">ToPythonRecord</span><span class="p">,[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">dyn</span> <span class="n">false</span> <span class="n">s</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DRecord</span> <span class="n">_</span> <span class="o">&amp;</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">push_op_no_rewrite</span> <span class="n">s</span> <span class="n">ToPythonRecord</span> <span class="n">a</span> <span class="p">(</span><span class="n">YMacro</span> <span class="p">[</span><span class="n">Text</span> <span class="s2">"object"</span><span class="p">])</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="err">$</span><span class="s2">"Expected a record.</span><span class="se">\n</span><span class="s2">Got: {show_data a}"</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">ToPythonNamedTuple</span><span class="p">,[</span><span class="n">n</span><span class="p">;</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">n</span><span class="p">,</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">dyn</span> <span class="n">false</span> <span class="n">s</span> <span class="k">with</span>
            <span class="o">|</span> <span class="p">(</span><span class="n">DLit</span> <span class="p">(</span><span class="n">LitString</span> <span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">YPrim</span> <span class="n">StringT</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="n">n</span><span class="p">,</span> <span class="n">DRecord</span> <span class="n">_</span> <span class="o">&amp;</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">push_binop_no_rewrite</span> <span class="n">s</span> <span class="n">ToPythonNamedTuple</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">YMacro</span> <span class="p">[</span><span class="n">Text</span> <span class="s2">"object"</span><span class="p">])</span>
            <span class="o">|</span> <span class="n">n</span><span class="p">,</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="err">$</span><span class="s2">"Expected a pair of string and record.</span><span class="se">\n</span><span class="s2">Got: {show_data n}</span><span class="se">\n</span><span class="s2">And: {show_data a}"</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">VarTag</span><span class="p">,[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">_</span><span class="p">)),</span> <span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">_</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitInt32</span> <span class="n">i</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="err">$</span><span class="s2">"Expected a runtime variable.</span><span class="se">\n</span><span class="s2">Got: {show_data a}"</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">TagToSymbol</span><span class="p">,[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitInt32</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DSymbol</span> <span class="p">(</span><span class="n">string</span> <span class="n">i</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="err">$</span><span class="s2">"Expected an i32 literal.</span><span class="se">\n</span><span class="s2">Got: {show_data a}"</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">FunctionTermSlotsGet</span><span class="p">,[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DFunction</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">free_vars</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">DPair</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">s</span><span class="p">))</span> <span class="n">free_vars</span> <span class="n">DB</span>
            <span class="o">|</span> <span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">YFun</span> <span class="n">_</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="err">$</span><span class="s2">"Expected a compile time function. Got a runtime one."</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="err">$</span><span class="s2">"Expected a compile time function.</span><span class="se">\n</span><span class="s2">Got: {show_data a}"</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">FunctionTermSlotsSet</span><span class="p">,[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span><span class="p">,</span> <span class="n">term</span> <span class="n">s</span> <span class="n">b</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DFunction</span><span class="p">(</span><span class="n">q1</span><span class="p">,</span><span class="n">q2</span><span class="p">,</span><span class="n">free_vars</span><span class="p">,</span><span class="n">q4</span><span class="p">,</span><span class="n">q5</span><span class="p">,</span><span class="n">a6</span><span class="p">),</span> <span class="n">b</span> <span class="o">-&gt;</span> 
                <span class="n">let</span> <span class="n">mutable</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span>
                <span class="n">let</span> <span class="n">free_vars</span> <span class="o">=</span> 
                    <span class="n">Array</span><span class="o">.</span><span class="n">init</span> <span class="n">free_vars</span><span class="o">.</span><span class="n">Length</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> 
                        <span class="k">match</span> <span class="n">b</span> <span class="k">with</span>
                        <span class="o">|</span> <span class="n">DPair</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">b</span> <span class="o">&lt;-</span> <span class="n">w</span><span class="p">;</span> <span class="n">q</span>
                        <span class="o">|</span> <span class="n">DB</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="s2">"Unexpected end of the tuple to be set."</span>
                        <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="err">$</span><span class="s2">"Expected a pair.</span><span class="se">\n</span><span class="s2">Got: {show_data b}"</span>
                        <span class="p">)</span> 
                <span class="k">match</span> <span class="n">b</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">DB</span> <span class="o">-&gt;</span> <span class="n">DFunction</span><span class="p">(</span><span class="n">q1</span><span class="p">,</span><span class="n">q2</span><span class="p">,</span><span class="n">free_vars</span><span class="p">,</span><span class="n">q4</span><span class="p">,</span><span class="n">q5</span><span class="p">,</span><span class="n">a6</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="err">$</span><span class="s2">"Expected an unit end of the tuple.</span><span class="se">\n</span><span class="s2">Got: {show_data b}"</span>
            <span class="o">|</span> <span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">YFun</span> <span class="n">_</span><span class="p">)),</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="err">$</span><span class="s2">"Expected a compile time function. Got a runtime one."</span>
            <span class="o">|</span> <span class="n">a</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="err">$</span><span class="s2">"Expected a compile time function.</span><span class="se">\n</span><span class="s2">Got: {show_data a}"</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">SizeOf</span><span class="p">,[</span><span class="n">EType</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">ty</span> <span class="n">s</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">YB</span> <span class="o">|</span> <span class="n">YSymbol</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitInt32</span> <span class="mi">0</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">YPrim</span> <span class="p">(</span><span class="n">Int8T</span> <span class="o">|</span> <span class="n">UInt8T</span> <span class="o">|</span> <span class="n">BoolT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitInt32</span> <span class="mi">1</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">YPrim</span> <span class="p">(</span><span class="n">Int16T</span> <span class="o">|</span> <span class="n">UInt16T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitInt32</span> <span class="mi">2</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">YPrim</span> <span class="p">(</span><span class="n">Int32T</span> <span class="o">|</span> <span class="n">UInt32T</span> <span class="o">|</span> <span class="n">Float32T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitInt32</span> <span class="mi">4</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">YPrim</span> <span class="p">(</span><span class="n">Int64T</span> <span class="o">|</span> <span class="n">UInt64T</span> <span class="o">|</span> <span class="n">Float64T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitInt32</span> <span class="mi">8</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">push_typedop</span> <span class="n">s</span> <span class="p">(</span><span class="n">TySizeOf</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">YPrim</span> <span class="n">Int32T</span><span class="p">)</span> 
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">FreeVars</span><span class="p">,[</span><span class="n">a</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">data_free_vars</span>
            <span class="n">Array</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">DPair</span><span class="p">(</span><span class="n">DV</span> <span class="n">x</span><span class="p">,</span><span class="n">s</span><span class="p">))</span> <span class="n">x</span> <span class="p">(</span><span class="n">DRecord</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">FreeVarsReplace</span><span class="p">,[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">term</span> <span class="n">s</span> <span class="n">a</span>
            <span class="n">let</span> <span class="n">b</span> <span class="o">=</span> <span class="n">term</span> <span class="n">s</span> <span class="n">b</span>
            <span class="n">let</span> <span class="n">a_fv</span> <span class="o">=</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">data_free_vars</span>
            <span class="n">let</span> <span class="n">b_fv</span> <span class="o">=</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">data_free_vars</span>
            <span class="k">if</span> <span class="n">a_fv</span><span class="o">.</span><span class="n">Length</span> <span class="o">&lt;&gt;</span> <span class="n">b_fv</span><span class="o">.</span><span class="n">Length</span> <span class="n">then</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="s2">"The two expressions need to have the same number of free variables."</span>
            <span class="n">let</span> <span class="n">d</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Reference</span><span class="p">)</span>
            <span class="n">Array</span><span class="o">.</span><span class="n">iter2</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">ta</span><span class="p">)</span> <span class="k">as</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">tb</span><span class="p">)</span> <span class="k">as</span> <span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> 
                <span class="k">if</span> <span class="n">ta</span> <span class="o">&lt;&gt;</span> <span class="n">tb</span> <span class="n">then</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="err">$</span><span class="s2">"The free variables can only be replaced with free vars of the same type.</span><span class="se">\n</span><span class="s2">Got: {show_ty ta}</span><span class="se">\n</span><span class="s2">Expected: {show_ty tb}"</span>
                <span class="n">d</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
                <span class="p">)</span> <span class="n">a_fv</span> <span class="n">b_fv</span>
            <span class="n">data_free_vars_replace</span> <span class="n">s</span> <span class="n">d</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">HashSetCreate</span><span class="p">,[])</span> <span class="o">-&gt;</span> <span class="n">DHashSet</span><span class="p">(</span><span class="n">HashSet</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Reference</span><span class="p">))</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">HashSetAdd</span><span class="p">,[</span><span class="n">h</span><span class="p">;</span><span class="n">k</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">h</span><span class="p">,</span> <span class="n">term</span> <span class="n">s</span> <span class="n">k</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DHashSet</span> <span class="n">h</span><span class="p">,</span> <span class="n">k</span> <span class="o">-&gt;</span> <span class="n">DLit</span><span class="p">(</span><span class="n">LitBool</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">Add</span> <span class="n">k</span><span class="p">))</span>
            <span class="o">|</span> <span class="n">h</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="err">$</span><span class="s2">"Expected a compile time HashSet.</span><span class="se">\n</span><span class="s2">Got: {show_data h}"</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">HashSetContains</span><span class="p">,[</span><span class="n">h</span><span class="p">;</span><span class="n">k</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">h</span><span class="p">,</span> <span class="n">term</span> <span class="n">s</span> <span class="n">k</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DHashSet</span> <span class="n">h</span><span class="p">,</span> <span class="n">k</span> <span class="o">-&gt;</span> <span class="n">DLit</span><span class="p">(</span><span class="n">LitBool</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">Contains</span> <span class="n">k</span><span class="p">))</span>
            <span class="o">|</span> <span class="n">h</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="err">$</span><span class="s2">"Expected a compile time HashSet.</span><span class="se">\n</span><span class="s2">Got: {show_data h}"</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">HashSetRemove</span><span class="p">,[</span><span class="n">h</span><span class="p">;</span><span class="n">k</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">h</span><span class="p">,</span> <span class="n">term</span> <span class="n">s</span> <span class="n">k</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DHashSet</span> <span class="n">h</span><span class="p">,</span> <span class="n">k</span> <span class="o">-&gt;</span> <span class="n">DLit</span><span class="p">(</span><span class="n">LitBool</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">Remove</span> <span class="n">k</span><span class="p">))</span>
            <span class="o">|</span> <span class="n">h</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="err">$</span><span class="s2">"Expected a compile time HashSet.</span><span class="se">\n</span><span class="s2">Got: {show_data h}"</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">HashSetCount</span><span class="p">,[</span><span class="n">h</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">h</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DHashSet</span> <span class="n">h</span> <span class="o">-&gt;</span> <span class="n">DLit</span><span class="p">(</span><span class="n">LitInt32</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">Count</span><span class="p">))</span>
            <span class="o">|</span> <span class="n">h</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="err">$</span><span class="s2">"Expected a compile time HashSet.</span><span class="se">\n</span><span class="s2">Got: {show_data h}"</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">HashMapCreate</span><span class="p">,[])</span> <span class="o">-&gt;</span> <span class="n">DHashMap</span><span class="p">(</span><span class="n">OrderedDictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Reference</span><span class="p">),</span> <span class="n">ref</span> <span class="n">true</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">HashMapSetImmutable</span><span class="p">,[</span><span class="n">h</span><span class="p">])</span> <span class="o">-&gt;</span> 
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">h</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DHashMap</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">is_writable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">is_writable</span><span class="o">.</span><span class="n">Value</span> <span class="o">&lt;-</span> <span class="n">false</span><span class="p">;</span> <span class="n">DB</span>
            <span class="o">|</span> <span class="n">h</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="err">$</span><span class="s2">"Expected a compile time HashMap.</span><span class="se">\n</span><span class="s2">Got: {show_data h}"</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">HashMapSet</span><span class="p">,[</span><span class="n">h</span><span class="p">;</span><span class="n">k</span><span class="p">;</span><span class="n">v</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">h</span><span class="p">,</span> <span class="n">term</span> <span class="n">s</span> <span class="n">k</span><span class="p">,</span> <span class="n">term</span> <span class="n">s</span> <span class="n">v</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DHashMap</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">is_writable</span><span class="p">),</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="n">when</span> <span class="n">is_writable</span><span class="o">.</span><span class="n">Value</span> <span class="o">-&gt;</span> <span class="n">h</span><span class="o">.</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">v</span><span class="p">;</span> <span class="n">DB</span>
            <span class="o">|</span> <span class="n">DHashMap</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">_</span><span class="p">),</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="s2">"The hash map has been made read-only and cannot be added to."</span>
            <span class="o">|</span> <span class="n">h</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="err">$</span><span class="s2">"Expected a compile time HashMap.</span><span class="se">\n</span><span class="s2">Got: {show_data h}"</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">HashMapAdd</span><span class="p">,[</span><span class="n">h</span><span class="p">;</span><span class="n">k</span><span class="p">;</span><span class="n">v</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">h</span><span class="p">,</span> <span class="n">term</span> <span class="n">s</span> <span class="n">k</span><span class="p">,</span> <span class="n">term</span> <span class="n">s</span> <span class="n">v</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DHashMap</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">is_writable</span><span class="p">),</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="n">when</span> <span class="n">is_writable</span><span class="o">.</span><span class="n">Value</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">TryAdd</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="n">then</span> <span class="n">DB</span> <span class="k">else</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="s2">"The entry with the same key already exists in the dictionary."</span>
            <span class="o">|</span> <span class="n">DHashMap</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">_</span><span class="p">),</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="s2">"The hash map has been made read-only and cannot be added to."</span>
            <span class="o">|</span> <span class="n">h</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="err">$</span><span class="s2">"Expected a compile time HashMap.</span><span class="se">\n</span><span class="s2">Got: {show_data h}"</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">HashMapTryAdd</span><span class="p">,[</span><span class="n">h</span><span class="p">;</span><span class="n">k</span><span class="p">;</span><span class="n">v</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">h</span><span class="p">,</span> <span class="n">term</span> <span class="n">s</span> <span class="n">k</span><span class="p">,</span> <span class="n">term</span> <span class="n">s</span> <span class="n">v</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DHashMap</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">is_writable</span><span class="p">),</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">is_writable</span><span class="o">.</span><span class="n">Value</span> <span class="n">then</span> <span class="n">DLit</span><span class="p">(</span><span class="n">LitBool</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">TryAdd</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)))</span> <span class="k">else</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="s2">"The hash map has been made read-only and cannot be added to."</span>
            <span class="o">|</span> <span class="n">h</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="err">$</span><span class="s2">"Expected a compile time HashMap.</span><span class="se">\n</span><span class="s2">Got: {show_data h}"</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">HashMapContains</span><span class="p">,[</span><span class="n">h</span><span class="p">;</span><span class="n">k</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">h</span><span class="p">,</span> <span class="n">term</span> <span class="n">s</span> <span class="n">k</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DHashMap</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">_</span><span class="p">),</span> <span class="n">k</span> <span class="o">-&gt;</span> <span class="n">DLit</span><span class="p">(</span><span class="n">LitBool</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">ContainsKey</span> <span class="n">k</span><span class="p">))</span>
            <span class="o">|</span> <span class="n">h</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="err">$</span><span class="s2">"Expected a compile time HashMap.</span><span class="se">\n</span><span class="s2">Got: {show_data h}"</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">HashMapRemove</span><span class="p">,[</span><span class="n">h</span><span class="p">;</span><span class="n">k</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">h</span><span class="p">,</span> <span class="n">term</span> <span class="n">s</span> <span class="n">k</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DHashMap</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">is_writable</span><span class="p">),</span> <span class="n">k</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">is_writable</span><span class="o">.</span><span class="n">Value</span> <span class="n">then</span> <span class="n">DLit</span><span class="p">(</span><span class="n">LitBool</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">Remove</span> <span class="n">k</span><span class="p">))</span> <span class="k">else</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="s2">"The hash map has been made read-only and cannot be removed from."</span>
            <span class="o">|</span> <span class="n">h</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="err">$</span><span class="s2">"Expected a compile time HashMap.</span><span class="se">\n</span><span class="s2">Got: {show_data h}"</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">HashMapCount</span><span class="p">,[</span><span class="n">h</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">h</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DHashMap</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DLit</span><span class="p">(</span><span class="n">LitInt32</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">Count</span><span class="p">))</span>
            <span class="o">|</span> <span class="n">h</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="err">$</span><span class="s2">"Expected a compile time HashMap.</span><span class="se">\n</span><span class="s2">Got: {show_data h}"</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">HashMapTryGet</span><span class="p">,[</span><span class="n">h</span><span class="p">;</span><span class="n">k</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">term</span> <span class="n">s</span> <span class="n">h</span><span class="p">,</span> <span class="n">term</span> <span class="n">s</span> <span class="n">k</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DHashMap</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">_</span><span class="p">),</span> <span class="n">k</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">h</span><span class="o">.</span><span class="n">TryGetValue</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">true</span><span class="p">,</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">v</span>
                <span class="o">|</span> <span class="n">false</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">DSymbol</span> <span class="s2">"null"</span>
            <span class="o">|</span> <span class="n">h</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="err">$</span><span class="s2">"Expected a compile time HashMap.</span><span class="se">\n</span><span class="s2">Got: {show_data h}"</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">StaticStringConcat</span><span class="p">,[</span><span class="n">l</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">strb</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Text</span><span class="o">.</span><span class="n">StringBuilder</span><span class="p">()</span>
            <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="o">=</span> <span class="n">function</span>
                <span class="o">|</span> <span class="n">DPair</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="n">a</span><span class="p">;</span> <span class="n">loop</span> <span class="n">b</span>
                <span class="o">|</span> <span class="n">DLit</span><span class="p">(</span><span class="n">LitString</span> <span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">strb</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
                <span class="o">|</span> <span class="n">DB</span> <span class="o">-&gt;</span> <span class="p">()</span>
                <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="err">$</span><span class="s2">"Expected a compile time string or a pair of them.</span><span class="se">\n</span><span class="s2">Got: {show_data x}"</span>
            <span class="n">loop</span> <span class="p">(</span><span class="n">term</span> <span class="n">s</span> <span class="n">l</span><span class="p">)</span>
            <span class="n">DLit</span><span class="p">(</span><span class="n">LitString</span><span class="p">(</span><span class="n">strb</span><span class="o">.</span><span class="n">ToString</span><span class="p">()))</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">Printf</span><span class="p">,[</span><span class="n">fmt</span><span class="p">;</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">fmt</span><span class="p">,</span><span class="nb">str</span> <span class="o">=</span> <span class="n">term2</span> <span class="n">s</span> <span class="n">fmt</span> <span class="nb">str</span>
            <span class="k">match</span> <span class="n">fmt</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DLit</span><span class="p">(</span><span class="n">LitString</span> <span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">push_binop_no_rewrite</span> <span class="n">s</span> <span class="n">Printf</span> <span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="n">YB</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="err">$</span><span class="s2">"Expected a compile time string as the format.</span><span class="se">\n</span><span class="s2">Got: {show_data fmt}"</span>
        <span class="o">|</span> <span class="n">EOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">op</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Compiler error: %A with </span><span class="si">%i</span><span class="s2"> args not implemented"</span> <span class="n">op</span> <span class="p">(</span><span class="n">List</span><span class="o">.</span><span class="n">length</span> <span class="n">a</span><span class="p">)</span>

    <span class="n">let</span> <span class="n">s</span> <span class="p">:</span> <span class="n">LangEnv</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">seq</span> <span class="o">=</span> <span class="n">null</span>
        <span class="n">cse</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">unions</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>
        <span class="n">env_global_type</span> <span class="o">=</span> <span class="p">[</span><span class="o">||</span><span class="p">]</span>
        <span class="n">env_global_term</span> <span class="o">=</span> <span class="p">[</span><span class="o">||</span><span class="p">]</span>
        <span class="n">env_stack_type</span> <span class="o">=</span> <span class="p">[</span><span class="o">||</span><span class="p">]</span>
        <span class="n">env_stack_term</span> <span class="o">=</span> <span class="p">[</span><span class="o">||</span><span class="p">]</span>
        <span class="n">backend</span> <span class="o">=</span> <span class="n">backend_strings</span><span class="o">.</span><span class="n">Add</span> <span class="n">env</span><span class="o">.</span><span class="n">backend</span>
        <span class="nb">globals</span> <span class="o">=</span> <span class="n">ResizeArray</span> <span class="p">()</span>
        <span class="p">}</span>
    <span class="n">let</span> <span class="n">ty_to_data</span> <span class="n">x</span> <span class="o">=</span> <span class="n">ty_to_data</span> <span class="p">{</span><span class="n">s</span> <span class="k">with</span> <span class="n">i</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span><span class="p">}</span> <span class="n">x</span>
    <span class="n">let</span> <span class="n">nominal_apply</span> <span class="n">x</span> <span class="o">=</span> <span class="n">nominal_type_apply</span> <span class="p">{</span><span class="n">s</span> <span class="k">with</span> <span class="n">i</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span><span class="p">}</span> <span class="n">x</span>

    <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">EFun</span><span class="s1">'(r,_,_,_,_) -&gt; term_scope s (EApply(r,x,EB r)), {join_point_method=join_point_method; join_point_closure=join_point_closure; ty_to_data=ty_to_data; nominal_apply=nominal_apply; globals=s.globals}</span>
    <span class="o">|</span> <span class="n">EForall</span><span class="s1">' _ -&gt; raise_type_error s "The main function should not have a forall."</span>
    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_type_error</span> <span class="n">s</span> <span class="s2">"Expected a function as the main."</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=47">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="CodegenUtils">CodegenUtils<a class="anchor-link" href="#CodegenUtils"></a></h2>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=48">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="o">//</span> <span class="nb">open</span> <span class="n">System</span><span class="o">.</span><span class="n">Text</span>

<span class="nb">type</span> <span class="n">CodegenEnv</span> <span class="o">=</span>
    <span class="p">{</span>
    <span class="n">text</span> <span class="p">:</span> <span class="n">System</span><span class="o">.</span><span class="n">Text</span><span class="o">.</span><span class="n">StringBuilder</span>
    <span class="n">indent</span> <span class="p">:</span> <span class="nb">int</span>
    <span class="p">}</span>

<span class="n">let</span> <span class="n">line</span> <span class="n">x</span> <span class="p">(</span><span class="n">s</span> <span class="p">:</span> <span class="n">string</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="s1">' '</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">indent</span><span class="p">)</span><span class="o">.</span><span class="n">AppendLine</span> <span class="n">s</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
<span class="n">let</span> <span class="n">indent</span> <span class="n">x</span> <span class="p">:</span> <span class="n">CodegenEnv</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span> <span class="k">with</span> <span class="n">indent</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">indent</span><span class="o">+</span><span class="mi">4</span><span class="p">}</span>
<span class="n">let</span> <span class="n">add_dec_point</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">string</span><span class="p">)</span> <span class="o">=</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">IndexOf</span><span class="p">(</span><span class="s1">'.'</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">x</span><span class="o">.</span><span class="n">Contains</span> <span class="s2">"E"</span> <span class="o">|&gt;</span> <span class="ow">not</span> <span class="n">then</span> <span class="n">x</span> <span class="o">+</span> <span class="s2">".0"</span> <span class="k">else</span> <span class="n">x</span>

<span class="n">exception</span> <span class="n">CodegenError</span> <span class="n">of</span> <span class="n">Range</span> <span class="n">option</span> <span class="o">*</span> <span class="n">string</span>
<span class="n">exception</span> <span class="n">CodegenErrorWithPos</span> <span class="n">of</span> <span class="n">Trace</span> <span class="o">*</span> <span class="n">string</span>
<span class="n">let</span> <span class="n">raise_codegen_error</span> <span class="n">x</span> <span class="o">=</span> <span class="k">raise</span> <span class="p">(</span><span class="n">CodegenError</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="n">x</span><span class="p">))</span>
<span class="n">let</span> <span class="n">raise_codegen_error_backend</span> <span class="n">r</span> <span class="n">x</span> <span class="o">=</span> <span class="k">raise</span> <span class="p">(</span><span class="n">CodegenError</span> <span class="p">(</span><span class="n">Some</span> <span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">))</span>
<span class="n">let</span> <span class="n">raise_codegen_error</span><span class="s1">' trace (r,x) = raise (CodegenErrorWithPos(Option.fold (fun s x -&gt; x :: s) trace r,x))</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=49">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="CodegenFsharp">CodegenFsharp<a class="anchor-link" href="#CodegenFsharp"></a></h2>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=50">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="o">//</span> <span class="nb">open</span> <span class="n">System</span>
<span class="o">//</span> <span class="nb">open</span> <span class="n">System</span><span class="o">.</span><span class="n">Text</span>
<span class="nb">open</span> <span class="n">System</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">Generic</span>

<span class="n">let</span> <span class="n">private</span> <span class="n">backend_nameFsharp</span> <span class="o">=</span> <span class="s2">"Fsharp"</span>

<span class="n">let</span> <span class="n">litFsharp</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">LitInt8</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%i</span><span class="s2">y"</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">LitInt16</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%i</span><span class="s2">s"</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">LitInt32</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%i</span><span class="s2">"</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">LitInt64</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%i</span><span class="s2">L"</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">LitUInt8</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%i</span><span class="s2">uy"</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">LitUInt16</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%i</span><span class="s2">us"</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">LitUInt32</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%i</span><span class="s2">u"</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">LitUInt64</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%i</span><span class="s2">UL"</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">LitFloat32</span> <span class="n">x</span> <span class="o">-&gt;</span> 
        <span class="k">if</span> <span class="n">x</span> <span class="o">=</span> <span class="n">infinityf</span> <span class="n">then</span> <span class="s2">"infinityf"</span>
        <span class="k">elif</span> <span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="n">infinityf</span> <span class="n">then</span> <span class="s2">"-infinityf"</span>
        <span class="k">elif</span> <span class="n">System</span><span class="o">.</span><span class="n">Single</span><span class="o">.</span><span class="n">IsNaN</span> <span class="n">x</span> <span class="n">then</span> <span class="s2">"nanf"</span>
        <span class="k">else</span> <span class="n">x</span><span class="o">.</span><span class="n">ToString</span><span class="p">(</span><span class="s2">"R"</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">add_dec_point</span> <span class="o">|&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2">f"</span>
    <span class="o">|</span> <span class="n">LitFloat64</span> <span class="n">x</span> <span class="o">-&gt;</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">=</span> <span class="n">infinity</span> <span class="n">then</span> <span class="s2">"infinity"</span>
        <span class="k">elif</span> <span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="n">infinity</span> <span class="n">then</span> <span class="s2">"-infinity"</span>
        <span class="k">elif</span> <span class="n">System</span><span class="o">.</span><span class="n">Double</span><span class="o">.</span><span class="n">IsNaN</span> <span class="n">x</span> <span class="n">then</span> <span class="s2">"nan"</span>
        <span class="k">else</span> <span class="n">x</span><span class="o">.</span><span class="n">ToString</span><span class="p">(</span><span class="s2">"R"</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">add_dec_point</span>
    <span class="o">|</span> <span class="n">LitString</span> <span class="n">x</span> <span class="o">-&gt;</span> 
        <span class="n">let</span> <span class="n">strb</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Text</span><span class="o">.</span><span class="n">StringBuilder</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">Length</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">strb</span><span class="o">.</span><span class="n">Append</span> <span class="s1">'"'</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
        <span class="n">String</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">function</span>
            <span class="o">|</span> <span class="s1">'"'</span> <span class="o">-&gt;</span> <span class="n">strb</span><span class="o">.</span><span class="n">Append</span> <span class="s2">"</span><span class="se">\\\"</span><span class="s2">"</span> 
            <span class="o">|</span> <span class="s1">'</span><span class="se">\b</span><span class="s1">'</span> <span class="o">-&gt;</span> <span class="n">strb</span><span class="o">.</span><span class="n">Append</span> <span class="o">@</span><span class="s2">"</span><span class="se">\b</span><span class="s2">"</span>
            <span class="o">|</span> <span class="s1">'</span><span class="se">\t</span><span class="s1">'</span> <span class="o">-&gt;</span> <span class="n">strb</span><span class="o">.</span><span class="n">Append</span> <span class="o">@</span><span class="s2">"</span><span class="se">\t</span><span class="s2">"</span>
            <span class="o">|</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">'</span> <span class="o">-&gt;</span> <span class="n">strb</span><span class="o">.</span><span class="n">Append</span> <span class="o">@</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
            <span class="o">|</span> <span class="s1">'</span><span class="se">\r</span><span class="s1">'</span> <span class="o">-&gt;</span> <span class="n">strb</span><span class="o">.</span><span class="n">Append</span> <span class="o">@</span><span class="s2">"</span><span class="se">\r</span><span class="s2">"</span>
            <span class="o">|</span> <span class="s1">'</span><span class="se">\\</span><span class="s1">'</span> <span class="o">-&gt;</span> <span class="n">strb</span><span class="o">.</span><span class="n">Append</span> <span class="o">@</span><span class="s2">"</span><span class="se">\\</span><span class="s2">"</span>
            <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">strb</span><span class="o">.</span><span class="n">Append</span> <span class="n">x</span>
            <span class="o">&gt;&gt;</span> <span class="n">ignore</span> 
            <span class="p">)</span> <span class="n">x</span>
        <span class="n">strb</span><span class="o">.</span><span class="n">Append</span> <span class="s1">'"'</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
        <span class="n">strb</span><span class="o">.</span><span class="n">ToString</span><span class="p">()</span>
    <span class="o">|</span> <span class="n">LitChar</span> <span class="n">x</span> <span class="o">-&gt;</span> 
        <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
        <span class="o">|</span> <span class="s1">'</span><span class="se">\b</span><span class="s1">'</span> <span class="o">-&gt;</span> <span class="o">@</span><span class="s2">"</span><span class="se">\b</span><span class="s2">"</span>
        <span class="o">|</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">'</span> <span class="o">-&gt;</span> <span class="o">@</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
        <span class="o">|</span> <span class="s1">'</span><span class="se">\t</span><span class="s1">'</span> <span class="o">-&gt;</span> <span class="o">@</span><span class="s2">"</span><span class="se">\t</span><span class="s2">"</span>
        <span class="o">|</span> <span class="s1">'</span><span class="se">\r</span><span class="s1">'</span> <span class="o">-&gt;</span> <span class="o">@</span><span class="s2">"</span><span class="se">\r</span><span class="s2">"</span>
        <span class="o">|</span> <span class="s1">'</span><span class="se">\\</span><span class="s1">'</span> <span class="o">-&gt;</span> <span class="o">@</span><span class="s2">"</span><span class="se">\\</span><span class="s2">"</span>
        <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">string</span> <span class="n">x</span>
        <span class="o">|&gt;</span> <span class="n">sprintf</span> <span class="s2">"'</span><span class="si">%s</span><span class="s2">'"</span>
    <span class="o">|</span> <span class="n">LitBool</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">x</span> <span class="n">then</span> <span class="s2">"true"</span> <span class="k">else</span> <span class="s2">"false"</span>

<span class="n">let</span> <span class="n">prim</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">Int8T</span> <span class="o">-&gt;</span> <span class="s2">"int8"</span>
    <span class="o">|</span> <span class="n">Int16T</span> <span class="o">-&gt;</span> <span class="s2">"int16"</span>
    <span class="o">|</span> <span class="n">Int32T</span> <span class="o">-&gt;</span> <span class="s2">"int32"</span>
    <span class="o">|</span> <span class="n">Int64T</span> <span class="o">-&gt;</span> <span class="s2">"int64"</span>
    <span class="o">|</span> <span class="n">UInt8T</span> <span class="o">-&gt;</span> <span class="s2">"uint8"</span>
    <span class="o">|</span> <span class="n">UInt16T</span> <span class="o">-&gt;</span> <span class="s2">"uint16"</span>
    <span class="o">|</span> <span class="n">UInt32T</span> <span class="o">-&gt;</span> <span class="s2">"uint32"</span>
    <span class="o">|</span> <span class="n">UInt64T</span> <span class="o">-&gt;</span> <span class="s2">"uint64"</span>
    <span class="o">|</span> <span class="n">Float32T</span> <span class="o">-&gt;</span> <span class="s2">"float32"</span>
    <span class="o">|</span> <span class="n">Float64T</span> <span class="o">-&gt;</span> <span class="s2">"float"</span>
    <span class="o">|</span> <span class="n">BoolT</span> <span class="o">-&gt;</span> <span class="s2">"bool"</span>
    <span class="o">|</span> <span class="n">StringT</span> <span class="o">-&gt;</span> <span class="s2">"string"</span>
    <span class="o">|</span> <span class="n">CharT</span> <span class="o">-&gt;</span> <span class="s2">"char"</span>

<span class="n">let</span> <span class="n">type_lit</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">YLit</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">litFsharp</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">YSymbol</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="s2">"Compiler error: Expecting a type literal in the macro."</span> 

<span class="nb">type</span> <span class="n">UnionRecFsharp</span> <span class="o">=</span> <span class="p">{</span><span class="n">tag</span> <span class="p">:</span> <span class="nb">int</span><span class="p">;</span> <span class="n">free_vars</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="nb">int</span> <span class="o">*</span> <span class="n">string</span><span class="p">,</span> <span class="n">TyV</span><span class="p">[]</span><span class="o">&gt;</span><span class="p">}</span>
<span class="nb">type</span> <span class="n">LayoutRecFsharp</span> <span class="o">=</span> <span class="p">{</span><span class="n">tag</span> <span class="p">:</span> <span class="nb">int</span><span class="p">;</span> <span class="n">data</span> <span class="p">:</span> <span class="n">Data</span><span class="p">;</span> <span class="n">free_vars</span> <span class="p">:</span> <span class="n">TyV</span><span class="p">[];</span> <span class="n">free_vars_by_key</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="nb">int</span> <span class="o">*</span> <span class="n">string</span><span class="p">,</span> <span class="n">TyV</span><span class="p">[]</span><span class="o">&gt;</span><span class="p">}</span>
<span class="nb">type</span> <span class="n">MethodRecFsharp</span> <span class="o">=</span> <span class="p">{</span><span class="n">tag</span> <span class="p">:</span> <span class="nb">int</span><span class="p">;</span> <span class="n">free_vars</span> <span class="p">:</span> <span class="n">L</span><span class="o">&lt;</span><span class="n">Tag</span><span class="p">,</span><span class="n">Ty</span><span class="o">&gt;</span><span class="p">[];</span> <span class="nb">range</span> <span class="p">:</span> <span class="n">Ty</span><span class="p">;</span> <span class="n">body</span> <span class="p">:</span> <span class="n">TypedBind</span><span class="p">[]}</span>
<span class="nb">type</span> <span class="n">ClosureRecFsharp</span> <span class="o">=</span> <span class="p">{</span><span class="n">tag</span> <span class="p">:</span> <span class="nb">int</span><span class="p">;</span> <span class="n">free_vars</span> <span class="p">:</span> <span class="n">L</span><span class="o">&lt;</span><span class="n">Tag</span><span class="p">,</span><span class="n">Ty</span><span class="o">&gt;</span><span class="p">[];</span> <span class="n">domain_args</span> <span class="p">:</span> <span class="n">TyV</span><span class="p">[];</span> <span class="nb">range</span> <span class="p">:</span> <span class="n">Ty</span><span class="p">;</span> <span class="n">body</span> <span class="p">:</span> <span class="n">TypedBind</span><span class="p">[]}</span>

<span class="n">let</span> <span class="n">codegenFsharp</span> <span class="p">(</span><span class="n">env</span> <span class="p">:</span> <span class="n">PartEvalResult</span><span class="p">)</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">TypedBind</span> <span class="p">[])</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">types</span> <span class="o">=</span> <span class="n">ResizeArray</span><span class="p">()</span>
    <span class="n">let</span> <span class="n">functions</span> <span class="o">=</span> <span class="n">ResizeArray</span><span class="p">()</span>

    <span class="n">let</span> <span class="nb">print</span> <span class="n">is_type</span> <span class="n">show</span> <span class="n">r</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="p">{</span><span class="n">text</span><span class="o">=</span><span class="n">System</span><span class="o">.</span><span class="n">Text</span><span class="o">.</span><span class="n">StringBuilder</span><span class="p">();</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">}</span>
        <span class="n">show</span> <span class="n">s</span> <span class="n">r</span>
        <span class="n">let</span> <span class="n">text</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">ToString</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">is_type</span> <span class="n">then</span> <span class="n">types</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="k">else</span> <span class="n">functions</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="n">let</span> <span class="n">layout</span> <span class="n">show</span> <span class="o">=</span>
        <span class="n">let</span> <span class="nb">dict</span><span class="s1">' = Dictionary(HashIdentity.Structural)</span>
        <span class="n">let</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Reference</span><span class="p">)</span>
        <span class="n">let</span> <span class="n">f</span> <span class="n">x</span> <span class="p">:</span> <span class="n">LayoutRecFsharp</span> <span class="o">=</span> 
            <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">YLayout</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">ty_to_data</span> <span class="n">x</span>
            <span class="n">let</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span>
                <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">DRecord</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">data_free_vars</span><span class="p">)</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">toArray</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">collect</span> <span class="n">snd</span><span class="p">,</span> <span class="n">a</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">data_free_vars</span> <span class="n">x</span><span class="p">,</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
            <span class="p">{</span><span class="n">data</span><span class="o">=</span><span class="n">x</span><span class="p">;</span> <span class="n">free_vars</span><span class="o">=</span><span class="n">a</span><span class="p">;</span> <span class="n">free_vars_by_key</span><span class="o">=</span><span class="n">b</span><span class="p">;</span> <span class="n">tag</span><span class="o">=</span><span class="nb">dict</span><span class="s1">'.Count}</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="err">$</span><span class="s2">"Compiler error: Expected a layout type (3).</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">{show_ty x}"</span>
        <span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">mutable</span> <span class="n">dirty</span> <span class="o">=</span> <span class="n">false</span>
            <span class="n">let</span> <span class="n">r</span> <span class="o">=</span> <span class="n">memoize</span> <span class="nb">dict</span> <span class="p">(</span><span class="n">memoize</span> <span class="nb">dict</span><span class="s1">' (fun x -&gt; dirty &lt;- true; f x)) x</span>
            <span class="k">if</span> <span class="n">dirty</span> <span class="n">then</span> <span class="nb">print</span> <span class="n">true</span> <span class="n">show</span> <span class="n">r</span>
            <span class="n">r</span>

    <span class="n">let</span> <span class="n">union</span> <span class="n">show</span> <span class="o">=</span>
        <span class="n">let</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Reference</span><span class="p">)</span>
        <span class="n">let</span> <span class="n">f</span> <span class="p">(</span><span class="n">a</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="nb">int</span> <span class="o">*</span> <span class="n">string</span><span class="p">,</span><span class="n">Ty</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">:</span> <span class="n">UnionRecFsharp</span> <span class="o">=</span> <span class="p">{</span><span class="n">free_vars</span><span class="o">=</span><span class="n">a</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">env</span><span class="o">.</span><span class="n">ty_to_data</span> <span class="o">&gt;&gt;</span> <span class="n">data_free_vars</span><span class="p">);</span> <span class="n">tag</span><span class="o">=</span><span class="nb">dict</span><span class="o">.</span><span class="n">Count</span><span class="p">}</span>
        <span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">mutable</span> <span class="n">dirty</span> <span class="o">=</span> <span class="n">false</span>
            <span class="n">let</span> <span class="n">r</span> <span class="o">=</span> <span class="n">memoize</span> <span class="nb">dict</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">dirty</span> <span class="o">&lt;-</span> <span class="n">true</span><span class="p">;</span> <span class="n">f</span> <span class="n">x</span><span class="p">)</span> <span class="n">x</span>
            <span class="k">if</span> <span class="n">dirty</span> <span class="n">then</span> <span class="nb">print</span> <span class="n">true</span> <span class="n">show</span> <span class="n">r</span>
            <span class="n">r</span>

    <span class="n">let</span> <span class="n">jp</span> <span class="n">f</span> <span class="n">show</span> <span class="o">=</span>
        <span class="n">let</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Structural</span><span class="p">)</span>
        <span class="n">let</span> <span class="n">f</span> <span class="n">x</span> <span class="o">=</span> <span class="n">f</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="o">.</span><span class="n">Count</span><span class="p">)</span>
        <span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">mutable</span> <span class="n">dirty</span> <span class="o">=</span> <span class="n">false</span>
            <span class="n">let</span> <span class="n">r</span> <span class="o">=</span> <span class="n">memoize</span> <span class="nb">dict</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">dirty</span> <span class="o">&lt;-</span> <span class="n">true</span><span class="p">;</span> <span class="n">f</span> <span class="n">x</span><span class="p">)</span> <span class="n">x</span>
            <span class="k">if</span> <span class="n">dirty</span> <span class="n">then</span> <span class="nb">print</span> <span class="n">false</span> <span class="n">show</span> <span class="n">r</span>
            <span class="n">r</span>

    <span class="n">let</span> <span class="n">args</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">_</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"v</span><span class="si">%i</span><span class="s2">"</span> <span class="n">i</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">", "</span>
    <span class="n">let</span> <span class="n">show_w</span> <span class="o">=</span> <span class="n">function</span> <span class="n">WV</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">_</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"v</span><span class="si">%i</span><span class="s2">"</span> <span class="n">i</span> <span class="o">|</span> <span class="n">WLit</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">litFsharp</span> <span class="n">a</span>

    <span class="n">let</span> <span class="k">global</span><span class="s1">' =</span>
        <span class="n">let</span> <span class="n">has_added</span> <span class="o">=</span> <span class="n">HashSet</span> <span class="n">env</span><span class="o">.</span><span class="n">globals</span>
        <span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">has_added</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="n">then</span> <span class="n">env</span><span class="o">.</span><span class="n">globals</span><span class="o">.</span><span class="n">Add</span> <span class="n">x</span>

    <span class="n">let</span> <span class="n">rec</span> <span class="n">tyv</span> <span class="n">x</span> <span class="o">=</span>
        <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">YUnion</span> <span class="n">a</span> <span class="o">-&gt;</span> 
            <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">Item</span>
            <span class="k">match</span> <span class="n">a</span><span class="o">.</span><span class="n">layout</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">UHeap</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"UH</span><span class="si">%i</span><span class="s2">"</span> <span class="p">(</span><span class="n">uheap</span> <span class="n">a</span><span class="o">.</span><span class="n">cases</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span>
            <span class="o">|</span> <span class="n">UStack</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"US</span><span class="si">%i</span><span class="s2">"</span> <span class="p">(</span><span class="n">ustack</span> <span class="n">a</span><span class="o">.</span><span class="n">cases</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span>
        <span class="o">|</span> <span class="n">YLayout</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">lay</span><span class="p">)</span> <span class="k">as</span> <span class="n">a</span> <span class="o">-&gt;</span> 
            <span class="k">match</span> <span class="n">lay</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">Heap</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Heap</span><span class="si">%i</span><span class="s2">"</span> <span class="p">(</span><span class="n">heap</span> <span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span>
            <span class="o">|</span> <span class="n">HeapMutable</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Mut</span><span class="si">%i</span><span class="s2">"</span> <span class="p">(</span><span class="n">mut</span> <span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span>
            <span class="o">|</span> <span class="n">StackMutable</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="s2">"Compiler error: The F# backend doesn't support stack mutable layout types."</span>
        <span class="o">|</span> <span class="n">YMacro</span> <span class="p">[</span><span class="n">Text</span> <span class="s2">"backend_switch "</span><span class="p">;</span> <span class="n">Type</span> <span class="p">(</span><span class="n">YRecord</span> <span class="n">r</span><span class="p">)]</span> <span class="o">-&gt;</span>
            <span class="k">match</span><span class="w"> </span><span class="n">r</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryPick</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="k">_</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">k</span> <span class="o">=</span> <span class="n">backend_nameFsharp</span> <span class="n">then</span> <span class="n">Some</span> <span class="n">v</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">Some</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">tup_ty</span> <span class="n">x</span>
            <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="err">$</span><span class="s2">"In the backend_switch, expected a record with the '</span><span class="si">{backend_nameFsharp}</span><span class="s2">' field."</span>
        <span class="o">|</span> <span class="n">YMacro</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">function</span> <span class="n">Text</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="o">|</span> <span class="n">Type</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">tup_ty</span> <span class="n">a</span> <span class="o">|</span> <span class="n">TypeLit</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">type_lit</span> <span class="n">a</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">""</span>
        <span class="o">|</span> <span class="n">YPrim</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">prim</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">YArray</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"(</span><span class="si">%s</span><span class="s2"> [])"</span> <span class="p">(</span><span class="n">tup_ty</span> <span class="n">a</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">YFun</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">FT_Vanilla</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"(</span><span class="si">%s</span><span class="s2"> -&gt; </span><span class="si">%s</span><span class="s2">)"</span> <span class="p">(</span><span class="n">tup_ty</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup_ty</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">YExists</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="s2">"Existentials are not supported at runtime. They are a compile time feature only."</span>
        <span class="o">|</span> <span class="n">YForall</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="s2">"Foralls are not supported at runtime. They are a compile time feature only."</span>
        <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="err">$</span><span class="s2">"Type not supported in the codegen.</span><span class="se">\n</span><span class="s2">Got: %A</span><span class="si">{a}</span><span class="s2">"</span>
    <span class="ow">and</span> <span class="n">args_tys</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">t</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"v</span><span class="si">%i</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">"</span> <span class="n">i</span> <span class="p">(</span><span class="n">tup_ty</span> <span class="n">t</span><span class="p">))</span> <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">", "</span>
    <span class="ow">and</span> <span class="n">binds</span> <span class="p">(</span><span class="n">s</span> <span class="p">:</span> <span class="n">CodegenEnv</span><span class="p">)</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">TypedBind</span> <span class="p">[])</span> <span class="o">=</span>
        <span class="n">Array</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">function</span>
            <span class="o">|</span> <span class="n">TyLet</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">trace</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">try</span> <span class="n">op</span> <span class="n">s</span> <span class="p">(</span><span class="n">Some</span> <span class="n">d</span><span class="p">)</span> <span class="n">a</span> <span class="k">with</span> <span class="p">:</span><span class="err">?</span> <span class="n">CodegenError</span> <span class="k">as</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span><span class="s1">' trace (e.Data0,e.Data1)</span>
            <span class="o">|</span> <span class="n">TyLocalReturnOp</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">try</span> <span class="n">op</span> <span class="n">s</span> <span class="kc">None</span> <span class="n">a</span> <span class="k">with</span> <span class="p">:</span><span class="err">?</span> <span class="n">CodegenError</span> <span class="k">as</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span><span class="s1">' trace (e.Data0,e.Data1)</span>
            <span class="o">|</span> <span class="n">TyLocalReturnData</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">trace</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">try</span> <span class="n">line</span> <span class="n">s</span> <span class="p">(</span><span class="n">tup</span> <span class="n">d</span><span class="p">)</span> <span class="k">with</span> <span class="p">:</span><span class="err">?</span> <span class="n">CodegenError</span> <span class="k">as</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span><span class="s1">' trace (e.Data0,e.Data1)</span>
            <span class="p">)</span> <span class="n">x</span>
    <span class="ow">and</span> <span class="n">tup</span> <span class="n">x</span> <span class="o">=</span>
        <span class="k">match</span> <span class="n">data_term_vars</span> <span class="n">x</span> <span class="k">with</span>
        <span class="o">|</span> <span class="p">[</span><span class="o">||</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="s2">"()"</span>
        <span class="o">|</span> <span class="p">[</span><span class="o">|</span><span class="n">x</span><span class="o">|</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">show_w</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="n">show_w</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">", "</span> <span class="o">|&gt;</span> <span class="n">sprintf</span> <span class="s2">"struct (</span><span class="si">%s</span><span class="s2">)"</span>
    <span class="ow">and</span> <span class="n">tup_ty</span> <span class="n">x</span> <span class="o">=</span>
        <span class="k">match</span> <span class="n">env</span><span class="o">.</span><span class="n">ty_to_data</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">data_free_vars</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">tyv</span> <span class="n">x</span><span class="p">)</span> <span class="k">with</span>
        <span class="o">|</span> <span class="p">[</span><span class="o">||</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="s2">"unit"</span>
        <span class="o">|</span> <span class="p">[</span><span class="o">|</span><span class="n">x</span><span class="o">|</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">" * "</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">sprintf</span> <span class="s2">"struct (</span><span class="si">%s</span><span class="s2">)"</span>
    <span class="ow">and</span> <span class="n">op</span> <span class="n">s</span> <span class="n">d</span> <span class="n">a</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">jp</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">=</span>
            <span class="n">let</span> <span class="n">args</span> <span class="o">=</span> <span class="n">args</span> <span class="n">b</span>
            <span class="k">match</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">JPMethod</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"method</span><span class="si">%i</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)"</span> <span class="p">(</span><span class="n">method</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span><span class="o">.</span><span class="n">tag</span> <span class="n">args</span>
            <span class="o">|</span> <span class="n">JPClosure</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"closure</span><span class="si">%i</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)"</span> <span class="p">(</span><span class="n">closure</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span><span class="o">.</span><span class="n">tag</span> <span class="n">args</span>
        <span class="n">let</span> <span class="n">free_vars</span> <span class="n">do_annot</span> <span class="n">x</span> <span class="o">=</span>
            <span class="n">let</span> <span class="n">f</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">t</span><span class="p">))</span> <span class="o">=</span> <span class="k">if</span> <span class="n">do_annot</span> <span class="n">then</span> <span class="n">sprintf</span> <span class="s2">"v</span><span class="si">%i</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">"</span> <span class="n">i</span> <span class="p">(</span><span class="n">tyv</span> <span class="n">t</span><span class="p">)</span> <span class="k">else</span> <span class="n">sprintf</span> <span class="s2">"v</span><span class="si">%i</span><span class="s2">"</span> <span class="n">i</span>
            <span class="k">match</span> <span class="n">data_free_vars</span> <span class="n">x</span> <span class="k">with</span>
            <span class="o">|</span> <span class="p">[</span><span class="o">||</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="s2">"()"</span>
            <span class="o">|</span> <span class="p">[</span><span class="o">|</span><span class="n">x</span><span class="o">|</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">x</span>
            <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="n">f</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">", "</span> <span class="o">|&gt;</span> <span class="n">sprintf</span> <span class="s2">"struct (</span><span class="si">%s</span><span class="s2">)"</span>
        <span class="n">let</span> <span class="n">simple</span> <span class="n">x</span> <span class="o">=</span> 
            <span class="k">match</span> <span class="n">d</span> <span class="k">with</span>
            <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">x</span>
            <span class="o">|</span> <span class="n">Some</span> <span class="n">d</span> <span class="o">-&gt;</span> <span class="n">match</span> <span class="n">free_vars</span> <span class="n">true</span> <span class="n">d</span> <span class="k">with</span> <span class="s2">"()"</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="o">|</span> <span class="n">d</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"let </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">"</span> <span class="n">d</span> <span class="n">x</span>
            <span class="o">|&gt;</span> <span class="n">line</span> <span class="n">s</span>
        <span class="n">let</span> <span class="nb">complex</span> <span class="n">f</span> <span class="o">=</span>
            <span class="k">match</span> <span class="n">d</span> <span class="k">with</span>
            <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">s</span> <span class="p">:</span> <span class="n">unit</span>
            <span class="o">|</span> <span class="n">Some</span> <span class="n">d</span> <span class="o">-&gt;</span> <span class="n">match</span> <span class="n">free_vars</span> <span class="n">true</span> <span class="n">d</span> <span class="k">with</span> <span class="s2">"()"</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">s</span> <span class="o">|</span> <span class="n">d</span> <span class="o">-&gt;</span> <span class="n">line</span> <span class="n">s</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"let </span><span class="si">%s</span><span class="s2"> ="</span> <span class="n">d</span><span class="p">);</span> <span class="n">f</span> <span class="p">(</span><span class="n">indent</span> <span class="n">s</span><span class="p">)</span>
        <span class="n">let</span> <span class="n">layout_vars</span> <span class="n">a</span> <span class="o">=</span>
            <span class="n">let</span> <span class="n">f</span> <span class="n">i</span> <span class="n">x</span> <span class="o">=</span>
                <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">WV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="s1">',_)) -&gt; sprintf "l</span><span class="si">%i</span><span class="s1"> = v</span><span class="si">%i</span><span class="s1">" i i'</span>
                <span class="o">|</span> <span class="n">WLit</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"l</span><span class="si">%i</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">"</span> <span class="n">i</span> <span class="p">(</span><span class="n">litFsharp</span> <span class="n">x</span><span class="p">)</span>
            <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">data_term_vars</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">mapi</span> <span class="n">f</span> <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">"; "</span>
        <span class="n">let</span> <span class="n">layout_index</span> <span class="n">i</span> <span class="n">x</span> <span class="o">=</span>
            <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="s1">',_)) -&gt; sprintf "v</span><span class="si">%i</span><span class="s1">.l</span><span class="si">%i</span><span class="s1">" i i'</span><span class="p">)</span>
            <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">", "</span>
            <span class="o">|&gt;</span> <span class="n">function</span> <span class="s2">""</span> <span class="o">-&gt;</span> <span class="p">()</span> <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">simple</span> <span class="n">x</span>
        <span class="n">let</span> <span class="n">length</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">=</span>
            <span class="k">match</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">YPrim</span> <span class="n">UInt8T</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"System.Convert.ToByte </span><span class="si">%s</span><span class="s2">.Length"</span> <span class="p">(</span><span class="n">tup</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">YPrim</span> <span class="n">UInt16T</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"System.Convert.ToUInt16 </span><span class="si">%s</span><span class="s2">.Length"</span> <span class="p">(</span><span class="n">tup</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">YPrim</span> <span class="n">UInt32T</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"System.Convert.ToUInt32 </span><span class="si">%s</span><span class="s2">.Length"</span> <span class="p">(</span><span class="n">tup</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">YPrim</span> <span class="n">UInt64T</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"System.Convert.ToUInt64 </span><span class="si">%s</span><span class="s2">.Length"</span> <span class="p">(</span><span class="n">tup</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">YPrim</span> <span class="n">Int8T</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"System.Convert.ToSByte </span><span class="si">%s</span><span class="s2">.Length"</span> <span class="p">(</span><span class="n">tup</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">YPrim</span> <span class="n">Int16T</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"System.Convert.ToInt16 </span><span class="si">%s</span><span class="s2">.Length"</span> <span class="p">(</span><span class="n">tup</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">YPrim</span> <span class="n">Int32T</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2">.Length"</span> <span class="p">(</span><span class="n">tup</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">YPrim</span> <span class="n">Int64T</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"System.Convert.ToInt64 </span><span class="si">%s</span><span class="s2">.Length"</span> <span class="p">(</span><span class="n">tup</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="s2">"Compiler error: Expected an int in length"</span>
            <span class="o">|&gt;</span> <span class="n">simple</span>
        <span class="k">match</span> <span class="n">a</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">TyMacro</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">function</span> <span class="n">CMText</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="o">|</span> <span class="n">CMTerm</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">tup</span> <span class="n">x</span> <span class="o">|</span> <span class="n">CMType</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">tup_ty</span> <span class="n">x</span> <span class="o">|</span> <span class="n">CMTypeLit</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">type_lit</span> <span class="n">x</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">""</span> <span class="o">|&gt;</span> <span class="n">simple</span>
        <span class="o">|</span> <span class="n">TySizeOf</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">simple</span> <span class="err">$</span><span class="s2">"sizeof&lt;{tup_ty t}&gt;"</span>
        <span class="o">|</span> <span class="n">TyIf</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span><span class="n">tr</span><span class="p">,</span><span class="n">fl</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="nb">complex</span> <span class="o">&lt;|</span> <span class="n">fun</span> <span class="n">s</span> <span class="o">-&gt;</span>
            <span class="n">line</span> <span class="n">s</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"if </span><span class="si">%s</span><span class="s2"> then"</span> <span class="p">(</span><span class="n">tup</span> <span class="n">cond</span><span class="p">))</span>
            <span class="n">binds</span> <span class="p">(</span><span class="n">indent</span> <span class="n">s</span><span class="p">)</span> <span class="n">tr</span>
            <span class="k">match</span> <span class="n">fl</span> <span class="k">with</span>
            <span class="o">|</span> <span class="p">[</span><span class="o">|</span><span class="n">TyLocalReturnData</span><span class="p">(</span><span class="n">DB</span><span class="p">,</span><span class="n">_</span><span class="p">)</span><span class="o">|</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="p">()</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span>
                <span class="n">line</span> <span class="n">s</span> <span class="s2">"else"</span>
                <span class="n">binds</span> <span class="p">(</span><span class="n">indent</span> <span class="n">s</span><span class="p">)</span> <span class="n">fl</span>
        <span class="o">|</span> <span class="n">TyJoinPoint</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">args</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">simple</span> <span class="p">(</span><span class="n">jp</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span>
        <span class="o">|</span> <span class="n">TyBackend</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">r</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error_backend</span> <span class="n">r</span> <span class="s2">"The F# backend does not support nesting other backends."</span>
        <span class="o">|</span> <span class="n">TyWhile</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="nb">complex</span> <span class="o">&lt;|</span> <span class="n">fun</span> <span class="n">s</span> <span class="o">-&gt;</span>
            <span class="n">line</span> <span class="n">s</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"while </span><span class="si">%s</span><span class="s2"> do"</span> <span class="p">(</span><span class="n">jp</span> <span class="n">a</span><span class="p">))</span>
            <span class="n">binds</span> <span class="p">(</span><span class="n">indent</span> <span class="n">s</span><span class="p">)</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">TyDo</span> <span class="n">a</span> <span class="o">-&gt;</span>
            <span class="nb">complex</span> <span class="o">&lt;|</span> <span class="n">fun</span> <span class="n">s</span> <span class="o">-&gt;</span>
            <span class="n">line</span> <span class="n">s</span> <span class="s2">"do"</span>
            <span class="n">binds</span> <span class="p">(</span><span class="n">indent</span> <span class="n">s</span><span class="p">)</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">TyIndent</span> <span class="n">a</span> <span class="o">-&gt;</span>
            <span class="nb">complex</span> <span class="o">&lt;|</span> <span class="n">fun</span> <span class="n">s</span> <span class="o">-&gt;</span>
            <span class="n">binds</span> <span class="p">(</span><span class="n">indent</span> <span class="n">s</span><span class="p">)</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">TyIntSwitch</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">_</span><span class="p">),</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="nb">complex</span> <span class="o">&lt;|</span> <span class="n">fun</span> <span class="n">s</span> <span class="o">-&gt;</span>
            <span class="n">line</span> <span class="n">s</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"match v</span><span class="si">%i</span><span class="s2"> with"</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">Array</span><span class="o">.</span><span class="n">iteri</span> <span class="p">(</span><span class="n">fun</span> <span class="n">i</span> <span class="n">x</span> <span class="o">-&gt;</span>
                <span class="n">line</span> <span class="n">s</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"| </span><span class="si">%i</span><span class="s2"> -&gt;"</span> <span class="n">i</span><span class="p">)</span>
                <span class="n">binds</span> <span class="p">(</span><span class="n">indent</span> <span class="n">s</span><span class="p">)</span> <span class="n">x</span>
                <span class="p">)</span> <span class="n">on_succ</span>
            <span class="n">line</span> <span class="n">s</span> <span class="s2">"| _ -&gt;"</span>
            <span class="n">binds</span> <span class="p">(</span><span class="n">indent</span> <span class="n">s</span><span class="p">)</span> <span class="n">on_fail</span>
        <span class="o">|</span> <span class="n">TyUnionUnbox</span><span class="p">(</span><span class="ow">is</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">on_succs</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="nb">complex</span> <span class="o">&lt;|</span> <span class="n">fun</span> <span class="n">s</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">case_tags</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">Item</span><span class="o">.</span><span class="n">tags</span>
            <span class="n">line</span> <span class="n">s</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"match </span><span class="si">%s</span><span class="s2"> with"</span> <span class="p">(</span><span class="ow">is</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">_</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"v</span><span class="si">{i}</span><span class="s2">"</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">", "</span><span class="p">))</span>
            <span class="n">let</span> <span class="n">prefix</span> <span class="o">=</span> 
                <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">Item</span>
                <span class="k">match</span> <span class="n">x</span><span class="o">.</span><span class="n">layout</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">UHeap</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"UH</span><span class="si">%i</span><span class="s2">"</span> <span class="p">(</span><span class="n">uheap</span> <span class="n">x</span><span class="o">.</span><span class="n">cases</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span>
                <span class="o">|</span> <span class="n">UStack</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"US</span><span class="si">%i</span><span class="s2">"</span> <span class="p">(</span><span class="n">ustack</span> <span class="n">x</span><span class="o">.</span><span class="n">cases</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span>
            <span class="n">Map</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">k</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">i</span> <span class="o">=</span> <span class="n">case_tags</span><span class="o">.</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="n">let</span> <span class="n">cases</span> <span class="o">=</span> 
                    <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">a</span> <span class="o">-&gt;</span>
                        <span class="k">match</span> <span class="n">data_free_vars</span> <span class="n">a</span> <span class="k">with</span>
                        <span class="o">|</span> <span class="p">[</span><span class="o">||</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="s2">""</span>
                        <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"(</span><span class="si">%s</span><span class="s2">)"</span> <span class="p">(</span><span class="n">args</span> <span class="n">x</span><span class="p">)</span>
                        <span class="o">|&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2">_</span><span class="si">%i%s</span><span class="s2">"</span> <span class="n">prefix</span> <span class="n">i</span>
                        <span class="p">)</span>
                    <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">", "</span>
                <span class="n">line</span> <span class="n">s</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"| </span><span class="si">%s</span><span class="s2"> -&gt; (* </span><span class="si">%s</span><span class="s2"> *)"</span> <span class="n">cases</span> <span class="n">k</span><span class="p">)</span>
                <span class="n">binds</span> <span class="p">(</span><span class="n">indent</span> <span class="n">s</span><span class="p">)</span> <span class="n">b</span>
                <span class="p">)</span> <span class="n">on_succs</span>
            <span class="n">on_fail</span> <span class="o">|&gt;</span> <span class="n">Option</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">b</span> <span class="o">-&gt;</span>
                <span class="n">line</span> <span class="n">s</span> <span class="s2">"| _ -&gt;"</span>
                <span class="n">binds</span> <span class="p">(</span><span class="n">indent</span> <span class="n">s</span><span class="p">)</span> <span class="n">b</span>
                <span class="p">)</span>
        <span class="o">|</span> <span class="n">TyUnionBox</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">Item</span>
            <span class="n">let</span> <span class="n">i</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
            <span class="n">let</span> <span class="nb">vars</span> <span class="o">=</span>
                <span class="k">match</span> <span class="n">data_term_vars</span> <span class="n">b</span> <span class="k">with</span>
                <span class="o">|</span> <span class="p">[</span><span class="o">||</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="s2">""</span>
                <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="n">show_w</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">", "</span> <span class="o">|&gt;</span> <span class="n">sprintf</span> <span class="s2">"(</span><span class="si">%s</span><span class="s2">)"</span>
            <span class="k">match</span> <span class="n">c</span><span class="o">.</span><span class="n">layout</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">UHeap</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"UH</span><span class="si">%i</span><span class="s2">_</span><span class="si">%i%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">uheap</span> <span class="n">c</span><span class="o">.</span><span class="n">cases</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span> <span class="n">i</span> <span class="nb">vars</span>
            <span class="o">|</span> <span class="n">UStack</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"US</span><span class="si">%i</span><span class="s2">_</span><span class="si">%i%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">ustack</span> <span class="n">c</span><span class="o">.</span><span class="n">cases</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span> <span class="n">i</span> <span class="nb">vars</span>
            <span class="o">|&gt;</span> <span class="n">simple</span>
        <span class="o">|</span> <span class="n">TyToLayout</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> 
            <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">layout_vars</span> <span class="n">a</span>
            <span class="k">match</span> <span class="n">b</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">YLayout</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">layout</span><span class="p">)</span> <span class="o">-&gt;</span> 
                <span class="k">match</span> <span class="n">layout</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">Heap</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">a</span> <span class="o">=</span> <span class="s2">""</span> <span class="n">then</span> <span class="n">sprintf</span> <span class="s2">"Heap</span><span class="si">%i</span><span class="s2">()"</span> <span class="p">(</span><span class="n">heap</span> <span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span> <span class="k">else</span> <span class="n">sprintf</span> <span class="s2">"{</span><span class="si">%s</span><span class="s2">} : Heap</span><span class="si">%i</span><span class="s2">"</span> <span class="n">a</span> <span class="p">(</span><span class="n">heap</span> <span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span>
                <span class="o">|</span> <span class="n">HeapMutable</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">a</span> <span class="o">=</span> <span class="s2">""</span> <span class="n">then</span> <span class="n">sprintf</span> <span class="s2">"Mut</span><span class="si">%i</span><span class="s2">()"</span> <span class="p">(</span><span class="n">mut</span> <span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span> <span class="k">else</span> <span class="n">sprintf</span> <span class="s2">"{</span><span class="si">%s</span><span class="s2">} : Mut</span><span class="si">%i</span><span class="s2">"</span> <span class="n">a</span> <span class="p">(</span><span class="n">mut</span> <span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span>
                <span class="o">|</span> <span class="n">StackMutable</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="s2">"The F# backend doesn't support stack mutable layout types."</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="err">$</span><span class="s2">"Compiler error: Expected a layout type (4).</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">{show_ty b}"</span>
            <span class="o">|&gt;</span> <span class="n">simple</span>
        <span class="o">|</span> <span class="n">TyLayoutIndexAll</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">YLayout</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">lay</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">a</span><span class="p">))</span> <span class="o">-&gt;</span> 
            <span class="k">match</span> <span class="n">lay</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">Heap</span> <span class="o">-&gt;</span> <span class="n">heap</span> <span class="n">a</span> 
            <span class="o">|</span> <span class="n">HeapMutable</span> <span class="o">-&gt;</span> <span class="n">mut</span> <span class="n">a</span> 
            <span class="o">|</span> <span class="n">StackMutable</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="s2">"The F# backend doesn't support indexing into stack mutable layout types."</span>
            <span class="o">|&gt;</span> <span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">.</span><span class="n">free_vars</span> <span class="o">|&gt;</span> <span class="n">layout_index</span> <span class="n">i</span>
        <span class="o">|</span> <span class="n">TyLayoutIndexByKey</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">YLayout</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">lay</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">a</span><span class="p">),</span><span class="n">key</span><span class="p">)</span> <span class="o">-&gt;</span> 
            <span class="k">match</span> <span class="n">lay</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">Heap</span> <span class="o">-&gt;</span> <span class="n">heap</span> <span class="n">a</span>
            <span class="o">|</span> <span class="n">HeapMutable</span> <span class="o">-&gt;</span> <span class="n">mut</span> <span class="n">a</span> 
            <span class="o">|</span> <span class="n">StackMutable</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="s2">"The F# backend doesn't support indexing into stack mutable layout types."</span>
            <span class="o">|&gt;</span> <span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span>
                <span class="n">x</span><span class="o">.</span><span class="n">free_vars_by_key</span>
                <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryPick</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">k</span> <span class="o">=</span> <span class="n">key</span> <span class="n">then</span> <span class="n">Some</span> <span class="n">v</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                <span class="o">|&gt;</span> <span class="n">Option</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">layout_index</span> <span class="n">i</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TyLayoutIndexAll</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyLayoutIndexByKey</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="s2">"Compiler error: Expected the TyV in layout index to be a layout type."</span>
        <span class="o">|</span> <span class="n">TyLayoutMutableSet</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">t</span><span class="p">),</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">k</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">s</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">DRecord</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">l</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">pick</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">k</span><span class="s1">') v -&gt; if k'</span> <span class="o">=</span> <span class="n">k</span> <span class="n">then</span> <span class="n">Some</span> <span class="n">v</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="s2">"Compiler error: Expected a record."</span><span class="p">)</span> <span class="p">(</span><span class="n">mut</span> <span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">data</span> <span class="n">b</span>
            <span class="n">Array</span><span class="o">.</span><span class="n">iter2</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="s1">',_)) b -&gt;</span>
                <span class="n">line</span> <span class="n">s</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"v</span><span class="si">%i</span><span class="s2">.l</span><span class="si">%i</span><span class="s2"> &lt;- </span><span class="si">%s</span><span class="s2">"</span> <span class="n">i</span> <span class="n">i</span><span class="s1">' (show_w b))</span>
                <span class="p">)</span> <span class="p">(</span><span class="n">data_free_vars</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">data_term_vars</span> <span class="n">c</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TyArrayLiteral</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">simple</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"[|</span><span class="si">%s</span><span class="s2">|]"</span> <span class="p">(</span><span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="n">tup</span> <span class="n">b</span> <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">"; "</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TyArrayCreate</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">b</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">DLit</span><span class="p">(</span><span class="n">LitInt32</span> <span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">YPrim</span> <span class="n">Int32T</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">simple</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"Array.zeroCreate&lt;</span><span class="si">%s</span><span class="s2">&gt; (</span><span class="si">%s</span><span class="s2">)"</span> <span class="p">(</span><span class="n">tup_ty</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup</span> <span class="n">b</span><span class="p">))</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">simple</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"Array.zeroCreate&lt;</span><span class="si">%s</span><span class="s2">&gt; (System.Convert.ToInt32(</span><span class="si">%s</span><span class="s2">))"</span> <span class="p">(</span><span class="n">tup_ty</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup</span> <span class="n">b</span><span class="p">))</span>
        <span class="o">|</span> <span class="n">TyArrayLength</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">length</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TyStringLength</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">length</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">TyFailwith</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">simple</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"failwith&lt;</span><span class="si">%s</span><span class="s2">&gt; </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup_ty</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup</span> <span class="n">b</span><span class="p">))</span>
        <span class="o">|</span> <span class="n">TyConv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">b</span> <span class="o">=</span> <span class="n">tup</span> <span class="n">b</span>
            <span class="k">match</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">YPrim</span> <span class="n">Int8T</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"int8 </span><span class="si">{b}</span><span class="s2">"</span>
            <span class="o">|</span> <span class="n">YPrim</span> <span class="n">Int16T</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"int16 </span><span class="si">{b}</span><span class="s2">"</span>
            <span class="o">|</span> <span class="n">YPrim</span> <span class="n">Int32T</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"int32 </span><span class="si">{b}</span><span class="s2">"</span>
            <span class="o">|</span> <span class="n">YPrim</span> <span class="n">Int64T</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"int64 </span><span class="si">{b}</span><span class="s2">"</span>
            <span class="o">|</span> <span class="n">YPrim</span> <span class="n">UInt8T</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"uint8 </span><span class="si">{b}</span><span class="s2">"</span>
            <span class="o">|</span> <span class="n">YPrim</span> <span class="n">UInt16T</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"uint16 </span><span class="si">{b}</span><span class="s2">"</span>
            <span class="o">|</span> <span class="n">YPrim</span> <span class="n">UInt32T</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"uint32 </span><span class="si">{b}</span><span class="s2">"</span>
            <span class="o">|</span> <span class="n">YPrim</span> <span class="n">UInt64T</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"uint64 </span><span class="si">{b}</span><span class="s2">"</span>
            <span class="o">|</span> <span class="n">YPrim</span> <span class="n">Float32T</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"float32 </span><span class="si">{b}</span><span class="s2">"</span>
            <span class="o">|</span> <span class="n">YPrim</span> <span class="n">Float64T</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"float </span><span class="si">{b}</span><span class="s2">"</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="err">$</span><span class="s2">"Compiler error: Unexpected type in Conv. Got: {show_ty a}"</span>
            <span class="o">|&gt;</span> <span class="n">simple</span>
        <span class="o">|</span> <span class="n">TyApply</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">_</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"v</span><span class="si">%i</span><span class="s2"> </span><span class="si">%s</span><span class="s2">"</span> <span class="n">i</span> <span class="p">(</span><span class="n">tup</span> <span class="n">b</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">simple</span>
        <span class="o">|</span> <span class="n">TyOp</span><span class="p">(</span><span class="n">Global</span><span class="p">,</span> <span class="p">[</span><span class="n">DLit</span> <span class="p">(</span><span class="n">LitString</span> <span class="n">x</span><span class="p">)])</span> <span class="o">-&gt;</span> <span class="k">global</span><span class="s1">' x</span>
        <span class="o">|</span> <span class="n">TyOp</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="n">l</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">op</span><span class="p">,</span> <span class="n">l</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">Dyn</span><span class="p">,[</span><span class="n">a</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">tup</span> <span class="n">a</span>
            <span class="o">|</span> <span class="n">TypeToVar</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="s2">"The use of `` should never appear in generated code."</span>
            <span class="o">|</span> <span class="n">StringIndex</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2">.[int </span><span class="si">%s</span><span class="s2">]"</span> <span class="p">(</span><span class="n">tup</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">StringSlice</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">;</span><span class="n">c</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2">.[int </span><span class="si">%s</span><span class="s2">..int </span><span class="si">%s</span><span class="s2">]"</span> <span class="p">(</span><span class="n">tup</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup</span> <span class="n">b</span><span class="p">)</span> <span class="p">(</span><span class="n">tup</span> <span class="n">c</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">ArrayIndex</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2">.[int </span><span class="si">%s</span><span class="s2">]"</span> <span class="p">(</span><span class="n">tup</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">ArrayIndexSet</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">;</span><span class="n">c</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2">.[int </span><span class="si">%s</span><span class="s2">] &lt;- </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup</span> <span class="n">b</span><span class="p">)</span> <span class="p">(</span><span class="n">tup</span> <span class="n">c</span><span class="p">)</span> 

            <span class="o">//</span> <span class="n">Math</span>
            <span class="o">|</span> <span class="n">Add</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> + </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">Sub</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> - </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">Mult</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> * </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">Div</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> / </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">Mod</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> </span><span class="si">%%</span><span class="s2"> </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">Pow</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> ** </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">LT</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> &lt; </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">LTE</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> &lt;= </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">EQ</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">NEQ</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> &lt;&gt; </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">GT</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> &gt; </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">GTE</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> &gt;= </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">BoolAnd</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> &amp;&amp; </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">BoolOr</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> || </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">BitwiseAnd</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> &amp;&amp;&amp; </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">BitwiseOr</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> ||| </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">BitwiseXor</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> ^^^ </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">BitwiseComplement</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"~~~</span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup</span> <span class="n">a</span><span class="p">)</span>

            <span class="o">|</span> <span class="n">ShiftLeft</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> &lt;&lt;&lt; </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup</span> <span class="n">b</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">ShiftRight</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> &gt;&gt;&gt; </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup</span> <span class="n">b</span><span class="p">)</span>

            <span class="o">|</span> <span class="n">Neg</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">" -</span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup</span> <span class="n">x</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">Log</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"log </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup</span> <span class="n">x</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">Exp</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"exp </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup</span> <span class="n">x</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">Tanh</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"tanh </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup</span> <span class="n">x</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">Sqrt</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"sqrt </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup</span> <span class="n">x</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">Sin</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"sin </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup</span> <span class="n">x</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">Cos</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"cos </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup</span> <span class="n">x</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">NanIs</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">-&gt;</span> 
                <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">DLit</span><span class="p">(</span><span class="n">LitFloat32</span> <span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">YPrim</span> <span class="n">Float32T</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"System.Single.IsNaN(</span><span class="si">%s</span><span class="s2">)"</span> <span class="p">(</span><span class="n">tup</span> <span class="n">x</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">DLit</span><span class="p">(</span><span class="n">LitFloat64</span> <span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">YPrim</span> <span class="n">Float64T</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"System.Double.IsNaN(</span><span class="si">%s</span><span class="s2">)"</span> <span class="p">(</span><span class="n">tup</span> <span class="n">x</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="s2">"Compiler error: Invalid type in NanIs."</span>
            <span class="o">|</span> <span class="n">UnionTag</span><span class="p">,</span> <span class="p">[</span><span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">YUnion</span> <span class="n">h</span><span class="p">))]</span> <span class="o">-&gt;</span> 
                <span class="n">let</span> <span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">Item</span>
                <span class="n">let</span> <span class="n">ty</span> <span class="o">=</span>
                    <span class="k">match</span> <span class="n">h</span><span class="o">.</span><span class="n">layout</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">UHeap</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"UH</span><span class="si">%i</span><span class="s2">"</span> <span class="p">(</span><span class="n">uheap</span> <span class="n">h</span><span class="o">.</span><span class="n">cases</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span>
                    <span class="o">|</span> <span class="n">UStack</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"US</span><span class="si">%i</span><span class="s2">"</span> <span class="p">(</span><span class="n">ustack</span> <span class="n">h</span><span class="o">.</span><span class="n">cases</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span>
                <span class="n">let</span> <span class="n">items</span> <span class="o">=</span>
                    <span class="n">h</span><span class="o">.</span><span class="n">cases</span>
                    <span class="o">|&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">KeyValue</span> <span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">_</span><span class="p">),</span> <span class="n">_</span><span class="p">))</span> <span class="o">-&gt;</span>
                        <span class="err">$</span><span class="s2">"</span><span class="si">{ty}</span><span class="s2">_</span><span class="si">{i}</span><span class="s2">, </span><span class="si">{i}</span><span class="s2">"</span>
                    <span class="p">)</span>
                    <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">"; "</span>
                <span class="err">$</span><span class="s2">"[ </span><span class="si">{items}</span><span class="s2"> ] |&gt; Map |&gt; Map.find v</span><span class="si">{i}</span><span class="s2">"</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Compiler error: %A with </span><span class="si">%i</span><span class="s2"> args not supported"</span> <span class="n">op</span> <span class="n">l</span><span class="o">.</span><span class="n">Length</span>
            <span class="o">|&gt;</span> <span class="n">simple</span>
    <span class="ow">and</span> <span class="n">heap</span> <span class="p">:</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">LayoutRecFsharp</span> <span class="o">=</span> <span class="n">layout</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">x</span> <span class="o">-&gt;</span>
        <span class="n">let</span> <span class="n">b</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">free_vars</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">t</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"l</span><span class="si">%i</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">"</span> <span class="n">i</span> <span class="p">(</span><span class="n">tyv</span> <span class="n">t</span><span class="p">))</span> <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">"; "</span>
        <span class="k">if</span> <span class="n">b</span> <span class="o">=</span> <span class="s2">""</span> <span class="n">then</span> <span class="n">line</span> <span class="n">s</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"Heap</span><span class="si">%i</span><span class="s2">() = class end"</span> <span class="n">x</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
        <span class="k">else</span> <span class="n">line</span> <span class="n">s</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"Heap</span><span class="si">%i</span><span class="s2"> = {</span><span class="si">%s</span><span class="s2">}"</span> <span class="n">x</span><span class="o">.</span><span class="n">tag</span> <span class="n">b</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="ow">and</span> <span class="n">mut</span> <span class="p">:</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">LayoutRecFsharp</span> <span class="o">=</span> <span class="n">layout</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">x</span> <span class="o">-&gt;</span>
        <span class="n">let</span> <span class="n">b</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">free_vars</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">t</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"mutable l</span><span class="si">%i</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">"</span> <span class="n">i</span> <span class="p">(</span><span class="n">tyv</span> <span class="n">t</span><span class="p">))</span> <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">"; "</span>
        <span class="k">if</span> <span class="n">b</span> <span class="o">=</span> <span class="s2">""</span> <span class="n">then</span> <span class="n">line</span> <span class="n">s</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"Mut</span><span class="si">%i</span><span class="s2">() = class end"</span> <span class="n">x</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
        <span class="k">else</span> <span class="n">line</span> <span class="n">s</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"Mut</span><span class="si">%i</span><span class="s2"> = {</span><span class="si">%s</span><span class="s2">}"</span> <span class="n">x</span><span class="o">.</span><span class="n">tag</span> <span class="n">b</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="ow">and</span> <span class="n">uheap</span> <span class="p">:</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">UnionRecFsharp</span> <span class="o">=</span> <span class="n">union</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">x</span> <span class="o">-&gt;</span>
        <span class="n">line</span> <span class="n">s</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"UH</span><span class="si">%i</span><span class="s2"> ="</span> <span class="n">x</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
        <span class="n">let</span> <span class="n">mutable</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">x</span><span class="o">.</span><span class="n">free_vars</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="n">a</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="p">[</span><span class="o">||</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">line</span> <span class="p">(</span><span class="n">indent</span> <span class="n">s</span><span class="p">)</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"| UH</span><span class="si">%i</span><span class="s2">_</span><span class="si">%i</span><span class="s2">"</span> <span class="n">x</span><span class="o">.</span><span class="n">tag</span> <span class="n">i</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">line</span> <span class="p">(</span><span class="n">indent</span> <span class="n">s</span><span class="p">)</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"| UH</span><span class="si">%i</span><span class="s2">_</span><span class="si">%i</span><span class="s2"> of </span><span class="si">%s</span><span class="s2">"</span> <span class="n">x</span><span class="o">.</span><span class="n">tag</span> <span class="n">i</span> <span class="p">(</span><span class="n">a</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">t</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">tyv</span> <span class="n">t</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">" * "</span><span class="p">))</span>
            <span class="n">i</span> <span class="o">&lt;-</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="ow">and</span> <span class="n">ustack</span> <span class="p">:</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">UnionRecFsharp</span> <span class="o">=</span> <span class="n">union</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">x</span> <span class="o">-&gt;</span>
        <span class="n">line</span> <span class="n">s</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"[&lt;Struct&gt;] US</span><span class="si">%i</span><span class="s2"> ="</span> <span class="n">x</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
        <span class="n">let</span> <span class="n">mutable</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">x</span><span class="o">.</span><span class="n">free_vars</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="n">a</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="p">[</span><span class="o">||</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">line</span> <span class="p">(</span><span class="n">indent</span> <span class="n">s</span><span class="p">)</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"| US</span><span class="si">%i</span><span class="s2">_</span><span class="si">%i</span><span class="s2">"</span> <span class="n">x</span><span class="o">.</span><span class="n">tag</span> <span class="n">i</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">line</span> <span class="p">(</span><span class="n">indent</span> <span class="n">s</span><span class="p">)</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"| US</span><span class="si">%i</span><span class="s2">_</span><span class="si">%i</span><span class="s2"> of </span><span class="si">%s</span><span class="s2">"</span> <span class="n">x</span><span class="o">.</span><span class="n">tag</span> <span class="n">i</span> <span class="p">(</span><span class="n">a</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">mapi</span> <span class="p">(</span><span class="n">fun</span> <span class="n">i</span><span class="s1">' (L(_,t)) -&gt; sprintf "f</span><span class="si">%i</span><span class="s1">_</span><span class="si">%i</span><span class="s1"> : </span><span class="si">%s</span><span class="s1">" i i'</span> <span class="p">(</span><span class="n">tyv</span> <span class="n">t</span><span class="p">))</span> <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">" * "</span><span class="p">))</span>
            <span class="n">i</span> <span class="o">&lt;-</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="ow">and</span> <span class="n">method</span> <span class="p">:</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">MethodRecFsharp</span> <span class="o">=</span>
        <span class="n">jp</span> <span class="p">(</span><span class="n">fun</span> <span class="p">((</span><span class="n">jp_body</span><span class="p">,</span><span class="n">key</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">C</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="n">_</span><span class="p">))),</span><span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="p">(</span><span class="n">fst</span> <span class="n">env</span><span class="o">.</span><span class="n">join_point_method</span><span class="o">.</span><span class="p">[</span><span class="n">jp_body</span><span class="p">])</span><span class="o">.</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">Some</span> <span class="n">a</span><span class="p">,</span> <span class="n">Some</span> <span class="nb">range</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">tag</span><span class="o">=</span><span class="n">i</span><span class="p">;</span> <span class="n">free_vars</span><span class="o">=</span><span class="n">rdata_free_vars</span> <span class="n">args</span><span class="p">;</span> <span class="nb">range</span><span class="o">=</span><span class="nb">range</span><span class="p">;</span> <span class="n">body</span><span class="o">=</span><span class="n">a</span><span class="p">}</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="s2">"Compiler error: The method dictionary is malformed"</span>
            <span class="p">)</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">x</span> <span class="o">-&gt;</span>
            <span class="n">line</span> <span class="n">s</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"method</span><span class="si">%i</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">) : </span><span class="si">%s</span><span class="s2"> ="</span> <span class="n">x</span><span class="o">.</span><span class="n">tag</span> <span class="p">(</span><span class="n">args_tys</span> <span class="n">x</span><span class="o">.</span><span class="n">free_vars</span><span class="p">)</span> <span class="p">(</span><span class="n">tup_ty</span> <span class="n">x</span><span class="o">.</span><span class="n">range</span><span class="p">))</span>
            <span class="n">binds</span> <span class="p">(</span><span class="n">indent</span> <span class="n">s</span><span class="p">)</span> <span class="n">x</span><span class="o">.</span><span class="n">body</span>
            <span class="p">)</span>
    <span class="ow">and</span> <span class="n">closure</span> <span class="p">:</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">ClosureRecFsharp</span> <span class="o">=</span>
        <span class="n">jp</span> <span class="p">(</span><span class="n">fun</span> <span class="p">((</span><span class="n">jp_body</span><span class="p">,</span><span class="n">key</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">C</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">fun_ty</span><span class="p">))),</span><span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">fun_ty</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">YFun</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span><span class="nb">range</span><span class="p">,</span><span class="n">FT_Vanilla</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="p">(</span><span class="n">fst</span> <span class="n">env</span><span class="o">.</span><span class="n">join_point_closure</span><span class="o">.</span><span class="p">[</span><span class="n">jp_body</span><span class="p">])</span><span class="o">.</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">Some</span><span class="p">(</span><span class="n">domain_args</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">tag</span><span class="o">=</span><span class="n">i</span><span class="p">;</span> <span class="n">free_vars</span><span class="o">=</span><span class="n">rdata_free_vars</span> <span class="n">args</span><span class="p">;</span> <span class="n">domain_args</span><span class="o">=</span><span class="n">data_free_vars</span> <span class="n">domain_args</span><span class="p">;</span> <span class="nb">range</span><span class="o">=</span><span class="nb">range</span><span class="p">;</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">}</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="s2">"Compiler error: The method dictionary is malformed"</span>
            <span class="o">|</span> <span class="n">YFun</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="s2">"Non-standard functions are not supported in the F# backend."</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="s2">"Compiler error: Unexpected type in the closure join point."</span>
            <span class="p">)</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">x</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">domain</span> <span class="o">=</span> 
                <span class="k">match</span> <span class="n">x</span><span class="o">.</span><span class="n">domain_args</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">t</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"v</span><span class="si">%i</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">"</span> <span class="n">i</span> <span class="p">(</span><span class="n">tyv</span> <span class="n">t</span><span class="p">))</span> <span class="k">with</span>
                <span class="o">|</span> <span class="p">[</span><span class="o">||</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="s2">"()"</span>
                <span class="o">|</span> <span class="p">[</span><span class="o">|</span><span class="n">x</span><span class="o">|</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"(</span><span class="si">%s</span><span class="s2">)"</span> <span class="n">x</span>
                <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">", "</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">sprintf</span> <span class="s2">"struct (</span><span class="si">%s</span><span class="s2">)"</span>
            <span class="n">line</span> <span class="n">s</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"closure</span><span class="si">%i</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">) </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2"> ="</span> <span class="n">x</span><span class="o">.</span><span class="n">tag</span> <span class="p">(</span><span class="n">args_tys</span> <span class="n">x</span><span class="o">.</span><span class="n">free_vars</span><span class="p">)</span> <span class="n">domain</span> <span class="p">(</span><span class="n">tup_ty</span> <span class="n">x</span><span class="o">.</span><span class="n">range</span><span class="p">))</span>
            <span class="n">binds</span> <span class="p">(</span><span class="n">indent</span> <span class="n">s</span><span class="p">)</span> <span class="n">x</span><span class="o">.</span><span class="n">body</span>
            <span class="p">)</span>

    <span class="n">let</span> <span class="n">main</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Text</span><span class="o">.</span><span class="n">StringBuilder</span><span class="p">()</span>
    <span class="n">binds</span> <span class="p">{</span><span class="n">text</span><span class="o">=</span><span class="n">main</span><span class="p">;</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">}</span> <span class="n">x</span>

    <span class="n">let</span> <span class="n">program</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Text</span><span class="o">.</span><span class="n">StringBuilder</span><span class="p">()</span>
    <span class="n">env</span><span class="o">.</span><span class="n">globals</span> <span class="o">|&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">string</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">program</span><span class="o">.</span><span class="n">AppendLine</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">ignore</span><span class="p">)</span>
    <span class="n">types</span> <span class="o">|&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">iteri</span> <span class="p">(</span><span class="n">fun</span> <span class="n">i</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">program</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="k">if</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">then</span> <span class="s2">"type "</span> <span class="k">else</span> <span class="s2">"and "</span><span class="p">)</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">ignore</span><span class="p">)</span>
    <span class="n">functions</span> <span class="o">|&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">iteri</span> <span class="p">(</span><span class="n">fun</span> <span class="n">i</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">program</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="k">if</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">then</span> <span class="s2">"let rec "</span> <span class="k">else</span> <span class="s2">"and "</span><span class="p">)</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">ignore</span><span class="p">)</span>
    <span class="n">program</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">.</span><span class="n">ToString</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=51">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="RefCounting">RefCounting<a class="anchor-link" href="#RefCounting"></a></h2>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=52">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="o">//</span> <span class="n">Here</span> <span class="n">are</span> <span class="n">the</span> <span class="n">reference</span> <span class="n">counting</span> <span class="n">analysis</span> <span class="n">passes</span><span class="o">.</span>
<span class="nb">open</span> <span class="n">System</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">Generic</span>

<span class="n">let</span> <span class="n">varc_add</span> <span class="n">x</span> <span class="n">i</span> <span class="n">v</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">c</span> <span class="o">=</span> <span class="n">Option</span><span class="o">.</span><span class="n">defaultValue</span> <span class="mi">0</span> <span class="p">(</span><span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">x</span> <span class="n">v</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span>
    <span class="k">if</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">then</span> <span class="n">Map</span><span class="o">.</span><span class="n">remove</span> <span class="n">x</span> <span class="n">v</span> <span class="k">else</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">x</span> <span class="n">c</span> <span class="n">v</span>
<span class="n">let</span> <span class="n">varc_union</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="n">varc_add</span> <span class="n">a</span> <span class="n">b</span>
<span class="n">let</span> <span class="n">varc_data</span> <span class="n">call_data</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">mutable</span> <span class="n">v</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">f</span> <span class="o">=</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">DPair</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span><span class="p">;</span> <span class="n">f</span> <span class="n">b</span>
        <span class="o">|</span> <span class="n">DForall</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">DFunction</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">iter</span> <span class="n">f</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">DRecord</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="p">)</span> <span class="n">l</span>
        <span class="o">|</span> <span class="n">DV</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">v</span> <span class="o">&lt;-</span> <span class="n">varc_add</span> <span class="n">x</span> <span class="mi">1</span> <span class="n">v</span>
        <span class="o">|</span> <span class="n">DExists</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">|</span> <span class="n">DUnion</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">DNominal</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">a</span>
        <span class="o">|</span> <span class="n">DLit</span> <span class="n">_</span> <span class="o">|</span> <span class="n">DTLit</span> <span class="n">_</span> <span class="o">|</span> <span class="n">DSymbol</span> <span class="n">_</span> <span class="o">|</span> <span class="n">DB</span> <span class="o">-&gt;</span> <span class="p">()</span>
        <span class="o">|</span> <span class="n">DHashSet</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">iter</span> <span class="n">f</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">DHashMap</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">kv</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">kv</span><span class="o">.</span><span class="n">Value</span><span class="p">)</span>
    <span class="n">f</span> <span class="n">call_data</span>
    <span class="n">v</span>
<span class="n">let</span> <span class="n">varc_set</span> <span class="n">x</span> <span class="n">i</span> <span class="o">=</span> <span class="n">Set</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">v</span> <span class="n">i</span> <span class="n">s</span><span class="p">)</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span> <span class="n">x</span>

<span class="n">let</span> <span class="n">refc_used_vars</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">TypedBind</span> <span class="p">[])</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">g_bind</span> <span class="p">:</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="n">TypedBind</span><span class="p">,</span> <span class="n">TyV</span> <span class="n">Set</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Reference</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">fv</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">data_free_vars</span> <span class="o">|&gt;</span> <span class="n">Set</span>
    <span class="n">let</span> <span class="n">jp</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">JoinPointCall</span><span class="p">)</span> <span class="o">=</span> <span class="n">snd</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">Set</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">binds</span> <span class="n">x</span> <span class="o">=</span>
        <span class="n">Array</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="n">k</span> <span class="n">vs</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">k</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">TyLet</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">o</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">vs</span> <span class="o">+</span> <span class="n">op</span> <span class="n">o</span> <span class="o">-</span> <span class="n">fv</span> <span class="n">d</span>
            <span class="o">|</span> <span class="n">TyLocalReturnOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">o</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">vs</span> <span class="o">+</span> <span class="n">op</span> <span class="n">o</span>
            <span class="o">|</span> <span class="n">TyLocalReturnData</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">vs</span> <span class="o">+</span> <span class="n">fv</span> <span class="n">d</span>
            <span class="o">|&gt;</span> <span class="n">fun</span> <span class="n">vs</span> <span class="o">-&gt;</span> <span class="n">g_bind</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">vs</span><span class="p">);</span> <span class="n">vs</span>
            <span class="p">)</span> <span class="n">x</span> <span class="n">Set</span><span class="o">.</span><span class="n">empty</span>
    <span class="ow">and</span> <span class="n">op</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">TypedOp</span><span class="p">)</span> <span class="p">:</span> <span class="n">TyV</span> <span class="n">Set</span> <span class="o">=</span>
        <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">TySizeOf</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="o">.</span><span class="n">empty</span>
        <span class="o">|</span> <span class="n">TyMacro</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">function</span> <span class="n">CMTerm</span> <span class="n">d</span> <span class="o">-&gt;</span> <span class="n">s</span> <span class="o">+</span> <span class="n">fv</span> <span class="n">d</span> <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="p">)</span> <span class="n">Set</span><span class="o">.</span><span class="n">empty</span> <span class="n">l</span>
        <span class="o">|</span> <span class="n">TyArrayLiteral</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">l</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">l</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">s</span> <span class="o">+</span> <span class="n">fv</span> <span class="n">x</span><span class="p">)</span> <span class="n">Set</span><span class="o">.</span><span class="n">empty</span> <span class="n">l</span>
        <span class="o">|</span> <span class="n">TyToLayout</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyUnionBox</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyFailwith</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyConv</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyArrayCreate</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyArrayLength</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyStringLength</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">fv</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">TyWhile</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span><span class="n">body</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jp</span> <span class="n">cond</span> <span class="o">+</span> <span class="n">binds</span> <span class="n">body</span>
        <span class="o">|</span> <span class="n">TyDo</span> <span class="n">body</span> <span class="o">|</span> <span class="n">TyIndent</span> <span class="n">body</span> <span class="o">-&gt;</span> <span class="n">binds</span> <span class="n">body</span>
        <span class="o">|</span> <span class="n">TyLayoutIndexAll</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyLayoutIndexByKey</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="o">.</span><span class="n">singleton</span> <span class="n">i</span>
        <span class="o">|</span> <span class="n">TyApply</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">d</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyLayoutMutableSet</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">d</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="o">.</span><span class="n">singleton</span> <span class="n">i</span> <span class="o">+</span> <span class="n">fv</span> <span class="n">d</span>
        <span class="o">|</span> <span class="n">TyJoinPoint</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">jp</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">TyBackend</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="o">.</span><span class="n">empty</span>
        <span class="o">|</span> <span class="n">TyIf</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span><span class="n">tr</span><span class="s1">',fl'</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">fv</span> <span class="n">cond</span> <span class="o">+</span> <span class="n">binds</span> <span class="n">tr</span><span class="s1">' + binds fl'</span>
        <span class="o">|</span> <span class="n">TyUnionUnbox</span><span class="p">(</span><span class="n">vs</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">on_succs</span><span class="s1">',on_fail'</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">vs</span> <span class="o">=</span> <span class="n">vs</span> <span class="o">|&gt;</span> <span class="n">Set</span>
            <span class="n">let</span> <span class="n">on_fail</span> <span class="o">=</span> 
                <span class="k">match</span> <span class="n">on_fail</span><span class="s1">' with</span>
                <span class="o">|</span> <span class="n">Some</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">binds</span> <span class="n">x</span>
                <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="o">.</span><span class="n">empty</span>
            <span class="n">Map</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">k</span> <span class="p">(</span><span class="n">lets</span><span class="p">,</span><span class="n">body</span><span class="p">)</span> <span class="o">-&gt;</span> 
                <span class="n">let</span> <span class="n">lets</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">s</span> <span class="o">+</span> <span class="n">fv</span> <span class="n">x</span><span class="p">)</span> <span class="n">Set</span><span class="o">.</span><span class="n">empty</span> <span class="n">lets</span>
                <span class="n">s</span> <span class="o">+</span> <span class="p">(</span><span class="n">binds</span> <span class="n">body</span> <span class="o">-</span> <span class="n">lets</span><span class="p">)</span>
                <span class="p">)</span> <span class="p">(</span><span class="n">vs</span> <span class="o">+</span> <span class="n">on_fail</span><span class="p">)</span> <span class="n">on_succs</span><span class="s1">'</span>
        <span class="o">|</span> <span class="n">TyIntSwitch</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="n">on_succs</span><span class="s1">',on_fail'</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">vs</span> <span class="o">=</span> <span class="n">Set</span><span class="o">.</span><span class="n">singleton</span> <span class="n">tag</span>
            <span class="n">let</span> <span class="n">on_fail</span> <span class="o">=</span> <span class="n">binds</span> <span class="n">on_fail</span><span class="s1">'</span>
            <span class="n">Array</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">body</span> <span class="o">-&gt;</span> <span class="n">s</span> <span class="o">+</span> <span class="n">binds</span> <span class="n">body</span><span class="p">)</span> <span class="p">(</span><span class="n">vs</span> <span class="o">+</span> <span class="n">on_fail</span><span class="p">)</span> <span class="n">on_succs</span><span class="s1">'</span>
    <span class="n">binds</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
    <span class="n">g_bind</span>

<span class="nb">type</span> <span class="n">RefcVars</span> <span class="o">=</span> <span class="p">{</span><span class="n">g_incr</span> <span class="p">:</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="n">TypedBind</span><span class="p">,</span><span class="n">TyV</span> <span class="n">Set</span><span class="o">&gt;</span><span class="p">;</span> <span class="n">g_decr</span> <span class="p">:</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="n">TypedBind</span><span class="p">,</span><span class="n">TyV</span> <span class="n">Set</span><span class="o">&gt;</span><span class="p">;</span> <span class="n">g_op</span> <span class="p">:</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="n">TypedBind</span><span class="p">,</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">TyV</span><span class="p">,</span> <span class="nb">int</span><span class="o">&gt;&gt;</span><span class="p">;</span> <span class="n">g_op_decr</span> <span class="p">:</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="n">TypedBind</span><span class="p">,</span><span class="n">TyV</span> <span class="n">Set</span><span class="o">&gt;</span><span class="p">}</span>

<span class="n">let</span> <span class="n">refc_prepass</span> <span class="p">(</span><span class="n">new_vars</span> <span class="p">:</span> <span class="n">TyV</span> <span class="n">Set</span><span class="p">)</span> <span class="p">(</span><span class="n">increfed_vars</span> <span class="p">:</span> <span class="n">TyV</span> <span class="n">Set</span><span class="p">)</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">TypedBind</span> <span class="p">[])</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">used_vars</span> <span class="o">=</span> <span class="n">refc_used_vars</span> <span class="n">x</span>
    <span class="n">let</span> <span class="n">g_incr</span> <span class="p">:</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="n">TypedBind</span><span class="p">,</span> <span class="n">TyV</span> <span class="n">Set</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Reference</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">g_decr</span> <span class="p">:</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="n">TypedBind</span><span class="p">,</span> <span class="n">TyV</span> <span class="n">Set</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Reference</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">g_op</span> <span class="p">:</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="n">TypedBind</span><span class="p">,</span> <span class="n">_</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Reference</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">g_op_decr</span> <span class="p">:</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="n">TypedBind</span><span class="p">,</span> <span class="n">TyV</span> <span class="n">Set</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Reference</span><span class="p">)</span>

    <span class="n">let</span> <span class="n">add</span> <span class="p">(</span><span class="n">d</span> <span class="p">:</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="n">TypedBind</span><span class="p">,</span> <span class="n">TyV</span> <span class="n">Set</span><span class="o">&gt;</span><span class="p">)</span> <span class="n">k</span> <span class="n">x</span> <span class="o">=</span> <span class="k">if</span> <span class="n">Set</span><span class="o">.</span><span class="n">isEmpty</span> <span class="n">x</span> <span class="n">then</span> <span class="p">()</span> <span class="k">else</span> <span class="n">d</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">add</span><span class="s1">' (d : Dictionary&lt;TypedBind, Map&lt;TyV,int&gt;&gt;) k x = if Map.isEmpty x then () else d.Add(k,x)</span>
    <span class="n">let</span> <span class="n">fv</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">data_free_vars</span> <span class="o">|&gt;</span> <span class="n">Set</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">binds</span> <span class="p">(</span><span class="n">new_vars</span> <span class="p">:</span> <span class="n">TyV</span> <span class="n">Set</span><span class="p">)</span> <span class="p">(</span><span class="n">increfed_vars</span> <span class="p">:</span> <span class="n">TyV</span> <span class="n">Set</span><span class="p">)</span> <span class="p">(</span><span class="n">k</span> <span class="p">:</span> <span class="n">TypedBind</span> <span class="p">[])</span> <span class="o">=</span>
        <span class="n">Array</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">new_vars</span><span class="p">,</span> <span class="n">increfed_vars</span><span class="p">)</span> <span class="n">k</span> <span class="o">-&gt;</span>
            <span class="n">add</span> <span class="n">g_incr</span> <span class="n">k</span> <span class="n">new_vars</span>
            <span class="n">let</span> <span class="n">increfed_vars</span> <span class="o">=</span> <span class="n">new_vars</span> <span class="o">+</span> <span class="n">increfed_vars</span>

            <span class="n">let</span> <span class="n">used_vars</span> <span class="o">=</span> <span class="n">used_vars</span><span class="o">.</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">let</span> <span class="n">decref_vars</span> <span class="o">=</span> <span class="n">increfed_vars</span> <span class="o">-</span> <span class="n">used_vars</span>
            <span class="n">add</span> <span class="n">g_decr</span> <span class="n">k</span> <span class="n">decref_vars</span>
            <span class="n">let</span> <span class="n">r</span> <span class="o">=</span> <span class="n">increfed_vars</span> <span class="o">-</span> <span class="n">decref_vars</span>
            <span class="k">match</span> <span class="n">k</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">TyLet</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">o</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">op</span> <span class="n">k</span> <span class="n">Set</span><span class="o">.</span><span class="n">empty</span> <span class="n">o</span>
                <span class="n">let</span> <span class="n">new_vars</span> <span class="o">=</span> <span class="n">fv</span> <span class="n">d</span>
                <span class="k">match</span> <span class="n">o</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">TyLayoutIndexAll</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyLayoutIndexByKey</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyOp</span><span class="p">(</span><span class="n">ArrayIndex</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">new_vars</span><span class="p">,</span> <span class="n">r</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="o">.</span><span class="n">empty</span><span class="p">,</span> <span class="n">r</span> <span class="o">+</span> <span class="n">new_vars</span>
            <span class="o">|</span> <span class="n">TyLocalReturnOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">o</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> 
                <span class="n">op</span> <span class="n">k</span> <span class="n">r</span> <span class="n">o</span>
                <span class="n">Set</span><span class="o">.</span><span class="n">empty</span><span class="p">,</span> <span class="n">r</span>
            <span class="o">|</span> <span class="n">TyLocalReturnData</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">add</span><span class="s1">' g_op k (varc_data d)</span>
                <span class="n">add</span> <span class="n">g_op_decr</span> <span class="n">k</span> <span class="n">r</span>
                <span class="n">Set</span><span class="o">.</span><span class="n">empty</span><span class="p">,</span> <span class="n">r</span>
            <span class="p">)</span> <span class="p">(</span><span class="n">new_vars</span><span class="p">,</span> <span class="n">increfed_vars</span><span class="p">)</span> <span class="n">k</span>
        <span class="o">|&gt;</span> <span class="n">ignore</span>
    <span class="ow">and</span> <span class="n">op</span> <span class="n">k</span> <span class="n">increfed_vars</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">TypedOp</span><span class="p">)</span> <span class="p">:</span> <span class="n">unit</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">fun_call</span> <span class="n">q</span> <span class="o">=</span> <span class="n">add</span><span class="s1">' g_op k q; add g_op_decr k increfed_vars</span>
        <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">TyApply</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">varc_add</span> <span class="n">a</span> <span class="mi">1</span> <span class="p">(</span><span class="n">varc_data</span> <span class="n">b</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">fun_call</span>
        <span class="o">|</span> <span class="n">TyJoinPoint</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">varc_add</span> <span class="n">x</span> <span class="mi">1</span> <span class="n">s</span><span class="p">)</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">fun_call</span>
        <span class="o">|</span> <span class="n">TyArrayLiteral</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">varc_union</span> <span class="n">s</span> <span class="p">(</span><span class="n">varc_data</span> <span class="n">x</span><span class="p">))</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">fun_call</span>
        <span class="o">|</span> <span class="n">TyUnionBox</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyToLayout</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">varc_data</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">fun_call</span>
        <span class="o">|</span> <span class="n">TySizeOf</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyLayoutIndexAll</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyLayoutIndexByKey</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyMacro</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyOp</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyFailwith</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyConv</span> <span class="n">_</span> 
        <span class="o">|</span> <span class="n">TyArrayCreate</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyArrayLength</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyStringLength</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyLayoutMutableSet</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyBackend</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="p">()</span>
        <span class="o">|</span> <span class="n">TyWhile</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">body</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">binds</span> <span class="n">Set</span><span class="o">.</span><span class="n">empty</span> <span class="n">Set</span><span class="o">.</span><span class="n">empty</span> <span class="n">body</span>
        <span class="o">|</span> <span class="n">TyDo</span> <span class="n">body</span> <span class="o">|</span> <span class="n">TyIndent</span> <span class="n">body</span> <span class="o">-&gt;</span> <span class="n">binds</span> <span class="n">Set</span><span class="o">.</span><span class="n">empty</span> <span class="n">Set</span><span class="o">.</span><span class="n">empty</span> <span class="n">body</span>
        <span class="o">|</span> <span class="n">TyIf</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">tr</span><span class="s1">',fl'</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">binds</span> <span class="n">Set</span><span class="o">.</span><span class="n">empty</span> <span class="n">increfed_vars</span> <span class="n">tr</span><span class="s1">'; binds Set.empty increfed_vars fl'</span>
        <span class="o">|</span> <span class="n">TyUnionUnbox</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">on_succs</span><span class="s1">',on_fail'</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">Map</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="p">(</span><span class="n">lets</span><span class="p">,</span><span class="n">body</span><span class="p">)</span> <span class="o">-&gt;</span> 
                <span class="n">binds</span> <span class="p">(</span><span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">s</span> <span class="o">+</span> <span class="n">fv</span> <span class="n">x</span><span class="p">)</span> <span class="n">Set</span><span class="o">.</span><span class="n">empty</span> <span class="n">lets</span><span class="p">)</span> <span class="n">increfed_vars</span> <span class="n">body</span>
                <span class="p">)</span> <span class="n">on_succs</span><span class="s1">'</span>
            <span class="n">Option</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">binds</span> <span class="n">Set</span><span class="o">.</span><span class="n">empty</span> <span class="n">increfed_vars</span><span class="p">)</span> <span class="n">on_fail</span><span class="s1">'</span>
        <span class="o">|</span> <span class="n">TyIntSwitch</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">on_succs</span><span class="s1">',on_fail'</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">Array</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">binds</span> <span class="n">Set</span><span class="o">.</span><span class="n">empty</span> <span class="n">increfed_vars</span><span class="p">)</span> <span class="n">on_succs</span><span class="s1">'</span>
            <span class="n">binds</span> <span class="n">Set</span><span class="o">.</span><span class="n">empty</span> <span class="n">increfed_vars</span> <span class="n">on_fail</span><span class="s1">'</span>
    <span class="n">binds</span> <span class="n">new_vars</span> <span class="n">increfed_vars</span> <span class="n">x</span>
    
    <span class="p">{</span><span class="n">g_incr</span><span class="o">=</span><span class="n">g_incr</span><span class="p">;</span> <span class="n">g_op</span><span class="o">=</span><span class="n">g_op</span><span class="p">;</span> <span class="n">g_decr</span><span class="o">=</span><span class="n">g_decr</span><span class="p">;</span> <span class="n">g_op_decr</span><span class="o">=</span><span class="n">g_op_decr</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=53">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="CodegenC">CodegenC<a class="anchor-link" href="#CodegenC"></a></h2>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=54">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">module</span> <span class="n">CodegenC</span> <span class="o">=</span>
    <span class="o">//</span> <span class="nb">open</span> <span class="n">System</span>
    <span class="o">//</span> <span class="nb">open</span> <span class="n">System</span><span class="o">.</span><span class="n">Text</span>
    <span class="nb">open</span> <span class="n">System</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">Generic</span>

    <span class="n">let</span> <span class="n">sizeof_tyvC</span> <span class="o">=</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">YPrim</span> <span class="p">(</span><span class="n">Int64T</span> <span class="o">|</span> <span class="n">UInt64T</span> <span class="o">|</span> <span class="n">Float64T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="mi">8</span>
        <span class="o">|</span> <span class="n">YPrim</span> <span class="p">(</span><span class="n">Int32T</span> <span class="o">|</span> <span class="n">UInt32T</span> <span class="o">|</span> <span class="n">Float32T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="mi">4</span>
        <span class="o">|</span> <span class="n">YPrim</span> <span class="p">(</span><span class="n">Int16T</span> <span class="o">|</span> <span class="n">UInt16T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="mi">2</span>
        <span class="o">|</span> <span class="n">YPrim</span> <span class="p">(</span><span class="n">Int8T</span> <span class="o">|</span> <span class="n">UInt8T</span> <span class="o">|</span> <span class="n">CharT</span> <span class="o">|</span> <span class="n">BoolT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="mi">1</span>
        <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="mi">8</span>
    <span class="n">let</span> <span class="n">order_argsC</span> <span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">sortWith</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">t</span><span class="p">))</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">t</span><span class="s1">')) -&gt; compare (sizeof_tyvC t'</span><span class="p">)</span> <span class="p">(</span><span class="n">sizeof_tyvC</span> <span class="n">t</span><span class="p">))</span>
    <span class="n">let</span> <span class="n">lineC</span> <span class="n">x</span> <span class="n">s</span> <span class="o">=</span> <span class="k">if</span> <span class="n">s</span> <span class="o">&lt;&gt;</span> <span class="s2">""</span> <span class="n">then</span> <span class="n">x</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="s1">' '</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">indent</span><span class="p">)</span><span class="o">.</span><span class="n">AppendLine</span> <span class="n">s</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
    <span class="n">let</span> <span class="n">line</span><span class="s1">' x s = line x (String.concat " " s)</span>

    <span class="n">let</span> <span class="n">rec</span> <span class="n">is_heap</span> <span class="n">f</span> <span class="n">x</span> <span class="o">=</span> 
        <span class="n">Array</span><span class="o">.</span><span class="n">exists</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">t</span><span class="p">))</span> <span class="o">-&gt;</span> 
            <span class="k">match</span> <span class="n">t</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">YUnion</span> <span class="n">a</span> <span class="n">when</span> <span class="n">a</span><span class="o">.</span><span class="n">Item</span><span class="o">.</span><span class="n">layout</span> <span class="o">=</span> <span class="n">UStack</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">exists</span> <span class="p">(</span><span class="n">snd</span> <span class="o">&gt;&gt;</span> <span class="n">f</span> <span class="o">&gt;&gt;</span> <span class="n">is_heap</span> <span class="n">f</span><span class="p">)</span> <span class="n">a</span><span class="o">.</span><span class="n">Item</span><span class="o">.</span><span class="n">tag_cases</span>
            <span class="o">|</span> <span class="n">YPrim</span> <span class="n">StringT</span> <span class="o">-&gt;</span> <span class="n">true</span>
            <span class="o">|</span> <span class="n">YPrim</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">false</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">true</span>
            <span class="p">)</span> <span class="n">x</span>
    <span class="n">let</span> <span class="n">is_stringC</span> <span class="o">=</span> <span class="n">function</span> <span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">YPrim</span> <span class="n">StringT</span><span class="p">))</span> <span class="o">|</span> <span class="n">DLit</span><span class="p">(</span><span class="n">LitString</span> <span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">true</span> <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">false</span>

    <span class="nb">type</span> <span class="n">BindsReturnC</span> <span class="o">=</span>
        <span class="o">|</span> <span class="n">BindsTailEnd</span>
        <span class="o">|</span> <span class="n">BindsLocal</span> <span class="n">of</span> <span class="n">TyV</span> <span class="p">[]</span>

    <span class="n">let</span> <span class="n">term_vars_to_tysC</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">function</span> <span class="n">WV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">t</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">t</span> <span class="o">|</span> <span class="n">WLit</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">YPrim</span> <span class="p">(</span><span class="n">lit_to_primitive_type</span> <span class="n">x</span><span class="p">))</span>
    <span class="n">let</span> <span class="n">binds_last_dataC</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">last</span> <span class="o">|&gt;</span> <span class="n">function</span> <span class="n">TyLocalReturnData</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyLocalReturnOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="o">|</span> <span class="n">TyLet</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="s2">"Compiler error: Cannot find the return data of the last bind."</span>

    <span class="nb">type</span> <span class="n">UnionRecC</span> <span class="o">=</span> <span class="p">{</span><span class="n">tag</span> <span class="p">:</span> <span class="nb">int</span><span class="p">;</span> <span class="n">free_vars</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="nb">int</span> <span class="o">*</span> <span class="n">string</span><span class="p">,</span> <span class="n">TyV</span><span class="p">[]</span><span class="o">&gt;</span><span class="p">}</span>
    <span class="nb">type</span> <span class="n">LayoutRecC</span> <span class="o">=</span> <span class="p">{</span><span class="n">tag</span> <span class="p">:</span> <span class="nb">int</span><span class="p">;</span> <span class="n">data</span> <span class="p">:</span> <span class="n">Data</span><span class="p">;</span> <span class="n">free_vars</span> <span class="p">:</span> <span class="n">TyV</span><span class="p">[];</span> <span class="n">free_vars_by_key</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="nb">int</span> <span class="o">*</span> <span class="n">string</span><span class="p">,</span> <span class="n">TyV</span><span class="p">[]</span><span class="o">&gt;</span><span class="p">}</span>
    <span class="nb">type</span> <span class="n">MethodRecC</span> <span class="o">=</span> <span class="p">{</span><span class="n">tag</span> <span class="p">:</span> <span class="nb">int</span><span class="p">;</span> <span class="n">free_vars</span> <span class="p">:</span> <span class="n">L</span><span class="o">&lt;</span><span class="n">Tag</span><span class="p">,</span><span class="n">Ty</span><span class="o">&gt;</span><span class="p">[];</span> <span class="nb">range</span> <span class="p">:</span> <span class="n">Ty</span><span class="p">;</span> <span class="n">body</span> <span class="p">:</span> <span class="n">TypedBind</span><span class="p">[];</span> <span class="n">name</span> <span class="p">:</span> <span class="n">string</span> <span class="n">option</span><span class="p">}</span>
    <span class="nb">type</span> <span class="n">ClosureRecC</span> <span class="o">=</span> <span class="p">{</span><span class="n">tag</span> <span class="p">:</span> <span class="nb">int</span><span class="p">;</span> <span class="n">free_vars</span> <span class="p">:</span> <span class="n">L</span><span class="o">&lt;</span><span class="n">Tag</span><span class="p">,</span><span class="n">Ty</span><span class="o">&gt;</span><span class="p">[];</span> <span class="n">domain</span> <span class="p">:</span> <span class="n">Ty</span><span class="p">;</span> <span class="n">domain_args</span> <span class="p">:</span> <span class="n">TyV</span><span class="p">[];</span> <span class="nb">range</span> <span class="p">:</span> <span class="n">Ty</span><span class="p">;</span> <span class="n">body</span> <span class="p">:</span> <span class="n">TypedBind</span><span class="p">[]}</span>
    <span class="nb">type</span> <span class="n">TupleRecC</span> <span class="o">=</span> <span class="p">{</span><span class="n">tag</span> <span class="p">:</span> <span class="nb">int</span><span class="p">;</span> <span class="n">tys</span> <span class="p">:</span> <span class="n">Ty</span> <span class="p">[]}</span>
    <span class="nb">type</span> <span class="n">ArrayRecC</span> <span class="o">=</span> <span class="p">{</span><span class="n">tag</span> <span class="p">:</span> <span class="nb">int</span><span class="p">;</span> <span class="n">ty</span> <span class="p">:</span> <span class="n">Ty</span><span class="p">;</span> <span class="n">tyvs</span> <span class="p">:</span> <span class="n">TyV</span><span class="p">[]}</span>
    <span class="nb">type</span> <span class="n">CFunRecC</span> <span class="o">=</span> <span class="p">{</span><span class="n">tag</span> <span class="p">:</span> <span class="nb">int</span><span class="p">;</span> <span class="n">domain_args_ty</span> <span class="p">:</span> <span class="n">Ty</span><span class="p">[];</span> <span class="nb">range</span> <span class="p">:</span> <span class="n">Ty</span><span class="p">}</span>

    <span class="n">let</span> <span class="n">size_t</span> <span class="o">=</span> <span class="n">UInt32T</span>

    <span class="n">let</span> <span class="n">lit_stringC</span> <span class="n">x</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">strb</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Text</span><span class="o">.</span><span class="n">StringBuilder</span><span class="p">(</span><span class="n">String</span><span class="o">.</span><span class="n">length</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">strb</span><span class="o">.</span><span class="n">Append</span> <span class="s1">'"'</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
        <span class="n">String</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">function</span>
            <span class="o">|</span> <span class="s1">'"'</span> <span class="o">-&gt;</span> <span class="n">strb</span><span class="o">.</span><span class="n">Append</span> <span class="s2">"</span><span class="se">\\\"</span><span class="s2">"</span> 
            <span class="o">|</span> <span class="s1">'</span><span class="se">\b</span><span class="s1">'</span> <span class="o">-&gt;</span> <span class="n">strb</span><span class="o">.</span><span class="n">Append</span> <span class="o">@</span><span class="s2">"</span><span class="se">\b</span><span class="s2">"</span>
            <span class="o">|</span> <span class="s1">'</span><span class="se">\t</span><span class="s1">'</span> <span class="o">-&gt;</span> <span class="n">strb</span><span class="o">.</span><span class="n">Append</span> <span class="o">@</span><span class="s2">"</span><span class="se">\t</span><span class="s2">"</span>
            <span class="o">|</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">'</span> <span class="o">-&gt;</span> <span class="n">strb</span><span class="o">.</span><span class="n">Append</span> <span class="o">@</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
            <span class="o">|</span> <span class="s1">'</span><span class="se">\r</span><span class="s1">'</span> <span class="o">-&gt;</span> <span class="n">strb</span><span class="o">.</span><span class="n">Append</span> <span class="o">@</span><span class="s2">"</span><span class="se">\r</span><span class="s2">"</span>
            <span class="o">|</span> <span class="s1">'</span><span class="se">\\</span><span class="s1">'</span> <span class="o">-&gt;</span> <span class="n">strb</span><span class="o">.</span><span class="n">Append</span> <span class="o">@</span><span class="s2">"</span><span class="se">\\</span><span class="s2">"</span>
            <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">strb</span><span class="o">.</span><span class="n">Append</span> <span class="n">x</span>
            <span class="o">&gt;&gt;</span> <span class="n">ignore</span> 
            <span class="p">)</span> <span class="n">x</span>
        <span class="n">strb</span><span class="o">.</span><span class="n">Append</span> <span class="s1">'"'</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
        <span class="n">strb</span><span class="o">.</span><span class="n">ToString</span><span class="p">()</span>

    <span class="n">let</span> <span class="n">codegenC</span> <span class="p">(</span><span class="n">env</span> <span class="p">:</span> <span class="n">PartEvalResult</span><span class="p">)</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">TypedBind</span> <span class="p">[])</span> <span class="o">=</span>
        <span class="n">let</span> <span class="nb">globals</span> <span class="o">=</span> <span class="n">ResizeArray</span><span class="p">()</span>
        <span class="n">let</span> <span class="n">fwd_dcls</span> <span class="o">=</span> <span class="n">ResizeArray</span><span class="p">()</span>
        <span class="n">let</span> <span class="n">types</span> <span class="o">=</span> <span class="n">ResizeArray</span><span class="p">()</span>
        <span class="n">let</span> <span class="n">functions</span> <span class="o">=</span> <span class="n">ResizeArray</span><span class="p">()</span>

        <span class="n">let</span> <span class="n">malloc</span><span class="p">,</span> <span class="n">free</span> <span class="o">=</span> <span class="s2">"malloc"</span><span class="p">,</span> <span class="s2">"free"</span>

        <span class="n">let</span> <span class="n">print_decref</span> <span class="n">s_fun</span> <span class="n">name_fun</span> <span class="n">type_arg</span> <span class="n">name_decref</span> <span class="o">=</span>
            <span class="n">line</span> <span class="n">s_fun</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"void </span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2"> * x){"</span> <span class="n">name_fun</span> <span class="n">type_arg</span><span class="p">)</span>
            <span class="n">let</span> <span class="n">_</span> <span class="o">=</span>
                <span class="n">let</span> <span class="n">s_fun</span> <span class="o">=</span> <span class="n">indent</span> <span class="n">s_fun</span>
                <span class="n">line</span> <span class="n">s_fun</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"if (x != NULL &amp;&amp; --(x-&gt;refc) == 0) { </span><span class="si">%s</span><span class="s2">(x); </span><span class="si">%s</span><span class="s2">(x); }"</span> <span class="n">name_decref</span> <span class="n">free</span><span class="p">)</span>
            <span class="n">line</span> <span class="n">s_fun</span> <span class="s2">"}"</span>

        <span class="n">let</span> <span class="nb">print</span> <span class="n">show</span> <span class="n">r</span> <span class="o">=</span>
            <span class="n">let</span> <span class="n">s_typ_fwd</span> <span class="o">=</span> <span class="p">{</span><span class="n">text</span><span class="o">=</span><span class="n">System</span><span class="o">.</span><span class="n">Text</span><span class="o">.</span><span class="n">StringBuilder</span><span class="p">();</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">}</span>
            <span class="n">let</span> <span class="n">s_typ</span> <span class="o">=</span> <span class="p">{</span><span class="n">text</span><span class="o">=</span><span class="n">System</span><span class="o">.</span><span class="n">Text</span><span class="o">.</span><span class="n">StringBuilder</span><span class="p">();</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">}</span>
            <span class="n">let</span> <span class="n">s_fun</span> <span class="o">=</span> <span class="p">{</span><span class="n">text</span><span class="o">=</span><span class="n">System</span><span class="o">.</span><span class="n">Text</span><span class="o">.</span><span class="n">StringBuilder</span><span class="p">();</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">}</span>
            <span class="n">show</span> <span class="n">s_typ_fwd</span> <span class="n">s_typ</span> <span class="n">s_fun</span> <span class="n">r</span>
            <span class="n">let</span> <span class="n">f</span> <span class="p">(</span><span class="n">a</span> <span class="p">:</span> <span class="n">_</span> <span class="n">ResizeArray</span><span class="p">)</span> <span class="p">(</span><span class="n">b</span> <span class="p">:</span> <span class="n">CodegenEnv</span><span class="p">)</span> <span class="o">=</span> 
                <span class="n">let</span> <span class="n">text</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">ToString</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">text</span> <span class="o">&lt;&gt;</span> <span class="s2">""</span> <span class="n">then</span> <span class="n">a</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="n">f</span> <span class="n">fwd_dcls</span> <span class="n">s_typ_fwd</span>
            <span class="n">f</span> <span class="n">types</span> <span class="n">s_typ</span>
            <span class="n">f</span> <span class="n">functions</span> <span class="n">s_fun</span>

        <span class="n">let</span> <span class="n">layout</span> <span class="n">show</span> <span class="o">=</span>
            <span class="n">let</span> <span class="nb">dict</span><span class="s1">' = Dictionary(HashIdentity.Structural)</span>
            <span class="n">let</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Reference</span><span class="p">)</span>
            <span class="n">let</span> <span class="n">f</span> <span class="n">x</span> <span class="p">:</span> <span class="n">LayoutRecC</span> <span class="o">=</span> 
                <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">YLayout</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span>
                    <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">ty_to_data</span> <span class="n">x</span>
                    <span class="n">let</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span>
                        <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
                        <span class="o">|</span> <span class="n">DRecord</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">data_free_vars</span><span class="p">)</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">toArray</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">collect</span> <span class="n">snd</span><span class="p">,</span> <span class="n">a</span>
                        <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">data_free_vars</span> <span class="n">x</span><span class="p">,</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
                    <span class="p">{</span><span class="n">data</span><span class="o">=</span><span class="n">x</span><span class="p">;</span> <span class="n">free_vars</span><span class="o">=</span><span class="n">a</span><span class="p">;</span> <span class="n">free_vars_by_key</span><span class="o">=</span><span class="n">b</span><span class="p">;</span> <span class="n">tag</span><span class="o">=</span><span class="nb">dict</span><span class="s1">'.Count}</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="err">$</span><span class="s2">"Compiler error: Expected a layout type (7).</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">{show_ty x}"</span>
            <span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">mutable</span> <span class="n">dirty</span> <span class="o">=</span> <span class="n">false</span>
                <span class="n">let</span> <span class="n">r</span> <span class="o">=</span> <span class="n">memoize</span> <span class="nb">dict</span> <span class="p">(</span><span class="n">memoize</span> <span class="nb">dict</span><span class="s1">' (fun x -&gt; dirty &lt;- true; f x)) x</span>
                <span class="k">if</span> <span class="n">dirty</span> <span class="n">then</span> <span class="nb">print</span> <span class="n">show</span> <span class="n">r</span>
                <span class="n">r</span>

        <span class="n">let</span> <span class="n">union</span> <span class="n">show</span> <span class="o">=</span>
            <span class="n">let</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Reference</span><span class="p">)</span>
            <span class="n">let</span> <span class="n">f</span> <span class="p">(</span><span class="n">a</span> <span class="p">:</span> <span class="n">Union</span><span class="p">)</span> <span class="p">:</span> <span class="n">UnionRecC</span> <span class="o">=</span> 
                <span class="n">let</span> <span class="n">free_vars</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">Item</span><span class="o">.</span><span class="n">cases</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">env</span><span class="o">.</span><span class="n">ty_to_data</span> <span class="o">&gt;&gt;</span> <span class="n">data_free_vars</span><span class="p">)</span>
                <span class="p">{</span><span class="n">free_vars</span><span class="o">=</span><span class="n">free_vars</span><span class="p">;</span> <span class="n">tag</span><span class="o">=</span><span class="nb">dict</span><span class="o">.</span><span class="n">Count</span><span class="p">}</span>
            <span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">mutable</span> <span class="n">dirty</span> <span class="o">=</span> <span class="n">false</span>
                <span class="n">let</span> <span class="n">r</span> <span class="o">=</span> <span class="n">memoize</span> <span class="nb">dict</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">dirty</span> <span class="o">&lt;-</span> <span class="n">true</span><span class="p">;</span> <span class="n">f</span> <span class="n">x</span><span class="p">)</span> <span class="n">x</span>
                <span class="k">if</span> <span class="n">dirty</span> <span class="n">then</span> <span class="nb">print</span> <span class="n">show</span> <span class="n">r</span>
                <span class="n">r</span>

        <span class="n">let</span> <span class="n">jp</span> <span class="n">f</span> <span class="n">show</span> <span class="o">=</span>
            <span class="n">let</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Structural</span><span class="p">)</span>
            <span class="n">let</span> <span class="n">f</span> <span class="n">x</span> <span class="o">=</span> <span class="n">f</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="o">.</span><span class="n">Count</span><span class="p">)</span>
            <span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">mutable</span> <span class="n">dirty</span> <span class="o">=</span> <span class="n">false</span>
                <span class="n">let</span> <span class="n">r</span> <span class="o">=</span> <span class="n">memoize</span> <span class="nb">dict</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">dirty</span> <span class="o">&lt;-</span> <span class="n">true</span><span class="p">;</span> <span class="n">f</span> <span class="n">x</span><span class="p">)</span> <span class="n">x</span>
                <span class="k">if</span> <span class="n">dirty</span> <span class="n">then</span> <span class="nb">print</span> <span class="n">show</span> <span class="n">r</span>
                <span class="n">r</span>

        <span class="n">let</span> <span class="nb">tuple</span> <span class="n">show</span> <span class="o">=</span>
            <span class="n">let</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Structural</span><span class="p">)</span>
            <span class="n">let</span> <span class="n">f</span> <span class="n">x</span> <span class="o">=</span> <span class="p">{</span><span class="n">tag</span><span class="o">=</span><span class="nb">dict</span><span class="o">.</span><span class="n">Count</span><span class="p">;</span> <span class="n">tys</span><span class="o">=</span><span class="n">x</span><span class="p">}</span>
            <span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">mutable</span> <span class="n">dirty</span> <span class="o">=</span> <span class="n">false</span>
                <span class="n">let</span> <span class="n">r</span> <span class="o">=</span> <span class="n">memoize</span> <span class="nb">dict</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">dirty</span> <span class="o">&lt;-</span> <span class="n">true</span><span class="p">;</span> <span class="n">f</span> <span class="n">x</span><span class="p">)</span> <span class="n">x</span>
                <span class="k">if</span> <span class="n">dirty</span> <span class="n">then</span> <span class="nb">print</span> <span class="n">show</span> <span class="n">r</span>
                <span class="n">r</span>

        <span class="n">let</span> <span class="n">carray</span><span class="s1">' show =</span>
            <span class="n">let</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Structural</span><span class="p">)</span>
            <span class="n">let</span> <span class="n">f</span> <span class="n">x</span> <span class="o">=</span> <span class="p">{</span><span class="n">tag</span><span class="o">=</span><span class="nb">dict</span><span class="o">.</span><span class="n">Count</span><span class="p">;</span> <span class="n">ty</span><span class="o">=</span><span class="n">x</span><span class="p">;</span> <span class="n">tyvs</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">ty_to_data</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">data_free_vars</span><span class="p">}</span>
            <span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">mutable</span> <span class="n">dirty</span> <span class="o">=</span> <span class="n">false</span>
                <span class="n">let</span> <span class="n">r</span> <span class="o">=</span> <span class="n">memoize</span> <span class="nb">dict</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">dirty</span> <span class="o">&lt;-</span> <span class="n">true</span><span class="p">;</span> <span class="n">f</span> <span class="n">x</span><span class="p">)</span> <span class="n">x</span>
                <span class="k">if</span> <span class="n">dirty</span> <span class="n">then</span> <span class="nb">print</span> <span class="n">show</span> <span class="n">r</span>
                <span class="n">r</span>

        <span class="n">let</span> <span class="n">cstring</span><span class="s1">' show =</span>
            <span class="n">let</span> <span class="n">mutable</span> <span class="n">dirty</span> <span class="o">=</span> <span class="n">true</span>
            <span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span>
                <span class="k">if</span> <span class="n">dirty</span> <span class="n">then</span> <span class="nb">print</span> <span class="n">show</span> <span class="p">()</span>
                <span class="n">dirty</span> <span class="o">&lt;-</span> <span class="n">false</span>

        <span class="n">let</span> <span class="n">cfun</span><span class="s1">' show =</span>
            <span class="n">let</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Structural</span><span class="p">)</span>
            <span class="n">let</span> <span class="n">f</span> <span class="p">(</span><span class="n">a</span> <span class="p">:</span> <span class="n">Ty</span><span class="p">,</span> <span class="n">b</span> <span class="p">:</span> <span class="n">Ty</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="n">tag</span><span class="o">=</span><span class="nb">dict</span><span class="o">.</span><span class="n">Count</span><span class="p">;</span> <span class="n">domain_args_ty</span><span class="o">=</span><span class="n">a</span> <span class="o">|&gt;</span> <span class="n">env</span><span class="o">.</span><span class="n">ty_to_data</span> <span class="o">|&gt;</span> <span class="n">data_free_vars</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">t</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="p">);</span> <span class="nb">range</span><span class="o">=</span><span class="n">b</span><span class="p">}</span>
            <span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">mutable</span> <span class="n">dirty</span> <span class="o">=</span> <span class="n">false</span>
                <span class="n">let</span> <span class="n">r</span> <span class="o">=</span> <span class="n">memoize</span> <span class="nb">dict</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">dirty</span> <span class="o">&lt;-</span> <span class="n">true</span><span class="p">;</span> <span class="n">f</span> <span class="n">x</span><span class="p">)</span> <span class="n">x</span>
                <span class="k">if</span> <span class="n">dirty</span> <span class="n">then</span> <span class="nb">print</span> <span class="n">show</span> <span class="n">r</span>
                <span class="n">r</span>

        <span class="n">let</span> <span class="n">args</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">_</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"v</span><span class="si">%i</span><span class="s2">"</span> <span class="n">i</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">", "</span>

        <span class="n">let</span> <span class="n">tmp</span> <span class="o">=</span>
            <span class="n">let</span> <span class="n">mutable</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="n">u</span>
            <span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">i</span> <span class="o">&lt;-</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="n">u</span><span class="p">;</span> <span class="n">x</span>

        <span class="n">let</span> <span class="k">global</span><span class="s1">' =</span>
            <span class="n">let</span> <span class="n">has_added</span> <span class="o">=</span> <span class="n">HashSet</span><span class="p">()</span>
            <span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">has_added</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="n">then</span> <span class="nb">globals</span><span class="o">.</span><span class="n">Add</span> <span class="n">x</span>

        <span class="n">let</span> <span class="kn">import</span> <span class="nn">x</span> <span class="o">=</span> <span class="k">global</span><span class="s1">' $"#include &lt;</span><span class="si">{x}</span><span class="s1">&gt;"</span>
        <span class="n">let</span> <span class="n">import</span><span class="s1">' x = global'</span> <span class="err">$</span><span class="s2">"#include </span><span class="se">\"</span><span class="si">{x}</span><span class="se">\"</span><span class="s2">"</span>

        <span class="n">let</span> <span class="n">tyvs_to_tys</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">TyV</span> <span class="p">[])</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">t</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="p">)</span> <span class="n">x</span>
        
        <span class="n">let</span> <span class="n">rec</span> <span class="n">binds_start</span> <span class="p">(</span><span class="n">args</span> <span class="p">:</span> <span class="n">TyV</span> <span class="p">[])</span> <span class="p">(</span><span class="n">s</span> <span class="p">:</span> <span class="n">CodegenEnv</span><span class="p">)</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">TypedBind</span> <span class="p">[])</span> <span class="o">=</span> <span class="n">binds</span> <span class="p">(</span><span class="n">refc_prepass</span> <span class="n">Set</span><span class="o">.</span><span class="n">empty</span> <span class="p">(</span><span class="n">Set</span> <span class="n">args</span><span class="p">)</span> <span class="n">x</span><span class="p">)</span> <span class="n">s</span> <span class="n">BindsTailEnd</span> <span class="n">x</span>
        <span class="ow">and</span> <span class="n">return_local</span> <span class="n">s</span> <span class="n">ret</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">string</span><span class="p">)</span> <span class="o">=</span> 
            <span class="k">match</span> <span class="n">ret</span> <span class="k">with</span>
            <span class="o">|</span> <span class="p">[</span><span class="o">||</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">line</span> <span class="n">s</span> <span class="err">$</span><span class="s2">"</span><span class="si">{x}</span><span class="s2">;"</span>
            <span class="o">|</span> <span class="p">[</span><span class="o">|</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">_</span><span class="p">)</span><span class="o">|</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">line</span> <span class="n">s</span> <span class="err">$</span><span class="s2">"v</span><span class="si">{i}</span><span class="s2"> = </span><span class="si">{x}</span><span class="s2">;"</span>
            <span class="o">|</span> <span class="n">ret</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">tmp_i</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">()</span>
                <span class="n">line</span> <span class="n">s</span> <span class="err">$</span><span class="s2">"{tup_ty_tyvs ret} tmp</span><span class="si">{tmp_i}</span><span class="s2"> = </span><span class="si">{x}</span><span class="s2">;"</span>
                <span class="n">Array</span><span class="o">.</span><span class="n">mapi</span> <span class="p">(</span><span class="n">fun</span> <span class="n">i</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="s1">',_)) -&gt; $"v{i'</span><span class="p">}</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">{</span><span class="n">tmp_i</span><span class="p">}</span><span class="o">.</span><span class="n">v</span><span class="p">{</span><span class="n">i</span><span class="p">};</span><span class="s2">") ret |&gt; line' s</span>
        <span class="ow">and</span> <span class="n">binds</span> <span class="p">(</span><span class="nb">vars</span> <span class="p">:</span> <span class="n">RefcVars</span><span class="p">)</span> <span class="p">(</span><span class="n">s</span> <span class="p">:</span> <span class="n">CodegenEnv</span><span class="p">)</span> <span class="p">(</span><span class="n">ret</span> <span class="p">:</span> <span class="n">BindsReturnC</span><span class="p">)</span> <span class="p">(</span><span class="n">stmts</span> <span class="p">:</span> <span class="n">TypedBind</span> <span class="p">[])</span> <span class="o">=</span> 
            <span class="n">let</span> <span class="n">tup_destruct</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">=</span>
                <span class="n">Array</span><span class="o">.</span><span class="n">map2</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">_</span><span class="p">))</span> <span class="n">b</span> <span class="o">-&gt;</span> 
                    <span class="k">match</span> <span class="n">b</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">WLit</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"v</span><span class="si">{i}</span><span class="s2"> = {lit b};"</span>
                    <span class="o">|</span> <span class="n">WV</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="s1">',_)) -&gt; $"v</span><span class="si">{i}</span><span class="s1"> = v{i'</span><span class="p">};</span><span class="s2">"</span>
                    <span class="p">)</span> <span class="n">a</span> <span class="n">b</span>
            <span class="n">Array</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span>
                <span class="o">//</span> <span class="n">This</span> <span class="n">complicated</span> <span class="n">looking</span> <span class="n">piece</span> <span class="n">of</span> <span class="n">code</span> <span class="ow">is</span> <span class="n">responsible</span> <span class="k">for</span> <span class="n">putting</span> <span class="n">the</span> <span class="n">incref</span> <span class="ow">and</span> <span class="n">decref</span> <span class="n">statements</span> <span class="n">at</span> <span class="n">the</span> <span class="n">beginning</span> <span class="n">of</span> <span class="n">every</span>
                <span class="o">//</span> <span class="n">statement</span><span class="o">.</span> <span class="n">It</span><span class="s1">'s actually the only place where ref counting code is outputted in the codegen.</span>
                <span class="n">let</span> <span class="n">_</span> <span class="o">=</span>
                    <span class="n">let</span> <span class="n">f</span> <span class="n">k</span> <span class="o">=</span> <span class="n">get_default</span> <span class="n">k</span> <span class="n">x</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="o">.</span><span class="n">empty</span><span class="p">)</span>
                    <span class="n">let</span> <span class="sa">f</span><span class="s1">' k = get_default k x (fun () -&gt; Map.empty)</span>
                    <span class="n">let</span> <span class="n">incr</span><span class="p">,</span> <span class="n">decr</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">op_decr</span> <span class="o">=</span> <span class="n">varc_set</span> <span class="p">(</span><span class="n">f</span> <span class="nb">vars</span><span class="o">.</span><span class="n">g_incr</span><span class="p">)</span> <span class="mi">1</span><span class="p">,</span> <span class="n">varc_set</span> <span class="p">(</span><span class="n">f</span> <span class="nb">vars</span><span class="o">.</span><span class="n">g_decr</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s1">' vars.g_op, varc_set (f vars.g_op_decr) -1</span>
                    <span class="n">let</span> <span class="n">incr</span><span class="p">,</span> <span class="n">decr</span> <span class="o">=</span> <span class="n">varc_union</span> <span class="n">incr</span> <span class="n">decr</span> <span class="o">|&gt;</span> <span class="n">varc_union</span> <span class="n">op</span> <span class="o">|&gt;</span> <span class="n">varc_union</span> <span class="n">op_decr</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">partition</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">v</span><span class="p">)</span>
                    <span class="n">refc_varc</span> <span class="n">incr</span> <span class="o">|&gt;</span> <span class="n">line</span><span class="s1">' s; refc_varc decr |&gt; line'</span> <span class="n">s</span>
                <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">TyLet</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">trace</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span>
                    <span class="k">try</span> <span class="n">let</span> <span class="n">d</span> <span class="o">=</span> <span class="n">data_free_vars</span> <span class="n">d</span>
                        <span class="n">let</span> <span class="n">decl_vars</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">t</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"{tyv t} v</span><span class="si">{i}</span><span class="s2">;"</span><span class="p">)</span> <span class="n">d</span>
                        <span class="k">match</span> <span class="n">a</span> <span class="k">with</span>
                        <span class="o">|</span> <span class="n">TyMacro</span> <span class="n">a</span> <span class="o">-&gt;</span>
                            <span class="n">let</span> <span class="n">m</span> <span class="o">=</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">function</span> <span class="n">CMText</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="o">|</span> <span class="n">CMTerm</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">tup_data</span> <span class="n">x</span> <span class="o">|</span> <span class="n">CMType</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">tup_ty</span> <span class="n">x</span> <span class="o">|</span> <span class="n">CMTypeLit</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">type_lit</span> <span class="n">x</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">""</span>
                            <span class="n">let</span> <span class="n">q</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">Split</span><span class="p">(</span><span class="s2">"</span><span class="se">\\</span><span class="s2">v"</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">q</span><span class="o">.</span><span class="n">Length</span> <span class="o">=</span> <span class="mi">1</span> <span class="n">then</span> 
                                <span class="n">decl_vars</span> <span class="o">|&gt;</span> <span class="n">line</span><span class="s1">' s</span>
                                <span class="n">return_local</span> <span class="n">s</span> <span class="n">d</span> <span class="n">m</span> 
                            <span class="k">else</span>
                                <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">Length</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">Length</span><span class="o">-</span><span class="mi">1</span> <span class="n">then</span>
                                    <span class="n">let</span> <span class="n">w</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Text</span><span class="o">.</span><span class="n">StringBuilder</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Length</span><span class="o">+</span><span class="mi">8</span><span class="p">)</span>
                                    <span class="n">let</span> <span class="n">tag</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">_</span><span class="p">))</span> <span class="o">=</span> <span class="n">i</span> <span class="p">:</span> <span class="nb">int</span>
                                    <span class="n">Array</span><span class="o">.</span><span class="n">iteri</span> <span class="p">(</span><span class="n">fun</span> <span class="n">i</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">w</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="s1">'v'</span><span class="p">)</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="n">tag</span> <span class="n">v</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">ignore</span><span class="p">)</span> <span class="n">d</span>
                                    <span class="n">w</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">Length</span><span class="p">])</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="s1">';'</span><span class="p">)</span><span class="o">.</span><span class="n">ToString</span><span class="p">()</span> <span class="o">|&gt;</span> <span class="n">line</span> <span class="n">s</span>
                                <span class="k">else</span>
                                    <span class="n">raise_codegen_error</span> <span class="s2">"The special </span><span class="se">\\</span><span class="s2">v macro requires the same number of free vars in its binding as there are </span><span class="se">\\</span><span class="s2">v in the code."</span>
                        <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span>
                            <span class="n">decl_vars</span> <span class="o">|&gt;</span> <span class="n">line</span><span class="s1">' s</span>
                            <span class="n">op</span> <span class="nb">vars</span> <span class="n">s</span> <span class="p">(</span><span class="n">BindsLocal</span> <span class="n">d</span><span class="p">)</span> <span class="n">a</span>
                    <span class="k">with</span> <span class="p">:</span><span class="err">?</span> <span class="n">CodegenError</span> <span class="k">as</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span><span class="s1">' trace (e.Data0, e.Data1)</span>
                <span class="o">|</span> <span class="n">TyLocalReturnOp</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span>
                    <span class="k">try</span> <span class="n">op</span> <span class="nb">vars</span> <span class="n">s</span> <span class="n">ret</span> <span class="n">a</span>
                    <span class="k">with</span> <span class="p">:</span><span class="err">?</span> <span class="n">CodegenError</span> <span class="k">as</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span><span class="s1">' trace (e.Data0, e.Data1)</span>
                <span class="o">|</span> <span class="n">TyLocalReturnData</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">trace</span><span class="p">)</span> <span class="o">-&gt;</span>
                    <span class="k">try</span> <span class="n">match</span> <span class="n">ret</span> <span class="k">with</span>
                        <span class="o">|</span> <span class="n">BindsLocal</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">line</span><span class="s1">' s (tup_destruct (l,data_term_vars d))</span>
                        <span class="o">|</span> <span class="n">BindsTailEnd</span> <span class="o">-&gt;</span> <span class="n">line</span> <span class="n">s</span> <span class="err">$</span><span class="s2">"return {tup_data d};"</span>
                    <span class="k">with</span> <span class="p">:</span><span class="err">?</span> <span class="n">CodegenError</span> <span class="k">as</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span><span class="s1">' trace (e.Data0, e.Data1)</span>
                <span class="p">)</span> <span class="n">stmts</span>
        <span class="ow">and</span> <span class="n">refc_change</span><span class="s1">''</span> <span class="p">(</span><span class="n">f</span> <span class="p">:</span> <span class="nb">int</span> <span class="o">*</span> <span class="n">Ty</span> <span class="o">-&gt;</span> <span class="n">string</span><span class="p">)</span> <span class="n">count</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">t</span><span class="s1">')) =</span>
            <span class="n">let</span> <span class="n">v</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span><span class="n">t</span><span class="s1">'</span>
            <span class="n">let</span> <span class="n">inline</span> <span class="n">g</span> <span class="n">decref</span> <span class="o">=</span>
                <span class="k">if</span> <span class="n">count</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="n">then</span> <span class="n">Some</span> <span class="p">(</span><span class="n">decref</span><span class="p">())</span>
                <span class="k">elif</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span> <span class="n">then</span> <span class="n">Some</span> <span class="err">$</span><span class="s2">"{f v}-&gt;refc++;"</span>
                <span class="k">elif</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">count</span> <span class="n">then</span> <span class="n">Some</span> <span class="err">$</span><span class="s2">"{f v}-&gt;refc += </span><span class="si">{count}</span><span class="s2">;"</span>
                <span class="k">else</span> <span class="n">raise_codegen_error</span> <span class="err">$</span><span class="s2">"Compiler error: Invalid count in refc_change''. Got: </span><span class="si">{count}</span><span class="s2">"</span>
            <span class="k">match</span> <span class="n">t</span><span class="s1">' with</span>
            <span class="o">|</span> <span class="n">YUnion</span> <span class="n">t</span> <span class="o">-&gt;</span> 
                <span class="k">match</span> <span class="n">t</span><span class="o">.</span><span class="n">Item</span><span class="o">.</span><span class="n">layout</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">UStack</span> <span class="o">-&gt;</span> 
                    <span class="k">if</span> <span class="n">count</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="n">then</span> <span class="n">Some</span> <span class="err">$</span><span class="s2">"USDecref{(ustack t).tag}(&amp;({f v}));"</span>
                    <span class="k">elif</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">count</span> <span class="n">then</span> <span class="n">Some</span> <span class="p">(</span><span class="n">String</span><span class="o">.</span><span class="n">replicate</span> <span class="n">count</span> <span class="err">$</span><span class="s2">"USIncref{(ustack t).tag}(&amp;({f v}));"</span><span class="p">)</span>
                    <span class="k">else</span> <span class="n">raise_codegen_error</span> <span class="err">$</span><span class="s2">"Compiler error: Invalid count in refc_change''. UStack case. Got: </span><span class="si">{count}</span><span class="s2">"</span>
                <span class="o">|</span> <span class="n">UHeap</span> <span class="o">-&gt;</span> <span class="n">g</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"UHDecref{(uheap t).tag}({f v});"</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">YArray</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">g</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"ArrayDecref{(carray t).tag}({f v});"</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">YFun</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">FT_Vanilla</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">g</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span>  <span class="err">$</span><span class="s2">"{f v}-&gt;decref_fptr({f v});"</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">YPrim</span> <span class="n">StringT</span> <span class="o">-&gt;</span> <span class="n">g</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span>  <span class="err">$</span><span class="s2">"StringDecref({f v});"</span> <span class="p">)</span>
            <span class="o">|</span> <span class="n">YLayout</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">Heap</span><span class="p">)</span> <span class="k">as</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">g</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span>  <span class="err">$</span><span class="s2">"HeapDecref{(heap a).tag}({f v});"</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">YLayout</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">HeapMutable</span><span class="p">)</span> <span class="k">as</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">g</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span>  <span class="err">$</span><span class="s2">"MutDecref{(mut a).tag}({f v});"</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="kc">None</span>
        <span class="ow">and</span> <span class="n">refc_change</span><span class="s1">' (f : int * Ty -&gt; string) count (x : TyV []) : string [] = Array.choose (refc_change'' f count) x</span>
        <span class="ow">and</span> <span class="n">refc_change</span> <span class="n">f</span> <span class="n">c</span> <span class="n">x</span> <span class="o">=</span> <span class="n">refc_change</span><span class="s1">' (fun (i,t) -&gt; f i) c x</span>
        <span class="ow">and</span> <span class="n">refc_varc</span> <span class="n">x</span> <span class="o">=</span> 
            <span class="n">let</span> <span class="n">ar</span> <span class="o">=</span> <span class="n">ResizeArray</span><span class="p">(</span><span class="n">Map</span><span class="o">.</span><span class="n">count</span> <span class="n">x</span><span class="p">)</span>
            <span class="n">Map</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">k</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">refc_change</span><span class="s1">''</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"v</span><span class="si">{i}</span><span class="s2">"</span><span class="p">)</span> <span class="n">v</span> <span class="n">k</span> <span class="o">|&gt;</span> <span class="n">Option</span><span class="o">.</span><span class="n">iter</span> <span class="n">ar</span><span class="o">.</span><span class="n">Add</span><span class="p">)</span> <span class="n">x</span>
            <span class="n">ar</span>
        <span class="o">//</span><span class="ow">and</span> <span class="n">refc_incr</span> <span class="n">x</span> <span class="p">:</span> <span class="n">string</span> <span class="p">[]</span> <span class="o">=</span> <span class="n">refc_change</span> <span class="p">(</span><span class="n">fun</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"v</span><span class="si">{i}</span><span class="s2">"</span><span class="p">)</span> <span class="mi">1</span> <span class="n">x</span>
        <span class="o">//</span><span class="ow">and</span> <span class="n">refc_decr</span> <span class="n">x</span> <span class="p">:</span> <span class="n">string</span> <span class="p">[]</span> <span class="o">=</span> <span class="n">refc_change</span> <span class="p">(</span><span class="n">fun</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"v</span><span class="si">{i}</span><span class="s2">"</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span> <span class="n">x</span>
        <span class="ow">and</span> <span class="n">show_w</span> <span class="o">=</span> <span class="n">function</span> <span class="n">WV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">_</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"v</span><span class="si">%i</span><span class="s2">"</span> <span class="n">i</span> <span class="o">|</span> <span class="n">WLit</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">lit</span> <span class="n">a</span>
        <span class="ow">and</span> <span class="n">args</span><span class="s1">' b = data_term_vars b |&gt; Array.map show_w |&gt; String.concat ", "</span>
        <span class="ow">and</span> <span class="n">tup_term_vars</span> <span class="n">x</span> <span class="o">=</span>
            <span class="n">let</span> <span class="n">args</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="n">show_w</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">", "</span>
            <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">x</span><span class="o">.</span><span class="n">Length</span> <span class="n">then</span> <span class="n">sprintf</span> <span class="s2">"TupleCreate</span><span class="si">%i</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)"</span> <span class="p">(</span><span class="n">tup</span> <span class="p">(</span><span class="n">term_vars_to_tysC</span> <span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">tag</span> <span class="n">args</span> <span class="k">else</span> <span class="n">args</span>
        <span class="ow">and</span> <span class="n">tup_data</span> <span class="n">x</span> <span class="o">=</span> <span class="n">tup_term_vars</span> <span class="p">(</span><span class="n">data_term_vars</span> <span class="n">x</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">tup_ty_tys</span> <span class="o">=</span> <span class="n">function</span>
            <span class="o">|</span> <span class="p">[</span><span class="o">||</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="s2">"void"</span>
            <span class="o">|</span> <span class="p">[</span><span class="o">|</span><span class="n">x</span><span class="o">|</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">tyv</span> <span class="n">x</span>
            <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Tuple</span><span class="si">%i</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span>
        <span class="ow">and</span> <span class="n">tup_ty_tyvs</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">TyV</span> <span class="p">[])</span> <span class="o">=</span> <span class="n">tup_ty_tys</span> <span class="p">(</span><span class="n">tyvs_to_tys</span> <span class="n">x</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">tup_ty</span> <span class="n">x</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">ty_to_data</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">data_free_vars</span> <span class="o">|&gt;</span> <span class="n">tup_ty_tyvs</span>
        <span class="ow">and</span> <span class="n">tyv</span> <span class="n">x</span> <span class="o">=</span>
            <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">YUnion</span> <span class="n">a</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">a</span><span class="o">.</span><span class="n">Item</span><span class="o">.</span><span class="n">layout</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">UStack</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"US</span><span class="si">%i</span><span class="s2">"</span> <span class="p">(</span><span class="n">ustack</span> <span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span>
                <span class="o">|</span> <span class="n">UHeap</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"UH</span><span class="si">%i</span><span class="s2"> *"</span> <span class="p">(</span><span class="n">uheap</span> <span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span>
            <span class="o">|</span> <span class="n">YLayout</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">lay</span><span class="p">)</span> <span class="k">as</span> <span class="n">a</span> <span class="o">-&gt;</span> 
                <span class="k">match</span> <span class="n">lay</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">Heap</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Heap</span><span class="si">%i</span><span class="s2"> *"</span> <span class="p">(</span><span class="n">heap</span> <span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span>
                <span class="o">|</span> <span class="n">HeapMutable</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Mut</span><span class="si">%i</span><span class="s2"> *"</span> <span class="p">(</span><span class="n">mut</span> <span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span>
                <span class="o">|</span> <span class="n">StackMutable</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="s2">"Compiler error: The C backend doesn't support stack mutable layout types."</span>
            <span class="o">|</span> <span class="n">YMacro</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">function</span> <span class="n">Text</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="o">|</span> <span class="n">Type</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">tup_ty</span> <span class="n">a</span> <span class="o">|</span> <span class="n">TypeLit</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">type_lit</span> <span class="n">a</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">""</span>
            <span class="o">|</span> <span class="n">YPrim</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">prim</span> <span class="n">a</span>
            <span class="o">|</span> <span class="n">YArray</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Array</span><span class="si">%i</span><span class="s2"> *"</span> <span class="p">(</span><span class="n">carray</span> <span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span>
            <span class="o">|</span> <span class="n">YFun</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">FT_Vanilla</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"Fun</span><span class="si">%i</span><span class="s2"> *"</span> <span class="p">(</span><span class="n">cfun</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span><span class="o">.</span><span class="n">tag</span>
            <span class="o">|</span> <span class="n">YExists</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="s2">"Existentials are not supported at runtime. They are a compile time feature only."</span>
            <span class="o">|</span> <span class="n">YForall</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="s2">"Foralls are not supported at runtime. They are a compile time feature only."</span>
            <span class="o">|</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"Compiler error: Type not supported in the codegen.</span><span class="se">\n</span><span class="s2">Got: %A"</span> <span class="n">a</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">prim</span> <span class="o">=</span> <span class="n">function</span>
            <span class="o">|</span> <span class="n">Int8T</span> <span class="o">-&gt;</span> <span class="s2">"int8_t"</span> 
            <span class="o">|</span> <span class="n">Int16T</span> <span class="o">-&gt;</span> <span class="s2">"int16_t"</span>
            <span class="o">|</span> <span class="n">Int32T</span> <span class="o">-&gt;</span> <span class="s2">"int32_t"</span>
            <span class="o">|</span> <span class="n">Int64T</span> <span class="o">-&gt;</span> <span class="s2">"int64_t"</span>
            <span class="o">|</span> <span class="n">UInt8T</span> <span class="o">-&gt;</span> <span class="s2">"uint8_t"</span>
            <span class="o">|</span> <span class="n">UInt16T</span> <span class="o">-&gt;</span> <span class="s2">"uint16_t"</span>
            <span class="o">|</span> <span class="n">UInt32T</span> <span class="o">-&gt;</span> <span class="s2">"uint32_t"</span>
            <span class="o">|</span> <span class="n">UInt64T</span> <span class="o">-&gt;</span> <span class="s2">"uint64_t"</span> <span class="o">//</span> <span class="n">are</span> <span class="n">defined</span> <span class="ow">in</span> <span class="n">stdint</span><span class="o">.</span><span class="n">h</span>
            <span class="o">|</span> <span class="n">Float32T</span> <span class="o">-&gt;</span> <span class="s2">"float"</span>
            <span class="o">|</span> <span class="n">Float64T</span> <span class="o">-&gt;</span> <span class="s2">"double"</span>
            <span class="o">|</span> <span class="n">BoolT</span> <span class="o">-&gt;</span> <span class="s2">"bool"</span> <span class="o">//</span> <span class="ow">is</span> <span class="n">defined</span> <span class="ow">in</span> <span class="n">stdbool</span><span class="o">.</span><span class="n">h</span>
            <span class="o">|</span> <span class="n">CharT</span> <span class="o">-&gt;</span> <span class="s2">"char"</span>
            <span class="o">|</span> <span class="n">StringT</span> <span class="o">-&gt;</span> <span class="n">cstring</span><span class="p">();</span> <span class="s2">"String *"</span>
        <span class="ow">and</span> <span class="n">lit</span> <span class="o">=</span> <span class="n">function</span>
            <span class="o">|</span> <span class="n">LitInt8</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%i</span><span class="s2">"</span> <span class="n">x</span>
            <span class="o">|</span> <span class="n">LitInt16</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%i</span><span class="s2">"</span> <span class="n">x</span>
            <span class="o">|</span> <span class="n">LitInt32</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%i</span><span class="s2">l"</span> <span class="n">x</span>
            <span class="o">|</span> <span class="n">LitInt64</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%i</span><span class="s2">ll"</span> <span class="n">x</span>
            <span class="o">|</span> <span class="n">LitUInt8</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%i</span><span class="s2">u"</span> <span class="n">x</span>
            <span class="o">|</span> <span class="n">LitUInt16</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%i</span><span class="s2">u"</span> <span class="n">x</span>
            <span class="o">|</span> <span class="n">LitUInt32</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%i</span><span class="s2">ul"</span> <span class="n">x</span>
            <span class="o">|</span> <span class="n">LitUInt64</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%i</span><span class="s2">ull"</span> <span class="n">x</span>
            <span class="o">|</span> <span class="n">LitFloat32</span> <span class="n">x</span> <span class="o">-&gt;</span> 
                <span class="k">if</span> <span class="n">x</span> <span class="o">=</span> <span class="n">infinityf</span> <span class="n">then</span> <span class="s2">"HUGE_VALF"</span> <span class="o">//</span> <span class="n">nan</span><span class="o">/</span><span class="n">inf</span> <span class="n">macros</span> <span class="n">are</span> <span class="n">defined</span> <span class="ow">in</span> <span class="n">math</span><span class="o">.</span><span class="n">h</span>
                <span class="k">elif</span> <span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="n">infinityf</span> <span class="n">then</span> <span class="s2">"-HUGE_VALF"</span>
                <span class="k">elif</span> <span class="n">System</span><span class="o">.</span><span class="n">Single</span><span class="o">.</span><span class="n">IsNaN</span> <span class="n">x</span> <span class="n">then</span> <span class="s2">"NAN"</span>
                <span class="k">else</span> <span class="n">x</span><span class="o">.</span><span class="n">ToString</span><span class="p">(</span><span class="s2">"R"</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">add_dec_point</span> <span class="o">|&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2">f"</span>
            <span class="o">|</span> <span class="n">LitFloat64</span> <span class="n">x</span> <span class="o">-&gt;</span>
                <span class="k">if</span> <span class="n">x</span> <span class="o">=</span> <span class="n">infinity</span> <span class="n">then</span> <span class="s2">"HUGE_VAL"</span>
                <span class="k">elif</span> <span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="n">infinity</span> <span class="n">then</span> <span class="s2">"-HUGE_VAL"</span>
                <span class="k">elif</span> <span class="n">System</span><span class="o">.</span><span class="n">Double</span><span class="o">.</span><span class="n">IsNaN</span> <span class="n">x</span> <span class="n">then</span> <span class="s2">"NAN"</span>
                <span class="k">else</span> <span class="n">x</span><span class="o">.</span><span class="n">ToString</span><span class="p">(</span><span class="s2">"R"</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">add_dec_point</span>
            <span class="o">|</span> <span class="n">LitString</span> <span class="n">x</span> <span class="o">-&gt;</span>
                <span class="n">cstring</span><span class="p">()</span>
                <span class="n">lit_stringC</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">sprintf</span> <span class="s2">"StringLit(</span><span class="si">%i</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)"</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">Length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">LitChar</span> <span class="n">x</span> <span class="o">-&gt;</span> 
                <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
                <span class="o">|</span> <span class="s1">'</span><span class="se">\b</span><span class="s1">'</span> <span class="o">-&gt;</span> <span class="o">@</span><span class="s2">"</span><span class="se">\b</span><span class="s2">"</span>
                <span class="o">|</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">'</span> <span class="o">-&gt;</span> <span class="o">@</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
                <span class="o">|</span> <span class="s1">'</span><span class="se">\t</span><span class="s1">'</span> <span class="o">-&gt;</span> <span class="o">@</span><span class="s2">"</span><span class="se">\t</span><span class="s2">"</span>
                <span class="o">|</span> <span class="s1">'</span><span class="se">\r</span><span class="s1">'</span> <span class="o">-&gt;</span> <span class="o">@</span><span class="s2">"</span><span class="se">\r</span><span class="s2">"</span>
                <span class="o">|</span> <span class="s1">'</span><span class="se">\\</span><span class="s1">'</span> <span class="o">-&gt;</span> <span class="o">@</span><span class="s2">"</span><span class="se">\\</span><span class="s2">"</span>
                <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">string</span> <span class="n">x</span>
                <span class="o">|&gt;</span> <span class="n">sprintf</span> <span class="s2">"'</span><span class="si">%s</span><span class="s2">'"</span>
            <span class="o">|</span> <span class="n">LitBool</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">x</span> <span class="n">then</span> <span class="s2">"true"</span> <span class="k">else</span> <span class="s2">"false"</span> <span class="o">//</span> <span class="n">true</span> <span class="ow">and</span> <span class="n">false</span> <span class="n">are</span> <span class="n">defined</span> <span class="ow">in</span> <span class="n">stddef</span><span class="o">.</span><span class="n">h</span>
        <span class="ow">and</span> <span class="n">type_lit</span> <span class="o">=</span> <span class="n">function</span>
            <span class="o">|</span> <span class="n">YLit</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">lit</span> <span class="n">x</span>
            <span class="o">|</span> <span class="n">YSymbol</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span>
            <span class="o">|</span> <span class="n">YNominal</span> <span class="n">_</span> <span class="o">|</span> <span class="n">YApply</span> <span class="n">_</span> <span class="k">as</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">type_lit</span> <span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">nominal_apply</span> <span class="n">x</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="s2">"Compiler error: Expecting a type literal in the macro."</span> 
        <span class="ow">and</span> <span class="n">op</span> <span class="p">(</span><span class="nb">vars</span> <span class="p">:</span> <span class="n">RefcVars</span><span class="p">)</span> <span class="n">s</span> <span class="p">(</span><span class="n">ret</span> <span class="p">:</span> <span class="n">BindsReturnC</span><span class="p">)</span> <span class="n">a</span> <span class="o">=</span>
            <span class="n">let</span> <span class="n">binds</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">binds</span> <span class="nb">vars</span> <span class="n">a</span> <span class="n">b</span>
            <span class="n">let</span> <span class="k">return</span><span class="s1">' (x : string) =</span>
                <span class="k">match</span> <span class="n">ret</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">BindsLocal</span> <span class="n">ret</span> <span class="o">-&gt;</span> <span class="n">return_local</span> <span class="n">s</span> <span class="n">ret</span> <span class="n">x</span>
                <span class="o">|</span> <span class="n">BindsTailEnd</span> <span class="o">-&gt;</span> <span class="n">line</span> <span class="n">s</span> <span class="err">$</span><span class="s2">"return </span><span class="si">{x}</span><span class="s2">;"</span>
            <span class="n">let</span> <span class="n">layout_index</span> <span class="p">(</span><span class="n">x</span><span class="s1">'_i : int) (x'</span> <span class="p">:</span> <span class="n">TyV</span> <span class="p">[])</span> <span class="o">=</span>
                <span class="k">match</span> <span class="n">ret</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">BindsLocal</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">map2</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">_</span><span class="p">))</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="s1">',_)) -&gt; $"v</span><span class="si">{i}</span><span class="s1"> = v{x'</span><span class="n">_i</span><span class="p">}</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">{</span><span class="n">i</span><span class="s1">'};") x x'</span> <span class="o">|&gt;</span> <span class="n">line</span><span class="s1">' s</span>
                <span class="o">|</span> <span class="n">BindsTailEnd</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="s2">"Compiler error: Layout index should never come in end position."</span>
            <span class="n">let</span> <span class="n">jp</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="sa">b</span><span class="s1">') =</span>
                <span class="n">let</span> <span class="n">args</span> <span class="o">=</span> <span class="n">args</span> <span class="sa">b</span><span class="s1">'</span>
                <span class="k">match</span> <span class="n">a</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">JPMethod</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> 
                    <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">method</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
                    <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s%i</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)"</span> <span class="p">(</span><span class="n">Option</span><span class="o">.</span><span class="n">defaultValue</span> <span class="s2">"method"</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="n">x</span><span class="o">.</span><span class="n">tag</span> <span class="n">args</span>
                <span class="o">|</span> <span class="n">JPClosure</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"ClosureCreate</span><span class="si">%i</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)"</span> <span class="p">(</span><span class="n">closure</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span><span class="o">.</span><span class="n">tag</span> <span class="n">args</span>
            <span class="n">let</span> <span class="n">string_in_op</span> <span class="o">=</span> <span class="n">function</span> <span class="n">DLit</span> <span class="p">(</span><span class="n">LitString</span> <span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">lit_stringC</span> <span class="n">b</span> <span class="o">|</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"{tup_data b}-&gt;ptr"</span>
            <span class="k">match</span> <span class="n">a</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">TySizeOf</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="k">return</span><span class="s1">' $"sizeof({tup_ty t})"</span>
            <span class="o">|</span> <span class="n">TyMacro</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="s2">"Macros are supposed to be taken care of in the `binds` function."</span>
            <span class="o">|</span> <span class="n">TyIf</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span><span class="n">tr</span><span class="p">,</span><span class="n">fl</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">line</span> <span class="n">s</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"if (</span><span class="si">%s</span><span class="s2">){"</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">cond</span><span class="p">))</span>
                <span class="n">binds</span> <span class="p">(</span><span class="n">indent</span> <span class="n">s</span><span class="p">)</span> <span class="n">ret</span> <span class="n">tr</span>
                <span class="n">line</span> <span class="n">s</span> <span class="s2">"} else {"</span>
                <span class="n">binds</span> <span class="p">(</span><span class="n">indent</span> <span class="n">s</span><span class="p">)</span> <span class="n">ret</span> <span class="n">fl</span>
                <span class="n">line</span> <span class="n">s</span> <span class="s2">"}"</span>
            <span class="o">|</span> <span class="n">TyJoinPoint</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">args</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">return</span><span class="s1">' (jp (a, args))</span>
            <span class="o">|</span> <span class="n">TyBackend</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">r</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error_backend</span> <span class="n">r</span> <span class="s2">"The C backend does not support nesting of other backends."</span>
            <span class="o">|</span> <span class="n">TyWhile</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">cond</span> <span class="o">=</span>
                    <span class="k">match</span> <span class="n">a</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">JPMethod</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">),</span><span class="sa">b</span><span class="s1">' -&gt; sprintf "method_while</span><span class="si">%i</span><span class="s1">(</span><span class="si">%s</span><span class="s1">)" (method_while (a,b)).tag (args b'</span><span class="p">)</span>
                    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="s2">"Expected a regular method rather than closure create in the while conditional."</span>
                <span class="n">line</span> <span class="n">s</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"while (</span><span class="si">%s</span><span class="s2">){"</span> <span class="n">cond</span><span class="p">)</span>
                <span class="n">binds</span> <span class="p">(</span><span class="n">indent</span> <span class="n">s</span><span class="p">)</span> <span class="p">(</span><span class="n">BindsLocal</span> <span class="p">[</span><span class="o">||</span><span class="p">])</span> <span class="n">b</span>
                <span class="n">line</span> <span class="n">s</span> <span class="s2">"}"</span>
            <span class="o">|</span> <span class="n">TyDo</span> <span class="n">a</span> <span class="o">|</span> <span class="n">TyIndent</span> <span class="n">a</span> <span class="o">-&gt;</span>
                <span class="n">binds</span> <span class="n">s</span> <span class="n">ret</span> <span class="n">a</span>
            <span class="o">|</span> <span class="n">TyIntSwitch</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">v_i</span><span class="p">,</span><span class="n">_</span><span class="p">),</span><span class="n">on_succ</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">line</span> <span class="n">s</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"switch (v</span><span class="si">%i</span><span class="s2">) {"</span> <span class="n">v_i</span><span class="p">)</span>
                <span class="n">let</span> <span class="n">_</span> <span class="o">=</span>
                    <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">indent</span> <span class="n">s</span>
                    <span class="n">Array</span><span class="o">.</span><span class="n">iteri</span> <span class="p">(</span><span class="n">fun</span> <span class="n">i</span> <span class="n">x</span> <span class="o">-&gt;</span>
                        <span class="n">line</span> <span class="n">s</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"case </span><span class="si">%i</span><span class="s2">: {"</span> <span class="n">i</span><span class="p">)</span>
                        <span class="n">binds</span> <span class="p">(</span><span class="n">indent</span> <span class="n">s</span><span class="p">)</span> <span class="n">ret</span> <span class="n">x</span>
                        <span class="n">line</span> <span class="p">(</span><span class="n">indent</span> <span class="n">s</span><span class="p">)</span> <span class="s2">"break;"</span>
                        <span class="n">line</span> <span class="n">s</span> <span class="s2">"}"</span>
                        <span class="p">)</span> <span class="n">on_succ</span>
                    <span class="n">line</span> <span class="n">s</span> <span class="s2">"default: {"</span>
                    <span class="n">binds</span> <span class="p">(</span><span class="n">indent</span> <span class="n">s</span><span class="p">)</span> <span class="n">ret</span> <span class="n">on_fail</span>
                    <span class="n">line</span> <span class="n">s</span> <span class="s2">"}"</span>
                <span class="n">line</span> <span class="n">s</span> <span class="s2">"}"</span>
            <span class="o">|</span> <span class="n">TyUnionUnbox</span><span class="p">(</span><span class="ow">is</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">on_succs</span><span class="p">,</span><span class="n">on_fail</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">case_tags</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">Item</span><span class="o">.</span><span class="n">tags</span>
                <span class="n">let</span> <span class="n">acs</span> <span class="o">=</span> <span class="n">match</span> <span class="n">x</span><span class="o">.</span><span class="n">Item</span><span class="o">.</span><span class="n">layout</span> <span class="k">with</span> <span class="n">UHeap</span> <span class="o">-&gt;</span> <span class="s2">"-&gt;"</span> <span class="o">|</span> <span class="n">UStack</span> <span class="o">-&gt;</span> <span class="s2">"."</span>
                <span class="n">let</span> <span class="n">head</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">head</span> <span class="ow">is</span> <span class="o">|&gt;</span> <span class="n">fun</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">_</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"v</span><span class="si">{i}{acs}</span><span class="s2">tag"</span>
                <span class="n">List</span><span class="o">.</span><span class="n">pairwise</span> <span class="ow">is</span>
                <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">_</span><span class="p">),</span> <span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="s1">',_)) -&gt; $"v</span><span class="si">{i}{acs}</span><span class="s1">tag == v{i'</span><span class="p">}{</span><span class="n">acs</span><span class="p">}</span><span class="n">tag</span><span class="s2">")</span>
                <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">" &amp;&amp; "</span>
                <span class="o">|&gt;</span> <span class="n">function</span> <span class="s2">""</span> <span class="o">-&gt;</span> <span class="n">head</span> <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"</span><span class="si">{x}</span><span class="s2"> ? </span><span class="si">{head}</span><span class="s2"> : -1"</span>
                <span class="o">|&gt;</span> <span class="n">sprintf</span> <span class="s2">"switch (</span><span class="si">%s</span><span class="s2">) {"</span> <span class="o">|&gt;</span> <span class="n">line</span> <span class="n">s</span>
                <span class="n">let</span> <span class="n">_</span> <span class="o">=</span>
                    <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">indent</span> <span class="n">s</span>
                    <span class="n">Map</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">k</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
                        <span class="n">let</span> <span class="n">union_i</span> <span class="o">=</span> <span class="n">case_tags</span><span class="o">.</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="n">let</span> <span class="n">decr</span> <span class="o">=</span> <span class="n">get_default</span> <span class="nb">vars</span><span class="o">.</span><span class="n">g_decr</span> <span class="p">(</span><span class="n">Array</span><span class="o">.</span><span class="n">head</span> <span class="n">b</span><span class="p">)</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="o">.</span><span class="n">empty</span><span class="p">)</span>
                        <span class="n">line</span> <span class="n">s</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"case </span><span class="si">%i</span><span class="s2">: { // </span><span class="si">%s</span><span class="s2">"</span> <span class="n">union_i</span> <span class="n">k</span><span class="p">)</span>
                        <span class="n">List</span><span class="o">.</span><span class="n">iter2</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">data_i</span><span class="p">,</span><span class="n">_</span><span class="p">))</span> <span class="n">a</span> <span class="o">-&gt;</span>
                            <span class="n">let</span> <span class="n">a</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">data_free_vars</span> <span class="n">a</span><span class="p">,</span> <span class="n">indent</span> <span class="n">s</span>
                            <span class="n">let</span> <span class="n">qs</span> <span class="o">=</span> <span class="n">ResizeArray</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">Length</span><span class="p">)</span>
                            <span class="n">Array</span><span class="o">.</span><span class="n">iteri</span> <span class="p">(</span><span class="n">fun</span> <span class="n">field_i</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">v_i</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="k">as</span> <span class="n">v</span><span class="p">)</span> <span class="o">-&gt;</span> 
                                <span class="k">if</span> <span class="n">Set</span><span class="o">.</span><span class="n">contains</span> <span class="n">v</span> <span class="n">decr</span> <span class="o">=</span> <span class="n">false</span> <span class="n">then</span> <span class="n">qs</span><span class="o">.</span><span class="n">Add</span> <span class="err">$</span><span class="s2">"{tyv t} v</span><span class="si">{v_i}</span><span class="s2"> = v</span><span class="si">{data_i}{acs}</span><span class="s2">case</span><span class="si">{union_i}</span><span class="s2">.v</span><span class="si">{field_i}</span><span class="s2">;"</span>
                                <span class="p">)</span> <span class="n">a</span> 
                            <span class="n">line</span><span class="s1">' s qs</span>
                            <span class="p">)</span> <span class="ow">is</span> <span class="n">a</span>
                        <span class="n">binds</span> <span class="p">(</span><span class="n">indent</span> <span class="n">s</span><span class="p">)</span> <span class="n">ret</span> <span class="n">b</span>
                        <span class="n">line</span> <span class="p">(</span><span class="n">indent</span> <span class="n">s</span><span class="p">)</span> <span class="s2">"break;"</span>
                        <span class="n">line</span> <span class="n">s</span> <span class="s2">"}"</span>
                        <span class="p">)</span> <span class="n">on_succs</span>
                    <span class="n">on_fail</span> <span class="o">|&gt;</span> <span class="n">Option</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">b</span> <span class="o">-&gt;</span>
                        <span class="n">line</span> <span class="n">s</span> <span class="s2">"default: {"</span>
                        <span class="n">binds</span> <span class="p">(</span><span class="n">indent</span> <span class="n">s</span><span class="p">)</span> <span class="n">ret</span> <span class="n">b</span>
                        <span class="n">line</span> <span class="n">s</span> <span class="s2">"}"</span>
                        <span class="p">)</span>
                <span class="n">line</span> <span class="n">s</span> <span class="s2">"}"</span>
            <span class="o">|</span> <span class="n">TyUnionBox</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="s1">') -&gt;</span>
                <span class="n">let</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="s1">'.Item</span>
                <span class="n">let</span> <span class="n">i</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
                <span class="n">let</span> <span class="nb">vars</span> <span class="o">=</span> <span class="n">args</span><span class="s1">' b</span>
                <span class="k">match</span> <span class="n">c</span><span class="o">.</span><span class="n">layout</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">UHeap</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"UH</span><span class="si">%i</span><span class="s2">_</span><span class="si">%i</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)"</span> <span class="p">(</span><span class="n">uheap</span> <span class="n">c</span><span class="s1">').tag i vars</span>
                <span class="o">|</span> <span class="n">UStack</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"US</span><span class="si">%i</span><span class="s2">_</span><span class="si">%i</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)"</span> <span class="p">(</span><span class="n">ustack</span> <span class="n">c</span><span class="s1">').tag i vars</span>
                <span class="o">|&gt;</span> <span class="k">return</span><span class="s1">'</span>
            <span class="o">|</span> <span class="n">TyToLayout</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> 
                <span class="k">match</span> <span class="n">b</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">YLayout</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">layout</span><span class="p">)</span> <span class="o">-&gt;</span> 
                    <span class="k">match</span> <span class="n">layout</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">Heap</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"HeapCreate</span><span class="si">%i</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)"</span> <span class="p">(</span><span class="n">heap</span> <span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span> <span class="p">(</span><span class="n">args</span><span class="s1">' a)</span>
                    <span class="o">|</span> <span class="n">HeapMutable</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"MutCreate</span><span class="si">%i</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)"</span> <span class="p">(</span><span class="n">mut</span> <span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span> <span class="p">(</span><span class="n">args</span><span class="s1">' a)</span>
                    <span class="o">|</span> <span class="n">StackMutable</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="s2">"The C backend doesn't support stack mutable layout types."</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="err">$</span><span class="s2">"Compiler error: Expected a layout type (8).</span><span class="se">\n</span><span class="s2">Got: </span><span class="si">%s</span><span class="s2">{show_ty b}"</span>
                <span class="o">|&gt;</span> <span class="k">return</span><span class="s1">'</span>
            <span class="o">|</span> <span class="n">TyLayoutIndexAll</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">YLayout</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">lay</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">a</span><span class="p">))</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">lay</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">Heap</span> <span class="o">-&gt;</span> <span class="n">heap</span> <span class="n">a</span> 
                <span class="o">|</span> <span class="n">HeapMutable</span> <span class="o">-&gt;</span> <span class="n">mut</span> <span class="n">a</span>
                <span class="o">|</span> <span class="n">StackMutable</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="s2">"The C backend doesn't support indexing into stack mutable layout types."</span>
                <span class="o">|&gt;</span> <span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">.</span><span class="n">free_vars</span> <span class="o">|&gt;</span> <span class="n">layout_index</span> <span class="n">i</span> 
            <span class="o">|</span> <span class="n">TyLayoutIndexByKey</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">YLayout</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">lay</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">a</span><span class="p">),</span><span class="n">key</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">lay</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">Heap</span> <span class="o">-&gt;</span> <span class="n">heap</span> <span class="n">a</span> 
                <span class="o">|</span> <span class="n">HeapMutable</span> <span class="o">-&gt;</span> <span class="n">mut</span> <span class="n">a</span>
                <span class="o">|</span> <span class="n">StackMutable</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="s2">"The C backend doesn't support indexing into stack mutable layout types."</span>
                <span class="o">|&gt;</span> <span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">free_vars_by_key</span>
                    <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryPick</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">k</span> <span class="o">=</span> <span class="n">key</span> <span class="n">then</span> <span class="n">Some</span> <span class="n">v</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="o">|&gt;</span> <span class="n">Option</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">layout_index</span> <span class="n">i</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">TyLayoutIndexAll</span> <span class="n">_</span> <span class="o">|</span> <span class="n">TyLayoutIndexByKey</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="s2">"Compiler error: Expected the TyV in layout index to be a layout type."</span>
            <span class="o">|</span> <span class="n">TyLayoutMutableSet</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">t</span><span class="p">),</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">q</span> <span class="o">=</span> <span class="n">mut</span> <span class="n">t</span> <span class="o">//</span> <span class="err">`</span><span class="n">mut</span> <span class="n">t</span><span class="err">`</span> <span class="ow">is</span> <span class="n">correct</span> <span class="n">here</span><span class="p">,</span> <span class="n">peval</span> <span class="n">strips</span> <span class="n">the</span> <span class="n">YLayout</span><span class="o">.</span>
                <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">k</span> <span class="o">-&gt;</span>
                    <span class="k">match</span> <span class="n">s</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">DRecord</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">l</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">pick</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">k</span><span class="s1">') v -&gt; if k'</span> <span class="o">=</span> <span class="n">k</span> <span class="n">then</span> <span class="n">Some</span> <span class="n">v</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="s2">"Compiler error: Expected a record."</span><span class="p">)</span> <span class="n">q</span><span class="o">.</span><span class="n">data</span> <span class="n">b</span> 
                <span class="n">Array</span><span class="o">.</span><span class="n">map2</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="s1">',_)) b -&gt; $"&amp;(v</span><span class="si">{i}</span><span class="s1">-&gt;v{i'</span><span class="p">}),</span> <span class="p">{</span><span class="n">show_w</span> <span class="n">b</span><span class="p">}</span><span class="s2">") (data_free_vars a) (data_term_vars c) |&gt; String.concat "</span><span class="p">,</span> <span class="s2">" </span>
                <span class="o">|&gt;</span> <span class="n">sprintf</span> <span class="s2">"AssignMut</span><span class="si">%i</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)"</span> <span class="p">(</span><span class="n">assign_mut</span> <span class="p">(</span><span class="n">tyvs_to_tys</span> <span class="n">q</span><span class="o">.</span><span class="n">free_vars</span><span class="p">))</span><span class="o">.</span><span class="n">tag</span> <span class="o">|&gt;</span> <span class="k">return</span><span class="s1">'</span>
            <span class="o">|</span> <span class="n">TyArrayLiteral</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="sa">b</span><span class="s1">') -&gt;</span>
                <span class="n">let</span> <span class="n">b</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="n">tup_data</span> <span class="sa">b</span><span class="s1">' |&gt; String.concat "," |&gt; sprintf "{</span><span class="si">%s</span><span class="s1">}"</span>
                <span class="err">$</span><span class="s2">"ArrayLit{(carray a).tag}({b'.Length}, ({tup_ty a} [])</span><span class="si">{b}</span><span class="s2">)"</span> <span class="o">|&gt;</span> <span class="k">return</span><span class="s1">'</span>
            <span class="o">|</span> <span class="n">TyArrayCreate</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> 
                <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">carray</span> <span class="n">a</span>
                <span class="n">let</span> <span class="n">is_heap</span> <span class="p">:</span> <span class="n">string</span> <span class="o">=</span> <span class="n">is_heap</span> <span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">ty_to_data</span> <span class="o">&gt;&gt;</span> <span class="n">data_free_vars</span><span class="p">)</span> <span class="n">a</span><span class="o">.</span><span class="n">tyvs</span> <span class="o">|&gt;</span> <span class="n">sprintf</span> <span class="s2">"%b"</span>
                <span class="err">$</span><span class="s2">"ArrayCreate</span><span class="si">{a.tag}</span><span class="s2">({tup_data b}, </span><span class="si">{is_heap}</span><span class="s2">)"</span> <span class="o">|&gt;</span> <span class="k">return</span><span class="s1">'</span>
            <span class="o">|</span> <span class="n">TyFailwith</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> 
                <span class="n">let</span> <span class="n">fmt</span> <span class="o">=</span> <span class="o">@</span><span class="s2">"</span><span class="si">%s</span><span class="se">\n</span><span class="s2">"</span>
                <span class="n">line</span> <span class="n">s</span> <span class="err">$</span><span class="s2">"fprintf(stderr, </span><span class="se">\"</span><span class="si">{fmt}</span><span class="se">\"</span><span class="s2">, {string_in_op b});"</span>
                <span class="n">line</span> <span class="n">s</span> <span class="s2">"exit(EXIT_FAILURE);"</span> <span class="o">//</span> <span class="n">TODO</span><span class="p">:</span> <span class="n">Print</span> <span class="n">out</span> <span class="n">the</span> <span class="n">error</span> <span class="n">traces</span> <span class="k">as</span> <span class="n">well</span><span class="o">.</span>
            <span class="o">|</span> <span class="n">TyConv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">return</span><span class="s1">' $"({tyv a}){tup_data b}"</span>
            <span class="o">|</span> <span class="n">TyApply</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">_</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> 
                <span class="k">match</span> <span class="n">args</span><span class="s1">' b with</span>
                <span class="o">|</span> <span class="s2">""</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"v</span><span class="si">{i}</span><span class="s2">-&gt;fptr(v</span><span class="si">{i}</span><span class="s2">)"</span>
                <span class="o">|</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"v</span><span class="si">{i}</span><span class="s2">-&gt;fptr(v</span><span class="si">{i}</span><span class="s2">, </span><span class="si">{b}</span><span class="s2">)"</span>
                <span class="o">|&gt;</span> <span class="k">return</span><span class="s1">'</span>
            <span class="o">|</span> <span class="n">TyArrayLength</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">return</span><span class="s1">' $"{tup_data b}-&gt;len"</span>
            <span class="o">|</span> <span class="n">TyStringLength</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">return</span><span class="s1">' $"{tup_data b}-&gt;len-1"</span>
            <span class="o">|</span> <span class="n">TyOp</span><span class="p">(</span><span class="n">Global</span><span class="p">,[</span><span class="n">DLit</span> <span class="p">(</span><span class="n">LitString</span> <span class="n">x</span><span class="p">)])</span> <span class="o">-&gt;</span> <span class="k">global</span><span class="s1">' x</span>
            <span class="o">|</span> <span class="n">TyOp</span><span class="p">(</span><span class="n">op</span><span class="p">,</span><span class="n">l</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">float_suffix</span> <span class="o">=</span> <span class="n">function</span>
                    <span class="o">|</span> <span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">YPrim</span> <span class="n">Float32T</span><span class="p">))</span> <span class="o">|</span> <span class="n">DLit</span><span class="p">(</span><span class="n">LitFloat32</span> <span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">"f"</span>
                    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="s2">""</span>
                <span class="k">match</span> <span class="n">op</span><span class="p">,</span> <span class="n">l</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">Dyn</span><span class="p">,[</span><span class="n">a</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">tup_data</span> <span class="n">a</span>
                <span class="o">|</span> <span class="n">TypeToVar</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="s2">"The use of `` should never appear in generated code."</span>
                <span class="o">|</span> <span class="n">StringIndex</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2">-&gt;ptr[</span><span class="si">%s</span><span class="s2">]"</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">StringSlice</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">;</span><span class="n">c</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="s2">"String slice is not supported natively in the C backend. Use a library implementation instead."</span>
                <span class="o">|</span> <span class="n">ArrayIndex</span><span class="p">,</span> <span class="p">[</span><span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">YArray</span> <span class="n">t</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="o">-&gt;</span> 
                    <span class="k">match</span> <span class="n">tup_ty</span> <span class="n">t</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="s2">"void"</span> <span class="o">-&gt;</span> <span class="s2">"/* void array index */"</span>
                    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2">-&gt;ptr[</span><span class="si">%s</span><span class="s2">]"</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">ArrayIndexSet</span><span class="p">,</span> <span class="p">[</span><span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">YArray</span> <span class="n">t</span><span class="p">))</span> <span class="k">as</span> <span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">;</span><span class="n">c</span><span class="p">]</span> <span class="o">-&gt;</span> 
                    <span class="n">let</span> <span class="n">a</span><span class="s1">',b'</span><span class="p">,</span><span class="n">c</span><span class="s1">' = tup_data a, tup_data b, tup_data c</span>
                    <span class="k">match</span> <span class="n">c</span><span class="s1">' with</span>
                    <span class="o">|</span> <span class="s2">""</span> <span class="o">-&gt;</span> <span class="s2">"/* void array set */"</span>
                    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"AssignArray{(assign_array (tyvs_to_tys (carray t).tyvs)).tag}(&amp;({a'}-&gt;ptr[{b'}]), {c'})"</span>
                <span class="o">//</span> <span class="n">Math</span>
                <span class="o">|</span> <span class="n">Add</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> + </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">Sub</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> - </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">Mult</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> * </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">Div</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> / </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">Mod</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> </span><span class="si">%%</span><span class="s2"> </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">Pow</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"pow</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">)"</span> <span class="p">(</span><span class="n">float_suffix</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">LT</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> &lt; </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">LTE</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> &lt;= </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">EQ</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="n">when</span> <span class="n">is_stringC</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="kn">import</span> <span class="s2">"string.h"</span><span class="p">;</span> <span class="n">sprintf</span> <span class="s2">"strcmp(</span><span class="si">%s</span><span class="s2">-&gt;ptr, </span><span class="si">%s</span><span class="s2">-&gt;ptr) == 0"</span> <span class="p">(</span><span class="n">string_in_op</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">string_in_op</span> <span class="n">b</span><span class="p">)</span> <span class="o">//</span> <span class="n">TODO</span><span class="p">:</span> <span class="n">Optimize</span> <span class="n">string</span> <span class="n">structural</span> <span class="n">comparison</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">real_core</span>
                <span class="o">|</span> <span class="n">NEQ</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="n">when</span> <span class="n">is_stringC</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="kn">import</span> <span class="s2">"string.h"</span><span class="p">;</span> <span class="n">sprintf</span> <span class="s2">"strcmp(</span><span class="si">%s</span><span class="s2">-&gt;ptr, </span><span class="si">%s</span><span class="s2">-&gt;ptr) != 0"</span> <span class="p">(</span><span class="n">string_in_op</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">string_in_op</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">GT</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="n">when</span> <span class="n">is_stringC</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="kn">import</span> <span class="s2">"string.h"</span><span class="p">;</span> <span class="n">sprintf</span> <span class="s2">"strcmp(</span><span class="si">%s</span><span class="s2">-&gt;ptr, </span><span class="si">%s</span><span class="s2">-&gt;ptr) &gt; 0"</span> <span class="p">(</span><span class="n">string_in_op</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">string_in_op</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">GTE</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="n">when</span> <span class="n">is_stringC</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="kn">import</span> <span class="s2">"string.h"</span><span class="p">;</span> <span class="n">sprintf</span> <span class="s2">"strcmp(</span><span class="si">%s</span><span class="s2">-&gt;ptr, </span><span class="si">%s</span><span class="s2">-&gt;ptr) &gt;= 0"</span> <span class="p">(</span><span class="n">string_in_op</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">string_in_op</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">EQ</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> == </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">NEQ</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> != </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">GT</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> &gt; </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">GTE</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> &gt;= </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">BoolAnd</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> &amp;&amp; </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">BoolOr</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> || </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">BitwiseAnd</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> &amp; </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">BitwiseOr</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> | </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">BitwiseXor</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> ^ </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">BitwiseComplement</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"~</span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">a</span><span class="p">)</span>

                <span class="o">|</span> <span class="n">ShiftLeft</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> &lt;&lt; </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">b</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">ShiftRight</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="p">;</span><span class="n">b</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> &gt;&gt; </span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">b</span><span class="p">)</span>

                <span class="o">|</span> <span class="n">Neg</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"-</span><span class="si">%s</span><span class="s2">"</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">x</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">Log</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="kn">import</span> <span class="s2">"math.h"</span><span class="p">;</span> <span class="n">sprintf</span> <span class="s2">"log</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)"</span> <span class="p">(</span><span class="n">float_suffix</span> <span class="n">x</span><span class="p">)</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">x</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">Exp</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="kn">import</span> <span class="s2">"math.h"</span><span class="p">;</span> <span class="n">sprintf</span> <span class="s2">"exp</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)"</span> <span class="p">(</span><span class="n">float_suffix</span> <span class="n">x</span><span class="p">)</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">x</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">Tanh</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="kn">import</span> <span class="s2">"math.h"</span><span class="p">;</span> <span class="n">sprintf</span> <span class="s2">"tanh</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)"</span> <span class="p">(</span><span class="n">float_suffix</span> <span class="n">x</span><span class="p">)</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">x</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">Sqrt</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="kn">import</span> <span class="s2">"math.h"</span><span class="p">;</span> <span class="n">sprintf</span> <span class="s2">"sqrt</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">)"</span> <span class="p">(</span><span class="n">float_suffix</span> <span class="n">x</span><span class="p">)</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">x</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">NanIs</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="kn">import</span> <span class="s2">"math.h"</span><span class="p">;</span> <span class="n">sprintf</span> <span class="s2">"isnan(</span><span class="si">%s</span><span class="s2">)"</span> <span class="p">(</span><span class="n">tup_data</span> <span class="n">x</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">UnionTag</span><span class="p">,</span> <span class="p">[</span><span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">YUnion</span> <span class="n">l</span><span class="p">))</span> <span class="k">as</span> <span class="n">x</span><span class="p">]</span> <span class="o">-&gt;</span> 
                    <span class="k">match</span> <span class="n">l</span><span class="o">.</span><span class="n">Item</span><span class="o">.</span><span class="n">layout</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">UHeap</span> <span class="o">-&gt;</span> <span class="s2">"-&gt;tag"</span>
                    <span class="o">|</span> <span class="n">UStack</span> <span class="o">-&gt;</span> <span class="s2">".tag"</span>
                    <span class="o">|&gt;</span> <span class="n">sprintf</span> <span class="s2">"v</span><span class="si">%i%s</span><span class="s2">"</span> <span class="n">i</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="o">&lt;|</span> <span class="n">sprintf</span> <span class="s2">"Compiler error: %A with </span><span class="si">%i</span><span class="s2"> args not supported"</span> <span class="n">op</span> <span class="n">l</span><span class="o">.</span><span class="n">Length</span>
                <span class="o">|&gt;</span> <span class="k">return</span><span class="s1">'</span>
        <span class="ow">and</span> <span class="n">print_ordered_args</span> <span class="n">s</span> <span class="n">v</span> <span class="o">=</span> <span class="o">//</span> <span class="n">Unlike</span> <span class="n">C</span><span class="c1"># for example, C keeps the struct fields in input order. To reduce padding, it is best to order the fields from largest to smallest.</span>
            <span class="n">order_argsC</span> <span class="n">v</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">x</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">line</span> <span class="n">s</span> <span class="err">$</span><span class="s2">"{tyv x} v</span><span class="si">{i}</span><span class="s2">;"</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">method_templ</span> <span class="n">is_while</span> <span class="n">fun_name</span> <span class="p">:</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">MethodRecC</span> <span class="o">=</span>
            <span class="n">jp</span> <span class="p">(</span><span class="n">fun</span> <span class="p">((</span><span class="n">jp_body</span><span class="p">,</span><span class="n">key</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">C</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="n">_</span><span class="p">))),</span><span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="p">(</span><span class="n">fst</span> <span class="n">env</span><span class="o">.</span><span class="n">join_point_method</span><span class="o">.</span><span class="p">[</span><span class="n">jp_body</span><span class="p">])</span><span class="o">.</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">Some</span> <span class="n">a</span><span class="p">,</span> <span class="n">Some</span> <span class="nb">range</span><span class="p">,</span> <span class="n">name</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">tag</span><span class="o">=</span><span class="n">i</span><span class="p">;</span> <span class="n">free_vars</span><span class="o">=</span><span class="n">rdata_free_vars</span> <span class="n">args</span><span class="p">;</span> <span class="nb">range</span><span class="o">=</span><span class="nb">range</span><span class="p">;</span> <span class="n">body</span><span class="o">=</span><span class="n">a</span><span class="p">;</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">}</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="s2">"Compiler error: The method dictionary is malformed"</span>
                <span class="p">)</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="n">s_typ</span> <span class="n">s_fun</span> <span class="n">x</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">ret_ty</span> <span class="o">=</span> <span class="n">tup_ty</span> <span class="n">x</span><span class="o">.</span><span class="n">range</span>
                <span class="n">let</span> <span class="n">args</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">free_vars</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">mapi</span> <span class="p">(</span><span class="n">fun</span> <span class="n">i</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"{tyv x} v</span><span class="si">{i}</span><span class="s2">"</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">", "</span>
                <span class="n">let</span> <span class="n">fun_name</span> <span class="o">=</span> <span class="n">Option</span><span class="o">.</span><span class="n">defaultValue</span> <span class="n">fun_name</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span>
                <span class="n">line</span> <span class="n">s_fun</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s%i</span><span class="s2">(</span><span class="si">%s</span><span class="s2">){"</span> <span class="n">ret_ty</span> <span class="n">fun_name</span> <span class="n">x</span><span class="o">.</span><span class="n">tag</span> <span class="n">args</span><span class="p">)</span>
                <span class="n">binds_start</span> <span class="p">(</span><span class="k">if</span> <span class="n">is_while</span> <span class="n">then</span> <span class="p">[</span><span class="o">||</span><span class="p">]</span> <span class="k">else</span> <span class="n">x</span><span class="o">.</span><span class="n">free_vars</span><span class="p">)</span> <span class="p">(</span><span class="n">indent</span> <span class="n">s_fun</span><span class="p">)</span> <span class="n">x</span><span class="o">.</span><span class="n">body</span>
                <span class="n">line</span> <span class="n">s_fun</span> <span class="s2">"}"</span>
                <span class="p">)</span>
        <span class="ow">and</span> <span class="n">method_while</span> <span class="p">:</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">MethodRecC</span> <span class="o">=</span> <span class="n">method_templ</span> <span class="n">true</span> <span class="s2">"method_while"</span>
        <span class="ow">and</span> <span class="n">method</span> <span class="p">:</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">MethodRecC</span> <span class="o">=</span> <span class="n">method_templ</span> <span class="n">false</span> <span class="s2">"method"</span>
        <span class="ow">and</span> <span class="n">closure</span> <span class="p">:</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">ClosureRecC</span> <span class="o">=</span>
            <span class="n">jp</span> <span class="p">(</span><span class="n">fun</span> <span class="p">((</span><span class="n">jp_body</span><span class="p">,</span><span class="n">key</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">C</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">fun_ty</span><span class="p">))),</span><span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">fun_ty</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">YFun</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span><span class="nb">range</span><span class="p">,</span><span class="n">FT_Vanilla</span><span class="p">)</span> <span class="o">-&gt;</span>
                    <span class="k">match</span> <span class="p">(</span><span class="n">fst</span> <span class="n">env</span><span class="o">.</span><span class="n">join_point_closure</span><span class="o">.</span><span class="p">[</span><span class="n">jp_body</span><span class="p">])</span><span class="o">.</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">Some</span><span class="p">(</span><span class="n">domain_args</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">tag</span><span class="o">=</span><span class="n">i</span><span class="p">;</span> <span class="n">free_vars</span><span class="o">=</span><span class="n">rdata_free_vars</span> <span class="n">args</span><span class="p">;</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">;</span> <span class="n">domain_args</span><span class="o">=</span><span class="n">data_free_vars</span> <span class="n">domain_args</span><span class="p">;</span> <span class="nb">range</span><span class="o">=</span><span class="nb">range</span><span class="p">;</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">}</span>
                    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="s2">"Compiler error: The method dictionary is malformed"</span>
                <span class="o">|</span> <span class="n">YFun</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span><span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="s2">"Non-standard functions are not supported in the C backend."</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="s2">"Compiler error: Unexpected type in the closure join point."</span>
                <span class="p">)</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="n">s_typ</span> <span class="n">s_fun</span> <span class="n">x</span> <span class="o">-&gt;</span>
                
                <span class="n">let</span> <span class="n">i</span><span class="p">,</span> <span class="nb">range</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">tup_ty</span> <span class="n">x</span><span class="o">.</span><span class="n">range</span>
                <span class="n">line</span> <span class="n">s_typ</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"typedef struct Closure</span><span class="si">%i</span><span class="s2"> Closure</span><span class="si">%i</span><span class="s2">;"</span> <span class="n">i</span> <span class="n">i</span><span class="p">)</span>
                <span class="n">line</span> <span class="n">s_typ</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"struct Closure</span><span class="si">%i</span><span class="s2"> {"</span> <span class="n">i</span><span class="p">)</span>
                <span class="n">let</span> <span class="n">_</span> <span class="o">=</span>
                    <span class="n">let</span> <span class="n">s_typ</span> <span class="o">=</span> <span class="n">indent</span> <span class="n">s_typ</span>
                    <span class="n">line</span> <span class="n">s_typ</span> <span class="err">$</span><span class="s2">"int refc;"</span>
                    <span class="n">line</span> <span class="n">s_typ</span> <span class="err">$</span><span class="s2">"void (*decref_fptr)(Closure</span><span class="si">{i}</span><span class="s2"> *);"</span>
                    <span class="k">match</span> <span class="n">x</span><span class="o">.</span><span class="n">domain_args</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">t</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">tyv</span> <span class="n">t</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">", "</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="s2">""</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"</span><span class="si">{range}</span><span class="s2"> (*fptr)(Closure</span><span class="si">{i}</span><span class="s2"> *);"</span>
                    <span class="o">|</span> <span class="n">domain_args_ty</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"</span><span class="si">{range}</span><span class="s2"> (*fptr)(Closure</span><span class="si">{i}</span><span class="s2"> *, </span><span class="si">{domain_args_ty}</span><span class="s2">);"</span>
                    <span class="o">|&gt;</span> <span class="n">line</span> <span class="n">s_typ</span>
                    <span class="n">print_ordered_args</span> <span class="n">s_typ</span> <span class="n">x</span><span class="o">.</span><span class="n">free_vars</span>
                <span class="n">line</span> <span class="n">s_typ</span> <span class="s2">"};"</span>

                <span class="n">line</span> <span class="n">s_fun</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"static inline void ClosureDecrefBody</span><span class="si">%i</span><span class="s2">(Closure</span><span class="si">%i</span><span class="s2"> * x){"</span> <span class="n">i</span> <span class="n">i</span><span class="p">)</span>
                <span class="n">let</span> <span class="n">_</span> <span class="o">=</span>
                    <span class="n">let</span> <span class="n">s_fun</span> <span class="o">=</span> <span class="n">indent</span> <span class="n">s_fun</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">free_vars</span> <span class="o">|&gt;</span> <span class="n">refc_change</span> <span class="p">(</span><span class="n">fun</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"x-&gt;v</span><span class="si">{i}</span><span class="s2">"</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span> <span class="o">|&gt;</span> <span class="n">line</span><span class="s1">' s_fun</span>
                <span class="n">line</span> <span class="n">s_fun</span> <span class="s2">"}"</span>

                <span class="n">print_decref</span> <span class="n">s_fun</span> <span class="err">$</span><span class="s2">"ClosureDecref</span><span class="si">{i}</span><span class="s2">"</span> <span class="err">$</span><span class="s2">"Closure</span><span class="si">{i}</span><span class="s2">"</span> <span class="err">$</span><span class="s2">"ClosureDecrefBody</span><span class="si">{i}</span><span class="s2">"</span>
                
                <span class="k">match</span> <span class="n">x</span><span class="o">.</span><span class="n">domain_args</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">t</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"{tyv t} v</span><span class="si">{i}</span><span class="s2">"</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">", "</span> <span class="k">with</span>
                <span class="o">|</span> <span class="s2">""</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> ClosureMethod</span><span class="si">%i</span><span class="s2">(Closure</span><span class="si">%i</span><span class="s2"> * x){"</span> <span class="nb">range</span> <span class="n">i</span> <span class="n">i</span>
                <span class="o">|</span> <span class="n">domain_args</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> ClosureMethod</span><span class="si">%i</span><span class="s2">(Closure</span><span class="si">%i</span><span class="s2"> * x, </span><span class="si">%s</span><span class="s2">){"</span> <span class="nb">range</span> <span class="n">i</span> <span class="n">i</span> <span class="n">domain_args</span>
                <span class="o">|&gt;</span> <span class="n">line</span> <span class="n">s_fun</span>
                <span class="n">let</span> <span class="n">_</span> <span class="o">=</span>
                    <span class="n">let</span> <span class="n">s_fun</span> <span class="o">=</span> <span class="n">indent</span> <span class="n">s_fun</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">free_vars</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">t</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"{tyv t} v</span><span class="si">{i}</span><span class="s2"> = x-&gt;v</span><span class="si">{i}</span><span class="s2">;"</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">line</span><span class="s1">' s_fun</span>
                    <span class="n">line</span> <span class="n">s_fun</span> <span class="err">$</span><span class="s2">"ClosureDecref</span><span class="si">{i}</span><span class="s2">(x);"</span>
                    <span class="n">binds_start</span> <span class="n">x</span><span class="o">.</span><span class="n">domain_args</span> <span class="n">s_fun</span> <span class="n">x</span><span class="o">.</span><span class="n">body</span>
                <span class="n">line</span> <span class="n">s_fun</span> <span class="s2">"}"</span>

                <span class="n">let</span> <span class="n">fun_tag</span> <span class="o">=</span> <span class="p">(</span><span class="n">cfun</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">domain</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">range</span><span class="p">))</span><span class="o">.</span><span class="n">tag</span>
                <span class="n">let</span> <span class="n">free_vars</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">free_vars</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">t</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"{tyv t} v</span><span class="si">{i}</span><span class="s2">"</span><span class="p">)</span>
                <span class="n">line</span> <span class="n">s_fun</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"Fun</span><span class="si">%i</span><span class="s2"> * ClosureCreate</span><span class="si">%i</span><span class="s2">(</span><span class="si">%s</span><span class="s2">){"</span> <span class="n">fun_tag</span> <span class="n">i</span> <span class="p">(</span><span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">", "</span> <span class="n">free_vars</span><span class="p">))</span>
                <span class="n">let</span> <span class="n">_</span> <span class="o">=</span>
                    <span class="n">let</span> <span class="n">s_fun</span> <span class="o">=</span> <span class="n">indent</span> <span class="n">s_fun</span>
                    <span class="n">line</span> <span class="n">s_fun</span> <span class="err">$</span><span class="s2">"Closure</span><span class="si">{i}</span><span class="s2"> * x = </span><span class="si">{malloc}</span><span class="s2">(sizeof(Closure</span><span class="si">{i}</span><span class="s2">));"</span>
                    <span class="n">line</span> <span class="n">s_fun</span> <span class="s2">"x-&gt;refc = 1;"</span>
                    <span class="n">line</span> <span class="n">s_fun</span> <span class="err">$</span><span class="s2">"x-&gt;decref_fptr = ClosureDecref</span><span class="si">{i}</span><span class="s2">;"</span>
                    <span class="n">line</span> <span class="n">s_fun</span> <span class="err">$</span><span class="s2">"x-&gt;fptr = ClosureMethod</span><span class="si">{i}</span><span class="s2">;"</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">free_vars</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">_</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"x-&gt;v</span><span class="si">{i}</span><span class="s2"> = v</span><span class="si">{i}</span><span class="s2">;"</span><span class="p">)</span>  <span class="o">|&gt;</span> <span class="n">line</span><span class="s1">' s_fun</span>
                    <span class="n">line</span> <span class="n">s_fun</span> <span class="err">$</span><span class="s2">"return (Fun</span><span class="si">{fun_tag}</span><span class="s2"> *) x;"</span>
                <span class="n">line</span> <span class="n">s_fun</span> <span class="s2">"}"</span>
                <span class="p">)</span>
        <span class="ow">and</span> <span class="n">cfun</span> <span class="p">:</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">CFunRecC</span> <span class="o">=</span>
            <span class="n">cfun</span><span class="s1">' (fun _ s_typ s_fun x -&gt;</span>
                <span class="n">let</span> <span class="n">i</span><span class="p">,</span> <span class="nb">range</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">tup_ty</span> <span class="n">x</span><span class="o">.</span><span class="n">range</span>
                <span class="n">line</span> <span class="n">s_typ</span> <span class="err">$</span><span class="s2">"typedef struct Fun</span><span class="si">{i}</span><span class="s2"> Fun</span><span class="si">{i}</span><span class="s2">;"</span>
                <span class="n">line</span> <span class="n">s_typ</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"struct Fun</span><span class="si">%i</span><span class="s2">{"</span> <span class="n">i</span><span class="p">)</span>
                <span class="n">let</span> <span class="n">_</span> <span class="o">=</span>
                    <span class="n">let</span> <span class="n">s_typ</span> <span class="o">=</span> <span class="n">indent</span> <span class="n">s_typ</span>
                    <span class="n">line</span> <span class="n">s_typ</span> <span class="err">$</span><span class="s2">"int refc;"</span>
                    <span class="n">line</span> <span class="n">s_typ</span> <span class="err">$</span><span class="s2">"void (*decref_fptr)(Fun</span><span class="si">{i}</span><span class="s2"> *);"</span>
                    <span class="k">match</span> <span class="n">x</span><span class="o">.</span><span class="n">domain_args_ty</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="n">tyv</span> <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">", "</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="s2">""</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"</span><span class="si">{range}</span><span class="s2"> (*fptr)(Fun</span><span class="si">{i}</span><span class="s2"> *);"</span>
                    <span class="o">|</span> <span class="n">domain_args_ty</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"</span><span class="si">{range}</span><span class="s2"> (*fptr)(Fun</span><span class="si">{i}</span><span class="s2"> *, </span><span class="si">{domain_args_ty}</span><span class="s2">);"</span>
                    <span class="o">|&gt;</span> <span class="n">line</span> <span class="n">s_typ</span>
                <span class="n">line</span> <span class="n">s_typ</span> <span class="s2">"};"</span>
                <span class="p">)</span>
        <span class="ow">and</span> <span class="n">tup</span> <span class="p">:</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">TupleRecC</span> <span class="o">=</span>
            <span class="nb">tuple</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="n">s_typ</span> <span class="n">s_fun</span> <span class="n">x</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">name</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">"Tuple</span><span class="si">%i</span><span class="s2">"</span> <span class="n">x</span><span class="o">.</span><span class="n">tag</span>
                <span class="n">line</span> <span class="n">s_typ</span> <span class="s2">"typedef struct {"</span>
                <span class="n">x</span><span class="o">.</span><span class="n">tys</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">mapi</span> <span class="p">(</span><span class="n">fun</span> <span class="n">i</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">x</span><span class="p">))</span> <span class="o">|&gt;</span> <span class="n">print_ordered_args</span> <span class="p">(</span><span class="n">indent</span> <span class="n">s_typ</span><span class="p">)</span>
                <span class="n">line</span> <span class="n">s_typ</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"} </span><span class="si">%s</span><span class="s2">;"</span> <span class="n">name</span><span class="p">)</span>

                <span class="n">let</span> <span class="n">args</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">tys</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">mapi</span> <span class="p">(</span><span class="n">fun</span> <span class="n">i</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"{tyv x} v</span><span class="si">{i}</span><span class="s2">"</span><span class="p">)</span>
                <span class="n">line</span> <span class="n">s_fun</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"static inline </span><span class="si">%s</span><span class="s2"> TupleCreate</span><span class="si">%i</span><span class="s2">(</span><span class="si">%s</span><span class="s2">){"</span> <span class="n">name</span> <span class="n">x</span><span class="o">.</span><span class="n">tag</span> <span class="p">(</span><span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">", "</span> <span class="n">args</span><span class="p">))</span>
                <span class="n">let</span> <span class="n">_</span> <span class="o">=</span>
                    <span class="n">let</span> <span class="n">s_fun</span> <span class="o">=</span> <span class="n">indent</span> <span class="n">s_fun</span>
                    <span class="n">line</span> <span class="n">s_fun</span> <span class="err">$</span><span class="s2">"</span><span class="si">{name}</span><span class="s2"> x;"</span>
                    <span class="n">Array</span><span class="o">.</span><span class="n">init</span> <span class="n">args</span><span class="o">.</span><span class="n">Length</span> <span class="p">(</span><span class="n">fun</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"x.v</span><span class="si">{i}</span><span class="s2"> = v</span><span class="si">{i}</span><span class="s2">;"</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">line</span><span class="s1">' s_fun</span>
                    <span class="n">line</span> <span class="n">s_fun</span> <span class="err">$</span><span class="s2">"return x;"</span>
                <span class="n">line</span> <span class="n">s_fun</span> <span class="s2">"}"</span>
                <span class="p">)</span>
        <span class="ow">and</span> <span class="n">assign_mut</span> <span class="p">:</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">TupleRecC</span> <span class="o">=</span> 
            <span class="nb">tuple</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="n">s_typ</span> <span class="n">s_fun</span> <span class="n">x</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">tyvs</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">mapi</span> <span class="p">(</span><span class="n">fun</span> <span class="n">i</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">t</span><span class="p">))</span> <span class="n">x</span><span class="o">.</span><span class="n">tys</span>
                <span class="n">let</span> <span class="n">args</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">mapi</span> <span class="p">(</span><span class="n">fun</span> <span class="n">i</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">let</span> <span class="n">t</span> <span class="o">=</span> <span class="n">tyv</span> <span class="n">t</span> <span class="ow">in</span> <span class="err">$</span><span class="s2">"</span><span class="si">{t}</span><span class="s2"> * a</span><span class="si">{i}</span><span class="s2">, </span><span class="si">{t}</span><span class="s2"> b</span><span class="si">{i}</span><span class="s2">"</span><span class="p">)</span> <span class="n">x</span><span class="o">.</span><span class="n">tys</span> <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">", "</span>
                <span class="n">line</span> <span class="n">s_fun</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"static inline void AssignMut</span><span class="si">%i</span><span class="s2">(</span><span class="si">%s</span><span class="s2">){"</span> <span class="n">x</span><span class="o">.</span><span class="n">tag</span> <span class="n">args</span><span class="p">)</span>
                <span class="n">let</span> <span class="n">_</span> <span class="o">=</span>
                    <span class="n">let</span> <span class="n">s_fun</span> <span class="o">=</span> <span class="n">indent</span> <span class="n">s_fun</span>
                    <span class="n">refc_change</span> <span class="p">(</span><span class="n">fun</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"b</span><span class="si">{i}</span><span class="s2">"</span><span class="p">)</span> <span class="mi">1</span> <span class="n">tyvs</span> <span class="o">|&gt;</span> <span class="n">line</span><span class="s1">' s_fun</span>
                    <span class="n">refc_change</span> <span class="p">(</span><span class="n">fun</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"*a</span><span class="si">{i}</span><span class="s2">"</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span> <span class="n">tyvs</span> <span class="o">|&gt;</span> <span class="n">line</span><span class="s1">' s_fun</span>
                    <span class="n">Array</span><span class="o">.</span><span class="n">init</span> <span class="n">tyvs</span><span class="o">.</span><span class="n">Length</span> <span class="p">(</span><span class="n">fun</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"*a</span><span class="si">{i}</span><span class="s2"> = b</span><span class="si">{i}</span><span class="s2">;"</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">line</span><span class="s1">' s_fun</span>
                <span class="n">line</span> <span class="n">s_fun</span> <span class="s2">"}"</span>
                <span class="p">)</span>
        <span class="ow">and</span> <span class="n">assign_array</span> <span class="p">:</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">TupleRecC</span> <span class="o">=</span> 
            <span class="nb">tuple</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="n">s_typ</span> <span class="n">s_fun</span> <span class="n">x</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">tyvs</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">mapi</span> <span class="p">(</span><span class="n">fun</span> <span class="n">i</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">t</span><span class="p">))</span> <span class="n">x</span><span class="o">.</span><span class="n">tys</span><span class="p">,</span> <span class="n">tup_ty_tys</span> <span class="n">x</span><span class="o">.</span><span class="n">tys</span>
                <span class="n">line</span> <span class="n">s_fun</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"static inline void AssignArray</span><span class="si">%i</span><span class="s2">(</span><span class="si">%s</span><span class="s2"> * a, </span><span class="si">%s</span><span class="s2"> b){"</span> <span class="n">x</span><span class="o">.</span><span class="n">tag</span> <span class="n">T</span> <span class="n">T</span><span class="p">)</span>
                <span class="n">let</span> <span class="n">_</span> <span class="o">=</span>
                    <span class="n">let</span> <span class="n">s_fun</span> <span class="o">=</span> <span class="n">indent</span> <span class="n">s_fun</span>
                    <span class="k">match</span> <span class="n">tyvs</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="p">[</span><span class="o">||</span><span class="p">]</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="s2">"Compiler error: Void types not allowed in assign."</span>
                    <span class="o">|</span> <span class="p">[</span><span class="o">|</span><span class="n">t</span><span class="o">|</span><span class="p">]</span> <span class="o">-&gt;</span> 
                        <span class="n">refc_change</span> <span class="p">(</span><span class="n">fun</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="s2">"b"</span><span class="p">)</span> <span class="mi">1</span> <span class="n">tyvs</span> <span class="o">|&gt;</span> <span class="n">line</span><span class="s1">' s_fun</span>
                        <span class="n">refc_change</span> <span class="p">(</span><span class="n">fun</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="s2">"*a"</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span> <span class="n">tyvs</span> <span class="o">|&gt;</span> <span class="n">line</span><span class="s1">' s_fun</span>
                        <span class="err">$</span><span class="s2">"*a = b;"</span> <span class="o">|&gt;</span> <span class="n">line</span> <span class="n">s_fun</span>
                    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span>
                        <span class="n">refc_change</span> <span class="p">(</span><span class="n">fun</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"b.v</span><span class="si">{i}</span><span class="s2">"</span><span class="p">)</span> <span class="mi">1</span> <span class="n">tyvs</span> <span class="o">|&gt;</span> <span class="n">line</span><span class="s1">' s_fun</span>
                        <span class="n">refc_change</span> <span class="p">(</span><span class="n">fun</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"a-&gt;v</span><span class="si">{i}</span><span class="s2">"</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span> <span class="n">tyvs</span> <span class="o">|&gt;</span> <span class="n">line</span><span class="s1">' s_fun</span>
                        <span class="err">$</span><span class="s2">"*a = b;"</span> <span class="o">|&gt;</span> <span class="n">line</span> <span class="n">s_fun</span>
                <span class="n">line</span> <span class="n">s_fun</span> <span class="s2">"}"</span>
                <span class="p">)</span>
        <span class="ow">and</span> <span class="n">layout_tmpl</span> <span class="n">name</span> <span class="p">:</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">LayoutRecC</span> <span class="o">=</span>
            <span class="n">layout</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="n">s_typ</span> <span class="n">s_fun</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">LayoutRecC</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">i</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">tag</span>
                <span class="n">let</span> <span class="n">name</span><span class="s1">' = sprintf "</span><span class="si">%s%i</span><span class="s1">" name i</span>

                <span class="n">line</span> <span class="n">s_typ</span> <span class="s2">"typedef struct {"</span>
                <span class="n">let</span> <span class="n">_</span> <span class="o">=</span>
                    <span class="n">let</span> <span class="n">s_typ</span> <span class="o">=</span> <span class="n">indent</span> <span class="n">s_typ</span>
                    <span class="n">line</span> <span class="n">s_typ</span> <span class="s2">"int refc;"</span>
                    <span class="n">print_ordered_args</span> <span class="n">s_typ</span> <span class="n">x</span><span class="o">.</span><span class="n">free_vars</span>
                <span class="n">line</span> <span class="n">s_typ</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"} </span><span class="si">%s</span><span class="s2">;"</span> <span class="n">name</span><span class="s1">')</span>

                <span class="n">line</span> <span class="n">s_fun</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"static inline void </span><span class="si">%s</span><span class="s2">DecrefBody</span><span class="si">%i</span><span class="s2">(</span><span class="si">%s</span><span class="s2"> * x){"</span> <span class="n">name</span> <span class="n">i</span> <span class="n">name</span><span class="s1">')</span>
                <span class="n">let</span> <span class="n">_</span> <span class="o">=</span>
                    <span class="n">let</span> <span class="n">s_fun</span> <span class="o">=</span> <span class="n">indent</span> <span class="n">s_fun</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">free_vars</span> <span class="o">|&gt;</span> <span class="n">refc_change</span> <span class="p">(</span><span class="n">fun</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"x-&gt;v</span><span class="si">{i}</span><span class="s2">"</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span> <span class="o">|&gt;</span> <span class="n">line</span><span class="s1">' s_fun</span>
                <span class="n">line</span> <span class="n">s_fun</span> <span class="s2">"}"</span>

                <span class="n">print_decref</span> <span class="n">s_fun</span> <span class="err">$</span><span class="s2">"</span><span class="si">{name}</span><span class="s2">Decref</span><span class="si">{i}</span><span class="s2">"</span> <span class="n">name</span><span class="s1">' $"</span><span class="si">{name}</span><span class="s1">DecrefBody</span><span class="si">{i}</span><span class="s1">"</span>

                <span class="n">let</span> <span class="n">args</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">free_vars</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">x</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"{tyv x} v</span><span class="si">{i}</span><span class="s2">"</span><span class="p">)</span>
                <span class="n">line</span> <span class="n">s_fun</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> * </span><span class="si">%s</span><span class="s2">Create</span><span class="si">%i</span><span class="s2">(</span><span class="si">%s</span><span class="s2">){"</span> <span class="n">name</span><span class="s1">' name i (String.concat ", " args))</span>
                <span class="n">let</span> <span class="n">_</span> <span class="o">=</span>
                    <span class="n">let</span> <span class="n">s_fun</span> <span class="o">=</span> <span class="n">indent</span> <span class="n">s_fun</span>
                    <span class="n">line</span> <span class="n">s_fun</span> <span class="err">$</span><span class="s2">"{name'} * x = </span><span class="si">{malloc}</span><span class="s2">(sizeof({name'}));"</span>
                    <span class="n">line</span> <span class="n">s_fun</span> <span class="s2">"x-&gt;refc = 1;"</span>
                    <span class="n">Array</span><span class="o">.</span><span class="n">init</span> <span class="n">args</span><span class="o">.</span><span class="n">Length</span> <span class="p">(</span><span class="n">fun</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"x-&gt;v</span><span class="si">{i}</span><span class="s2"> = v</span><span class="si">{i}</span><span class="s2">;"</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">line</span><span class="s1">' s_fun</span>
                    <span class="n">line</span> <span class="n">s_fun</span> <span class="err">$</span><span class="s2">"return x;"</span>
                <span class="n">line</span> <span class="n">s_fun</span> <span class="s2">"}"</span>
                <span class="p">)</span>
        <span class="ow">and</span> <span class="n">heap</span> <span class="p">:</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">LayoutRecC</span> <span class="o">=</span> <span class="n">layout_tmpl</span> <span class="s2">"Heap"</span>
        <span class="ow">and</span> <span class="n">mut</span> <span class="p">:</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">LayoutRecC</span> <span class="o">=</span> <span class="n">layout_tmpl</span> <span class="s2">"Mut"</span>
        <span class="ow">and</span> <span class="n">union_tmpl</span> <span class="n">is_stack</span> <span class="p">:</span> <span class="n">Union</span> <span class="o">-&gt;</span> <span class="n">UnionRecC</span> <span class="o">=</span> 
            <span class="n">let</span> <span class="n">inline</span> <span class="n">map_iteri</span> <span class="n">f</span> <span class="n">x</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">i</span> <span class="n">k</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">i</span> <span class="n">k</span> <span class="n">v</span><span class="p">;</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="mi">0</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
            <span class="n">union</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s_fwd</span> <span class="n">s_typ</span> <span class="n">s_fun</span> <span class="n">x</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">i</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">tag</span>
                <span class="k">match</span> <span class="n">is_stack</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">true</span>  <span class="o">-&gt;</span> <span class="n">line</span> <span class="n">s_typ</span> <span class="s2">"typedef struct {"</span>
                <span class="o">|</span> <span class="n">false</span> <span class="o">-&gt;</span> 
                    <span class="n">line</span> <span class="n">s_fwd</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"typedef struct UH</span><span class="si">%i</span><span class="s2"> UH</span><span class="si">%i</span><span class="s2">;"</span> <span class="n">i</span> <span class="n">i</span><span class="p">)</span>
                    <span class="n">line</span> <span class="n">s_typ</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"struct UH</span><span class="si">%i</span><span class="s2"> {"</span> <span class="n">i</span><span class="p">)</span>
                <span class="n">let</span> <span class="n">_</span> <span class="o">=</span>
                    <span class="n">let</span> <span class="n">s_typ</span> <span class="o">=</span> <span class="n">indent</span> <span class="n">s_typ</span>
                    <span class="k">match</span> <span class="n">is_stack</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">true</span> <span class="o">-&gt;</span> <span class="p">()</span>
                    <span class="o">|</span> <span class="n">false</span> <span class="o">-&gt;</span> <span class="n">line</span> <span class="n">s_typ</span> <span class="s2">"int refc;"</span>
                    <span class="n">line</span> <span class="n">s_typ</span> <span class="s2">"int tag;"</span>
                    <span class="n">line</span> <span class="n">s_typ</span> <span class="s2">"union {"</span>
                    <span class="n">let</span> <span class="n">_</span> <span class="o">=</span>
                        <span class="n">let</span> <span class="n">s_typ</span> <span class="o">=</span> <span class="n">indent</span> <span class="n">s_typ</span>
                        <span class="n">map_iteri</span> <span class="p">(</span><span class="n">fun</span> <span class="n">tag</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="n">v</span> <span class="o">-&gt;</span> 
                            <span class="k">if</span> <span class="n">Array</span><span class="o">.</span><span class="n">isEmpty</span> <span class="n">v</span> <span class="o">=</span> <span class="n">false</span> <span class="n">then</span>
                                <span class="n">line</span> <span class="n">s_typ</span> <span class="s2">"struct {"</span>
                                <span class="n">print_ordered_args</span> <span class="p">(</span><span class="n">indent</span> <span class="n">s_typ</span><span class="p">)</span> <span class="n">v</span>
                                <span class="n">line</span> <span class="n">s_typ</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"} case</span><span class="si">%i</span><span class="s2">; // </span><span class="si">%s</span><span class="s2">"</span> <span class="n">tag</span> <span class="n">k</span><span class="p">)</span>
                            <span class="p">)</span> <span class="n">x</span><span class="o">.</span><span class="n">free_vars</span>
                    <span class="n">line</span> <span class="n">s_typ</span> <span class="s2">"};"</span>
                <span class="k">match</span> <span class="n">is_stack</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">true</span>  <span class="o">-&gt;</span> <span class="n">line</span> <span class="n">s_typ</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"} US</span><span class="si">%i</span><span class="s2">;"</span> <span class="n">i</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">false</span> <span class="o">-&gt;</span> <span class="n">line</span> <span class="n">s_typ</span> <span class="s2">"};"</span>

                <span class="n">let</span> <span class="n">print_refc</span> <span class="n">name</span> <span class="n">typ</span> <span class="n">q</span> <span class="o">=</span>
                    <span class="n">line</span> <span class="n">s_fun</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"static inline void </span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2"> * x){"</span> <span class="n">name</span> <span class="n">typ</span><span class="p">)</span>
                    <span class="n">let</span> <span class="n">_</span> <span class="o">=</span>
                        <span class="n">let</span> <span class="n">s_fun</span> <span class="o">=</span> <span class="n">indent</span> <span class="n">s_fun</span>
                        <span class="n">line</span> <span class="n">s_fun</span> <span class="s2">"switch (x-&gt;tag) {"</span>
                        <span class="n">map_iteri</span> <span class="p">(</span><span class="n">fun</span> <span class="n">tag</span> <span class="n">k</span> <span class="n">v</span> <span class="o">-&gt;</span> 
                            <span class="n">let</span> <span class="n">s_fun</span> <span class="o">=</span> <span class="n">indent</span> <span class="n">s_fun</span>
                            <span class="n">let</span> <span class="n">refc</span> <span class="o">=</span> <span class="n">v</span> <span class="o">|&gt;</span> <span class="n">refc_change</span> <span class="p">(</span><span class="n">fun</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"x-&gt;case</span><span class="si">{tag}</span><span class="s2">.v</span><span class="si">{i}</span><span class="s2">"</span><span class="p">)</span> <span class="n">q</span>
                            <span class="k">if</span> <span class="n">refc</span><span class="o">.</span><span class="n">Length</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">then</span>
                                <span class="n">line</span> <span class="n">s_fun</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"case </span><span class="si">%i</span><span class="s2">: {"</span> <span class="n">tag</span><span class="p">)</span>
                                <span class="n">let</span> <span class="n">_</span> <span class="o">=</span>
                                    <span class="n">let</span> <span class="n">s_fun</span> <span class="o">=</span> <span class="n">indent</span> <span class="n">s_fun</span>
                                    <span class="n">refc</span> <span class="o">|&gt;</span> <span class="n">line</span><span class="s1">' s_fun</span>
                                    <span class="n">line</span> <span class="n">s_fun</span> <span class="s2">"break;"</span>
                                <span class="n">line</span> <span class="n">s_fun</span> <span class="s2">"}"</span>
                            <span class="p">)</span> <span class="n">x</span><span class="o">.</span><span class="n">free_vars</span>
                        <span class="n">line</span> <span class="n">s_fun</span> <span class="s2">"}"</span>
                    <span class="n">line</span> <span class="n">s_fun</span> <span class="s2">"}"</span>

                <span class="k">match</span> <span class="n">is_stack</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">true</span>  <span class="o">-&gt;</span> 
                    <span class="n">print_refc</span> <span class="err">$</span><span class="s2">"USIncrefBody</span><span class="si">{i}</span><span class="s2">"</span> <span class="err">$</span><span class="s2">"US</span><span class="si">{i}</span><span class="s2">"</span> <span class="mi">1</span>
                    <span class="n">print_refc</span> <span class="err">$</span><span class="s2">"USDecrefBody</span><span class="si">{i}</span><span class="s2">"</span> <span class="err">$</span><span class="s2">"US</span><span class="si">{i}</span><span class="s2">"</span> <span class="o">-</span><span class="mi">1</span>
                <span class="o">|</span> <span class="n">false</span> <span class="o">-&gt;</span> <span class="n">print_refc</span> <span class="err">$</span><span class="s2">"UHDecrefBody</span><span class="si">{i}</span><span class="s2">"</span> <span class="err">$</span><span class="s2">"UH</span><span class="si">{i}</span><span class="s2">"</span> <span class="o">-</span><span class="mi">1</span>

                <span class="k">match</span> <span class="n">is_stack</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">true</span>  <span class="o">-&gt;</span> 
                    <span class="n">line</span> <span class="n">s_fun</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"void USIncref</span><span class="si">%i</span><span class="s2">(US</span><span class="si">%i</span><span class="s2"> * x){ USIncrefBody</span><span class="si">%i</span><span class="s2">(x); }"</span> <span class="n">i</span> <span class="n">i</span> <span class="n">i</span><span class="p">)</span>
                    <span class="n">line</span> <span class="n">s_fun</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"void USDecref</span><span class="si">%i</span><span class="s2">(US</span><span class="si">%i</span><span class="s2"> * x){ USDecrefBody</span><span class="si">%i</span><span class="s2">(x); }"</span> <span class="n">i</span> <span class="n">i</span> <span class="n">i</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">false</span> <span class="o">-&gt;</span> 
                    <span class="n">line</span> <span class="n">s_fwd</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"void UHDecref</span><span class="si">%i</span><span class="s2">(UH</span><span class="si">%i</span><span class="s2"> * x);"</span> <span class="n">i</span> <span class="n">i</span><span class="p">)</span>
                    <span class="n">print_decref</span> <span class="n">s_fun</span> <span class="err">$</span><span class="s2">"UHDecref</span><span class="si">{i}</span><span class="s2">"</span> <span class="err">$</span><span class="s2">"UH</span><span class="si">{i}</span><span class="s2">"</span> <span class="err">$</span><span class="s2">"UHDecrefBody</span><span class="si">{i}</span><span class="s2">"</span>
                
                <span class="n">map_iteri</span> <span class="p">(</span><span class="n">fun</span> <span class="n">tag</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="n">v</span> <span class="o">-&gt;</span> 
                    <span class="n">let</span> <span class="n">args</span> <span class="o">=</span> <span class="n">v</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">t</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"{tyv t} v</span><span class="si">{i}</span><span class="s2">"</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">", "</span>
                    <span class="k">if</span> <span class="n">is_stack</span> <span class="n">then</span>
                        <span class="n">line</span> <span class="n">s_fun</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"US</span><span class="si">%i</span><span class="s2"> US</span><span class="si">%i</span><span class="s2">_</span><span class="si">%i</span><span class="s2">(</span><span class="si">%s</span><span class="s2">) { // </span><span class="si">%s</span><span class="s2">"</span> <span class="n">i</span> <span class="n">i</span> <span class="n">tag</span> <span class="n">args</span> <span class="n">k</span><span class="p">)</span>
                        <span class="n">let</span> <span class="n">_</span> <span class="o">=</span>
                            <span class="n">let</span> <span class="n">s_fun</span> <span class="o">=</span> <span class="n">indent</span> <span class="n">s_fun</span>
                            <span class="n">line</span> <span class="n">s_fun</span> <span class="err">$</span><span class="s2">"US</span><span class="si">{i}</span><span class="s2"> x;"</span>
                            <span class="n">line</span> <span class="n">s_fun</span> <span class="err">$</span><span class="s2">"x.tag = </span><span class="si">{tag}</span><span class="s2">;"</span>
                            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">Length</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">then</span>
                                <span class="n">v</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">t</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"x.case</span><span class="si">{tag}</span><span class="s2">.v</span><span class="si">{i}</span><span class="s2"> = v</span><span class="si">{i}</span><span class="s2">;"</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">line</span><span class="s1">' s_fun</span>
                            <span class="n">line</span> <span class="n">s_fun</span> <span class="s2">"return x;"</span>
                        <span class="n">line</span> <span class="n">s_fun</span> <span class="s2">"}"</span>
                    <span class="k">else</span>
                        <span class="n">line</span> <span class="n">s_fun</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"UH</span><span class="si">%i</span><span class="s2"> * UH</span><span class="si">%i</span><span class="s2">_</span><span class="si">%i</span><span class="s2">(</span><span class="si">%s</span><span class="s2">) { // </span><span class="si">%s</span><span class="s2">"</span> <span class="n">i</span> <span class="n">i</span> <span class="n">tag</span> <span class="n">args</span> <span class="n">k</span><span class="p">)</span>
                        <span class="n">let</span> <span class="n">_</span> <span class="o">=</span>
                            <span class="n">let</span> <span class="n">s_fun</span> <span class="o">=</span> <span class="n">indent</span> <span class="n">s_fun</span>
                            <span class="n">line</span> <span class="n">s_fun</span> <span class="err">$</span><span class="s2">"UH</span><span class="si">{i}</span><span class="s2"> * x = </span><span class="si">{malloc}</span><span class="s2">(sizeof(UH</span><span class="si">{i}</span><span class="s2">));"</span>
                            <span class="n">line</span> <span class="n">s_fun</span> <span class="err">$</span><span class="s2">"x-&gt;tag = </span><span class="si">{tag}</span><span class="s2">;"</span>
                            <span class="n">line</span> <span class="n">s_fun</span> <span class="s2">"x-&gt;refc = 1;"</span>
                            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">Length</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">then</span>
                                <span class="n">v</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">t</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"x-&gt;case</span><span class="si">{tag}</span><span class="s2">.v</span><span class="si">{i}</span><span class="s2"> = v</span><span class="si">{i}</span><span class="s2">;"</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">line</span><span class="s1">' s_fun</span>
                            <span class="n">line</span> <span class="n">s_fun</span> <span class="err">$</span><span class="s2">"return x;"</span>
                        <span class="n">line</span> <span class="n">s_fun</span> <span class="s2">"}"</span>
                    <span class="p">)</span> <span class="n">x</span><span class="o">.</span><span class="n">free_vars</span>
                <span class="p">)</span>
        <span class="ow">and</span> <span class="n">ustack</span> <span class="p">:</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">UnionRecC</span> <span class="o">=</span> <span class="n">union_tmpl</span> <span class="n">true</span>
        <span class="ow">and</span> <span class="n">uheap</span> <span class="p">:</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">UnionRecC</span> <span class="o">=</span> <span class="n">union_tmpl</span> <span class="n">false</span>
        <span class="ow">and</span> <span class="n">carray</span> <span class="p">:</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">ArrayRecC</span> <span class="o">=</span>
            <span class="n">carray</span><span class="s1">' (fun _ s_typ s_fun x -&gt;</span>
                <span class="n">let</span> <span class="n">i</span><span class="p">,</span> <span class="n">len_t</span><span class="p">,</span> <span class="n">ptr_t</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">prim</span> <span class="n">size_t</span><span class="p">,</span> <span class="n">tup_ty_tyvs</span> <span class="n">x</span><span class="o">.</span><span class="n">tyvs</span>
                <span class="n">line</span> <span class="n">s_typ</span> <span class="s2">"typedef struct {"</span>
                <span class="n">let</span> <span class="n">_</span> <span class="o">=</span>
                    <span class="n">let</span> <span class="n">s_typ</span> <span class="o">=</span> <span class="n">indent</span> <span class="n">s_typ</span>
                    <span class="n">line</span> <span class="n">s_typ</span> <span class="s2">"int refc;"</span>
                    <span class="n">line</span> <span class="n">s_typ</span> <span class="err">$</span><span class="s2">"</span><span class="si">{len_t}</span><span class="s2"> len;"</span>
                    <span class="k">if</span> <span class="n">ptr_t</span> <span class="o">&lt;&gt;</span> <span class="s2">"void"</span> <span class="n">then</span> <span class="n">line</span> <span class="n">s_typ</span> <span class="err">$</span><span class="s2">"</span><span class="si">{ptr_t}</span><span class="s2"> ptr[];"</span> <span class="o">//</span> <span class="n">flexible</span> <span class="n">array</span> <span class="n">member</span>
                <span class="n">line</span> <span class="n">s_typ</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"} Array</span><span class="si">%i</span><span class="s2">;"</span> <span class="n">i</span><span class="p">)</span>


                <span class="n">let</span> <span class="n">print_body</span> <span class="n">p</span> <span class="n">s_fun</span> <span class="n">q</span> <span class="o">=</span>
                    <span class="n">let</span> <span class="n">refcs</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">tyvs</span> <span class="o">|&gt;</span> <span class="n">refc_change</span> <span class="p">(</span><span class="n">fun</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">x</span><span class="o">.</span><span class="n">tyvs</span><span class="o">.</span><span class="n">Length</span> <span class="n">then</span> <span class="err">$</span><span class="s2">"v.v</span><span class="si">{i}</span><span class="s2">"</span> <span class="k">else</span> <span class="s2">"v"</span><span class="p">)</span> <span class="n">q</span>
                    <span class="k">if</span> <span class="n">refcs</span><span class="o">.</span><span class="n">Length</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">then</span>
                        <span class="n">p</span><span class="p">()</span>
                        <span class="n">line</span> <span class="n">s_fun</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"for (</span><span class="si">%s</span><span class="s2"> i=0; i &lt; len; i++){"</span> <span class="n">len_t</span><span class="p">)</span>
                        <span class="n">let</span> <span class="n">_</span> <span class="o">=</span>
                            <span class="n">let</span> <span class="n">s_fun</span> <span class="o">=</span> <span class="n">indent</span> <span class="n">s_fun</span>
                            <span class="n">line</span> <span class="n">s_fun</span> <span class="err">$</span><span class="s2">"</span><span class="si">{ptr_t}</span><span class="s2"> v = ptr[i];"</span>
                            <span class="n">refcs</span> <span class="o">|&gt;</span> <span class="n">line</span><span class="s1">' s_fun</span>
                        <span class="n">line</span> <span class="n">s_fun</span> <span class="s2">"}"</span>

                <span class="n">line</span> <span class="n">s_fun</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"static inline void ArrayDecrefBody</span><span class="si">%i</span><span class="s2">(Array</span><span class="si">%i</span><span class="s2"> * x){"</span> <span class="n">i</span> <span class="n">i</span><span class="p">)</span>
                <span class="n">let</span> <span class="n">_</span> <span class="o">=</span>
                    <span class="n">let</span> <span class="n">s_fun</span> <span class="o">=</span> <span class="n">indent</span> <span class="n">s_fun</span>
                    <span class="n">print_body</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span>
                        <span class="n">line</span> <span class="n">s_fun</span> <span class="err">$</span><span class="s2">"</span><span class="si">{len_t}</span><span class="s2"> len = x-&gt;len;"</span>
                        <span class="n">line</span> <span class="n">s_fun</span> <span class="err">$</span><span class="s2">"</span><span class="si">{ptr_t}</span><span class="s2"> * ptr = x-&gt;ptr;"</span>
                        <span class="p">)</span> <span class="n">s_fun</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">line</span> <span class="n">s_fun</span> <span class="s2">"}"</span>

                <span class="n">print_decref</span> <span class="n">s_fun</span> <span class="err">$</span><span class="s2">"ArrayDecref</span><span class="si">{i}</span><span class="s2">"</span> <span class="err">$</span><span class="s2">"Array</span><span class="si">{i}</span><span class="s2">"</span> <span class="err">$</span><span class="s2">"ArrayDecrefBody</span><span class="si">{i}</span><span class="s2">"</span>
                
                <span class="n">line</span> <span class="n">s_fun</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"Array</span><span class="si">%i</span><span class="s2"> * ArrayCreate</span><span class="si">%i</span><span class="s2">(</span><span class="si">%s</span><span class="s2"> len, bool init_at_zero){"</span> <span class="n">i</span> <span class="n">i</span> <span class="n">len_t</span><span class="p">)</span>
                <span class="n">let</span> <span class="n">_</span> <span class="o">=</span>
                    <span class="n">let</span> <span class="n">s_fun</span> <span class="o">=</span> <span class="n">indent</span> <span class="n">s_fun</span>
                    <span class="k">match</span> <span class="n">ptr_t</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="s2">"void"</span> <span class="o">-&gt;</span> <span class="n">line</span> <span class="n">s_fun</span> <span class="err">$</span><span class="s2">"</span><span class="si">{len_t}</span><span class="s2"> size = sizeof(Array</span><span class="si">{i}</span><span class="s2">);"</span>
                    <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">line</span> <span class="n">s_fun</span> <span class="err">$</span><span class="s2">"</span><span class="si">{len_t}</span><span class="s2"> size = sizeof(Array</span><span class="si">{i}</span><span class="s2">) + sizeof(</span><span class="si">{ptr_t}</span><span class="s2">) * len;"</span>
                    <span class="n">line</span> <span class="n">s_fun</span> <span class="err">$</span><span class="s2">"Array</span><span class="si">{i}</span><span class="s2"> * x = </span><span class="si">{malloc}</span><span class="s2">(size);"</span>
                    <span class="n">line</span> <span class="n">s_fun</span> <span class="s2">"if (init_at_zero) { memset(x,0,size); }"</span>
                    <span class="n">line</span> <span class="n">s_fun</span> <span class="s2">"x-&gt;refc = 1;"</span>
                    <span class="n">line</span> <span class="n">s_fun</span> <span class="s2">"x-&gt;len = len;"</span>
                    <span class="n">line</span> <span class="n">s_fun</span> <span class="s2">"return x;"</span>
                <span class="n">line</span> <span class="n">s_fun</span> <span class="s2">"}"</span>

                <span class="n">line</span> <span class="n">s_fun</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"Array</span><span class="si">%i</span><span class="s2"> * ArrayLit</span><span class="si">%i</span><span class="s2">(</span><span class="si">%s</span><span class="s2"> len, </span><span class="si">%s</span><span class="s2"> * ptr){"</span> <span class="n">i</span> <span class="n">i</span> <span class="n">len_t</span> <span class="n">ptr_t</span><span class="p">)</span>
                <span class="n">let</span> <span class="n">_</span> <span class="o">=</span>
                    <span class="n">let</span> <span class="n">s_fun</span> <span class="o">=</span> <span class="n">indent</span> <span class="n">s_fun</span>
                    <span class="n">line</span> <span class="n">s_fun</span> <span class="err">$</span><span class="s2">"Array</span><span class="si">{i}</span><span class="s2"> * x = ArrayCreate</span><span class="si">{i}</span><span class="s2">(len, false);"</span>
                    <span class="k">if</span> <span class="n">ptr_t</span> <span class="o">&lt;&gt;</span> <span class="s2">"void"</span> <span class="n">then</span> 
                        <span class="n">line</span> <span class="n">s_fun</span> <span class="err">$</span><span class="s2">"memcpy(x-&gt;ptr, ptr, sizeof(</span><span class="si">{ptr_t}</span><span class="s2">) * len);"</span>
                        <span class="n">print_body</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="p">())</span> <span class="p">(</span><span class="n">indent</span> <span class="n">s_fun</span><span class="p">)</span> <span class="mi">1</span>
                    <span class="n">line</span> <span class="n">s_fun</span> <span class="s2">"return x;"</span>
                <span class="n">line</span> <span class="n">s_fun</span> <span class="s2">"}"</span>
                <span class="p">)</span>
        <span class="ow">and</span> <span class="n">cstring</span> <span class="p">:</span> <span class="n">unit</span> <span class="o">-&gt;</span> <span class="n">unit</span> <span class="o">=</span>
            <span class="n">cstring</span><span class="s1">' (fun _ s_typ s_fun () -&gt;</span>
                <span class="n">let</span> <span class="n">char</span> <span class="o">=</span> <span class="n">YPrim</span> <span class="n">CharT</span>
                <span class="n">let</span> <span class="n">size_t</span><span class="p">,</span> <span class="n">ptr_t</span><span class="p">,</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">prim</span> <span class="n">size_t</span><span class="p">,</span> <span class="n">tyv</span> <span class="n">char</span><span class="p">,</span> <span class="p">(</span><span class="n">carray</span> <span class="n">char</span><span class="p">)</span><span class="o">.</span><span class="n">tag</span>
                <span class="n">line</span> <span class="n">s_typ</span> <span class="err">$</span><span class="s2">"typedef Array</span><span class="si">{tag}</span><span class="s2"> String;"</span>

                <span class="n">line</span> <span class="n">s_fun</span> <span class="s2">"static inline void StringDecref(String * x){"</span>
                <span class="n">line</span> <span class="p">(</span><span class="n">indent</span> <span class="n">s_fun</span><span class="p">)</span> <span class="err">$</span><span class="s2">"return ArrayDecref</span><span class="si">{tag}</span><span class="s2">(x);"</span>
                <span class="n">line</span> <span class="n">s_fun</span> <span class="s2">"}"</span>

                <span class="n">line</span> <span class="n">s_fun</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"static inline String * StringLit(</span><span class="si">%s</span><span class="s2"> len, </span><span class="si">%s</span><span class="s2"> * ptr){"</span> <span class="n">size_t</span> <span class="n">ptr_t</span><span class="p">)</span>
                <span class="n">line</span> <span class="p">(</span><span class="n">indent</span> <span class="n">s_fun</span><span class="p">)</span> <span class="err">$</span><span class="s2">"return ArrayLit</span><span class="si">{tag}</span><span class="s2">(len, ptr);"</span>
                <span class="n">line</span> <span class="n">s_fun</span> <span class="s2">"}"</span>
                <span class="p">)</span>

        <span class="k">match</span> <span class="n">binds_last_dataC</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">data_term_vars</span> <span class="o">|&gt;</span> <span class="n">term_vars_to_tysC</span> <span class="k">with</span>
        <span class="o">|</span> <span class="p">[</span><span class="o">|</span><span class="n">YPrim</span> <span class="n">Int32T</span><span class="o">|</span><span class="p">]</span> <span class="o">-&gt;</span>
            <span class="kn">import</span> <span class="s2">"stdbool.h"</span>
            <span class="kn">import</span> <span class="s2">"stdint.h"</span>
            <span class="kn">import</span> <span class="s2">"stdio.h"</span>
            <span class="kn">import</span> <span class="s2">"stdlib.h"</span>

            <span class="n">let</span> <span class="n">main_defs</span> <span class="o">=</span> <span class="p">{</span><span class="n">text</span><span class="o">=</span><span class="n">System</span><span class="o">.</span><span class="n">Text</span><span class="o">.</span><span class="n">StringBuilder</span><span class="p">();</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">}</span>
            <span class="kn">import</span> <span class="s2">"string.h"</span> <span class="o">//</span> <span class="k">for</span> <span class="n">memcpy</span>

            <span class="n">line</span> <span class="n">main_defs</span> <span class="p">(</span><span class="n">sprintf</span> <span class="s2">"</span><span class="si">%s</span><span class="s2"> main(){"</span> <span class="p">(</span><span class="n">prim</span> <span class="n">Int32T</span><span class="p">))</span>
            <span class="n">binds_start</span> <span class="p">[</span><span class="o">||</span><span class="p">]</span> <span class="p">(</span><span class="n">indent</span> <span class="n">main_defs</span><span class="p">)</span> <span class="n">x</span>
            <span class="n">line</span> <span class="n">main_defs</span> <span class="s2">"}"</span>

            <span class="n">let</span> <span class="n">program</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Text</span><span class="o">.</span><span class="n">StringBuilder</span><span class="p">()</span>

            <span class="nb">globals</span> <span class="o">|&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">program</span><span class="o">.</span><span class="n">AppendLine</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">ignore</span><span class="p">)</span>
            <span class="n">fwd_dcls</span> <span class="o">|&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">program</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">ignore</span><span class="p">)</span>
            <span class="n">types</span> <span class="o">|&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">program</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">ignore</span><span class="p">)</span>
            <span class="n">functions</span> <span class="o">|&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">program</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">ignore</span><span class="p">)</span>
            <span class="n">program</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="n">main_defs</span><span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">ToString</span><span class="p">()</span>
        <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span>
            <span class="n">raise_codegen_error</span> <span class="s2">"The return type of main in the C backend should be a 32-bit int."</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=55">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="CodegenCuda">CodegenCuda<a class="anchor-link" href="#CodegenCuda"></a></h2>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=56">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">module</span> <span class="n">CodegenCuda</span> <span class="o">=</span>
    <span class="o">//</span> <span class="nb">open</span> <span class="n">System</span>
    <span class="o">//</span> <span class="nb">open</span> <span class="n">System</span><span class="o">.</span><span class="n">Text</span>
    <span class="nb">open</span> <span class="n">System</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">Generic</span>

    <span class="n">let</span> <span class="n">private</span> <span class="n">backend_nameCuda</span> <span class="o">=</span> <span class="s2">"Cuda"</span>
    <span class="n">let</span> <span class="n">private</span> <span class="n">max_tag</span> <span class="o">=</span> <span class="mi">255</span><span class="n">uy</span>

    <span class="n">let</span> <span class="n">is_stringCuda</span> <span class="o">=</span> <span class="n">function</span> <span class="n">DV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">YPrim</span> <span class="n">StringT</span><span class="p">))</span> <span class="o">|</span> <span class="n">DLit</span><span class="p">(</span><span class="n">LitString</span> <span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">true</span> <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">false</span>
    <span class="n">let</span> <span class="n">sizeof_tyvCuda</span> <span class="o">=</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">YPrim</span> <span class="p">(</span><span class="n">Int64T</span> <span class="o">|</span> <span class="n">UInt64T</span> <span class="o">|</span> <span class="n">Float64T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="mi">8</span>
        <span class="o">|</span> <span class="n">YPrim</span> <span class="p">(</span><span class="n">Int32T</span> <span class="o">|</span> <span class="n">UInt32T</span> <span class="o">|</span> <span class="n">Float32T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="mi">4</span>
        <span class="o">|</span> <span class="n">YPrim</span> <span class="p">(</span><span class="n">Int16T</span> <span class="o">|</span> <span class="n">UInt16T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="mi">2</span>
        <span class="o">|</span> <span class="n">YPrim</span> <span class="p">(</span><span class="n">Int8T</span> <span class="o">|</span> <span class="n">UInt8T</span> <span class="o">|</span> <span class="n">CharT</span> <span class="o">|</span> <span class="n">BoolT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="mi">1</span>
        <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="mi">8</span>
    <span class="n">let</span> <span class="n">order_args</span> <span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">sortWith</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">t</span><span class="p">))</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">t</span><span class="s1">')) -&gt; compare (sizeof_tyvCuda t'</span><span class="p">)</span> <span class="p">(</span><span class="n">sizeof_tyvCuda</span> <span class="n">t</span><span class="p">))</span>
    <span class="n">let</span> <span class="n">lineCuda</span> <span class="n">x</span> <span class="n">s</span> <span class="o">=</span> <span class="k">if</span> <span class="n">s</span> <span class="o">&lt;&gt;</span> <span class="s2">""</span> <span class="n">then</span> <span class="n">x</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="s1">' '</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">indent</span><span class="p">)</span><span class="o">.</span><span class="n">AppendLine</span> <span class="n">s</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
    <span class="n">let</span> <span class="n">lineCuda</span><span class="s1">' x s = line x (String.concat " " s)</span>

    <span class="nb">type</span> <span class="n">BindsReturnCuda</span> <span class="o">=</span>
        <span class="o">|</span> <span class="n">BindsTailEnd</span>
        <span class="o">|</span> <span class="n">BindsLocal</span> <span class="n">of</span> <span class="n">TyV</span> <span class="p">[]</span>

    <span class="n">let</span> <span class="n">term_vars_to_tysCuda</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">function</span> <span class="n">WV</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">t</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">t</span> <span class="o">|</span> <span class="n">WLit</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">YPrim</span> <span class="p">(</span><span class="n">lit_to_primitive_type</span> <span class="n">x</span><span class="p">))</span>
    <span class="n">let</span> <span class="n">binds_last_dataCuda</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">last</span> <span class="o">|&gt;</span> <span class="n">function</span> <span class="n">TyLocalReturnData</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">|</span> <span class="n">TyLocalReturnOp</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="o">|</span> <span class="n">TyLet</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">raise_codegen_error</span> <span class="s2">"Compiler error: Cannot find the return data of the last bind."</span>

    <span class="nb">type</span> <span class="n">LayoutRecCuda</span> <span class="o">=</span> <span class="p">{</span><span class="n">tag</span> <span class="p">:</span> <span class="nb">int</span><span class="p">;</span> <span class="n">data</span> <span class="p">:</span> <span class="n">Data</span><span class="p">;</span> <span class="n">free_vars</span> <span class="p">:</span> <span class="n">TyV</span><span class="p">[];</span> <span class="n">free_vars_by_key</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="nb">int</span> <span class="o">*</span> <span class="n">string</span><span class="p">,</span> <span class="n">TyV</span><span class="p">[]</span><span class="o">&gt;</span><span class="p">}</span>
    <span class="nb">type</span> <span class="n">UnionRecCuda</span> <span class="o">=</span> <span class="p">{</span><span class="n">tag</span> <span class="p">:</span> <span class="nb">int</span><span class="p">;</span> <span class="n">free_vars</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="nb">int</span> <span class="o">*</span> <span class="n">string</span><span class="p">,</span> <span class="n">TyV</span><span class="p">[]</span><span class="o">&gt;</span><span class="p">;</span> <span class="n">is_heap</span> <span class="p">:</span> <span class="nb">bool</span><span class="p">}</span>
    <span class="nb">type</span> <span class="n">MethodRecCuda</span> <span class="o">=</span> <span class="p">{</span><span class="n">tag</span> <span class="p">:</span> <span class="nb">int</span><span class="p">;</span> <span class="n">free_vars</span> <span class="p">:</span> <span class="n">TyV</span><span class="p">[];</span> <span class="nb">range</span> <span class="p">:</span> <span class="n">Ty</span><span class="p">;</span> <span class="n">body</span> <span class="p">:</span> <span class="n">TypedBind</span><span class="p">[];</span> <span class="n">name</span> <span class="p">:</span> <span class="n">string</span> <span class="n">option</span><span class="p">}</span>
    <span class="nb">type</span> <span class="n">ClosureRecCuda</span> <span class="o">=</span> <span class="p">{</span><span class="n">tag</span> <span class="p">:</span> <span class="nb">int</span><span class="p">;</span> <span class="n">free_vars</span> <span class="p">:</span> <span class="n">TyV</span><span class="p">[];</span> <span class="n">domain</span> <span class="p">:</span> <span class="n">Ty</span><span class="p">;</span> <span class="nb">range</span> <span class="p">:</span> <span class="n">Ty</span><span class="p">;</span> <span class="n">funtype</span> <span class="p">:</span> <span class="n">FunType</span><span class="p">;</span> <span class="n">body</span> <span class="p">:</span> <span class="n">TypedBind</span><span class="p">[]}</span>
    <span class="nb">type</span> <span class="n">TupleRecCuda</span> <span class="o">=</span> <span class="p">{</span><span class="n">tag</span> <span class="p">:</span> <span class="nb">int</span><span class="p">;</span> <span class="n">tys</span> <span class="p">:</span> <span class="n">Ty</span> <span class="p">[]}</span>
    <span class="nb">type</span> <span class="n">CFunRecCuda</span> <span class="o">=</span> <span class="p">{</span><span class="n">tag</span> <span class="p">:</span> <span class="nb">int</span><span class="p">;</span> <span class="n">domain</span> <span class="p">:</span> <span class="n">Ty</span><span class="p">;</span> <span class="nb">range</span> <span class="p">:</span> <span class="n">Ty</span><span class="p">;</span> <span class="n">funtype</span> <span class="p">:</span> <span class="n">FunType</span><span class="p">}</span>

    <span class="o">//</span><span class="n">let</span> <span class="n">size_t</span> <span class="o">=</span> <span class="n">UInt32T</span>

    <span class="o">//</span> <span class="n">Replaces</span> <span class="n">the</span> <span class="n">invalid</span> <span class="n">symbols</span> <span class="ow">in</span> <span class="n">Spiral</span> <span class="n">method</span> <span class="n">names</span> <span class="k">for</span> <span class="n">the</span> <span class="n">C</span> <span class="n">backend</span><span class="o">.</span>
    <span class="n">let</span> <span class="n">fix_method_name</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">string</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">Replace</span><span class="p">(</span><span class="s1">''','_') + "_"</span>

<span class="s1">    let unroll_pop (s : Stack&lt;int&gt;) = if s.Count &gt; 0 then s.Pop() else -1</span>
<span class="s1">    let unroll_peek (s : Stack&lt;int&gt;) = if s.Count &gt; 0 then s.Peek() else -1</span>

<span class="s1">    let lit_stringCuda x =</span>
<span class="s1">        let strb = System.Text.StringBuilder(String.length x + 2)</span>
<span class="s1">        strb.Append '"' |&gt; ignore</span>
<span class="s1">        String.iter (function</span>
<span class="s1">            | '"' -&gt; strb.Append "</span><span class="se">\\\"</span><span class="s1">" </span>
<span class="s1">            | '</span><span class="se">\b</span><span class="s1">' -&gt; strb.Append @"</span><span class="se">\b</span><span class="s1">"</span>
<span class="s1">            | '</span><span class="se">\t</span><span class="s1">' -&gt; strb.Append @"</span><span class="se">\t</span><span class="s1">"</span>
<span class="s1">            | '</span><span class="se">\n</span><span class="s1">' -&gt; strb.Append @"</span><span class="se">\n</span><span class="s1">"</span>
<span class="s1">            | '</span><span class="se">\r</span><span class="s1">' -&gt; strb.Append @"</span><span class="se">\r</span><span class="s1">"</span>
<span class="s1">            | '</span><span class="se">\\</span><span class="s1">' -&gt; strb.Append @"</span><span class="se">\\</span><span class="s1">"</span>
<span class="s1">            | x -&gt; strb.Append x</span>
<span class="s1">            &gt;&gt; ignore </span>
<span class="s1">            ) x</span>
<span class="s1">        strb.Append '"' |&gt; ignore</span>
<span class="s1">        strb.ToString()</span>

<span class="s1">    let codegenCuda (default_env : DefaultEnv) (globals : _ ResizeArray, fwd_dcls : _ ResizeArray, types : _ ResizeArray, functions : _ ResizeArray, main_defs : _ ResizeArray) (env : PartEvalResult) =</span>
<span class="s1">        let print show r =</span>
<span class="s1">            let s_typ_fwd = {text=System.Text.StringBuilder(); indent=0}</span>
<span class="s1">            let s_typ = {text=System.Text.StringBuilder(); indent=0}</span>
<span class="s1">            let s_fun = {text=System.Text.StringBuilder(); indent=0}</span>
<span class="s1">            show s_typ_fwd s_typ s_fun r</span>
<span class="s1">            let f (a : _ ResizeArray) (b : CodegenEnv) = </span>
<span class="s1">                let text = b.text.ToString()</span>
<span class="s1">                if text &lt;&gt; "" then a.Add(text)</span>
<span class="s1">            f fwd_dcls s_typ_fwd</span>
<span class="s1">            f types s_typ</span>
<span class="s1">            f functions s_fun</span>

<span class="s1">        let layout show =</span>
<span class="s1">            let dict' = Dictionary(HashIdentity.Structural)</span>
<span class="s1">            let dict = Dictionary(HashIdentity.Reference)</span>
<span class="s1">            let f x : LayoutRecCuda = </span>
<span class="s1">                match x with</span>
<span class="s1">                | YLayout(x,_) -&gt;</span>
<span class="s1">                let x = env.ty_to_data x</span>
<span class="s1">                let a, b =</span>
<span class="s1">                    match x with</span>
<span class="s1">                    | DRecord a -&gt; let a = Map.map (fun _ -&gt; data_free_vars) a in a |&gt; Map.toArray |&gt; Array.collect snd, a</span>
<span class="s1">                    | _ -&gt; data_free_vars x, Map.empty</span>
<span class="s1">                {data=x; free_vars=a; free_vars_by_key=b; tag=dict'.Count}</span>
<span class="s1">                | _ -&gt; raise_codegen_error $"Compiler error: Expected a layout type (1).</span><span class="se">\n</span><span class="s1">Got: </span><span class="si">%s</span><span class="s1">{show_ty x}"</span>
<span class="s1">            fun x -&gt;</span>
<span class="s1">                let mutable dirty = false</span>
<span class="s1">                let r = memoize dict (memoize dict' (fun x -&gt; dirty &lt;- true; f x)) x</span>
<span class="s1">                if dirty then print show r</span>
<span class="s1">                r</span>

<span class="s1">        let union show =</span>
<span class="s1">            let dict = Dictionary(HashIdentity.Reference)</span>
<span class="s1">            let f (a : Union) : UnionRecCuda = </span>
<span class="s1">                let free_vars = a.Item.cases |&gt; Map.map (fun _ -&gt; env.ty_to_data &gt;&gt; data_free_vars)</span>
<span class="s1">                {free_vars=free_vars; tag=dict.Count; is_heap=a.Item.layout = UHeap}</span>
<span class="s1">            fun x -&gt;</span>
<span class="s1">                let mutable dirty = false</span>
<span class="s1">                let r = memoize dict (fun x -&gt; dirty &lt;- true; f x) x</span>
<span class="s1">                if dirty then print show r</span>
<span class="s1">                r</span>

<span class="s1">        let jp f show =</span>
<span class="s1">            let dict = Dictionary(HashIdentity.Structural)</span>
<span class="s1">            let f x = f (x, dict.Count)</span>
<span class="s1">            fun x -&gt;</span>
<span class="s1">                let mutable dirty = false</span>
<span class="s1">                let r = memoize dict (fun x -&gt; dirty &lt;- true; f x) x</span>
<span class="s1">                if dirty then print show r</span>
<span class="s1">                r</span>

<span class="s1">        let tuple show =</span>
<span class="s1">            let dict = Dictionary(HashIdentity.Structural)</span>
<span class="s1">            let f x = {tag=dict.Count; tys=x}</span>
<span class="s1">            fun x -&gt;</span>
<span class="s1">                let mutable dirty = false</span>
<span class="s1">                let r = memoize dict (fun x -&gt; dirty &lt;- true; f x) x</span>
<span class="s1">                if dirty then print show r</span>
<span class="s1">                r</span>

<span class="s1">        let cfun' show =</span>
<span class="s1">            let dict = Dictionary(HashIdentity.Structural)</span>
<span class="s1">            let f (a : Ty, b : Ty, t : FunType) = {tag=dict.Count; domain=a; range=b; funtype=t}</span>
<span class="s1">            fun x -&gt;</span>
<span class="s1">                let mutable dirty = false</span>
<span class="s1">                let r = memoize dict (fun x -&gt; dirty &lt;- true; f x) x</span>
<span class="s1">                if dirty then print show r</span>
<span class="s1">                r</span>

<span class="s1">        let args x = x |&gt; Array.map (fun (L(i,_)) -&gt; sprintf "v</span><span class="si">%i</span><span class="s1">" i) |&gt; String.concat ", "</span>

<span class="s1">        let tmp =</span>
<span class="s1">            let mutable i = 0u</span>
<span class="s1">            fun () -&gt; let x = i in i &lt;- i + 1u; x</span>

<span class="s1">        let global' =</span>
<span class="s1">            let has_added = HashSet()</span>
<span class="s1">            fun x -&gt; if has_added.Add(x) then globals.Add x</span>

<span class="s1">        let import x = global' $"#include &lt;</span><span class="si">{x}</span><span class="s1">&gt;"</span>
<span class="s1">        let import' x = global' $"#include </span><span class="se">\"</span><span class="si">{x}</span><span class="se">\"</span><span class="s1">"</span>

<span class="s1">        let tyvs_to_tys (x : TyV []) = Array.map (fun (L(i,t)) -&gt; t) x</span>

<span class="s1">        let rec binds_start (s : CodegenEnv) (x : TypedBind []) = binds (Stack()) s BindsTailEnd x</span>
<span class="s1">        and return_local s ret (x : string) = </span>
<span class="s1">            match ret with</span>
<span class="s1">            | [||] -&gt; line s $"</span><span class="si">{x}</span><span class="s1">;"</span>
<span class="s1">            | [|L(i,_)|] -&gt; line s $"v</span><span class="si">{i}</span><span class="s1"> = </span><span class="si">{x}</span><span class="s1">;"</span>
<span class="s1">            | ret -&gt;</span>
<span class="s1">                let tmp_i = tmp()</span>
<span class="s1">                line s $"{tup_ty_tyvs ret} tmp</span><span class="si">{tmp_i}</span><span class="s1"> = </span><span class="si">{x}</span><span class="s1">;"</span>
<span class="s1">                Array.mapi (fun i (L(i',_)) -&gt; $"v{i'} = tmp</span><span class="si">{tmp_i}</span><span class="s1">.v</span><span class="si">{i}</span><span class="s1">;") ret |&gt; lineCuda' s</span>
<span class="s1">        and get_layout_rec lay a =</span>
<span class="s1">            match lay with </span>
<span class="s1">            | Heap -&gt; heap a </span>
<span class="s1">            | HeapMutable -&gt; mut a</span>
<span class="s1">            | StackMutable -&gt; stack_mut a</span>
<span class="s1">        and binds (unroll : Stack&lt;int&gt;) (s : CodegenEnv) (ret : BindsReturnCuda) (stmts : TypedBind []) =</span>
<span class="s1">            let tup_destruct (a,b) =</span>
<span class="s1">                Array.map2 (fun (L(i,_)) b -&gt;</span>
<span class="s1">                    match b with</span>
<span class="s1">                    | WLit b -&gt; $"v</span><span class="si">{i}</span><span class="s1"> = {lit b};"</span>
<span class="s1">                    | WV (L(i',_)) -&gt; $"v</span><span class="si">{i}</span><span class="s1"> = v{i'};"</span>
<span class="s1">                    ) a b</span>
<span class="s1">            Array.forall (fun x -&gt;</span>
<span class="s1">                match x with</span>
<span class="s1">                | TyLet(d,trace,a) -&gt;</span>
<span class="s1">                    try let d = data_free_vars d</span>
<span class="s1">                        let decl_vars () = Array.map (fun (L(i,t)) -&gt; $"{tyv t} v</span><span class="si">{i}</span><span class="s1">;") d</span>
<span class="s1">                        let layout_index layout (x'_i : int) (x' : TyV []) = </span>
<span class="s1">                            match layout with</span>
<span class="s1">                            | Heap | HeapMutable -&gt; Array.map2 (fun (L(i,t)) (L(i',_)) -&gt; $"{tyv t} &amp; v</span><span class="si">{i}</span><span class="s1"> = v{x'_i}.base-&gt;v{i'};") d x' |&gt; lineCuda' s</span>
<span class="s1">                            | StackMutable -&gt; Array.map2 (fun (L(i,t)) (L(i',_)) -&gt; $"{tyv t} &amp; v</span><span class="si">{i}</span><span class="s1"> = v{x'_i}.v{i'};") d x' |&gt; lineCuda' s</span>
<span class="s1">                        match a with</span>
<span class="s1">                        | TyToLayout(a,YLayout(_,StackMutable) &amp; b) -&gt;</span>
<span class="s1">                            match d with</span>
<span class="s1">                            | [|L(i,YLayout(_,StackMutable))|] -&gt; // For the regular arrays.</span>
<span class="s1">                                let tag = (stack_mut b).tag</span>
<span class="s1">                                line s $"StackMut</span><span class="si">{tag}</span><span class="s1"> v</span><span class="si">{i}</span><span class="s1">{{{args' a}}};"</span>
<span class="s1">                                true</span>
<span class="s1">                            | _ -&gt;</span>
<span class="s1">                                raise_codegen_error "Compiler error: Expected a stack mutable layout type."</span>
<span class="s1">                        | TyLayoutIndexAll(x) -&gt; </span>
<span class="s1">                            match x with </span>
<span class="s1">                            | L(i,YLayout(_,lay) &amp; a) -&gt; (get_layout_rec lay a).free_vars |&gt; layout_index lay i </span>
<span class="s1">                            | _ -&gt; raise_codegen_error "Compiler error: Expected the TyV in layout index to be a layout type."</span>
<span class="s1">                            true</span>
<span class="s1">                        | TyLayoutIndexByKey(x,key) -&gt; </span>
<span class="s1">                            match x with </span>
<span class="s1">                            | L(i,YLayout(_,lay) &amp; a) -&gt; (get_layout_rec lay a).free_vars_by_key |&gt; Map.pick (fun (_, k') v' -&gt; if key = k' then Some v' else None) |&gt; layout_index lay i </span>
<span class="s1">                            | _ -&gt; raise_codegen_error "Compiler error: Expected the TyV in layout index by key to be a layout type."</span>
<span class="s1">                            true</span>
<span class="s1">                        | TyMacro a -&gt;</span>
<span class="s1">                            let m = a |&gt; List.map (function CMText x -&gt; x | CMTerm x -&gt; tup_data x | CMType x -&gt; tup_ty x | CMTypeLit x -&gt; type_lit x) |&gt; String.concat ""</span>
<span class="s1">                            if m.StartsWith("#pragma") then </span>
<span class="s1">                                line s m</span>
<span class="s1">                                true</span>
<span class="s1">                            elif m = "break" then</span>
<span class="s1">                                line s "break;"</span>
<span class="s1">                                false</span>
<span class="s1">                            elif m.StartsWith("return") then</span>
<span class="s1">                                line s $"</span><span class="si">{m}</span><span class="s1">;"</span>
<span class="s1">                                false</span>
<span class="s1">                            else</span>
<span class="s1">                                let q = m.Split("</span><span class="se">\\</span><span class="s1">v")</span>
<span class="s1">                                if q.Length = 1 then </span>
<span class="s1">                                    decl_vars() |&gt; lineCuda' s</span>
<span class="s1">                                    return_local s d m </span>
<span class="s1">                                    true</span>
<span class="s1">                                else</span>
<span class="s1">                                    if d.Length = q.Length-1 then</span>
<span class="s1">                                        let w = System.Text.StringBuilder(m.Length+8)</span>
<span class="s1">                                        let tag (L(i,_)) = i : int</span>
<span class="s1">                                        Array.iteri (fun i v -&gt; w.Append(q.[i]).Append('v').Append(tag v) |&gt; ignore) d</span>
<span class="s1">                                        w.Append(q.[d.Length]).Append(';').ToString() |&gt; line s</span>
<span class="s1">                                        true</span>
<span class="s1">                                    else</span>
<span class="s1">                                        raise_codegen_error "The special </span><span class="se">\\</span><span class="s1">v macro requires the same number of free vars in its binding as there are </span><span class="se">\\</span><span class="s1">v in the code."</span>
<span class="s1">                        | TyArrayLiteral(a,b') -&gt; </span>
<span class="s1">                            let inits = List.map tup_data b' |&gt; String.concat "," |&gt; sprintf "{</span><span class="si">%s</span><span class="s1">}"</span>
<span class="s1">                            match d with</span>
<span class="s1">                            | [|L(i,YArray t)|] -&gt; // For the regular arrays.</span>
<span class="s1">                                line s $"</span><span class="si">%s</span><span class="s1">{tup_ty t} v</span><span class="si">{i}</span><span class="s1">[] = </span><span class="si">%s{inits}</span><span class="s1">;"</span>
<span class="s1">                                true</span>
<span class="s1">                            | _ -&gt;</span>
<span class="s1">                                raise_codegen_error "Compiler error: Expected a single variable on the left side of an array literal op."</span>
<span class="s1">                        | TyArrayCreate(a,b) -&gt;  </span>
<span class="s1">                            match d with</span>
<span class="s1">                            | [|L(i,YArray t)|] -&gt; </span>
<span class="s1">                                match tup_ty t with</span>
<span class="s1">                                | "void" -&gt; line s "/* void array create */"</span>
<span class="s1">                                | t -&gt; line s $"</span><span class="si">{t}</span><span class="s1"> v</span><span class="si">{i}</span><span class="s1">[{tup_data b}];"</span>
<span class="s1">                                true</span>
<span class="s1">                            | _ -&gt; raise_codegen_error "Compiler error: Expected a single variable on the left side of an array create op."</span>
<span class="s1">                        | TyJoinPoint(JPClosure(a,b),b') -&gt;</span>
<span class="s1">                            match d with</span>
<span class="s1">                            | [|L(i,_)|] -&gt; </span>
<span class="s1">                                let x = closure (a,b)</span>
<span class="s1">                                match x.funtype with</span>
<span class="s1">                                | FT_Pointer -&gt;</span>
<span class="s1">                                    let y = cfun (x.domain,x.range,x.funtype)</span>
<span class="s1">                                    line s $"Fun</span><span class="si">{y.tag}</span><span class="s1"> v</span><span class="si">{i}</span><span class="s1"> = FunPointerMethod</span><span class="si">{x.tag}</span><span class="s1">;"</span>
<span class="s1">                                | FT_Vanilla -&gt;</span>
<span class="s1">                                    let args = args b'</span>
<span class="s1">                                    line s $"Closure</span><span class="si">{x.tag}</span><span class="s1"> v</span><span class="si">{i}</span><span class="s1">{{</span><span class="si">{args}</span><span class="s1">}};"</span>
<span class="s1">                                | FT_Closure -&gt; </span>
<span class="s1">                                    let y = cfun (x.domain,x.range,x.funtype)</span>
<span class="s1">                                    let args = args b'</span>
<span class="s1">                                    line s $"Fun</span><span class="si">{y.tag}</span><span class="s1"> v</span><span class="si">{i}</span><span class="s1">{{new Closure</span><span class="si">{x.tag}</span><span class="s1">{{</span><span class="si">{args}</span><span class="s1">}}}};"</span>
<span class="s1">                                true</span>
<span class="s1">                            | _ -&gt; raise_codegen_error "Compiler error: Expected a single variable on the left side of a closure join point."</span>
<span class="s1">                        | _ -&gt;</span>
<span class="s1">                            decl_vars() |&gt; lineCuda' s</span>
<span class="s1">                            op unroll s (BindsLocal d) a</span>
<span class="s1">                            true</span>
<span class="s1">                    with :? CodegenError as e -&gt; raise_codegen_error' trace (e.Data0, e.Data1)</span>
<span class="s1">                | TyLocalReturnOp(trace,a,_) -&gt;</span>
<span class="s1">                    try op unroll s ret a</span>
<span class="s1">                        true</span>
<span class="s1">                    with :? CodegenError as e -&gt; raise_codegen_error' trace (e.Data0, e.Data1)</span>
<span class="s1">                | TyLocalReturnData(d,trace) -&gt;</span>
<span class="s1">                    try match ret with</span>
<span class="s1">                        | BindsLocal l -&gt; lineCuda' s (tup_destruct (l,data_term_vars d))</span>
<span class="s1">                        | BindsTailEnd -&gt; line s $"return {tup_data d};"</span>
<span class="s1">                        true</span>
<span class="s1">                    with :? CodegenError as e -&gt; raise_codegen_error' trace (e.Data0, e.Data1)</span>
<span class="s1">                ) stmts</span>
<span class="s1">            |&gt; ignore</span>
<span class="s1">        and show_w = function WV(L(i,_)) -&gt; sprintf "v</span><span class="si">%i</span><span class="s1">" i | WLit a -&gt; lit a</span>
<span class="s1">        and args' b = data_term_vars b |&gt; Array.map show_w |&gt; String.concat ", "</span>
<span class="s1">        and tup_term_vars x =</span>
<span class="s1">            let args = Array.map show_w x |&gt; String.concat ", "</span>
<span class="s1">            if 1 &lt; x.Length then sprintf "Tuple</span><span class="si">%i</span><span class="s1">{</span><span class="si">%s</span><span class="s1">}" (tup (term_vars_to_tysCuda x)).tag args else args</span>
<span class="s1">        and tup_data x = tup_term_vars (data_term_vars x)</span>
<span class="s1">        and tup_ty_tys = function</span>
<span class="s1">            | [||] -&gt; "void"</span>
<span class="s1">            | [|x|] -&gt; tyv x</span>
<span class="s1">            | x -&gt; sprintf "Tuple</span><span class="si">%i</span><span class="s1">" (tup x).tag</span>
<span class="s1">        and tup_ty_tyvs (x : TyV []) = tup_ty_tys (tyvs_to_tys x)</span>
<span class="s1">        and tup_ty x = env.ty_to_data x |&gt; data_free_vars |&gt; tup_ty_tyvs</span>
<span class="s1">        and tyv x =</span>
<span class="s1">            match x with</span>
<span class="s1">            | YUnion a -&gt;</span>
<span class="s1">                match a.Item.layout with</span>
<span class="s1">                | UStack -&gt; sprintf "Union</span><span class="si">%i</span><span class="s1">" (unions a).tag</span>
<span class="s1">                | UHeap -&gt; sprintf "sptr&lt;Union</span><span class="si">%i</span><span class="s1">&gt;" (unions a).tag</span>
<span class="s1">            | YLayout(_,lay) as a -&gt; </span>
<span class="s1">                match lay with</span>
<span class="s1">                | Heap -&gt; sprintf "sptr&lt;Heap</span><span class="si">%i</span><span class="s1">&gt;" (heap a).tag</span>
<span class="s1">                | HeapMutable -&gt; sprintf "sptr&lt;Mut</span><span class="si">%i</span><span class="s1">&gt;" (mut a).tag</span>
<span class="s1">                | StackMutable -&gt; sprintf "StackMut</span><span class="si">%i</span><span class="s1"> &amp;" (stack_mut a).tag</span>
<span class="s1">            | YMacro [Text "backend_switch "; Type (YRecord r)] -&gt;</span>
<span class="s1">                match r |&gt; Map.tryPick (fun (_, k) v -&gt; if k = backend_nameCuda then Some v else None) with</span>
<span class="s1">                | Some x -&gt; tup_ty x</span>
<span class="s1">                | None -&gt; raise_codegen_error $"In the backend_switch, expected a record with the '</span><span class="si">{backend_nameCuda}</span><span class="s1">' field."</span>
<span class="s1">            | YMacro a -&gt; a |&gt; List.map (function Text a -&gt; a | Type a -&gt; tup_ty a | TypeLit a -&gt; type_lit a) |&gt; String.concat ""</span>
<span class="s1">            | YPrim a -&gt; prim a</span>
<span class="s1">            | YArray a -&gt; sprintf "</span><span class="si">%s</span><span class="s1"> *" (tup_ty a)</span>
<span class="s1">            | YFun(a,b,t) -&gt; $"Fun</span><span class="si">%i</span><span class="s1">{(cfun (a,b,t)).tag}"</span>
<span class="s1">            | YExists -&gt; raise_codegen_error "Existentials are not supported at runtime. They are a compile time feature only."</span>
<span class="s1">            | YForall -&gt; raise_codegen_error "Foralls are not supported at runtime. They are a compile time feature only."</span>
<span class="s1">            | a -&gt; raise_codegen_error (sprintf "Compiler error: Type not supported in the codegen.</span><span class="se">\n</span><span class="s1">Got: %A" a)</span>
<span class="s1">        and prim = function</span>
<span class="s1">            | Int8T -&gt; "char" </span>
<span class="s1">            | Int16T -&gt; "short"</span>
<span class="s1">            | Int32T -&gt; "int"</span>
<span class="s1">            | Int64T -&gt; "long long"</span>
<span class="s1">            | UInt8T -&gt; "unsigned char"</span>
<span class="s1">            | UInt16T -&gt; "unsigned short"</span>
<span class="s1">            | UInt32T -&gt; "unsigned int"</span>
<span class="s1">            | UInt64T -&gt; "unsigned long long"</span>
<span class="s1">            | Float32T -&gt; "float"</span>
<span class="s1">            | Float64T -&gt; "double"</span>
<span class="s1">            | BoolT -&gt; "bool" // part of c++ standard</span>
<span class="s1">            | CharT -&gt; "char"</span>
<span class="s1">            | StringT -&gt; "const char *"</span>
<span class="s1">        and lit = function</span>
<span class="s1">            | LitInt8 x -&gt; sprintf "</span><span class="si">%i</span><span class="s1">" x</span>
<span class="s1">            | LitInt16 x -&gt; sprintf "</span><span class="si">%i</span><span class="s1">" x</span>
<span class="s1">            | LitInt32 x -&gt; sprintf "</span><span class="si">%i</span><span class="s1">" x</span>
<span class="s1">            | LitInt64 x -&gt; sprintf "</span><span class="si">%i</span><span class="s1">ll" x</span>
<span class="s1">            | LitUInt8 x -&gt; sprintf "</span><span class="si">%i</span><span class="s1">u" x</span>
<span class="s1">            | LitUInt16 x -&gt; sprintf "</span><span class="si">%i</span><span class="s1">u" x</span>
<span class="s1">            | LitUInt32 x -&gt; sprintf "</span><span class="si">%i</span><span class="s1">u" x</span>
<span class="s1">            | LitUInt64 x -&gt; sprintf "</span><span class="si">%i</span><span class="s1">ull" x</span>
<span class="s1">            | LitFloat32 x -&gt; </span>
<span class="s1">                if x = infinityf then "1.0f / 0.0f"</span>
<span class="s1">                elif x = -infinityf then "-1.0f / 0.0f"</span>
<span class="s1">                elif System.Single.IsNaN x then "0.0f / 0.0f"</span>
<span class="s1">                else x.ToString("R") |&gt; add_dec_point |&gt; sprintf "</span><span class="si">%s</span><span class="s1">f"</span>
<span class="s1">            | LitFloat64 x -&gt;</span>
<span class="s1">                if x = infinity then "1.0 / 0.0"</span>
<span class="s1">                elif x = -infinity then "-1.0 / 0.0"</span>
<span class="s1">                elif System.Double.IsNaN x then "0.0 / 0.0"</span>
<span class="s1">                else x.ToString("R") |&gt; add_dec_point</span>
<span class="s1">            | LitString x -&gt; lit_stringCuda x</span>
<span class="s1">            | LitChar x -&gt; </span>
<span class="s1">                match x with</span>
<span class="s1">                | '</span><span class="se">\b</span><span class="s1">' -&gt; @"</span><span class="se">\b</span><span class="s1">"</span>
<span class="s1">                | '</span><span class="se">\n</span><span class="s1">' -&gt; @"</span><span class="se">\n</span><span class="s1">"</span>
<span class="s1">                | '</span><span class="se">\t</span><span class="s1">' -&gt; @"</span><span class="se">\t</span><span class="s1">"</span>
<span class="s1">                | '</span><span class="se">\r</span><span class="s1">' -&gt; @"</span><span class="se">\r</span><span class="s1">"</span>
<span class="s1">                | '</span><span class="se">\\</span><span class="s1">' -&gt; @"</span><span class="se">\\</span><span class="s1">"</span>
<span class="s1">                | x -&gt; string x</span>
<span class="s1">                |&gt; sprintf "'</span><span class="si">%s</span><span class="s1">'"</span>
<span class="s1">            | LitBool x -&gt; if x then "true" else "false" // true and false are defined in stddef.h</span>
<span class="s1">        and type_lit = function</span>
<span class="s1">            | YLit x -&gt; lit x</span>
<span class="s1">            | YSymbol x -&gt; x</span>
<span class="s1">            | x -&gt; raise_codegen_error "Compiler error: Expecting a type literal in the macro." </span>
<span class="s1">        and op (unroll : Stack&lt;int&gt;)s (ret : BindsReturnCuda) a =</span>
<span class="s1">            let binds a b = binds unroll a b</span>
<span class="s1">            let return' (x : string) =</span>
<span class="s1">                match ret with</span>
<span class="s1">                | BindsLocal ret -&gt; return_local s ret x</span>
<span class="s1">                | BindsTailEnd -&gt; line s $"return </span><span class="si">{x}</span><span class="s1">;"</span>
<span class="s1">            let jp (a,b') =</span>
<span class="s1">                let args = args b'</span>
<span class="s1">                match a with</span>
<span class="s1">                | JPMethod(a,b) -&gt; </span>
<span class="s1">                    let x = method (a,b)</span>
<span class="s1">                    let method_name = Option.defaultValue "method_" x.name</span>
<span class="s1">                    $"</span><span class="si">{method_name}{x.tag}</span><span class="s1">(</span><span class="si">{args}</span><span class="s1">)"</span>
<span class="s1">                | JPClosure(a,b) -&gt;</span>
<span class="s1">                    let x = closure (a,b)</span>
<span class="s1">                    match x.funtype with</span>
<span class="s1">                    | FT_Vanilla -&gt; raise_codegen_error "Compiler error: The vanilla function case should have been blocked elsewhere."</span>
<span class="s1">                    | FT_Pointer -&gt; $"FunPointerMethod</span><span class="si">{x.tag}</span><span class="s1">"</span>
<span class="s1">                    | FT_Closure -&gt; $"csptr&lt;ClosureBase</span><span class="si">{x.tag}</span><span class="s1">&gt;{{new Closure</span><span class="si">{x.tag}</span><span class="s1">{{</span><span class="si">{args}</span><span class="s1">}}}}"</span>
<span class="s1">            match a with</span>
<span class="s1">            | TyMacro _ -&gt; raise_codegen_error "Macros are supposed to be taken care of in the `binds` function."</span>
<span class="s1">            | TyIf(cond,tr,fl) -&gt;</span>
<span class="s1">                line s (sprintf "if (</span><span class="si">%s</span><span class="s1">){" (tup_data cond))</span>
<span class="s1">                binds (indent s) ret tr</span>
<span class="s1">                line s "} else {"</span>
<span class="s1">                binds (indent s) ret fl</span>
<span class="s1">                line s "}"</span>
<span class="s1">            | TyJoinPoint(a,args) -&gt; return' (jp (a, args))</span>
<span class="s1">            | TyBackend(_,_,r) -&gt; raise_codegen_error_backend r "The Cuda backend does not support the nesting of other backends."</span>
<span class="s1">            | TyWhile(a,b) -&gt;</span>
<span class="s1">                let cond =</span>
<span class="s1">                    match a with</span>
<span class="s1">                    | JPMethod(a,b),b' -&gt; sprintf "while_method_</span><span class="si">%i</span><span class="s1">(</span><span class="si">%s</span><span class="s1">)" (method_while (a,b)).tag (args b')</span>
<span class="s1">                    | _ -&gt; raise_codegen_error "Expected a regular method rather than closure create in the while conditional."</span>
<span class="s1">                match unroll_peek unroll with</span>
<span class="s1">                | -1 -&gt; ()</span>
<span class="s1">                | 0 -&gt; line s $"#pragma unroll"</span>
<span class="s1">                | i -&gt; line s $"#pragma unroll </span><span class="si">%i{i}</span><span class="s1">"</span>
<span class="s1">                line s (sprintf "while (</span><span class="si">%s</span><span class="s1">){" cond)</span>
<span class="s1">                binds (indent s) (BindsLocal [||]) b</span>
<span class="s1">                line s "}"</span>
<span class="s1">            | TyDo a | TyIndent a -&gt;</span>
<span class="s1">                binds s ret a</span>
<span class="s1">            | TyIntSwitch(L(v_i,_),on_succ,on_fail) -&gt;</span>
<span class="s1">                line s (sprintf "switch (v</span><span class="si">%i</span><span class="s1">) {" v_i)</span>
<span class="s1">                let _ =</span>
<span class="s1">                    let s = indent s</span>
<span class="s1">                    Array.iteri (fun i x -&gt;</span>
<span class="s1">                        line s (sprintf "case </span><span class="si">%i</span><span class="s1">: {" i)</span>
<span class="s1">                        binds (indent s) ret x</span>
<span class="s1">                        line (indent s) "break;"</span>
<span class="s1">                        line s "}"</span>
<span class="s1">                        ) on_succ</span>
<span class="s1">                    line s "default: {"</span>
<span class="s1">                    binds (indent s) ret on_fail</span>
<span class="s1">                    line s "}"</span>
<span class="s1">                line s "}"</span>
<span class="s1">            | TyUnionUnbox(is,x,on_succs,on_fail) -&gt;</span>
<span class="s1">                let case_tags = x.Item.tags</span>
<span class="s1">                let acs = match x.Item.layout with UHeap -&gt; ".base-&gt;" | UStack -&gt; "."</span>
<span class="s1">                let head = List.head is |&gt; fun (L(i,_)) -&gt; $"v</span><span class="si">{i}{acs}</span><span class="s1">tag"</span>
<span class="s1">                List.pairwise is</span>
<span class="s1">                |&gt; List.map (fun (L(i,_), L(i',_)) -&gt; $"v</span><span class="si">{i}{acs}</span><span class="s1">tag == v{i'}</span><span class="si">{acs}</span><span class="s1">tag")</span>
<span class="s1">                |&gt; String.concat " &amp;&amp; "</span>
<span class="s1">                |&gt; function "" -&gt; head | x -&gt; $"</span><span class="si">{x}</span><span class="s1"> ? </span><span class="si">{head}</span><span class="s1"> : </span><span class="si">{max_tag}</span><span class="s1">"</span>
<span class="s1">                |&gt; sprintf "switch (</span><span class="si">%s</span><span class="s1">) {" |&gt; line s</span>
<span class="s1">                let _ =</span>
<span class="s1">                    let s = indent s</span>
<span class="s1">                    Map.iter (fun k (a,b) -&gt;</span>
<span class="s1">                        let union_i = case_tags.[k]</span>
<span class="s1">                        line s (sprintf "case </span><span class="si">%i</span><span class="s1">: { // </span><span class="si">%s</span><span class="s1">" union_i k)</span>
<span class="s1">                        List.iter2 (fun (L(data_i,_)) a -&gt;</span>
<span class="s1">                            let a, s = data_free_vars a, indent s</span>
<span class="s1">                            let qs = ResizeArray(a.Length)</span>
<span class="s1">                            Array.iteri (fun field_i (L(v_i,t) as v) -&gt; </span>
<span class="s1">                                qs.Add $"{tyv t} v</span><span class="si">{v_i}</span><span class="s1"> = v</span><span class="si">{data_i}{acs}</span><span class="s1">case</span><span class="si">{union_i}</span><span class="s1">.v</span><span class="si">{field_i}</span><span class="s1">;"</span>
<span class="s1">                                ) a </span>
<span class="s1">                            lineCuda' s qs</span>
<span class="s1">                            ) is a</span>
<span class="s1">                        binds (indent s) ret b</span>
<span class="s1">                        line (indent s) "break;"</span>
<span class="s1">                        line s "}"</span>
<span class="s1">                        ) on_succs</span>
<span class="s1">                    line s "default: {"</span>
<span class="s1">                    let _ =</span>
<span class="s1">                        let s = indent s</span>
<span class="s1">                        match on_fail with</span>
<span class="s1">                        | Some b -&gt; binds s ret b</span>
<span class="s1">                        | None -&gt; line s "assert(</span><span class="se">\"</span><span class="s1">Invalid tag.</span><span class="se">\"</span><span class="s1"> &amp;&amp; false); __trap();"</span>
<span class="s1">                    line s "}"</span>
<span class="s1">                line s "}"</span>
<span class="s1">            | TyUnionBox(a,b,c') -&gt;</span>
<span class="s1">                let c = c'.Item</span>
<span class="s1">                let i = c.tags.[a]</span>
<span class="s1">                let vars = args' b</span>
<span class="s1">                let tag = (unions c').tag</span>
<span class="s1">                match c.layout with</span>
<span class="s1">                | UHeap -&gt; $"sptr&lt;Union</span><span class="si">{tag}</span><span class="s1">&gt;{{new Union</span><span class="si">{tag}</span><span class="s1">{{Union</span><span class="si">{tag}</span><span class="s1">_</span><span class="si">{i}</span><span class="s1">{{</span><span class="si">{vars}</span><span class="s1">}}}}}}"</span>
<span class="s1">                | UStack -&gt; $"Union</span><span class="si">{tag}</span><span class="s1">{{Union</span><span class="si">{tag}</span><span class="s1">_</span><span class="si">{i}</span><span class="s1">{{</span><span class="si">{vars}</span><span class="s1">}}}}"</span>
<span class="s1">                |&gt; return'</span>
<span class="s1">            | TyToLayout(a,b) -&gt; </span>
<span class="s1">                match b with</span>
<span class="s1">                | YLayout(_,layout) -&gt; </span>
<span class="s1">                    match layout with</span>
<span class="s1">                    | Heap -&gt;</span>
<span class="s1">                        let tag = (heap b).tag</span>
<span class="s1">                        $"sptr&lt;Heap</span><span class="si">{tag}</span><span class="s1">&gt;{{new Heap</span><span class="si">{tag}</span><span class="s1">{{{args' a}}}}}"</span>
<span class="s1">                    | HeapMutable -&gt;</span>
<span class="s1">                        let tag = (mut b).tag</span>
<span class="s1">                        $"sptr&lt;Mut</span><span class="si">{tag}</span><span class="s1">&gt;{{new Mut</span><span class="si">{tag}</span><span class="s1">{{{args' a}}}}}"</span>
<span class="s1">                    | StackMutable -&gt; raise_codegen_error "The Cuda backend doesn't support stack mutable layout types."</span>
<span class="s1">                | _ -&gt; raise_codegen_error "Compiler error: Expected a layout type (2)."</span>
<span class="s1">                |&gt; return'</span>
<span class="s1">            | TyLayoutIndexAll(x) -&gt; raise_codegen_error "Compiler error: TyLayoutIndexAll should have been taken care of in TyLet."</span>
<span class="s1">            | TyLayoutIndexByKey(x,key) -&gt; raise_codegen_error "Compiler error: TyLayoutIndexByKey should have been taken care of in TyLet."</span>
<span class="s1">            | TyLayoutMutableSet(L(i,t),b,c) -&gt;</span>
<span class="s1">                match t with</span>
<span class="s1">                | YLayout(_,lay) -&gt;</span>
<span class="s1">                    match lay with</span>
<span class="s1">                    | HeapMutable -&gt; </span>
<span class="s1">                        let a =</span>
<span class="s1">                            List.fold</span>
<span class="s1">                                (fun s k -&gt;</span>
<span class="s1">                                    match s with</span>
<span class="s1">                                    | DRecord l -&gt; l |&gt; Map.pick (fun (_, k') v' -&gt; if k = k' then Some v' else None)</span>
<span class="s1">                                    | _ -&gt; raise_codegen_error "Compiler error: Expected a record.")</span>
<span class="s1">                                (mut t).data b</span>
<span class="s1">                        Array.map2 (fun (L(i',_)) b -&gt; $"v</span><span class="si">{i}</span><span class="s1">.base-&gt;v{i'} = {show_w b};") (data_free_vars a) (data_term_vars c)</span>
<span class="s1">                    | StackMutable -&gt; </span>
<span class="s1">                        let a = List.fold (fun s k -&gt; match s with DRecord l -&gt; l |&gt; Map.pick (fun (_, k') v' -&gt; if k = k' then Some v' else None) | _ -&gt; raise_codegen_error "Compiler error: Expected a record.") (stack_mut t).data b</span>
<span class="s1">                        Array.map2 (fun (L(i',_)) b -&gt; $"v</span><span class="si">{i}</span><span class="s1">.v{i'} = {show_w b};") (data_free_vars a) (data_term_vars c)</span>
<span class="s1">                    | Heap -&gt; raise_codegen_error "Compiler error (1): TyLayoutMutableSet should only be HeapMutable or StackMutable."</span>
<span class="s1">                | _ -&gt; raise_codegen_error "Compiler error (2): TyLayoutMutableSet should only be HeapMutable or StackMutable."</span>
<span class="s1">                |&gt; String.concat " " |&gt; line s</span>
<span class="s1">            | TyArrayLiteral(a,b') -&gt; raise_codegen_error "Compiler error: TyArrayLiteral should have been taken care of in TyLet."</span>
<span class="s1">            | TyArrayCreate(a,b) -&gt;  raise_codegen_error "Compiler error: TyArrayCreate should have been taken care of in TyLet."</span>
<span class="s1">            | TyFailwith(a,b) -&gt;</span>
<span class="s1">                let string_in_op = function DLit (LitString b) -&gt; lit_stringCuda b | b -&gt; raise_codegen_error "In the Cuda backend, the exception string must be a literal."</span>
<span class="s1">                let fmt = @"</span><span class="si">%s</span><span class="se">\n</span><span class="s1">"</span>
<span class="s1">                line s $"printf(</span><span class="se">\"</span><span class="si">{fmt}</span><span class="se">\"</span><span class="s1">, {string_in_op b});"</span>
<span class="s1">                line s "__trap();" // TODO: Print out the error traces as well.</span>
<span class="s1">            | TyConv(a,b) -&gt; return' $"({tyv a}){tup_data b}"</span>
<span class="s1">            | TyApply(L(i,_),b) -&gt; </span>
<span class="s1">                let rec loop = function</span>
<span class="s1">                    | DPair(a,b) -&gt; tup_data a :: loop b</span>
<span class="s1">                    | a -&gt; [tup_data a]</span>
<span class="s1">                let args = loop b |&gt; List.filter ((&lt;&gt;) "") |&gt; String.concat ", "</span>
<span class="s1">                $"v</span><span class="si">{i}</span><span class="s1">(</span><span class="si">{args}</span><span class="s1">)" |&gt; return'</span>
<span class="s1">            | TyArrayLength(_,b) -&gt; raise_codegen_error "Array length is not supported in the Cuda C++ backend as they are bare pointers."</span>
<span class="s1">            | TyStringLength(_,b) -&gt; raise_codegen_error "String length is not supported in the Cuda C++ backend."</span>
<span class="s1">            | TySizeOf t -&gt; return' $"sizeof({tup_ty t})"</span>
<span class="s1">            | TyOp(Global,[DLit (LitString x)]) -&gt; global' x</span>
<span class="s1">            | TyOp(PragmaUnrollPush,[DLit (LitInt32 x)]) -&gt; unroll.Push(x); line s $"// Pushing the loop unrolling to: </span><span class="si">{x}</span><span class="s1">"</span>
<span class="s1">            | TyOp(PragmaUnrollPop,[]) -&gt; line s $"// Poping the loop unrolling to: {unroll_pop unroll}"</span>
<span class="s1">            | TyOp(op,l) -&gt;</span>
<span class="s1">                match op, l with</span>
<span class="s1">                | Dyn,[a] -&gt; tup_data a</span>
<span class="s1">                | TypeToVar, _ -&gt; raise_codegen_error "The use of `` should never appear in generated code."</span>
<span class="s1">                | StringIndex, [a;b] -&gt; sprintf "</span><span class="si">%s</span><span class="s1">[</span><span class="si">%s</span><span class="s1">]" (tup_data a) (tup_data b)</span>
<span class="s1">                | StringSlice, [a;b;c] -&gt; raise_codegen_error "String slice is not supported natively in the C backend. Use a library implementation instead."</span>
<span class="s1">                | ArrayIndex, [DV(L(_,YArray t)) &amp; a;b] -&gt; </span>
<span class="s1">                    match tup_ty t with</span>
<span class="s1">                    | "void" -&gt; "/* void array index */"</span>
<span class="s1">                    | _ -&gt; sprintf "</span><span class="si">%s</span><span class="s1">[</span><span class="si">%s</span><span class="s1">]" (tup_data a) (tup_data b)</span>
<span class="s1">                | ArrayIndexSet, [DV(L(_,YArray t)) as a;b;c] -&gt; </span>
<span class="s1">                    let a',b',c' = tup_data a, tup_data b, tup_data c</span>
<span class="s1">                    match c' with</span>
<span class="s1">                    | "" -&gt; "/* void array set */"</span>
<span class="s1">                    | _ -&gt; $"{a'}[{b'}] = {c'}"</span>
<span class="s1">                // Math</span>
<span class="s1">                | Add, [a;b] -&gt; sprintf "</span><span class="si">%s</span><span class="s1"> + </span><span class="si">%s</span><span class="s1">" (tup_data a) (tup_data b)</span>
<span class="s1">                | Sub, [a;b] -&gt; sprintf "</span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">" (tup_data a) (tup_data b)</span>
<span class="s1">                | Mult, [a;b] -&gt; sprintf "</span><span class="si">%s</span><span class="s1"> * </span><span class="si">%s</span><span class="s1">" (tup_data a) (tup_data b)</span>
<span class="s1">                | Div, [a;b] -&gt; sprintf "</span><span class="si">%s</span><span class="s1"> / </span><span class="si">%s</span><span class="s1">" (tup_data a) (tup_data b)</span>
<span class="s1">                | Mod, [a;b] -&gt; sprintf "</span><span class="si">%s</span><span class="s1"> </span><span class="si">%%</span><span class="s1"> </span><span class="si">%s</span><span class="s1">" (tup_data a) (tup_data b)</span>
<span class="s1">                | Pow, [a;b] -&gt; sprintf "pow(</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">)" (tup_data a) (tup_data b)</span>
<span class="s1">                | LT, [a;b] -&gt; sprintf "</span><span class="si">%s</span><span class="s1"> &lt; </span><span class="si">%s</span><span class="s1">" (tup_data a) (tup_data b)</span>
<span class="s1">                | LTE, [a;b] -&gt; sprintf "</span><span class="si">%s</span><span class="s1"> &lt;= </span><span class="si">%s</span><span class="s1">" (tup_data a) (tup_data b)</span>
<span class="s1">                | EQ, [a;b] | NEQ, [a;b] | GT, [a;b] | GTE, [a;b] when is_stringCuda a -&gt; raise_codegen_error "String comparison operations are not supported in the Cuda C++ backend."</span>
<span class="s1">                | EQ, [a;b] -&gt; sprintf "</span><span class="si">%s</span><span class="s1"> == </span><span class="si">%s</span><span class="s1">" (tup_data a) (tup_data b)</span>
<span class="s1">                | NEQ, [a;b] -&gt; sprintf "</span><span class="si">%s</span><span class="s1"> != </span><span class="si">%s</span><span class="s1">" (tup_data a) (tup_data b)</span>
<span class="s1">                | GT, [a;b] -&gt; sprintf "</span><span class="si">%s</span><span class="s1"> &gt; </span><span class="si">%s</span><span class="s1">" (tup_data a) (tup_data b)</span>
<span class="s1">                | GTE, [a;b] -&gt; sprintf "</span><span class="si">%s</span><span class="s1"> &gt;= </span><span class="si">%s</span><span class="s1">" (tup_data a) (tup_data b)</span>
<span class="s1">                | BoolAnd, [a;b] -&gt; sprintf "</span><span class="si">%s</span><span class="s1"> &amp;&amp; </span><span class="si">%s</span><span class="s1">" (tup_data a) (tup_data b)</span>
<span class="s1">                | BoolOr, [a;b] -&gt; sprintf "</span><span class="si">%s</span><span class="s1"> || </span><span class="si">%s</span><span class="s1">" (tup_data a) (tup_data b)</span>
<span class="s1">                | BitwiseAnd, [a;b] -&gt; sprintf "</span><span class="si">%s</span><span class="s1"> &amp; </span><span class="si">%s</span><span class="s1">" (tup_data a) (tup_data b)</span>
<span class="s1">                | BitwiseOr, [a;b] -&gt; sprintf "</span><span class="si">%s</span><span class="s1"> | </span><span class="si">%s</span><span class="s1">" (tup_data a) (tup_data b)</span>
<span class="s1">                | BitwiseXor, [a;b] -&gt; sprintf "</span><span class="si">%s</span><span class="s1"> ^ </span><span class="si">%s</span><span class="s1">" (tup_data a) (tup_data b)</span>
<span class="s1">                | BitwiseComplement, [a] -&gt; sprintf "~</span><span class="si">%s</span><span class="s1">" (tup_data a)</span>

<span class="s1">                | ShiftLeft, [a;b] -&gt; sprintf "</span><span class="si">%s</span><span class="s1"> &lt;&lt; </span><span class="si">%s</span><span class="s1">" (tup_data a) (tup_data b)</span>
<span class="s1">                | ShiftRight, [a;b] -&gt; sprintf "</span><span class="si">%s</span><span class="s1"> &gt;&gt; </span><span class="si">%s</span><span class="s1">" (tup_data a) (tup_data b)</span>

<span class="s1">                | Neg, [x] -&gt; sprintf "-</span><span class="si">%s</span><span class="s1">" (tup_data x)</span>
<span class="s1">                | Log, [x] -&gt; sprintf "log(</span><span class="si">%s</span><span class="s1">)" (tup_data x)</span>
<span class="s1">                | Exp, [x] -&gt; sprintf "exp(</span><span class="si">%s</span><span class="s1">)" (tup_data x)</span>
<span class="s1">                | Tanh, [x] -&gt; sprintf "tanh(</span><span class="si">%s</span><span class="s1">)" (tup_data x)</span>
<span class="s1">                | Sqrt, [x] -&gt; sprintf "sqrt(</span><span class="si">%s</span><span class="s1">)" (tup_data x)</span>
<span class="s1">                | Sin, [x] -&gt; sprintf "sin(</span><span class="si">%s</span><span class="s1">)" (tup_data x)</span>
<span class="s1">                | Cos, [x] -&gt; sprintf "cos(</span><span class="si">%s</span><span class="s1">)" (tup_data x)</span>
<span class="s1">                | NanIs, [x] -&gt; sprintf "isnan(</span><span class="si">%s</span><span class="s1">)" (tup_data x)</span>
<span class="s1">                | Printf, [fmt;str] -&gt; </span>
<span class="s1">                    match args' str with</span>
<span class="s1">                    | "" -&gt; sprintf "printf(</span><span class="si">%s</span><span class="s1">)" (tup_data fmt)</span>
<span class="s1">                    | str -&gt; sprintf "printf(</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">)" (tup_data fmt) str</span>
<span class="s1">                | UnionTag, [DV(L(i,YUnion l)) as x] -&gt; </span>
<span class="s1">                    match l.Item.layout with</span>
<span class="s1">                    | UHeap -&gt; ".base-&gt;tag"</span>
<span class="s1">                    | UStack -&gt; ".tag"</span>
<span class="s1">                    |&gt; sprintf "v</span><span class="si">%i%s</span><span class="s1">" i</span>
<span class="s1">                | _ -&gt; raise_codegen_error &lt;| sprintf "Compiler error: %A with </span><span class="si">%i</span><span class="s1"> args not supported" op l.Length</span>
<span class="s1">                |&gt; return'</span>
<span class="s1">        and print_ordered_args s v = // Unlike C# for example, C keeps the struct fields in input order. To reduce padding, it is best to order the fields from largest to smallest.</span>
<span class="s1">            order_args v |&gt; Array.iter (fun (L(i,x)) -&gt; line s $"{tyv x} v</span><span class="si">{i}</span><span class="s1">;")</span>
<span class="s1">        and method_template is_while : _ -&gt; MethodRecCuda =</span>
<span class="s1">            jp (fun ((jp_body,key &amp; (C(args,_))),i) -&gt;</span>
<span class="s1">                match (fst env.join_point_method.[jp_body]).[key] with</span>
<span class="s1">                | Some a, Some range, name -&gt; {tag=i; free_vars=rdata_free_vars args; range=range; body=a; name=Option.map fix_method_name name}</span>
<span class="s1">                | _ -&gt; raise_codegen_error "Compiler error: The method dictionary is malformed"</span>
<span class="s1">                ) (fun s_fwd s_typ s_fun x -&gt;</span>
<span class="s1">                let ret_ty = tup_ty x.range</span>
<span class="s1">                let fun_name = Option.defaultValue (if is_while then "while_method_" else "method_") x.name</span>
<span class="s1">                let args = x.free_vars |&gt; Array.mapi (fun i (L(_,x)) -&gt; $"{tyv x} v</span><span class="si">{i}</span><span class="s1">") |&gt; String.concat ", "</span>
<span class="s1">                let inline_ = </span>
<span class="s1">                    if is_while then "inline "</span>
<span class="s1">                    else </span>
<span class="s1">                        line s_fwd $"__device__ </span><span class="si">{ret_ty}</span><span class="s1"> </span><span class="si">{fun_name}{x.tag}</span><span class="s1">(</span><span class="si">{args}</span><span class="s1">);"</span>
<span class="s1">                        if fun_name.StartsWith "noinline" then "__noinline__ " else ""</span>
<span class="s1">                line s_fun $"__device__ </span><span class="si">{inline_}{ret_ty}</span><span class="s1"> </span><span class="si">{fun_name}{x.tag}</span><span class="s1">(</span><span class="si">{args}</span><span class="s1">){{"</span>
<span class="s1">                binds_start (indent s_fun) x.body</span>
<span class="s1">                line s_fun "}"</span>
<span class="s1">                )</span>
<span class="s1">        and method : _ -&gt; MethodRecCuda = method_template false</span>
<span class="s1">        and method_while : _ -&gt; MethodRecCuda = method_template true</span>
<span class="s1">        and closure_args domain count_start =</span>
<span class="s1">            let rec loop = function</span>
<span class="s1">                | YPair(a,b) -&gt; a :: loop b</span>
<span class="s1">                | a -&gt; [a]</span>
<span class="s1">            let mutable count = count_start</span>
<span class="s1">            let rename x = Array.map (fun (L(i,t)) -&gt; let x = L(count,t) in count &lt;- count+1; x) x</span>
<span class="s1">            let mutable i = 0</span>
<span class="s1">            loop domain |&gt; List.choose (fun x -&gt; </span>
<span class="s1">                let n = env.ty_to_data x |&gt; data_free_vars </span>
<span class="s1">                let x = if n.Length &lt;&gt; 0 then Some(i, tup_ty_tyvs n, n |&gt; rename) else None</span>
<span class="s1">                i &lt;- i+1</span>
<span class="s1">                x</span>
<span class="s1">                )</span>
<span class="s1">        and closure : _ -&gt; ClosureRecCuda =</span>
<span class="s1">            jp (fun ((jp_body,key &amp; (C(args,_,fun_ty))),i) -&gt;</span>
<span class="s1">                match fun_ty with</span>
<span class="s1">                | YFun(domain,range,t) -&gt;</span>
<span class="s1">                    match (fst env.join_point_closure.[jp_body]).[key] with</span>
<span class="s1">                    | Some(domain_args, body) -&gt; {tag=i; domain=domain; range=range; body=body; free_vars=rdata_free_vars args; funtype=t}</span>
<span class="s1">                    | _ -&gt; raise_codegen_error "Compiler error: The method dictionary is malformed"</span>
<span class="s1">                | _ -&gt; raise_codegen_error "Compiler error: Unexpected type in the closure join point."</span>
<span class="s1">                ) (fun _ s_typ s_fun x -&gt;</span>
<span class="s1">                let i, range = x.tag, tup_ty x.range</span>
<span class="s1">                let closure_args = closure_args x.domain x.free_vars.Length</span>
<span class="s1">                let args = closure_args |&gt; List.map (fun (i,ty,_) -&gt; $"</span><span class="si">{ty}</span><span class="s1"> tup</span><span class="si">{i}</span><span class="s1">") |&gt; String.concat ", "</span>
<span class="s1">                let print_body s_fun =</span>
<span class="s1">                    let s_fun = indent s_fun</span>
<span class="s1">                    x.free_vars |&gt; Array.map (fun (L(i,t)) -&gt;</span>
<span class="s1">                        $"{tyv t} &amp; v</span><span class="si">{i}</span><span class="s1"> = this-&gt;v</span><span class="si">{i}</span><span class="s1">;"</span>
<span class="s1">                        ) |&gt; String.concat " " |&gt; line s_fun</span>
<span class="s1">                    closure_args |&gt; List.map (fun (i'',_,vars) -&gt;</span>
<span class="s1">                        Array.mapi (fun i' (L(i,t)) -&gt; </span>
<span class="s1">                            if vars.Length &lt;&gt; 1 then $"{tyv t} v</span><span class="si">{i}</span><span class="s1"> = tup{i''}.v{i'};"</span>
<span class="s1">                            else $"{tyv t} v</span><span class="si">{i}</span><span class="s1"> = tup{i''};"</span>
<span class="s1">                            ) vars</span>
<span class="s1">                        |&gt; String.concat " "</span>
<span class="s1">                        ) |&gt; String.concat " " |&gt; line s_fun</span>
<span class="s1">                    binds_start s_fun x.body</span>
<span class="s1">                match x.funtype with</span>
<span class="s1">                | FT_Pointer -&gt;</span>
<span class="s1">                    $"__device__ </span><span class="si">{range}</span><span class="s1"> FunPointerMethod</span><span class="si">{i}</span><span class="s1">(</span><span class="si">{args}</span><span class="s1">){{" |&gt; line s_fun</span>
<span class="s1">                    print_body s_fun</span>
<span class="s1">                    line s_fun "}"</span>
<span class="s1">                | FT_Vanilla | FT_Closure -&gt;</span>
<span class="s1">                    match x.funtype with</span>
<span class="s1">                    | FT_Pointer -&gt; raise_codegen_error "Compiler error: The pointer case have been taken care of (1)."</span>
<span class="s1">                    | FT_Closure -&gt;</span>
<span class="s1">                        let i' = (cfun (x.domain,x.range,x.funtype)).tag</span>
<span class="s1">                        line s_typ $"struct Closure</span><span class="si">{i}</span><span class="s1"> : public ClosureBase{i'} {{"</span>
<span class="s1">                    | FT_Vanilla -&gt;</span>
<span class="s1">                        line s_typ $"struct Closure</span><span class="si">{i}</span><span class="s1"> {{"</span>
<span class="s1">                    let () =</span>
<span class="s1">                        let s_typ = indent s_typ</span>
<span class="s1">                        let () = // free vars in the environment</span>
<span class="s1">                            print_ordered_args s_typ x.free_vars</span>
<span class="s1">                        let () = // operator()</span>
<span class="s1">                            match x.funtype with</span>
<span class="s1">                            | FT_Pointer -&gt; raise_codegen_error "Compiler error: The pointer case have been taken care of (2)."</span>
<span class="s1">                            | FT_Vanilla -&gt; line s_typ $"__device__ </span><span class="si">{range}</span><span class="s1"> operator()(</span><span class="si">{args}</span><span class="s1">){{"</span>
<span class="s1">                            | FT_Closure -&gt; line s_typ $"__device__ </span><span class="si">{range}</span><span class="s1"> operator()(</span><span class="si">{args}</span><span class="s1">) override {{"</span>
<span class="s1">                            print_body s_typ</span>
<span class="s1">                            line s_typ "}"</span>
<span class="s1">                        let () = // constructor</span>
<span class="s1">                            match x.free_vars with</span>
<span class="s1">                            | [||] -&gt; ()</span>
<span class="s1">                            | _ -&gt;</span>
<span class="s1">                                let constructor_args = </span>
<span class="s1">                                    x.free_vars </span>
<span class="s1">                                    |&gt; Array.map (fun (L(i,t)) -&gt; $"{tyv t} _v</span><span class="si">{i}</span><span class="s1">")</span>
<span class="s1">                                    |&gt; String.concat ", "</span>
<span class="s1">                                let initializer_args = </span>
<span class="s1">                                    x.free_vars </span>
<span class="s1">                                    |&gt; Array.map (fun (L(i,t)) -&gt; $"v</span><span class="si">{i}</span><span class="s1">(_v</span><span class="si">{i}</span><span class="s1">)")</span>
<span class="s1">                                    |&gt; String.concat ", "</span>
<span class="s1">                                line s_typ $"__device__ Closure</span><span class="si">{i}</span><span class="s1">(</span><span class="si">{constructor_args}</span><span class="s1">) : </span><span class="si">{initializer_args}</span><span class="s1"> {{ }}"</span>
<span class="s1">                        let () = // destructor</span>
<span class="s1">                            match x.funtype with</span>
<span class="s1">                            | FT_Pointer | FT_Vanilla -&gt; ()</span>
<span class="s1">                            | FT_Closure -&gt; line s_typ $"__device__ ~Closure</span><span class="si">{i}</span><span class="s1">() override = default;"</span>
<span class="s1">                        ()</span>
<span class="s1">                    line s_typ "};"</span>
<span class="s1">                )</span>
<span class="s1">        and cfun : _ -&gt; CFunRecCuda =</span>
<span class="s1">            cfun' (fun s_fwd s_typ s_fun x -&gt;</span>
<span class="s1">                let i, range = x.tag, tup_ty x.range</span>
<span class="s1">                let domain_args_ty = closure_args x.domain 0 |&gt; List.map (fun (_,ty,_) -&gt; ty) |&gt; String.concat ", "</span>
<span class="s1">                match x.funtype with</span>
<span class="s1">                | FT_Vanilla -&gt; raise_codegen_error "Regular functions do not have a composable type in the Cuda backend. Consider explicitly converting them to either closures or pointers using `to_closure` or `to_fptr` if you want to pass them through boundaries."</span>
<span class="s1">                | FT_Pointer -&gt; line s_fwd $"typedef </span><span class="si">{range}</span><span class="s1"> (* Fun</span><span class="si">{i}</span><span class="s1">)(</span><span class="si">{domain_args_ty}</span><span class="s1">);"</span>
<span class="s1">                | FT_Closure -&gt;</span>
<span class="s1">                    line s_fwd $"struct ClosureBase</span><span class="si">{i}</span><span class="s1"> {{ int refc{{0}}; __device__ virtual </span><span class="si">{range}</span><span class="s1"> operator()(</span><span class="si">{domain_args_ty}</span><span class="s1">) = 0; __device__ virtual ~ClosureBase</span><span class="si">{i}</span><span class="s1">() = default; }};"</span>
<span class="s1">                    line s_fwd $"typedef csptr&lt;ClosureBase</span><span class="si">{i}</span><span class="s1">&gt; Fun</span><span class="si">{i}</span><span class="s1">;"</span>
<span class="s1">                )</span>
<span class="s1">        and tup : _ -&gt; TupleRecCuda = </span>
<span class="s1">            tuple (fun s_fwd s_typ s_fun x -&gt;</span>
<span class="s1">                let name = sprintf "Tuple</span><span class="si">%i</span><span class="s1">" x.tag</span>
<span class="s1">                line s_fwd $"struct </span><span class="si">{name}</span><span class="s1">;"</span>
<span class="s1">                line s_typ $"struct </span><span class="si">{name}</span><span class="s1"> {{"</span>
<span class="s1">                x.tys |&gt; Array.mapi (fun i x -&gt; L(i,x)) |&gt; print_ordered_args (indent s_typ)</span>
<span class="s1">                let concat x = String.concat ", " x</span>
<span class="s1">                let args = x.tys |&gt; Array.mapi (fun i x -&gt; $"{tyv x} t</span><span class="si">{i}</span><span class="s1">")</span>
<span class="s1">                let con_init = x.tys |&gt; Array.mapi (fun i x -&gt; $"v</span><span class="si">{i}</span><span class="s1">(t</span><span class="si">{i}</span><span class="s1">)")</span>
<span class="s1">                if args.Length &lt;&gt; 0 then</span>
<span class="s1">                    line (indent s_typ) $"__device__ </span><span class="si">{name}</span><span class="s1">() = default;"</span>
<span class="s1">                    line (indent s_typ) $"__device__ </span><span class="si">{name}</span><span class="s1">({concat args}) : {concat con_init} {{}}"</span>
<span class="s1">                line s_typ "};"</span>
<span class="s1">                )</span>
<span class="s1">        and unions : _ -&gt; UnionRecCuda = </span>
<span class="s1">            let inline map_iteri f x = Map.fold (fun i k v -&gt; f i k v; i+1) 0 x |&gt; ignore</span>
<span class="s1">            union (fun s_fwd s_typ s_fun x -&gt;</span>
<span class="s1">                let i = x.tag</span>
<span class="s1">                line s_fwd $"struct Union</span><span class="si">{i}</span><span class="s1">;" // Forward declaration for the union.</span>
<span class="s1">                map_iteri (fun tag k v -&gt; // The individual union cases.</span>
<span class="s1">                    line s_typ $"struct Union</span><span class="si">{i}</span><span class="s1">_</span><span class="si">{tag}</span><span class="s1"> {{ // </span><span class="si">{k}</span><span class="s1">"</span>
<span class="s1">                    // The free vars in the env.</span>
<span class="s1">                    print_ordered_args (indent s_typ) v</span>
<span class="s1">                    let () = // constructors</span>
<span class="s1">                        let s_typ = indent s_typ</span>
<span class="s1">                        let concat x = String.concat ", " x</span>
<span class="s1">                        let args = v |&gt; Array.map (fun (L(i,x)) -&gt; $"{tyv x} t</span><span class="si">{i}</span><span class="s1">")</span>
<span class="s1">                        let con_init = v |&gt; Array.map (fun (L(i,x)) -&gt; $"v</span><span class="si">{i}</span><span class="s1">(t</span><span class="si">{i}</span><span class="s1">)")</span>
<span class="s1">                        if v.Length &lt;&gt; 0 then </span>
<span class="s1">                            line s_typ $"__device__ Union</span><span class="si">{i}</span><span class="s1">_</span><span class="si">{tag}</span><span class="s1">({concat args}) : {concat con_init} {{}}" </span>
<span class="s1">                            line s_typ $"__device__ Union</span><span class="si">{i}</span><span class="s1">_</span><span class="si">{tag}</span><span class="s1">() = delete;" </span>
<span class="s1">                    line s_typ "};"</span>
<span class="s1">                    ) x.free_vars</span>
<span class="s1">                    </span>
<span class="s1">                line s_typ $"struct Union</span><span class="si">{i}</span><span class="s1"> {{" // The union definition.</span>
<span class="s1">                let _ = // Union cases inside the union.</span>
<span class="s1">                    let s_typ = indent s_typ</span>
<span class="s1">                    line s_typ $"union {{"</span>
<span class="s1">                    let _ =</span>
<span class="s1">                        let s_typ = indent s_typ</span>
<span class="s1">                        map_iteri (fun tag (_,k) v -&gt; line s_typ $"Union</span><span class="si">{i}</span><span class="s1">_</span><span class="si">{tag}</span><span class="s1"> case</span><span class="si">{tag}</span><span class="s1">; // </span><span class="si">{k}</span><span class="s1">") x.free_vars</span>
<span class="s1">                    line s_typ "};"</span>

<span class="s1">                    if x.is_heap then line s_typ "int refc</span><span class="si">{0}</span><span class="s1">;"</span>
<span class="s1">                    if x.free_vars.Count &gt; int max_tag then raise_codegen_error $"Too many union cases. They should not be more than </span><span class="si">{max_tag}</span><span class="s1">."</span>
<span class="s1">                    line s_typ $"unsigned char tag{{</span><span class="si">{max_tag}</span><span class="s1">}};"</span>
<span class="s1">                    line s_typ $"__device__ Union</span><span class="si">{i}</span><span class="s1">() {{}}" // default constructor, the refc and tag have def value so we don't have to do anything here.</span>
<span class="s1">                    </span>
<span class="s1">                    map_iteri (fun tag k v -&gt; // The constructors for all the union cases.</span>
<span class="s1">                        line s_typ $"__device__ Union</span><span class="si">{i}</span><span class="s1">(Union</span><span class="si">{i}</span><span class="s1">_</span><span class="si">{tag}</span><span class="s1"> t) : tag(</span><span class="si">{tag}</span><span class="s1">), case</span><span class="si">{tag}</span><span class="s1">(t) {{}} // </span><span class="si">{k}</span><span class="s1">"</span>
<span class="s1">                        ) x.free_vars</span>
<span class="s1">                    </span>
<span class="s1">                    line s_typ $"__device__ Union</span><span class="si">{i}</span><span class="s1">(Union</span><span class="si">{i}</span><span class="s1"> &amp; x) : tag(x.tag) {{" // copy constructor</span>
<span class="s1">                    let () =</span>
<span class="s1">                        let s_typ = indent s_typ</span>
<span class="s1">                        line s_typ "switch(x.tag){"</span>
<span class="s1">                        let () = // copy constructor cases</span>
<span class="s1">                            let s_typ = indent s_typ</span>
<span class="s1">                            map_iteri (fun tag k v -&gt; </span>
<span class="s1">                                line s_typ $"case </span><span class="si">{tag}</span><span class="s1">: new (&amp;this-&gt;case</span><span class="si">{tag}</span><span class="s1">) Union</span><span class="si">{i}</span><span class="s1">_</span><span class="si">{tag}</span><span class="s1">(x.case</span><span class="si">{tag}</span><span class="s1">); break; // </span><span class="si">{k}</span><span class="s1">"</span>
<span class="s1">                                ) x.free_vars</span>
<span class="s1">                        line s_typ "}"</span>
<span class="s1">                    line s_typ "}"</span>
<span class="s1">                    line s_typ $"__device__ Union</span><span class="si">{i}</span><span class="s1">(Union</span><span class="si">{i}</span><span class="s1"> &amp;&amp; x) : tag(x.tag) {{" // move constructor</span>
<span class="s1">                    let () =</span>
<span class="s1">                        let s_typ = indent s_typ</span>
<span class="s1">                        line s_typ "switch(x.tag){"</span>
<span class="s1">                        let () = // move constructor cases</span>
<span class="s1">                            let s_typ = indent s_typ</span>
<span class="s1">                            map_iteri (fun tag k v -&gt; </span>
<span class="s1">                                line s_typ $"case </span><span class="si">{tag}</span><span class="s1">: new (&amp;this-&gt;case</span><span class="si">{tag}</span><span class="s1">) Union</span><span class="si">{i}</span><span class="s1">_</span><span class="si">{tag}</span><span class="s1">(std::move(x.case</span><span class="si">{tag}</span><span class="s1">)); break; // </span><span class="si">{k}</span><span class="s1">"</span>
<span class="s1">                                ) x.free_vars</span>
<span class="s1">                        line s_typ "}"</span>
<span class="s1">                    line s_typ "}"</span>
<span class="s1">                    line s_typ $"__device__ Union</span><span class="si">{i}</span><span class="s1"> &amp; operator=(Union</span><span class="si">{i}</span><span class="s1"> &amp; x) {{" // copy assignment operator</span>
<span class="s1">                    let () =</span>
<span class="s1">                        let s_typ = indent s_typ</span>
<span class="s1">                        line s_typ "if (this-&gt;tag == x.tag) {" </span>
<span class="s1">                        let () =</span>
<span class="s1">                            let s_typ = indent s_typ</span>
<span class="s1">                            line s_typ "switch(x.tag){"</span>
<span class="s1">                            let () = // copy assignment cases</span>
<span class="s1">                                let s_typ = indent s_typ</span>
<span class="s1">                                map_iteri (fun tag k v -&gt; </span>
<span class="s1">                                    line s_typ $"case </span><span class="si">{tag}</span><span class="s1">: this-&gt;case</span><span class="si">{tag}</span><span class="s1"> = x.case</span><span class="si">{tag}</span><span class="s1">; break; // </span><span class="si">{k}</span><span class="s1">"</span>
<span class="s1">                                    ) x.free_vars</span>
<span class="s1">                            line s_typ "}"</span>
<span class="s1">                        line s_typ "} else {"</span>
<span class="s1">                        let () =</span>
<span class="s1">                            let s_typ = indent s_typ</span>
<span class="s1">                            line s_typ $"this-&gt;~Union</span><span class="si">{i}</span><span class="s1">();"</span>
<span class="s1">                            line s_typ $"new (this) Union</span><span class="si">{i}</span><span class="s1">{{x}};"</span>
<span class="s1">                        line s_typ "}"</span>
<span class="s1">                        line s_typ "return *this;"</span>
<span class="s1">                    line s_typ "}"</span>
<span class="s1">                    line s_typ $"__device__ Union</span><span class="si">{i}</span><span class="s1"> &amp; operator=(Union</span><span class="si">{i}</span><span class="s1"> &amp;&amp; x) {{" // move assignment operator</span>
<span class="s1">                    let () =</span>
<span class="s1">                        let s_typ = indent s_typ</span>
<span class="s1">                        line s_typ "if (this-&gt;tag == x.tag) {" </span>
<span class="s1">                        let () =</span>
<span class="s1">                            let s_typ = indent s_typ</span>
<span class="s1">                            line s_typ "switch(x.tag){"</span>
<span class="s1">                            let () = // move assignment cases</span>
<span class="s1">                                let s_typ = indent s_typ</span>
<span class="s1">                                map_iteri (fun tag k v -&gt; </span>
<span class="s1">                                    line s_typ $"case </span><span class="si">{tag}</span><span class="s1">: this-&gt;case</span><span class="si">{tag}</span><span class="s1"> = std::move(x.case</span><span class="si">{tag}</span><span class="s1">); break; // </span><span class="si">{k}</span><span class="s1">"</span>
<span class="s1">                                    ) x.free_vars</span>
<span class="s1">                            line s_typ "}"</span>
<span class="s1">                        line s_typ "} else {"</span>
<span class="s1">                        let () =</span>
<span class="s1">                            let s_typ = indent s_typ</span>
<span class="s1">                            line s_typ $"this-&gt;~Union</span><span class="si">{i}</span><span class="s1">();"</span>
<span class="s1">                            line s_typ $"new (this) Union</span><span class="si">{i}</span><span class="s1">{{std::move(x)}};"</span>
<span class="s1">                        line s_typ "}"</span>
<span class="s1">                        line s_typ "return *this;"</span>
<span class="s1">                    line s_typ "}"</span>
<span class="s1">                    line s_typ $"__device__ ~Union</span><span class="si">{i}</span><span class="s1">() {{"</span>
<span class="s1">                    let () = // destructor</span>
<span class="s1">                        let s_typ = indent s_typ</span>
<span class="s1">                        line s_typ "switch(this-&gt;tag){"</span>
<span class="s1">                        let () = // destructor cases</span>
<span class="s1">                            let s_typ = indent s_typ</span>
<span class="s1">                            map_iteri (fun tag k v -&gt; </span>
<span class="s1">                                line s_typ $"case </span><span class="si">{tag}</span><span class="s1">: this-&gt;case</span><span class="si">{tag}</span><span class="s1">.~Union</span><span class="si">{i}</span><span class="s1">_</span><span class="si">{tag}</span><span class="s1">(); break; // </span><span class="si">{k}</span><span class="s1">"</span>
<span class="s1">                                ) x.free_vars</span>
<span class="s1">                        line s_typ "}"</span>
<span class="s1">                        line s_typ $"this-&gt;tag = </span><span class="si">{max_tag}</span><span class="s1">;"</span>
<span class="s1">                    line s_typ "}"</span>
<span class="s1">                line s_typ "};"</span>
<span class="s1">                )</span>
<span class="s1">        and layout_tmpl is_heap name : _ -&gt; LayoutRecCuda =</span>
<span class="s1">            layout (fun s_fwd s_typ s_fun (x : LayoutRecCuda) -&gt;</span>
<span class="s1">                let name = sprintf "</span><span class="si">%s%i</span><span class="s1">" name x.tag</span>
<span class="s1">                line s_fwd $"struct </span><span class="si">{name}</span><span class="s1">;"</span>
<span class="s1">                line s_typ $"struct </span><span class="si">{name}</span><span class="s1"> {{"</span>
<span class="s1">                let () =</span>
<span class="s1">                    let s_typ = indent s_typ</span>
<span class="s1">                    if is_heap then line s_typ "int refc</span><span class="si">{0}</span><span class="s1">;"</span>
<span class="s1">                    x.free_vars |&gt; print_ordered_args s_typ</span>
<span class="s1">                    let concat x = String.concat ", " x</span>
<span class="s1">                    let args = x.free_vars |&gt; Array.map (fun (L(i,x)) -&gt; $"{tyv x} t</span><span class="si">{i}</span><span class="s1">")</span>
<span class="s1">                    let con_init = x.free_vars |&gt; Array.map (fun (L(i,x)) -&gt; $"v</span><span class="si">{i}</span><span class="s1">(t</span><span class="si">{i}</span><span class="s1">)")</span>
<span class="s1">                    if args.Length &lt;&gt; 0 then</span>
<span class="s1">                        line s_typ $"__device__ </span><span class="si">{name}</span><span class="s1">() = default;"</span>
<span class="s1">                        line s_typ $"__device__ </span><span class="si">{name}</span><span class="s1">({concat args}) : {concat con_init} {{}}" </span>
<span class="s1">                line s_typ "};"</span>
<span class="s1">                )</span>
<span class="s1">        and heap : _ -&gt; LayoutRecCuda = layout_tmpl true "Heap"</span>
<span class="s1">        and mut : _ -&gt; LayoutRecCuda = layout_tmpl true "Mut"</span>
<span class="s1">        and stack_mut : _ -&gt; LayoutRecCuda = layout_tmpl false "StackMut"</span>

<span class="s1">        fun vs (x : TypedBind []) -&gt;</span>
<span class="s1">            let ret_ty =</span>
<span class="s1">                let er() = raise_codegen_error "The return type of the __global__ kernel in the Cuda backend should be a void type or a record of type {cluster_dims : {x : int; y : int; z : int}}."</span>
<span class="s1">                match binds_last_dataCuda x with</span>
<span class="s1">                | DRecord m when m.Count = 1 -&gt;</span>
<span class="s1">                    match Map.tryPick (fun (_, k) v -&gt; if k = "cluster_dims" then Some v else None) m with</span>
<span class="s1">                    | Some(DRecord m) when m.Count = 3 -&gt;</span>
<span class="s1">                        match</span>
<span class="s1">                            Map.tryPick (fun (_, k) v -&gt; if k = "x" then Some v else None) m,</span>
<span class="s1">                            Map.tryPick (fun (_, k) v -&gt; if k = "y" then Some v else None) m,</span>
<span class="s1">                            Map.tryPick (fun (_, k) v -&gt; if k = "z" then Some v else None) m</span>
<span class="s1">                        with</span>
<span class="s1">                        | Some(DSymbol x), Some(DSymbol y), Some(DSymbol z) -&gt;  $"void __cluster_dims__(</span><span class="si">{x}</span><span class="s1">,</span><span class="si">{y}</span><span class="s1">,</span><span class="si">{z}</span><span class="s1">)"</span>
<span class="s1">                        | Some(DV _), _, _</span>
<span class="s1">                        | _, Some(DV _), _</span>
<span class="s1">                        | _, _, Some(DV _) -&gt;  raise_codegen_error "All the variables have to be known at compile time."</span>
<span class="s1">                        | _ -&gt; er()</span>
<span class="s1">                    | _ -&gt; er()</span>
<span class="s1">                | DB -&gt; "void"</span>
<span class="s1">                | _ -&gt; er()</span>
<span class="s1">            let main_defs' = {text=System.Text.StringBuilder(); indent=0}</span>
<span class="s1">            let args = vs |&gt; Array.mapi (fun i (L(_,x)) -&gt; $"{tyv x} v</span><span class="si">{i}</span><span class="s1">") |&gt; String.concat ", "</span>
<span class="s1">            line main_defs' $"extern </span><span class="se">\"</span><span class="s1">C</span><span class="se">\"</span><span class="s1"> __global__ </span><span class="si">{ret_ty}</span><span class="s1"> entry</span><span class="si">%i{main_defs.Count}</span><span class="s1">(</span><span class="si">%s{args}</span><span class="s1">) {{"</span>
<span class="s1">            binds_start (indent main_defs') x</span>
<span class="s1">            line main_defs' "}"</span>
<span class="s1">            main_defs.Add(main_defs'.text.ToString())</span>

<span class="s1">            global' $"using default_int = {prim default_env.default_int};"</span>
<span class="s1">            global' $"using default_uint = {prim default_env.default_uint};"</span>
<span class="s1">            global' (System.IO.File.ReadAllText(System.IO.Path.Join(</span>
<span class="s1">                // AppDomain.CurrentDomain.BaseDirectory,</span>
<span class="s1">                System.IO.Path.Combine (SpiralFileSystem.get_workspace_root (), "deps/The-Spiral-Language/The Spiral Language 2"),</span>
<span class="s1">                "reference_counting.cuh"</span>
<span class="s1">            )))</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=57">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="CodegenPython">CodegenPython<a class="anchor-link" href="#CodegenPython"></a></h2>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=58">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">module</span> <span class="n">CodegenPython</span> <span class="o">=</span>
    <span class="o">//</span> <span class="nb">open</span> <span class="n">System</span>
    <span class="o">//</span> <span class="nb">open</span> <span class="n">System</span><span class="o">.</span><span class="n">Text</span>
    <span class="nb">open</span> <span class="n">System</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">Generic</span>

    <span class="n">let</span> <span class="n">private</span> <span class="n">backend_namePython</span> <span class="o">=</span> <span class="s2">"Python"</span>

    <span class="n">let</span> <span class="n">litPython</span> <span class="o">=</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">LitInt8</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%i</span><span class="s2">"</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">LitInt16</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%i</span><span class="s2">"</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">LitInt32</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%i</span><span class="s2">"</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">LitInt64</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%i</span><span class="s2">"</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">LitUInt8</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%i</span><span class="s2">"</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">LitUInt16</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%i</span><span class="s2">"</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">LitUInt32</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%i</span><span class="s2">"</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">LitUInt64</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sprintf</span> <span class="s2">"</span><span class="si">%i</span><span class="s2">"</span> <span class="n">x</span>
        <span class="o">|</span> <span class="n">LitFloat32</span> <span class="n">x</span> <span class="o">-&gt;</span> 
            <span class="k">if</span> <span class="n">x</span> <span class="o">=</span> <span class="n">infinityf</span> <span class="n">then</span> <span class="s2">"float('inf')"</span>
            <span class="k">elif</span> <span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="n">infinityf</span> <span class="n">then</span> <span class="s2">"float('-inf')"</span>
            <span class="k">elif</span> <span class="n">System</span><span class="o">.</span><span class="n">Single</span><span class="o">.</span><span class="n">IsNaN</span> <span class="n">x</span> <span class="n">then</span> <span class="s2">"float()"</span>
            <span class="k">else</span> <span class="n">x</span><span class="o">.</span><span class="n">ToString</span><span class="p">(</span><span class="s2">"R"</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">add_dec_point</span>
        <span class="o">|</span> <span class="n">LitFloat64</span> <span class="n">x</span> <span class="o">-&gt;</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">=</span> <span class="n">infinity</span> <span class="n">then</span> <span class="s2">"float('inf')"</span>
            <span class="k">elif</span> <span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="n">infinity</span> <span class="n">then</span> <span class="s2">"float('-inf')"</span>
            <span class="k">elif</span> <span class="n">System</span><span class="o">.</span><span class="n">Double</span><span class="o">.</span><span class="n">IsNaN</span> <span class="n">x</span> <span class="n">then</span> <span class="s2">"float()"</span>
            <span class="k">else</span> <span class="n">x</span><span class="o">.</span><span class="n">ToString</span><span class="p">(</span><span class="s2">"R"</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">add_dec_point</span>
        <span class="o">|</span> <span class="n">LitString</span> <span class="n">x</span> <span class="o">-&gt;</span> 
            <span class="n">let</span> <span class="n">strb</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Text</span><span class="o">.</span><span class="n">StringBuilder</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">Length</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">strb</span><span class="o">.</span><span class="n">Append</span> <span class="s1">'"'</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
            <span class="n">String</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">function</span>
                <span class="o">|</span> <span class="s1">'"'</span> <span class="o">-&gt;</span> <span class="n">strb</span><span class="o">.</span><span class="n">Append</span> <span class="s2">"</span><span class="se">\\\"</span><span class="s2">"</span> 
                <span class="o">|</span> <span class="s1">'</span><span class="se">\b</span><span class="s1">'</span> <span class="o">-&gt;</span> <span class="n">strb</span><span class="o">.</span><span class="n">Append</span> <span class="o">@</span><span class="s2">"</span><span class="se">\b</span><span class="s2">"</span>
                <span class="o">|</span> <span class="s1">'</span><span class="se">\t</span><span class="s1">'</span> <span class="o">-&gt;</span> <span class="n">strb</span><span class="o">.</span><span class="n">Append</span> <span class="o">@</span><span class="s2">"</span><span class="se">\t</span><span class="s2">"</span>
                <span class="o">|</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">'</span> <span class="o">-&gt;</span> <span class="n">strb</span><span class="o">.</span><span class="n">Append</span> <span class="o">@</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
                <span class="o">|</span> <span class="s1">'</span><span class="se">\r</span><span class="s1">'</span> <span class="o">-&gt;</span> <span class="n">strb</span><span class="o">.</span><span class="n">Append</span> <span class="o">@</span><span class="s2">"</span><span class="se">\r</span><span class="s2">"</span>
                <span class="o">|</span> <span class="s1">'</span><span class="se">\\</span><span class="s1">'</span> <span class="o">-&gt;</span> <span class="n">strb</span><span class="o">.</span><span class="n">Append</span> <span class="o">@</span><span class="s2">"</span><span class="se">\\</span><span class="s2">"</span>
                <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">strb</span><span class="o">.</span><span class="n">Append</span> <span class="n">x</span>
                <span class="o">&gt;&gt;</span> <span class="n">ignore</span> 
                <span class="p">)</span> <span class="n">x</span>
            <span class="n">strb</span><span class="o">.</span><span class="n">Append</span> <span class="s1">'"'</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
            <span class="n">strb</span><span class="o">.</span><span class="n">ToString</span><span class="p">()</span>
        <span class="o">|</span> <span class="n">LitChar</span> <span class="n">x</span> <span class="o">-&gt;</span> 
            <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
            <span class="o">|</span> <span class="s1">'</span><span class="se">\b</span><span class="s1">'</span> <span class="o">-&gt;</span> <span class="o">@</span><span class="s2">"</span><span class="se">\b</span><span class="s2">"</span>
            <span class="o">|</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">'</span> <span class="o">-&gt;</span> <span class="o">@</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
            <span class="o">|</span> <span class="s1">'</span><span class="se">\t</span><span class="s1">'</span> <span class="o">-&gt;</span> <span class="o">@</span><span class="s2">"</span><span class="se">\t</span><span class="s2">"</span>
            <span class="o">|</span> <span class="s1">'</span><span class="se">\r</span><span class="s1">'</span> <span class="o">-&gt;</span> <span class="o">@</span><span class="s2">"</span><span class="se">\r</span><span class="s2">"</span>
            <span class="o">|</span> <span class="s1">'</span><span class="se">\\</span><span class="s1">'</span> <span class="o">-&gt;</span> <span class="o">@</span><span class="s2">"</span><span class="se">\\</span><span class="s2">"</span>
            <span class="o">|</span> <span class="s1">''' -&gt; @"</span><span class="se">\'</span><span class="s1">"</span>
<span class="s1">            | x -&gt; string x</span>
<span class="s1">            |&gt; sprintf "'</span><span class="si">%s</span><span class="s1">'"</span>
<span class="s1">        | LitBool x -&gt; if x then "True" else "False"</span>

<span class="s1">    let type_litPython = function</span>
<span class="s1">        | YLit x -&gt; litPython x</span>
<span class="s1">        | YSymbol x -&gt; x</span>
<span class="s1">        | x -&gt; raise_codegen_error "Compiler error: Expecting a type literal in the macro." </span>

<span class="s1">    let show_w = function WV(L(i,_)) -&gt; sprintf "v</span><span class="si">%i</span><span class="s1">" i | WLit a -&gt; litPython a</span>
<span class="s1">    let args x = x |&gt; Array.map (fun (L(i,_)) -&gt; sprintf "v</span><span class="si">%i</span><span class="s1">" i) |&gt; String.concat ", "</span>
<span class="s1">    let primPython x = show_primt x</span>
<span class="s1">    let cupy_ty x =</span>
<span class="s1">        match x with</span>
<span class="s1">        | [|L(_,x)|] -&gt;</span>
<span class="s1">            match x with</span>
<span class="s1">            | YPrim x -&gt;</span>
<span class="s1">                match x with</span>
<span class="s1">                | Int8T -&gt; "cp.int8"</span>
<span class="s1">                | Int16T -&gt; "cp.int16"</span>
<span class="s1">                | Int32T -&gt; "cp.int32"</span>
<span class="s1">                | Int64T -&gt; "cp.int64"</span>
<span class="s1">                | UInt8T -&gt; "cp.uint8"</span>
<span class="s1">                | UInt16T -&gt; "cp.uint16"</span>
<span class="s1">                | UInt32T -&gt; "cp.uint32"</span>
<span class="s1">                | UInt64T -&gt; "cp.uint64"</span>
<span class="s1">                | Float32T -&gt; "cp.float32"</span>
<span class="s1">                | Float64T -&gt; "cp.float64"</span>
<span class="s1">                | BoolT -&gt; "cp.bool_"</span>
<span class="s1">                | _ -&gt; "object"</span>
<span class="s1">            | _ -&gt; "object"</span>
<span class="s1">        | _ -&gt; "object"</span>

<span class="s1">    type UnionRecPython = {tag : int; free_vars : Map&lt;int * string, TyV[]&gt;}</span>
<span class="s1">    type LayoutRecPython = {tag : int; data : Data; free_vars : TyV[]; free_vars_by_key : Map&lt;int * string, TyV[]&gt;}</span>
<span class="s1">    type MethodRecPython = {tag : int; free_vars : L&lt;Tag,Ty&gt;[]; range : Ty; body : TypedBind[]}</span>
<span class="s1">    type ClosureRecPython = {tag : int; free_vars : L&lt;Tag,Ty&gt;[]; domain : Ty; domain_args : TyV[]; range : Ty; body : TypedBind[]}</span>

<span class="s1">    type BindsReturnPython =</span>
<span class="s1">        | BindsTailEnd</span>
<span class="s1">        | BindsLocal of TyV []</span>

<span class="s1">    let linePython x s = if s &lt;&gt; "" then x.text.Append(' ', x.indent).AppendLine s |&gt; ignore</span>

<span class="s1">    let codegen' backend_handler (env : PartEvalResult) (x : TypedBind []) =</span>
<span class="s1">        let fwd_dcls = ResizeArray()</span>
<span class="s1">        let types = ResizeArray()</span>
<span class="s1">        let functions = ResizeArray()</span>

<span class="s1">        let global' =</span>
<span class="s1">            let has_added = HashSet env.globals</span>
<span class="s1">            fun x -&gt; if has_added.Add(x) then env.globals.Add x</span>

<span class="s1">        let import x = global' $"import </span><span class="si">{x}</span><span class="s1">"</span>
<span class="s1">        let from x = global' $"from </span><span class="si">{x}</span><span class="s1">"</span>

<span class="s1">        let print is_type show r =</span>
<span class="s1">            let s = {text=System.Text.StringBuilder(); indent=0}</span>
<span class="s1">            show s r</span>
<span class="s1">            let text = s.text.ToString()</span>
<span class="s1">            if is_type then types.Add(text) else functions.Add(text)</span>

<span class="s1">        let union show =</span>
<span class="s1">            let dict = Dictionary(HashIdentity.Reference)</span>
<span class="s1">            let f (a : Union) : UnionRecPython =</span>
<span class="s1">                let free_vars = a.Item.cases |&gt; Map.map (fun _ -&gt; env.ty_to_data &gt;&gt; data_free_vars)</span>
<span class="s1">                {free_vars=free_vars; tag=dict.Count}</span>
<span class="s1">            fun x -&gt;</span>
<span class="s1">                let mutable dirty = false</span>
<span class="s1">                let r = memoize dict (fun x -&gt; dirty &lt;- true; f x) x</span>
<span class="s1">                if dirty then print true show r</span>
<span class="s1">                r</span>

<span class="s1">        let layout show =</span>
<span class="s1">            let dict' = Dictionary(HashIdentity.Structural)</span>
<span class="s1">            let dict = Dictionary(HashIdentity.Reference)</span>
<span class="s1">            let f x : LayoutRecPython = </span>
<span class="s1">                match x with</span>
<span class="s1">                | YLayout(x,_) -&gt;</span>
<span class="s1">                let x = env.ty_to_data x</span>
<span class="s1">                let a, b =</span>
<span class="s1">                    match x with</span>
<span class="s1">                    | DRecord a -&gt; let a = Map.map (fun _ -&gt; data_free_vars) a in a |&gt; Map.toArray |&gt; Array.collect snd, a</span>
<span class="s1">                    | _ -&gt; data_free_vars x, Map.empty</span>
<span class="s1">                {data=x; free_vars=a; free_vars_by_key=b; tag=dict'.Count}</span>
<span class="s1">                | _ -&gt; raise_codegen_error $"Compiler error: Expected a layout type (5).</span><span class="se">\n</span><span class="s1">Got: </span><span class="si">%s</span><span class="s1">{show_ty x}"</span>
<span class="s1">            fun x -&gt;</span>
<span class="s1">                let mutable dirty = false</span>
<span class="s1">                let r = memoize dict (memoize dict' (fun x -&gt; dirty &lt;- true; f x)) x</span>
<span class="s1">                if dirty then print true show r</span>
<span class="s1">                r</span>

<span class="s1">        let jp is_type f show =</span>
<span class="s1">            let dict = Dictionary(HashIdentity.Structural)</span>
<span class="s1">            let f x = f (x, dict.Count)</span>
<span class="s1">            fun x -&gt;</span>
<span class="s1">                let mutable dirty = false</span>
<span class="s1">                let r = memoize dict (fun x -&gt; dirty &lt;- true; f x) x</span>
<span class="s1">                if dirty then print is_type show r</span>
<span class="s1">                r</span>

<span class="s1">        let cupy_ty x = env.ty_to_data x |&gt; data_free_vars |&gt; cupy_ty</span>
<span class="s1">        let rec binds_start (args : TyV []) (s : CodegenEnv) (x : TypedBind []) = binds (refc_prepass Set.empty (Set args) x).g_decr s BindsTailEnd x</span>
<span class="s1">        and binds g_decr (s : CodegenEnv) (ret : BindsReturnPython) (stmts : TypedBind []) = </span>
<span class="s1">            let s_len = s.text.Length</span>
<span class="s1">            let tup_destruct (a,b) =</span>
<span class="s1">                if 0 &lt; Array.length a then</span>
<span class="s1">                    let a = args a</span>
<span class="s1">                    let b = Array.map show_w (data_term_vars b) |&gt; String.concat ", "</span>
<span class="s1">                    sprintf "</span><span class="si">%s</span><span class="s1"> = </span><span class="si">%s</span><span class="s1">" a b |&gt; line s</span>
<span class="s1">            Array.iter (fun x -&gt;</span>
<span class="s1">                let _ =</span>
<span class="s1">                    let f (g : Dictionary&lt;_,_&gt;) = match g.TryGetValue(x) with true, x -&gt; Seq.toArray x | _ -&gt; [||]</span>
<span class="s1">                    match args (f g_decr) with "" -&gt; () | x -&gt; sprintf "del </span><span class="si">%s</span><span class="s1">" x |&gt; line s</span>
<span class="s1">                match x with</span>
<span class="s1">                | TyLet(d,trace,a) -&gt;</span>
<span class="s1">                    try op g_decr s (BindsLocal (data_free_vars d)) a</span>
<span class="s1">                    with :? CodegenError as e -&gt; raise_codegen_error' trace (e.Data0,e.Data1)</span>
<span class="s1">                | TyLocalReturnOp(trace,a,_) -&gt;</span>
<span class="s1">                    try op g_decr s ret a</span>
<span class="s1">                    with :? CodegenError as e -&gt; raise_codegen_error' trace (e.Data0,e.Data1)</span>
<span class="s1">                | TyLocalReturnData(d,trace) -&gt;</span>
<span class="s1">                    try match ret with</span>
<span class="s1">                        | BindsLocal l -&gt; tup_destruct (l, d) </span>
<span class="s1">                        | BindsTailEnd -&gt; line s $"return {tup_data' d}"</span>
<span class="s1">                    with :? CodegenError as e -&gt; raise_codegen_error' trace (e.Data0,e.Data1)</span>
<span class="s1">                ) stmts</span>
<span class="s1">            if s.text.Length = s_len then line s "pass"</span>
<span class="s1">        and tup_data' x = </span>
<span class="s1">            match Array.map show_w (data_term_vars x) with</span>
<span class="s1">            | [||] -&gt; ""</span>
<span class="s1">            | [|x|] -&gt; x</span>
<span class="s1">            | args -&gt; String.concat ", " args</span>
<span class="s1">        and tup_data x = </span>
<span class="s1">            match Array.map show_w (data_term_vars x) with</span>
<span class="s1">            | [||] -&gt; "None"</span>
<span class="s1">            | [|x|] -&gt; x</span>
<span class="s1">            | args -&gt; sprintf "(</span><span class="si">%s</span><span class="s1">)" (String.concat ", " args)</span>
<span class="s1">        and tyv x =</span>
<span class="s1">            match x with</span>
<span class="s1">            | YUnion a -&gt;</span>
<span class="s1">                match a.Item.layout with</span>
<span class="s1">                | UHeap -&gt; sprintf "UH</span><span class="si">%i</span><span class="s1">" (uheap a).tag</span>
<span class="s1">                | UStack -&gt; sprintf "US</span><span class="si">%i</span><span class="s1">" (ustack a).tag</span>
<span class="s1">            | YLayout(_,lay) as a -&gt; </span>
<span class="s1">                match lay with</span>
<span class="s1">                | Heap -&gt; sprintf "Heap</span><span class="si">%i</span><span class="s1">" (heap a).tag</span>
<span class="s1">                | HeapMutable -&gt; sprintf "Mut</span><span class="si">%i</span><span class="s1">" (mut a).tag</span>
<span class="s1">                | StackMutable -&gt; raise_codegen_error "Compiler error: The Python backend doesn't support stack mutable layout types."</span>
<span class="s1">            | YMacro [Text "backend_switch "; Type (YRecord r)] -&gt;</span>
<span class="s1">                match r |&gt; Map.tryPick (fun (_, k) v -&gt; if k = backend_namePython then Some v else None) with</span>
<span class="s1">                | Some x -&gt; tup_ty x</span>
<span class="s1">                | None -&gt; raise_codegen_error $"In the backend_switch, expected a record with the '</span><span class="si">{backend_namePython}</span><span class="s1">' field."</span>
<span class="s1">            | YMacro a -&gt;</span>
<span class="s1">                a</span>
<span class="s1">                |&gt; List.map (function</span>
<span class="s1">                    | Text a -&gt; a</span>
<span class="s1">                    | Type a -&gt; tup_ty a</span>
<span class="s1">                    | TypeLit a -&gt; type_litPython a</span>
<span class="s1">                )</span>
<span class="s1">                |&gt; String.concat ""</span>
<span class="s1">            | YPrim a -&gt; primPython a</span>
<span class="s1">            | YArray a -&gt; "(cp if cuda else np).ndarray"</span>
<span class="s1">            | YFun(a,b,FT_Vanilla) -&gt; </span>
<span class="s1">                let a = env.ty_to_data a |&gt; data_free_vars |&gt; Array.map (fun (L(_,t)) -&gt; tyv t) |&gt; String.concat ", "</span>
<span class="s1">                $"Callable[[</span><span class="si">{a}</span><span class="s1">], {tup_ty b}]"</span>
<span class="s1">            | YExists -&gt; raise_codegen_error "Existentials are not supported at runtime. They are a compile time feature only."</span>
<span class="s1">            | YForall -&gt; raise_codegen_error "Foralls are not supported at runtime. They are a compile time feature only."</span>
<span class="s1">            | a -&gt; raise_codegen_error $"Complier error: Type not supported in the codegen.</span><span class="se">\n</span><span class="s1">Got: %A</span><span class="si">{a}</span><span class="s1">"</span>
<span class="s1">        and tup_ty x =</span>
<span class="s1">            match env.ty_to_data x |&gt; data_free_vars |&gt; Array.map (fun (L(_,t)) -&gt; tyv t) with</span>
<span class="s1">            | [||] -&gt; "None"</span>
<span class="s1">            | [|x|] -&gt; x</span>
<span class="s1">            | x -&gt; String.concat ", " x |&gt; sprintf "Tuple[</span><span class="si">%s</span><span class="s1">]"</span>
<span class="s1">        and op g_decr s (ret : BindsReturnPython) a =</span>
<span class="s1">            let return' (x : string) =</span>
<span class="s1">                match ret with</span>
<span class="s1">                | BindsTailEnd -&gt; line s $"return </span><span class="si">{x}</span><span class="s1">"</span>
<span class="s1">                | BindsLocal ret -&gt; line s (if ret.Length = 0 then x else sprintf "</span><span class="si">%s</span><span class="s1"> = </span><span class="si">%s</span><span class="s1">" (args ret) x)</span>
<span class="s1">            let jp (a,b) =</span>
<span class="s1">                let args = args b</span>
<span class="s1">                match a with</span>
<span class="s1">                | JPMethod(a,b) -&gt; sprintf "method</span><span class="si">%i</span><span class="s1">(</span><span class="si">%s</span><span class="s1">)" (method (a,b)).tag args</span>
<span class="s1">                | JPClosure(a,b) -&gt; sprintf "Closure</span><span class="si">%i</span><span class="s1">(</span><span class="si">%s</span><span class="s1">)" (closure (a,b)).tag args</span>
<span class="s1">            let layout_index i x' =</span>
<span class="s1">                x' |&gt; Array.map (fun (L(i',_)) -&gt; $"v</span><span class="si">{i}</span><span class="s1">.v{i'}")</span>
<span class="s1">                |&gt; String.concat ", "</span>
<span class="s1">                |&gt; return'</span>

<span class="s1">            match a with</span>
<span class="s1">            | TySizeOf t -&gt; raise_codegen_error $"The following type in `sizeof` is not supported in the Python back end.</span><span class="se">\n</span><span class="s1">Got: {show_ty t}"</span>
<span class="s1">            | TyMacro a -&gt;</span>
<span class="s1">                // System.Console.WriteLine $"CodegenPython.TyMacro / a: %A</span><span class="si">{a}</span><span class="s1">"</span>
<span class="s1">                a</span>
<span class="s1">                |&gt; List.map (function</span>
<span class="s1">                    | CMText x when x |&gt; SpiralSm.starts_with "$</span><span class="se">\"</span><span class="s1">" -&gt;</span>
<span class="s1">                        let x = x |&gt; SpiralSm.replace "%A{" "{"</span>
<span class="s1">                        $"f</span><span class="se">\"</span><span class="s1">{x.[2..]}"</span>
<span class="s1">                    | CMText x -&gt; x</span>
<span class="s1">                    | CMTerm x -&gt; tup_data x</span>
<span class="s1">                    | CMType x -&gt; tup_ty x</span>
<span class="s1">                    | CMTypeLit a -&gt; type_litPython a</span>
<span class="s1">                )</span>
<span class="s1">                |&gt; String.concat ""</span>
<span class="s1">                |&gt; return'</span>
<span class="s1">            | TyIf(cond,tr,fl) -&gt;</span>
<span class="s1">                line s (sprintf "if </span><span class="si">%s</span><span class="s1">:" (tup_data cond))</span>
<span class="s1">                binds g_decr (indent s) ret tr</span>
<span class="s1">                line s "else:"</span>
<span class="s1">                binds g_decr (indent s) ret fl</span>
<span class="s1">            | TyJoinPoint(a,args) -&gt; return' (jp (a, args))</span>
<span class="s1">            | TyBackend(a,b,c) -&gt; return' (backend_handler (a,b,c))</span>
<span class="s1">            | TyWhile(a,b) -&gt;</span>
<span class="s1">                line s (sprintf "while </span><span class="si">%s</span><span class="s1">:" (jp a))</span>
<span class="s1">                binds g_decr (indent s) (BindsLocal [||]) b</span>
<span class="s1">            | TyDo a -&gt;</span>
<span class="s1">                binds g_decr s ret a</span>
<span class="s1">            | TyIndent a -&gt;</span>
<span class="s1">                binds g_decr (indent s) ret a</span>
<span class="s1">            | TyIntSwitch(L(v_i,_),on_succ,on_fail) -&gt;</span>
<span class="s1">                Array.iteri (fun i x -&gt;</span>
<span class="s1">                    if i = 0 then line s $"if v</span><span class="si">{v_i}</span><span class="s1"> == </span><span class="si">{i}</span><span class="s1">:"</span>
<span class="s1">                    else line s $"elif v</span><span class="si">{v_i}</span><span class="s1"> == </span><span class="si">{i}</span><span class="s1">:"</span>
<span class="s1">                    binds g_decr (indent s) ret x</span>
<span class="s1">                    ) on_succ</span>
<span class="s1">                line s "else:"</span>
<span class="s1">                binds g_decr (indent s) ret on_fail</span>
<span class="s1">            | TyUnionUnbox(is,x,on_succs,on_fail) -&gt;</span>
<span class="s1">                let case_tags = x.Item.tags</span>
<span class="s1">                line s (sprintf "match </span><span class="si">%s</span><span class="s1">:" (is |&gt; List.map (fun (L(i,_)) -&gt; $"v</span><span class="si">{i}</span><span class="s1">") |&gt; String.concat ", "))</span>
<span class="s1">                let s = indent s</span>
<span class="s1">                let prefix = </span>
<span class="s1">                    match x.Item.layout with</span>
<span class="s1">                    | UHeap -&gt; sprintf "UH</span><span class="si">%i</span><span class="s1">" (uheap x).tag</span>
<span class="s1">                    | UStack -&gt; sprintf "US</span><span class="si">%i</span><span class="s1">" (ustack x).tag</span>
<span class="s1">                Map.iter (fun k (a,b) -&gt;</span>
<span class="s1">                    let i = case_tags.[k]</span>
<span class="s1">                    let cases = </span>
<span class="s1">                        a |&gt; List.map (fun a -&gt;</span>
<span class="s1">                            let x = data_free_vars a</span>
<span class="s1">                            let g_decr' = get_default g_decr (Array.head b) (fun () -&gt; Set.empty)</span>
<span class="s1">                            let x,g_decr' = Array.mapFold (fun g_decr (L(i,_) as v) -&gt; if Set.contains v g_decr then "_", Set.remove v g_decr else sprintf "v</span><span class="si">%i</span><span class="s1">" i, g_decr) g_decr' x</span>
<span class="s1">                            g_decr.[Array.head b] &lt;- g_decr'</span>
<span class="s1">                            sprintf "</span><span class="si">%s</span><span class="s1">_</span><span class="si">%i</span><span class="s1">(</span><span class="si">%s</span><span class="s1">)" prefix i (String.concat ", " x)</span>
<span class="s1">                            )</span>
<span class="s1">                        |&gt; String.concat ", "</span>
<span class="s1">                    line s (sprintf "case </span><span class="si">%s</span><span class="s1">: # </span><span class="si">%s</span><span class="s1">" cases k)</span>
<span class="s1">                    binds g_decr (indent s) ret b</span>
<span class="s1">                    ) on_succs</span>
<span class="s1">                line s "case t:"</span>
<span class="s1">                match on_fail with</span>
<span class="s1">                | Some b -&gt; binds g_decr (indent s) ret b</span>
<span class="s1">                | None -&gt; line (indent s) "raise Exception(f'Pattern matching miss. Got: </span><span class="si">{t}</span><span class="s1">')"</span>
<span class="s1">            | TyUnionBox(a,b,c') -&gt;</span>
<span class="s1">                let c = c'.Item</span>
<span class="s1">                let i = c.tags.[a]</span>
<span class="s1">                let vars = tup_data' b</span>
<span class="s1">                match c.layout with</span>
<span class="s1">                | UHeap -&gt; sprintf "UH</span><span class="si">%i</span><span class="s1">_</span><span class="si">%i</span><span class="s1">(</span><span class="si">%s</span><span class="s1">)" (uheap c').tag i vars</span>
<span class="s1">                | UStack -&gt; sprintf "US</span><span class="si">%i</span><span class="s1">_</span><span class="si">%i</span><span class="s1">(</span><span class="si">%s</span><span class="s1">)" (ustack c').tag i vars</span>
<span class="s1">                |&gt; return'</span>
<span class="s1">            | TyToLayout(a,b) -&gt; </span>
<span class="s1">                match b with</span>
<span class="s1">                | YLayout(_,layout) -&gt; </span>
<span class="s1">                    match layout with</span>
<span class="s1">                    | Heap -&gt; sprintf "Heap</span><span class="si">%i</span><span class="s1">(</span><span class="si">%s</span><span class="s1">)" (heap b).tag (tup_data' a)</span>
<span class="s1">                    | HeapMutable -&gt; sprintf "Mut</span><span class="si">%i</span><span class="s1">(</span><span class="si">%s</span><span class="s1">)" (mut b).tag (tup_data' a)</span>
<span class="s1">                    | StackMutable -&gt; raise_codegen_error "The Python backend doesn't support stack mutable layout types."</span>
<span class="s1">                | _ -&gt; raise_codegen_error "Compiler error: Expected a layout type (6)."</span>
<span class="s1">                |&gt; return'</span>
<span class="s1">            | TyLayoutIndexAll(L(i,YLayout(_,lay) &amp; a)) -&gt; </span>
<span class="s1">                match lay with</span>
<span class="s1">                | Heap -&gt; heap a </span>
<span class="s1">                | HeapMutable -&gt; mut a</span>
<span class="s1">                | StackMutable -&gt; raise_codegen_error "The Python backend doesn't support indexing into stack mutable layout types."</span>
<span class="s1">                |&gt; fun x -&gt; x.free_vars |&gt; layout_index i</span>
<span class="s1">            | TyLayoutIndexByKey(L(i,YLayout(_,lay) &amp; a),key) -&gt;</span>
<span class="s1">                match lay with</span>
<span class="s1">                | Heap -&gt; heap a </span>
<span class="s1">                | HeapMutable -&gt; mut a</span>
<span class="s1">                | StackMutable -&gt; raise_codegen_error "The Python backend doesn't support indexing into stack mutable layout types."</span>
<span class="s1">                |&gt; fun x -&gt;</span>
<span class="s1">                    x.free_vars_by_key</span>
<span class="s1">                    |&gt; Map.tryPick (fun (_, k) v -&gt; if k = key then Some v else None)</span>
<span class="s1">                    |&gt; Option.iter (layout_index i)</span>
<span class="s1">            | TyLayoutIndexAll _ | TyLayoutIndexByKey _ -&gt; raise_codegen_error "Compiler error: Expected the TyV in layout index to be a layout type."</span>
<span class="s1">            | TyLayoutMutableSet(L(i,t),b,c) -&gt;</span>
<span class="s1">                let a = List.fold (fun s k -&gt;</span>
<span class="s1">                    match s with</span>
<span class="s1">                    | DRecord l -&gt; l |&gt; Map.pick (fun (_,k') v -&gt; if k = k' then Some v else None)</span>
<span class="s1">                    | _ -&gt; raise_codegen_error "Compiler error: Expected a record.") (mut t).data b</span>
<span class="s1">                Array.iter2 (fun (L(i',_)) b -&gt; line s $"v</span><span class="si">{i}</span><span class="s1">.v{i'} = {show_w b}") (data_free_vars a) (data_term_vars c)</span>
<span class="s1">            | TyArrayLiteral(a,b) -&gt; return' &lt;| sprintf "(cp if cuda else np).array([</span><span class="si">%s</span><span class="s1">],dtype=</span><span class="si">%s</span><span class="s1">)" (List.map tup_data' b |&gt; String.concat ", ") (cupy_ty a)</span>
<span class="s1">            | TyArrayCreate(a,b) -&gt; return' $"(cp if cuda else np).empty({tup_data b},dtype={cupy_ty a})" </span>
<span class="s1">            | TyFailwith(a,b) -&gt; line s $"raise Exception({tup_data' b})"</span>
<span class="s1">            | TyConv(a,b) -&gt; return' $"{tyv a}({tup_data b})"</span>
<span class="s1">            | TyApply(L(i,_),b) -&gt; return' $"v</span><span class="si">{i}</span><span class="s1">({tup_data' b})"</span>
<span class="s1">            | TyArrayLength(a,b) -&gt; return' $"{tup_data b}.__len__()"</span>
<span class="s1">            | TyStringLength(a,b) -&gt; return' $"len({tup_data b})"</span>
<span class="s1">            | TyOp(Global,[DLit (LitString x)]) -&gt; global' x</span>
<span class="s1">            | TyOp(op,l) -&gt;</span>
<span class="s1">                match op, l with</span>
<span class="s1">                | ToPythonRecord,[DRecord x] -&gt; Map.foldBack (fun k v l -&gt; $"'</span><span class="si">{k}</span><span class="s1">': {tup_data v}" :: l) x [] |&gt; String.concat ", " |&gt; sprintf "{</span><span class="si">%s</span><span class="s1">}"</span>
<span class="s1">                | ToPythonNamedTuple,[n;DRecord x] -&gt; </span>
<span class="s1">                    import "collections"</span>
<span class="s1">                    let field_names = Map.foldBack (fun k v l -&gt; $"'</span><span class="si">{k}</span><span class="s1">'" :: l) x [] |&gt; String.concat ", "</span>
<span class="s1">                    let args = Map.foldBack (fun k v l -&gt; tup_data v :: l) x [] |&gt; String.concat ", "</span>
<span class="s1">                    $"collections.namedtuple({tup_data n},[</span><span class="si">{field_names}</span><span class="s1">])(</span><span class="si">{args}</span><span class="s1">)"</span>
<span class="s1">                | Dyn,[a] -&gt; tup_data a</span>
<span class="s1">                | TypeToVar, _ -&gt; raise_codegen_error "The use of `` should never appear in generated code."</span>
<span class="s1">                | StringIndex, [a;b] -&gt; sprintf "</span><span class="si">%s</span><span class="s1">[</span><span class="si">%s</span><span class="s1">]" (tup_data a) (tup_data b)</span>
<span class="s1">                | StringSlice, [a;b;c] -&gt; sprintf "</span><span class="si">%s</span><span class="s1">[</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">]" (tup_data a) (tup_data b) (tup_data c)</span>
<span class="s1">                | ArrayIndex, [a;b] -&gt; sprintf "</span><span class="si">%s</span><span class="s1">[</span><span class="si">%s</span><span class="s1">].item()" (tup_data a) (tup_data b)</span>
<span class="s1">                | ArrayIndexSet, [a;b;c] -&gt; </span>
<span class="s1">                    match tup_data' c with</span>
<span class="s1">                    | "" -&gt; "pass # void array set"</span>
<span class="s1">                    | c -&gt; sprintf "</span><span class="si">%s</span><span class="s1">[</span><span class="si">%s</span><span class="s1">] = </span><span class="si">%s</span><span class="s1">" (tup_data a) (tup_data b) c</span>
<span class="s1">                // Math</span>
<span class="s1">                | Add, [a;b] -&gt; sprintf "</span><span class="si">%s</span><span class="s1"> + </span><span class="si">%s</span><span class="s1">" (tup_data a) (tup_data b)</span>
<span class="s1">                | Sub, [a;b] -&gt; sprintf "</span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">" (tup_data a) (tup_data b)</span>
<span class="s1">                | Mult, [a;b] -&gt; sprintf "</span><span class="si">%s</span><span class="s1"> * </span><span class="si">%s</span><span class="s1">" (tup_data a) (tup_data b)</span>
<span class="s1">                | Div, [(DV(L(_,YPrim (Float32T | Float64T))) | DLit(LitFloat32 _ | LitFloat64 _)) &amp; a;b] -&gt; sprintf "</span><span class="si">%s</span><span class="s1"> / </span><span class="si">%s</span><span class="s1">" (tup_data a) (tup_data b)</span>
<span class="s1">                | Div, [a;b] -&gt; sprintf "</span><span class="si">%s</span><span class="s1"> // </span><span class="si">%s</span><span class="s1">" (tup_data a) (tup_data b)</span>
<span class="s1">                | Mod, [a;b] -&gt; sprintf "</span><span class="si">%s</span><span class="s1"> </span><span class="si">%%</span><span class="s1"> </span><span class="si">%s</span><span class="s1">" (tup_data a) (tup_data b)</span>
<span class="s1">                | Pow, [a;b] -&gt; sprintf "pow(</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">)" (tup_data a) (tup_data b)</span>
<span class="s1">                | LT, [a;b] -&gt; sprintf "</span><span class="si">%s</span><span class="s1"> &lt; </span><span class="si">%s</span><span class="s1">" (tup_data a) (tup_data b)</span>
<span class="s1">                | LTE, [a;b] -&gt; sprintf "</span><span class="si">%s</span><span class="s1"> &lt;= </span><span class="si">%s</span><span class="s1">" (tup_data a) (tup_data b)</span>
<span class="s1">                | EQ, [a;b] -&gt; sprintf "</span><span class="si">%s</span><span class="s1"> == </span><span class="si">%s</span><span class="s1">" (tup_data a) (tup_data b)</span>
<span class="s1">                | NEQ, [a;b] -&gt; sprintf "</span><span class="si">%s</span><span class="s1"> != </span><span class="si">%s</span><span class="s1">" (tup_data a) (tup_data b)</span>
<span class="s1">                | GT, [a;b] -&gt; sprintf "</span><span class="si">%s</span><span class="s1"> &gt; </span><span class="si">%s</span><span class="s1">" (tup_data a) (tup_data b)</span>
<span class="s1">                | GTE, [a;b] -&gt; sprintf "</span><span class="si">%s</span><span class="s1"> &gt;= </span><span class="si">%s</span><span class="s1">" (tup_data a) (tup_data b)</span>
<span class="s1">                | BoolAnd, [a;b] -&gt; sprintf "</span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1">" (tup_data a) (tup_data b)</span>
<span class="s1">                | BoolOr, [a;b] -&gt; sprintf "</span><span class="si">%s</span><span class="s1"> or </span><span class="si">%s</span><span class="s1">" (tup_data a) (tup_data b)</span>
<span class="s1">                | BitwiseAnd, [a;b] -&gt; sprintf "</span><span class="si">%s</span><span class="s1"> &amp; </span><span class="si">%s</span><span class="s1">" (tup_data a) (tup_data b)</span>
<span class="s1">                | BitwiseOr, [a;b] -&gt; sprintf "</span><span class="si">%s</span><span class="s1"> | </span><span class="si">%s</span><span class="s1">" (tup_data a) (tup_data b)</span>
<span class="s1">                | BitwiseXor, [a;b] -&gt; sprintf "</span><span class="si">%s</span><span class="s1"> ^ </span><span class="si">%s</span><span class="s1">" (tup_data a) (tup_data b)</span>
<span class="s1">                | BitwiseComplement, [a] -&gt; sprintf "~</span><span class="si">%s</span><span class="s1">" (tup_data a)</span>

<span class="s1">                | ShiftLeft, [a;b] -&gt; sprintf "</span><span class="si">%s</span><span class="s1"> &lt;&lt; </span><span class="si">%s</span><span class="s1">" (tup_data a) (tup_data b)</span>
<span class="s1">                | ShiftRight, [a;b] -&gt; sprintf "</span><span class="si">%s</span><span class="s1"> &gt;&gt; </span><span class="si">%s</span><span class="s1">" (tup_data a) (tup_data b)</span>

<span class="s1">                | Neg, [x] -&gt; sprintf "-</span><span class="si">%s</span><span class="s1">" (tup_data x)</span>
<span class="s1">                | Log, [x] -&gt; import "math"; sprintf "math.log(</span><span class="si">%s</span><span class="s1">)" (tup_data x)</span>
<span class="s1">                | Exp, [x] -&gt; import "math"; sprintf "math.exp(</span><span class="si">%s</span><span class="s1">)" (tup_data x)</span>
<span class="s1">                | Tanh, [x] -&gt; import "math"; sprintf "math.tanh(</span><span class="si">%s</span><span class="s1">)" (tup_data x)</span>
<span class="s1">                | Sqrt, [x] -&gt; import "math"; sprintf "math.sqrt(</span><span class="si">%s</span><span class="s1">)" (tup_data x)</span>
<span class="s1">                | Sin, [x] -&gt; import "math"; sprintf "math.sin(</span><span class="si">%s</span><span class="s1">)" (tup_data x)</span>
<span class="s1">                | Cos, [x] -&gt; import "math"; sprintf "math.cos(</span><span class="si">%s</span><span class="s1">)" (tup_data x)</span>
<span class="s1">                | NanIs, [x] -&gt; import "math"; sprintf "math.isnan(</span><span class="si">%s</span><span class="s1">)" (tup_data x)</span>
<span class="s1">                | UnionTag, [DUnion(_,l) | DV(L(_,YUnion l)) as x] -&gt; sprintf "</span><span class="si">%s</span><span class="s1">.tag" (tup_data x) </span>
<span class="s1">                | _ -&gt; raise_codegen_error &lt;| sprintf "Compiler error: %A with </span><span class="si">%i</span><span class="s1"> args not supported" op l.Length</span>
<span class="s1">                |&gt; return'</span>
<span class="s1">        and uheap : _ -&gt; UnionRecPython = union (fun s x -&gt;</span>
<span class="s1">            let cases = Array.init x.free_vars.Count (fun i -&gt; $"</span><span class="se">\"</span><span class="s1">UH</span><span class="si">{x.tag}</span><span class="s1">_</span><span class="si">{i}</span><span class="se">\"</span><span class="s1">") |&gt; function [|x|] -&gt; x | x -&gt; x |&gt; String.concat ", " |&gt; sprintf "Union[</span><span class="si">%s</span><span class="s1">]"</span>
<span class="s1">            fwd_dcls.Add $"UH</span><span class="si">{x.tag}</span><span class="s1"> = </span><span class="si">{cases}</span><span class="s1">"</span>
<span class="s1">            let mutable i = 0</span>
<span class="s1">            x.free_vars |&gt; Map.iter (fun k a -&gt;</span>
<span class="s1">                line s $"class UH</span><span class="si">{x.tag}</span><span class="s1">_</span><span class="si">{i}</span><span class="s1">(NamedTuple): # </span><span class="si">{k}</span><span class="s1">"</span>
<span class="s1">                let s = indent s</span>
<span class="s1">                a |&gt; Array.iter (fun (L(i,t)) -&gt; line s $"v</span><span class="si">{i}</span><span class="s1"> : {tyv t}")</span>
<span class="s1">                line s $"tag = </span><span class="si">{i}</span><span class="s1">"</span>
<span class="s1">                i &lt;- i+1</span>
<span class="s1">                )</span>
<span class="s1">            )</span>
<span class="s1">        and ustack : _ -&gt; UnionRecPython = union (fun s x -&gt;</span>
<span class="s1">            let mutable i = 0</span>
<span class="s1">            x.free_vars |&gt; Map.iter (fun k a -&gt;</span>
<span class="s1">                line s $"class US</span><span class="si">{x.tag}</span><span class="s1">_</span><span class="si">{i}</span><span class="s1">(NamedTuple): # </span><span class="si">{k}</span><span class="s1">"</span>
<span class="s1">                let s = indent s</span>
<span class="s1">                a |&gt; Array.iter (fun (L(i,t)) -&gt; line s $"v</span><span class="si">{i}</span><span class="s1"> : {tyv t}")</span>
<span class="s1">                line s $"tag = </span><span class="si">{i}</span><span class="s1">"</span>
<span class="s1">                i &lt;- i+1</span>
<span class="s1">                )</span>
<span class="s1">            let cases = Array.init x.free_vars.Count (fun i -&gt; $"US</span><span class="si">{x.tag}</span><span class="s1">_</span><span class="si">{i}</span><span class="s1">") |&gt; function [|x|] -&gt; x | x -&gt; x |&gt; String.concat ", " |&gt; sprintf "Union[</span><span class="si">%s</span><span class="s1">]"</span>
<span class="s1">            line s $"US</span><span class="si">{x.tag}</span><span class="s1"> = </span><span class="si">{cases}</span><span class="s1">"</span>
<span class="s1">            )</span>
<span class="s1">        and heap : _ -&gt; LayoutRecPython = layout (fun s x -&gt; </span>
<span class="s1">            line s $"class Heap</span><span class="si">{x.tag}</span><span class="s1">(NamedTuple):"</span>
<span class="s1">            let s = indent s</span>
<span class="s1">            if x.free_vars.Length = 0 then line s "pass" </span>
<span class="s1">            else x.free_vars |&gt; Array.iter (fun (L(i,t)) -&gt; line s $"v</span><span class="si">{i}</span><span class="s1"> : {tyv t}")</span>
<span class="s1">            )</span>
<span class="s1">        and mut : _ -&gt; LayoutRecPython = layout (fun s x -&gt; </span>
<span class="s1">            line s "@dataclass"</span>
<span class="s1">            line s $"class Mut</span><span class="si">{x.tag}</span><span class="s1">:"</span>
<span class="s1">            let s = indent s</span>
<span class="s1">            if x.free_vars.Length = 0 then line s "pass" </span>
<span class="s1">            else x.free_vars |&gt; Array.iter (fun (L(i,t)) -&gt; line s $"v</span><span class="si">{i}</span><span class="s1"> : {tyv t}")</span>
<span class="s1">            )</span>
<span class="s1">        and method : _ -&gt; MethodRecPython =</span>
<span class="s1">            jp false (fun ((jp_body,key &amp; (C(args,_))),i) -&gt;</span>
<span class="s1">                match (fst env.join_point_method.[jp_body]).[key] with</span>
<span class="s1">                | Some a, Some range, _ -&gt; {tag=i; free_vars=rdata_free_vars args; range=range; body=a}</span>
<span class="s1">                | _ -&gt; raise_codegen_error "Compiler error: The method dictionary is malformed"</span>
<span class="s1">                ) (fun s x -&gt;</span>
<span class="s1">                let method_args = x.free_vars |&gt; Array.map (fun (L(i,t)) -&gt; $"v</span><span class="si">{i}</span><span class="s1"> : {tyv t}") |&gt; String.concat ", "</span>
<span class="s1">                line s $"def method</span><span class="si">{x.tag}</span><span class="s1">(</span><span class="si">{method_args}</span><span class="s1">) -&gt; {tup_ty x.range}:"</span>
<span class="s1">                binds_start x.free_vars (indent s) x.body</span>
<span class="s1">                )</span>
<span class="s1">        and closure : _ -&gt; ClosureRecPython =</span>
<span class="s1">            jp true (fun ((jp_body,key &amp; (C(args,_,fun_ty))),i) -&gt;</span>
<span class="s1">                match fun_ty with</span>
<span class="s1">                | YFun(domain,range,FT_Vanilla) -&gt;</span>
<span class="s1">                    match (fst env.join_point_closure.[jp_body]).[key] with</span>
<span class="s1">                    | Some(domain_args, body) -&gt; {tag=i; free_vars=rdata_free_vars args; domain=domain; domain_args=data_free_vars domain_args; range=range; body=body}</span>
<span class="s1">                    | _ -&gt; raise_codegen_error "Compiler error: The method dictionary is malformed"</span>
<span class="s1">                | YFun _ -&gt; raise_codegen_error "Non-standard functions are not supported in the Python backend."</span>
<span class="s1">                | _ -&gt; raise_codegen_error "Compiler error: Unexpected type in the closure join point."</span>
<span class="s1">                ) (fun s x -&gt;</span>
<span class="s1">                let env_args = x.free_vars |&gt; Array.map (fun (L(i,t)) -&gt; $"env_v</span><span class="si">{i}</span><span class="s1"> : {tyv t}") |&gt; String.concat ", "</span>
<span class="s1">                line s $"def Closure</span><span class="si">{x.tag}</span><span class="s1">(</span><span class="si">{env_args}</span><span class="s1">):"</span>
<span class="s1">                let s = indent s</span>
<span class="s1">                let inner_args = x.domain_args |&gt; Array.map (fun (L(i,t)) -&gt; $"v</span><span class="si">{i}</span><span class="s1"> : {tyv t}") |&gt; String.concat ", "</span>
<span class="s1">                line s $"def inner(</span><span class="si">{inner_args}</span><span class="s1">) -&gt; {tup_ty x.range}:"</span>
<span class="s1">                let _ =</span>
<span class="s1">                    let s = indent s</span>
<span class="s1">                    if x.free_vars.Length &gt; 0 then </span>
<span class="s1">                        let nonlocal_args = x.free_vars |&gt; Array.map (fun (L(i,t)) -&gt; $"env_v</span><span class="si">{i}</span><span class="s1">") |&gt; String.concat ", "</span>
<span class="s1">                        line s $"nonlocal </span><span class="si">{nonlocal_args}</span><span class="s1">"</span>
<span class="s1">                        x.free_vars |&gt; Array.map (fun (L(i,t)) -&gt; $"v</span><span class="si">{i}</span><span class="s1"> = env_v</span><span class="si">{i}</span><span class="s1">") |&gt; String.concat "; " |&gt; line s</span>
<span class="s1">                    binds_start x.free_vars s x.body</span>
<span class="s1">                line s "return inner"</span>
<span class="s1">                )</span>

<span class="s1">        import "cupy as cp"</span>
<span class="s1">        import "numpy as np"</span>
<span class="s1">        from "dataclasses import dataclass"</span>
<span class="s1">        from "typing import NamedTuple, Union, Callable, Tuple"</span>
<span class="s1">        env.globals.Add "i8 = int; i16 = int; i32 = int; i64 = int; u8 = int; u16 = int; u32 = int; u64 = int; f32 = float; f64 = float; char = str; string = str"</span>
<span class="s1">        env.globals.Add "cuda = False"</span>
<span class="s1">        env.globals.Add ""</span>

<span class="s1">        let main = System.Text.StringBuilder()</span>
<span class="s1">        let s = {text=main; indent=0}</span>
<span class="s1">        </span>
<span class="s1">        line s "def main_body():"</span>
<span class="s1">        binds_start [||] (indent s) x</span>
<span class="s1">        s.text.AppendLine() |&gt; ignore</span>

<span class="s1">        line s "def main():"</span>
<span class="s1">        line (indent s) "r = main_body()"</span>
<span class="s1">        line (indent s) "if cuda: cp.cuda.get_current_stream().synchronize() # This line is here so the `__trap()` calls on the kernel aren't missed."</span>
<span class="s1">        line (indent s) "return r"</span>
<span class="s1">        s.text.AppendLine() |&gt; ignore</span>

<span class="s1">        line s "if __name__ == '__main__': result = main(); None if result is None else print(result)"</span>

<span class="s1">        let program = System.Text.StringBuilder()</span>
<span class="s1">        env.globals |&gt; Seq.iter (fun x -&gt; program.AppendLine(x) |&gt; ignore)</span>
<span class="s1">        fwd_dcls |&gt; Seq.iter (fun x -&gt; program.AppendLine(x) |&gt; ignore)</span>
<span class="s1">        types |&gt; Seq.iter (fun x -&gt; program.Append(x) |&gt; ignore)</span>
<span class="s1">        functions |&gt; Seq.iter (fun x -&gt; program.Append(x) |&gt; ignore)</span>
<span class="s1">        program.Append(main).ToString()</span>

<span class="s1">    let codegenPython (default_env : DefaultEnv) env x = </span>
<span class="s1">        let cuda_kernels = System.Text.StringBuilder().AppendLine("kernel = r</span><span class="se">\"\"\"</span><span class="s1">")</span>
<span class="s1">        let g = Dictionary(HashIdentity.Structural)</span>
<span class="s1">        let globals, fwd_dcls, types, functions, main_defs as ars = ResizeArray(), ResizeArray(), ResizeArray(), ResizeArray(), ResizeArray()</span>

<span class="s1">        let codegen = CodegenCuda.codegenCuda default_env ars env</span>
<span class="s1">        let python_code =</span>
<span class="s1">            codegen' (fun (jp_body,key,r') -&gt;</span>
<span class="s1">                let backend_name = (fst jp_body).node</span>
<span class="s1">                match backend_name with</span>
<span class="s1">                | "Cuda" -&gt; </span>
<span class="s1">                    memoize g (fun (jp_body,key &amp; (C(args,_))) -&gt;</span>
<span class="s1">                        let args = rdata_free_vars args</span>
<span class="s1">                        match (fst env.join_point_method.[jp_body]).[key] with</span>
<span class="s1">                        | Some a, Some _, _ -&gt; codegen args a</span>
<span class="s1">                        | _ -&gt; raise_codegen_error "Compiler error: The method dictionary is malformed"</span>
<span class="s1">                        string g.Count</span>
<span class="s1">                        ) (jp_body,key)</span>
<span class="s1">                | x -&gt; raise_codegen_error_backend r' $"The Python + Cuda backend does not support the </span><span class="si">{x}</span><span class="s1"> backend."</span>
<span class="s1">                ) env x</span>

<span class="s1">        globals |&gt; Seq.iter (fun x -&gt; cuda_kernels.AppendLine(x) |&gt; ignore)</span>
<span class="s1">        fwd_dcls |&gt; Seq.iter (fun x -&gt; cuda_kernels.Append(x) |&gt; ignore)</span>
<span class="s1">        types |&gt; Seq.iter (fun x -&gt; cuda_kernels.Append(x) |&gt; ignore)</span>
<span class="s1">        functions |&gt; Seq.iter (fun x -&gt; cuda_kernels.Append(x) |&gt; ignore)</span>
<span class="s1">        main_defs |&gt; Seq.iter (fun x -&gt; cuda_kernels.Append(x) |&gt; ignore)</span>

<span class="s1">        cuda_kernels</span>
<span class="s1">            .AppendLine("</span><span class="se">\"\"\"</span><span class="s1">")</span>
<span class="s1">            .AppendLine(System.IO.File.ReadAllText(System.IO.Path.Join(</span>
<span class="s1">    #if !INTERACTIVE</span>
<span class="s1">                // AppDomain.CurrentDomain.BaseDirectory,</span>
<span class="s1">                System.IO.Path.Combine (SpiralFileSystem.get_workspace_root (), "deps/The-Spiral-Language/The Spiral Language 2"),</span>
<span class="s1">    #else</span>
<span class="s1">                System.IO.Path.Combine (SpiralFileSystem.get_workspace_root (), "deps/The-Spiral-Language/The Spiral Language 2"),</span>
<span class="s1">    #endif</span>
<span class="s1">                "reference_counting.py"</span>
<span class="s1">            )))</span>
<span class="s1">            .Append(python_code).ToString()</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=59">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="WDiff">WDiff<a class="anchor-link" href="#WDiff"></a></h2>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=60">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="o">//</span> <span class="nb">open</span> <span class="n">System</span>
<span class="nb">open</span> <span class="n">System</span><span class="o">.</span><span class="n">IO</span>
<span class="nb">open</span> <span class="n">System</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">Generic</span>

<span class="o">//</span> <span class="n">Full</span> <span class="n">name</span><span class="p">:</span> <span class="n">Microsoft</span><span class="o">.</span><span class="n">FSharp</span><span class="o">.</span><span class="n">Core</span><span class="o">.</span><span class="n">Result</span><span class="o">&lt;</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="o">&gt;.</span><span class="n">Ok</span>

<span class="nb">open</span> <span class="n">FSharp</span><span class="o">.</span><span class="n">Core</span>

<span class="nb">open</span> <span class="n">Hopac</span>
<span class="nb">open</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">Infixes</span>
<span class="nb">open</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">Extensions</span>
<span class="nb">open</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">Stream</span>

<span class="n">let</span> <span class="n">process_errors</span> <span class="n">line</span> <span class="p">(</span><span class="n">ers</span> <span class="p">:</span> <span class="n">LineTokenErrors</span> <span class="nb">list</span><span class="p">)</span> <span class="p">:</span> <span class="n">RString</span> <span class="nb">list</span> <span class="o">=</span>
    <span class="n">ers</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">mapi</span> <span class="p">(</span><span class="n">fun</span> <span class="n">i</span> <span class="n">l</span> <span class="o">-&gt;</span> 
        <span class="n">let</span> <span class="n">i</span> <span class="o">=</span> <span class="n">line</span> <span class="o">+</span> <span class="n">i</span>
        <span class="n">l</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="p">,</span> <span class="p">({</span><span class="o">|</span><span class="n">line</span><span class="o">=</span><span class="n">i</span><span class="p">;</span> <span class="n">character</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">from</span><span class="o">|</span><span class="p">},</span> <span class="p">{</span><span class="o">|</span><span class="n">line</span><span class="o">=</span><span class="n">i</span><span class="p">;</span> <span class="n">character</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">nearTo</span><span class="o">|</span><span class="p">}))</span>
        <span class="p">)</span>
    <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">concat</span>
    <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">groupBy</span> <span class="n">snd</span>
    <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">k</span><span class="p">,</span> <span class="n">process_error</span> <span class="p">(</span><span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="n">fst</span> <span class="n">v</span><span class="p">))</span>

<span class="o">///</span> <span class="n">Replaces</span> <span class="n">the</span> <span class="n">token</span> <span class="n">lines</span> <span class="ow">and</span> <span class="n">updates</span> <span class="n">the</span> <span class="n">errors</span> <span class="n">given</span> <span class="n">the</span> <span class="n">edit</span><span class="o">.</span>
<span class="n">let</span> <span class="n">tokenize_replace</span> <span class="p">(</span><span class="n">lines</span> <span class="p">:</span> <span class="n">_</span> <span class="n">FSharpx</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">PersistentVector</span> <span class="n">FSharpx</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">PersistentVector</span><span class="p">,</span> <span class="n">errors</span> <span class="p">:</span> <span class="n">_</span> <span class="nb">list</span><span class="p">)</span> <span class="p">(</span><span class="n">edit</span> <span class="p">:</span> <span class="n">SpiEdit</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">toks</span><span class="p">,</span> <span class="n">ers</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="n">tokenize</span> <span class="n">edit</span><span class="o">.</span><span class="n">lines</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">unzip</span>
    <span class="n">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">replace</span> <span class="n">edit</span><span class="o">.</span><span class="kn">from</span> <span class="nn">edit.nearTo</span> <span class="n">toks</span> <span class="n">lines</span>
    <span class="n">let</span> <span class="n">errors</span> <span class="o">=</span> 
        <span class="n">let</span> <span class="n">adj</span> <span class="o">=</span> <span class="n">edit</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">Length</span> <span class="o">-</span> <span class="p">(</span><span class="n">edit</span><span class="o">.</span><span class="n">nearTo</span> <span class="o">-</span> <span class="n">edit</span><span class="o">.</span><span class="n">from</span><span class="p">)</span>
        <span class="n">errors</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">choose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">((</span><span class="n">a</span> <span class="p">:</span> <span class="n">VSCPos</span><span class="p">,</span><span class="n">b</span><span class="p">),</span><span class="n">c</span> <span class="k">as</span> <span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> 
            <span class="k">if</span> <span class="n">edit</span><span class="o">.</span><span class="kn">from</span> <span class="o">&lt;=</span> <span class="n">a</span><span class="o">.</span><span class="n">line</span> <span class="o">&amp;&amp;</span> <span class="n">a</span><span class="o">.</span><span class="n">line</span> <span class="o">&lt;</span> <span class="n">edit</span><span class="o">.</span><span class="n">nearTo</span> <span class="n">then</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">edit</span><span class="o">.</span><span class="n">nearTo</span> <span class="o">&lt;=</span> <span class="n">a</span><span class="o">.</span><span class="n">line</span> <span class="o">&amp;&amp;</span> <span class="n">adj</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">then</span> <span class="n">Some</span> <span class="p">(</span><span class="n">add_line_to_range</span> <span class="n">adj</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">),</span><span class="n">c</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">Some</span> <span class="n">x</span>
            <span class="p">)</span>
    <span class="n">let</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">append</span> <span class="n">errors</span> <span class="p">(</span><span class="n">process_errors</span> <span class="n">edit</span><span class="o">.</span><span class="kn">from</span> <span class="p">(</span><span class="n">Array</span><span class="o">.</span><span class="n">toList</span> <span class="n">ers</span><span class="p">))</span>
    <span class="n">lines</span><span class="p">,</span> <span class="n">errors</span>

<span class="nb">type</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ReferenceEquality</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">TokenizerState</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">lines_text</span> <span class="p">:</span> <span class="n">string</span> <span class="n">FSharpx</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">PersistentVector</span>
    <span class="n">lines_token</span> <span class="p">:</span> <span class="n">LineTokens</span>
    <span class="n">blocks</span> <span class="p">:</span> <span class="n">LineTokens</span> <span class="n">Block</span> <span class="nb">list</span>
    <span class="n">errors</span> <span class="p">:</span> <span class="n">RString</span> <span class="nb">list</span>
    <span class="p">}</span>

<span class="n">let</span> <span class="n">wdiff_tokenizer_init</span> <span class="o">=</span> <span class="p">{</span> <span class="n">lines_text</span> <span class="o">=</span> <span class="n">FSharpx</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">PersistentVector</span><span class="o">.</span><span class="n">empty</span><span class="p">;</span> <span class="n">lines_token</span> <span class="o">=</span> <span class="n">FSharpx</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">PersistentVector</span><span class="o">.</span><span class="n">empty</span><span class="p">;</span> <span class="n">blocks</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span> <span class="p">}</span>

<span class="o">///</span> <span class="n">Immutably</span> <span class="n">updates</span> <span class="n">the</span> <span class="n">state</span> <span class="n">based</span> <span class="n">on</span> <span class="n">the</span> <span class="n">request</span><span class="o">.</span> <span class="n">Does</span> <span class="n">diffing</span> <span class="n">to</span> <span class="n">make</span> <span class="n">the</span> <span class="n">operation</span> <span class="n">efficient</span><span class="o">.</span>
<span class="o">///</span> <span class="n">It</span> <span class="ow">is</span> <span class="n">possible</span> <span class="k">for</span> <span class="n">the</span> <span class="n">server</span> <span class="n">to</span> <span class="n">go</span> <span class="n">out</span> <span class="n">of</span> <span class="n">sync</span><span class="p">,</span> <span class="ow">in</span> <span class="n">which</span> <span class="n">case</span> <span class="n">an</span> <span class="n">error</span> <span class="ow">is</span> <span class="n">returned</span><span class="o">.</span>
<span class="n">let</span> <span class="n">replace</span><span class="s1">' (state : TokenizerState) (edit : SpiEdit) =</span>
    <span class="n">let</span> <span class="n">lines_text</span> <span class="o">=</span> <span class="n">replace</span> <span class="n">edit</span><span class="o">.</span><span class="kn">from</span> <span class="nn">edit.nearTo</span> <span class="n">edit</span><span class="o">.</span><span class="n">lines</span> <span class="n">state</span><span class="o">.</span><span class="n">lines_text</span>
    <span class="n">let</span> <span class="n">lines_token</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">tokenize_replace</span> <span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">lines_token</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span> <span class="n">edit</span>
    <span class="n">let</span> <span class="n">blocks</span> <span class="o">=</span> <span class="n">wdiff_block_all</span> <span class="n">state</span><span class="o">.</span><span class="n">blocks</span> <span class="p">(</span><span class="n">lines_token</span><span class="p">,</span> <span class="n">edit</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">Length</span><span class="p">,</span> <span class="n">edit</span><span class="o">.</span><span class="n">from</span><span class="p">,</span> <span class="n">edit</span><span class="o">.</span><span class="n">nearTo</span><span class="p">)</span>
    <span class="p">{</span><span class="n">lines_text</span><span class="o">=</span><span class="n">lines_text</span><span class="p">;</span> <span class="n">lines_token</span><span class="o">=</span><span class="n">lines_token</span><span class="p">;</span> <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">;</span> <span class="n">blocks</span><span class="o">=</span><span class="n">blocks</span><span class="p">}</span>
<span class="n">let</span> <span class="n">wdiff_tokenizer_all</span> <span class="p">(</span><span class="n">state</span> <span class="p">:</span> <span class="n">TokenizerState</span><span class="p">)</span> <span class="n">text</span> <span class="o">=</span> 
    <span class="n">let</span> <span class="n">text</span> <span class="o">=</span> <span class="n">lines</span> <span class="n">text</span>
    <span class="n">let</span> <span class="n">text</span><span class="s1">' = state.lines_text |&gt; Seq.toArray</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">text</span> <span class="p">:</span> <span class="n">string</span> <span class="p">[]</span> <span class="k">as</span> <span class="n">x</span><span class="p">)</span> <span class="n">i</span> <span class="o">=</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">min</span> <span class="n">text</span><span class="o">.</span><span class="n">Length</span> <span class="n">state</span><span class="o">.</span><span class="n">lines_text</span><span class="o">.</span><span class="n">Length</span> <span class="o">&amp;&amp;</span> <span class="n">index</span> <span class="n">text</span> <span class="n">i</span> <span class="o">=</span> <span class="n">index</span> <span class="n">text</span><span class="s1">' i then loop x (i+1) else i</span>
    <span class="n">let</span> <span class="kn">from</span> <span class="o">=</span> <span class="n">loop</span> <span class="p">((</span><span class="n">fun</span> <span class="n">text</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">text</span><span class="o">.</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span><span class="n">text</span><span class="p">)</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="kn">from</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">Length</span> <span class="n">then</span> <span class="n">state</span> <span class="k">else</span>
    <span class="n">let</span> <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="p">[</span><span class="n">from</span><span class="o">..</span><span class="p">]</span>
    <span class="n">let</span> <span class="n">fromRev</span> <span class="o">=</span> <span class="n">loop</span> <span class="p">((</span><span class="n">fun</span> <span class="n">text</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">text</span><span class="o">.</span><span class="p">[</span><span class="n">text</span><span class="o">.</span><span class="n">Length</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">i</span><span class="p">]),</span><span class="n">text</span><span class="p">)</span> <span class="mi">0</span>
    <span class="n">replace</span><span class="s1">' state {|from=from; nearTo=text'</span><span class="o">.</span><span class="n">Length</span><span class="o">-</span><span class="n">fromRev</span><span class="p">;</span> <span class="n">lines</span><span class="o">=</span><span class="n">text</span><span class="o">.</span><span class="p">[</span><span class="o">..</span><span class="n">text</span><span class="o">.</span><span class="n">Length</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">fromRev</span><span class="p">]</span><span class="o">|</span><span class="p">}</span>
<span class="n">let</span> <span class="n">wdiff_tokenizer_edit</span> <span class="p">(</span><span class="n">state</span> <span class="p">:</span> <span class="n">TokenizerState</span><span class="p">)</span> <span class="p">(</span><span class="n">edit</span> <span class="p">:</span> <span class="n">SpiEdit</span><span class="p">)</span> <span class="o">=</span> 
    <span class="k">if</span> <span class="n">edit</span><span class="o">.</span><span class="n">nearTo</span> <span class="o">&lt;=</span> <span class="n">state</span><span class="o">.</span><span class="n">lines_text</span><span class="o">.</span><span class="n">Length</span> <span class="n">then</span> <span class="n">Ok</span> <span class="p">(</span><span class="n">replace</span><span class="s1">' state edit)</span>
    <span class="k">else</span> <span class="n">Error</span> <span class="s2">"The edit is out of bounds and cannot be applied. The language server and the editor are out of sync. Try reopening the file being edited."</span>

<span class="n">let</span> <span class="n">semantic_updates_apply</span> <span class="p">(</span><span class="n">block</span> <span class="p">:</span> <span class="n">LineTokens</span><span class="p">)</span> <span class="n">updates</span> <span class="o">=</span>
    <span class="n">Seq</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">block</span> <span class="p">(</span><span class="n">c</span> <span class="p">:</span> <span class="n">VectorCord</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="o">-&gt;</span> 
        <span class="n">let</span> <span class="n">x</span> <span class="o">=</span>
            <span class="n">let</span> <span class="n">r</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">FSharpx</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">PersistentVector</span><span class="o">.</span><span class="n">nthNth</span> <span class="n">c</span><span class="o">.</span><span class="n">row</span> <span class="n">c</span><span class="o">.</span><span class="n">col</span> <span class="n">block</span>
            <span class="n">let</span> <span class="n">x</span> <span class="o">=</span>
                <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">TokVar</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TokVar</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">l</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">TokSymbol</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TokSymbol</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">l</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">TokOperator</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TokOperator</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">l</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">TokUnaryOperator</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TokUnaryOperator</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">l</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">failwithf</span> <span class="s2">"Compiler error: Cannot change the semantic legend for the %A token."</span> <span class="n">x</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">x</span>
        <span class="n">FSharpx</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">PersistentVector</span><span class="o">.</span><span class="n">updateNth</span> <span class="n">c</span><span class="o">.</span><span class="n">row</span> <span class="n">c</span><span class="o">.</span><span class="n">col</span> <span class="n">x</span> <span class="n">block</span>
        <span class="p">)</span> <span class="n">block</span> <span class="n">updates</span>

<span class="n">let</span> <span class="n">parse_block</span> <span class="n">default_env</span> <span class="n">is_top_down</span> <span class="p">(</span><span class="n">block</span> <span class="p">:</span> <span class="n">LineTokens</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">comments</span><span class="p">,</span> <span class="n">cords_tokens</span> <span class="o">=</span> 
        <span class="n">Array</span><span class="o">.</span><span class="n">init</span> <span class="n">block</span><span class="o">.</span><span class="n">Length</span> <span class="p">(</span><span class="n">fun</span> <span class="n">line</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="p">[</span><span class="n">line</span><span class="p">]</span>
            <span class="n">let</span> <span class="n">comment</span><span class="p">,</span> <span class="nb">len</span> <span class="o">=</span> <span class="n">match</span> <span class="n">FSharpx</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">PersistentVector</span><span class="o">.</span><span class="n">tryLast</span> <span class="n">x</span> <span class="k">with</span> <span class="n">Some</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">TokComment</span> <span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Some</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="n">x</span><span class="o">.</span><span class="n">Length</span><span class="o">-</span><span class="mi">1</span> <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">Length</span>
            <span class="n">let</span> <span class="n">tokens</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">init</span> <span class="nb">len</span> <span class="p">(</span><span class="n">fun</span> <span class="n">i</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">r</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> 
                <span class="p">{</span><span class="o">|</span><span class="n">row</span><span class="o">=</span><span class="n">line</span><span class="p">;</span> <span class="n">col</span><span class="o">=</span><span class="n">i</span><span class="o">|</span><span class="p">},</span> <span class="p">(({</span><span class="o">|</span> <span class="n">line</span><span class="o">=</span><span class="n">line</span><span class="p">;</span> <span class="n">character</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="kn">from</span> <span class="o">|</span><span class="p">},</span> <span class="p">{</span><span class="o">|</span> <span class="n">line</span><span class="o">=</span><span class="n">line</span><span class="p">;</span> <span class="n">character</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">nearTo</span> <span class="o">|</span><span class="p">}),</span> <span class="n">x</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">comment</span><span class="p">,</span> <span class="n">tokens</span>
            <span class="p">)</span>
        <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">unzip</span>
    <span class="n">let</span> <span class="n">cords</span><span class="p">,</span> <span class="n">tokens</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">unzip</span> <span class="p">(</span><span class="n">Array</span><span class="o">.</span><span class="n">concat</span> <span class="n">cords_tokens</span><span class="p">)</span>

    <span class="n">let</span> <span class="n">semantic_updates</span> <span class="o">=</span> <span class="n">ResizeArray</span><span class="p">()</span>
    <span class="n">let</span> <span class="n">env</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">tokens_cords</span> <span class="o">=</span> <span class="n">cords</span><span class="p">;</span> <span class="n">semantic_updates</span> <span class="o">=</span> <span class="n">semantic_updates</span>
        <span class="n">comments</span> <span class="o">=</span> <span class="n">comments</span><span class="p">;</span> <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span><span class="p">;</span> <span class="n">is_top_down</span> <span class="o">=</span> <span class="n">is_top_down</span>
        <span class="n">default_env</span> <span class="o">=</span> <span class="n">default_env</span>
        <span class="p">}</span>
    <span class="p">{</span><span class="n">result</span><span class="o">=</span><span class="n">parseBlockParsing</span> <span class="n">env</span><span class="p">;</span> <span class="n">semantic_tokens</span><span class="o">=</span><span class="n">semantic_updates_apply</span> <span class="n">block</span> <span class="n">semantic_updates</span><span class="p">}</span>

<span class="n">let</span> <span class="n">wdiff_parse_init</span> <span class="n">is_top_down</span> <span class="p">:</span> <span class="n">ParserState</span> <span class="o">=</span> <span class="p">{</span><span class="n">is_top_down</span><span class="o">=</span><span class="n">is_top_down</span><span class="p">;</span> <span class="n">blocks</span><span class="o">=</span><span class="p">[]}</span>
<span class="n">let</span> <span class="n">wdiff_parse</span> <span class="n">default_env</span> <span class="p">(</span><span class="n">state</span> <span class="p">:</span> <span class="n">ParserState</span><span class="p">)</span> <span class="p">(</span><span class="n">unparsed_blocks</span> <span class="p">:</span> <span class="n">LineTokens</span> <span class="n">Block</span> <span class="nb">list</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">let</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">HashIdentity</span><span class="o">.</span><span class="n">Reference</span><span class="p">)</span>
    <span class="o">//</span> <span class="n">Offset</span> <span class="n">should</span> <span class="n">be</span> <span class="n">ignored</span> <span class="n">when</span> <span class="n">memoizing</span> <span class="n">the</span> <span class="n">results</span> <span class="n">of</span> <span class="n">parsing</span><span class="o">.</span>
    <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="o">.</span><span class="n">block</span><span class="p">))</span> <span class="n">state</span><span class="o">.</span><span class="n">blocks</span>
    <span class="n">let</span> <span class="n">blocks</span> <span class="o">=</span> <span class="n">unparsed_blocks</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> 
        <span class="n">x</span><span class="o">.</span><span class="n">block</span><span class="p">,</span> <span class="p">{</span><span class="n">block</span><span class="o">=</span><span class="n">memoize</span> <span class="nb">dict</span> <span class="p">(</span><span class="n">fun</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">memo</span><span class="p">(</span><span class="n">Job</span><span class="o">.</span><span class="n">thunk</span> <span class="o">&lt;|</span> <span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">parse_block</span> <span class="n">default_env</span> <span class="n">state</span><span class="o">.</span><span class="n">is_top_down</span><span class="p">)</span> <span class="n">a</span><span class="p">))</span> <span class="n">x</span><span class="o">.</span><span class="n">block</span><span class="p">;</span> <span class="n">offset</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">offset</span><span class="p">}</span>
        <span class="p">)</span>  
    <span class="p">{</span><span class="n">state</span> <span class="k">with</span> <span class="n">blocks</span> <span class="o">=</span> <span class="n">blocks</span> <span class="p">}</span>

<span class="nb">type</span> <span class="n">ModuleState</span> <span class="o">=</span> <span class="p">{</span> <span class="n">tokenizer</span> <span class="p">:</span> <span class="n">TokenizerState</span><span class="p">;</span> <span class="n">bundler</span> <span class="p">:</span> <span class="n">BlockBundleState</span><span class="p">;</span> <span class="n">parser</span> <span class="p">:</span> <span class="n">ParserState</span> <span class="p">}</span>
<span class="n">let</span> <span class="n">wdiff_module_init</span> <span class="n">is_top_down</span> <span class="o">=</span> <span class="p">{</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">wdiff_tokenizer_init</span><span class="p">;</span> <span class="n">bundler</span> <span class="o">=</span> <span class="n">wdiff_block_bundle_init</span><span class="p">;</span> <span class="n">parser</span> <span class="o">=</span> <span class="n">wdiff_parse_init</span> <span class="n">is_top_down</span><span class="p">}</span>
<span class="n">let</span> <span class="n">wdiff_module_body</span> <span class="n">default_env</span> <span class="n">state</span> <span class="n">tokenizer</span> <span class="o">=</span>
    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span> <span class="n">then</span> <span class="n">state</span> <span class="k">else</span>
    <span class="n">let</span> <span class="n">parser</span> <span class="o">=</span> <span class="n">wdiff_parse</span> <span class="n">default_env</span> <span class="n">state</span><span class="o">.</span><span class="n">parser</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">blocks</span>
    <span class="n">let</span> <span class="n">bundler</span> <span class="o">=</span> <span class="n">wdiff_block_bundle</span> <span class="n">state</span><span class="o">.</span><span class="n">bundler</span> <span class="n">parser</span>
    <span class="p">{</span><span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">;</span> <span class="n">parser</span><span class="o">=</span><span class="n">parser</span><span class="p">;</span> <span class="n">bundler</span><span class="o">=</span><span class="n">bundler</span><span class="p">}</span>
<span class="n">let</span> <span class="n">wdiff_module_edit</span> <span class="n">default_env</span> <span class="p">(</span><span class="n">state</span> <span class="p">:</span> <span class="n">ModuleState</span><span class="p">)</span> <span class="n">x</span> <span class="o">=</span> <span class="n">wdiff_tokenizer_edit</span> <span class="n">state</span><span class="o">.</span><span class="n">tokenizer</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">Result</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">wdiff_module_body</span> <span class="n">default_env</span> <span class="n">state</span><span class="p">)</span>
<span class="n">let</span> <span class="n">wdiff_module_all</span> <span class="n">default_env</span> <span class="n">state</span> <span class="n">x</span> <span class="o">=</span> <span class="n">wdiff_tokenizer_all</span> <span class="n">state</span><span class="o">.</span><span class="n">tokenizer</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">wdiff_module_body</span> <span class="n">default_env</span> <span class="n">state</span>
<span class="n">let</span> <span class="n">wdiff_module_init_all</span> <span class="n">default_env</span> <span class="n">is_top_down</span> <span class="n">x</span> <span class="o">=</span> <span class="n">wdiff_module_all</span> <span class="n">default_env</span> <span class="p">(</span><span class="n">wdiff_module_init</span> <span class="n">is_top_down</span><span class="p">)</span> <span class="n">x</span>

<span class="nb">type</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ReferenceEquality</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">FileState</span><span class="o">&lt;</span><span class="s1">'input,'</span><span class="n">result</span><span class="p">,</span><span class="s1">'state&gt; = { input : '</span><span class="nb">input</span><span class="p">;</span> <span class="n">result</span> <span class="p">:</span> <span class="s1">'result; state : '</span><span class="n">state</span> <span class="p">}</span>
<span class="nb">type</span> <span class="n">FileFuns</span><span class="o">&lt;</span><span class="s1">'a,'</span><span class="n">b</span><span class="p">,</span><span class="s1">'state&gt; =</span>
    <span class="n">abstract</span> <span class="n">member</span> <span class="nb">eval</span> <span class="p">:</span> <span class="s1">'state * '</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="s1">'b</span>
    <span class="n">abstract</span> <span class="n">member</span> <span class="n">diff</span> <span class="p">:</span> <span class="s1">'state * '</span><span class="n">b</span> <span class="o">*</span> <span class="s1">'a -&gt; '</span><span class="n">b</span>
    <span class="n">abstract</span> <span class="n">member</span> <span class="n">init</span> <span class="p">:</span> <span class="s1">'a -&gt; FileState&lt;'</span><span class="n">a</span><span class="p">,</span><span class="s1">'b,'</span><span class="n">state</span><span class="o">&gt;</span>

<span class="nb">type</span> <span class="n">TypecheckerStateValue</span> <span class="o">=</span> <span class="n">Bundle</span> <span class="n">option</span> <span class="o">*</span> <span class="n">InferResult</span> <span class="o">*</span> <span class="n">TopEnv</span>
<span class="nb">type</span> <span class="n">TypecheckerStatePropagated</span> <span class="o">=</span> <span class="p">(</span><span class="nb">bool</span> <span class="o">*</span> <span class="n">TopEnv</span><span class="p">)</span> <span class="n">Promise</span>
<span class="nb">type</span> <span class="n">TypecheckerState</span> <span class="o">=</span> <span class="n">FileState</span><span class="o">&lt;</span><span class="n">PackageId</span> <span class="o">*</span> <span class="n">ModuleId</span> <span class="o">*</span> <span class="n">BlockBundleState</span><span class="p">,</span> <span class="n">TypecheckerStateValue</span> <span class="n">Stream</span><span class="p">,</span> <span class="n">TypecheckerStatePropagated</span><span class="o">&gt;</span>

<span class="n">let</span> <span class="n">rec</span> <span class="n">typecheck</span> <span class="p">(</span><span class="n">package_id</span><span class="p">,</span><span class="n">module_id</span><span class="p">,</span><span class="n">env</span> <span class="p">:</span> <span class="n">TopEnv</span><span class="p">)</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&gt;&gt;=*</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">Cons</span><span class="p">((</span><span class="n">_</span><span class="p">,</span><span class="n">b</span> <span class="p">:</span> <span class="n">BlockBundleValue</span><span class="p">),</span> <span class="n">ls</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="k">match</span> <span class="n">b</span><span class="o">.</span><span class="n">bundle</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">Some</span> <span class="n">bundle</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">infer</span> <span class="n">package_id</span> <span class="n">module_id</span> <span class="n">env</span> <span class="n">bundle</span>
            <span class="n">let</span> <span class="n">adds</span> <span class="o">=</span> <span class="n">match</span> <span class="n">x</span><span class="o">.</span><span class="n">top_env_additions</span> <span class="k">with</span> <span class="n">AOpen</span> <span class="n">x</span> <span class="o">|</span> <span class="n">AInclude</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span>
            <span class="n">let</span> <span class="n">env</span> <span class="o">=</span> <span class="n">unionInfer</span> <span class="n">adds</span> <span class="n">env</span>
            <span class="n">Job</span><span class="o">.</span><span class="n">result</span> <span class="p">(</span><span class="n">Cons</span><span class="p">((</span><span class="n">b</span><span class="o">.</span><span class="n">bundle</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">env</span><span class="p">),</span><span class="n">typecheck</span> <span class="p">(</span><span class="n">package_id</span><span class="p">,</span><span class="n">module_id</span><span class="p">,</span><span class="n">env</span><span class="p">)</span> <span class="n">ls</span><span class="p">))</span>
        <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span>
            <span class="n">typecheck</span> <span class="p">(</span><span class="n">package_id</span><span class="p">,</span><span class="n">module_id</span><span class="p">,</span><span class="n">env</span><span class="p">)</span> <span class="n">ls</span> <span class="p">:</span><span class="o">&gt;</span> <span class="n">_</span> <span class="n">Job</span>
    <span class="o">|</span> <span class="n">Nil</span> <span class="o">-&gt;</span>
        <span class="n">Job</span><span class="o">.</span><span class="n">result</span> <span class="n">Nil</span>

<span class="n">let</span> <span class="n">rec</span> <span class="n">diff</span> <span class="p">(</span><span class="n">package_id</span><span class="p">,</span><span class="n">module_id</span><span class="p">,</span><span class="n">env</span><span class="p">)</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="nb">input</span> <span class="p">:</span> <span class="n">BlockBundleState</span><span class="p">)</span> <span class="o">=</span> 
    <span class="n">let</span> <span class="n">tc</span> <span class="p">()</span> <span class="o">=</span> <span class="n">typecheck</span> <span class="p">(</span><span class="n">package_id</span><span class="p">,</span><span class="n">module_id</span><span class="p">,</span><span class="n">env</span><span class="p">)</span> <span class="nb">input</span>
    <span class="k">if</span> <span class="n">Promise</span><span class="o">.</span><span class="n">Now</span><span class="o">.</span><span class="n">isFulfilled</span> <span class="n">result</span> <span class="n">then</span>
        <span class="nb">input</span> <span class="o">&gt;&gt;**</span> <span class="n">fun</span> <span class="nb">input</span> <span class="o">-&gt;</span>
        <span class="k">match</span> <span class="n">Promise</span><span class="o">.</span><span class="n">Now</span><span class="o">.</span><span class="n">get</span> <span class="n">result</span><span class="p">,</span><span class="nb">input</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">Cons</span><span class="p">((</span><span class="sa">b</span><span class="s1">',_,env as x),next), Cons((_,b),bs) when b'</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">bundle</span> <span class="o">-&gt;</span> <span class="n">Promise</span><span class="o">.</span><span class="n">Now</span><span class="o">.</span><span class="n">withValue</span> <span class="p">(</span><span class="n">Cons</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">diff</span> <span class="p">(</span><span class="n">package_id</span><span class="p">,</span><span class="n">module_id</span><span class="p">,</span><span class="n">env</span><span class="p">)</span> <span class="p">(</span><span class="nb">next</span><span class="p">,</span><span class="n">bs</span><span class="p">)))</span>
        <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">tc</span><span class="p">()</span>
    <span class="k">else</span> <span class="n">tc</span><span class="p">()</span>

<span class="n">let</span> <span class="n">funs_file_tc</span> <span class="o">=</span> <span class="p">{</span><span class="n">new</span> <span class="n">FileFuns</span><span class="o">&lt;</span><span class="n">PackageId</span> <span class="o">*</span> <span class="n">ModuleId</span> <span class="o">*</span> <span class="n">BlockBundleState</span><span class="p">,</span> <span class="n">TypecheckerStateValue</span> <span class="n">Stream</span><span class="p">,</span> <span class="n">TypecheckerStatePropagated</span><span class="o">&gt;</span> <span class="k">with</span>
    <span class="n">member</span> <span class="n">_</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">state</span><span class="p">,(</span><span class="n">pid</span><span class="p">,</span><span class="n">mid</span><span class="p">,</span><span class="n">x</span><span class="p">))</span> <span class="o">=</span> 
        <span class="n">state</span> <span class="o">&gt;&gt;=*</span> <span class="n">fun</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">env</span><span class="p">)</span> <span class="o">-&gt;</span> 
        <span class="n">typecheck</span> <span class="p">(</span><span class="n">pid</span><span class="p">,</span><span class="n">mid</span><span class="p">,</span><span class="n">env</span><span class="p">)</span> <span class="n">x</span>
    <span class="n">member</span> <span class="n">_</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="n">b</span><span class="p">,(</span><span class="n">pid</span><span class="p">,</span><span class="n">mid</span><span class="p">,</span><span class="n">a</span><span class="p">))</span> <span class="o">=</span>
        <span class="n">state</span> <span class="o">&gt;&gt;=*</span> <span class="n">fun</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">env</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">diff</span> <span class="p">(</span><span class="n">pid</span><span class="p">,</span><span class="n">mid</span><span class="p">,</span><span class="n">env</span><span class="p">)</span> <span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
    <span class="n">member</span> <span class="n">_</span><span class="o">.</span><span class="n">init</span> <span class="n">x</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nb">input</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">Promise</span><span class="o">.</span><span class="n">Now</span><span class="o">.</span><span class="n">never</span><span class="p">()</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">Promise</span><span class="o">.</span><span class="n">Now</span><span class="o">.</span><span class="n">never</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="n">let</span> <span class="n">wdiff_file_update_state</span> <span class="p">(</span><span class="n">funs</span> <span class="p">:</span> <span class="n">FileFuns</span><span class="o">&lt;</span><span class="s1">'a,'</span><span class="n">b</span><span class="p">,</span><span class="s1">'state&gt;) (state : FileState&lt;'</span><span class="n">a</span><span class="p">,</span><span class="s1">'b,'</span><span class="n">state</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="s1">'state) =</span>
    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">x</span> <span class="n">then</span> <span class="n">state</span> <span class="k">else</span> <span class="p">{</span><span class="n">state</span> <span class="k">with</span> <span class="n">state</span><span class="o">=</span><span class="n">x</span><span class="p">;</span> <span class="n">result</span><span class="o">=</span><span class="n">funs</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">state</span><span class="o">.</span><span class="n">input</span><span class="p">)}</span>

<span class="n">let</span> <span class="n">wdiff_file_update_input</span> <span class="p">(</span><span class="n">funs</span> <span class="p">:</span> <span class="n">FileFuns</span><span class="o">&lt;</span><span class="s1">'a,'</span><span class="n">b</span><span class="p">,</span><span class="s1">'state&gt;) (state : FileState&lt;'</span><span class="n">a</span><span class="p">,</span><span class="s1">'b,'</span><span class="n">state</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="s1">'a) =</span>
    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="n">x</span> <span class="n">then</span> <span class="n">state</span> <span class="k">else</span> <span class="p">{</span><span class="n">state</span> <span class="k">with</span> <span class="nb">input</span><span class="o">=</span><span class="n">x</span><span class="p">;</span> <span class="n">result</span><span class="o">=</span><span class="n">funs</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">state</span><span class="p">,</span><span class="n">state</span><span class="o">.</span><span class="n">result</span><span class="p">,</span><span class="n">x</span><span class="p">)}</span>

<span class="n">let</span> <span class="n">wdiff_file</span> <span class="p">(</span><span class="n">funs</span> <span class="p">:</span> <span class="n">FileFuns</span><span class="o">&lt;</span><span class="s1">'a,'</span><span class="n">b</span><span class="p">,</span><span class="s1">'state&gt;) (state : FileState&lt;'</span><span class="n">a</span><span class="p">,</span><span class="s1">'b,'</span><span class="n">state</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">=</span>
    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">a</span> <span class="n">then</span> <span class="n">wdiff_file_update_input</span> <span class="n">funs</span> <span class="n">state</span> <span class="n">b</span> <span class="k">else</span> <span class="p">{</span><span class="n">state</span><span class="o">=</span><span class="n">a</span><span class="p">;</span> <span class="nb">input</span><span class="o">=</span><span class="n">b</span><span class="p">;</span> <span class="n">result</span><span class="o">=</span><span class="n">funs</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)}</span>

<span class="nb">type</span> <span class="n">ProjFilesTree</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">File</span> <span class="n">of</span> <span class="n">module_id</span><span class="p">:</span> <span class="n">ModuleId</span> <span class="o">*</span> <span class="n">path</span><span class="p">:</span> <span class="n">string</span> <span class="o">*</span> <span class="n">name</span><span class="p">:</span> <span class="n">string</span> <span class="n">option</span>
    <span class="o">|</span> <span class="n">Directory</span> <span class="n">of</span> <span class="n">dir_id</span><span class="p">:</span> <span class="n">DirId</span> <span class="o">*</span> <span class="n">name</span><span class="p">:</span> <span class="n">string</span> <span class="o">*</span> <span class="n">ProjFilesTree</span> <span class="nb">list</span>

<span class="nb">type</span> <span class="n">ProjFiles</span> <span class="o">=</span> <span class="p">{</span> <span class="n">tree</span> <span class="p">:</span> <span class="n">ProjFilesTree</span> <span class="nb">list</span><span class="p">;</span> <span class="n">num_dirs</span> <span class="p">:</span> <span class="nb">int</span><span class="p">;</span> <span class="n">num_files</span> <span class="p">:</span> <span class="nb">int</span> <span class="p">}</span>

<span class="nb">type</span> <span class="n">ProjFileFuns</span><span class="o">&lt;</span><span class="s1">'a,'</span><span class="n">state</span><span class="o">&gt;</span> <span class="o">=</span>
    <span class="n">abstract</span> <span class="n">member</span> <span class="n">file</span> <span class="p">:</span> <span class="n">string</span> <span class="n">option</span> <span class="o">*</span> <span class="s1">'state * '</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="s1">'a * '</span><span class="n">state</span>
    <span class="n">abstract</span> <span class="n">member</span> <span class="n">union</span> <span class="p">:</span> <span class="s1">'state * '</span><span class="n">state</span> <span class="o">-&gt;</span> <span class="s1">'state</span>
    <span class="n">abstract</span> <span class="n">member</span> <span class="n">in_module</span> <span class="p">:</span> <span class="n">string</span> <span class="o">*</span> <span class="s1">'state -&gt; '</span><span class="n">state</span>
    <span class="n">abstract</span> <span class="n">member</span> <span class="n">default</span><span class="s1">' : DefaultEnv -&gt; '</span><span class="n">state</span>
    <span class="n">abstract</span> <span class="n">member</span> <span class="n">empty</span> <span class="p">:</span> <span class="s1">'state</span>

<span class="nb">type</span> <span class="p">[</span><span class="o">&lt;</span><span class="n">ReferenceEquality</span><span class="o">&gt;</span><span class="p">]</span> <span class="n">ProjFilesState</span><span class="o">&lt;</span><span class="s1">'a,'</span><span class="n">state</span><span class="o">&gt;</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">init</span> <span class="p">:</span> <span class="s1">'state</span>
    <span class="n">uids_file</span> <span class="p">:</span> <span class="p">(</span><span class="s1">'a * '</span><span class="n">state</span><span class="p">)</span> <span class="p">[]</span>
    <span class="n">uids_directory</span> <span class="p">:</span> <span class="s1">'state []</span>
    <span class="n">files</span> <span class="p">:</span> <span class="n">ProjFiles</span>
    <span class="n">result</span> <span class="p">:</span> <span class="s1">'state</span>
    <span class="p">}</span>

<span class="n">let</span> <span class="n">proj_files_diff</span> <span class="p">(</span><span class="n">uids_file</span> <span class="p">:</span> <span class="p">(</span><span class="s1">'a * '</span><span class="n">b</span><span class="p">)</span> <span class="p">[],</span> <span class="n">uids_directory</span> <span class="p">:</span> <span class="s1">'b [], files) (uids, files'</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">uids_file</span><span class="s1">' = Array.zeroCreate (Array.length uids)</span>
    <span class="n">let</span> <span class="n">uids_directory</span><span class="s1">' = Array.zeroCreate files'</span><span class="o">.</span><span class="n">num_dirs</span>
    <span class="o">//</span> <span class="n">Ref</span> <span class="n">equality</span> <span class="ow">is</span> <span class="n">done</span> <span class="n">first</span> <span class="k">for</span> <span class="n">performance</span><span class="o">.</span> <span class="n">Most</span> <span class="n">of</span> <span class="n">the</span> <span class="n">time</span> <span class="n">the</span> <span class="n">strings</span> <span class="n">will</span> <span class="n">be</span> <span class="n">the</span> <span class="n">same</span><span class="o">.</span>
    <span class="n">let</span> <span class="n">eq</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Object</span><span class="o">.</span><span class="n">ReferenceEquals</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">||</span> <span class="n">a</span> <span class="o">=</span> <span class="n">b</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="o">=</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">File</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span><span class="n">path</span><span class="p">,</span><span class="n">name</span><span class="p">),</span> <span class="n">File</span><span class="p">(</span><span class="n">mid</span><span class="s1">',path'</span><span class="p">,</span><span class="n">name</span><span class="s1">') when mid = mid'</span> <span class="o">&amp;&amp;</span> <span class="n">eq</span> <span class="n">path</span> <span class="n">path</span><span class="s1">' &amp;&amp; eq name name'</span> <span class="o">-&gt;</span> 
            <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">uids_file</span><span class="o">.</span><span class="p">[</span><span class="n">mid</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">uids</span><span class="o">.</span><span class="p">[</span><span class="n">mid</span><span class="p">]</span> <span class="o">=</span> <span class="n">fst</span> <span class="n">x</span> <span class="n">then</span> <span class="n">uids_file</span><span class="s1">'.[mid] &lt;- x; true else false</span>
        <span class="o">|</span> <span class="n">Directory</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">l</span><span class="p">),</span> <span class="n">Directory</span><span class="p">(</span><span class="n">uid</span><span class="s1">',name'</span><span class="p">,</span><span class="n">l</span><span class="s1">') when uid = uid'</span> <span class="o">&amp;&amp;</span> <span class="n">eq</span> <span class="n">name</span> <span class="n">name</span><span class="s1">' &amp;&amp; list (l,l'</span><span class="p">)</span> <span class="o">-&gt;</span> 
            <span class="n">uids_directory</span><span class="s1">'.[uid] &lt;- uids_directory.[uid]; true</span>
        <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">false</span>
    <span class="ow">and</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">x</span> <span class="p">::</span> <span class="n">xs</span><span class="p">,</span> <span class="n">y</span> <span class="p">::</span> <span class="n">ys</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">list</span> <span class="p">(</span><span class="n">xs</span><span class="p">,</span><span class="n">ys</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">false</span>
    <span class="k">if</span> <span class="nb">list</span> <span class="p">(</span><span class="n">files</span><span class="o">.</span><span class="n">tree</span><span class="p">,</span> <span class="n">files</span><span class="s1">'.tree) then None else Some (uids_file'</span><span class="p">,</span><span class="n">uids_directory</span><span class="s1">')</span>

<span class="n">let</span> <span class="n">proj_files</span> <span class="p">(</span><span class="n">funs</span> <span class="p">:</span> <span class="n">ProjFileFuns</span><span class="o">&lt;</span><span class="s1">'a,'</span><span class="n">state</span><span class="o">&gt;</span><span class="p">)</span> <span class="n">uids_file</span> <span class="n">uids_directory</span> <span class="n">uids</span> <span class="n">s</span> <span class="n">l</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">inline</span> <span class="n">memo</span> <span class="p">(</span><span class="n">uids</span> <span class="p">:</span> <span class="n">_</span> <span class="p">[])</span> <span class="n">uid</span> <span class="n">f</span> <span class="o">=</span> 
        <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">uids</span><span class="o">.</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">isNull</span> <span class="p">(</span><span class="n">box</span> <span class="n">x</span><span class="p">)</span> <span class="n">then</span> <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">f</span><span class="p">()</span> <span class="ow">in</span> <span class="n">uids</span><span class="o">.</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">x</span><span class="p">;</span> <span class="n">x</span>
        <span class="k">else</span> <span class="n">x</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="n">state</span> <span class="o">=</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">File</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">memo</span> <span class="n">uids_file</span> <span class="n">mid</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="n">funs</span><span class="o">.</span><span class="n">file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">state</span><span class="p">,</span><span class="n">Array</span><span class="o">.</span><span class="n">get</span> <span class="n">uids</span> <span class="n">mid</span><span class="p">))</span> <span class="o">|&gt;</span> <span class="n">snd</span>
        <span class="o">|</span> <span class="n">Directory</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">l</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">memo</span> <span class="n">uids_directory</span> <span class="n">uid</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="n">funs</span><span class="o">.</span><span class="n">in_module</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="nb">list</span> <span class="n">state</span> <span class="n">l</span><span class="p">))</span>
    <span class="ow">and</span> <span class="nb">list</span> <span class="n">s</span> <span class="n">l</span> <span class="o">=</span> 
        <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">empty</span><span class="p">,</span><span class="n">big</span><span class="p">)</span> <span class="n">x</span> <span class="o">-&gt;</span> 
            <span class="n">let</span> <span class="n">small</span> <span class="o">=</span> <span class="n">loop</span> <span class="n">big</span> <span class="n">x</span>
            <span class="n">funs</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">small</span><span class="p">,</span><span class="n">empty</span><span class="p">),</span> <span class="n">funs</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">small</span><span class="p">,</span><span class="n">big</span><span class="p">)</span>
            <span class="p">)</span> <span class="p">(</span><span class="n">funs</span><span class="o">.</span><span class="n">empty</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="n">l</span> <span class="o">|&gt;</span> <span class="n">fst</span>
    <span class="nb">list</span> <span class="n">s</span> <span class="n">l</span><span class="o">.</span><span class="n">tree</span>

<span class="n">let</span> <span class="n">wdiff_proj_files_update_files</span> <span class="p">(</span><span class="n">funs</span> <span class="p">:</span> <span class="n">ProjFileFuns</span><span class="o">&lt;</span><span class="s1">'a,'</span><span class="n">state</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">(</span><span class="n">state</span> <span class="p">:</span> <span class="n">ProjFilesState</span><span class="o">&lt;</span><span class="s1">'a,'</span><span class="n">state</span> <span class="o">&gt;</span><span class="p">)</span> <span class="p">(</span><span class="n">uids</span><span class="p">,</span><span class="n">files</span> <span class="p">:</span> <span class="n">ProjFiles</span><span class="p">)</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">proj_files_diff</span> <span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">uids_file</span><span class="p">,</span><span class="n">state</span><span class="o">.</span><span class="n">uids_directory</span><span class="p">,</span><span class="n">state</span><span class="o">.</span><span class="n">files</span><span class="p">)</span> <span class="p">(</span><span class="n">uids</span><span class="p">,</span><span class="n">files</span><span class="p">)</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">Some</span> <span class="p">(</span><span class="n">uids_file</span><span class="p">,</span> <span class="n">uids_directory</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">state</span> <span class="k">with</span> <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">;</span> <span class="n">uids_file</span><span class="o">=</span><span class="n">uids_file</span><span class="p">;</span> <span class="n">uids_directory</span><span class="o">=</span><span class="n">uids_directory</span><span class="p">;</span> <span class="n">result</span><span class="o">=</span><span class="n">proj_files</span> <span class="n">funs</span> <span class="n">uids_file</span> <span class="n">uids_directory</span> <span class="n">uids</span> <span class="n">state</span><span class="o">.</span><span class="n">init</span> <span class="n">files</span><span class="p">}</span>
    <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">state</span>

<span class="n">let</span> <span class="n">wdiff_proj_files_update_packages</span> <span class="p">(</span><span class="n">funs</span> <span class="p">:</span> <span class="n">ProjFileFuns</span><span class="o">&lt;</span><span class="s1">'a,'</span><span class="n">state</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">(</span><span class="n">state</span> <span class="p">:</span> <span class="n">ProjFilesState</span><span class="o">&lt;</span><span class="s1">'a,'</span><span class="n">state</span> <span class="o">&gt;</span><span class="p">)</span> <span class="p">(</span><span class="n">init</span> <span class="p">:</span> <span class="s1">'state) =</span>
    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">init</span> <span class="n">then</span> <span class="n">state</span> <span class="k">else</span>
    <span class="n">let</span> <span class="n">uids_file</span><span class="p">,</span> <span class="n">uids_directory</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">zeroCreate</span> <span class="n">state</span><span class="o">.</span><span class="n">uids_file</span><span class="o">.</span><span class="n">Length</span><span class="p">,</span> <span class="n">Array</span><span class="o">.</span><span class="n">zeroCreate</span> <span class="n">state</span><span class="o">.</span><span class="n">uids_directory</span><span class="o">.</span><span class="n">Length</span>
    <span class="n">let</span> <span class="n">uids</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="n">fst</span> <span class="n">state</span><span class="o">.</span><span class="n">uids_file</span>
    <span class="p">{</span><span class="n">state</span> <span class="k">with</span> <span class="n">init</span><span class="o">=</span><span class="n">init</span><span class="p">;</span> <span class="n">uids_file</span><span class="o">=</span><span class="n">uids_file</span><span class="p">;</span> <span class="n">uids_directory</span><span class="o">=</span><span class="n">uids_directory</span><span class="p">;</span> <span class="n">result</span><span class="o">=</span><span class="n">proj_files</span> <span class="n">funs</span> <span class="n">uids_file</span> <span class="n">uids_directory</span> <span class="n">uids</span> <span class="n">init</span> <span class="n">state</span><span class="o">.</span><span class="n">files</span><span class="p">}</span>

<span class="n">let</span> <span class="n">wdiff_proj_files</span> <span class="p">(</span><span class="n">funs</span> <span class="p">:</span> <span class="n">ProjFileFuns</span><span class="o">&lt;</span><span class="s1">'a,'</span><span class="n">state</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">(</span><span class="n">state</span> <span class="p">:</span> <span class="n">ProjFilesState</span><span class="o">&lt;</span><span class="s1">'a,'</span><span class="n">state</span> <span class="o">&gt;</span><span class="p">)</span> <span class="p">(</span><span class="n">init</span><span class="p">,(</span><span class="n">uids</span><span class="p">,</span><span class="n">files</span><span class="p">))</span> <span class="o">=</span>
    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">init</span> <span class="n">then</span> <span class="n">wdiff_proj_files_update_files</span> <span class="n">funs</span> <span class="n">state</span> <span class="p">(</span><span class="n">uids</span><span class="p">,</span><span class="n">files</span><span class="p">)</span>
    <span class="k">else</span>
        <span class="n">let</span> <span class="n">uids_file</span><span class="p">,</span> <span class="n">uids_directory</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">zeroCreate</span> <span class="n">files</span><span class="o">.</span><span class="n">num_files</span><span class="p">,</span> <span class="n">Array</span><span class="o">.</span><span class="n">zeroCreate</span> <span class="n">files</span><span class="o">.</span><span class="n">num_dirs</span>
        <span class="p">{</span><span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">;</span> <span class="n">init</span><span class="o">=</span><span class="n">init</span><span class="p">;</span> <span class="n">uids_file</span><span class="o">=</span><span class="n">uids_file</span><span class="p">;</span> <span class="n">uids_directory</span><span class="o">=</span><span class="n">uids_directory</span><span class="p">;</span> <span class="n">result</span><span class="o">=</span><span class="n">proj_files</span> <span class="n">funs</span> <span class="n">uids_file</span> <span class="n">uids_directory</span> <span class="n">uids</span> <span class="n">init</span> <span class="n">files</span><span class="p">}</span>

<span class="n">let</span> <span class="n">typechecker_results_summary</span> <span class="n">l</span> <span class="o">=</span>
    <span class="n">Stream</span><span class="o">.</span><span class="n">foldFun</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">has_error</span><span class="p">,</span><span class="n">big</span><span class="p">)</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span> <span class="p">:</span> <span class="n">InferResult</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> 
        <span class="n">has_error</span> <span class="o">||</span> <span class="n">List</span><span class="o">.</span><span class="n">isEmpty</span> <span class="n">x</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="n">false</span><span class="p">,</span>
        <span class="k">match</span> <span class="n">x</span><span class="o">.</span><span class="n">top_env_additions</span> <span class="k">with</span> 
        <span class="o">|</span> <span class="n">AOpen</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">big</span> 
        <span class="o">|</span> <span class="n">AInclude</span> <span class="n">small</span> <span class="o">-&gt;</span> <span class="n">unionInfer</span> <span class="n">small</span> <span class="n">big</span>
        <span class="p">)</span> <span class="p">(</span><span class="n">false</span><span class="p">,</span><span class="n">top_env_emptyInfer</span><span class="p">)</span> <span class="n">l</span>

<span class="n">let</span> <span class="n">funs_proj_file_tc</span> <span class="o">=</span> <span class="p">{</span><span class="n">new</span> <span class="n">ProjFileFuns</span><span class="o">&lt;</span><span class="n">TypecheckerState</span><span class="p">,</span><span class="n">TypecheckerStatePropagated</span><span class="o">&gt;</span> <span class="k">with</span>
    <span class="n">member</span> <span class="n">_</span><span class="o">.</span><span class="n">file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">state</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">=</span> 
        <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">wdiff_file_update_state</span> <span class="n">funs_file_tc</span> <span class="n">x</span> <span class="n">state</span>
        <span class="n">let</span> <span class="n">env</span> <span class="o">=</span> 
            <span class="n">typechecker_results_summary</span> <span class="n">x</span><span class="o">.</span><span class="n">result</span> <span class="o">&gt;&gt;-*</span> <span class="n">fun</span> <span class="p">(</span><span class="n">has_error</span><span class="p">,</span><span class="n">env</span><span class="p">)</span> <span class="o">-&gt;</span> 
            <span class="n">has_error</span><span class="p">,</span> <span class="n">match</span> <span class="n">name</span> <span class="k">with</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">env</span> <span class="o">|</span> <span class="n">Some</span> <span class="n">name</span> <span class="o">-&gt;</span> <span class="n">in_moduleInfer</span> <span class="n">name</span> <span class="n">env</span>
        <span class="n">x</span><span class="p">,</span><span class="n">env</span>
    <span class="n">member</span> <span class="n">_</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">small</span><span class="p">,</span><span class="n">big</span><span class="p">)</span> <span class="o">=</span> <span class="n">small</span> <span class="o">&gt;&gt;=*</span> <span class="n">fun</span> <span class="n">small</span> <span class="o">-&gt;</span> <span class="n">big</span> <span class="o">&gt;&gt;-</span> <span class="n">fun</span> <span class="n">big</span> <span class="o">-&gt;</span> <span class="n">fst</span> <span class="n">small</span> <span class="o">||</span> <span class="n">fst</span> <span class="n">big</span><span class="p">,</span> <span class="n">unionInfer</span> <span class="p">(</span><span class="n">snd</span> <span class="n">small</span><span class="p">)</span> <span class="p">(</span><span class="n">snd</span> <span class="n">big</span><span class="p">)</span>
    <span class="n">member</span> <span class="n">_</span><span class="o">.</span><span class="n">in_module</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">small</span><span class="p">)</span> <span class="o">=</span> <span class="n">small</span> <span class="o">&gt;&gt;-*</span> <span class="n">fun</span> <span class="p">(</span><span class="n">has_error</span><span class="p">,</span><span class="n">env</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">has_error</span><span class="p">,</span> <span class="n">in_moduleInfer</span> <span class="n">name</span> <span class="n">env</span>
    <span class="n">member</span> <span class="n">_</span><span class="o">.</span><span class="n">default</span><span class="s1">' default_env = Promise.Now.withValue (false,top_env_defaultInfer default_env)</span>
    <span class="n">member</span> <span class="n">_</span><span class="o">.</span><span class="n">empty</span> <span class="o">=</span> <span class="n">Promise</span><span class="o">.</span><span class="n">Now</span><span class="o">.</span><span class="n">withValue</span> <span class="p">(</span><span class="n">false</span><span class="p">,</span><span class="n">top_env_emptyInfer</span><span class="p">)</span>
    <span class="p">}</span>

<span class="nb">type</span> <span class="n">PackageEnv</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">nominals_aux</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">PackageId</span><span class="p">,</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">GlobalId</span><span class="p">,</span> <span class="p">{</span><span class="o">|</span><span class="n">name</span> <span class="p">:</span> <span class="n">string</span><span class="p">;</span> <span class="n">kind</span> <span class="p">:</span> <span class="n">TT</span><span class="o">|</span><span class="p">}</span><span class="o">&gt;&gt;</span>
    <span class="n">nominals</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">PackageId</span><span class="p">,</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">GlobalId</span><span class="p">,</span> <span class="p">{</span><span class="o">|</span><span class="nb">vars</span> <span class="p">:</span> <span class="n">Var</span> <span class="nb">list</span><span class="p">;</span> <span class="n">body</span> <span class="p">:</span> <span class="n">T</span><span class="o">|</span><span class="p">}</span><span class="o">&gt;&gt;</span>
    <span class="n">prototypes_instances</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">PackageId</span><span class="p">,</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">GlobalId</span> <span class="o">*</span> <span class="n">GlobalId</span><span class="p">,</span> <span class="n">Constraint</span> <span class="n">Set</span> <span class="nb">list</span><span class="o">&gt;&gt;</span>
    <span class="n">prototypes</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">PackageId</span><span class="p">,</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">GlobalId</span><span class="p">,</span> <span class="p">{</span><span class="o">|</span><span class="n">name</span> <span class="p">:</span> <span class="n">string</span><span class="p">;</span> <span class="n">signature</span> <span class="p">:</span> <span class="n">T</span><span class="p">;</span> <span class="n">kind</span> <span class="p">:</span> <span class="n">TT</span><span class="o">|</span><span class="p">}</span><span class="o">&gt;&gt;</span>
    <span class="n">ty</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="n">T</span><span class="o">&gt;</span>
    <span class="n">term</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="n">T</span><span class="o">&gt;</span>
    <span class="n">constraints</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="n">ConstraintOrModule</span><span class="o">&gt;</span>
    <span class="p">}</span>

<span class="n">let</span> <span class="n">union</span> <span class="n">small</span> <span class="n">big</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">nominals_aux</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">small</span><span class="o">.</span><span class="n">nominals_aux</span> <span class="n">big</span><span class="o">.</span><span class="n">nominals_aux</span>
    <span class="n">nominals</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">small</span><span class="o">.</span><span class="n">nominals</span> <span class="n">big</span><span class="o">.</span><span class="n">nominals</span>
    <span class="n">prototypes_instances</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">small</span><span class="o">.</span><span class="n">prototypes_instances</span> <span class="n">big</span><span class="o">.</span><span class="n">prototypes_instances</span>
    <span class="n">prototypes</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">small</span><span class="o">.</span><span class="n">prototypes</span> <span class="n">big</span><span class="o">.</span><span class="n">prototypes</span>
    <span class="n">ty</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">small</span><span class="o">.</span><span class="n">ty</span> <span class="n">big</span><span class="o">.</span><span class="n">ty</span>
    <span class="n">term</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">small</span><span class="o">.</span><span class="n">term</span> <span class="n">big</span><span class="o">.</span><span class="n">term</span>
    <span class="n">constraints</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">small</span><span class="o">.</span><span class="n">constraints</span> <span class="n">big</span><span class="o">.</span><span class="n">constraints</span>
    <span class="p">}</span>

<span class="n">let</span> <span class="n">in_moduleWDiff</span> <span class="n">m</span> <span class="p">(</span><span class="n">a</span> <span class="p">:</span> <span class="n">PackageEnv</span><span class="p">)</span> <span class="o">=</span>
    <span class="p">{</span><span class="n">a</span> <span class="k">with</span> 
        <span class="n">ty</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">m</span> <span class="p">(</span><span class="n">TyModule</span> <span class="n">a</span><span class="o">.</span><span class="n">ty</span><span class="p">)</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
        <span class="n">term</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">m</span> <span class="p">(</span><span class="n">TyModule</span> <span class="n">a</span><span class="o">.</span><span class="n">term</span><span class="p">)</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">m</span> <span class="p">(</span><span class="n">M</span> <span class="n">a</span><span class="o">.</span><span class="n">constraints</span><span class="p">)</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
        <span class="p">}</span>

<span class="n">let</span> <span class="n">package_to_file</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">PackageEnv</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">nominals_next_tag</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">nominals_aux</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span><span class="p">)</span> <span class="n">x</span><span class="o">.</span><span class="n">nominals_aux</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
    <span class="n">nominals</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span><span class="p">)</span> <span class="n">x</span><span class="o">.</span><span class="n">nominals</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
    <span class="n">prototypes_next_tag</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">prototypes_instances</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span><span class="p">)</span> <span class="n">x</span><span class="o">.</span><span class="n">prototypes_instances</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
    <span class="n">prototypes</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span><span class="p">)</span> <span class="n">x</span><span class="o">.</span><span class="n">prototypes</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
    <span class="n">ty</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">ty</span>
    <span class="n">term</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">term</span>
    <span class="n">constraints</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">constraints</span>
    <span class="p">}</span>

<span class="n">let</span> <span class="n">add_file_to_package</span> <span class="n">package_id</span> <span class="p">(</span><span class="n">small</span> <span class="p">:</span> <span class="n">TopEnv</span><span class="p">)</span> <span class="p">(</span><span class="n">big</span> <span class="p">:</span> <span class="n">PackageEnv</span><span class="p">):</span> <span class="n">PackageEnv</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">nominals_aux</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">package_id</span> <span class="n">small</span><span class="o">.</span><span class="n">nominals_aux</span> <span class="n">big</span><span class="o">.</span><span class="n">nominals_aux</span>
    <span class="n">nominals</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">package_id</span> <span class="n">small</span><span class="o">.</span><span class="n">nominals</span> <span class="n">big</span><span class="o">.</span><span class="n">nominals</span>
    <span class="n">prototypes_instances</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">package_id</span> <span class="n">small</span><span class="o">.</span><span class="n">prototypes_instances</span> <span class="n">big</span><span class="o">.</span><span class="n">prototypes_instances</span>
    <span class="n">prototypes</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">package_id</span> <span class="n">small</span><span class="o">.</span><span class="n">prototypes</span> <span class="n">big</span><span class="o">.</span><span class="n">prototypes</span>
    <span class="n">ty</span> <span class="o">=</span> <span class="n">small</span><span class="o">.</span><span class="n">ty</span>
    <span class="n">term</span> <span class="o">=</span> <span class="n">small</span><span class="o">.</span><span class="n">term</span>
    <span class="n">constraints</span> <span class="o">=</span> <span class="n">small</span><span class="o">.</span><span class="n">constraints</span>
    <span class="p">}</span>

<span class="n">let</span> <span class="n">package_env_empty</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">nominals_aux</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
    <span class="n">nominals</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
    <span class="n">prototypes_instances</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
    <span class="n">prototypes</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
    <span class="n">ty</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
    <span class="n">term</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
    <span class="n">constraints</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
    <span class="p">}</span>

<span class="n">let</span> <span class="n">package_env_default</span> <span class="n">default_env</span> <span class="o">=</span> 
    <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">top_env_defaultInfer</span> <span class="n">default_env</span>
    <span class="p">{</span><span class="n">package_env_empty</span> <span class="k">with</span> <span class="n">ty</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">ty</span><span class="p">;</span> <span class="n">term</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">term</span><span class="p">;</span> <span class="n">constraints</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">constraints</span><span class="p">}</span>

<span class="nb">type</span> <span class="n">ProjPackagesState</span><span class="o">&lt;</span><span class="s1">'a&gt; = {</span>
    <span class="n">packages</span> <span class="p">:</span> <span class="p">(</span><span class="n">string</span> <span class="n">option</span> <span class="o">*</span> <span class="s1">'a) list</span>
    <span class="n">result</span> <span class="p">:</span> <span class="s1">'a</span>
    <span class="p">}</span>
<span class="nb">type</span> <span class="n">ProjState</span><span class="o">&lt;</span><span class="s1">'file_inputs,'</span><span class="n">files</span><span class="p">,</span><span class="s1">'packages&gt; = {</span>
    <span class="n">package_id</span> <span class="p">:</span> <span class="n">PackageId</span>
    <span class="n">packages</span> <span class="p">:</span> <span class="s1">'packages ProjPackagesState</span>
    <span class="n">files</span> <span class="p">:</span> <span class="n">ProjFilesState</span><span class="o">&lt;</span><span class="s1">'file_inputs,'</span><span class="n">files</span><span class="o">&gt;</span>
    <span class="n">result</span> <span class="p">:</span> <span class="s1">'packages</span>
    <span class="p">}</span>
<span class="nb">type</span> <span class="n">TypecheckerStateTop</span> <span class="o">=</span> <span class="p">(</span><span class="nb">bool</span> <span class="o">*</span> <span class="n">PackageEnv</span><span class="p">)</span> <span class="n">Promise</span>
<span class="nb">type</span> <span class="n">ProjStateTC</span> <span class="o">=</span> <span class="n">ProjState</span><span class="o">&lt;</span><span class="n">TypecheckerState</span><span class="p">,</span><span class="n">TypecheckerStatePropagated</span><span class="p">,</span><span class="n">TypecheckerStateTop</span><span class="o">&gt;</span>
<span class="nb">type</span> <span class="n">ProjEnvTC</span> <span class="o">=</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">PackageId</span><span class="p">,</span><span class="n">ProjStateTC</span><span class="o">&gt;</span>

<span class="nb">type</span> <span class="n">ProjPackageFuns</span><span class="o">&lt;</span><span class="s1">'file,'</span><span class="n">package</span><span class="o">&gt;</span> <span class="o">=</span>
    <span class="n">abstract</span> <span class="n">member</span> <span class="n">unions</span> <span class="p">:</span> <span class="n">DefaultEnv</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">string</span> <span class="n">option</span> <span class="o">*</span> <span class="s1">'package) list -&gt; '</span><span class="n">package</span>
    <span class="n">abstract</span> <span class="n">member</span> <span class="n">union</span> <span class="p">:</span> <span class="s1">'package * '</span><span class="n">package</span> <span class="o">-&gt;</span> <span class="s1">'package</span>
    <span class="n">abstract</span> <span class="n">member</span> <span class="n">in_module</span> <span class="p">:</span> <span class="n">string</span> <span class="o">*</span> <span class="s1">'package -&gt; '</span><span class="n">package</span>
    <span class="n">abstract</span> <span class="n">member</span> <span class="n">package_to_file</span> <span class="p">:</span> <span class="s1">'package -&gt; '</span><span class="n">file</span>
    <span class="n">abstract</span> <span class="n">member</span> <span class="n">add_file_to_package</span> <span class="p">:</span> <span class="n">PackageId</span> <span class="o">*</span> <span class="s1">'file * '</span><span class="n">package</span> <span class="o">-&gt;</span> <span class="s1">'package</span>
    <span class="n">abstract</span> <span class="n">member</span> <span class="n">default</span><span class="s1">' : DefaultEnv -&gt; '</span><span class="n">package</span>
    <span class="n">abstract</span> <span class="n">member</span> <span class="n">empty</span> <span class="p">:</span> <span class="s1">'package</span>

<span class="n">let</span> <span class="n">funs_proj_package_tc</span> <span class="o">=</span> <span class="p">{</span><span class="n">new</span> <span class="n">ProjPackageFuns</span><span class="o">&lt;</span><span class="n">TypecheckerStatePropagated</span><span class="p">,</span><span class="n">TypecheckerStateTop</span><span class="o">&gt;</span> <span class="k">with</span>
    <span class="n">member</span> <span class="n">funs</span><span class="o">.</span><span class="n">unions</span> <span class="n">default_env</span> <span class="n">l</span> <span class="o">=</span> 
        <span class="n">let</span> <span class="n">f</span> <span class="o">=</span> <span class="n">function</span> <span class="n">Some</span> <span class="n">name</span><span class="p">,</span> <span class="n">small</span> <span class="o">-&gt;</span> <span class="n">funs</span><span class="o">.</span><span class="n">in_module</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">small</span><span class="p">)</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">small</span> <span class="o">-&gt;</span> <span class="n">small</span>
        <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">big</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">funs</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">f</span> <span class="n">x</span><span class="p">,</span><span class="n">big</span><span class="p">))</span> <span class="p">(</span><span class="n">funs</span><span class="o">.</span><span class="n">default</span><span class="s1">' default_env) l</span>
    <span class="n">member</span> <span class="n">_</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">small</span><span class="p">,</span><span class="n">big</span><span class="p">)</span> <span class="o">=</span> 
        <span class="n">Job</span><span class="o">.</span><span class="n">delay</span> <span class="o">&lt;|</span> <span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span>
            <span class="n">Hopac</span><span class="o">.</span><span class="n">queueIgnore</span> <span class="n">big</span>
            <span class="n">small</span> <span class="o">&gt;&gt;=</span> <span class="n">fun</span> <span class="n">a</span> <span class="o">-&gt;</span>
            <span class="n">big</span> <span class="o">&gt;&gt;-</span> <span class="n">fun</span> <span class="n">b</span> <span class="o">-&gt;</span>
            <span class="n">fst</span> <span class="n">a</span> <span class="o">||</span> <span class="n">fst</span> <span class="n">b</span><span class="p">,</span> <span class="n">union</span> <span class="p">(</span><span class="n">snd</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">snd</span> <span class="n">b</span><span class="p">)</span>
        <span class="o">|&gt;</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">memo</span>
    <span class="n">member</span> <span class="n">_</span><span class="o">.</span><span class="n">in_module</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&gt;&gt;-*</span> <span class="n">fun</span> <span class="p">(</span><span class="n">has_error</span><span class="p">,</span><span class="n">env</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">has_error</span><span class="p">,</span> <span class="n">in_moduleWDiff</span> <span class="n">name</span> <span class="n">env</span>
    <span class="n">member</span> <span class="n">_</span><span class="o">.</span><span class="n">package_to_file</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&gt;&gt;-*</span> <span class="n">fun</span> <span class="p">(</span><span class="n">has_error</span><span class="p">,</span><span class="n">env</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">has_error</span><span class="p">,</span> <span class="n">package_to_file</span> <span class="n">env</span>
    <span class="n">member</span> <span class="n">_</span><span class="o">.</span><span class="n">add_file_to_package</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">=</span> 
        <span class="n">a</span> <span class="o">&gt;&gt;=*</span> <span class="n">fun</span> <span class="p">(</span><span class="n">has_error</span><span class="p">,</span><span class="n">env</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="n">b</span> <span class="o">&gt;&gt;-*</span> <span class="n">fun</span> <span class="p">(</span><span class="n">has_error</span><span class="s1">',env'</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="n">has_error</span> <span class="o">||</span> <span class="n">has_error</span><span class="s1">', add_file_to_package pid env env'</span>
    <span class="n">member</span> <span class="n">_</span><span class="o">.</span><span class="n">default</span><span class="s1">' default_env = Promise.Now.withValue (false, package_env_default default_env)</span>
    <span class="n">member</span> <span class="n">_</span><span class="o">.</span><span class="n">empty</span> <span class="o">=</span> <span class="n">Promise</span><span class="o">.</span><span class="n">Now</span><span class="o">.</span><span class="n">withValue</span> <span class="p">(</span><span class="n">false</span><span class="p">,</span> <span class="n">package_env_empty</span><span class="p">)</span>
    <span class="p">}</span>

<span class="n">let</span> <span class="n">wdiff_proj_init</span> <span class="n">default_env</span> <span class="p">(</span><span class="n">funs_packages</span> <span class="p">:</span> <span class="n">ProjPackageFuns</span><span class="o">&lt;</span><span class="s1">'file,'</span><span class="n">package</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">(</span><span class="n">funs_files</span> <span class="p">:</span> <span class="n">ProjFileFuns</span><span class="o">&lt;</span><span class="s1">'file_input,'</span><span class="n">file</span><span class="o">&gt;</span><span class="p">)</span> <span class="n">package_id</span> <span class="p">:</span> <span class="n">ProjState</span><span class="o">&lt;</span><span class="s1">'file_input,'</span><span class="n">file</span><span class="p">,</span><span class="s1">'package&gt; = </span>
    <span class="n">let</span> <span class="n">packages</span> <span class="o">=</span> <span class="p">{</span> <span class="n">packages</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">result</span> <span class="o">=</span> <span class="n">funs_packages</span><span class="o">.</span><span class="n">default</span><span class="s1">' default_env}</span>
    <span class="n">let</span> <span class="n">files</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">files</span><span class="o">=</span><span class="p">{</span><span class="n">tree</span><span class="o">=</span><span class="p">[];</span> <span class="n">num_dirs</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">num_files</span><span class="o">=</span><span class="mi">0</span><span class="p">}</span>
        <span class="n">uids_file</span><span class="o">=</span><span class="p">[</span><span class="o">||</span><span class="p">];</span> <span class="n">uids_directory</span><span class="o">=</span><span class="p">[</span><span class="o">||</span><span class="p">]</span>
        <span class="n">init</span><span class="o">=</span><span class="n">funs_files</span><span class="o">.</span><span class="n">default</span><span class="s1">' default_env; result=funs_files.empty</span>
        <span class="p">}</span>
    <span class="n">let</span> <span class="n">result</span> <span class="o">=</span> <span class="n">funs_packages</span><span class="o">.</span><span class="n">empty</span>
    <span class="p">{</span> <span class="n">package_id</span> <span class="o">=</span> <span class="n">package_id</span><span class="p">;</span> <span class="n">packages</span> <span class="o">=</span> <span class="n">packages</span><span class="p">;</span> <span class="n">files</span> <span class="o">=</span> <span class="n">files</span><span class="p">;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">}</span>

<span class="n">let</span> <span class="n">wdiff_proj_packages</span> <span class="n">default_env</span> <span class="p">(</span><span class="n">funs</span> <span class="p">:</span> <span class="n">ProjPackageFuns</span><span class="o">&lt;</span><span class="n">_</span><span class="p">,</span><span class="s1">'a&gt;) (state : '</span><span class="n">a</span> <span class="n">ProjPackagesState</span><span class="p">)</span> <span class="n">x</span> <span class="o">=</span>
    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">packages</span> <span class="o">=</span> <span class="n">x</span> <span class="n">then</span> <span class="n">state</span> <span class="k">else</span> <span class="p">{</span><span class="n">packages</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">funs</span><span class="o">.</span><span class="n">unions</span> <span class="n">default_env</span> <span class="n">x</span> <span class="p">}</span>

<span class="n">let</span> <span class="n">wdiff_proj_update_packages</span> <span class="n">default_env</span> <span class="n">funs_packages</span> <span class="n">funs_files</span> <span class="p">(</span><span class="n">state</span> <span class="p">:</span> <span class="n">ProjState</span><span class="o">&lt;</span><span class="s1">'a,'</span><span class="n">b</span><span class="p">,</span><span class="s1">'state&gt;) x =</span>
    <span class="n">let</span> <span class="n">packages</span> <span class="o">=</span> <span class="n">wdiff_proj_packages</span> <span class="n">default_env</span> <span class="n">funs_packages</span> <span class="n">state</span><span class="o">.</span><span class="n">packages</span> <span class="n">x</span>
    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">packages</span> <span class="o">=</span> <span class="n">packages</span> <span class="n">then</span> <span class="n">state</span> <span class="k">else</span>
    <span class="n">let</span> <span class="n">files</span> <span class="o">=</span> <span class="n">wdiff_proj_files_update_packages</span> <span class="n">funs_files</span> <span class="n">state</span><span class="o">.</span><span class="n">files</span> <span class="p">(</span><span class="n">funs_packages</span><span class="o">.</span><span class="n">package_to_file</span><span class="p">(</span><span class="n">packages</span><span class="o">.</span><span class="n">result</span><span class="p">))</span>
    <span class="n">let</span> <span class="n">result</span> <span class="o">=</span> <span class="n">funs_packages</span><span class="o">.</span><span class="n">add_file_to_package</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">package_id</span><span class="p">,</span><span class="n">files</span><span class="o">.</span><span class="n">result</span><span class="p">,</span><span class="n">packages</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>
    <span class="p">{</span><span class="n">state</span> <span class="k">with</span> <span class="n">packages</span><span class="o">=</span><span class="n">packages</span><span class="p">;</span> <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">;</span> <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">}</span>

<span class="n">let</span> <span class="n">wdiff_proj_update_files</span> <span class="p">(</span><span class="n">funs_packages</span> <span class="p">:</span> <span class="n">ProjPackageFuns</span><span class="o">&lt;</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="o">&gt;</span><span class="p">)</span> <span class="n">funs_files</span> <span class="p">(</span><span class="n">state</span> <span class="p">:</span> <span class="n">ProjState</span><span class="o">&lt;</span><span class="s1">'a,'</span><span class="n">b</span><span class="p">,</span><span class="s1">'state&gt;) x =</span>
    <span class="n">let</span> <span class="n">files</span> <span class="o">=</span> <span class="n">wdiff_proj_files_update_files</span> <span class="n">funs_files</span> <span class="n">state</span><span class="o">.</span><span class="n">files</span> <span class="n">x</span>
    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">files</span> <span class="n">then</span> <span class="n">state</span> <span class="k">else</span>
    <span class="n">let</span> <span class="n">result</span> <span class="o">=</span> <span class="n">funs_packages</span><span class="o">.</span><span class="n">add_file_to_package</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">package_id</span><span class="p">,</span><span class="n">files</span><span class="o">.</span><span class="n">result</span><span class="p">,</span><span class="n">state</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>
    <span class="p">{</span><span class="n">state</span> <span class="k">with</span> <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">;</span> <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">}</span>

<span class="n">let</span> <span class="n">wdiff_proj</span> <span class="n">default_env</span> <span class="p">(</span><span class="n">funs_packages</span> <span class="p">:</span> <span class="n">ProjPackageFuns</span><span class="o">&lt;</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="o">&gt;</span><span class="p">)</span> <span class="n">funs_files</span> <span class="p">(</span><span class="n">state</span> <span class="p">:</span> <span class="n">ProjState</span><span class="o">&lt;</span><span class="s1">'file_input,'</span><span class="n">file</span><span class="p">,</span><span class="s1">'state&gt;) (packages,files) =</span>
    <span class="n">let</span> <span class="n">packages</span> <span class="o">=</span> <span class="n">wdiff_proj_packages</span> <span class="n">default_env</span> <span class="n">funs_packages</span> <span class="n">state</span><span class="o">.</span><span class="n">packages</span> <span class="n">packages</span>
    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">packages</span> <span class="o">=</span> <span class="n">packages</span> <span class="n">then</span> <span class="n">wdiff_proj_update_files</span> <span class="n">funs_packages</span> <span class="n">funs_files</span> <span class="n">state</span> <span class="n">files</span>
    <span class="k">else</span>
        <span class="n">let</span> <span class="n">files</span> <span class="o">=</span> <span class="n">wdiff_proj_files</span> <span class="n">funs_files</span> <span class="n">state</span><span class="o">.</span><span class="n">files</span> <span class="p">(</span><span class="n">funs_packages</span><span class="o">.</span><span class="n">package_to_file</span><span class="p">(</span><span class="n">packages</span><span class="o">.</span><span class="n">result</span><span class="p">),</span><span class="n">files</span><span class="p">)</span>
        <span class="n">let</span> <span class="n">result</span> <span class="o">=</span> <span class="n">funs_packages</span><span class="o">.</span><span class="n">add_file_to_package</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">package_id</span><span class="p">,</span><span class="n">files</span><span class="o">.</span><span class="n">result</span><span class="p">,</span><span class="n">packages</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>
        <span class="p">{</span><span class="n">state</span> <span class="k">with</span> <span class="n">packages</span><span class="o">=</span><span class="n">packages</span><span class="p">;</span> <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">;</span> <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">}</span>

<span class="nb">type</span> <span class="n">ProjEnvUpdate</span><span class="o">&lt;</span><span class="s1">'a&gt; =</span>
    <span class="o">|</span> <span class="n">UpdatePackageModule</span> <span class="n">of</span> <span class="n">PackageId</span> <span class="o">*</span> <span class="p">(</span><span class="n">string</span> <span class="n">option</span> <span class="o">*</span> <span class="n">PackageId</span><span class="p">)</span> <span class="nb">list</span> <span class="o">*</span> <span class="p">(</span><span class="s1">'a [] * ProjFiles)</span>
    <span class="o">|</span> <span class="n">UpdatePackage</span> <span class="n">of</span> <span class="n">PackageId</span> <span class="o">*</span> <span class="p">(</span><span class="n">string</span> <span class="n">option</span> <span class="o">*</span> <span class="n">PackageId</span><span class="p">)</span> <span class="nb">list</span>

<span class="n">let</span> <span class="n">map_packages</span> <span class="n">s</span> <span class="n">packages</span> <span class="o">=</span> <span class="n">packages</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="p">,</span> <span class="p">(</span><span class="n">Map</span><span class="o">.</span><span class="n">find</span> <span class="n">b</span> <span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>
<span class="n">let</span> <span class="n">wdiff_projenv</span> <span class="n">default_env</span> <span class="n">funs_packages</span> <span class="n">funs_files</span> <span class="p">(</span><span class="n">s</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">PackageId</span><span class="p">,</span><span class="n">ProjState</span><span class="o">&lt;</span><span class="s1">'a,'</span><span class="n">b</span><span class="p">,</span><span class="s1">'state&gt;&gt;) l =</span>
    <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">UpdatePackageModule</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span><span class="n">packages</span><span class="p">,</span><span class="n">files</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">uid</span> <span class="p">(</span><span class="n">wdiff_proj</span> <span class="n">default_env</span> <span class="n">funs_packages</span> <span class="n">funs_files</span> <span class="n">s</span><span class="o">.</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span> <span class="p">(</span><span class="n">map_packages</span> <span class="n">s</span> <span class="n">packages</span><span class="p">,</span><span class="n">files</span><span class="p">))</span> <span class="n">s</span>
        <span class="o">|</span> <span class="n">UpdatePackage</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span><span class="n">packages</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">uid</span> <span class="p">(</span><span class="n">wdiff_proj_update_packages</span> <span class="n">default_env</span> <span class="n">funs_packages</span> <span class="n">funs_files</span> <span class="n">s</span><span class="o">.</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span> <span class="p">(</span><span class="n">map_packages</span> <span class="n">s</span> <span class="n">packages</span><span class="p">))</span> <span class="n">s</span>
        <span class="p">)</span> <span class="n">s</span> <span class="n">l</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=61">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="WDiffPrepass">WDiffPrepass<a class="anchor-link" href="#WDiffPrepass"></a></h2>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=62">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="nb">open</span> <span class="n">Hopac</span>
<span class="nb">open</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">Infixes</span>
<span class="nb">open</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">Extensions</span>
<span class="nb">open</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">Stream</span>

<span class="nb">type</span> <span class="n">PrepassStateValue</span> <span class="o">=</span> <span class="n">InferResult</span> <span class="o">*</span> <span class="n">PrepassTopEnv</span> <span class="n">AdditionType</span> <span class="o">*</span> <span class="n">PrepassTopEnv</span>
<span class="nb">type</span> <span class="n">PrepassStatePropagated</span> <span class="o">=</span> <span class="n">PrepassTopEnv</span> <span class="n">Promise</span>
<span class="nb">type</span> <span class="n">PrepassState</span> <span class="o">=</span> <span class="n">FileState</span><span class="o">&lt;</span><span class="n">PackageId</span> <span class="o">*</span> <span class="n">ModuleId</span> <span class="o">*</span> <span class="n">string</span> <span class="o">*</span> <span class="n">TypecheckerStateValue</span> <span class="n">Stream</span><span class="p">,</span> <span class="n">PrepassStateValue</span> <span class="n">Stream</span><span class="p">,</span> <span class="n">PrepassStatePropagated</span><span class="o">&gt;</span>

<span class="n">let</span> <span class="n">rec</span> <span class="n">prepass</span> <span class="p">(</span><span class="n">package_id</span><span class="p">,</span><span class="n">module_id</span><span class="p">,</span><span class="n">path</span><span class="p">,</span><span class="n">env</span><span class="p">)</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">Cons</span><span class="p">((</span><span class="n">_</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="p">:</span> <span class="n">TypecheckerStateValue</span><span class="p">,</span> <span class="n">ls</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="n">r</span><span class="o">.</span><span class="n">filled_top</span> <span class="o">&gt;&gt;-</span> <span class="n">fun</span> <span class="n">filled_top</span> <span class="o">-&gt;</span> 
        <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">prepassPrepass</span> <span class="n">package_id</span> <span class="n">module_id</span> <span class="n">path</span> <span class="n">env</span><span class="p">)</span><span class="o">.</span><span class="n">filled_top</span> <span class="n">filled_top</span>
        <span class="n">let</span> <span class="n">adds</span> <span class="o">=</span> <span class="n">match</span> <span class="n">x</span> <span class="k">with</span> <span class="n">AOpen</span> <span class="n">x</span> <span class="o">|</span> <span class="n">AInclude</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span>
        <span class="n">let</span> <span class="n">env</span> <span class="o">=</span> <span class="n">unionPrepass</span> <span class="n">adds</span> <span class="n">env</span>
        <span class="n">Cons</span><span class="p">((</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">env</span><span class="p">),</span><span class="n">ls</span> <span class="o">&gt;&gt;=*</span> <span class="n">prepass</span> <span class="p">(</span><span class="n">package_id</span><span class="p">,</span><span class="n">module_id</span><span class="p">,</span><span class="n">path</span><span class="p">,</span><span class="n">env</span><span class="p">))</span>
    <span class="o">|</span> <span class="n">Nil</span> <span class="o">-&gt;</span>
        <span class="n">Job</span><span class="o">.</span><span class="n">result</span> <span class="n">Nil</span>

<span class="n">let</span> <span class="n">rec</span> <span class="n">diffWDiffPrepass</span> <span class="p">(</span><span class="n">package_id</span><span class="p">,</span><span class="n">module_id</span><span class="p">,</span><span class="n">path</span><span class="p">,</span><span class="n">env</span><span class="p">)</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="nb">input</span> <span class="p">:</span> <span class="n">TypecheckerStateValue</span> <span class="n">Stream</span><span class="p">)</span> <span class="o">=</span> 
    <span class="nb">input</span> <span class="o">&gt;&gt;**</span> <span class="n">fun</span> <span class="nb">input</span> <span class="o">-&gt;</span>
    <span class="n">let</span> <span class="n">tc</span> <span class="p">()</span> <span class="o">=</span> <span class="n">prepass</span> <span class="p">(</span><span class="n">package_id</span><span class="p">,</span><span class="n">module_id</span><span class="p">,</span><span class="n">path</span><span class="p">,</span><span class="n">env</span><span class="p">)</span> <span class="nb">input</span> <span class="o">|&gt;</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">memo</span>
    <span class="k">if</span> <span class="n">Promise</span><span class="o">.</span><span class="n">Now</span><span class="o">.</span><span class="n">isFulfilled</span> <span class="n">result</span> <span class="n">then</span>
        <span class="k">match</span> <span class="n">Promise</span><span class="o">.</span><span class="n">Now</span><span class="o">.</span><span class="n">get</span> <span class="n">result</span><span class="p">,</span><span class="nb">input</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">Cons</span><span class="p">((</span><span class="sa">b</span><span class="s1">',_,env as x),next), Cons((_,b,_),bs) when b'</span> <span class="o">=</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">Cons</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">diffWDiffPrepass</span> <span class="p">(</span><span class="n">package_id</span><span class="p">,</span><span class="n">module_id</span><span class="p">,</span><span class="n">path</span><span class="p">,</span><span class="n">env</span><span class="p">)</span> <span class="p">(</span><span class="nb">next</span><span class="p">,</span><span class="n">bs</span><span class="p">))</span> <span class="o">|&gt;</span> <span class="n">Promise</span><span class="o">.</span><span class="n">Now</span><span class="o">.</span><span class="n">withValue</span>
        <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">tc</span><span class="p">()</span>
    <span class="k">else</span> <span class="n">tc</span><span class="p">()</span>

<span class="n">let</span> <span class="n">funs_file_prepass</span> <span class="o">=</span> <span class="p">{</span><span class="n">new</span> <span class="n">FileFuns</span><span class="o">&lt;</span><span class="n">PackageId</span> <span class="o">*</span> <span class="n">ModuleId</span> <span class="o">*</span> <span class="n">string</span> <span class="o">*</span> <span class="n">TypecheckerStateValue</span> <span class="n">Stream</span><span class="p">,</span> <span class="n">PrepassStateValue</span> <span class="n">Stream</span><span class="p">,</span> <span class="n">PrepassStatePropagated</span><span class="o">&gt;</span> <span class="k">with</span>
    <span class="n">member</span> <span class="n">_</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">state</span><span class="p">,(</span><span class="n">pid</span><span class="p">,</span><span class="n">mid</span><span class="p">,</span><span class="n">path</span><span class="p">,</span><span class="n">x</span><span class="p">))</span> <span class="o">=</span> 
        <span class="n">state</span> <span class="o">&gt;&gt;=*</span> <span class="n">fun</span> <span class="n">env</span> <span class="o">-&gt;</span> 
        <span class="n">x</span> <span class="o">&gt;&gt;=</span> <span class="n">prepass</span> <span class="p">(</span><span class="n">pid</span><span class="p">,</span><span class="n">mid</span><span class="p">,</span><span class="n">path</span><span class="p">,</span><span class="n">env</span><span class="p">)</span>
    <span class="n">member</span> <span class="n">_</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="n">b</span><span class="p">,(</span><span class="n">pid</span><span class="p">,</span><span class="n">mid</span><span class="p">,</span><span class="n">path</span><span class="p">,</span><span class="n">a</span><span class="p">))</span> <span class="o">=</span>
        <span class="n">state</span> <span class="o">&gt;&gt;=*</span> <span class="n">fun</span> <span class="n">env</span> <span class="o">-&gt;</span> <span class="n">diffWDiffPrepass</span> <span class="p">(</span><span class="n">pid</span><span class="p">,</span><span class="n">mid</span><span class="p">,</span><span class="n">path</span><span class="p">,</span><span class="n">env</span><span class="p">)</span> <span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
    <span class="n">member</span> <span class="n">_</span><span class="o">.</span><span class="n">init</span> <span class="n">x</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nb">input</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">Promise</span><span class="o">.</span><span class="n">Now</span><span class="o">.</span><span class="n">never</span><span class="p">()</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">Promise</span><span class="o">.</span><span class="n">Now</span><span class="o">.</span><span class="n">never</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="n">let</span> <span class="n">prepass_results_summary</span> <span class="n">l</span> <span class="o">=</span>
    <span class="n">Stream</span><span class="o">.</span><span class="n">foldFun</span> <span class="p">(</span><span class="n">fun</span> <span class="n">big</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">AOpen</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">big</span>
        <span class="o">|</span> <span class="n">AInclude</span> <span class="n">small</span> <span class="o">-&gt;</span> <span class="n">unionPrepass</span> <span class="n">small</span> <span class="n">big</span>
        <span class="p">)</span> <span class="p">(</span><span class="n">top_env_emptyPrepass</span><span class="p">)</span> <span class="n">l</span>

<span class="n">let</span> <span class="n">funs_proj_file_prepass</span> <span class="o">=</span> <span class="p">{</span><span class="n">new</span> <span class="n">ProjFileFuns</span><span class="o">&lt;</span><span class="n">PrepassState</span><span class="p">,</span><span class="n">PrepassStatePropagated</span><span class="o">&gt;</span> <span class="k">with</span>
    <span class="n">member</span> <span class="n">_</span><span class="o">.</span><span class="n">file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">state</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">=</span> 
        <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">wdiff_file_update_state</span> <span class="n">funs_file_prepass</span> <span class="n">x</span> <span class="n">state</span>
        <span class="n">let</span> <span class="n">env</span> <span class="o">=</span> 
            <span class="n">prepass_results_summary</span> <span class="n">x</span><span class="o">.</span><span class="n">result</span> <span class="o">&gt;&gt;-*</span> <span class="n">fun</span> <span class="n">env</span> <span class="o">-&gt;</span> 
            <span class="k">match</span> <span class="n">name</span> <span class="k">with</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">env</span> <span class="o">|</span> <span class="n">Some</span> <span class="n">name</span> <span class="o">-&gt;</span> <span class="n">in_modulePrepass</span> <span class="n">name</span> <span class="n">env</span>
        <span class="n">x</span><span class="p">,</span><span class="n">env</span>
    <span class="n">member</span> <span class="n">_</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">small</span><span class="p">,</span><span class="n">big</span><span class="p">)</span> <span class="o">=</span> <span class="n">small</span> <span class="o">&gt;&gt;=*</span> <span class="n">fun</span> <span class="n">small</span> <span class="o">-&gt;</span> <span class="n">big</span> <span class="o">&gt;&gt;-</span> <span class="n">fun</span> <span class="n">big</span> <span class="o">-&gt;</span> <span class="n">unionPrepass</span> <span class="n">small</span> <span class="n">big</span>
    <span class="n">member</span> <span class="n">_</span><span class="o">.</span><span class="n">in_module</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">small</span><span class="p">)</span> <span class="o">=</span> <span class="n">small</span> <span class="o">&gt;&gt;-*</span> <span class="n">in_modulePrepass</span> <span class="n">name</span>
    <span class="n">member</span> <span class="n">_</span><span class="o">.</span><span class="n">default</span><span class="s1">' default_env = Promise.Now.withValue (top_env_defaultPrepass default_env)</span>
    <span class="n">member</span> <span class="n">_</span><span class="o">.</span><span class="n">empty</span> <span class="o">=</span> <span class="n">Promise</span><span class="o">.</span><span class="n">Now</span><span class="o">.</span><span class="n">withValue</span> <span class="n">top_env_emptyPrepass</span>
    <span class="p">}</span>

<span class="nb">type</span> <span class="n">PrepassPackageEnv</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">prototypes_instances</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="nb">int</span><span class="p">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">GlobalId</span> <span class="o">*</span> <span class="n">GlobalId</span><span class="p">,</span><span class="n">E</span><span class="o">&gt;&gt;</span>
    <span class="n">nominals</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="nb">int</span><span class="p">,</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">GlobalId</span><span class="p">,{</span><span class="o">|</span><span class="n">body</span> <span class="p">:</span> <span class="n">TPrepass</span><span class="p">;</span> <span class="n">name</span> <span class="p">:</span> <span class="n">string</span><span class="o">|</span><span class="p">}</span><span class="o">&gt;&gt;</span>
    <span class="n">term</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="n">E</span><span class="o">&gt;</span>
    <span class="n">ty</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="n">TPrepass</span><span class="o">&gt;</span>
    <span class="p">}</span>

<span class="n">let</span> <span class="n">unionWDiffPrepass</span> <span class="n">small</span> <span class="n">big</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">prototypes_instances</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">small</span><span class="o">.</span><span class="n">prototypes_instances</span> <span class="n">big</span><span class="o">.</span><span class="n">prototypes_instances</span>
    <span class="n">nominals</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">small</span><span class="o">.</span><span class="n">nominals</span> <span class="n">big</span><span class="o">.</span><span class="n">nominals</span>
    <span class="n">term</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">small</span><span class="o">.</span><span class="n">term</span> <span class="n">big</span><span class="o">.</span><span class="n">term</span>
    <span class="n">ty</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">small</span><span class="o">.</span><span class="n">ty</span> <span class="n">big</span><span class="o">.</span><span class="n">ty</span>
    <span class="p">}</span>
    
<span class="n">let</span> <span class="n">in_module</span> <span class="n">m</span> <span class="p">(</span><span class="n">a</span> <span class="p">:</span> <span class="n">PrepassPackageEnv</span><span class="p">)</span> <span class="o">=</span>
    <span class="p">{</span><span class="n">a</span> <span class="k">with</span> 
        <span class="n">ty</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">m</span> <span class="p">(</span><span class="n">TModule</span> <span class="n">a</span><span class="o">.</span><span class="n">ty</span><span class="p">)</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
        <span class="n">term</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">m</span> <span class="p">(</span><span class="n">EModule</span> <span class="n">a</span><span class="o">.</span><span class="n">term</span><span class="p">)</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
        <span class="p">}</span>

<span class="n">let</span> <span class="n">package_env_emptyWDiffPrepass</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">prototypes_instances</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
    <span class="n">nominals</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
    <span class="n">term</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
    <span class="n">ty</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
    <span class="p">}</span>

<span class="n">let</span> <span class="n">package_to_fileWDiffPrepass</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">PrepassPackageEnv</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">nominals_next_tag</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">nominals</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span><span class="p">)</span> <span class="n">x</span><span class="o">.</span><span class="n">nominals</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
    <span class="n">prototypes_next_tag</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">prototypes_instances</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">foldBack</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span><span class="p">)</span> <span class="n">x</span><span class="o">.</span><span class="n">prototypes_instances</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
    <span class="n">ty</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">ty</span>
    <span class="n">term</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">term</span>
    <span class="p">}</span>

<span class="n">let</span> <span class="n">add_file_to_packageWDiffPrepass</span> <span class="n">package_id</span> <span class="p">(</span><span class="n">small</span> <span class="p">:</span> <span class="n">PrepassTopEnv</span><span class="p">)</span> <span class="p">(</span><span class="n">big</span> <span class="p">:</span> <span class="n">PrepassPackageEnv</span><span class="p">):</span> <span class="n">PrepassPackageEnv</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">nominals</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">package_id</span> <span class="n">small</span><span class="o">.</span><span class="n">nominals</span> <span class="n">big</span><span class="o">.</span><span class="n">nominals</span>
    <span class="n">prototypes_instances</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">package_id</span> <span class="n">small</span><span class="o">.</span><span class="n">prototypes_instances</span> <span class="n">big</span><span class="o">.</span><span class="n">prototypes_instances</span>
    <span class="n">ty</span> <span class="o">=</span> <span class="n">small</span><span class="o">.</span><span class="n">ty</span>
    <span class="n">term</span> <span class="o">=</span> <span class="n">small</span><span class="o">.</span><span class="n">term</span>
    <span class="p">}</span>

<span class="n">let</span> <span class="n">package_env_defaultWDiffPrepass</span> <span class="n">default_env</span> <span class="o">=</span> <span class="p">{</span> <span class="n">package_env_emptyWDiffPrepass</span> <span class="k">with</span> <span class="n">ty</span> <span class="o">=</span> <span class="p">(</span><span class="n">top_env_defaultPrepass</span> <span class="n">default_env</span><span class="p">)</span><span class="o">.</span><span class="n">ty</span> <span class="p">}</span>

<span class="nb">type</span> <span class="n">ProjStatePrepass</span> <span class="o">=</span> <span class="n">ProjState</span><span class="o">&lt;</span><span class="n">PrepassState</span><span class="p">,</span><span class="n">PrepassStatePropagated</span><span class="p">,</span><span class="n">PrepassPackageEnv</span> <span class="n">Promise</span><span class="o">&gt;</span>
<span class="n">let</span> <span class="n">funs_proj_package_prepass</span> <span class="o">=</span> <span class="p">{</span><span class="n">new</span> <span class="n">ProjPackageFuns</span><span class="o">&lt;</span><span class="n">PrepassStatePropagated</span><span class="p">,</span><span class="n">PrepassPackageEnv</span> <span class="n">Promise</span><span class="o">&gt;</span> <span class="k">with</span>
    <span class="n">member</span> <span class="n">funs</span><span class="o">.</span><span class="n">unions</span> <span class="n">default_env</span> <span class="n">l</span> <span class="o">=</span> 
        <span class="n">let</span> <span class="n">f</span> <span class="o">=</span> <span class="n">function</span> <span class="n">Some</span> <span class="n">name</span><span class="p">,</span> <span class="n">small</span> <span class="o">-&gt;</span> <span class="n">funs</span><span class="o">.</span><span class="n">in_module</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">small</span><span class="p">)</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">small</span> <span class="o">-&gt;</span> <span class="n">small</span>
        <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">big</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">funs</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">f</span> <span class="n">x</span><span class="p">,</span><span class="n">big</span><span class="p">))</span> <span class="p">(</span><span class="n">funs</span><span class="o">.</span><span class="n">default</span><span class="s1">' default_env) l</span>
    <span class="n">member</span> <span class="n">_</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">small</span><span class="p">,</span><span class="n">big</span><span class="p">)</span> <span class="o">=</span> 
        <span class="n">Job</span><span class="o">.</span><span class="n">delay</span> <span class="o">&lt;|</span> <span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span>
            <span class="n">Hopac</span><span class="o">.</span><span class="n">queueIgnore</span> <span class="n">big</span>
            <span class="n">small</span> <span class="o">&gt;&gt;=</span> <span class="n">fun</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">big</span> <span class="o">&gt;&gt;-</span> <span class="n">unionWDiffPrepass</span> <span class="n">a</span>
        <span class="o">|&gt;</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">memo</span>
    <span class="n">member</span> <span class="n">_</span><span class="o">.</span><span class="n">in_module</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&gt;&gt;-*</span> <span class="n">fun</span> <span class="n">env</span> <span class="o">-&gt;</span> <span class="n">in_module</span> <span class="n">name</span> <span class="n">env</span>
    <span class="n">member</span> <span class="n">_</span><span class="o">.</span><span class="n">package_to_file</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&gt;&gt;-*</span> <span class="n">package_to_fileWDiffPrepass</span>
    <span class="n">member</span> <span class="n">_</span><span class="o">.</span><span class="n">add_file_to_package</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">=</span> 
        <span class="n">a</span> <span class="o">&gt;&gt;=*</span> <span class="n">fun</span> <span class="n">env</span> <span class="o">-&gt;</span>
        <span class="n">b</span> <span class="o">&gt;&gt;-*</span> <span class="n">add_file_to_packageWDiffPrepass</span> <span class="n">pid</span> <span class="n">env</span>
    <span class="n">member</span> <span class="n">_</span><span class="o">.</span><span class="n">default</span><span class="s1">' default_env = Promise.Now.withValue (package_env_defaultWDiffPrepass default_env)</span>
    <span class="n">member</span> <span class="n">_</span><span class="o">.</span><span class="n">empty</span> <span class="o">=</span> <span class="n">Promise</span><span class="o">.</span><span class="n">Now</span><span class="o">.</span><span class="n">withValue</span> <span class="n">package_env_emptyWDiffPrepass</span>
    <span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=63">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="SpiProj">SpiProj<a class="anchor-link" href="#SpiProj"></a></h2>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=64">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1">#r @"../../../../../../../.nuget/packages/fsharp.control.asyncseq/3.2.1/lib/netstandard2.1/FSharp.Control.AsyncSeq.dll"</span>
<span class="c1">#r @"../../../../../../../.nuget/packages/system.reactive/6.0.1-preview.1/lib/net6.0/System.Reactive.dll"</span>
<span class="c1">#r @"../../../../../../../.nuget/packages/system.reactive.linq/6.0.1-preview.1/lib/netstandard2.0/System.Reactive.Linq.dll"</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=65">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="ch">#!import ../../../polyglot/lib/fsharp/CommonFSharp.fs</span>
<span class="c1">#!import ../../../polyglot/lib/fsharp/Async.fs</span>
<span class="c1">#!import ../../../polyglot/lib/fsharp/AsyncSeq.fs</span>
<span class="c1">#!import ../../../polyglot/lib/fsharp/Runtime.fs</span>
<span class="c1">#!import ../../../polyglot/lib/fsharp/FileSystem.fs</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=66">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="o">//</span> <span class="n">Everything</span> <span class="n">that</span> <span class="n">deals</span> <span class="k">with</span> <span class="n">Spiral</span> <span class="n">project</span> <span class="n">files</span> <span class="n">themselves</span> <span class="n">goes</span> <span class="n">here</span>
<span class="nb">open</span> <span class="n">FParsec</span>

<span class="o">//</span> <span class="nb">open</span> <span class="n">Common</span>


<span class="nb">type</span> <span class="n">RawFileHierarchy</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">Directory</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">RString</span> <span class="o">*</span> <span class="n">RawFileHierarchy</span> <span class="nb">list</span>
    <span class="o">|</span> <span class="n">File</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">RString</span> <span class="o">*</span> <span class="n">is_top_down</span> <span class="p">:</span> <span class="nb">bool</span> <span class="o">*</span> <span class="n">is_include</span> <span class="p">:</span> <span class="nb">bool</span>
<span class="nb">type</span> <span class="n">ConfigResumableError</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">DuplicateFiles</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="p">[]</span> <span class="p">[]</span>
    <span class="o">|</span> <span class="n">DuplicateRecordFields</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="p">[]</span> <span class="p">[]</span>
    <span class="o">|</span> <span class="n">MissingNecessaryRecordFields</span> <span class="n">of</span> <span class="n">string</span> <span class="p">[]</span> <span class="o">*</span> <span class="n">VSCRange</span>
<span class="nb">type</span> <span class="n">ConfigFatalError</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">Tabs</span> <span class="n">of</span> <span class="n">VSCRange</span> <span class="p">[]</span>
    <span class="o">|</span> <span class="n">ParserError</span> <span class="n">of</span> <span class="n">string</span> <span class="o">*</span> <span class="n">VSCRange</span>
<span class="n">exception</span> <span class="n">ConfigException</span> <span class="n">of</span> <span class="n">ConfigFatalError</span>

<span class="n">let</span> <span class="n">rec</span> <span class="n">spaces_template</span> <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">spaces</span> <span class="o">&gt;&gt;.</span> <span class="n">optional</span> <span class="p">(</span><span class="n">followedByString</span> <span class="s2">"//"</span> <span class="o">&gt;&gt;.</span> <span class="n">skipRestOfLine</span> <span class="n">true</span> <span class="o">&gt;&gt;.</span> <span class="n">spaces_template</span><span class="p">))</span> <span class="n">s</span>
<span class="n">let</span> <span class="n">spacesSpiProj</span> <span class="n">s</span> <span class="o">=</span> <span class="n">spaces_template</span> <span class="n">s</span>

<span class="n">let</span> <span class="k">raise</span><span class="s1">' x = raise (ConfigException x)</span>
<span class="n">let</span> <span class="n">raise_if_not_empty</span> <span class="n">exn</span> <span class="n">l</span> <span class="o">=</span> <span class="k">if</span> <span class="n">Array</span><span class="o">.</span><span class="n">isEmpty</span> <span class="n">l</span> <span class="o">=</span> <span class="n">false</span> <span class="n">then</span> <span class="k">raise</span><span class="s1">' (exn l)</span>
<span class="n">let</span> <span class="n">add_to_exception_list</span><span class="s1">' (p: CharStream&lt;ResizeArray&lt;ConfigResumableError&gt;&gt;) = p.State.UserState.Add</span>
<span class="n">let</span> <span class="n">add_to_exception_list</span> <span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="n">CharStream</span><span class="o">&lt;</span><span class="n">ResizeArray</span><span class="o">&lt;</span><span class="n">ConfigResumableError</span><span class="o">&gt;&gt;</span><span class="p">)</span> <span class="n">exn</span> <span class="n">l</span> <span class="o">=</span> <span class="k">if</span> <span class="n">Array</span><span class="o">.</span><span class="n">isEmpty</span> <span class="n">l</span> <span class="o">=</span> <span class="n">false</span> <span class="n">then</span> <span class="n">p</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">UserState</span><span class="o">.</span><span class="n">Add</span> <span class="p">(</span><span class="n">exn</span> <span class="n">l</span><span class="p">)</span>
<span class="n">let</span> <span class="n">column</span> <span class="p">(</span><span class="n">p</span> <span class="p">:</span> <span class="n">CharStream</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">Column</span>
<span class="n">let</span> <span class="n">pos</span> <span class="p">(</span><span class="n">p</span> <span class="p">:</span> <span class="n">CharStream</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">:</span> <span class="n">VSCPos</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span><span class="n">line</span><span class="o">=</span><span class="nb">int</span> <span class="n">p</span><span class="o">.</span><span class="n">Line</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">character</span><span class="o">=</span><span class="nb">int</span> <span class="n">p</span><span class="o">.</span><span class="n">Column</span> <span class="o">-</span> <span class="mi">1</span><span class="o">|</span><span class="p">}</span>
<span class="n">let</span> <span class="n">pos</span><span class="s1">' p = Reply(pos p)</span>
<span class="n">let</span> <span class="n">rangeSpiProj</span> <span class="n">f</span> <span class="n">p</span> <span class="o">=</span> <span class="n">pipe3</span> <span class="n">pos</span><span class="s1">' f pos'</span> <span class="p">(</span><span class="n">fun</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span> <span class="o">-&gt;</span> <span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="p">:</span> <span class="n">VSCRange</span><span class="p">),</span> <span class="n">b</span><span class="p">)</span> <span class="n">p</span>

<span class="n">let</span> <span class="n">is_small_var_char_startingSpiProj</span> <span class="n">c</span> <span class="o">=</span> <span class="n">isAsciiLower</span> <span class="n">c</span>
<span class="n">let</span> <span class="n">is_var_charSpiProj</span> <span class="n">c</span> <span class="o">=</span> <span class="n">isAsciiLetter</span> <span class="n">c</span> <span class="o">||</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">'_'</span> <span class="o">||</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">''' || isDigit c</span>
<span class="s1">let file' p = many1Satisfy2L is_small_var_char_startingSpiProj is_var_charSpiProj "lowercase variable name" p</span>
<span class="s1">let fileSpiProj p = (rangeSpiProj file' .&gt;&gt; spacesSpiProj) p</span>
<span class="s1">let file_verify p = (skipMany1Satisfy2L is_small_var_char_startingSpiProj is_var_charSpiProj "lowercase variable name" .&gt;&gt; spacesSpiProj .&gt;&gt; eof) p</span>

<span class="s1">let rec file_hierarchy p =</span>
<span class="s1">    let i = column p</span>
<span class="s1">    let expr p = if i = column p then file_or_directory p else Reply(ReplyStatus.Error,expected "file or directory on the same or greater indentation as the first one")</span>
<span class="s1">    (many expr |&gt;&gt; fun l -&gt;</span>
<span class="s1">        let _ = </span>
<span class="s1">            l |&gt; List.toArray</span>
<span class="s1">            |&gt; Array.choose (function | File(_,(a,b),_,_) -&gt; Some (b,a) | _ -&gt; None)</span>
<span class="s1">            |&gt; Array.groupBy fst</span>
<span class="s1">            |&gt; Array.choose (fun (a,b) -&gt; if b.Length &gt; 1 then Some (Array.map snd b) else None)</span>
<span class="s1">            |&gt; add_to_exception_list p DuplicateFiles</span>
<span class="s1">        l</span>
<span class="s1">        ) p</span>

<span class="s1">and file_or_directory p =</span>
<span class="s1">    let i = column p</span>
<span class="s1">    let file_hierarchy p = if i &lt; column p then file_hierarchy p else Reply([])</span>
<span class="s1">    (rangeSpiProj (rangeSpiProj file' &gt;&gt;= fun (r,name) p -&gt;</span>
<span class="s1">        let adjust_range ((a,b) : VSCRange) : VSCRange = if b.character &lt; a.character then a,{|line=b.line-1; character=System.Int32.MaxValue|} else a,b</span>
<span class="s1">        let x = p.Peek2()</span>
<span class="s1">        match x.Char0, x.Char1 with</span>
<span class="s1">        | '/',_ -&gt; p.Skip(); (spacesSpiProj &gt;&gt;. file_hierarchy |&gt;&gt; fun files r' -&gt; Directory(adjust_range r',(r,name),files)) p</span>
<span class="s1">        | '-',_ -&gt; p.Skip(); (spacesSpiProj &gt;&gt;</span><span class="si">% f</span><span class="s1">un r' -&gt; File(adjust_range r',(r,name),true,true)) p</span>
<span class="s1">        | '*','-' -&gt; p.Skip(2); (spacesSpiProj &gt;&gt;</span><span class="si">% f</span><span class="s1">un r' -&gt; File(adjust_range r',(r,name),false,true)) p</span>
<span class="s1">        | '*',_ -&gt; p.Skip(); (spacesSpiProj &gt;&gt;</span><span class="si">% f</span><span class="s1">un r' -&gt; File(adjust_range r',(r,name),false,false)) p</span>
<span class="s1">        | _ -&gt; (spacesSpiProj &gt;&gt;</span><span class="si">% f</span><span class="s1">un r' -&gt; File(adjust_range r',(r,name),true,false)) p</span>
<span class="s1">        )</span>
<span class="s1">    |&gt;&gt; fun (r',f) -&gt; f r') p</span>

<span class="s1">type RawSchemaPackages = {range : VSCRange; name : string; is_in_compiler_dir : bool; is_include : bool}</span>
<span class="s1">let packages p =</span>
<span class="s1">    let i = column p</span>
<span class="s1">    let file = rangeSpiProj (((skipChar '|' &gt;&gt;% true) &lt;|&gt;</span><span class="si">% f</span><span class="s1">alse) .&gt;&gt;.  file') &gt;&gt;= fun (r,(is_in_compiler_dir,name)) p -&gt;</span>
<span class="s1">        match p.Peek() with</span>
<span class="s1">        | '-' -&gt; p.Skip(); (spacesSpiProj &gt;&gt;% {range=r; name=name; is_in_compiler_dir=is_in_compiler_dir; is_include=true}) p</span>
<span class="s1">        | _ -&gt; (spacesSpiProj &gt;&gt;% {range=r; name=name; is_in_compiler_dir=is_in_compiler_dir; is_include=false}) p</span>
<span class="s1">    let file p = if i &lt;= column p then file p else Reply(ReplyStatus.Error,expected "directory on the same or greater indentation as the first one")</span>
<span class="s1">    many file p</span>

<span class="s1">let tab_positions (str : string): VSCRange [] =</span>
<span class="s1">    let mutable line = -1</span>
<span class="s1">    lines str |&gt; Array.choose (fun x -&gt; </span>
<span class="s1">        line &lt;- line + 1</span>
<span class="s1">        let x = {|line=line; character=x.IndexOf("</span><span class="se">\t</span><span class="s1">")|}</span>
<span class="s1">        if x.character &lt;&gt; -1 then Some(x,{|x with character=x.character+1|}) else None</span>
<span class="s1">        )</span>

<span class="s1">let record_reduce (field: Parser&lt;'schema -&gt; 'schema, _&gt;) s p =</span>
<span class="s1">    let record_body p =</span>
<span class="s1">        let i = column p</span>
<span class="s1">        let indent expr p = if i = column p then expr p else Reply(ReplyStatus.Error,expected "record field on the same indentation as the first one")</span>
<span class="s1">        many (indent field) p</span>
<span class="s1">    (rangeSpiProj record_body |&gt;&gt; fun (r,l) -&gt; r, List.fold (|&gt;) s l) p</span>

<span class="s1">let record_field (name, p) = </span>
<span class="s1">    (skipString name &gt;&gt;. skipChar ':' &gt;&gt;. spacesSpiProj &gt;&gt;. rangeSpiProj p)</span>
<span class="s1">    |&gt;&gt; (fun (r,f) (s,l) -&gt; f s, (r, name) :: l)</span>

<span class="s1">let record fields fields_necessary schema =</span>
<span class="s1">    let fields = choice (List.map record_field fields)</span>
<span class="s1">    record_reduce fields (schema, []) &gt;&gt;= fun (range,(schema,l)) p -&gt;</span>
<span class="s1">        let l = List.toArray l</span>
<span class="s1">        let _ =</span>
<span class="s1">            let names = Array.map snd l</span>
<span class="s1">            Set fields_necessary - Set names</span>
<span class="s1">            |&gt; Set.toArray</span>
<span class="s1">            |&gt; add_to_exception_list p (fun fields -&gt; MissingNecessaryRecordFields(fields,range))</span>
<span class="s1">        let _ =</span>
<span class="s1">            Array.groupBy snd l</span>
<span class="s1">            |&gt; Array.choose (fun (k, v) -&gt; if v.Length &gt; 1 then Some (Array.map fst v) else None)</span>
<span class="s1">            |&gt; add_to_exception_list p DuplicateRecordFields</span>

<span class="s1">        Reply(schema)</span>

<span class="s1">type RawSchema = {</span>
<span class="s1">    name : RString option</span>
<span class="s1">    version : RString option</span>
<span class="s1">    moduleDir : RString option</span>
<span class="s1">    modules : RawFileHierarchy list</span>
<span class="s1">    packageDir : RString option</span>
<span class="s1">    packages : RawSchemaPackages list</span>
<span class="s1">    }</span>

<span class="s1">let schema_def: RawSchema = {</span>
<span class="s1">    name=None</span>
<span class="s1">    version=None</span>
<span class="s1">    moduleDir=None</span>
<span class="s1">    modules=[]</span>
<span class="s1">    packageDir=None</span>
<span class="s1">    packages=[]</span>
<span class="s1">    }</span>

<span class="s1">type ConfigError = ResumableError of ConfigResumableError [] | FatalError of ConfigFatalError</span>

<span class="s1">open System.IO</span>
<span class="s1">let config text =</span>
<span class="s1">    try </span>
<span class="s1">        let _ = tab_positions text |&gt; raise_if_not_empty Tabs</span>
<span class="s1">        </span>
<span class="s1">        let directory p = (rangeSpiProj (restOfLine false) .&gt;&gt; spacesSpiProj |&gt;&gt; fun (r,x) -&gt; Some(r,x.Trim())) p</span>

<span class="s1">        let fields = [</span>
<span class="s1">            "version", rangeSpiProj (restOfLine true .&gt;&gt; spacesSpiProj) |&gt;&gt; fun (r,x) s -&gt; {s with version=Some (r,x.TrimEnd())}</span>
<span class="s1">            "name", fileSpiProj |&gt;&gt; fun x s -&gt; {s with name=Some x}</span>
<span class="s1">            "moduleDir", directory |&gt;&gt; fun x s -&gt; {s with moduleDir=x}</span>
<span class="s1">            "modules", file_hierarchy |&gt;&gt; fun x s -&gt; {s with modules=x}</span>
<span class="s1">            "packageDir", directory |&gt;&gt; fun x s -&gt; {s with packageDir=x}</span>
<span class="s1">            "packages", packages |&gt;&gt; fun x s -&gt; {s with packages=x}</span>
<span class="s1">            ]</span>
<span class="s1">        let necessary = []</span>

<span class="s1">        match runParserOnString (spacesSpiProj &gt;&gt;. record fields necessary schema_def .&gt;&gt; eof) (ResizeArray()) "spiral.config" text with</span>
<span class="s1">        | Success(a,userstate,_) -&gt; </span>
<span class="s1">            if userstate.Count &gt; 0 then userstate.ToArray() |&gt; ResumableError |&gt; Result.Error else Result.Ok a</span>
<span class="s1">        | Failure(messages,error,_) -&gt;</span>
<span class="s1">            let x = {|line=int error.Position.Line - 1; character=int error.Position.Column - 1|}</span>
<span class="s1">            ParserError(messages, (x,{|x with character=x.character+1|})) |&gt; FatalError |&gt; Result.Error</span>
<span class="s1">    with </span>
<span class="s1">        | :? ConfigException as e -&gt; e.Data0 |&gt; FatalError |&gt; Result.Error</span>

<span class="s1">    |&gt; Result.mapError (fun x -&gt;</span>
<span class="s1">        let fatal_error = function</span>
<span class="s1">            | Tabs l -&gt; l |&gt; Array.map (fun r -&gt; r, "Tab not allowed.")</span>
<span class="s1">            | ParserError(x,r) -&gt; [|r, (lines x).[3..] |&gt; String.concat "</span><span class="se">\n</span><span class="s1">"|]</span>
<span class="s1">        let inline duplicate er = Array.collect (fun l -&gt; let er = er (Array.length l) in Array.map (fun r -&gt; r, er) l)</span>
<span class="s1">        let resumable_error = function</span>
<span class="s1">            | DuplicateFiles l -&gt; duplicate (sprintf "Duplicate name. Count: </span><span class="si">%i</span><span class="s1">") l</span>
<span class="s1">            | DuplicateRecordFields l -&gt; duplicate (sprintf "Duplicate record field. Count: </span><span class="si">%i</span><span class="s1">") l</span>
<span class="s1">            | MissingNecessaryRecordFields (l,r) -&gt; [|r, sprintf "Record is missing the fields: </span><span class="si">%s</span><span class="s1">" (String.concat ", " l)|]</span>
<span class="s1">        match x with</span>
<span class="s1">        | ResumableError x -&gt; Array.collect resumable_error x</span>
<span class="s1">        | FatalError x -&gt; fatal_error x</span>
<span class="s1">        |&gt; Array.toList</span>
<span class="s1">        )</span>

<span class="s1">type FileHierarchy =</span>
<span class="s1">    | Directory of VSCRange * path: RString * name : string * FileHierarchy list</span>
<span class="s1">    | File of VSCRange * path: RString * string option</span>
<span class="s1">type SchemaPackages = {dir : RString; name : string option}</span>
<span class="s1">type Schema = {</span>
<span class="s1">    moduleDir : VSCRange option * string</span>
<span class="s1">    modules : FileHierarchy list</span>
<span class="s1">    packageDir : VSCRange option * string </span>
<span class="s1">    packages : SchemaPackages list</span>
<span class="s1">    }</span>

<span class="s1">exception SchemaException of RString</span>
<span class="s1">type SchemaResult = Result&lt;Schema,RString list&gt;</span>
<span class="s1">let schema (pdir,text) : SchemaResult = config text |&gt; Result.bind (fun x -&gt;</span>
<span class="s1">    try</span>
<span class="s1">        let combine a (r,b) =</span>
<span class="s1">            try</span>
<span class="s1">                Path.Combine(a,b)</span>
<span class="s1">                |&gt; Path.GetFullPath</span>
<span class="s1">                |&gt; fun result -&gt;</span>
<span class="s1">                    let result' = result |&gt; SpiralFileSystem.standardize_path</span>
<span class="s1">                    // trace Verbose (fun () -&gt; $"""SpiProj.schema.combine / a: </span><span class="si">{a}</span><span class="s1"> / b: </span><span class="si">{b}</span><span class="s1"> / result: {result |&gt; SpiralSm.replace "</span><span class="se">\\</span><span class="s1">" "|"} / result': {result'}""") _locals</span>
<span class="s1">                    result'</span>
<span class="s1">            with e -&gt;</span>
<span class="s1">                raise (SchemaException(r,e.Message))</span>
<span class="s1">        let module_dir =</span>
<span class="s1">            match x.moduleDir with</span>
<span class="s1">            | Some(r,_ as x) -&gt; Some r, combine pdir x</span>
<span class="s1">            | None -&gt; None, pdir</span>
<span class="s1">        let package_dir = </span>
<span class="s1">            match x.packageDir with</span>
<span class="s1">            | Some(r,_ as x) -&gt; Some r, combine pdir x</span>
<span class="s1">            | None -&gt; None, Path.Combine(pdir,"..") |&gt; Path.GetFullPath</span>
<span class="s1">        // trace Verbose (fun () -&gt; $"""SpiProj.schema / pdir: </span><span class="si">{pdir}</span><span class="s1"> / module_dir: {module_dir |&gt; snd} / package_dir: {package_dir |&gt; snd |&gt; SpiralSm.replace "</span><span class="se">\\</span><span class="s1">" "|"}""") _locals</span>
<span class="s1">        let modules =</span>
<span class="s1">            let rec loop prefix = function</span>
<span class="s1">                | RawFileHierarchy.Directory(r,(r',a),l) -&gt; </span>
<span class="s1">                    let prefix = Path.Combine(prefix,a)</span>
<span class="s1">                    let prefix' = prefix |&gt; SpiralFileSystem.standardize_path</span>
<span class="s1">                    trace Verbose (fun () -&gt; $"SpiProj.schema.modules.loop | RawFileHierarchy.Directory(r,(r',a),l) / prefix: </span><span class="si">{prefix}</span><span class="s1"> / prefix': {prefix'}") _locals</span>
<span class="s1">                    let prefix = prefix'</span>
<span class="s1">                    Directory(r,(r',prefix),a,List.map (loop prefix) l)</span>
<span class="s1">                | RawFileHierarchy.File(r,(r',a),is_top_down,is_include) -&gt;</span>
<span class="s1">                    let path = Path.Combine(prefix,a + if is_top_down then ".spi" else ".spir")</span>
<span class="s1">                    let path' = path |&gt; SpiralFileSystem.standardize_path</span>
<span class="s1">                    // trace Verbose (fun () -&gt; $"SpiProj.schema.modules.loop | RawFileHierarchy.File(r,(r',a),is_top_down,is_include) / path: </span><span class="si">{path}</span><span class="s1"> / path': {path'}") _locals</span>
<span class="s1">                    let path = path'</span>
<span class="s1">                    File(r,(r',path),if is_include then None else Some a)</span>
<span class="s1">            List.map (loop (snd module_dir)) x.modules</span>
<span class="s1">        let packages =</span>
<span class="s1">            let cdir =</span>
<span class="s1">#if !INTERACTIVE</span>
<span class="s1">                // Path.Combine(System.AppDomain.CurrentDomain.BaseDirectory,"..")</span>
<span class="s1">                Path.Combine (SpiralFileSystem.get_workspace_root (), "deps/The-Spiral-Language/VS Code Plugin")</span>
<span class="s1">#else</span>
<span class="s1">                Path.Combine (SpiralFileSystem.get_workspace_root (), "deps/The-Spiral-Language/VS Code Plugin")</span>
<span class="s1">#endif</span>
<span class="s1">                |&gt; Path.GetFullPath</span>
<span class="s1">            x.packages |&gt; List.map (fun x -&gt;</span>
<span class="s1">                let name = if x.is_include then None else Some x.name</span>
<span class="s1">                let dir = Path.Combine((if x.is_in_compiler_dir then cdir else snd package_dir),x.name)</span>
<span class="s1">                let dir' = dir |&gt; SpiralFileSystem.standardize_path</span>
<span class="s1">                let dir'' = dir' |&gt; SpiralFileSystem.standardize_path</span>
<span class="s1">                trace Verbose (fun () -&gt; $"""SpiProj.schema.packages / dir: {dir |&gt; SpiralSm.replace "</span><span class="se">\\</span><span class="s1">" "|"} / dir': {dir'} / dir'': {dir''}""") _locals</span>
<span class="s1">                let dir = dir''</span>
<span class="s1">                {name = name; dir = x.range, dir}</span>
<span class="s1">                )</span>
<span class="s1">        Result.Ok {moduleDir = module_dir; modules = modules; packageDir = package_dir; packages = packages}</span>
<span class="s1">    with :? SchemaException as e -&gt; Result.Error [e.Data0]</span>
<span class="s1">    )</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=67">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="Graph">Graph<a class="anchor-link" href="#Graph"></a></h2>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=68">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="nb">open</span> <span class="n">System</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">Generic</span>

<span class="nb">type</span> <span class="n">Graph</span> <span class="o">=</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="n">string</span> <span class="n">Set</span><span class="o">&gt;</span>
<span class="nb">type</span> <span class="n">MirroredGraph</span> <span class="o">=</span> <span class="n">Graph</span> <span class="o">*</span> <span class="n">Graph</span>

<span class="n">let</span> <span class="n">mirrored_graph_empty</span> <span class="p">:</span> <span class="n">MirroredGraph</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">,</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>

<span class="n">let</span> <span class="n">link_add</span><span class="s1">' (abs : Graph) a b: Graph = </span>
    <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">a</span> <span class="nb">abs</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">Some</span> <span class="n">bs</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">a</span> <span class="p">(</span><span class="n">Set</span><span class="o">.</span><span class="n">add</span> <span class="n">b</span> <span class="n">bs</span><span class="p">)</span> <span class="nb">abs</span>
    <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">a</span> <span class="p">(</span><span class="n">Set</span><span class="o">.</span><span class="n">singleton</span> <span class="n">b</span><span class="p">)</span> <span class="nb">abs</span>
<span class="n">let</span> <span class="n">link_add</span> <span class="p">(</span><span class="n">s</span> <span class="p">:</span> <span class="n">MirroredGraph</span><span class="p">)</span> <span class="n">a</span> <span class="n">b</span><span class="p">:</span> <span class="n">MirroredGraph</span> <span class="o">=</span> <span class="n">link_add</span><span class="s1">' (fst s) a b, link_add'</span> <span class="p">(</span><span class="n">snd</span> <span class="n">s</span><span class="p">)</span> <span class="n">b</span> <span class="n">a</span>

<span class="n">let</span> <span class="n">link_remove</span><span class="s1">' (abs : Graph) a b = </span>
    <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">a</span> <span class="nb">abs</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">Some</span> <span class="n">bs</span> <span class="o">-&gt;</span> 
        <span class="n">let</span> <span class="n">bs</span> <span class="o">=</span> <span class="n">Set</span><span class="o">.</span><span class="n">remove</span> <span class="n">b</span> <span class="n">bs</span>
        <span class="k">if</span> <span class="n">Set</span><span class="o">.</span><span class="n">isEmpty</span> <span class="n">bs</span> <span class="n">then</span> <span class="n">Map</span><span class="o">.</span><span class="n">remove</span> <span class="n">a</span> <span class="nb">abs</span> <span class="k">else</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">a</span> <span class="n">bs</span> <span class="nb">abs</span>
    <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="nb">abs</span>
<span class="n">let</span> <span class="n">link_remove</span> <span class="p">(</span><span class="n">s</span> <span class="p">:</span> <span class="n">MirroredGraph</span><span class="p">)</span> <span class="n">a</span> <span class="n">b</span><span class="p">:</span> <span class="n">MirroredGraph</span> <span class="o">=</span> <span class="n">link_remove</span><span class="s1">' (fst s) a b, link_remove'</span> <span class="p">(</span><span class="n">snd</span> <span class="n">s</span><span class="p">)</span> <span class="n">b</span> <span class="n">a</span>

<span class="n">let</span> <span class="n">links_remove</span> <span class="p">((</span><span class="nb">abs</span><span class="p">,</span><span class="n">bas</span> <span class="k">as</span> <span class="n">s</span><span class="p">)</span> <span class="p">:</span> <span class="n">MirroredGraph</span><span class="p">)</span> <span class="n">a</span><span class="p">:</span> <span class="n">MirroredGraph</span> <span class="o">=</span> 
    <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">a</span> <span class="nb">abs</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">Some</span> <span class="n">bs</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">remove</span> <span class="n">a</span> <span class="nb">abs</span><span class="p">,</span> <span class="n">Set</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">bas</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">link_remove</span><span class="s1">' bas b a) bas bs</span>
    <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">s</span>
<span class="n">let</span> <span class="n">links_add</span> <span class="n">s</span> <span class="n">a</span> <span class="n">bs</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">link_add</span> <span class="n">s</span> <span class="n">a</span> <span class="n">b</span><span class="p">)</span> <span class="n">s</span> <span class="n">bs</span>
<span class="n">let</span> <span class="n">links_replace</span> <span class="p">(</span><span class="n">s</span> <span class="p">:</span> <span class="n">MirroredGraph</span><span class="p">)</span> <span class="n">a</span> <span class="n">bs</span> <span class="o">=</span> <span class="n">links_add</span> <span class="p">(</span><span class="n">links_remove</span> <span class="n">s</span> <span class="n">a</span><span class="p">)</span> <span class="n">a</span> <span class="n">bs</span>
<span class="n">let</span> <span class="n">links_get</span> <span class="p">(</span><span class="nb">abs</span> <span class="p">:</span> <span class="n">Graph</span><span class="p">)</span> <span class="n">a</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">a</span> <span class="nb">abs</span> <span class="o">|&gt;</span> <span class="n">Option</span><span class="o">.</span><span class="n">defaultValue</span> <span class="n">Set</span><span class="o">.</span><span class="n">empty</span>
<span class="n">let</span> <span class="n">link_exists</span> <span class="p">((</span><span class="nb">abs</span><span class="p">,</span><span class="n">bas</span><span class="p">)</span> <span class="p">:</span> <span class="n">MirroredGraph</span><span class="p">)</span> <span class="n">x</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">containsKey</span> <span class="n">x</span> <span class="nb">abs</span> <span class="o">||</span> <span class="n">Map</span><span class="o">.</span><span class="n">containsKey</span> <span class="n">x</span> <span class="n">bas</span>

<span class="n">let</span> <span class="n">inline</span> <span class="n">topological_sort_template</span> <span class="n">add</span> <span class="n">bas</span> <span class="n">dirty_nodes</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">sort_visited</span> <span class="o">=</span> <span class="n">HashSet</span><span class="p">()</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">dfs_rev</span> <span class="n">a</span> <span class="o">=</span> <span class="k">if</span> <span class="n">sort_visited</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="n">then</span> <span class="n">Seq</span><span class="o">.</span><span class="n">iter</span> <span class="n">dfs_rev</span> <span class="p">(</span><span class="n">links_get</span> <span class="n">bas</span> <span class="n">a</span><span class="p">);</span> <span class="n">add</span> <span class="n">a</span>
    <span class="n">Seq</span><span class="o">.</span><span class="n">iter</span> <span class="n">dfs_rev</span> <span class="n">dirty_nodes</span>
    <span class="n">sort_visited</span>

<span class="o">//</span> <span class="n">Returns</span> <span class="n">the</span> <span class="n">order</span> <span class="n">end</span> <span class="o">-&gt;</span> <span class="n">mid</span> <span class="o">-&gt;</span> <span class="n">start</span><span class="o">.</span>
<span class="n">let</span> <span class="n">topological_sort</span><span class="s1">' bas start_nodes = let sort_order = Queue() in sort_order, topological_sort_template sort_order.Enqueue bas start_nodes</span>
<span class="o">//</span> <span class="n">Returns</span> <span class="n">the</span> <span class="n">order</span> <span class="n">start</span> <span class="o">-&gt;</span> <span class="n">mid</span> <span class="o">-&gt;</span> <span class="n">end</span><span class="o">.</span>
<span class="n">let</span> <span class="n">topological_sort</span> <span class="n">bas</span> <span class="n">start_nodes</span> <span class="o">=</span> <span class="n">let</span> <span class="n">sort_order</span> <span class="o">=</span> <span class="n">Stack</span><span class="p">()</span> <span class="ow">in</span> <span class="n">sort_order</span><span class="p">,</span> <span class="n">topological_sort_template</span> <span class="n">sort_order</span><span class="o">.</span><span class="n">Push</span> <span class="n">bas</span> <span class="n">start_nodes</span>

<span class="n">let</span> <span class="n">circular_nodes</span> <span class="p">((</span><span class="nb">abs</span><span class="p">,</span><span class="n">bas</span><span class="p">)</span> <span class="p">:</span> <span class="n">MirroredGraph</span><span class="p">)</span> <span class="n">dirty_nodes</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">sort_order</span><span class="p">,</span> <span class="n">sort_visited</span> <span class="o">=</span> <span class="n">topological_sort</span> <span class="n">bas</span> <span class="n">dirty_nodes</span>
    <span class="n">let</span> <span class="n">order</span> <span class="o">=</span> <span class="n">sort_order</span><span class="o">.</span><span class="n">ToArray</span><span class="p">()</span>
    <span class="n">let</span> <span class="n">visited</span> <span class="o">=</span> <span class="n">HashSet</span><span class="p">()</span>
    <span class="n">let</span> <span class="n">circular_nodes</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">()</span>
    <span class="n">Array</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">i</span> <span class="n">a</span> <span class="o">-&gt;</span>
        <span class="n">let</span> <span class="n">sc</span> <span class="o">=</span> <span class="n">ResizeArray</span><span class="p">()</span> <span class="o">//</span> <span class="n">This</span> <span class="n">array</span> <span class="n">stores</span> <span class="n">the</span> <span class="n">strongly</span> <span class="n">connected</span> <span class="n">components</span><span class="o">.</span>
        <span class="n">let</span> <span class="n">rec</span> <span class="n">dfs</span> <span class="n">a</span> <span class="o">=</span> <span class="k">if</span> <span class="n">sort_visited</span><span class="o">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">visited</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="n">then</span> <span class="n">Seq</span><span class="o">.</span><span class="n">iter</span> <span class="n">dfs</span> <span class="p">(</span><span class="n">links_get</span> <span class="nb">abs</span> <span class="n">a</span><span class="p">);</span> <span class="n">sc</span><span class="o">.</span><span class="n">Add</span> <span class="n">a</span>
        <span class="n">dfs</span> <span class="n">a</span>
        <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">sc</span><span class="o">.</span><span class="n">Count</span> <span class="n">then</span> 
            <span class="n">sc</span> <span class="o">|&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">circular_nodes</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">ignore</span><span class="p">)</span>
            <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">else</span> 
            <span class="n">i</span>
        <span class="p">)</span> <span class="mi">0</span> <span class="n">order</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
    <span class="n">order</span><span class="p">,</span> <span class="n">circular_nodes</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=69">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="ServerUtils">ServerUtils<a class="anchor-link" href="#ServerUtils"></a></h2>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=70">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="o">//</span> <span class="nb">open</span> <span class="n">System</span>
<span class="nb">open</span> <span class="n">System</span><span class="o">.</span><span class="n">IO</span>
<span class="nb">open</span> <span class="n">System</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">Generic</span>

<span class="o">//</span> <span class="nb">open</span> <span class="n">Common</span>


<span class="nb">type</span> <span class="n">ProjectCodeAction</span> <span class="o">=</span> 
    <span class="o">|</span> <span class="n">CreateFile</span> <span class="n">of</span> <span class="p">{</span><span class="o">|</span><span class="n">filePath</span> <span class="p">:</span> <span class="n">string</span><span class="o">|</span><span class="p">}</span>
    <span class="o">|</span> <span class="n">DeleteFile</span> <span class="n">of</span> <span class="p">{</span><span class="o">|</span><span class="nb">range</span><span class="p">:</span> <span class="n">VSCRange</span><span class="p">;</span> <span class="n">filePath</span> <span class="p">:</span> <span class="n">string</span><span class="o">|</span><span class="p">}</span> <span class="o">//</span> <span class="n">The</span> <span class="nb">range</span> <span class="n">here</span> <span class="n">includes</span> <span class="n">the</span> <span class="n">postfix</span> <span class="n">operators</span><span class="o">.</span>
    <span class="o">|</span> <span class="n">RenameFile</span> <span class="n">of</span> <span class="p">{</span><span class="o">|</span><span class="n">filePath</span> <span class="p">:</span> <span class="n">string</span><span class="p">;</span> <span class="n">target</span> <span class="p">:</span> <span class="n">string</span><span class="o">|</span><span class="p">}</span>
    <span class="o">|</span> <span class="n">CreateDirectory</span> <span class="n">of</span> <span class="p">{</span><span class="o">|</span><span class="n">dirPath</span> <span class="p">:</span> <span class="n">string</span><span class="o">|</span><span class="p">}</span>
    <span class="o">|</span> <span class="n">DeleteDirectory</span> <span class="n">of</span> <span class="p">{</span><span class="o">|</span><span class="nb">range</span><span class="p">:</span> <span class="n">VSCRange</span><span class="p">;</span> <span class="n">dirPath</span> <span class="p">:</span> <span class="n">string</span><span class="o">|</span><span class="p">}</span> <span class="o">//</span> <span class="n">The</span> <span class="nb">range</span> <span class="n">here</span> <span class="ow">is</span> <span class="k">for</span> <span class="n">the</span> <span class="n">whole</span> <span class="n">tree</span><span class="p">,</span> <span class="ow">not</span> <span class="n">just</span> <span class="n">the</span> <span class="n">code</span> <span class="n">action</span> <span class="n">activation</span><span class="o">.</span>
    <span class="o">|</span> <span class="n">RenameDirectory</span> <span class="n">of</span> <span class="p">{</span><span class="o">|</span><span class="n">dirPath</span> <span class="p">:</span> <span class="n">string</span><span class="p">;</span> <span class="n">target</span> <span class="p">:</span> <span class="n">string</span><span class="p">;</span> <span class="n">validate_as_file</span> <span class="p">:</span> <span class="nb">bool</span><span class="o">|</span><span class="p">}</span>

<span class="n">let</span> <span class="n">code_action_execute</span> <span class="n">a</span> <span class="o">=</span>
    <span class="k">try</span> <span class="n">match</span> <span class="n">a</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">CreateDirectory</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">Directory</span><span class="o">.</span><span class="n">CreateDirectory</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">dirPath</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">ignore</span><span class="p">;</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span> <span class="n">null</span>
        <span class="o">|</span> <span class="n">DeleteDirectory</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">Directory</span><span class="o">.</span><span class="n">Delete</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">dirPath</span><span class="p">,</span><span class="n">true</span><span class="p">);</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span> <span class="n">a</span><span class="o">.</span><span class="n">dirPath</span>
        <span class="o">|</span> <span class="n">RenameDirectory</span> <span class="n">a</span> <span class="o">-&gt;</span>
            <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">validate_as_file</span> <span class="n">then</span>
                <span class="k">match</span> <span class="n">FParsec</span><span class="o">.</span><span class="n">CharParsers</span><span class="o">.</span><span class="n">run</span> <span class="n">file_verify</span> <span class="n">a</span><span class="o">.</span><span class="n">target</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">FParsec</span><span class="o">.</span><span class="n">CharParsers</span><span class="o">.</span><span class="n">ParserResult</span><span class="o">.</span><span class="n">Success</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Directory</span><span class="o">.</span><span class="n">Move</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">dirPath</span><span class="p">,</span><span class="n">Path</span><span class="o">.</span><span class="n">Combine</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">dirPath</span><span class="p">,</span><span class="s2">".."</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">target</span><span class="p">));</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span> <span class="n">a</span><span class="o">.</span><span class="n">dirPath</span>
                <span class="o">|</span> <span class="n">FParsec</span><span class="o">.</span><span class="n">CharParsers</span><span class="o">.</span><span class="n">ParserResult</span><span class="o">.</span><span class="n">Failure</span><span class="p">(</span><span class="n">er</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="o">.</span><span class="n">Error</span> <span class="n">er</span>
            <span class="k">else</span>
                <span class="n">Directory</span><span class="o">.</span><span class="n">Move</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">dirPath</span><span class="p">,</span><span class="n">Path</span><span class="o">.</span><span class="n">Combine</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">dirPath</span><span class="p">,</span><span class="s2">".."</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">target</span><span class="p">));</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span> <span class="n">a</span><span class="o">.</span><span class="n">dirPath</span>
        <span class="o">|</span> <span class="n">CreateFile</span> <span class="n">a</span> <span class="o">-&gt;</span>
            <span class="k">if</span> <span class="n">File</span><span class="o">.</span><span class="n">Exists</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">filePath</span><span class="p">)</span> <span class="n">then</span> <span class="n">Result</span><span class="o">.</span><span class="n">Error</span> <span class="s2">"File already exists."</span>
            <span class="k">else</span> 
                <span class="n">Directory</span><span class="o">.</span><span class="n">GetParent</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">filePath</span><span class="p">)</span><span class="o">.</span><span class="n">Create</span><span class="p">()</span>
                <span class="n">File</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">filePath</span><span class="p">)</span><span class="o">.</span><span class="n">Dispose</span><span class="p">()</span>
                <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span> <span class="n">null</span>
        <span class="o">|</span> <span class="n">DeleteFile</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">File</span><span class="o">.</span><span class="n">Delete</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">filePath</span><span class="p">);</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span> <span class="n">a</span><span class="o">.</span><span class="n">filePath</span>
        <span class="o">|</span> <span class="n">RenameFile</span> <span class="n">a</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">FParsec</span><span class="o">.</span><span class="n">CharParsers</span><span class="o">.</span><span class="n">run</span> <span class="n">file_verify</span> <span class="n">a</span><span class="o">.</span><span class="n">target</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">FParsec</span><span class="o">.</span><span class="n">CharParsers</span><span class="o">.</span><span class="n">ParserResult</span><span class="o">.</span><span class="n">Success</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">File</span><span class="o">.</span><span class="n">Move</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">filePath</span><span class="p">,</span><span class="n">Path</span><span class="o">.</span><span class="n">Combine</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">filePath</span><span class="p">,</span><span class="s2">".."</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">target</span><span class="o">+</span><span class="n">Path</span><span class="o">.</span><span class="n">GetExtension</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">filePath</span><span class="p">)),</span><span class="n">false</span><span class="p">);</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span> <span class="n">a</span><span class="o">.</span><span class="n">filePath</span>
            <span class="o">|</span> <span class="n">FParsec</span><span class="o">.</span><span class="n">CharParsers</span><span class="o">.</span><span class="n">ParserResult</span><span class="o">.</span><span class="n">Failure</span><span class="p">(</span><span class="n">er</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="o">.</span><span class="n">Error</span> <span class="n">er</span>
    <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="o">.</span><span class="n">Error</span> <span class="n">e</span><span class="o">.</span><span class="n">Message</span>

<span class="nb">type</span> <span class="n">RAction</span> <span class="o">=</span> <span class="n">VSCRange</span> <span class="o">*</span> <span class="n">ProjectCodeAction</span>

<span class="nb">type</span> <span class="n">SchemaState</span> <span class="o">=</span> <span class="p">{</span> <span class="n">schema</span> <span class="p">:</span> <span class="n">Schema</span><span class="p">;</span> <span class="n">errors_parse</span> <span class="p">:</span> <span class="n">RString</span> <span class="nb">list</span><span class="p">;</span> <span class="n">errors_modules</span> <span class="p">:</span> <span class="n">RString</span> <span class="nb">list</span><span class="p">;</span> <span class="n">errors_packages</span> <span class="p">:</span> <span class="n">RString</span> <span class="nb">list</span><span class="p">}</span>
<span class="nb">type</span> <span class="n">SchemaEnv</span> <span class="o">=</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="n">SchemaState</span><span class="o">&gt;</span>
<span class="nb">type</span> <span class="n">ModuleEnv</span> <span class="o">=</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="n">ModuleState</span><span class="o">&gt;</span>

<span class="n">let</span> <span class="n">ss_empty</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">schema</span> <span class="o">=</span> <span class="p">{</span><span class="n">moduleDir</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">null</span><span class="p">;</span> <span class="n">modules</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">packageDir</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">null</span><span class="p">;</span> <span class="n">packages</span> <span class="o">=</span> <span class="p">[]}</span>
    <span class="n">errors_parse</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">errors_modules</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">errors_packages</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="p">}</span>
<span class="n">let</span> <span class="n">ss_from_result</span> <span class="o">=</span> <span class="n">function</span>
    <span class="o">|</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span> <span class="n">schema</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">ss_empty</span> <span class="k">with</span> <span class="n">schema</span> <span class="o">=</span> <span class="n">schema</span><span class="p">}</span>
    <span class="o">|</span> <span class="n">Result</span><span class="o">.</span><span class="n">Error</span> <span class="n">ers</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">ss_empty</span> <span class="k">with</span> <span class="n">errors_parse</span> <span class="o">=</span> <span class="n">ers</span><span class="p">}</span>
<span class="n">let</span> <span class="n">ss_validate_module</span> <span class="p">(</span><span class="n">packages</span> <span class="p">:</span> <span class="n">SchemaEnv</span><span class="p">)</span> <span class="p">(</span><span class="n">modules</span> <span class="p">:</span> <span class="n">ModuleEnv</span><span class="p">)</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">SchemaState</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">ResizeArray</span><span class="p">()</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="o">=</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">FileHierarchy</span><span class="o">.</span><span class="n">Directory</span><span class="p">(</span><span class="n">_</span><span class="p">,(</span><span class="n">r</span><span class="p">,</span><span class="n">path</span><span class="p">),</span><span class="n">_</span><span class="p">,</span><span class="n">l</span><span class="p">)</span> <span class="o">-&gt;</span> 
            <span class="n">trace</span> <span class="n">Verbose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"ss_validate_module / dir path: </span><span class="si">{path}</span><span class="s2">"</span><span class="p">)</span> <span class="n">_locals</span>
            <span class="k">if</span> <span class="n">Map</span><span class="o">.</span><span class="n">containsKey</span> <span class="n">path</span> <span class="n">packages</span> <span class="n">then</span> <span class="n">errors</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="s2">"Module directory has a package file in it."</span><span class="p">)</span>
            <span class="nb">list</span> <span class="n">l</span>
        <span class="o">|</span> <span class="n">FileHierarchy</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">_</span><span class="p">,(</span><span class="n">r</span><span class="p">,</span><span class="n">path</span><span class="p">),</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">path</span><span class="s1">' = path |&gt; SpiralFileSystem.standardize_path</span>
            <span class="n">trace</span> <span class="n">Verbose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"ss_validate_module / file / path: </span><span class="si">{path}</span><span class="s2"> / path': {path'}"</span><span class="p">)</span> <span class="n">_locals</span>
            <span class="k">if</span> <span class="n">Map</span><span class="o">.</span><span class="n">containsKey</span> <span class="n">path</span><span class="s1">' modules = false then errors.Add(r,"Module not loaded.")</span>
    <span class="ow">and</span> <span class="nb">list</span> <span class="n">l</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="n">loop</span> <span class="n">l</span>
    <span class="nb">list</span> <span class="n">x</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">modules</span>
    <span class="n">Seq</span><span class="o">.</span><span class="n">toList</span> <span class="n">errors</span>
<span class="n">let</span> <span class="n">ss_validate_modules</span> <span class="p">(</span><span class="n">packages</span> <span class="p">:</span> <span class="n">SchemaEnv</span><span class="p">)</span> <span class="n">modules</span> <span class="n">order</span> <span class="o">=</span> 
    <span class="n">Array</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">x</span> <span class="o">-&gt;</span>
        <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">x</span> <span class="n">s</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">Some</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">x</span> <span class="p">{</span><span class="n">v</span> <span class="k">with</span> <span class="n">errors_modules</span> <span class="o">=</span> <span class="n">ss_validate_module</span> <span class="n">packages</span> <span class="n">modules</span> <span class="n">v</span><span class="p">}</span> <span class="n">s</span>
        <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">s</span>
        <span class="p">)</span> <span class="n">packages</span> <span class="n">order</span>

<span class="n">let</span> <span class="n">ss_has_error</span> <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">List</span><span class="o">.</span><span class="n">isEmpty</span> <span class="n">x</span><span class="o">.</span><span class="n">errors_parse</span> <span class="o">&amp;&amp;</span> <span class="n">List</span><span class="o">.</span><span class="n">isEmpty</span> <span class="n">x</span><span class="o">.</span><span class="n">errors_modules</span> <span class="o">&amp;&amp;</span> <span class="n">List</span><span class="o">.</span><span class="n">isEmpty</span> <span class="n">x</span><span class="o">.</span><span class="n">errors_packages</span><span class="p">)</span> <span class="o">=</span> <span class="n">false</span>
<span class="n">let</span> <span class="n">ss_validate_packages</span> <span class="p">(</span><span class="n">packages</span> <span class="p">:</span> <span class="n">SchemaEnv</span><span class="p">)</span> <span class="p">(</span><span class="n">order</span> <span class="p">:</span> <span class="n">string</span> <span class="p">[],</span> <span class="n">socs</span> <span class="p">:</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="nb">int</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">:</span> <span class="n">SchemaEnv</span> <span class="o">=</span>
    <span class="n">Array</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">path</span> <span class="o">-&gt;</span>
        <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">path</span> <span class="n">s</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">Some</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">SchemaState</span><span class="p">)</span> <span class="o">-&gt;</span> 
            <span class="n">let</span> <span class="n">c</span> <span class="n">p</span> <span class="o">=</span> <span class="n">match</span> <span class="n">socs</span><span class="o">.</span><span class="n">TryGetValue</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">with</span> <span class="n">true</span><span class="p">,</span><span class="n">b</span> <span class="o">-&gt;</span> <span class="n">b</span> <span class="o">|</span> <span class="n">false</span><span class="p">,</span><span class="n">_</span> <span class="o">-&gt;</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">let</span> <span class="n">is_circular</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&lt;&gt;</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">let</span> <span class="n">are_in_same_strong_component</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">is_circular</span> <span class="n">a</span> <span class="o">&amp;&amp;</span> <span class="n">is_circular</span> <span class="n">b</span> <span class="o">&amp;&amp;</span> <span class="n">a</span> <span class="o">=</span> <span class="n">b</span>
            <span class="n">let</span> <span class="n">ers</span> <span class="o">=</span>
                <span class="n">let</span> <span class="n">cpath</span> <span class="o">=</span> <span class="n">c</span> <span class="n">path</span>
                <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">packages</span><span class="p">,</span> <span class="p">[])</span> <span class="o">||&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="p">{</span><span class="nb">dir</span><span class="o">=</span><span class="n">r</span><span class="p">,</span><span class="n">p</span><span class="p">}</span> <span class="n">ers</span> <span class="o">-&gt;</span>
                    <span class="n">let</span> <span class="n">cp</span> <span class="o">=</span> <span class="n">c</span> <span class="n">p</span>
                    <span class="k">if</span> <span class="n">are_in_same_strong_component</span> <span class="n">cpath</span> <span class="n">cp</span> <span class="n">then</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="s2">"Package is circular and loops through the current one."</span><span class="p">)</span> <span class="p">::</span> <span class="n">ers</span>
                    <span class="k">elif</span> <span class="n">path</span> <span class="o">=</span> <span class="n">p</span> <span class="n">then</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="s2">"Self referential links are not allowed."</span><span class="p">)</span> <span class="p">::</span> <span class="n">ers</span>
                    <span class="k">else</span>
                        <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">p</span> <span class="n">s</span> <span class="k">with</span>
                        <span class="o">|</span> <span class="n">Some</span> <span class="n">s</span><span class="s1">' when ss_has_error s'</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="s2">"Package has an error."</span><span class="p">)</span> <span class="p">::</span> <span class="n">ers</span>
                        <span class="o">|</span> <span class="n">Some</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">ers</span>
                        <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="s2">"Package not loaded."</span><span class="p">)</span> <span class="p">::</span> <span class="n">ers</span>
                    <span class="p">)</span> 
            <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">path</span> <span class="p">{</span><span class="n">x</span> <span class="k">with</span> <span class="n">errors_packages</span><span class="o">=</span><span class="n">ers</span><span class="p">}</span> <span class="n">s</span>
        <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">s</span>
        <span class="p">)</span> <span class="n">packages</span> <span class="n">order</span>

<span class="n">let</span> <span class="n">ss_validate</span> <span class="n">packages</span> <span class="n">modules</span> <span class="p">(</span><span class="n">order</span><span class="p">,</span><span class="n">socs</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">packages</span> <span class="o">=</span> <span class="n">ss_validate_modules</span> <span class="n">packages</span> <span class="n">modules</span> <span class="n">order</span>
    <span class="n">ss_validate_packages</span> <span class="n">packages</span> <span class="p">(</span><span class="n">order</span><span class="p">,</span><span class="n">socs</span><span class="p">)</span>

<span class="nb">type</span> <span class="n">ResultMap</span><span class="o">&lt;</span><span class="s1">'a,'</span><span class="n">b</span><span class="o">&gt;</span> <span class="n">when</span> <span class="s1">'a : comparison = {ok : Map&lt;'</span><span class="n">a</span><span class="p">,</span><span class="s1">'b&gt;; error: Map&lt;'</span><span class="n">a</span><span class="p">,</span><span class="s1">'b&gt;}</span>
<span class="nb">type</span> <span class="n">ProjEnvTCResult</span> <span class="o">=</span> <span class="n">ResultMap</span><span class="o">&lt;</span><span class="n">PackageId</span><span class="p">,</span><span class="n">ProjStateTC</span><span class="o">&gt;</span>

<span class="n">let</span> <span class="n">wdiff_projenvr_sync_schema</span> <span class="n">default_env</span> <span class="n">funs_packages</span> <span class="n">funs_files</span> <span class="p">(</span><span class="n">ids</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">PackageId</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">(</span><span class="n">packages</span> <span class="p">:</span> <span class="n">SchemaEnv</span><span class="p">)</span> 
        <span class="p">(</span><span class="n">state</span> <span class="p">:</span> <span class="n">ResultMap</span><span class="o">&lt;</span><span class="n">PackageId</span><span class="p">,</span><span class="n">ProjState</span><span class="o">&lt;</span><span class="s1">'file_input,'</span><span class="n">file</span><span class="p">,</span><span class="s1">'package&gt;&gt;) order =</span>
    <span class="n">Array</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">s</span> <span class="p">:</span> <span class="n">ResultMap</span><span class="o">&lt;</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="o">&gt;</span><span class="p">)</span> <span class="n">x</span> <span class="o">-&gt;</span>
        <span class="n">let</span> <span class="n">x</span><span class="s1">' = x |&gt; SpiralFileSystem.standardize_path</span>
        <span class="n">trace</span> <span class="n">Verbose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"ServerUtils.wdiff_projenvr_sync_schema / x: </span><span class="si">{x}</span><span class="s2"> / x': {x'}"</span><span class="p">)</span> <span class="n">_locals</span>
        <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">x</span><span class="s1">' ids with</span>
        <span class="o">|</span> <span class="n">Some</span> <span class="n">pid</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">x</span><span class="s1">' packages with</span>
            <span class="o">|</span> <span class="n">Some</span> <span class="n">schema</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">pid</span> <span class="n">s</span><span class="o">.</span><span class="n">ok</span><span class="p">,</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">pid</span> <span class="n">s</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="n">ss_has_error</span> <span class="n">schema</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">Some</span> <span class="n">_</span><span class="p">,</span> <span class="n">Some</span> <span class="n">_</span><span class="p">,</span><span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: The ok and error maps should be disjoint."</span>
                <span class="o">|</span> <span class="n">Some</span> <span class="n">x</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">true</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">ok</span><span class="o">=</span><span class="n">Map</span><span class="o">.</span><span class="n">remove</span> <span class="n">pid</span> <span class="n">s</span><span class="o">.</span><span class="n">ok</span><span class="p">;</span> <span class="n">error</span><span class="o">=</span><span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">pid</span> <span class="n">x</span> <span class="n">s</span><span class="o">.</span><span class="n">error</span><span class="p">}</span>
                <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Some</span> <span class="n">x</span><span class="p">,</span> <span class="n">false</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">ok</span><span class="o">=</span><span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">pid</span> <span class="n">x</span> <span class="n">s</span><span class="o">.</span><span class="n">ok</span><span class="p">;</span> <span class="n">error</span><span class="o">=</span><span class="n">Map</span><span class="o">.</span><span class="n">remove</span> <span class="n">pid</span> <span class="n">s</span><span class="o">.</span><span class="n">error</span><span class="p">}</span>
                <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">c</span> <span class="o">-&gt;</span> 
                    <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">wdiff_proj_init</span> <span class="n">default_env</span> <span class="n">funs_packages</span> <span class="n">funs_files</span> <span class="n">pid</span>
                    <span class="k">if</span> <span class="n">c</span> <span class="n">then</span> <span class="p">{</span><span class="n">s</span> <span class="k">with</span> <span class="n">error</span><span class="o">=</span><span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">pid</span> <span class="n">x</span> <span class="n">s</span><span class="o">.</span><span class="n">error</span><span class="p">}</span> <span class="k">else</span> <span class="p">{</span><span class="n">s</span> <span class="k">with</span> <span class="n">ok</span><span class="o">=</span><span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">pid</span> <span class="n">x</span> <span class="n">s</span><span class="o">.</span><span class="n">ok</span><span class="p">}</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">s</span>
            <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">ok</span><span class="o">=</span><span class="n">Map</span><span class="o">.</span><span class="n">remove</span> <span class="n">pid</span> <span class="n">s</span><span class="o">.</span><span class="n">ok</span><span class="p">;</span> <span class="n">error</span><span class="o">=</span><span class="n">Map</span><span class="o">.</span><span class="n">remove</span> <span class="n">pid</span> <span class="n">s</span><span class="o">.</span><span class="n">error</span><span class="p">}</span>
        <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">s</span>
        <span class="p">)</span> <span class="n">state</span> <span class="n">order</span>

<span class="n">let</span> <span class="n">projenv_update_packages</span> <span class="n">default_env</span> <span class="n">funs_packages</span> <span class="n">funs_files</span> <span class="p">(</span><span class="n">ids</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">PackageId</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">(</span><span class="n">packages</span> <span class="p">:</span> <span class="n">SchemaEnv</span><span class="p">)</span>
        <span class="p">(</span><span class="n">state</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">PackageId</span><span class="p">,</span><span class="n">ProjState</span><span class="o">&lt;</span><span class="s1">'a,'</span><span class="n">b</span><span class="p">,</span><span class="s1">'state&gt;&gt;)  (dirty_packages : Dictionary&lt;_,_&gt;, order : string []) =</span>
    <span class="n">Array</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="n">l</span> <span class="o">-&gt;</span>
        <span class="n">let</span> <span class="n">x</span><span class="s1">' = x |&gt; SpiralFileSystem.standardize_path</span>
        <span class="n">trace</span> <span class="n">Verbose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"ServerUtils.projenv_update_packages / x: </span><span class="si">{x}</span><span class="s2"> / x': {x'}"</span><span class="p">)</span> <span class="n">_locals</span>
        <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">x</span><span class="s1">' packages with</span>
        <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">l</span>
        <span class="o">|</span> <span class="n">Some</span> <span class="n">schema</span> <span class="n">when</span> <span class="n">ss_has_error</span> <span class="n">schema</span> <span class="o">-&gt;</span> <span class="n">l</span>
        <span class="o">|</span> <span class="n">Some</span> <span class="n">schema</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">ids</span><span class="o">.</span><span class="p">[</span><span class="n">x</span><span class="s1">']</span>
            <span class="n">let</span> <span class="n">packages</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">packages</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ids</span><span class="o">.</span><span class="p">[</span><span class="n">snd</span> <span class="n">x</span><span class="o">.</span><span class="n">dir</span><span class="p">])</span>
            <span class="k">match</span> <span class="n">dirty_packages</span><span class="o">.</span><span class="n">TryGetValue</span><span class="p">(</span><span class="n">x</span><span class="s1">') with</span>
            <span class="o">|</span> <span class="n">true</span><span class="p">,</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">UpdatePackageModule</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span><span class="n">packages</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="p">::</span> <span class="n">l</span>
            <span class="o">|</span> <span class="n">false</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">UpdatePackage</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span><span class="n">packages</span><span class="p">)</span> <span class="p">::</span> <span class="n">l</span>
        <span class="p">)</span> <span class="n">order</span> <span class="p">[]</span>
    <span class="o">|&gt;</span> <span class="n">wdiff_projenv</span> <span class="n">default_env</span> <span class="n">funs_packages</span> <span class="n">funs_files</span> <span class="n">state</span>

<span class="n">let</span> <span class="n">inline</span> <span class="n">proj_file_iter_file</span> <span class="n">f</span> <span class="p">(</span><span class="n">files</span> <span class="p">:</span> <span class="n">ProjFiles</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="o">=</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">ProjFilesTree</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">module_id</span><span class="p">,</span><span class="n">path</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">module_id</span> <span class="n">path</span>
        <span class="o">|</span> <span class="n">ProjFilesTree</span><span class="o">.</span><span class="n">Directory</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">l</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span> <span class="n">l</span>
    <span class="ow">and</span> <span class="nb">list</span> <span class="n">l</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="n">loop</span> <span class="n">l</span>
    <span class="nb">list</span> <span class="n">files</span><span class="o">.</span><span class="n">tree</span>

<span class="n">let</span> <span class="n">proj_file_get_input</span> <span class="n">uids_file</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">ProjFiles</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">d</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">Array</span><span class="o">.</span><span class="n">length</span> <span class="n">uids_file</span><span class="p">)</span>
    <span class="n">proj_file_iter_file</span> <span class="p">(</span><span class="n">fun</span> <span class="n">mid</span> <span class="n">path</span> <span class="o">-&gt;</span> <span class="n">d</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">Array</span><span class="o">.</span><span class="n">get</span> <span class="n">uids_file</span> <span class="n">mid</span> <span class="o">|&gt;</span> <span class="n">fst</span><span class="p">))</span> <span class="n">x</span>
    <span class="n">d</span>

<span class="n">let</span> <span class="n">proj_file_from_schema</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">Schema</span><span class="p">)</span> <span class="p">:</span> <span class="n">ProjFiles</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">mutable</span> <span class="n">num_files</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">let</span> <span class="n">mutable</span> <span class="n">num_dirs</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="o">=</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">FileHierarchy</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">_</span><span class="p">,(</span><span class="n">_</span><span class="p">,</span><span class="n">path</span><span class="p">),</span><span class="n">name</span><span class="p">)</span> <span class="o">-&gt;</span> 
            <span class="n">let</span> <span class="n">uid</span> <span class="o">=</span> <span class="n">num_files</span>
            <span class="n">num_files</span> <span class="o">&lt;-</span> <span class="n">num_files</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">let</span> <span class="n">path</span><span class="s1">' = path |&gt; SpiralFileSystem.standardize_path</span>
            <span class="n">trace</span> <span class="n">Verbose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"ServerUtils.proj_file_from_schema / path: </span><span class="si">{path}</span><span class="s2"> / path': {path'}"</span><span class="p">)</span> <span class="n">_locals</span>
            <span class="n">ProjFilesTree</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span><span class="n">path</span><span class="s1">',name)</span>
        <span class="o">|</span> <span class="n">FileHierarchy</span><span class="o">.</span><span class="n">Directory</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">l</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">uid</span> <span class="o">=</span> <span class="n">num_dirs</span>
            <span class="n">num_dirs</span> <span class="o">&lt;-</span> <span class="n">num_dirs</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">ProjFilesTree</span><span class="o">.</span><span class="n">Directory</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="nb">list</span> <span class="n">l</span><span class="p">)</span>
    <span class="ow">and</span> <span class="nb">list</span> <span class="n">l</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="n">loop</span> <span class="n">l</span>
    <span class="n">let</span> <span class="n">tree</span> <span class="o">=</span> <span class="nb">list</span> <span class="n">x</span><span class="o">.</span><span class="n">modules</span>
    <span class="p">{</span> <span class="n">tree</span> <span class="o">=</span> <span class="n">tree</span><span class="p">;</span> <span class="n">num_files</span> <span class="o">=</span> <span class="n">num_files</span><span class="p">;</span> <span class="n">num_dirs</span> <span class="o">=</span> <span class="n">num_dirs</span> <span class="p">}</span>

<span class="n">let</span> <span class="n">inline</span> <span class="n">proj_file_make_input</span> <span class="n">f</span> <span class="p">(</span><span class="n">files</span> <span class="p">:</span> <span class="n">ProjFiles</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">ar</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">zeroCreate</span> <span class="n">files</span><span class="o">.</span><span class="n">num_files</span>
    <span class="n">proj_file_iter_file</span> <span class="p">(</span><span class="n">fun</span> <span class="n">mid</span> <span class="n">path</span> <span class="o">-&gt;</span> <span class="n">ar</span><span class="o">.</span><span class="p">[</span><span class="n">mid</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">f</span> <span class="n">mid</span> <span class="n">path</span><span class="p">)</span> <span class="n">files</span>
    <span class="n">ar</span>

<span class="n">let</span> <span class="n">inline</span> <span class="n">dirty_nodes_template</span> <span class="n">funs</span> <span class="p">(</span><span class="n">ids</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">PackageId</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">(</span><span class="n">packages</span> <span class="p">:</span> <span class="n">SchemaEnv</span><span class="p">)</span> <span class="n">modules</span>
        <span class="p">(</span><span class="n">state</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">PackageId</span><span class="p">,</span><span class="n">_</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">(</span><span class="n">dirty_packages</span> <span class="p">:</span> <span class="n">string</span> <span class="n">HashSet</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">d</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="n">_</span> <span class="p">[]</span> <span class="o">*</span> <span class="n">ProjFiles</span><span class="o">&gt;</span><span class="p">()</span>
    <span class="n">dirty_packages</span> <span class="o">|&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">path</span> <span class="o">-&gt;</span>
        <span class="n">let</span> <span class="n">path</span><span class="s1">' = path |&gt; SpiralFileSystem.standardize_path</span>
        <span class="n">trace</span> <span class="n">Verbose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"ServerUtils.dirty_nodes_template / path: </span><span class="si">{path}</span><span class="s2"> / path': {path'}"</span><span class="p">)</span> <span class="n">_locals</span>
        <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">path</span><span class="s1">' ids with</span>
        <span class="o">|</span> <span class="n">Some</span> <span class="n">pid</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">pid</span> <span class="n">state</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">Some</span> <span class="n">x</span> <span class="o">-&gt;</span> 
                <span class="n">let</span> <span class="n">modules</span> <span class="o">=</span> <span class="n">modules</span> <span class="n">pid</span>
                <span class="n">let</span> <span class="n">files</span> <span class="o">=</span> <span class="n">proj_file_from_schema</span> <span class="n">packages</span><span class="o">.</span><span class="p">[</span><span class="n">path</span><span class="s1">'].schema</span>
                <span class="n">let</span> <span class="n">state</span> <span class="o">=</span> 
                    <span class="n">let</span> <span class="n">state</span> <span class="o">=</span> <span class="n">proj_file_get_input</span> <span class="n">x</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">uids_file</span> <span class="n">x</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">files</span>
                    <span class="n">proj_file_make_input</span> <span class="p">(</span><span class="n">fun</span> <span class="n">mid</span> <span class="n">path</span> <span class="o">-&gt;</span>
                        <span class="n">trace</span> <span class="n">Verbose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"ServerUtils.dirty_nodes_template / proj_file_make_input / path: </span><span class="si">{path}</span><span class="s2"> / path': {path'}"</span><span class="p">)</span> <span class="n">_locals</span>
                        <span class="k">match</span> <span class="n">state</span><span class="o">.</span><span class="n">TryGetValue</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">with</span>
                        <span class="o">|</span> <span class="n">true</span><span class="p">,</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">wdiff_file_update_input</span> <span class="n">funs</span> <span class="n">x</span> <span class="p">(</span><span class="n">modules</span> <span class="n">mid</span> <span class="n">path</span><span class="p">)</span>
                        <span class="o">|</span> <span class="n">false</span><span class="p">,</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">funs</span><span class="o">.</span><span class="n">init</span> <span class="p">(</span><span class="n">modules</span> <span class="n">mid</span> <span class="n">path</span><span class="p">)</span>
                        <span class="p">)</span> <span class="n">files</span>
                <span class="n">d</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">path</span><span class="s1">',(state,files))</span>
            <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="p">()</span>
        <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="p">()</span>
        <span class="p">)</span>
    <span class="n">d</span>

<span class="n">let</span> <span class="n">dirty_nodes_tc</span> <span class="p">(</span><span class="n">ids</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">PackageId</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">(</span><span class="n">packages</span> <span class="p">:</span> <span class="n">SchemaEnv</span><span class="p">)</span> <span class="p">(</span><span class="n">modules</span> <span class="p">:</span> <span class="n">ModuleEnv</span><span class="p">)</span>
        <span class="p">(</span><span class="n">state</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">PackageId</span><span class="p">,</span><span class="n">ProjStateTC</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">(</span><span class="n">dirty_packages</span> <span class="p">:</span> <span class="n">string</span> <span class="n">HashSet</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">dirty_nodes_template</span> <span class="n">funs_file_tc</span> <span class="n">ids</span> <span class="n">packages</span> <span class="p">(</span><span class="n">fun</span> <span class="n">pid</span> <span class="n">mid</span> <span class="n">path</span> <span class="o">-&gt;</span> <span class="n">pid</span><span class="p">,</span> <span class="n">mid</span><span class="p">,</span> <span class="n">modules</span><span class="o">.</span><span class="p">[</span><span class="n">path</span><span class="p">]</span><span class="o">.</span><span class="n">bundler</span><span class="p">)</span> <span class="n">state</span> <span class="n">dirty_packages</span>

<span class="n">let</span> <span class="n">dirty_nodes_prepass</span> <span class="p">(</span><span class="n">ids</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">PackageId</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">(</span><span class="n">packages</span> <span class="p">:</span> <span class="n">SchemaEnv</span><span class="p">)</span> <span class="p">(</span><span class="n">modules</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">PackageId</span><span class="p">,</span><span class="n">ProjStateTC</span><span class="o">&gt;</span><span class="p">)</span>
        <span class="p">(</span><span class="n">state</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">PackageId</span><span class="p">,</span><span class="n">ProjStatePrepass</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">(</span><span class="n">dirty_packages</span> <span class="p">:</span> <span class="n">string</span> <span class="n">HashSet</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">modules</span> <span class="n">pid</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">modules</span><span class="o">.</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span>
        <span class="n">let</span> <span class="n">state</span> <span class="o">=</span> <span class="n">proj_file_get_input</span> <span class="n">x</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">uids_file</span> <span class="n">x</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">files</span>
        <span class="n">fun</span> <span class="p">(</span><span class="n">mid</span> <span class="p">:</span> <span class="n">ModuleId</span><span class="p">)</span> <span class="n">path</span> <span class="o">-&gt;</span> <span class="n">pid</span><span class="p">,</span> <span class="n">mid</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="p">[</span><span class="n">path</span><span class="p">]</span><span class="o">.</span><span class="n">result</span>
    <span class="n">dirty_nodes_template</span> <span class="n">funs_file_prepass</span> <span class="n">ids</span> <span class="n">packages</span> <span class="n">modules</span> <span class="n">state</span> <span class="n">dirty_packages</span>

<span class="n">let</span> <span class="n">wdiff_projenvr</span> <span class="n">default_env</span> <span class="n">dirty_nodes</span> <span class="n">funs_proj_package</span> <span class="n">funs_proj_file</span> 
        <span class="n">ids</span> <span class="n">packages</span> <span class="n">modules</span> <span class="p">(</span><span class="n">state</span> <span class="p">:</span> <span class="n">ResultMap</span><span class="o">&lt;</span><span class="n">PackageId</span><span class="p">,</span><span class="n">_</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">(</span><span class="n">dirty_packages</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">state</span> <span class="o">=</span> <span class="n">wdiff_projenvr_sync_schema</span> <span class="n">default_env</span> <span class="n">funs_proj_package</span> <span class="n">funs_proj_file</span> <span class="n">ids</span> <span class="n">packages</span> <span class="n">state</span> <span class="n">order</span>
    <span class="n">let</span> <span class="n">dirty_packages</span> <span class="o">=</span> <span class="n">dirty_nodes</span> <span class="n">ids</span> <span class="n">packages</span> <span class="n">modules</span> <span class="n">state</span><span class="o">.</span><span class="n">ok</span> <span class="n">dirty_packages</span>
    <span class="p">{</span><span class="n">state</span> <span class="k">with</span> <span class="n">ok</span><span class="o">=</span><span class="n">projenv_update_packages</span> <span class="n">default_env</span> <span class="n">funs_proj_package</span> <span class="n">funs_proj_file</span> <span class="n">ids</span> <span class="n">packages</span> <span class="n">state</span><span class="o">.</span><span class="n">ok</span> <span class="p">(</span><span class="n">dirty_packages</span><span class="p">,</span> <span class="n">order</span><span class="p">)}</span>

<span class="n">let</span> <span class="n">wdiff_projenvr_tc</span> <span class="n">default_env</span> <span class="n">ids</span> <span class="n">packages</span> <span class="n">modules</span> <span class="n">state</span> <span class="p">(</span><span class="n">dirty_packages</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">wdiff_projenvr</span> <span class="n">default_env</span> <span class="n">dirty_nodes_tc</span> <span class="n">funs_proj_package_tc</span> <span class="n">funs_proj_file_tc</span> 
        <span class="n">ids</span> <span class="n">packages</span> <span class="n">modules</span> <span class="n">state</span> <span class="p">(</span><span class="n">dirty_packages</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>

<span class="n">let</span> <span class="n">wdiff_projenvr_prepass</span> <span class="n">default_env</span> <span class="n">ids</span> <span class="n">packages</span> <span class="n">modules</span> <span class="n">state</span> <span class="p">(</span><span class="n">dirty_packages</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">wdiff_projenvr</span> <span class="n">default_env</span> <span class="n">dirty_nodes_prepass</span> <span class="n">funs_proj_package_prepass</span> <span class="n">funs_proj_file_prepass</span> 
        <span class="n">ids</span> <span class="n">packages</span> <span class="n">modules</span> <span class="n">state</span> <span class="p">(</span><span class="n">dirty_packages</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>

<span class="nb">type</span> <span class="n">LoadResult</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">LoadModule</span> <span class="n">of</span> <span class="n">path</span><span class="p">:</span> <span class="n">string</span> <span class="o">*</span> <span class="n">ModuleState</span> <span class="n">option</span>
    <span class="o">|</span> <span class="n">LoadPackage</span> <span class="n">of</span> <span class="n">package_dir</span><span class="p">:</span> <span class="n">string</span> <span class="o">*</span> <span class="n">SchemaState</span> <span class="n">option</span>

<span class="nb">open</span> <span class="n">System</span><span class="o">.</span><span class="n">Threading</span><span class="o">.</span><span class="n">Tasks</span>
<span class="n">let</span> <span class="n">is_top_down</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">string</span><span class="p">)</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">GetExtension</span> <span class="n">x</span> <span class="o">=</span> <span class="s2">".spi"</span>
<span class="n">let</span> <span class="n">spiproj_suffix</span> <span class="n">x</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">Combine</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="s2">"package.spiproj"</span><span class="p">)</span>
<span class="n">let</span> <span class="n">loader_package</span> <span class="n">default_env</span> <span class="p">(</span><span class="n">packages</span> <span class="p">:</span> <span class="n">SchemaEnv</span><span class="p">)</span> <span class="p">(</span><span class="n">modules</span> <span class="p">:</span> <span class="n">ModuleEnv</span><span class="p">)</span> <span class="p">(</span><span class="n">pdir</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">pdir</span><span class="s1">' = pdir |&gt; SpiralFileSystem.standardize_path</span>
    <span class="n">trace</span> <span class="n">Verbose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"ServerUtils.loader_package / pdir: </span><span class="si">{pdir}</span><span class="s2"> / pdir': {pdir'}"</span><span class="p">)</span> <span class="n">_locals</span>
    <span class="n">let</span> <span class="n">pdir</span> <span class="o">=</span> <span class="n">pdir</span><span class="s1">'</span>
    <span class="n">let</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
    <span class="n">let</span> <span class="n">load_module</span> <span class="n">modules</span> <span class="n">path</span> <span class="o">=</span>
        <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">path</span> <span class="n">modules</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">Some</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="p">()</span>
        <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span>
            <span class="n">task</span> <span class="p">{</span>
                <span class="k">if</span> <span class="n">File</span><span class="o">.</span><span class="n">Exists</span> <span class="n">path</span> <span class="n">then</span>
                    <span class="k">try</span> <span class="n">let</span><span class="err">!</span> <span class="n">x</span> <span class="o">=</span> <span class="n">File</span><span class="o">.</span><span class="n">ReadAllTextAsync</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">LoadModule</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">wdiff_module_init_all</span> <span class="n">default_env</span> <span class="p">(</span><span class="n">is_top_down</span> <span class="n">path</span><span class="p">)</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">Some</span><span class="p">)</span>
                    <span class="k">with</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="k">return</span> <span class="n">LoadModule</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">else</span> <span class="k">return</span> <span class="n">LoadModule</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span> <span class="o">//</span> <span class="n">Note</span><span class="p">:</span> <span class="n">We</span> <span class="n">need</span> <span class="n">this</span> <span class="n">case</span> <span class="n">otherwise</span> <span class="s1">'con'</span> <span class="n">might</span> <span class="n">cause</span> <span class="n">the</span> <span class="n">file</span> <span class="n">read</span> <span class="n">to</span> <span class="n">deadlock</span><span class="o">.</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">superuser</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">questions</span><span class="o">/</span><span class="mi">86999</span><span class="o">/</span><span class="n">why</span><span class="o">-</span><span class="n">cant</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="n">name</span><span class="o">-</span><span class="n">a</span><span class="o">-</span><span class="n">folder</span><span class="o">-</span><span class="ow">or</span><span class="o">-</span><span class="n">file</span><span class="o">-</span><span class="n">con</span><span class="o">-</span><span class="ow">in</span><span class="o">-</span><span class="n">windows</span>
            <span class="p">}</span> <span class="o">|&gt;</span> <span class="n">queue</span><span class="o">.</span><span class="n">Enqueue</span>

    <span class="n">let</span> <span class="n">schema</span> <span class="p">(</span><span class="n">pdir</span><span class="p">,</span><span class="n">text</span><span class="p">)</span> <span class="o">=</span> <span class="n">schema</span> <span class="p">(</span><span class="n">pdir</span><span class="p">,</span><span class="n">text</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">LoadPackage</span><span class="p">(</span><span class="n">pdir</span><span class="p">,</span><span class="n">Some</span> <span class="p">(</span><span class="n">ss_from_result</span> <span class="n">x</span><span class="p">))</span>
    <span class="n">let</span> <span class="n">load_package_from_disk</span> <span class="n">packages</span> <span class="n">pdir</span> <span class="o">=</span>
        <span class="n">trace</span> <span class="n">Verbose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"ServerUtils.loader_package.load_package_from_disk / pdir: </span><span class="si">{pdir}</span><span class="s2">"</span><span class="p">)</span> <span class="n">_locals</span>
        <span class="n">task</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">Directory</span><span class="o">.</span><span class="n">Exists</span> <span class="n">pdir</span> <span class="n">then</span>
                <span class="k">try</span>
                    <span class="n">let</span><span class="err">!</span> <span class="n">x</span> <span class="o">=</span> <span class="n">File</span><span class="o">.</span><span class="n">ReadAllTextAsync</span><span class="p">(</span><span class="n">spiproj_suffix</span> <span class="n">pdir</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">schema</span> <span class="p">(</span><span class="n">pdir</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">_</span> <span class="o">-&gt;</span>
                    <span class="k">return</span> <span class="n">LoadPackage</span><span class="p">(</span><span class="n">pdir</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span> <span class="k">return</span> <span class="n">LoadPackage</span><span class="p">(</span><span class="n">pdir</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span> <span class="o">//</span> <span class="n">Ditto</span><span class="o">.</span>
        <span class="p">}</span> <span class="o">|&gt;</span> <span class="n">queue</span><span class="o">.</span><span class="n">Enqueue</span>
    <span class="n">let</span> <span class="n">load_package_some</span> <span class="p">(</span><span class="n">pdir</span><span class="p">,</span><span class="n">text</span><span class="p">)</span> <span class="o">=</span>
        <span class="n">trace</span> <span class="n">Verbose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"ServerUtils.loader_package.load_package_some / pdir: </span><span class="si">{pdir}</span><span class="s2">"</span><span class="p">)</span> <span class="n">_locals</span>
        <span class="n">schema</span> <span class="p">(</span><span class="n">pdir</span><span class="p">,</span><span class="n">text</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">Task</span><span class="o">.</span><span class="n">FromResult</span> <span class="o">|&gt;</span> <span class="n">queue</span><span class="o">.</span><span class="n">Enqueue</span>
    <span class="n">let</span> <span class="n">load_package_none</span> <span class="n">packages</span> <span class="n">pdir</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">pdir</span><span class="s1">' = pdir |&gt; SpiralFileSystem.standardize_path</span>
        <span class="n">trace</span> <span class="n">Verbose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"ServerUtils.loader_package.load_package_none / pdir: </span><span class="si">{pdir}</span><span class="s2"> / pdir': {pdir'}"</span><span class="p">)</span> <span class="n">_locals</span>
        <span class="n">let</span> <span class="n">pdir</span> <span class="o">=</span> <span class="n">pdir</span><span class="s1">'</span>
        <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">pdir</span> <span class="n">packages</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">Some</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="p">()</span>
        <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">load_package_from_disk</span> <span class="n">packages</span> <span class="n">pdir</span>

    <span class="n">let</span> <span class="n">dirty_packages</span> <span class="o">=</span> <span class="n">HashSet</span><span class="p">()</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">invalidate_parent</span> <span class="n">packages</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">DirectoryInfo</span><span class="p">)</span> <span class="o">=</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;&gt;</span> <span class="n">null</span> <span class="n">then</span>
            <span class="n">let</span> <span class="n">x</span><span class="s1">' = x.FullName |&gt; SpiralFileSystem.standardize_path</span>
            <span class="o">//</span> <span class="n">trace</span> <span class="n">Verbose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"""ServerUtils.loader_package.invalidate_parent / x.FullName: {x.FullName |&gt; SpiralSm.replace "</span><span class="se">\\</span><span class="s2">" "|"} / x': {x'} / packages: %A{packages |&gt; Map.keys} / pdir: </span><span class="si">{pdir}</span><span class="s2">"""</span><span class="p">)</span> <span class="n">_locals</span>
            <span class="n">let</span> <span class="n">x_</span> <span class="o">=</span> <span class="n">x</span>
            <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span> <span class="n">FullName</span> <span class="o">=</span> <span class="n">x</span><span class="s1">' |}</span>
            <span class="k">if</span> <span class="n">Map</span><span class="o">.</span><span class="n">containsKey</span> <span class="n">x</span><span class="o">.</span><span class="n">FullName</span> <span class="n">packages</span> <span class="n">then</span> <span class="n">dirty_packages</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">FullName</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
            <span class="k">else</span> <span class="n">invalidate_parent</span> <span class="n">packages</span> <span class="n">x_</span><span class="o">.</span><span class="n">Parent</span>

    <span class="n">let</span> <span class="n">mutable</span> <span class="n">packages</span> <span class="o">=</span> <span class="n">packages</span>
    <span class="n">let</span> <span class="n">mutable</span> <span class="n">modules</span> <span class="o">=</span> <span class="n">modules</span>

    <span class="k">match</span> <span class="n">text</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">Some</span> <span class="n">text</span> <span class="o">-&gt;</span> <span class="n">load_package_some</span> <span class="p">(</span><span class="n">pdir</span><span class="p">,</span><span class="n">text</span><span class="p">)</span>
    <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span>
        <span class="o">//</span> <span class="n">trace</span> <span class="n">Verbose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"ServerUtils.loader_package / pdir: </span><span class="si">{pdir}</span><span class="s2">"</span><span class="p">)</span> <span class="n">_locals</span>
        <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">pdir</span> <span class="n">packages</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">Some</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">LoadPackage</span><span class="p">(</span><span class="n">pdir</span><span class="p">,</span><span class="n">Some</span> <span class="n">x</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">Task</span><span class="o">.</span><span class="n">FromResult</span> <span class="o">|&gt;</span> <span class="n">queue</span><span class="o">.</span><span class="n">Enqueue</span>
        <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">load_package_from_disk</span> <span class="n">packages</span> <span class="n">pdir</span>

    <span class="k">while</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">queue</span><span class="o">.</span><span class="n">Count</span> <span class="n">do</span>
        <span class="k">match</span> <span class="n">queue</span><span class="o">.</span><span class="n">Dequeue</span><span class="p">()</span><span class="o">.</span><span class="n">Result</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">LoadPackage</span><span class="p">(</span><span class="n">pdir</span><span class="p">,</span><span class="n">Some</span> <span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> 
            <span class="n">let</span> <span class="n">pdir</span><span class="s1">' = pdir |&gt; SpiralFileSystem.standardize_path</span>
            <span class="o">//</span> <span class="n">trace</span> <span class="n">Verbose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"ServerUtils.loader_package.LoadPackage / pdir: </span><span class="si">{pdir}</span><span class="s2"> / pdir': {pdir'}"</span><span class="p">)</span> <span class="n">_locals</span>
            <span class="n">packages</span> <span class="o">&lt;-</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">pdir</span><span class="s1">' x packages; dirty_packages.Add(pdir'</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">ignore</span><span class="p">;</span> <span class="n">invalidate_parent</span> <span class="n">packages</span> <span class="p">(</span><span class="n">Directory</span><span class="o">.</span><span class="n">GetParent</span><span class="p">(</span><span class="n">pdir</span><span class="s1">'))</span>
            <span class="n">x</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">packages</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">load_package_none</span> <span class="n">packages</span> <span class="p">(</span><span class="n">snd</span> <span class="n">x</span><span class="o">.</span><span class="n">dir</span><span class="p">))</span>
            <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="o">=</span> <span class="n">function</span>
                <span class="o">|</span> <span class="n">FileHierarchy</span><span class="o">.</span><span class="n">Directory</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">l</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span> <span class="n">l</span>
                <span class="o">|</span> <span class="n">FileHierarchy</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">_</span><span class="p">,(</span><span class="n">_</span><span class="p">,</span><span class="n">path</span><span class="p">),</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span>
                    <span class="n">let</span> <span class="n">path</span><span class="s1">' = path |&gt; SpiralFileSystem.standardize_path</span>
                    <span class="n">trace</span> <span class="n">Verbose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"ServerUtils.loader_package.LoadPackage | FileHierarchy.File(_,(_,path),_) / path: </span><span class="si">{path}</span><span class="s2"> / path': {path'}"</span><span class="p">)</span> <span class="n">_locals</span>
                    <span class="n">load_module</span> <span class="n">modules</span> <span class="n">path</span><span class="s1">'</span>
            <span class="ow">and</span> <span class="nb">list</span> <span class="n">l</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="n">loop</span> <span class="n">l</span>
            <span class="nb">list</span> <span class="n">x</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">modules</span>
        <span class="o">|</span> <span class="n">LoadPackage</span><span class="p">(</span><span class="n">pdir</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">packages</span> <span class="o">&lt;-</span> <span class="n">Map</span><span class="o">.</span><span class="n">remove</span> <span class="n">pdir</span> <span class="n">packages</span><span class="p">;</span> <span class="n">dirty_packages</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">pdir</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">ignore</span><span class="p">;</span> <span class="n">invalidate_parent</span> <span class="n">packages</span> <span class="p">(</span><span class="n">Directory</span><span class="o">.</span><span class="n">GetParent</span><span class="p">(</span><span class="n">pdir</span><span class="p">))</span>
        <span class="o">|</span> <span class="n">LoadModule</span><span class="p">(</span><span class="n">mdir</span><span class="p">,</span><span class="n">Some</span> <span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">mdir</span><span class="s1">' = mdir |&gt; SpiralFileSystem.standardize_path</span>
            <span class="n">trace</span> <span class="n">Verbose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"ServerUtils.loader_package.LoadModule / mdir: </span><span class="si">{mdir}</span><span class="s2"> / mdir': {mdir'}"</span><span class="p">)</span> <span class="n">_locals</span>
            <span class="n">modules</span> <span class="o">&lt;-</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">mdir</span><span class="s1">' x modules</span>
        <span class="o">|</span> <span class="n">LoadModule</span><span class="p">(</span><span class="n">mdir</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">modules</span> <span class="o">&lt;-</span> <span class="n">Map</span><span class="o">.</span><span class="n">remove</span> <span class="n">mdir</span> <span class="n">modules</span>
    <span class="n">packages</span><span class="p">,</span> <span class="n">dirty_packages</span><span class="p">,</span> <span class="n">modules</span>

<span class="n">let</span> <span class="n">graph_update</span> <span class="p">(</span><span class="n">packages</span> <span class="p">:</span> <span class="n">SchemaEnv</span><span class="p">)</span> <span class="p">(</span><span class="n">g</span> <span class="p">:</span> <span class="n">MirroredGraph</span><span class="p">)</span> <span class="p">(</span><span class="n">dirty_packages</span> <span class="p">:</span> <span class="n">string</span> <span class="n">HashSet</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">Seq</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">g</span> <span class="n">x</span> <span class="o">-&gt;</span>
        <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">x</span> <span class="n">packages</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">Some</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">links_replace</span> <span class="n">g</span> <span class="n">x</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">packages</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">snd</span> <span class="n">x</span><span class="o">.</span><span class="n">dir</span><span class="p">))</span>
        <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">links_remove</span> <span class="n">g</span> <span class="n">x</span>
        <span class="p">)</span> <span class="n">g</span> <span class="n">dirty_packages</span>

<span class="n">let</span> <span class="n">package_ids_update</span> <span class="p">(</span><span class="n">packages</span> <span class="p">:</span> <span class="n">SchemaEnv</span><span class="p">)</span> <span class="n">package_ids</span> <span class="p">(</span><span class="n">dirty_packages</span> <span class="p">:</span> <span class="n">string</span> <span class="n">HashSet</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">adds</span><span class="p">,</span><span class="n">removals</span> <span class="o">=</span> <span class="n">dirty_packages</span> <span class="o">|&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">toArray</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">partition</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">containsKey</span> <span class="n">x</span> <span class="n">packages</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">adds</span> <span class="o">=</span> <span class="n">adds</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">filter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">containsKey</span> <span class="n">x</span> <span class="p">(</span><span class="n">fst</span> <span class="n">package_ids</span><span class="p">)</span> <span class="o">=</span> <span class="n">false</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">mapi</span> <span class="p">(</span><span class="n">fun</span> <span class="n">i</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">x</span><span class="p">))</span>
    <span class="n">let</span> <span class="n">package_ids</span><span class="p">,</span> <span class="n">removed_pids</span> <span class="o">=</span> <span class="n">removals</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">),</span><span class="n">l</span> <span class="k">as</span> <span class="n">s</span><span class="p">)</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">x</span> <span class="n">a</span> <span class="k">with</span> <span class="n">Some</span> <span class="n">x</span><span class="s1">' -&gt; (Map.remove x a, Map.remove x'</span> <span class="n">b</span><span class="p">),</span> <span class="n">x</span><span class="s1">' :: l | None -&gt; s) (package_ids,[])</span>
    <span class="n">removed_pids</span><span class="p">,</span>
    <span class="k">if</span> <span class="n">Array</span><span class="o">.</span><span class="n">isEmpty</span> <span class="n">adds</span> <span class="n">then</span> <span class="n">package_ids</span> <span class="k">else</span>
    <span class="n">Map</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">x</span> <span class="n">_</span> <span class="o">-&gt;</span>
        <span class="n">Array</span><span class="o">.</span><span class="n">mapFold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">s</span> <span class="o">=</span> <span class="n">fst</span> <span class="n">x</span> <span class="n">then</span> <span class="p">(</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">snd</span> <span class="n">x</span><span class="p">),</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span> <span class="k">else</span> <span class="n">x</span><span class="p">,</span><span class="n">s</span><span class="p">)</span> <span class="n">x</span> <span class="n">s</span> <span class="o">|&gt;</span> <span class="n">fst</span>
        <span class="p">)</span> <span class="n">adds</span> <span class="p">(</span><span class="n">snd</span> <span class="n">package_ids</span><span class="p">)</span>
    <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">v</span> <span class="n">k</span> <span class="n">a</span><span class="p">,</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">k</span> <span class="n">v</span> <span class="n">b</span><span class="p">)</span> <span class="n">package_ids</span>

<span class="n">let</span> <span class="n">package_ids_remove</span> <span class="p">(</span><span class="n">s</span> <span class="p">:</span> <span class="n">ResultMap</span><span class="o">&lt;</span><span class="n">PackageId</span><span class="p">,</span><span class="n">_</span><span class="o">&gt;</span><span class="p">)</span> <span class="n">l</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">fold</span> <span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="p">{</span><span class="n">ok</span><span class="o">=</span><span class="n">Map</span><span class="o">.</span><span class="n">remove</span> <span class="n">x</span> <span class="n">s</span><span class="o">.</span><span class="n">ok</span><span class="p">;</span> <span class="n">error</span><span class="o">=</span><span class="n">Map</span><span class="o">.</span><span class="n">remove</span> <span class="n">x</span> <span class="n">s</span><span class="o">.</span><span class="n">error</span><span class="p">})</span> <span class="n">s</span> <span class="n">l</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=71">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="SignalRSupervisor">SignalRSupervisor<a class="anchor-link" href="#SignalRSupervisor"></a></h2>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=72">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="o">//</span> <span class="c1">#r @"../../../../../../../.nuget/packages/microsoft.aspnetcore.app.ref/7.0.11/ref/net7.0/Microsoft.AspNetCore.SignalR.Core.dll"</span>
<span class="o">//</span> <span class="c1">#r @"../../../../../../../.nuget/packages/argu/6.2.4/lib/netstandard2.0/Argu.dll"</span>
<span class="o">//</span> <span class="c1">#r @"../../../../../../../.nuget/packages/microsoft.aspnetcore.http.connections.common/7.0.0/lib/net7.0/Microsoft.AspNetCore.Http.Connections.Common.dll"</span>
<span class="o">//</span> <span class="c1">#r @"../../../../../../../.nuget/packages/microsoft.aspnetcore.http.connections.client/7.0.0/lib/net7.0/Microsoft.AspNetCore.Http.Connections.Client.dll"</span>
<span class="o">//</span> <span class="c1">#r @"../../../../../../../.nuget/packages/microsoft.aspnetcore.signalr.common/7.0.0/lib/net7.0/Microsoft.AspNetCore.SignalR.Common.dll"</span>
<span class="o">//</span> <span class="c1">#r @"../../../../../../../.nuget/packages/microsoft.aspnetcore.signalr.client/7.0.0/lib/net7.0/Microsoft.AspNetCore.SignalR.Client.dll"</span>
<span class="o">//</span> <span class="c1">#r @"../../../../../../../.nuget/packages/microsoft.aspnetcore.signalr.client.core/7.0.0/lib/net7.0/Microsoft.AspNetCore.SignalR.Client.Core.dll"</span>
<span class="o">//</span> <span class="c1">#r @"../../../../../../../.nuget/packages/fsharp.json/0.4.1/lib/netstandard2.0/FSharp.Json.dll"</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=73">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="o">//</span> <span class="nb">open</span> <span class="n">System</span>
<span class="nb">open</span> <span class="n">System</span><span class="o">.</span><span class="n">IO</span>
<span class="nb">open</span> <span class="n">System</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">Generic</span>

<span class="nb">open</span> <span class="n">Hopac</span>
<span class="nb">open</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">Infixes</span>
<span class="nb">open</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">Extensions</span>
<span class="nb">open</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">Stream</span>

<span class="o">//</span> <span class="nb">open</span> <span class="n">Common</span>
<span class="nb">open</span> <span class="n">SpiralFileSystem</span><span class="o">.</span><span class="n">Operators</span>

<span class="nb">type</span> <span class="n">LocalizedErrors</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span><span class="n">uri</span> <span class="p">:</span> <span class="n">string</span><span class="p">;</span> <span class="n">errors</span> <span class="p">:</span> <span class="n">RString</span> <span class="nb">list</span><span class="o">|</span><span class="p">}</span>
<span class="nb">type</span> <span class="n">TracedError</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span><span class="n">trace</span> <span class="p">:</span> <span class="n">string</span> <span class="nb">list</span><span class="p">;</span> <span class="n">message</span> <span class="p">:</span> <span class="n">string</span><span class="o">|</span><span class="p">}</span>
<span class="nb">type</span> <span class="n">SupervisorErrorSources</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">fatal</span> <span class="p">:</span> <span class="n">string</span> <span class="n">Ch</span>
    <span class="n">tokenizer</span> <span class="p">:</span> <span class="n">LocalizedErrors</span> <span class="n">Ch</span>
    <span class="n">parser</span> <span class="p">:</span> <span class="n">LocalizedErrors</span> <span class="n">Ch</span>
    <span class="n">typer</span> <span class="p">:</span> <span class="n">LocalizedErrors</span> <span class="n">Ch</span>
    <span class="n">package</span> <span class="p">:</span> <span class="n">LocalizedErrors</span> <span class="n">Ch</span>
    <span class="n">traced</span> <span class="p">:</span> <span class="n">TracedError</span> <span class="n">Ch</span>
    <span class="p">}</span>

<span class="nb">type</span> <span class="n">SupervisorReq</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">ProjectFileOpen</span> <span class="n">of</span> <span class="p">{</span><span class="o">|</span><span class="n">uri</span> <span class="p">:</span> <span class="n">string</span><span class="p">;</span> <span class="n">spiprojText</span> <span class="p">:</span> <span class="n">string</span><span class="o">|</span><span class="p">}</span>
    <span class="o">|</span> <span class="n">ProjectFileChange</span> <span class="n">of</span> <span class="p">{</span><span class="o">|</span><span class="n">uri</span> <span class="p">:</span> <span class="n">string</span><span class="p">;</span> <span class="n">spiprojText</span> <span class="p">:</span> <span class="n">string</span><span class="o">|</span><span class="p">}</span>
    <span class="o">|</span> <span class="n">ProjectFileLinks</span> <span class="n">of</span> <span class="p">{</span><span class="o">|</span><span class="n">uri</span> <span class="p">:</span> <span class="n">string</span><span class="o">|</span><span class="p">}</span> <span class="o">*</span> <span class="n">RString</span> <span class="nb">list</span> <span class="n">IVar</span>
    <span class="o">|</span> <span class="n">ProjectCodeActions</span> <span class="n">of</span> <span class="p">{</span><span class="o">|</span><span class="n">uri</span> <span class="p">:</span> <span class="n">string</span><span class="o">|</span><span class="p">}</span> <span class="o">*</span> <span class="n">RAction</span> <span class="nb">list</span> <span class="n">IVar</span>
    <span class="o">|</span> <span class="n">ProjectCodeActionExecute</span> <span class="n">of</span> <span class="p">{</span><span class="o">|</span><span class="n">uri</span> <span class="p">:</span> <span class="n">string</span><span class="p">;</span> <span class="n">action</span> <span class="p">:</span> <span class="n">ProjectCodeAction</span><span class="o">|</span><span class="p">}</span> <span class="o">*</span> <span class="p">{</span><span class="o">|</span><span class="n">result</span> <span class="p">:</span> <span class="n">string</span> <span class="n">option</span><span class="o">|</span><span class="p">}</span> <span class="n">IVar</span>
    <span class="o">|</span> <span class="n">FileOpen</span> <span class="n">of</span> <span class="p">{</span><span class="o">|</span><span class="n">uri</span> <span class="p">:</span> <span class="n">string</span><span class="p">;</span> <span class="n">spiText</span> <span class="p">:</span> <span class="n">string</span><span class="o">|</span><span class="p">}</span>
    <span class="o">|</span> <span class="n">FileChange</span> <span class="n">of</span> <span class="p">{</span><span class="o">|</span><span class="n">uri</span> <span class="p">:</span> <span class="n">string</span><span class="p">;</span> <span class="n">spiEdit</span> <span class="p">:</span> <span class="n">SpiEdit</span><span class="o">|</span><span class="p">}</span>
    <span class="o">|</span> <span class="n">FileDelete</span> <span class="n">of</span> <span class="p">{</span><span class="o">|</span><span class="n">uris</span> <span class="p">:</span> <span class="n">string</span> <span class="p">[]</span><span class="o">|</span><span class="p">}</span>
    <span class="o">|</span> <span class="n">FileTokenRange</span> <span class="n">of</span> <span class="p">{</span><span class="o">|</span><span class="n">uri</span> <span class="p">:</span> <span class="n">string</span><span class="p">;</span> <span class="nb">range</span> <span class="p">:</span> <span class="n">VSCRange</span><span class="o">|</span><span class="p">}</span> <span class="o">*</span> <span class="nb">int</span> <span class="p">[]</span> <span class="n">IVar</span>
    <span class="o">|</span> <span class="n">HoverAt</span> <span class="n">of</span> <span class="p">{</span><span class="o">|</span><span class="n">uri</span> <span class="p">:</span> <span class="n">string</span><span class="p">;</span> <span class="n">pos</span> <span class="p">:</span> <span class="n">VSCPos</span><span class="o">|</span><span class="p">}</span> <span class="o">*</span> <span class="n">string</span> <span class="n">option</span> <span class="n">IVar</span>
    <span class="o">|</span> <span class="n">BuildFile</span> <span class="n">of</span> <span class="p">{</span><span class="o">|</span><span class="n">uri</span> <span class="p">:</span> <span class="n">string</span><span class="p">;</span> <span class="n">backend</span> <span class="p">:</span> <span class="n">string</span><span class="o">|</span><span class="p">}</span> <span class="o">*</span> <span class="n">string</span> <span class="n">option</span> <span class="n">IVar</span>

<span class="nb">type</span> <span class="n">SupervisorState</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">packages</span> <span class="p">:</span> <span class="n">SchemaEnv</span>
    <span class="n">modules</span> <span class="p">:</span> <span class="n">ModuleEnv</span>
    <span class="n">packages_infer</span> <span class="p">:</span> <span class="n">ResultMap</span><span class="o">&lt;</span><span class="n">PackageId</span><span class="p">,</span><span class="n">ProjStateTC</span><span class="o">&gt;</span>
    <span class="n">packages_prepass</span> <span class="p">:</span> <span class="n">ResultMap</span><span class="o">&lt;</span><span class="n">PackageId</span><span class="p">,</span><span class="n">ProjStatePrepass</span><span class="o">&gt;</span>
    <span class="n">graph</span> <span class="p">:</span> <span class="n">MirroredGraph</span>
    <span class="n">package_ids</span> <span class="p">:</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span><span class="nb">int</span><span class="o">&gt;</span> <span class="o">*</span> <span class="n">Map</span><span class="o">&lt;</span><span class="nb">int</span><span class="p">,</span><span class="n">string</span><span class="o">&gt;</span>
    <span class="p">}</span>

<span class="n">let</span> <span class="n">proj_validate</span> <span class="n">default_env</span> <span class="n">s</span> <span class="n">dirty_packages</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">order</span><span class="p">,</span><span class="n">socs</span> <span class="o">=</span> <span class="n">circular_nodes</span> <span class="n">s</span><span class="o">.</span><span class="n">graph</span> <span class="n">dirty_packages</span>
    <span class="n">let</span> <span class="n">packages</span> <span class="o">=</span> <span class="n">ss_validate</span> <span class="n">s</span><span class="o">.</span><span class="n">packages</span> <span class="n">s</span><span class="o">.</span><span class="n">modules</span> <span class="p">(</span><span class="n">order</span><span class="p">,</span><span class="n">socs</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">packages_infer</span> <span class="o">=</span> <span class="n">wdiff_projenvr_tc</span> <span class="n">default_env</span> <span class="p">(</span><span class="n">fst</span> <span class="n">s</span><span class="o">.</span><span class="n">package_ids</span><span class="p">)</span> <span class="n">packages</span> <span class="n">s</span><span class="o">.</span><span class="n">modules</span> <span class="n">s</span><span class="o">.</span><span class="n">packages_infer</span> <span class="p">(</span><span class="n">dirty_packages</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
    <span class="n">order</span><span class="p">,</span> <span class="p">{</span><span class="n">s</span> <span class="k">with</span> <span class="n">packages_infer</span> <span class="o">=</span> <span class="n">packages_infer</span><span class="p">;</span> <span class="n">packages</span><span class="o">=</span><span class="n">packages</span><span class="p">}</span>

<span class="n">let</span> <span class="n">proj_graph_update</span> <span class="n">default_env</span> <span class="n">s</span> <span class="n">dirty_packages</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">removed_pids</span><span class="p">,</span><span class="n">package_ids</span> <span class="o">=</span> <span class="n">package_ids_update</span> <span class="n">s</span><span class="o">.</span><span class="n">packages</span> <span class="n">s</span><span class="o">.</span><span class="n">package_ids</span> <span class="n">dirty_packages</span>
    <span class="n">let</span> <span class="n">packages_infer</span><span class="p">,</span> <span class="n">packages_prepass</span> <span class="o">=</span> <span class="n">package_ids_remove</span> <span class="n">s</span><span class="o">.</span><span class="n">packages_infer</span> <span class="n">removed_pids</span><span class="p">,</span> <span class="n">package_ids_remove</span> <span class="n">s</span><span class="o">.</span><span class="n">packages_prepass</span> <span class="n">removed_pids</span>
    <span class="n">let</span> <span class="n">graph</span> <span class="o">=</span> <span class="n">graph_update</span> <span class="n">s</span><span class="o">.</span><span class="n">packages</span> <span class="n">s</span><span class="o">.</span><span class="n">graph</span> <span class="n">dirty_packages</span>
    <span class="n">proj_validate</span> <span class="n">default_env</span> <span class="p">{</span><span class="n">s</span> <span class="k">with</span> <span class="n">graph</span> <span class="o">=</span> <span class="n">graph</span><span class="p">;</span> <span class="n">package_ids</span> <span class="o">=</span> <span class="n">package_ids</span><span class="p">;</span> <span class="n">packages_infer</span> <span class="o">=</span> <span class="n">packages_infer</span><span class="p">;</span> <span class="n">packages_prepass</span> <span class="o">=</span> <span class="n">packages_prepass</span><span class="p">}</span> <span class="n">dirty_packages</span>

<span class="n">let</span> <span class="n">proj_open</span> <span class="n">default_env</span> <span class="n">s</span> <span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">packages</span><span class="p">,</span><span class="n">dirty_packages</span><span class="p">,</span><span class="n">modules</span> <span class="o">=</span> <span class="n">loader_package</span> <span class="n">default_env</span> <span class="n">s</span><span class="o">.</span><span class="n">packages</span> <span class="n">s</span><span class="o">.</span><span class="n">modules</span> <span class="p">(</span><span class="nb">dir</span><span class="p">,</span><span class="n">text</span><span class="p">)</span>
    <span class="n">proj_graph_update</span> <span class="n">default_env</span> <span class="p">{</span><span class="n">s</span> <span class="k">with</span> <span class="n">packages</span> <span class="o">=</span> <span class="n">packages</span><span class="p">;</span> <span class="n">modules</span> <span class="o">=</span> <span class="n">modules</span><span class="p">}</span> <span class="n">dirty_packages</span>

<span class="n">let</span> <span class="n">proj_revalidate_owner</span> <span class="n">default_env</span> <span class="n">s</span> <span class="n">file</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">DirectoryInfo</span><span class="p">)</span> <span class="o">=</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">=</span> <span class="n">null</span> <span class="n">then</span> <span class="p">[</span><span class="o">||</span><span class="p">],</span> <span class="n">s</span>
        <span class="k">else</span>
            <span class="n">let</span> <span class="n">x</span><span class="s1">' = x.FullName |&gt; SpiralFileSystem.standardize_path</span>
            <span class="o">//</span> <span class="n">trace</span> <span class="n">Verbose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"""Supervisor.proj_revalidate_owner / x.FullName: {x.FullName |&gt; SpiralSm.replace "</span><span class="se">\\</span><span class="s2">" "|"} / x': {x'}"""</span><span class="p">)</span> <span class="n">_locals</span>
            <span class="n">let</span> <span class="n">x_</span> <span class="o">=</span> <span class="n">x</span>
            <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span> <span class="n">FullName</span> <span class="o">=</span> <span class="n">x</span><span class="s1">' |}</span>
            <span class="k">if</span> <span class="n">Map</span><span class="o">.</span><span class="n">containsKey</span> <span class="n">x</span><span class="o">.</span><span class="n">FullName</span> <span class="n">s</span><span class="o">.</span><span class="n">packages</span> <span class="n">then</span> <span class="n">proj_validate</span> <span class="n">default_env</span> <span class="n">s</span> <span class="p">(</span><span class="n">HashSet</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">FullName</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">File</span><span class="o">.</span><span class="n">Exists</span><span class="p">(</span><span class="n">spiproj_suffix</span> <span class="n">x</span><span class="o">.</span><span class="n">FullName</span><span class="p">)</span> <span class="n">then</span> <span class="n">proj_open</span> <span class="n">default_env</span> <span class="n">s</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">FullName</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">loop</span> <span class="n">x_</span><span class="o">.</span><span class="n">Parent</span>
    <span class="n">loop</span> <span class="p">(</span><span class="n">Directory</span><span class="o">.</span><span class="n">GetParent</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>

<span class="n">let</span> <span class="n">file_delete</span> <span class="n">default_env</span> <span class="n">s</span> <span class="p">(</span><span class="n">files</span> <span class="p">:</span> <span class="n">string</span> <span class="p">[])</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">deleted_modules</span> <span class="o">=</span> <span class="n">HashSet</span><span class="p">()</span>
    <span class="n">let</span> <span class="n">deleted_packages</span> <span class="o">=</span> <span class="n">HashSet</span><span class="p">()</span>
    <span class="n">files</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">k</span> <span class="o">-&gt;</span>
        <span class="n">s</span><span class="o">.</span><span class="n">packages</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">k</span><span class="s1">' _ -&gt; if (spiproj_suffix k'</span><span class="p">)</span><span class="o">.</span><span class="n">StartsWith</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="n">then</span> <span class="n">deleted_packages</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">k</span><span class="s1">') |&gt; ignore)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">modules</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">k</span><span class="s1">' _ -&gt; if k'</span><span class="o">.</span><span class="n">StartsWith</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="n">then</span> <span class="n">deleted_modules</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">k</span><span class="s1">') |&gt; ignore)</span>
        <span class="p">)</span>
    <span class="n">let</span> <span class="n">modules</span> <span class="o">=</span> <span class="n">Seq</span><span class="o">.</span><span class="n">foldBack</span> <span class="n">Map</span><span class="o">.</span><span class="n">remove</span> <span class="n">deleted_modules</span> <span class="n">s</span><span class="o">.</span><span class="n">modules</span>
    <span class="n">let</span> <span class="n">packages</span> <span class="o">=</span> <span class="n">Seq</span><span class="o">.</span><span class="n">foldBack</span> <span class="n">Map</span><span class="o">.</span><span class="n">remove</span> <span class="n">deleted_packages</span> <span class="n">s</span><span class="o">.</span><span class="n">packages</span>
    <span class="n">let</span> <span class="n">dirty_packages</span> <span class="o">=</span> <span class="n">HashSet</span><span class="p">(</span><span class="n">deleted_packages</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">revalidate_parent</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">string</span><span class="p">)</span> <span class="o">=</span>
        <span class="n">trace</span> <span class="n">Verbose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"Supervisor.file_delete.revalidate_parent.loop / x.FullName: </span><span class="si">{x}</span><span class="s2">"</span><span class="p">)</span> <span class="n">_locals</span>
        <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">DirectoryInfo</span><span class="p">)</span> <span class="o">=</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;&gt;</span> <span class="n">null</span> <span class="n">then</span>
                <span class="n">let</span> <span class="n">x</span><span class="s1">' = x.FullName |&gt; SpiralFileSystem.standardize_path</span>
                <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">DirectoryInfo</span> <span class="n">x</span><span class="s1">'</span>
                <span class="k">if</span> <span class="n">Map</span><span class="o">.</span><span class="n">containsKey</span> <span class="n">x</span><span class="o">.</span><span class="n">FullName</span> <span class="n">s</span><span class="o">.</span><span class="n">packages</span> <span class="n">then</span> <span class="n">dirty_packages</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">FullName</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
                <span class="k">else</span> <span class="n">loop</span> <span class="n">x</span><span class="o">.</span><span class="n">Parent</span>
        <span class="n">loop</span><span class="p">(</span><span class="n">Directory</span><span class="o">.</span><span class="n">GetParent</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">Seq</span><span class="o">.</span><span class="n">iter</span> <span class="n">revalidate_parent</span> <span class="n">deleted_modules</span><span class="p">;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">iter</span> <span class="n">revalidate_parent</span> <span class="n">deleted_packages</span>
    <span class="n">Seq</span><span class="o">.</span><span class="n">toArray</span> <span class="n">deleted_modules</span><span class="p">,</span> <span class="n">proj_graph_update</span> <span class="n">default_env</span> <span class="p">{</span><span class="n">s</span> <span class="k">with</span> <span class="n">modules</span> <span class="o">=</span> <span class="n">modules</span><span class="p">;</span> <span class="n">packages</span> <span class="o">=</span> <span class="n">packages</span><span class="p">}</span> <span class="n">dirty_packages</span>

<span class="nb">type</span> <span class="n">AttentionState</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">modules</span> <span class="p">:</span> <span class="n">string</span> <span class="n">Set</span> <span class="o">*</span> <span class="n">string</span> <span class="nb">list</span>
    <span class="n">packages</span> <span class="p">:</span> <span class="n">string</span> <span class="n">Set</span> <span class="o">*</span> <span class="n">string</span> <span class="nb">list</span>
    <span class="n">old_packages</span> <span class="p">:</span> <span class="n">SchemaEnv</span>
    <span class="n">supervisor</span> <span class="p">:</span> <span class="n">SupervisorState</span>
    <span class="p">}</span>

<span class="n">let</span> <span class="n">attention_server</span> <span class="p">(</span><span class="n">errors</span> <span class="p">:</span> <span class="n">SupervisorErrorSources</span><span class="p">)</span> <span class="p">(</span><span class="n">req</span> <span class="p">:</span> <span class="n">_</span> <span class="n">Ch</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">push</span> <span class="n">path</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">o</span><span class="p">)</span> <span class="o">=</span> <span class="n">Set</span><span class="o">.</span><span class="n">add</span> <span class="n">path</span> <span class="n">s</span><span class="p">,</span> <span class="n">path</span> <span class="p">::</span> <span class="n">o</span>
    <span class="n">let</span> <span class="n">add</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">o</span><span class="p">)</span> <span class="n">l</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">foldBack</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">o</span> <span class="k">as</span> <span class="n">z</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">Set</span><span class="o">.</span><span class="n">contains</span> <span class="n">x</span> <span class="n">s</span> <span class="n">then</span> <span class="n">z</span> <span class="k">else</span> <span class="n">Set</span><span class="o">.</span><span class="n">add</span> <span class="n">x</span> <span class="n">s</span><span class="p">,</span> <span class="n">x</span> <span class="p">::</span> <span class="n">o</span><span class="p">)</span> <span class="n">l</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">o</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">update</span> <span class="p">(</span><span class="n">s</span> <span class="p">:</span> <span class="n">AttentionState</span><span class="p">)</span> <span class="p">(</span><span class="n">modules</span><span class="p">,</span><span class="n">packages</span><span class="p">,</span><span class="n">supervisor</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="n">modules</span> <span class="o">=</span> <span class="n">add</span> <span class="n">s</span><span class="o">.</span><span class="n">modules</span> <span class="n">modules</span><span class="p">;</span> <span class="n">packages</span> <span class="o">=</span> <span class="n">add</span> <span class="n">s</span><span class="o">.</span><span class="n">packages</span> <span class="n">packages</span><span class="p">;</span> <span class="n">supervisor</span> <span class="o">=</span> <span class="n">supervisor</span><span class="p">;</span> <span class="n">old_packages</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">supervisor</span><span class="o">.</span><span class="n">packages</span><span class="p">}</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="p">(</span><span class="n">s</span> <span class="p">:</span> <span class="n">AttentionState</span><span class="p">)</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">clear</span> <span class="n">uri</span> <span class="o">=</span>
            <span class="n">Hopac</span><span class="o">.</span><span class="n">start</span> <span class="p">(</span><span class="n">Ch</span><span class="o">.</span><span class="n">send</span> <span class="n">errors</span><span class="o">.</span><span class="n">tokenizer</span> <span class="p">{</span><span class="o">|</span><span class="n">uri</span><span class="o">=</span><span class="n">uri</span><span class="p">;</span> <span class="n">errors</span><span class="o">=</span><span class="p">[]</span><span class="o">|</span><span class="p">})</span>
            <span class="n">Hopac</span><span class="o">.</span><span class="n">start</span> <span class="p">(</span><span class="n">Ch</span><span class="o">.</span><span class="n">send</span> <span class="n">errors</span><span class="o">.</span><span class="n">parser</span> <span class="p">{</span><span class="o">|</span><span class="n">uri</span><span class="o">=</span><span class="n">uri</span><span class="p">;</span> <span class="n">errors</span><span class="o">=</span><span class="p">[]</span><span class="o">|</span><span class="p">})</span>
            <span class="n">Hopac</span><span class="o">.</span><span class="n">start</span> <span class="p">(</span><span class="n">Ch</span><span class="o">.</span><span class="n">send</span> <span class="n">errors</span><span class="o">.</span><span class="n">typer</span> <span class="p">{</span><span class="o">|</span><span class="n">uri</span><span class="o">=</span><span class="n">uri</span><span class="p">;</span> <span class="n">errors</span><span class="o">=</span><span class="p">[]</span><span class="o">|</span><span class="p">})</span>
        <span class="n">let</span> <span class="n">send_tokenizer</span> <span class="n">uri</span> <span class="n">x</span> <span class="o">=</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">start</span> <span class="p">(</span><span class="n">Ch</span><span class="o">.</span><span class="n">send</span> <span class="n">errors</span><span class="o">.</span><span class="n">tokenizer</span> <span class="p">{</span><span class="o">|</span><span class="n">uri</span><span class="o">=</span><span class="n">uri</span><span class="p">;</span> <span class="n">errors</span><span class="o">=</span><span class="n">x</span><span class="o">|</span><span class="p">})</span>
        <span class="n">let</span> <span class="n">clear_parse</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">start</span> <span class="p">(</span><span class="n">Ch</span><span class="o">.</span><span class="n">send</span> <span class="n">errors</span><span class="o">.</span><span class="n">parser</span> <span class="p">{</span><span class="o">|</span><span class="n">uri</span><span class="o">=</span><span class="n">uri</span><span class="p">;</span> <span class="n">errors</span><span class="o">=</span><span class="p">[]</span><span class="o">|</span><span class="p">})</span>
        <span class="n">let</span> <span class="n">clear_typer</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">start</span> <span class="p">(</span><span class="n">Ch</span><span class="o">.</span><span class="n">send</span> <span class="n">errors</span><span class="o">.</span><span class="n">typer</span> <span class="p">{</span><span class="o">|</span><span class="n">uri</span><span class="o">=</span><span class="n">uri</span><span class="p">;</span> <span class="n">errors</span><span class="o">=</span><span class="p">[]</span><span class="o">|</span><span class="p">})</span>
        <span class="n">let</span> <span class="n">clear_old_package</span> <span class="n">x</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">x</span> <span class="n">s</span><span class="o">.</span><span class="n">old_packages</span> <span class="o">|&gt;</span> <span class="n">Option</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="o">=</span> <span class="n">function</span>
                <span class="o">|</span> <span class="n">FileHierarchy</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">_</span><span class="p">,(</span><span class="n">_</span><span class="p">,</span><span class="n">pdir</span><span class="p">),</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">clear</span> <span class="p">(</span><span class="n">file_uri</span> <span class="n">pdir</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">FileHierarchy</span><span class="o">.</span><span class="n">Directory</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">l</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span> <span class="n">l</span>
            <span class="ow">and</span> <span class="nb">list</span> <span class="n">l</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="n">loop</span> <span class="n">l</span>
            <span class="nb">list</span> <span class="n">x</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">modules</span>
            <span class="p">)</span>

        <span class="n">let</span> <span class="n">inline</span> <span class="n">body</span> <span class="n">uri</span> <span class="n">interrupt</span> <span class="n">ers</span> <span class="n">ers</span><span class="s1">' src next =</span>
            <span class="n">Ch</span><span class="o">.</span><span class="n">Try</span><span class="o">.</span><span class="n">take</span> <span class="n">req</span> <span class="o">&gt;&gt;=</span> <span class="n">function</span>
            <span class="o">|</span> <span class="n">Some</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">interrupt</span> <span class="n">x</span>
            <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span>
                <span class="k">if</span> <span class="n">List</span><span class="o">.</span><span class="n">isEmpty</span> <span class="n">ers</span> <span class="n">then</span> <span class="nb">next</span> <span class="n">ers</span><span class="s1">'</span>
                <span class="k">else</span>
                    <span class="n">let</span> <span class="n">ers</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">append</span> <span class="n">ers</span> <span class="n">ers</span><span class="s1">'</span>
                    <span class="n">Hopac</span><span class="o">.</span><span class="n">start</span> <span class="p">(</span><span class="n">Ch</span><span class="o">.</span><span class="n">send</span> <span class="n">src</span> <span class="p">{</span><span class="o">|</span><span class="n">uri</span><span class="o">=</span><span class="n">uri</span><span class="p">;</span> <span class="n">errors</span><span class="o">=</span><span class="n">ers</span><span class="o">|</span><span class="p">})</span>
                    <span class="nb">next</span> <span class="n">ers</span>

        <span class="n">let</span> <span class="n">loop_module</span> <span class="p">(</span><span class="n">s</span> <span class="p">:</span> <span class="n">AttentionState</span><span class="p">)</span> <span class="n">mpath</span> <span class="p">(</span><span class="n">m</span> <span class="p">:</span> <span class="n">ModuleState</span><span class="p">)</span> <span class="o">=</span>
            <span class="n">let</span> <span class="n">mpath</span><span class="s1">' = mpath |&gt; SpiralFileSystem.standardize_path</span>
            <span class="n">let</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">file_uri</span> <span class="n">mpath</span>
            <span class="n">trace</span> <span class="n">Verbose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"Supervisor.attention_server.loop.loop_module / mpath: </span><span class="si">{mpath}</span><span class="s2"> / mpath': {mpath'} / uri: </span><span class="si">{uri}</span><span class="s2">"</span><span class="p">)</span> <span class="n">_locals</span>
            <span class="n">let</span> <span class="n">mpath</span> <span class="o">=</span> <span class="n">mpath</span><span class="s1">'</span>
            

            
            <span class="n">let</span> <span class="n">interrupt</span> <span class="n">x</span> <span class="o">=</span> <span class="n">loop</span> <span class="p">(</span><span class="n">update</span> <span class="p">{</span><span class="n">s</span> <span class="k">with</span> <span class="n">modules</span><span class="o">=</span><span class="n">push</span> <span class="n">mpath</span> <span class="n">s</span><span class="o">.</span><span class="n">modules</span><span class="p">}</span> <span class="n">x</span><span class="p">)</span>
            <span class="n">let</span> <span class="n">rec</span> <span class="n">bundler</span> <span class="p">(</span><span class="n">r</span> <span class="p">:</span> <span class="n">BlockBundleState</span><span class="p">)</span> <span class="n">ers</span><span class="s1">' = r &gt;&gt;= function</span>
                <span class="o">|</span> <span class="n">Cons</span><span class="p">((</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">),</span><span class="n">rs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">body</span> <span class="n">uri</span> <span class="n">interrupt</span> <span class="n">x</span><span class="o">.</span><span class="n">errors</span> <span class="n">ers</span><span class="s1">' errors.parser (bundler rs)</span>
                <span class="o">|</span> <span class="n">Nil</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="n">s</span>
            <span class="n">send_tokenizer</span> <span class="n">uri</span> <span class="n">m</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">errors</span>
            <span class="n">clear_parse</span> <span class="n">uri</span>
            <span class="n">clear_typer</span> <span class="n">uri</span>
            <span class="n">bundler</span> <span class="n">m</span><span class="o">.</span><span class="n">bundler</span> <span class="p">[]</span>

        <span class="n">let</span> <span class="n">rec</span> <span class="n">loop_package</span> <span class="p">(</span><span class="n">s</span> <span class="p">:</span> <span class="n">AttentionState</span><span class="p">)</span> <span class="n">pdir</span> <span class="o">=</span> <span class="n">function</span>
            <span class="o">|</span> <span class="p">(</span><span class="n">mpath</span><span class="p">,</span><span class="n">l</span><span class="p">)</span> <span class="p">::</span> <span class="n">ls</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">mpath</span><span class="s1">' = mpath |&gt; SpiralFileSystem.standardize_path</span>
                <span class="n">let</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">file_uri</span> <span class="n">mpath</span>
                <span class="n">let</span> <span class="n">pdir</span><span class="s1">' = pdir |&gt; SpiralFileSystem.standardize_path</span>
                <span class="n">trace</span> <span class="n">Verbose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"Supervisor.attention_server.loop.loop_package / mpath: </span><span class="si">{mpath}</span><span class="s2"> / mpath': {mpath'} / uri: </span><span class="si">{uri}</span><span class="s2"> / pdir: </span><span class="si">{pdir}</span><span class="s2"> / pdir': {pdir'}"</span><span class="p">)</span> <span class="n">_locals</span>
                <span class="n">let</span> <span class="n">interrupt</span> <span class="n">x</span> <span class="o">=</span> <span class="n">loop</span> <span class="p">(</span><span class="n">update</span> <span class="p">{</span><span class="n">s</span> <span class="k">with</span> <span class="n">packages</span><span class="o">=</span><span class="n">push</span> <span class="n">pdir</span> <span class="n">s</span><span class="o">.</span><span class="n">packages</span><span class="p">}</span> <span class="n">x</span><span class="p">)</span>
                <span class="n">let</span> <span class="n">rec</span> <span class="n">typer</span> <span class="p">(</span><span class="n">r</span> <span class="p">:</span> <span class="n">TypecheckerStateValue</span> <span class="n">Stream</span><span class="p">)</span> <span class="n">ers</span><span class="s1">' = r &gt;&gt;= function</span>
                    <span class="o">|</span> <span class="n">Cons</span><span class="p">((</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">_</span><span class="p">),</span><span class="n">rs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">body</span> <span class="n">uri</span> <span class="n">interrupt</span> <span class="n">x</span><span class="o">.</span><span class="n">errors</span> <span class="n">ers</span><span class="s1">' errors.typer (typer rs)</span>
                    <span class="o">|</span> <span class="n">Nil</span> <span class="o">-&gt;</span> <span class="n">loop_package</span> <span class="n">s</span> <span class="n">pdir</span><span class="s1">' ls</span>
                <span class="n">let</span> <span class="n">rec</span> <span class="n">bundler</span> <span class="p">(</span><span class="n">r</span> <span class="p">:</span> <span class="n">BlockBundleState</span><span class="p">)</span> <span class="n">ers</span><span class="s1">' = r &gt;&gt;= function</span>
                    <span class="o">|</span> <span class="n">Cons</span><span class="p">((</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">),</span><span class="n">rs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">body</span> <span class="n">uri</span> <span class="n">interrupt</span> <span class="n">x</span><span class="o">.</span><span class="n">errors</span> <span class="n">ers</span><span class="s1">' errors.parser (bundler rs)</span>
                    <span class="o">|</span> <span class="n">Nil</span> <span class="o">-&gt;</span> <span class="n">clear_typer</span> <span class="n">uri</span><span class="p">;</span> <span class="n">typer</span> <span class="n">l</span> <span class="p">[]</span>
                <span class="n">let</span> <span class="n">m</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">supervisor</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="p">[</span><span class="n">mpath</span><span class="s1">']</span>
                <span class="n">send_tokenizer</span> <span class="n">uri</span> <span class="n">m</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">errors</span>
                <span class="n">clear_parse</span> <span class="n">uri</span>
                <span class="n">bundler</span> <span class="n">m</span><span class="o">.</span><span class="n">bundler</span> <span class="p">[]</span>
            <span class="o">|</span> <span class="p">[]</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="n">s</span>

        <span class="n">let</span> <span class="n">package</span> <span class="n">s</span> <span class="o">=</span>
            <span class="k">match</span> <span class="n">s</span><span class="o">.</span><span class="n">packages</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">se</span><span class="p">,</span><span class="n">x</span> <span class="p">::</span> <span class="n">xs</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">x</span><span class="s1">' = x |&gt; SpiralFileSystem.standardize_path</span>
                <span class="n">trace</span> <span class="n">Verbose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"Supervisor.attention_server.loop.package / x: </span><span class="si">{x}</span><span class="s2"> / x': {x'}"</span><span class="p">)</span> <span class="n">_locals</span>
                <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="s1">'</span>
                <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span> <span class="k">with</span> <span class="n">packages</span><span class="o">=</span><span class="n">Set</span><span class="o">.</span><span class="n">remove</span> <span class="n">x</span> <span class="n">se</span><span class="p">,</span><span class="n">xs</span><span class="p">}</span>
                <span class="n">let</span> <span class="n">package_errors</span> <span class="o">=</span>
                    <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">x</span> <span class="n">s</span><span class="o">.</span><span class="n">supervisor</span><span class="o">.</span><span class="n">packages</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">Some</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">concat</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">errors_parse</span><span class="p">;</span> <span class="n">v</span><span class="o">.</span><span class="n">errors_modules</span><span class="p">;</span> <span class="n">v</span><span class="o">.</span><span class="n">errors_packages</span><span class="p">]</span>
                    <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="p">[]</span>
                <span class="n">Hopac</span><span class="o">.</span><span class="n">start</span> <span class="p">(</span><span class="n">Ch</span><span class="o">.</span><span class="n">send</span> <span class="n">errors</span><span class="o">.</span><span class="n">package</span> <span class="p">({</span><span class="o">|</span><span class="n">uri</span><span class="o">=</span><span class="n">file_uri</span><span class="p">(</span><span class="n">spiproj_suffix</span> <span class="n">x</span><span class="p">);</span> <span class="n">errors</span><span class="o">=</span><span class="n">package_errors</span><span class="o">|</span><span class="p">}))</span>
                <span class="n">clear_old_package</span> <span class="n">x</span>
                <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">x</span> <span class="p">(</span><span class="n">fst</span> <span class="n">s</span><span class="o">.</span><span class="n">supervisor</span><span class="o">.</span><span class="n">package_ids</span><span class="p">)</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">Some</span> <span class="n">uid</span> <span class="o">-&gt;</span>
                    <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">uid</span> <span class="n">s</span><span class="o">.</span><span class="n">supervisor</span><span class="o">.</span><span class="n">packages_infer</span><span class="o">.</span><span class="n">ok</span> <span class="k">with</span>
                    <span class="o">|</span> <span class="n">Some</span> <span class="n">v</span> <span class="o">-&gt;</span>
                        <span class="n">let</span> <span class="n">path_tcvals</span> <span class="o">=</span>
                            <span class="n">let</span> <span class="n">uids_file</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">uids_file</span>
                            <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="n">x</span> <span class="n">s</span> <span class="o">=</span>
                                <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
                                <span class="o">|</span> <span class="n">ProjFilesTree</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span><span class="n">path</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span>
                                    <span class="n">let</span> <span class="n">path</span><span class="s1">' = path |&gt; SpiralFileSystem.standardize_path</span>
                                    <span class="n">trace</span> <span class="n">Verbose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"Supervisor.attention_server.loop | WDiff.File(mid,path,_) / path: </span><span class="si">{path}</span><span class="s2"> / path': {path'}"</span><span class="p">)</span> <span class="n">_locals</span>
                                    <span class="p">(</span><span class="n">path</span><span class="s1">', (fst uids_file.[mid]).result) :: s</span>
                                <span class="o">|</span> <span class="n">ProjFilesTree</span><span class="o">.</span><span class="n">Directory</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">l</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span> <span class="n">l</span> <span class="n">s</span>
                            <span class="ow">and</span> <span class="nb">list</span> <span class="n">l</span> <span class="n">s</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">foldBack</span> <span class="n">loop</span> <span class="n">l</span> <span class="n">s</span>
                            <span class="nb">list</span> <span class="n">v</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">tree</span> <span class="p">[]</span>
                        <span class="n">loop_package</span> <span class="n">s</span> <span class="n">x</span> <span class="n">path_tcvals</span>
                    <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="n">s</span>
                <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="n">s</span>
            <span class="o">|</span> <span class="n">_</span><span class="p">,</span> <span class="p">[]</span> <span class="o">-&gt;</span> <span class="n">req</span> <span class="o">&gt;&gt;=</span> <span class="p">(</span><span class="n">update</span> <span class="n">s</span> <span class="o">&gt;&gt;</span> <span class="n">loop</span><span class="p">)</span>

        <span class="k">match</span> <span class="n">s</span><span class="o">.</span><span class="n">modules</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">se</span><span class="p">,</span><span class="n">x</span> <span class="p">::</span> <span class="n">xs</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">s</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span> <span class="k">with</span> <span class="n">modules</span><span class="o">=</span><span class="n">Set</span><span class="o">.</span><span class="n">remove</span> <span class="n">x</span> <span class="n">se</span><span class="p">,</span><span class="n">xs</span><span class="p">}</span>
            <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">x</span> <span class="n">s</span><span class="o">.</span><span class="n">supervisor</span><span class="o">.</span><span class="n">modules</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">Some</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">loop_module</span> <span class="n">s</span> <span class="n">x</span> <span class="n">v</span>
            <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">clear</span> <span class="p">(</span><span class="n">file_uri</span> <span class="n">x</span><span class="p">);</span> <span class="n">package</span> <span class="n">s</span>
        <span class="o">|</span> <span class="n">_</span><span class="p">,[]</span> <span class="o">-&gt;</span> <span class="n">package</span> <span class="n">s</span>

    <span class="p">(</span><span class="n">req</span> <span class="o">&gt;&gt;=</span> <span class="n">fun</span> <span class="p">(</span><span class="n">modules</span><span class="p">,</span><span class="n">packages</span><span class="p">,</span><span class="n">supervisor</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="n">loop</span> <span class="p">{</span><span class="n">modules</span> <span class="o">=</span> <span class="n">Set</span><span class="o">.</span><span class="n">ofArray</span> <span class="n">modules</span><span class="p">,</span> <span class="n">Array</span><span class="o">.</span><span class="n">toList</span> <span class="n">modules</span><span class="p">;</span> <span class="n">packages</span> <span class="o">=</span> <span class="n">Set</span><span class="o">.</span><span class="n">ofArray</span> <span class="n">packages</span><span class="p">,</span> <span class="n">Array</span><span class="o">.</span><span class="n">toList</span> <span class="n">packages</span><span class="p">;</span> <span class="n">supervisor</span> <span class="o">=</span> <span class="n">supervisor</span><span class="p">;</span> <span class="n">old_packages</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">}</span>
        <span class="p">)</span>

<span class="n">let</span> <span class="n">show_position</span> <span class="p">(</span><span class="n">s</span> <span class="p">:</span> <span class="n">SupervisorState</span><span class="p">)</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">Range</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="n">fst</span> <span class="n">x</span><span class="o">.</span><span class="n">range</span><span class="p">)</span><span class="o">.</span><span class="n">line</span>
    <span class="n">let</span> <span class="n">col</span> <span class="o">=</span> <span class="p">(</span><span class="n">fst</span> <span class="n">x</span><span class="o">.</span><span class="n">range</span><span class="p">)</span><span class="o">.</span><span class="n">character</span>
    <span class="n">let</span> <span class="n">er_code</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">path</span><span class="p">]</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">lines_text</span><span class="o">.</span><span class="p">[</span><span class="n">line</span><span class="p">]</span>
    <span class="n">System</span><span class="o">.</span><span class="n">Text</span><span class="o">.</span><span class="n">StringBuilder</span><span class="p">()</span>
        <span class="o">.</span><span class="n">AppendLine</span><span class="p">(</span><span class="n">sprintf</span> <span class="s2">"Error trace on line: </span><span class="si">%i</span><span class="s2">, column: </span><span class="si">%i</span><span class="s2"> in module: </span><span class="si">%s</span><span class="s2">."</span> <span class="p">(</span><span class="n">line</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="n">col</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="n">x</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="o">.</span><span class="n">AppendLine</span><span class="p">(</span><span class="n">er_code</span><span class="p">)</span>
        <span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="s1">' '</span><span class="p">,</span><span class="n">col</span><span class="p">)</span>
        <span class="o">.</span><span class="n">AppendLine</span><span class="p">(</span><span class="s2">"^"</span><span class="p">)</span>
        <span class="o">.</span><span class="n">ToString</span><span class="p">()</span>

<span class="n">let</span> <span class="n">show_trace</span> <span class="n">s</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">Trace</span><span class="p">)</span> <span class="p">(</span><span class="n">msg</span> <span class="p">:</span> <span class="n">string</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="p">(</span><span class="n">l</span> <span class="p">:</span> <span class="n">Trace</span><span class="p">)</span> <span class="o">=</span> <span class="n">function</span>
        <span class="o">|</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">Range</span><span class="p">)</span> <span class="p">::</span> <span class="n">xs</span> <span class="o">-&gt;</span>
            <span class="k">match</span> <span class="n">l</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">x</span><span class="s1">' :: _ when x.path = x'</span><span class="o">.</span><span class="n">path</span> <span class="o">&amp;&amp;</span> <span class="n">fst</span> <span class="n">x</span><span class="o">.</span><span class="n">range</span> <span class="o">=</span> <span class="n">fst</span> <span class="n">x</span><span class="s1">'.range -&gt; loop l xs</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="p">(</span><span class="n">x</span> <span class="p">::</span> <span class="n">l</span><span class="p">)</span> <span class="n">xs</span>
        <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">l</span>
    <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">show_position</span> <span class="n">s</span><span class="p">)</span> <span class="p">(</span><span class="n">loop</span> <span class="p">[]</span> <span class="n">x</span><span class="p">),</span> <span class="n">msg</span>

<span class="nb">type</span> <span class="n">BuildResult</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">BuildOk</span> <span class="n">of</span> <span class="p">{</span><span class="o">|</span><span class="n">code</span><span class="p">:</span> <span class="n">string</span><span class="p">;</span> <span class="n">file_extension</span> <span class="p">:</span> <span class="n">string</span><span class="o">|</span><span class="p">}</span> <span class="nb">list</span>
    <span class="o">|</span> <span class="n">BuildErrorTrace</span> <span class="n">of</span> <span class="n">string</span> <span class="nb">list</span> <span class="o">*</span> <span class="n">string</span>
    <span class="o">|</span> <span class="n">BuildFatalError</span> <span class="n">of</span> <span class="n">string</span>
    <span class="o">|</span> <span class="n">BuildSkip</span>

<span class="n">let</span> <span class="n">workspaceRoot</span> <span class="o">=</span> <span class="n">SpiralFileSystem</span><span class="o">.</span><span class="n">get_workspace_root</span> <span class="p">()</span>
<span class="n">let</span> <span class="n">targetDir</span> <span class="o">=</span> <span class="n">workspaceRoot</span> <span class="o">&lt;/&gt;</span> <span class="s2">"target/spiral_Eval"</span>
<span class="n">let</span> <span class="n">traceDir</span> <span class="o">=</span> <span class="n">targetDir</span> <span class="o">&lt;/&gt;</span> <span class="s2">"supervisor_trace"</span>
<span class="n">let</span> <span class="nb">dir</span> <span class="n">uri</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">result</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">FileInfo</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">Uri</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span><span class="o">.</span><span class="n">LocalPath</span><span class="p">)</span><span class="o">.</span><span class="n">Directory</span><span class="o">.</span><span class="n">FullName</span>
    <span class="n">let</span> <span class="n">result</span><span class="s1">' = result |&gt; SpiralFileSystem.standardize_path</span>
    <span class="n">trace</span> <span class="n">Verbose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"Supervisor.dir / uri: </span><span class="si">{uri}</span><span class="s2"> / result: </span><span class="si">{result}</span><span class="s2"> / result': {result'}"</span><span class="p">)</span> <span class="n">_locals</span>
    <span class="n">result</span><span class="s1">'</span>
<span class="n">let</span> <span class="n">file</span> <span class="n">uri</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">result</span> <span class="o">=</span>
        <span class="k">try</span>
            <span class="n">System</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">FileInfo</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">Uri</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span><span class="o">.</span><span class="n">LocalPath</span><span class="p">)</span><span class="o">.</span><span class="n">FullName</span>
        <span class="k">with</span> <span class="n">ex</span> <span class="o">-&gt;</span>
            <span class="n">trace</span> <span class="n">Verbose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"Supervisor.file / uri: </span><span class="si">{uri}</span><span class="s2"> / ex: %A</span><span class="si">{ex}</span><span class="s2">"</span><span class="p">)</span> <span class="n">_locals</span>
            <span class="n">uri</span>
    <span class="n">let</span> <span class="n">result</span><span class="s1">' = result |&gt; SpiralFileSystem.standardize_path</span>
    <span class="o">//</span> <span class="n">let</span> <span class="n">result</span> <span class="o">=</span> <span class="n">result</span> <span class="o">|&gt;</span> <span class="n">SpiralSm</span><span class="o">.</span><span class="n">replace</span> <span class="s2">"</span><span class="se">\\</span><span class="s2">"</span> <span class="s2">"|"</span>
    <span class="o">//</span> <span class="n">trace</span> <span class="n">Verbose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"Supervisor.file / uri: </span><span class="si">{uri}</span><span class="s2"> / result: </span><span class="si">{result}</span><span class="s2"> / result': {result'}"</span><span class="p">)</span> <span class="n">_locals</span>
    <span class="n">result</span><span class="s1">'</span>
<span class="n">let</span> <span class="n">supervisor_server</span> <span class="p">(</span><span class="n">default_env</span> <span class="p">:</span> <span class="n">DefaultEnv</span><span class="p">)</span> <span class="n">atten</span> <span class="p">(</span><span class="n">errors</span> <span class="p">:</span> <span class="n">SupervisorErrorSources</span><span class="p">)</span> <span class="n">req</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">fatal</span> <span class="n">x</span> <span class="o">=</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">start</span> <span class="p">(</span><span class="n">Ch</span><span class="o">.</span><span class="n">send</span> <span class="n">errors</span><span class="o">.</span><span class="n">fatal</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">handle_packages</span> <span class="p">(</span><span class="n">dirty_packages</span><span class="p">,</span><span class="n">s</span><span class="p">)</span> <span class="o">=</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">start</span> <span class="p">(</span><span class="n">Ch</span><span class="o">.</span><span class="n">send</span> <span class="n">atten</span> <span class="p">([</span><span class="o">||</span><span class="p">],</span><span class="n">dirty_packages</span><span class="p">,</span><span class="n">s</span><span class="p">));</span> <span class="n">s</span>
    <span class="n">let</span> <span class="n">handle_file_packages</span> <span class="n">file</span> <span class="p">(</span><span class="n">dirty_packages</span><span class="p">,</span><span class="n">s</span><span class="p">)</span> <span class="o">=</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">start</span> <span class="p">(</span><span class="n">Ch</span><span class="o">.</span><span class="n">send</span> <span class="n">atten</span> <span class="p">([</span><span class="o">|</span><span class="n">file</span><span class="o">|</span><span class="p">],</span><span class="n">dirty_packages</span><span class="p">,</span><span class="n">s</span><span class="p">));</span> <span class="n">s</span>
    <span class="n">let</span> <span class="n">handle_files_packages</span> <span class="p">(</span><span class="n">dirty_files</span><span class="p">,(</span><span class="n">dirty_packages</span><span class="p">,</span><span class="n">s</span><span class="p">))</span> <span class="o">=</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">start</span> <span class="p">(</span><span class="n">Ch</span><span class="o">.</span><span class="n">send</span> <span class="n">atten</span> <span class="p">(</span><span class="n">dirty_files</span><span class="p">,</span><span class="n">dirty_packages</span><span class="p">,</span><span class="n">s</span><span class="p">));</span> <span class="n">s</span>
    <span class="n">let</span> <span class="n">loop</span> <span class="p">(</span><span class="n">s</span> <span class="p">:</span> <span class="n">SupervisorState</span><span class="p">)</span> <span class="o">=</span> <span class="n">req</span> <span class="o">&gt;&gt;-</span> <span class="n">function</span>
        <span class="o">|</span> <span class="n">ProjectFileChange</span> <span class="n">x</span> <span class="o">|</span> <span class="n">ProjectFileOpen</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">proj_open</span> <span class="n">default_env</span> <span class="n">s</span> <span class="p">(</span><span class="nb">dir</span> <span class="n">x</span><span class="o">.</span><span class="n">uri</span><span class="p">,</span><span class="n">Some</span> <span class="n">x</span><span class="o">.</span><span class="n">spiprojText</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">handle_packages</span>
        <span class="o">|</span> <span class="n">FileOpen</span> <span class="n">x</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">file</span> <span class="o">=</span> <span class="n">file</span> <span class="n">x</span><span class="o">.</span><span class="n">uri</span>
            <span class="o">//</span> <span class="n">trace</span> <span class="n">Verbose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"Supervisor.supervisor_server.loop.FileOpen / x: %A</span><span class="si">{x}</span><span class="s2"> / file: </span><span class="si">{file}</span><span class="s2">"</span><span class="p">)</span> <span class="n">_locals</span>
            <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">file</span> <span class="n">s</span><span class="o">.</span><span class="n">modules</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">Some</span> <span class="n">m</span> <span class="o">-&gt;</span> <span class="n">wdiff_module_all</span> <span class="n">default_env</span> <span class="n">m</span> <span class="n">x</span><span class="o">.</span><span class="n">spiText</span>
            <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">wdiff_module_init_all</span> <span class="n">default_env</span> <span class="p">(</span><span class="n">is_top_down</span> <span class="n">file</span><span class="p">)</span> <span class="n">x</span><span class="o">.</span><span class="n">spiText</span>
            <span class="o">|&gt;</span> <span class="n">fun</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">proj_revalidate_owner</span> <span class="n">default_env</span> <span class="p">{</span><span class="n">s</span> <span class="k">with</span> <span class="n">modules</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">file</span> <span class="n">v</span> <span class="n">s</span><span class="o">.</span><span class="n">modules</span><span class="p">}</span> <span class="n">file</span>
            <span class="o">|&gt;</span> <span class="n">handle_file_packages</span> <span class="n">file</span>
        <span class="o">|</span> <span class="n">FileChange</span> <span class="n">x</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">file</span> <span class="o">=</span> <span class="n">file</span> <span class="n">x</span><span class="o">.</span><span class="n">uri</span>
            <span class="n">trace</span> <span class="n">Verbose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"Supervisor.supervisor_server.loop.FileChange / x: %A</span><span class="si">{x}</span><span class="s2"> / file: </span><span class="si">{file}</span><span class="s2">"</span><span class="p">)</span> <span class="n">_locals</span>
            <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">file</span> <span class="n">s</span><span class="o">.</span><span class="n">modules</span> <span class="k">with</span>
            <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">fatal</span> <span class="s2">"It is not possible to apply a change to a file that is not present in the environment. Try reopening it in the editor."</span><span class="p">;</span> <span class="n">s</span>
            <span class="o">|</span> <span class="n">Some</span> <span class="n">m</span> <span class="o">-&gt;</span>
                <span class="k">match</span> <span class="n">wdiff_module_edit</span> <span class="n">default_env</span> <span class="n">m</span> <span class="n">x</span><span class="o">.</span><span class="n">spiEdit</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">proj_revalidate_owner</span> <span class="n">default_env</span> <span class="p">{</span><span class="n">s</span> <span class="k">with</span> <span class="n">modules</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="n">file</span> <span class="n">v</span> <span class="n">s</span><span class="o">.</span><span class="n">modules</span><span class="p">}</span> <span class="n">file</span> <span class="o">|&gt;</span> <span class="n">handle_file_packages</span> <span class="n">file</span>
                <span class="o">|</span> <span class="n">Result</span><span class="o">.</span><span class="n">Error</span> <span class="n">er</span> <span class="o">-&gt;</span> <span class="n">fatal</span> <span class="n">er</span><span class="p">;</span> <span class="n">s</span>
        <span class="o">|</span> <span class="n">FileDelete</span> <span class="n">x</span> <span class="o">-&gt;</span>
            <span class="n">trace</span> <span class="n">Verbose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"Supervisor.supervisor_server.loop.FileDelete / x: </span><span class="si">{x}</span><span class="s2">"</span><span class="p">)</span> <span class="n">_locals</span>
            <span class="n">file_delete</span> <span class="n">default_env</span> <span class="n">s</span> <span class="p">(</span><span class="n">Array</span><span class="o">.</span><span class="n">map</span> <span class="n">file</span> <span class="n">x</span><span class="o">.</span><span class="n">uris</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">handle_files_packages</span>
        <span class="o">|</span> <span class="n">ProjectFileLinks</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">res</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">l</span> <span class="o">=</span>
                <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="p">(</span><span class="nb">dir</span> <span class="n">x</span><span class="o">.</span><span class="n">uri</span><span class="p">)</span> <span class="n">s</span><span class="o">.</span><span class="n">packages</span> <span class="k">with</span>
                <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="p">[]</span>
                <span class="o">|</span> <span class="n">Some</span> <span class="n">x</span> <span class="o">-&gt;</span>
                    <span class="n">let</span> <span class="n">mutable</span> <span class="n">l</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">packages</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span>
                        <span class="n">let</span> <span class="n">r</span><span class="p">,</span><span class="nb">dir</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">dir</span>
                        <span class="n">trace</span> <span class="n">Verbose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"Supervisor.supervisor_server.ProjectFileLinks / x.schema.packages |&gt; List.iter / dir: </span><span class="si">{dir}</span><span class="s2">"</span><span class="p">)</span> <span class="n">_locals</span>
                        <span class="k">if</span> <span class="n">Map</span><span class="o">.</span><span class="n">containsKey</span> <span class="nb">dir</span> <span class="n">s</span><span class="o">.</span><span class="n">packages</span> <span class="n">then</span> <span class="n">l</span> <span class="o">&lt;-</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">file_uri</span> <span class="p">(</span><span class="n">spiproj_suffix</span> <span class="nb">dir</span><span class="p">))</span> <span class="p">::</span> <span class="n">l</span>
                        <span class="p">)</span>
                    <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="o">=</span> <span class="n">function</span>
                        <span class="o">|</span> <span class="n">FileHierarchy</span><span class="o">.</span><span class="n">Directory</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">l</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span> <span class="n">l</span>
                        <span class="o">|</span> <span class="n">FileHierarchy</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">_</span><span class="p">,(</span><span class="n">r</span><span class="p">,</span><span class="n">path</span><span class="p">),</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span>
                            <span class="n">trace</span> <span class="n">Verbose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"Supervisor.supervisor_server.ProjectFileLinks.loop | SpiProj.FileHierarchy.File(_,(r,path),_) / path: </span><span class="si">{path}</span><span class="s2">"</span><span class="p">)</span> <span class="n">_locals</span>
                            <span class="k">if</span> <span class="n">Map</span><span class="o">.</span><span class="n">containsKey</span> <span class="n">path</span> <span class="n">s</span><span class="o">.</span><span class="n">modules</span> <span class="n">then</span> <span class="n">l</span> <span class="o">&lt;-</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">file_uri</span> <span class="n">path</span><span class="p">)</span> <span class="p">::</span> <span class="n">l</span>
                    <span class="ow">and</span> <span class="nb">list</span> <span class="n">l</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="n">loop</span> <span class="n">l</span>
                    <span class="nb">list</span> <span class="n">x</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">modules</span>
                    <span class="n">l</span>
            <span class="n">Hopac</span><span class="o">.</span><span class="n">start</span> <span class="p">(</span><span class="n">IVar</span><span class="o">.</span><span class="n">fill</span> <span class="n">res</span> <span class="n">l</span><span class="p">)</span>
            <span class="n">s</span>
        <span class="o">|</span> <span class="n">ProjectCodeActions</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">res</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">z</span> <span class="o">=</span>
                <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="p">(</span><span class="nb">dir</span> <span class="n">x</span><span class="o">.</span><span class="n">uri</span><span class="p">)</span> <span class="n">s</span><span class="o">.</span><span class="n">packages</span> <span class="k">with</span>
                <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="p">[]</span>
                <span class="o">|</span> <span class="n">Some</span> <span class="n">x</span> <span class="o">-&gt;</span>
                    <span class="n">let</span> <span class="n">mutable</span> <span class="n">z</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">let</span> <span class="n">actions_dir</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">path</span><span class="p">)</span> <span class="o">=</span>
                        <span class="k">match</span> <span class="n">r</span> <span class="k">with</span>
                        <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="p">()</span>
                        <span class="o">|</span> <span class="n">Some</span> <span class="n">r</span> <span class="o">-&gt;</span>
                            <span class="k">if</span> <span class="n">Directory</span><span class="o">.</span><span class="n">Exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="n">then</span>
                                <span class="n">z</span> <span class="o">&lt;-</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">RenameDirectory</span> <span class="p">{</span><span class="o">|</span><span class="n">dirPath</span><span class="o">=</span><span class="n">path</span><span class="p">;</span> <span class="n">target</span><span class="o">=</span><span class="n">null</span><span class="p">;</span> <span class="n">validate_as_file</span><span class="o">=</span><span class="n">false</span><span class="o">|</span><span class="p">})</span> <span class="p">::</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">DeleteDirectory</span> <span class="p">{</span><span class="o">|</span><span class="n">dirPath</span><span class="o">=</span><span class="n">path</span><span class="p">;</span> <span class="nb">range</span><span class="o">=</span><span class="n">r</span><span class="o">|</span><span class="p">})</span> <span class="p">::</span> <span class="n">z</span>
                            <span class="k">else</span>
                                <span class="n">z</span> <span class="o">&lt;-</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">CreateDirectory</span> <span class="p">{</span><span class="o">|</span><span class="n">dirPath</span><span class="o">=</span><span class="n">path</span><span class="o">|</span><span class="p">})</span> <span class="p">::</span> <span class="n">z</span>
                    <span class="n">actions_dir</span> <span class="n">x</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">moduleDir</span>
                    <span class="n">actions_dir</span> <span class="n">x</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">packageDir</span>

                    <span class="n">let</span> <span class="n">rec</span> <span class="n">actions_module</span> <span class="o">=</span> <span class="n">function</span>
                        <span class="o">|</span> <span class="n">FileHierarchy</span><span class="o">.</span><span class="n">Directory</span><span class="p">(</span><span class="sa">r</span><span class="s1">',(r,path),_,l) -&gt;</span>
                            <span class="n">trace</span> <span class="n">Verbose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"Supervisor.supervisor_server.ProjectCodeActions.actions_module | SpiProj.FileHierarchy.Directory(r',(r,path),_,l) / path: </span><span class="si">{path}</span><span class="s2">"</span><span class="p">)</span> <span class="n">_locals</span>
                            <span class="k">if</span> <span class="n">Directory</span><span class="o">.</span><span class="n">Exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="n">then</span>
                                <span class="n">z</span> <span class="o">&lt;-</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">RenameDirectory</span> <span class="p">{</span><span class="o">|</span><span class="n">dirPath</span><span class="o">=</span><span class="n">path</span><span class="p">;</span> <span class="n">target</span><span class="o">=</span><span class="n">null</span><span class="p">;</span> <span class="n">validate_as_file</span><span class="o">=</span><span class="n">true</span><span class="o">|</span><span class="p">})</span> <span class="p">::</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">DeleteDirectory</span> <span class="p">{</span><span class="o">|</span><span class="n">dirPath</span><span class="o">=</span><span class="n">path</span><span class="p">;</span> <span class="nb">range</span><span class="o">=</span><span class="sa">r</span><span class="s1">'|}) :: z</span>
                            <span class="k">else</span>
                                <span class="n">z</span> <span class="o">&lt;-</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">CreateDirectory</span> <span class="p">{</span><span class="o">|</span><span class="n">dirPath</span><span class="o">=</span><span class="n">path</span><span class="o">|</span><span class="p">})</span> <span class="p">::</span> <span class="n">z</span>
                            <span class="n">actions_modules</span> <span class="n">l</span>
                        <span class="o">|</span> <span class="n">FileHierarchy</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="sa">r</span><span class="s1">',(r,path),_) -&gt;</span>
                            <span class="n">trace</span> <span class="n">Verbose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"Supervisor.supervisor_server.ProjectCodeActions.actions_module | SpiProj.FileHierarchy.File(r',(r,path),_) / path: </span><span class="si">{path}</span><span class="s2">"</span><span class="p">)</span> <span class="n">_locals</span>
                            <span class="k">if</span> <span class="n">Map</span><span class="o">.</span><span class="n">containsKey</span> <span class="n">path</span> <span class="n">s</span><span class="o">.</span><span class="n">modules</span> <span class="n">then</span>
                                <span class="n">z</span> <span class="o">&lt;-</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">RenameFile</span> <span class="p">{</span><span class="o">|</span><span class="n">filePath</span><span class="o">=</span><span class="n">path</span><span class="p">;</span> <span class="n">target</span><span class="o">=</span><span class="n">null</span><span class="o">|</span><span class="p">})</span> <span class="p">::</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">DeleteFile</span> <span class="p">{</span><span class="o">|</span><span class="nb">range</span><span class="o">=</span><span class="sa">r</span><span class="s1">'; filePath=path|}) :: z</span>
                            <span class="k">else</span>
                                <span class="n">z</span> <span class="o">&lt;-</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">CreateFile</span> <span class="p">{</span><span class="o">|</span><span class="n">filePath</span><span class="o">=</span><span class="n">path</span><span class="o">|</span><span class="p">})</span> <span class="p">::</span> <span class="n">z</span>
                    <span class="ow">and</span> <span class="n">actions_modules</span> <span class="n">l</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">iter</span> <span class="n">actions_module</span> <span class="n">l</span>
                    <span class="n">actions_modules</span> <span class="n">x</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">modules</span>
                    <span class="n">z</span>
            <span class="n">Hopac</span><span class="o">.</span><span class="n">start</span> <span class="p">(</span><span class="n">IVar</span><span class="o">.</span><span class="n">fill</span> <span class="n">res</span> <span class="n">z</span><span class="p">)</span>
            <span class="n">s</span>
        <span class="o">|</span> <span class="n">ProjectCodeActionExecute</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">res</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">error</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span>
                <span class="k">match</span> <span class="n">code_action_execute</span> <span class="n">x</span><span class="o">.</span><span class="n">action</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">Result</span><span class="o">.</span><span class="n">Error</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">Some</span> <span class="n">x</span><span class="p">,</span> <span class="n">s</span>
                <span class="o">|</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span> <span class="n">null</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">,</span> <span class="n">proj_open</span> <span class="n">default_env</span> <span class="n">s</span> <span class="p">(</span><span class="nb">dir</span> <span class="n">x</span><span class="o">.</span><span class="n">uri</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">handle_packages</span>
                <span class="o">|</span> <span class="n">Result</span><span class="o">.</span><span class="n">Ok</span> <span class="n">path</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">,</span> <span class="n">file_delete</span> <span class="n">default_env</span> <span class="n">s</span> <span class="p">[</span><span class="o">|</span><span class="n">path</span><span class="o">|</span><span class="p">]</span> <span class="o">|&gt;</span> <span class="n">handle_files_packages</span>
            <span class="n">Hopac</span><span class="o">.</span><span class="n">start</span> <span class="p">(</span><span class="n">IVar</span><span class="o">.</span><span class="n">fill</span> <span class="n">res</span> <span class="p">{</span><span class="o">|</span><span class="n">result</span><span class="o">=</span><span class="n">error</span><span class="o">|</span><span class="p">})</span>
            <span class="n">s</span>
        <span class="o">|</span> <span class="n">FileTokenRange</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">v</span> <span class="o">=</span>
                <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="p">(</span><span class="n">file</span> <span class="n">x</span><span class="o">.</span><span class="n">uri</span><span class="p">)</span> <span class="n">s</span><span class="o">.</span><span class="n">modules</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">Some</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">Some</span> <span class="n">v</span>
                <span class="o">|</span> <span class="kc">None</span> <span class="n">when</span> <span class="n">x</span><span class="o">.</span><span class="n">uri</span> <span class="o">|&gt;</span> <span class="n">SpiralSm</span><span class="o">.</span><span class="n">ends_with</span> <span class="s2">".dib"</span> <span class="o">-&gt;</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">uri</span>
                    <span class="o">|&gt;</span> <span class="n">SpiralSm</span><span class="o">.</span><span class="n">replace</span> <span class="s2">"file:///"</span> <span class="s2">""</span>
                    <span class="o">|&gt;</span> <span class="n">File</span><span class="o">.</span><span class="n">ReadAllText</span>
                    <span class="o">|&gt;</span> <span class="n">wdiff_module_init_all</span> <span class="n">default_env</span> <span class="p">(</span><span class="n">is_top_down</span> <span class="n">x</span><span class="o">.</span><span class="n">uri</span><span class="p">)</span>
                    <span class="o">|&gt;</span> <span class="n">Some</span>
                <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="kc">None</span>

            <span class="k">match</span> <span class="n">v</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">Some</span> <span class="n">v</span> <span class="o">-&gt;</span>
                <span class="n">Hopac</span><span class="o">.</span><span class="n">start</span> <span class="p">(</span><span class="n">semantic_tokens</span> <span class="n">v</span><span class="o">.</span><span class="n">parser</span> <span class="o">&gt;&gt;=</span> <span class="p">(</span><span class="n">vscode_tokens</span> <span class="n">x</span><span class="o">.</span><span class="n">range</span> <span class="o">&gt;&gt;</span> <span class="n">IVar</span><span class="o">.</span><span class="n">fill</span> <span class="n">res</span><span class="p">))</span>
            <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span>
                <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">uri</span> <span class="o">|&gt;</span> <span class="n">SpiralSm</span><span class="o">.</span><span class="n">starts_with</span> <span class="s2">"vscode-notebook-cell"</span> <span class="o">|&gt;</span> <span class="ow">not</span> <span class="n">then</span>
                    <span class="n">trace</span> <span class="n">Debug</span>
                        <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"Supervisor.supervisor_server.FileTokenRange"</span><span class="p">)</span>
                        <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"module=None / x.uri: </span><span class="si">{x.uri}</span><span class="s2"> / {_locals ()}"</span><span class="p">)</span>

                <span class="n">Hopac</span><span class="o">.</span><span class="n">start</span> <span class="p">(</span><span class="n">IVar</span><span class="o">.</span><span class="n">fill</span> <span class="n">res</span> <span class="p">[</span><span class="o">||</span><span class="p">])</span>
            <span class="n">s</span>
        <span class="o">|</span> <span class="n">HoverAt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">res</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">file</span> <span class="o">=</span> <span class="n">file</span> <span class="n">x</span><span class="o">.</span><span class="n">uri</span>
            <span class="n">let</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">pos</span>
            <span class="n">let</span> <span class="n">_locals</span> <span class="p">()</span> <span class="o">=</span> <span class="err">$</span><span class="s2">"x: %A</span><span class="si">{x}</span><span class="s2"> / file: </span><span class="si">{file}</span><span class="s2"> / res: %A</span><span class="si">{res}</span><span class="s2">"</span>
            <span class="n">trace</span> <span class="n">Verbose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"Supervisor.supervisor_server.HoverAt"</span><span class="p">)</span> <span class="n">_locals</span>
            <span class="n">let</span> <span class="n">go_hover</span> <span class="n">x</span> <span class="o">=</span>
                <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
                <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="kc">None</span>
                <span class="o">|</span> <span class="n">Some</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">InferResult</span><span class="p">)</span> <span class="o">-&gt;</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">hovers</span> <span class="o">|&gt;</span> <span class="n">Array</span><span class="o">.</span><span class="n">tryPick</span> <span class="p">(</span><span class="n">fun</span> <span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">),</span><span class="n">r</span><span class="p">)</span> <span class="o">-&gt;</span>
                        <span class="k">if</span> <span class="n">pos</span><span class="o">.</span><span class="n">line</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">line</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">character</span> <span class="o">&lt;=</span> <span class="n">pos</span><span class="o">.</span><span class="n">character</span> <span class="o">&amp;&amp;</span> <span class="n">pos</span><span class="o">.</span><span class="n">character</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">.</span><span class="n">character</span><span class="p">)</span> <span class="n">then</span> <span class="n">Some</span> <span class="n">r</span> <span class="k">else</span> <span class="kc">None</span>
                        <span class="p">)</span>
                <span class="o">|&gt;</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span>
                    <span class="n">let</span> <span class="n">_locals</span> <span class="p">()</span> <span class="o">=</span> <span class="err">$</span><span class="s2">"x: %A</span><span class="si">{x}</span><span class="s2">"</span>
                    <span class="n">trace</span> <span class="n">Verbose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"Supervisor.supervisor_server.HoverAt.go_hover"</span><span class="p">)</span> <span class="n">_locals</span>
                    <span class="n">x</span>
                <span class="p">)</span>
                <span class="o">|&gt;</span> <span class="n">IVar</span><span class="o">.</span><span class="n">fill</span> <span class="n">res</span>
            <span class="n">let</span> <span class="n">go_block</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">TypecheckerState</span><span class="p">)</span> <span class="o">=</span>
                <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="n">s</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">TypecheckerStateValue</span> <span class="n">Stream</span><span class="p">)</span> <span class="o">=</span>
                    <span class="n">x</span> <span class="o">&gt;&gt;=</span> <span class="n">function</span>
                    <span class="o">|</span> <span class="n">Nil</span> <span class="o">-&gt;</span> <span class="n">go_hover</span> <span class="n">s</span>
                    <span class="o">|</span> <span class="n">Cons</span><span class="p">((</span><span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">_</span><span class="p">),</span><span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span>
                        <span class="n">let</span> <span class="n">_locals</span> <span class="p">()</span> <span class="o">=</span> <span class="err">$</span><span class="s2">"b: </span><span class="si">{b}</span><span class="s2">"</span>
                        <span class="n">trace</span> <span class="n">Verbose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"Supervisor.supervisor_server.HoverAt.go_block.loop Cons"</span><span class="p">)</span> <span class="n">_locals</span>
                        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">offset</span> <span class="o">&lt;=</span> <span class="n">pos</span><span class="o">.</span><span class="n">line</span> <span class="n">then</span> <span class="n">loop</span> <span class="p">(</span><span class="n">Some</span> <span class="n">x</span><span class="p">)</span> <span class="n">b</span>
                        <span class="o">//</span> <span class="n">If</span> <span class="n">the</span> <span class="n">block</span> <span class="ow">is</span> <span class="n">over</span> <span class="n">the</span> <span class="n">offset</span> <span class="n">that</span> <span class="n">means</span> <span class="n">the</span> <span class="n">previous</span> <span class="n">one</span> <span class="n">must</span> <span class="n">be</span> <span class="n">the</span> <span class="n">right</span> <span class="n">choice</span><span class="o">.</span>
                        <span class="k">else</span> <span class="n">go_hover</span> <span class="n">s</span>
                <span class="n">Hopac</span><span class="o">.</span><span class="n">start</span> <span class="p">(</span><span class="n">loop</span> <span class="kc">None</span> <span class="n">x</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>
            <span class="n">let</span> <span class="n">rec</span> <span class="n">go_file</span> <span class="n">uids_file</span> <span class="n">trees</span> <span class="o">=</span>
                <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="o">=</span> <span class="n">function</span>
                    <span class="o">|</span> <span class="n">ProjFilesTree</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span><span class="n">file</span><span class="s1">',_) -&gt; if file = file'</span> <span class="n">then</span> <span class="n">go_block</span> <span class="p">(</span><span class="n">Array</span><span class="o">.</span><span class="n">get</span> <span class="n">uids_file</span> <span class="n">uid</span> <span class="o">|&gt;</span> <span class="n">fst</span><span class="p">);</span> <span class="n">true</span> <span class="k">else</span> <span class="n">false</span>
                    <span class="o">|</span> <span class="n">ProjFilesTree</span><span class="o">.</span><span class="n">Directory</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">l</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span> <span class="n">l</span>
                <span class="ow">and</span> <span class="nb">list</span> <span class="n">l</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">exists</span> <span class="n">loop</span> <span class="n">l</span>
                <span class="nb">list</span> <span class="n">trees</span>
            <span class="n">let</span> <span class="n">rec</span> <span class="n">go_parent</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">DirectoryInfo</span><span class="p">)</span> <span class="o">=</span>
                <span class="n">trace</span> <span class="n">Verbose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"Supervisor.supervisor_server.HoverAt.go_parent / x: %A</span><span class="si">{x}</span><span class="s2">"</span><span class="p">)</span> <span class="n">_locals</span>
                <span class="k">if</span> <span class="n">x</span> <span class="o">=</span> <span class="n">null</span> <span class="n">then</span> <span class="n">false</span>
                <span class="k">else</span>
                    <span class="n">let</span> <span class="n">path</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">FullName</span> <span class="o">|&gt;</span> <span class="n">SpiralFileSystem</span><span class="o">.</span><span class="n">standardize_path</span>
                    <span class="k">if</span> <span class="n">Map</span><span class="o">.</span><span class="n">containsKey</span> <span class="n">path</span> <span class="n">s</span><span class="o">.</span><span class="n">packages</span> <span class="n">then</span>
                        <span class="n">let</span> <span class="n">pid</span> <span class="o">=</span> <span class="p">(</span><span class="n">fst</span> <span class="n">s</span><span class="o">.</span><span class="n">package_ids</span><span class="p">)</span><span class="o">.</span><span class="p">[</span><span class="n">path</span><span class="p">]</span>
                        <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">pid</span> <span class="n">s</span><span class="o">.</span><span class="n">packages_infer</span><span class="o">.</span><span class="n">ok</span> <span class="k">with</span>
                        <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">false</span>
                        <span class="o">|</span> <span class="n">Some</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">go_file</span> <span class="n">x</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">uids_file</span> <span class="n">x</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">tree</span>
                    <span class="k">else</span>
                        <span class="n">go_parent</span> <span class="n">x</span><span class="o">.</span><span class="n">Parent</span>
            <span class="k">if</span> <span class="n">go_parent</span> <span class="p">(</span><span class="n">Directory</span><span class="o">.</span><span class="n">GetParent</span><span class="p">(</span><span class="n">file</span><span class="p">))</span> <span class="o">=</span> <span class="n">false</span> <span class="n">then</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">start</span> <span class="p">(</span><span class="n">IVar</span><span class="o">.</span><span class="n">fill</span> <span class="n">res</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">s</span>
        <span class="o">|</span> <span class="n">BuildFile</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">backend</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">backend</span>
            <span class="n">let</span> <span class="n">file</span> <span class="o">=</span> <span class="n">file</span> <span class="n">x</span><span class="o">.</span><span class="n">uri</span>
            <span class="n">let</span> <span class="n">_locals</span> <span class="p">()</span> <span class="o">=</span> <span class="err">$</span><span class="s2">"x: %A</span><span class="si">{x}</span><span class="s2"> / file: </span><span class="si">{file}</span><span class="s2">"</span>
            <span class="n">trace</span> <span class="n">Verbose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"Supervisor.supervisor_server.BuildFile"</span><span class="p">)</span> <span class="n">_locals</span>
            <span class="n">let</span> <span class="n">handle_build_result</span> <span class="o">=</span> <span class="n">function</span>
                <span class="o">|</span> <span class="n">BuildOk</span> <span class="n">l</span> <span class="o">-&gt;</span>
                    <span class="n">Job</span><span class="o">.</span><span class="n">fromAsync</span> <span class="p">(</span><span class="k">async</span> <span class="p">{</span>
                        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">l</span> <span class="n">do</span>
                            <span class="n">do</span><span class="err">!</span> <span class="n">System</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">File</span><span class="o">.</span><span class="n">WriteAllTextAsync</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">Path</span><span class="o">.</span><span class="n">ChangeExtension</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">file_extension</span><span class="p">),</span> <span class="n">x</span><span class="o">.</span><span class="n">code</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">Async</span><span class="o">.</span><span class="n">AwaitTask</span>

                    <span class="p">})</span>
                    <span class="o">|&gt;</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">start</span>
                    <span class="n">l</span>
                    <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
                    <span class="o">|&gt;</span> <span class="n">String</span><span class="o">.</span><span class="n">concat</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
                    <span class="o">|&gt;</span> <span class="n">Some</span>
                    <span class="o">|&gt;</span> <span class="n">IVar</span><span class="o">.</span><span class="n">fill</span> <span class="n">res</span>
                <span class="o">|</span> <span class="n">BuildFatalError</span> <span class="n">x</span> <span class="k">as</span> <span class="n">x</span><span class="s1">' -&gt;</span>
                    <span class="n">trace</span> <span class="n">Info</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"Supervisor.supervisor_server.BuildFile.handle_build_result / BuildFatalError x: %A</span><span class="si">{x}</span><span class="s2">"</span><span class="p">)</span> <span class="n">_locals</span>
                    <span class="n">Hopac</span><span class="o">.</span><span class="n">start</span> <span class="p">(</span><span class="n">Ch</span><span class="o">.</span><span class="n">send</span> <span class="n">errors</span><span class="o">.</span><span class="n">fatal</span> <span class="n">x</span><span class="p">)</span>
                    <span class="n">IVar</span><span class="o">.</span><span class="n">fill</span> <span class="n">res</span> <span class="kc">None</span>
                <span class="o">|</span> <span class="n">BuildErrorTrace</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="k">as</span> <span class="n">x</span><span class="s1">' -&gt;</span>
                    <span class="n">trace</span> <span class="n">Info</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"Supervisor.supervisor_server.BuildFile.handle_build_result / BuildErrorTrace x': %A{x'}"</span><span class="p">)</span> <span class="n">_locals</span>
                    <span class="n">Hopac</span><span class="o">.</span><span class="n">start</span> <span class="p">(</span><span class="n">Ch</span><span class="o">.</span><span class="n">send</span> <span class="n">errors</span><span class="o">.</span><span class="n">traced</span> <span class="p">{</span><span class="o">|</span><span class="n">trace</span><span class="o">=</span><span class="n">a</span><span class="p">;</span> <span class="n">message</span><span class="o">=</span><span class="n">b</span><span class="o">|</span><span class="p">})</span>
                    <span class="n">IVar</span><span class="o">.</span><span class="n">fill</span> <span class="n">res</span> <span class="kc">None</span>
                <span class="o">|</span> <span class="n">BuildSkip</span> <span class="o">-&gt;</span>
                    <span class="n">trace</span> <span class="n">Info</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"Supervisor.supervisor_server.BuildFile.handle_build_result.BuildSkip"</span><span class="p">)</span> <span class="n">_locals</span>
                    <span class="n">IVar</span><span class="o">.</span><span class="n">fill</span> <span class="n">res</span> <span class="kc">None</span>
            <span class="n">let</span> <span class="n">file_build</span> <span class="p">(</span><span class="n">s</span> <span class="p">:</span> <span class="n">SupervisorState</span><span class="p">)</span> <span class="n">mid</span> <span class="p">(</span><span class="n">tc</span> <span class="p">:</span> <span class="n">ProjStateTC</span><span class="p">,</span> <span class="n">prepass</span> <span class="p">:</span> <span class="n">ProjStatePrepass</span><span class="p">)</span> <span class="o">=</span>
                <span class="n">trace</span> <span class="n">Verbose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"""Supervisor.supervisor_server.BuildFile.file_build / modules: %A{s.modules.Keys |&gt; SpiralSm.concat ", "} / packages: %A{s.packages.Keys |&gt; SpiralSm.concat ", "} / package_ids: %A{s.package_ids |&gt; fst |&gt; fun x -&gt; x.Keys |&gt; SpiralSm.concat ", "}"""</span><span class="p">)</span> <span class="n">_locals</span>
                <span class="n">let</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">uids_file</span><span class="o">.</span><span class="p">[</span><span class="n">mid</span><span class="p">]</span>
                <span class="n">let</span> <span class="n">x</span><span class="p">,</span><span class="n">_x</span> <span class="o">=</span> <span class="n">prepass</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">uids_file</span><span class="o">.</span><span class="p">[</span><span class="n">mid</span><span class="p">]</span>
                <span class="n">Hopac</span><span class="o">.</span><span class="n">start</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">state</span> <span class="o">&gt;&gt;=</span> <span class="n">fun</span> <span class="p">(</span><span class="n">has_error</span><span class="s1">',_) -&gt;</span>
                    <span class="n">b</span> <span class="o">&gt;&gt;=</span> <span class="n">fun</span> <span class="p">(</span><span class="n">has_error</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span>
                    <span class="k">if</span> <span class="n">has_error</span> <span class="o">||</span> <span class="n">has_error</span><span class="s1">' then fatal $"File {Path.GetFileNameWithoutExtension file} has a type error somewhere in its path."; Job.unit() else</span>
                    <span class="n">Stream</span><span class="o">.</span><span class="n">foldFun</span> <span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">env</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">env</span><span class="p">)</span> <span class="n">top_env_emptyPrepass</span> <span class="n">x</span><span class="o">.</span><span class="n">result</span> <span class="o">&gt;&gt;=</span> <span class="n">fun</span> <span class="n">env</span> <span class="o">-&gt;</span>
                    <span class="n">let</span> <span class="n">body</span><span class="p">()</span> <span class="o">=</span>
                        <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="s2">"main"</span> <span class="n">env</span><span class="o">.</span><span class="n">term</span> <span class="k">with</span>
                        <span class="o">|</span> <span class="n">Some</span> <span class="n">main</span> <span class="o">-&gt;</span>
                            <span class="n">let</span> <span class="n">prototypes_instances</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">prototypes_instances</span><span class="p">)</span>
                            <span class="n">let</span> <span class="n">nominals</span> <span class="o">=</span> 
                                <span class="n">let</span> <span class="n">t</span> <span class="o">=</span> <span class="n">HashConsTable</span><span class="p">()</span>
                                <span class="n">let</span> <span class="n">d</span> <span class="o">=</span> <span class="n">Dictionary</span><span class="p">()</span>
                                <span class="n">env</span><span class="o">.</span><span class="n">nominals</span> <span class="o">|&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">iter</span> <span class="p">(</span><span class="n">fun</span> <span class="n">k</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">d</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Add</span> <span class="p">{</span><span class="o">|</span><span class="n">v</span> <span class="k">with</span> <span class="nb">id</span><span class="o">=</span><span class="n">k</span><span class="o">|</span><span class="p">}))</span>
                                <span class="n">d</span>
                            <span class="k">try</span> 
                                <span class="n">let</span> <span class="n">build</span> <span class="n">codegen</span> <span class="n">backend</span> <span class="n">file_extension</span> <span class="o">=</span>
                                    <span class="n">let</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">),</span><span class="n">b</span> <span class="o">=</span> <span class="n">peval</span> <span class="p">{</span><span class="n">prototypes_instances</span><span class="o">=</span><span class="n">prototypes_instances</span><span class="p">;</span> <span class="n">nominals</span><span class="o">=</span><span class="n">nominals</span><span class="p">;</span> <span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">}</span> <span class="n">main</span>
                                    <span class="n">BuildOk</span> <span class="p">[{</span><span class="o">|</span><span class="n">code</span> <span class="o">=</span> <span class="n">codegen</span> <span class="n">b</span> <span class="n">a</span><span class="p">;</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">file_extension</span><span class="o">|</span><span class="p">}]</span>
                                <span class="k">match</span> <span class="n">backend</span> <span class="k">with</span>
                                <span class="o">|</span> <span class="s2">"Fsharp"</span> <span class="o">-&gt;</span> <span class="n">build</span> <span class="n">codegenFsharp</span> <span class="s2">"Fsharp"</span> <span class="s2">"fsx"</span>
                                <span class="o">|</span> <span class="s2">"C"</span> <span class="o">-&gt;</span> <span class="n">build</span> <span class="n">CodegenC</span><span class="o">.</span><span class="n">codegenC</span> <span class="s2">"C"</span> <span class="s2">"c"</span>
                                <span class="o">|</span> <span class="s2">"Python + Cuda"</span> <span class="o">-&gt;</span> <span class="n">build</span> <span class="p">(</span><span class="n">CodegenPython</span><span class="o">.</span><span class="n">codegenPython</span> <span class="n">default_env</span><span class="p">)</span> <span class="s2">"Python"</span> <span class="s2">"py"</span>
                                <span class="o">|</span> <span class="s2">"Cuda C++"</span> <span class="o">-&gt;</span> <span class="n">BuildFatalError</span> <span class="s2">"The host C++ backend originally made for FPGAs, and then ported to Cuda has been removed in v2.10.0 of Spiral. Please use an earlier version to access it."</span> <span class="o">//</span> <span class="n">Date</span><span class="p">:</span> <span class="mi">5</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="mi">2024</span>
                                <span class="o">|</span> <span class="s2">"Python"</span> <span class="o">-&gt;</span> <span class="n">BuildFatalError</span> <span class="s2">"The prototype Python backend has been replaced by the Python + Cuda one in v2.5.0 of Spiral. Please use an earlier version to access it."</span> <span class="o">//</span> <span class="n">Date</span><span class="p">:</span> <span class="mi">11</span><span class="o">/</span><span class="mi">3</span><span class="o">/</span><span class="mi">2023</span>
                                <span class="o">|</span> <span class="s2">"UPMEM: Python + C"</span> <span class="o">-&gt;</span> <span class="n">BuildFatalError</span> <span class="s2">"The UPMEM Python + C backend has been replaced by the Python + Cuda one in v2.5.0 of Spiral. Please use an earlier version to access it."</span> <span class="o">//</span> <span class="n">Date</span><span class="p">:</span> <span class="mi">11</span><span class="o">/</span><span class="mi">3</span><span class="o">/</span><span class="mi">2023</span>
                                <span class="o">|</span> <span class="s2">"HLS C++"</span> <span class="o">-&gt;</span> <span class="n">BuildFatalError</span> <span class="s2">"The HLS C++ backend has been replaced by the Cuda one in v2.5.0 of Spiral. Please use an earlier version to access it."</span> <span class="o">//</span> <span class="n">Date</span><span class="p">:</span> <span class="mi">10</span><span class="o">/</span><span class="mi">17</span><span class="o">/</span><span class="mi">2023</span>
                                <span class="o">|</span> <span class="s2">"Cython*"</span> <span class="o">|</span> <span class="s2">"Cython"</span> <span class="o">-&gt;</span> <span class="n">BuildFatalError</span> <span class="s2">"The Cython backend has been replaced by the Python one in v2.3.1 of Spiral. Please use an earlier version to access it."</span> <span class="o">//</span> <span class="n">Date</span><span class="p">:</span> <span class="mi">12</span><span class="o">/</span><span class="mi">27</span><span class="o">/</span><span class="mi">2022</span>
                                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">BuildFatalError</span> <span class="err">$</span><span class="s2">"Cannot recognize the backend: </span><span class="si">{backend}</span><span class="s2">"</span>
                            <span class="k">with</span>
                                <span class="o">|</span> <span class="p">:</span><span class="err">?</span> <span class="n">PartEvalTypeError</span> <span class="k">as</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">BuildErrorTrace</span><span class="p">(</span><span class="n">show_trace</span> <span class="n">s</span> <span class="n">e</span><span class="o">.</span><span class="n">Data0</span> <span class="n">e</span><span class="o">.</span><span class="n">Data1</span><span class="p">)</span>
                                <span class="o">|</span> <span class="p">:</span><span class="err">?</span> <span class="n">CodegenError</span> <span class="k">as</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">BuildFatalError</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">Data1</span><span class="p">)</span>
                                <span class="o">|</span> <span class="p">:</span><span class="err">?</span> <span class="n">CodegenErrorWithPos</span> <span class="k">as</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">BuildErrorTrace</span><span class="p">(</span><span class="n">show_trace</span> <span class="n">s</span> <span class="n">e</span><span class="o">.</span><span class="n">Data0</span> <span class="n">e</span><span class="o">.</span><span class="n">Data1</span><span class="p">)</span>
                                <span class="o">|</span> <span class="n">ex</span> <span class="o">-&gt;</span>
                                    <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">Directory</span><span class="o">.</span><span class="n">Exists</span> <span class="n">traceDir</span> <span class="n">then</span>
                                        <span class="n">let</span> <span class="n">guid</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">DateTime</span><span class="o">.</span><span class="n">Now</span> <span class="o">|&gt;</span> <span class="n">SpiralDateTime</span><span class="o">.</span><span class="n">new_guid_from_date_time</span>
                                        <span class="n">let</span> <span class="n">trace_file</span> <span class="o">=</span> <span class="n">traceDir</span> <span class="o">&lt;/&gt;</span> <span class="err">$</span><span class="s2">"</span><span class="si">{guid}</span><span class="s2">_error.json"</span>
                                        <span class="k">async</span> <span class="p">{</span>
                                            <span class="k">try</span>
                                                <span class="n">do</span><span class="err">!</span> <span class="err">$</span><span class="s2">"</span><span class="si">{ex}</span><span class="s2">"</span> <span class="o">|&gt;</span> <span class="n">SpiralFileSystem</span><span class="o">.</span><span class="n">write_all_text_async</span> <span class="n">trace_file</span>
                                            <span class="k">with</span> <span class="n">ex</span> <span class="o">-&gt;</span>
                                                <span class="n">trace</span> <span class="n">Critical</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"Supervisor.supervisor_server.BuildFile.file_build / ex: {ex |&gt; SpiralSm.format_exception}"</span><span class="p">)</span> <span class="n">_locals</span>
                                        <span class="p">}</span>
                                        <span class="o">|&gt;</span> <span class="n">Async</span><span class="o">.</span><span class="n">Start</span>
                                    <span class="n">trace</span> <span class="n">Critical</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"Supervisor.supervisor_server.BuildFile.file_build / ex: %A</span><span class="si">{ex}</span><span class="s2">"</span><span class="p">)</span> <span class="n">_locals</span>
                                    <span class="n">BuildFatalError</span><span class="p">(</span><span class="n">ex</span><span class="o">.</span><span class="n">Message</span><span class="p">)</span>
                        <span class="o">|</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">BuildFatalError</span> <span class="err">$</span><span class="s2">"Cannot find `main` in file {Path.GetFileNameWithoutExtension file}."</span>

                    <span class="o">//</span> <span class="n">The</span> <span class="n">partial</span> <span class="n">evaluator</span> <span class="ow">is</span> <span class="n">using</span> <span class="n">too</span> <span class="n">much</span> <span class="n">stack</span> <span class="n">space</span><span class="p">,</span> <span class="n">so</span> <span class="k">as</span> <span class="n">a</span> <span class="n">temporary</span> <span class="n">fix</span><span class="p">,</span> <span class="n">I</span> <span class="n">am</span> <span class="n">running</span> <span class="n">it</span> <span class="n">on</span> <span class="n">a</span> <span class="n">separate</span> <span class="n">thread</span> <span class="k">with</span> <span class="n">much</span> <span class="n">more</span> <span class="n">of</span> <span class="n">it</span><span class="o">.</span>
                    <span class="n">let</span> <span class="n">result</span> <span class="o">=</span> <span class="n">IVar</span><span class="p">()</span>
                    <span class="n">let</span> <span class="n">thread</span> <span class="o">=</span> <span class="n">new</span> <span class="n">System</span><span class="o">.</span><span class="n">Threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">Threading</span><span class="o">.</span><span class="n">ThreadStart</span><span class="p">(</span><span class="n">body</span> <span class="o">&gt;&gt;</span> <span class="n">IVar</span><span class="o">.</span><span class="n">fill</span> <span class="n">result</span> <span class="o">&gt;&gt;</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">start</span><span class="p">),</span> <span class="mi">1</span> <span class="o">&lt;&lt;&lt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">//</span> <span class="n">Stack</span> <span class="n">space</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">28</span> <span class="o">=</span> <span class="mi">256</span><span class="n">mb</span><span class="o">.</span>
                    <span class="n">thread</span><span class="o">.</span><span class="n">Start</span><span class="p">()</span>
                    <span class="n">result</span> <span class="o">&gt;&gt;=</span> <span class="n">handle_build_result</span>
                    <span class="p">)</span>
            <span class="n">let</span> <span class="n">file_find</span> <span class="p">(</span><span class="n">s</span> <span class="p">:</span> <span class="n">SupervisorState</span><span class="p">)</span> <span class="n">pdir</span> <span class="o">=</span>
                <span class="n">trace</span> <span class="n">Verbose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"Supervisor.supervisor_server.BuildFile.file_find / pdir: </span><span class="si">{pdir}</span><span class="s2">"</span><span class="p">)</span> <span class="n">_locals</span>
                <span class="n">let</span> <span class="n">uid</span> <span class="o">=</span> <span class="p">(</span><span class="n">fst</span> <span class="n">s</span><span class="o">.</span><span class="n">package_ids</span><span class="p">)</span><span class="o">.</span><span class="p">[</span><span class="n">pdir</span><span class="p">]</span>
                <span class="k">match</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">uid</span> <span class="n">s</span><span class="o">.</span><span class="n">packages_infer</span><span class="o">.</span><span class="n">ok</span><span class="p">,</span> <span class="n">Map</span><span class="o">.</span><span class="n">tryFind</span> <span class="n">uid</span> <span class="n">s</span><span class="o">.</span><span class="n">packages_prepass</span><span class="o">.</span><span class="n">ok</span> <span class="k">with</span>
                <span class="o">|</span> <span class="n">Some</span> <span class="n">a</span><span class="p">,</span> <span class="n">Some</span> <span class="n">b</span> <span class="o">-&gt;</span>
                    <span class="n">let</span> <span class="n">rec</span> <span class="n">loop</span> <span class="o">=</span> <span class="n">function</span>
                        <span class="o">|</span> <span class="n">ProjFilesTree</span><span class="o">.</span><span class="n">Directory</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">l</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span> <span class="n">l</span>
                        <span class="o">|</span> <span class="n">ProjFilesTree</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span><span class="n">path</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span>
                            <span class="n">trace</span> <span class="n">Verbose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"Supervisor.supervisor_server.BuildFile.file_find.loop | File(mid,path,_) / path: </span><span class="si">{path}</span><span class="s2">"</span><span class="p">)</span> <span class="n">_locals</span>
                            <span class="k">if</span> <span class="n">file</span> <span class="o">=</span> <span class="n">path</span> <span class="n">then</span> <span class="n">file_build</span> <span class="n">s</span> <span class="n">mid</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span> <span class="n">true</span> <span class="k">else</span> <span class="n">false</span>
                    <span class="ow">and</span> <span class="nb">list</span> <span class="n">l</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">exists</span> <span class="n">loop</span> <span class="n">l</span>
                    <span class="k">if</span> <span class="nb">list</span> <span class="n">b</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">tree</span> <span class="o">=</span> <span class="n">false</span> <span class="n">then</span> <span class="n">fatal</span> <span class="err">$</span><span class="s2">"File {Path.GetFileNameWithoutExtension file} cannot be found in the project {spiproj_suffix pdir}"</span>

                    <span class="n">s</span>
                <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span> <span class="o">-&gt;</span> <span class="n">fatal</span> <span class="err">$</span><span class="s2">"Owner of file {Path.GetFileNameWithoutExtension file} has an error. Location: {spiproj_suffix pdir}"</span><span class="p">;</span> <span class="n">s</span>
                <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Compiler error: The project status should be the same in both infer and prepass."</span>
            <span class="n">let</span> <span class="n">update_owner</span> <span class="n">pdir</span> <span class="o">=</span>
                <span class="n">let</span> <span class="n">order</span><span class="p">,</span><span class="n">dirty_packages</span> <span class="o">=</span> <span class="n">topological_sort</span><span class="s1">' (fst s.graph) [pdir]</span>
                <span class="n">let</span> <span class="n">packages_prepass</span> <span class="o">=</span> <span class="n">wdiff_projenvr_prepass</span> <span class="n">default_env</span> <span class="p">(</span><span class="n">fst</span> <span class="n">s</span><span class="o">.</span><span class="n">package_ids</span><span class="p">)</span> <span class="n">s</span><span class="o">.</span><span class="n">packages</span> <span class="n">s</span><span class="o">.</span><span class="n">packages_infer</span><span class="o">.</span><span class="n">ok</span> <span class="n">s</span><span class="o">.</span><span class="n">packages_prepass</span> <span class="p">(</span><span class="n">dirty_packages</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">ToArray</span><span class="p">())</span>
                <span class="n">file_find</span> <span class="p">{</span><span class="n">s</span> <span class="k">with</span> <span class="n">packages_prepass</span> <span class="o">=</span> <span class="n">packages_prepass</span><span class="p">}</span> <span class="n">pdir</span>
            <span class="n">let</span> <span class="n">rec</span> <span class="n">find_owner</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">DirectoryInfo</span><span class="p">)</span> <span class="o">=</span>
                <span class="k">if</span> <span class="n">x</span> <span class="o">=</span> <span class="n">null</span> <span class="n">then</span> <span class="n">fatal</span> <span class="err">$</span><span class="s2">"Cannot find the package file of </span><span class="si">{file}</span><span class="s2">"</span><span class="p">;</span> <span class="n">s</span>
                <span class="k">else</span>
                    <span class="n">let</span> <span class="n">x</span><span class="s1">' = x.FullName |&gt; SpiralFileSystem.standardize_path</span>
                    <span class="n">trace</span> <span class="n">Verbose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"""Supervisor.supervisor_server.BuildFile.find_owner / x.FullName: {x.FullName |&gt; SpiralSm.replace "</span><span class="se">\\</span><span class="s2">" "|"} / x': {x'}"""</span><span class="p">)</span> <span class="n">_locals</span>
                    <span class="n">let</span> <span class="n">x_</span> <span class="o">=</span> <span class="n">x</span>
                    <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span> <span class="n">FullName</span> <span class="o">=</span> <span class="n">x</span><span class="s1">' |}</span>
                    <span class="k">if</span> <span class="n">Map</span><span class="o">.</span><span class="n">containsKey</span> <span class="n">x</span><span class="o">.</span><span class="n">FullName</span> <span class="n">s</span><span class="o">.</span><span class="n">packages</span> <span class="n">then</span> <span class="n">update_owner</span> <span class="n">x</span><span class="o">.</span><span class="n">FullName</span>
                    <span class="k">else</span> <span class="n">find_owner</span> <span class="n">x_</span><span class="o">.</span><span class="n">Parent</span>
            <span class="n">find_owner</span> <span class="p">(</span><span class="n">Directory</span><span class="o">.</span><span class="n">GetParent</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>

    <span class="n">Job</span><span class="o">.</span><span class="n">iterateServer</span> <span class="p">{</span>
        <span class="n">packages</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
        <span class="n">modules</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
        <span class="n">packages_infer</span> <span class="o">=</span> <span class="p">{</span><span class="n">ok</span><span class="o">=</span><span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">;</span> <span class="n">error</span><span class="o">=</span><span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">}</span>
        <span class="n">packages_prepass</span> <span class="o">=</span> <span class="p">{</span><span class="n">ok</span><span class="o">=</span><span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">;</span> <span class="n">error</span><span class="o">=</span><span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">}</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">mirrored_graph_empty</span>
        <span class="n">package_ids</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span><span class="p">,</span> <span class="n">Map</span><span class="o">.</span><span class="n">empty</span>
        <span class="p">}</span> <span class="n">loop</span>

<span class="nb">type</span> <span class="n">ClientReq</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">ProjectFileOpen</span> <span class="n">of</span> <span class="p">{</span><span class="o">|</span><span class="n">uri</span> <span class="p">:</span> <span class="n">string</span><span class="p">;</span> <span class="n">spiprojText</span> <span class="p">:</span> <span class="n">string</span><span class="o">|</span><span class="p">}</span>
    <span class="o">|</span> <span class="n">ProjectFileChange</span> <span class="n">of</span> <span class="p">{</span><span class="o">|</span><span class="n">uri</span> <span class="p">:</span> <span class="n">string</span><span class="p">;</span> <span class="n">spiprojText</span> <span class="p">:</span> <span class="n">string</span><span class="o">|</span><span class="p">}</span>
    <span class="o">|</span> <span class="n">ProjectFileLinks</span> <span class="n">of</span> <span class="p">{</span><span class="o">|</span><span class="n">uri</span> <span class="p">:</span> <span class="n">string</span><span class="o">|</span><span class="p">}</span>
    <span class="o">|</span> <span class="n">ProjectCodeActionExecute</span> <span class="n">of</span> <span class="p">{</span><span class="o">|</span><span class="n">uri</span> <span class="p">:</span> <span class="n">string</span><span class="p">;</span> <span class="n">action</span> <span class="p">:</span> <span class="n">ProjectCodeAction</span><span class="o">|</span><span class="p">}</span>
    <span class="o">|</span> <span class="n">ProjectCodeActions</span> <span class="n">of</span> <span class="p">{</span><span class="o">|</span><span class="n">uri</span> <span class="p">:</span> <span class="n">string</span><span class="o">|</span><span class="p">}</span>
    <span class="o">|</span> <span class="n">FileOpen</span> <span class="n">of</span> <span class="p">{</span><span class="o">|</span><span class="n">uri</span> <span class="p">:</span> <span class="n">string</span><span class="p">;</span> <span class="n">spiText</span> <span class="p">:</span> <span class="n">string</span><span class="o">|</span><span class="p">}</span>
    <span class="o">|</span> <span class="n">FileChange</span> <span class="n">of</span> <span class="p">{</span><span class="o">|</span><span class="n">uri</span> <span class="p">:</span> <span class="n">string</span><span class="p">;</span> <span class="n">spiEdit</span> <span class="p">:</span> <span class="n">SpiEdit</span><span class="o">|</span><span class="p">}</span>
    <span class="o">|</span> <span class="n">FileDelete</span> <span class="n">of</span> <span class="p">{</span><span class="o">|</span><span class="n">uris</span> <span class="p">:</span> <span class="n">string</span> <span class="p">[]</span><span class="o">|</span><span class="p">}</span> <span class="o">//</span> <span class="n">Also</span> <span class="n">works</span> <span class="k">for</span> <span class="n">project</span> <span class="n">files</span> <span class="ow">and</span> <span class="n">directories</span><span class="o">.</span>
    <span class="o">|</span> <span class="n">FileTokenRange</span> <span class="n">of</span> <span class="p">{</span><span class="o">|</span><span class="n">uri</span> <span class="p">:</span> <span class="n">string</span><span class="p">;</span> <span class="nb">range</span> <span class="p">:</span> <span class="n">VSCRange</span><span class="o">|</span><span class="p">}</span>
    <span class="o">|</span> <span class="n">HoverAt</span> <span class="n">of</span> <span class="p">{</span><span class="o">|</span><span class="n">uri</span> <span class="p">:</span> <span class="n">string</span><span class="p">;</span> <span class="n">pos</span> <span class="p">:</span> <span class="n">VSCPos</span><span class="o">|</span><span class="p">}</span>
    <span class="o">|</span> <span class="n">BuildFile</span> <span class="n">of</span> <span class="p">{</span><span class="o">|</span><span class="n">uri</span> <span class="p">:</span> <span class="n">string</span><span class="p">;</span> <span class="n">backend</span> <span class="p">:</span> <span class="n">string</span><span class="o">|</span><span class="p">}</span>
    <span class="o">|</span> <span class="n">Ping</span> <span class="n">of</span> <span class="nb">bool</span>
    <span class="o">|</span> <span class="n">Exit</span> <span class="n">of</span> <span class="nb">bool</span>

<span class="nb">type</span> <span class="n">ClientErrorsRes</span> <span class="o">=</span>
    <span class="o">|</span> <span class="n">FatalError</span> <span class="n">of</span> <span class="n">string</span>
    <span class="o">|</span> <span class="n">TracedError</span> <span class="n">of</span> <span class="n">TracedError</span>
    <span class="o">|</span> <span class="n">PackageErrors</span> <span class="n">of</span> <span class="p">{</span><span class="o">|</span><span class="n">uri</span> <span class="p">:</span> <span class="n">string</span><span class="p">;</span> <span class="n">errors</span> <span class="p">:</span> <span class="n">RString</span> <span class="nb">list</span><span class="o">|</span><span class="p">}</span>
    <span class="o">|</span> <span class="n">TokenizerErrors</span> <span class="n">of</span> <span class="p">{</span><span class="o">|</span><span class="n">uri</span> <span class="p">:</span> <span class="n">string</span><span class="p">;</span> <span class="n">errors</span> <span class="p">:</span> <span class="n">RString</span> <span class="nb">list</span><span class="o">|</span><span class="p">}</span>
    <span class="o">|</span> <span class="n">ParserErrors</span> <span class="n">of</span> <span class="p">{</span><span class="o">|</span><span class="n">uri</span> <span class="p">:</span> <span class="n">string</span><span class="p">;</span> <span class="n">errors</span> <span class="p">:</span> <span class="n">RString</span> <span class="nb">list</span><span class="o">|</span><span class="p">}</span>
    <span class="o">|</span> <span class="n">TypeErrors</span> <span class="n">of</span> <span class="p">{</span><span class="o">|</span><span class="n">uri</span> <span class="p">:</span> <span class="n">string</span><span class="p">;</span> <span class="n">errors</span> <span class="p">:</span> <span class="n">RString</span> <span class="nb">list</span><span class="o">|</span><span class="p">}</span>


<span class="nb">type</span> <span class="n">Supervisor</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">supervisor_ch</span> <span class="p">:</span> <span class="n">SupervisorReq</span> <span class="n">Ch</span>
    <span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=74">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="new_server">new_server<a class="anchor-link" href="#new_server"></a></h2>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=75">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="o">//</span> <span class="c1">#r @"../../../../../../../.nuget/packages/microsoft.aspnetcore.app.ref/7.0.11/ref/net7.0/Microsoft.AspNetCore.SignalR.Core.dll"</span>
<span class="o">//</span> <span class="c1">#r @"../../../../../../../.nuget/packages/system.management/9.0.0/lib/netstandard2.0/System.Management.dll"</span>
<span class="o">//</span> <span class="c1">#r @"../../../../../../../.nuget/packages/fsharp.control.asyncseq/3.2.1/lib/netstandard2.1/FSharp.Control.AsyncSeq.dll"</span>
<span class="o">//</span> <span class="c1">#r @"../../../../../../../.nuget/packages/system.reactive/6.0.1-preview.1/lib/net6.0/System.Reactive.dll"</span>
<span class="o">//</span> <span class="c1">#r @"../../../../../../../.nuget/packages/system.reactive.linq/6.0.1-preview.1/lib/netstandard2.0/System.Reactive.Linq.dll"</span>
<span class="o">//</span> <span class="c1">#r @"../../../../../../../.nuget/packages/argu/6.2.4/lib/netstandard2.0/Argu.dll"</span>
<span class="c1">#r @"../../../../../../../.nuget/packages/microsoft.aspnetcore.http.connections.common/7.0.0/lib/net7.0/Microsoft.AspNetCore.Http.Connections.Common.dll"</span>
<span class="c1">#r @"../../../../../../../.nuget/packages/microsoft.aspnetcore.http.connections.client/7.0.0/lib/net7.0/Microsoft.AspNetCore.Http.Connections.Client.dll"</span>
<span class="c1">#r @"../../../../../../../.nuget/packages/microsoft.aspnetcore.signalr.common/7.0.0/lib/net7.0/Microsoft.AspNetCore.SignalR.Common.dll"</span>
<span class="c1">#r @"../../../../../../../.nuget/packages/microsoft.aspnetcore.signalr.client/9.0.0/lib/net9.0/Microsoft.AspNetCore.SignalR.Client.dll"</span>
<span class="c1">#r @"../../../../../../../.nuget/packages/microsoft.aspnetcore.signalr.client.core/9.0.0/lib/net9.0/Microsoft.AspNetCore.SignalR.Client.Core.dll"</span>
<span class="c1">#r @"../../../../../../../.nuget/packages/fsharp.json/0.4.1/lib/netstandard2.0/FSharp.Json.dll"</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=76">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1">#r @"../../../../../../../.nuget/packages/system.management/9.0.0/lib/netstandard2.0/System.Management.dll"</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=77">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="o">//</span> <span class="c1">#!import ../../../polyglot/apps/builder/Builder.fs</span>
<span class="o">//</span> <span class="c1">#!import ../../../polyglot/apps/spiral/Supervisor.fs</span>
<span class="c1">#!import ../../../polyglot/lib/fsharp/Testing.dib</span>
<span class="o">//</span> <span class="c1">#!import ../../../polyglot/apps/spiral/Eval.fs</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=78">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1">#if _LINUX</span>
<span class="c1">#r @"../../../../../../../.nuget/packages/microsoft.aspnetcore.app.runtime.linux-x64/9.0.0/runtimes/linux-x64/lib/net9.0/Microsoft.AspNetCore.dll"</span>
<span class="c1">#else</span>
<span class="c1">#r @"../../../../../../../.nuget/packages/microsoft.aspnetcore.app.runtime.win-x64/9.0.0/runtimes/win-x64/lib/net9.0/Microsoft.AspNetCore.dll"</span>
<span class="c1">#endif</span>

<span class="c1">#if _LINUX</span>
<span class="c1">#r @"../../../../../../../.nuget/packages/microsoft.aspnetcore.app.runtime.linux-x64/9.0.0/runtimes/linux-x64/lib/net9.0/Microsoft.AspNetCore.SignalR.dll"</span>
<span class="c1">#else</span>
<span class="c1">#r @"../../../../../../../.nuget/packages/microsoft.aspnetcore.app.runtime.win-x64/9.0.0/runtimes/win-x64/lib/net9.0/Microsoft.AspNetCore.SignalR.dll"</span>
<span class="c1">#endif</span>

<span class="c1">#if _LINUX</span>
<span class="c1">#r @"../../../../../../../.nuget/packages/microsoft.aspnetcore.app.runtime.linux-x64/9.0.0/runtimes/linux-x64/lib/net9.0/Microsoft.AspNetCore.SignalR.Core.dll"</span>
<span class="c1">#else</span>
<span class="c1">#r @"../../../../../../../.nuget/packages/microsoft.aspnetcore.app.runtime.win-x64/9.0.0/runtimes/win-x64/lib/net9.0/Microsoft.AspNetCore.SignalR.Core.dll"</span>
<span class="c1">#endif</span>

<span class="c1">#if _LINUX</span>
<span class="c1">#r @"../../../../../../../.nuget/packages/microsoft.aspnetcore.app.runtime.linux-x64/9.0.0/runtimes/linux-x64/lib/net9.0/Microsoft.AspNetCore.Cors.dll"</span>
<span class="c1">#else</span>
<span class="c1">#r @"../../../../../../../.nuget/packages/microsoft.aspnetcore.app.runtime.win-x64/9.0.0/runtimes/win-x64/lib/net9.0/Microsoft.AspNetCore.Cors.dll"</span>
<span class="c1">#endif</span>

<span class="c1">#if _LINUX</span>
<span class="c1">#r @"../../../../../../../.nuget/packages/microsoft.aspnetcore.app.runtime.linux-x64/9.0.0/runtimes/linux-x64/lib/net9.0/Microsoft.AspNetCore.Http.Abstractions.dll"</span>
<span class="c1">#else</span>
<span class="c1">#r @"../../../../../../../.nuget/packages/microsoft.aspnetcore.app.runtime.win-x64/9.0.0/runtimes/win-x64/lib/net9.0/Microsoft.AspNetCore.Http.Abstractions.dll"</span>
<span class="c1">#endif</span>

<span class="c1">#if _LINUX</span>
<span class="c1">#r @"../../../../../../../.nuget/packages/microsoft.aspnetcore.app.runtime.linux-x64/9.0.0/runtimes/linux-x64/lib/net9.0/Microsoft.AspNetCore.Connections.Abstractions.dll"</span>
<span class="c1">#else</span>
<span class="c1">#r @"../../../../../../../.nuget/packages/microsoft.aspnetcore.app.runtime.win-x64/9.0.0/runtimes/win-x64/lib/net9.0/Microsoft.AspNetCore.Connections.Abstractions.dll"</span>
<span class="c1">#endif</span>

<span class="c1">#if _LINUX</span>
<span class="c1">#r @"../../../../../../../.nuget/packages/microsoft.aspnetcore.app.runtime.linux-x64/9.0.0/runtimes/linux-x64/lib/net9.0/Microsoft.AspNetCore.Hosting.Abstractions.dll"</span>
<span class="c1">#else</span>
<span class="c1">#r @"../../../../../../../.nuget/packages/microsoft.aspnetcore.app.runtime.win-x64/9.0.0/runtimes/win-x64/lib/net9.0/Microsoft.AspNetCore.Hosting.Abstractions.dll"</span>
<span class="c1">#endif</span>

<span class="c1">#if _LINUX</span>
<span class="c1">#r @"../../../../../../../.nuget/packages/microsoft.aspnetcore.app.runtime.linux-x64/9.0.0/runtimes/linux-x64/lib/net9.0/Microsoft.AspNetCore.Http.Connections.dll"</span>
<span class="c1">#else</span>
<span class="c1">#r @"../../../../../../../.nuget/packages/microsoft.aspnetcore.app.runtime.win-x64/9.0.0/runtimes/win-x64/lib/net9.0/Microsoft.AspNetCore.Http.Connections.dll"</span>
<span class="c1">#endif</span>

<span class="c1">#if _LINUX</span>
<span class="c1">#r @"../../../../../../../.nuget/packages/microsoft.aspnetcore.app.runtime.linux-x64/9.0.0/runtimes/linux-x64/lib/net9.0/Microsoft.AspNetCore.Routing.dll"</span>
<span class="c1">#else</span>
<span class="c1">#r @"../../../../../../../.nuget/packages/microsoft.aspnetcore.app.runtime.win-x64/9.0.0/runtimes/win-x64/lib/net9.0/Microsoft.AspNetCore.Routing.dll"</span>
<span class="c1">#endif</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=79">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1">#r @"../../../../../../../.nuget/packages/microsoft.extensions.logging/9.0.0/lib/net9.0/Microsoft.Extensions.Logging.dll"</span>
<span class="c1">#r @"../../../../../../../.nuget/packages/microsoft.extensions.logging.abstractions/9.0.0/lib/net9.0/Microsoft.Extensions.Logging.Abstractions.dll"</span>
<span class="c1">#r @"../../../../../../../.nuget/packages/microsoft.extensions.dependencyinjection.abstractions/9.0.0/lib/net9.0/Microsoft.Extensions.DependencyInjection.Abstractions.dll"</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=80">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="nb">open</span> <span class="n">Hopac</span>
<span class="nb">open</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">Infixes</span>
<span class="o">//</span> <span class="nb">open</span> <span class="n">Common</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=81">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h3 id="new_server">new_server<a class="anchor-link" href="#new_server"></a></h3>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=82">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">let</span> <span class="n">new_server</span> <span class="p">()</span> <span class="o">=</span>
    <span class="n">let</span> <span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="o">&lt;</span><span class="n">ClientErrorsRes</span><span class="o">&gt;</span> <span class="p">()</span>
    <span class="o">//</span> <span class="n">let</span> <span class="n">disposable</span><span class="s1">' = connection.On&lt;string&gt; ("ServerToClientMsg", event.Trigger)</span>
    <span class="n">let</span> <span class="n">stream</span> <span class="o">=</span>
        <span class="n">FSharp</span><span class="o">.</span><span class="n">Control</span><span class="o">.</span><span class="n">AsyncSeq</span><span class="o">.</span><span class="n">unfoldAsync</span>
            <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="k">async</span> <span class="p">{</span>
                <span class="n">let</span><span class="err">!</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">Publish</span> <span class="o">|&gt;</span> <span class="n">Async</span><span class="o">.</span><span class="n">AwaitEvent</span>
                <span class="k">return</span> <span class="n">Some</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="p">())</span>
            <span class="p">})</span>
            <span class="p">()</span>

    <span class="n">let</span> <span class="n">error_ch_create</span> <span class="n">msg</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">Ch</span><span class="p">()</span>
        <span class="n">Hopac</span><span class="o">.</span><span class="n">server</span> <span class="p">(</span><span class="n">Job</span><span class="o">.</span><span class="n">forever</span> <span class="p">(</span><span class="n">Ch</span><span class="o">.</span><span class="n">take</span> <span class="n">x</span> <span class="o">&gt;&gt;=</span> <span class="p">(</span>
            <span class="n">msg</span> <span class="o">&gt;&gt;</span> <span class="n">fun</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">ClientErrorsRes</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="n">Hopac</span><span class="o">.</span><span class="n">Job</span><span class="o">.</span><span class="n">awaitUnitTask</span> <span class="p">(</span>
                    <span class="n">task</span> <span class="p">{</span>
                        <span class="n">event</span><span class="o">.</span><span class="n">Trigger</span> <span class="n">x</span>
                        <span class="n">trace</span> <span class="n">Verbose</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"spiral_compiler.new_server / error_ch_create / x: %A</span><span class="si">{x}</span><span class="s2">"</span><span class="p">)</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="s2">""</span><span class="p">)</span>
                        <span class="p">()</span>
                    <span class="p">}</span>
                    <span class="o">|&gt;</span> <span class="p">(</span><span class="n">fun</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">System</span><span class="o">.</span><span class="n">Threading</span><span class="o">.</span><span class="n">Tasks</span><span class="o">.</span><span class="n">Task</span><span class="o">&lt;</span><span class="n">unit</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="p">:</span><span class="o">&gt;</span> <span class="n">System</span><span class="o">.</span><span class="n">Threading</span><span class="o">.</span><span class="n">Tasks</span><span class="o">.</span><span class="n">Task</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="p">)))</span>
        <span class="n">x</span>

    <span class="n">let</span> <span class="n">errors</span> <span class="p">:</span> <span class="n">SupervisorErrorSources</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">fatal</span> <span class="o">=</span> <span class="n">error_ch_create</span> <span class="n">FatalError</span>
        <span class="n">package</span> <span class="o">=</span> <span class="n">error_ch_create</span> <span class="n">PackageErrors</span>
        <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">error_ch_create</span> <span class="n">TokenizerErrors</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">error_ch_create</span> <span class="n">ParserErrors</span>
        <span class="n">typer</span> <span class="o">=</span> <span class="n">error_ch_create</span> <span class="n">TypeErrors</span>
        <span class="n">traced</span> <span class="o">=</span> <span class="n">error_ch_create</span> <span class="n">TracedError</span>
        <span class="p">}</span>
    <span class="n">let</span> <span class="n">supervisor</span> <span class="o">=</span> <span class="n">Ch</span><span class="p">()</span>
    <span class="n">let</span> <span class="n">atten</span> <span class="o">=</span> <span class="n">Ch</span><span class="p">()</span>

    <span class="n">do</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">server</span> <span class="p">(</span><span class="n">attention_server</span> <span class="n">errors</span> <span class="n">atten</span><span class="p">)</span>

    <span class="n">let</span> <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="o">|</span> <span class="s2">"--port"</span><span class="p">;</span> <span class="s2">"0"</span> <span class="o">|</span><span class="p">]</span>
    <span class="n">let</span> <span class="n">env</span> <span class="o">=</span> <span class="n">parseStartup</span> <span class="n">args</span>
    <span class="n">do</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">start</span> <span class="p">(</span><span class="n">supervisor_server</span> <span class="n">env</span> <span class="n">atten</span> <span class="n">errors</span> <span class="n">supervisor</span><span class="p">)</span>

    <span class="n">let</span> <span class="n">job_null</span> <span class="n">job</span> <span class="o">=</span>
        <span class="n">job</span>
        <span class="o">|&gt;</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">start</span>
        <span class="n">task</span> <span class="p">{</span> <span class="k">return</span> <span class="n">null</span> <span class="p">}</span>
    <span class="n">let</span> <span class="n">serialize</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">obj</span><span class="p">)</span> <span class="o">=</span>
        <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">null</span> <span class="o">-&gt;</span> <span class="n">null</span>
        <span class="o">|</span> <span class="p">:</span><span class="err">?</span> <span class="n">Option</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="k">as</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">.</span><span class="n">Value</span>
        <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">FSharp</span><span class="o">.</span><span class="n">Json</span><span class="o">.</span><span class="n">Json</span><span class="o">.</span><span class="n">serialize</span> <span class="n">x</span>
    <span class="n">let</span> <span class="n">job_val</span> <span class="n">job</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">res</span> <span class="o">=</span> <span class="n">IVar</span><span class="p">()</span>
        <span class="n">let</span> <span class="n">job</span><span class="s1">' =</span>
            <span class="n">job</span> <span class="n">res</span>
        <span class="n">Hopac</span><span class="o">.</span><span class="n">queueAsTask</span> <span class="p">(</span><span class="n">job</span><span class="s1">' &gt;&gt;=. IVar.read res &gt;&gt;- serialize)</span>
    <span class="p">{</span><span class="o">|</span>
        <span class="n">job_null</span> <span class="o">=</span> <span class="n">job_null</span>
        <span class="n">job_val</span> <span class="o">=</span> <span class="n">job_val</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="n">stream</span>
        <span class="n">supervisor</span> <span class="o">=</span> <span class="n">supervisor</span>
    <span class="o">|</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=83">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="o">////</span> <span class="n">test</span>

<span class="n">SpiralTrace</span><span class="o">.</span><span class="n">TraceLevel</span><span class="o">.</span><span class="n">US0_0</span> <span class="o">|&gt;</span> <span class="n">set_trace_level</span>

<span class="n">let</span> <span class="n">server</span> <span class="o">=</span> <span class="n">new_server</span><span class="o">&lt;</span><span class="n">Job</span><span class="o">&lt;</span><span class="n">unit</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">string</span> <span class="n">option</span><span class="p">,</span> <span class="n">Job</span><span class="o">&lt;</span><span class="n">unit</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">unit</span><span class="o">&gt;</span> <span class="p">()</span>
<span class="k">async</span> <span class="p">{</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">let</span> <span class="n">fullPath</span> <span class="o">=</span> <span class="n">Supervisor</span><span class="o">.</span><span class="n">workspaceRoot</span> <span class="o">&lt;/&gt;</span> <span class="s2">"deps/spiral/lib/spiral/package.spiproj"</span>
    <span class="n">let</span> <span class="n">fullPathUri</span> <span class="o">=</span> <span class="n">fullPath</span> <span class="o">|&gt;</span> <span class="n">SpiralFileSystem</span><span class="o">.</span><span class="n">normalize_path</span> <span class="o">|&gt;</span> <span class="n">SpiralFileSystem</span><span class="o">.</span><span class="n">new_file_uri</span>
    <span class="n">let</span><span class="err">!</span> <span class="n">spiprojCode</span> <span class="o">=</span> <span class="n">fullPath</span> <span class="o">|&gt;</span> <span class="n">SpiralFileSystem</span><span class="o">.</span><span class="n">read_all_text_async</span>
    <span class="n">let</span> <span class="n">projectFileOpenArgs</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">fullPathUri</span><span class="p">;</span> <span class="n">spiprojText</span> <span class="o">=</span> <span class="n">spiprojCode</span> <span class="o">|</span><span class="p">}</span>
    <span class="n">let</span><span class="err">!</span> <span class="n">projectFileOpenResult</span> <span class="o">=</span>
        <span class="n">job_null</span> <span class="p">(</span><span class="n">supervisor</span> <span class="o">*&lt;+</span> <span class="n">Supervisor</span><span class="o">.</span><span class="n">SupervisorReq</span><span class="o">.</span><span class="n">ProjectFileOpen</span> <span class="n">projectFileOpenArgs</span><span class="p">)</span>
        <span class="o">|&gt;</span> <span class="n">Async</span><span class="o">.</span><span class="n">AwaitTask</span>
    <span class="n">trace</span> <span class="n">Info</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"Supervisor.ProjectFileOpen / projectFileOpenResult: %A</span><span class="si">{projectFileOpenResult}</span><span class="s2">"</span><span class="p">)</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="s2">""</span><span class="p">)</span>
    <span class="n">do</span><span class="err">!</span> <span class="n">Async</span><span class="o">.</span><span class="n">Sleep</span> <span class="mi">500</span>

    <span class="n">let</span> <span class="n">fullPath</span> <span class="o">=</span> <span class="s2">"C:/home/git/polyglot/target/spiral_Eval/packages/00b4ba49258747d295857ee25629c7b59c75cf4ab06958a0e3b0680ae9062d87/package.spiproj"</span>
    <span class="n">let</span> <span class="n">fullPathUri</span> <span class="o">=</span> <span class="n">fullPath</span> <span class="o">|&gt;</span> <span class="n">SpiralFileSystem</span><span class="o">.</span><span class="n">normalize_path</span> <span class="o">|&gt;</span> <span class="n">SpiralFileSystem</span><span class="o">.</span><span class="n">new_file_uri</span>
    <span class="n">let</span><span class="err">!</span> <span class="n">spiprojCode</span> <span class="o">=</span> <span class="n">fullPath</span> <span class="o">|&gt;</span> <span class="n">SpiralFileSystem</span><span class="o">.</span><span class="n">read_all_text_async</span>
    <span class="n">let</span> <span class="n">projectFileOpenArgs</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">fullPathUri</span><span class="p">;</span> <span class="n">spiprojText</span> <span class="o">=</span> <span class="n">spiprojCode</span> <span class="o">|</span><span class="p">}</span>
    <span class="n">let</span><span class="err">!</span> <span class="n">projectFileOpenResult</span> <span class="o">=</span>
        <span class="n">job_null</span> <span class="p">(</span><span class="n">supervisor</span> <span class="o">*&lt;+</span> <span class="n">Supervisor</span><span class="o">.</span><span class="n">SupervisorReq</span><span class="o">.</span><span class="n">ProjectFileOpen</span> <span class="n">projectFileOpenArgs</span><span class="p">)</span>
        <span class="o">|&gt;</span> <span class="n">Async</span><span class="o">.</span><span class="n">AwaitTask</span>
    <span class="n">trace</span> <span class="n">Info</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"Supervisor.ProjectFileOpen / projectFileOpenResult: %A</span><span class="si">{projectFileOpenResult}</span><span class="s2">"</span><span class="p">)</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="s2">""</span><span class="p">)</span>
    <span class="n">do</span><span class="err">!</span> <span class="n">Async</span><span class="o">.</span><span class="n">Sleep</span> <span class="mi">500</span>
<span class="o">*</span><span class="p">)</span>
    <span class="n">let</span> <span class="n">code</span> <span class="o">=</span> <span class="s2">"inl main () = 1i32 + 1"</span>
    <span class="n">let</span> <span class="n">struct</span> <span class="p">(</span><span class="n">fullPath</span><span class="p">,</span> <span class="n">disposable</span><span class="p">)</span> <span class="o">=</span> <span class="n">SpiralFileSystem</span><span class="o">.</span><span class="n">create_temp_dir</span> <span class="p">()</span>
    <span class="n">use</span> <span class="n">_</span> <span class="o">=</span> <span class="n">disposable</span>
    <span class="n">let</span> <span class="n">fullPathSpi</span> <span class="o">=</span> <span class="n">fullPath</span> <span class="o">&lt;/&gt;</span> <span class="s2">"main.spi"</span>
    <span class="n">do</span><span class="err">!</span> <span class="n">code</span> <span class="o">|&gt;</span> <span class="n">SpiralFileSystem</span><span class="o">.</span><span class="n">write_all_text_async</span> <span class="n">fullPathSpi</span>
    <span class="n">let</span> <span class="n">fullPathSpiproj</span> <span class="o">=</span> <span class="n">fullPath</span> <span class="o">&lt;/&gt;</span> <span class="s2">"package.spiproj"</span>
    <span class="n">do</span><span class="err">!</span> <span class="s2">"packages:</span><span class="se">\n</span><span class="s2"> |core-</span><span class="se">\n</span><span class="s2">modules:</span><span class="se">\n</span><span class="s2"> main</span><span class="se">\n</span><span class="s2">"</span> <span class="o">|&gt;</span> <span class="n">SpiralFileSystem</span><span class="o">.</span><span class="n">write_all_text_async</span> <span class="n">fullPathSpiproj</span>
    <span class="o">//</span> <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">code</span> <span class="o">|&gt;</span> <span class="n">Supervisor</span><span class="o">.</span><span class="n">persistCode</span>
    <span class="n">let</span> <span class="n">fullPathUri</span> <span class="o">=</span> <span class="n">fullPathSpi</span> <span class="o">|&gt;</span> <span class="n">SpiralFileSystem</span><span class="o">.</span><span class="n">normalize_path</span> <span class="o">|&gt;</span> <span class="n">SpiralFileSystem</span><span class="o">.</span><span class="n">new_file_uri</span>
    <span class="o">//</span> <span class="n">let</span><span class="err">!</span> <span class="n">code</span> <span class="o">=</span> <span class="n">fullPath</span> <span class="o">|&gt;</span> <span class="n">SpiralFileSystem</span><span class="o">.</span><span class="n">read_all_text_async</span>
    <span class="n">let</span> <span class="n">fileOpenArgs</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">fullPathUri</span><span class="p">;</span> <span class="n">spiText</span> <span class="o">=</span> <span class="n">code</span> <span class="o">|</span><span class="p">}</span>
    <span class="n">let</span><span class="err">!</span> <span class="n">fileOpenResult</span> <span class="o">=</span>
        <span class="n">server</span><span class="o">.</span><span class="n">job_null</span> <span class="p">(</span><span class="n">server</span><span class="o">.</span><span class="n">supervisor</span> <span class="o">*&lt;+</span> <span class="n">SupervisorReq</span><span class="o">.</span><span class="n">FileOpen</span> <span class="n">fileOpenArgs</span><span class="p">)</span>
        <span class="o">|&gt;</span> <span class="n">Async</span><span class="o">.</span><span class="n">AwaitTask</span>
        <span class="o">|&gt;</span> <span class="n">Async</span><span class="o">.</span><span class="n">runWithTimeoutAsync</span> <span class="mi">20000</span>
        <span class="o">|&gt;</span> <span class="n">Async</span><span class="o">.</span><span class="n">map</span> <span class="n">Option</span><span class="o">.</span><span class="n">get</span>
    <span class="n">trace</span> <span class="n">Info</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"spiral_compiler.run / FileOpen / fileOpenResult: %A</span><span class="si">{fileOpenResult}</span><span class="s2">"</span><span class="p">)</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="s2">""</span><span class="p">)</span>

<span class="o">//</span>    <span class="n">do</span><span class="err">!</span> <span class="n">Async</span><span class="o">.</span><span class="n">Sleep</span> <span class="mi">500</span>

    <span class="n">let</span> <span class="n">backendId</span> <span class="o">=</span> <span class="s2">"Fsharp"</span>
    <span class="n">let</span> <span class="n">buildFileArgs</span> <span class="o">=</span> <span class="p">{</span><span class="o">|</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">fullPathUri</span><span class="p">;</span> <span class="n">backend</span> <span class="o">=</span> <span class="n">backendId</span> <span class="o">|</span><span class="p">}</span>
    <span class="n">let</span><span class="err">!</span> <span class="n">buildFileResult</span> <span class="o">=</span>
        <span class="n">server</span><span class="o">.</span><span class="n">job_val</span> <span class="p">(</span><span class="n">fun</span> <span class="n">res</span> <span class="o">-&gt;</span> <span class="n">server</span><span class="o">.</span><span class="n">supervisor</span> <span class="o">*&lt;+</span> <span class="n">SupervisorReq</span><span class="o">.</span><span class="n">BuildFile</span><span class="p">(</span><span class="n">buildFileArgs</span><span class="p">,</span><span class="n">res</span><span class="p">))</span>
        <span class="o">|&gt;</span> <span class="n">Async</span><span class="o">.</span><span class="n">AwaitTask</span>
        <span class="o">|&gt;</span> <span class="n">Async</span><span class="o">.</span><span class="n">runWithTimeoutAsync</span> <span class="mi">15000</span>
        <span class="o">|&gt;</span> <span class="n">Async</span><span class="o">.</span><span class="n">map</span> <span class="n">Option</span><span class="o">.</span><span class="n">get</span>
    <span class="n">trace</span> <span class="n">Info</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"spiral_compiler.run / BuildFile / buildFileResult: %A</span><span class="si">{buildFileResult}</span><span class="s2">"</span><span class="p">)</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="s2">""</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">buildFileResult</span>


    <span class="p">(</span><span class="o">*</span>
    <span class="n">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">code</span> <span class="o">|&gt;</span> <span class="n">SpiralSm</span><span class="o">.</span><span class="n">split</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
    <span class="n">let</span> <span class="n">fileTokenRangeArgs</span> <span class="o">=</span>
        <span class="p">{</span><span class="o">|</span>
            <span class="n">uri</span> <span class="o">=</span> <span class="n">fullPathUri</span>
            <span class="nb">range</span> <span class="o">=</span>
                <span class="p">{</span><span class="o">|</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">character</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="o">|</span><span class="p">},</span>
                <span class="p">{</span><span class="o">|</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">Length</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">character</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="p">[</span><span class="n">lines</span><span class="o">.</span><span class="n">Length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Length</span>
                <span class="o">|</span><span class="p">}</span>
        <span class="o">|</span><span class="p">}</span>
    <span class="n">let</span><span class="err">!</span> <span class="n">fileTokenRangeResult</span> <span class="o">=</span>
        <span class="n">job_val</span> <span class="p">(</span><span class="n">fun</span> <span class="n">res</span> <span class="o">-&gt;</span> <span class="n">supervisor</span> <span class="o">*&lt;+</span> <span class="n">Supervisor</span><span class="o">.</span><span class="n">SupervisorReq</span><span class="o">.</span><span class="n">FileTokenRange</span><span class="p">(</span><span class="n">fileTokenRangeArgs</span><span class="p">,</span><span class="n">res</span><span class="p">))</span>
        <span class="o">|&gt;</span> <span class="n">Async</span><span class="o">.</span><span class="n">AwaitTask</span>
    <span class="n">trace</span> <span class="n">Info</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"Supervisor.FileTokenRange / fileTokenRangeResult: %A</span><span class="si">{fileTokenRangeResult.Length}</span><span class="s2">"</span><span class="p">)</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="s2">""</span><span class="p">)</span>
    <span class="o">*</span><span class="p">)</span>
<span class="p">}</span>
<span class="o">|&gt;</span> <span class="n">Async</span><span class="o">.</span><span class="n">runWithTimeout</span> <span class="mi">10000</span>
<span class="o">|&gt;</span> <span class="n">Option</span><span class="o">.</span><span class="n">map</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">SpiralSm</span><span class="o">.</span><span class="n">replace</span> <span class="s2">"</span><span class="se">\r\n</span><span class="s2">"</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
<span class="o">|&gt;</span> <span class="n">_assertEqual</span> <span class="p">(</span><span class="n">Some</span> <span class="s2">"2</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain" tabindex="0">
<pre>00:01:27 <span class="ansi-green-intense-fg">i</span> #1 spiral_compiler.run / FileOpen / fileOpenResult: &lt;null&gt;
00:01:28 <span class="ansi-green-intense-fg">i</span> #320 spiral_compiler.run / BuildFile / buildFileResult: "2
"
Some "2
"

</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=84">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="getParentProcessId">getParentProcessId<a class="anchor-link" href="#getParentProcessId"></a></h2>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=85">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">let</span> <span class="n">getParentProcessId</span> <span class="p">()</span> <span class="o">=</span>
    <span class="k">if</span> <span class="n">SpiralPlatform</span><span class="o">.</span><span class="n">is_windows</span> <span class="p">()</span> <span class="o">|&gt;</span> <span class="ow">not</span>
    <span class="n">then</span> <span class="mi">0</span><span class="n">u</span>
    <span class="k">else</span>
        <span class="n">let</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Diagnostics</span><span class="o">.</span><span class="n">Process</span><span class="o">.</span><span class="n">GetCurrentProcess</span><span class="p">()</span><span class="o">.</span><span class="n">Id</span>
        <span class="n">let</span> <span class="n">query</span> <span class="o">=</span> <span class="err">$</span><span class="s2">"SELECT ParentProcessId FROM Win32_Process WHERE ProcessId = </span><span class="si">{pid}</span><span class="s2">"</span>
        <span class="n">use</span> <span class="n">searcher</span> <span class="o">=</span> <span class="n">new</span> <span class="n">System</span><span class="o">.</span><span class="n">Management</span><span class="o">.</span><span class="n">ManagementObjectSearcher</span> <span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">use</span> <span class="n">results</span> <span class="o">=</span> <span class="n">searcher</span><span class="o">.</span><span class="n">Get</span> <span class="p">()</span>
        <span class="n">let</span> <span class="n">data</span> <span class="o">=</span> <span class="n">results</span> <span class="o">|&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">System</span><span class="o">.</span><span class="n">Management</span><span class="o">.</span><span class="n">ManagementObject</span><span class="o">&gt;</span>
        <span class="k">if</span> <span class="n">data</span> <span class="o">|&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">isEmpty</span>
        <span class="n">then</span> <span class="mi">0</span><span class="n">u</span>
        <span class="k">else</span> <span class="n">data</span> <span class="o">|&gt;</span> <span class="n">Seq</span><span class="o">.</span><span class="n">head</span> <span class="o">|&gt;</span> <span class="p">(</span><span class="n">fun</span> <span class="n">mo</span> <span class="o">-&gt;</span> <span class="n">mo</span><span class="o">.</span><span class="p">[</span><span class="s2">"ParentProcessId"</span><span class="p">]</span> <span class="p">:</span><span class="err">?</span><span class="o">&gt;</span> <span class="n">uint32</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=86">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="assemblyName">assemblyName<a class="anchor-link" href="#assemblyName"></a></h2>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=87">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">let</span> <span class="n">assemblyName</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Reflection</span><span class="o">.</span><span class="n">Assembly</span><span class="o">.</span><span class="n">GetEntryAssembly</span><span class="p">()</span><span class="o">.</span><span class="n">GetName</span><span class="p">()</span><span class="o">.</span><span class="n">Name</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=88">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="startParentWatcher">startParentWatcher<a class="anchor-link" href="#startParentWatcher"></a></h2>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=89">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">let</span> <span class="n">inline</span> <span class="n">startParentWatcher</span> <span class="p">()</span> <span class="o">=</span>
    <span class="k">if</span> <span class="p">[</span> <span class="s2">"dotnet-repl"</span> <span class="p">]</span> <span class="o">|&gt;</span> <span class="n">List</span><span class="o">.</span><span class="n">contains</span> <span class="n">assemblyName</span> <span class="o">|&gt;</span> <span class="ow">not</span> <span class="n">then</span>
        <span class="n">let</span> <span class="n">parentAsyncChild</span> <span class="o">=</span> <span class="k">async</span> <span class="p">{</span>
            <span class="n">let</span> <span class="n">parentProcessId</span> <span class="o">=</span> <span class="n">getParentProcessId</span> <span class="p">()</span>
            <span class="n">trace</span> <span class="n">Verbose</span>
                <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="s2">"spiral_compiler.startParentWatcher"</span><span class="p">)</span>
                <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"parentProcessId: </span><span class="si">{parentProcessId}</span><span class="s2"> / {_locals ()}"</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">parentProcessId</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="n">u</span> <span class="n">then</span>
                <span class="n">let</span> <span class="n">parentProcess</span> <span class="o">=</span> <span class="n">parentProcessId</span> <span class="o">|&gt;</span> <span class="nb">int</span> <span class="o">|&gt;</span> <span class="n">System</span><span class="o">.</span><span class="n">Diagnostics</span><span class="o">.</span><span class="n">Process</span><span class="o">.</span><span class="n">GetProcessById</span>
                <span class="n">do</span><span class="err">!</span> <span class="n">parentProcess</span><span class="o">.</span><span class="n">WaitForExitAsync</span> <span class="p">()</span> <span class="o">|&gt;</span> <span class="n">Async</span><span class="o">.</span><span class="n">AwaitTask</span>
                <span class="n">trace</span> <span class="n">Debug</span>
                    <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="s2">"spiral_compiler.startParentWatcher / Parent process has exited. Performing cleanup..."</span><span class="p">)</span>
                    <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"{_locals ()}"</span><span class="p">)</span>
                <span class="n">System</span><span class="o">.</span><span class="n">Threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="n">Sleep</span> <span class="mi">1000</span>
                <span class="n">System</span><span class="o">.</span><span class="n">Environment</span><span class="o">.</span><span class="n">Exit</span> <span class="mi">1</span>
        <span class="p">}</span>

        <span class="n">parentAsyncChild</span> <span class="o">|&gt;</span> <span class="n">Async</span><span class="o">.</span><span class="n">Start</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=90">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
<h2 id="SpiralHub">SpiralHub<a class="anchor-link" href="#SpiralHub"></a></h2>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=91">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="o">//</span> <span class="nb">open</span> <span class="n">System</span>
<span class="nb">open</span> <span class="n">System</span><span class="o">.</span><span class="n">IO</span>
<span class="nb">open</span> <span class="n">System</span><span class="o">.</span><span class="n">Collections</span><span class="o">.</span><span class="n">Generic</span>

<span class="nb">open</span> <span class="n">Hopac</span>
<span class="nb">open</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">Infixes</span>
<span class="nb">open</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">Extensions</span>
<span class="nb">open</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">Stream</span>

<span class="o">//</span> <span class="nb">open</span> <span class="n">Common</span>
<span class="nb">open</span> <span class="n">SpiralFileSystem</span><span class="o">.</span><span class="n">Operators</span>

<span class="nb">open</span> <span class="n">FSharp</span><span class="o">.</span><span class="n">Json</span>
<span class="nb">open</span> <span class="n">Microsoft</span><span class="o">.</span><span class="n">AspNetCore</span><span class="o">.</span><span class="n">SignalR</span>
<span class="nb">open</span> <span class="n">Microsoft</span><span class="o">.</span><span class="n">AspNetCore</span><span class="o">.</span><span class="n">SignalR</span><span class="o">.</span><span class="n">Client</span>

<span class="nb">type</span> <span class="n">SpiralHub</span><span class="p">(</span><span class="n">supervisor</span> <span class="p">:</span> <span class="n">Supervisor</span><span class="p">)</span> <span class="o">=</span>
    <span class="n">inherit</span> <span class="n">Hub</span><span class="p">()</span>

    <span class="n">member</span> <span class="n">_</span><span class="o">.</span><span class="n">ClientToServerMsg</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">string</span><span class="p">)</span> <span class="o">=</span>
        <span class="n">let</span> <span class="n">job_null</span> <span class="n">job</span> <span class="o">=</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">start</span> <span class="n">job</span><span class="p">;</span> <span class="n">task</span> <span class="p">{</span> <span class="k">return</span> <span class="n">null</span> <span class="p">}</span>

        <span class="n">let</span> <span class="n">serialize</span> <span class="p">(</span><span class="n">x</span> <span class="p">:</span> <span class="n">obj</span><span class="p">)</span> <span class="o">=</span>
            <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">null</span> <span class="o">-&gt;</span> <span class="n">null</span>
            <span class="o">|</span> <span class="p">:</span><span class="err">?</span> <span class="n">Option</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="k">as</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">.</span><span class="n">Value</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">Json</span><span class="o">.</span><span class="n">serialize</span> <span class="n">x</span>

        <span class="n">let</span> <span class="n">job_val</span> <span class="n">job</span> <span class="o">=</span> <span class="n">let</span> <span class="n">res</span> <span class="o">=</span> <span class="n">IVar</span><span class="p">()</span> <span class="ow">in</span> <span class="n">Hopac</span><span class="o">.</span><span class="n">queueAsTask</span> <span class="p">(</span><span class="n">job</span> <span class="n">res</span> <span class="o">&gt;&gt;=.</span> <span class="n">IVar</span><span class="o">.</span><span class="n">read</span> <span class="n">res</span> <span class="o">&gt;&gt;-</span> <span class="n">serialize</span><span class="p">)</span>
        <span class="n">let</span> <span class="n">supervisor</span> <span class="o">=</span> <span class="n">supervisor</span><span class="o">.</span><span class="n">supervisor_ch</span>

        <span class="n">let</span> <span class="n">client_req</span> <span class="o">=</span> <span class="n">Json</span><span class="o">.</span><span class="n">deserialize</span> <span class="n">x</span>

        <span class="k">if</span> <span class="n">Directory</span><span class="o">.</span><span class="n">Exists</span> <span class="n">traceDir</span> <span class="n">then</span>
            <span class="k">match</span> <span class="n">client_req</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">Ping</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="p">()</span>
            <span class="o">|</span> <span class="n">_</span> <span class="o">-&gt;</span>
                <span class="n">let</span> <span class="n">req_name</span> <span class="o">=</span> <span class="n">client_req</span><span class="o">.</span><span class="n">GetType</span><span class="p">()</span><span class="o">.</span><span class="n">Name</span>
                <span class="n">let</span> <span class="n">guid</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">DateTime</span><span class="o">.</span><span class="n">Now</span> <span class="o">|&gt;</span> <span class="n">SpiralDateTime</span><span class="o">.</span><span class="n">new_guid_from_date_time</span>
                <span class="n">let</span> <span class="n">trace_file</span> <span class="o">=</span> <span class="n">traceDir</span> <span class="o">&lt;/&gt;</span> <span class="err">$</span><span class="s2">"</span><span class="si">{guid}</span><span class="s2">_</span><span class="si">{req_name}</span><span class="s2">.json"</span>
                
                <span class="k">async</span> <span class="p">{</span>
                    <span class="n">do</span><span class="err">!</span> <span class="n">Async</span><span class="o">.</span><span class="n">Sleep</span> <span class="mi">500</span>
                    <span class="k">try</span>
                        <span class="n">do</span><span class="err">!</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">SpiralFileSystem</span><span class="o">.</span><span class="n">write_all_text_async</span> <span class="n">trace_file</span>
                    <span class="k">with</span> <span class="n">ex</span> <span class="o">-&gt;</span>
                        <span class="n">trace</span> <span class="n">Critical</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"SpiralHub.ClientToServerMsg / ex: {ex |&gt; SpiralSm.format_exception}"</span><span class="p">)</span> <span class="n">_locals</span>
                <span class="p">}</span>
                <span class="o">|&gt;</span> <span class="n">Async</span><span class="o">.</span><span class="n">Start</span>

        <span class="k">match</span> <span class="n">client_req</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">ProjectFileOpen</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">job_null</span> <span class="p">(</span><span class="n">supervisor</span> <span class="o">*&lt;+</span> <span class="n">SupervisorReq</span><span class="o">.</span><span class="n">ProjectFileOpen</span> <span class="n">x</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">ProjectFileChange</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">job_null</span> <span class="p">(</span><span class="n">supervisor</span> <span class="o">*&lt;+</span> <span class="n">SupervisorReq</span><span class="o">.</span><span class="n">ProjectFileChange</span> <span class="n">x</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">ProjectCodeActionExecute</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">job_val</span> <span class="p">(</span><span class="n">fun</span> <span class="n">res</span> <span class="o">-&gt;</span> <span class="n">supervisor</span> <span class="o">*&lt;+</span> <span class="n">SupervisorReq</span><span class="o">.</span><span class="n">ProjectCodeActionExecute</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">res</span><span class="p">))</span>
        <span class="o">|</span> <span class="n">ProjectFileLinks</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">job_val</span> <span class="p">(</span><span class="n">fun</span> <span class="n">res</span> <span class="o">-&gt;</span> <span class="n">supervisor</span> <span class="o">*&lt;+</span> <span class="n">SupervisorReq</span><span class="o">.</span><span class="n">ProjectFileLinks</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">res</span><span class="p">))</span>
        <span class="o">|</span> <span class="n">ProjectCodeActions</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">job_val</span> <span class="p">(</span><span class="n">fun</span> <span class="n">res</span> <span class="o">-&gt;</span> <span class="n">supervisor</span> <span class="o">*&lt;+</span> <span class="n">SupervisorReq</span><span class="o">.</span><span class="n">ProjectCodeActions</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">res</span><span class="p">))</span>
        <span class="o">|</span> <span class="n">FileOpen</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">job_null</span> <span class="p">(</span><span class="n">supervisor</span> <span class="o">*&lt;+</span> <span class="n">SupervisorReq</span><span class="o">.</span><span class="n">FileOpen</span> <span class="n">x</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">FileChange</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">job_null</span> <span class="p">(</span><span class="n">supervisor</span> <span class="o">*&lt;+</span> <span class="n">SupervisorReq</span><span class="o">.</span><span class="n">FileChange</span> <span class="n">x</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">FileDelete</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">job_null</span> <span class="p">(</span><span class="n">supervisor</span> <span class="o">*&lt;+</span> <span class="n">SupervisorReq</span><span class="o">.</span><span class="n">FileDelete</span> <span class="n">x</span><span class="p">)</span>
        <span class="o">|</span> <span class="n">FileTokenRange</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">job_val</span> <span class="p">(</span><span class="n">fun</span> <span class="n">res</span> <span class="o">-&gt;</span> <span class="n">supervisor</span> <span class="o">*&lt;+</span> <span class="n">SupervisorReq</span><span class="o">.</span><span class="n">FileTokenRange</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">res</span><span class="p">))</span>
        <span class="o">|</span> <span class="n">HoverAt</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">job_val</span> <span class="p">(</span><span class="n">fun</span> <span class="n">res</span> <span class="o">-&gt;</span> <span class="n">supervisor</span> <span class="o">*&lt;+</span> <span class="n">SupervisorReq</span><span class="o">.</span><span class="n">HoverAt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">res</span><span class="p">))</span>
        <span class="o">|</span> <span class="n">BuildFile</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">job_val</span> <span class="p">(</span><span class="n">fun</span> <span class="n">res</span> <span class="o">-&gt;</span> <span class="n">supervisor</span> <span class="o">*&lt;+</span> <span class="n">SupervisorReq</span><span class="o">.</span><span class="n">BuildFile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">res</span><span class="p">))</span>
        <span class="o">|</span> <span class="n">Ping</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">task</span> <span class="p">{</span> <span class="k">return</span> <span class="n">null</span> <span class="p">}</span>
        <span class="o">|</span> <span class="n">Exit</span> <span class="n">_</span> <span class="o">-&gt;</span>
            <span class="k">async</span> <span class="p">{</span>
                <span class="n">trace</span> <span class="n">Debug</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="s2">"Supervisor.SpiralHub.ClientToServerMsg / exiting..."</span><span class="p">)</span> <span class="n">_locals</span>
                <span class="k">async</span> <span class="p">{</span>
                    <span class="n">do</span><span class="err">!</span> <span class="n">Async</span><span class="o">.</span><span class="n">Sleep</span> <span class="mi">300</span>
                    <span class="n">System</span><span class="o">.</span><span class="n">Diagnostics</span><span class="o">.</span><span class="n">Process</span><span class="o">.</span><span class="n">GetCurrentProcess</span><span class="p">()</span><span class="o">.</span><span class="n">Kill</span> <span class="p">()</span>
                <span class="p">}</span>
                <span class="o">|&gt;</span> <span class="n">Async</span><span class="o">.</span><span class="n">Start</span>
                <span class="k">return</span> <span class="n">null</span>
            <span class="p">}</span>
            <span class="o">|&gt;</span> <span class="n">Async</span><span class="o">.</span><span class="n">StartAsTask</span>

<span class="nb">open</span> <span class="n">Microsoft</span><span class="o">.</span><span class="n">AspNetCore</span><span class="o">.</span><span class="n">Builder</span>
<span class="nb">open</span> <span class="n">Microsoft</span><span class="o">.</span><span class="n">AspNetCore</span><span class="o">.</span><span class="n">Hosting</span>
<span class="nb">open</span> <span class="n">Microsoft</span><span class="o">.</span><span class="n">Extensions</span><span class="o">.</span><span class="n">DependencyInjection</span>
<span class="nb">open</span> <span class="n">Microsoft</span><span class="o">.</span><span class="n">Extensions</span><span class="o">.</span><span class="n">Logging</span>

<span class="n">let</span> <span class="n">main</span> <span class="n">args</span> <span class="o">=</span>
    <span class="n">SpiralTrace</span><span class="o">.</span><span class="n">TraceLevel</span><span class="o">.</span><span class="n">US0_1</span> <span class="o">|&gt;</span> <span class="n">set_trace_level</span>
    <span class="o">//</span> <span class="n">Scheduler</span><span class="o">.</span><span class="n">Global</span><span class="o">.</span><span class="n">setCreate</span> <span class="p">{</span> <span class="n">Scheduler</span><span class="o">.</span><span class="n">Create</span><span class="o">.</span><span class="n">Def</span> <span class="k">with</span> <span class="n">MaxStackSize</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">8192</span> <span class="o">|&gt;</span> <span class="n">Some</span> <span class="p">}</span>

    <span class="n">let</span> <span class="n">env</span> <span class="o">=</span> <span class="n">parseStartup</span> <span class="n">args</span>

    <span class="n">let</span> <span class="n">uri_server</span> <span class="o">=</span> <span class="err">$</span><span class="s2">"http://localhost:</span><span class="si">{env.port}</span><span class="s2">"</span>

    <span class="n">printfn</span> <span class="s2">"Server bound to: </span><span class="si">%s</span><span class="s2">"</span> <span class="n">uri_server</span>
    <span class="n">trace</span> <span class="n">Debug</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"pwd: </span><span class="si">{System.Environment.CurrentDirectory}</span><span class="s2">"</span><span class="p">)</span> <span class="n">_locals</span>
    <span class="n">let</span> <span class="n">dllPath</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Reflection</span><span class="o">.</span><span class="n">Assembly</span><span class="o">.</span><span class="n">GetExecutingAssembly</span><span class="p">()</span><span class="o">.</span><span class="n">Location</span> <span class="o">|&gt;</span> <span class="n">System</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">Path</span><span class="o">.</span><span class="n">GetDirectoryName</span>
    <span class="n">trace</span> <span class="n">Debug</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"dllPath: </span><span class="si">{dllPath}</span><span class="s2">"</span><span class="p">)</span> <span class="n">_locals</span>
    <span class="n">trace</span> <span class="n">Debug</span> <span class="p">(</span><span class="n">fun</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="err">$</span><span class="s2">"targetDir: </span><span class="si">{targetDir}</span><span class="s2">"</span><span class="p">)</span> <span class="n">_locals</span>
    <span class="n">let</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">Microsoft</span><span class="o">.</span><span class="n">AspNetCore</span><span class="o">.</span><span class="n">Builder</span><span class="o">.</span><span class="n">WebApplication</span><span class="o">.</span><span class="n">CreateBuilder</span><span class="p">()</span>
    <span class="n">builder</span><span class="o">.</span><span class="n">Logging</span><span class="o">.</span><span class="n">SetMinimumLevel</span> <span class="n">LogLevel</span><span class="o">.</span><span class="n">Warning</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
    <span class="n">builder</span><span class="o">.</span><span class="n">Services</span>
        <span class="o">.</span><span class="n">AddCors</span><span class="p">()</span>
        <span class="o">.</span><span class="n">AddSignalR</span><span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> 
            <span class="n">x</span><span class="o">.</span><span class="n">MaximumReceiveMessageSize</span> <span class="o">&lt;-</span> <span class="mi">1</span> <span class="o">&lt;&lt;&lt;</span> <span class="mi">20</span> <span class="o">//</span> <span class="mi">1</span><span class="n">mb</span>
            <span class="n">x</span><span class="o">.</span><span class="n">EnableDetailedErrors</span> <span class="o">&lt;-</span> <span class="n">true</span>
            <span class="p">)</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
        
    <span class="n">builder</span><span class="o">.</span><span class="n">Services</span>
        <span class="o">.</span><span class="n">AddSingleton</span><span class="o">&lt;</span><span class="n">Supervisor</span><span class="o">&gt;</span><span class="p">(</span><span class="n">fun</span> <span class="n">s</span> <span class="o">-&gt;</span>
            <span class="n">let</span> <span class="n">hub</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">GetService</span><span class="o">&lt;</span><span class="n">IHubContext</span><span class="o">&lt;</span><span class="n">SpiralHub</span><span class="o">&gt;&gt;</span><span class="p">()</span>
            <span class="n">let</span> <span class="n">broadcast</span> <span class="n">x</span> <span class="o">=</span> <span class="n">hub</span><span class="o">.</span><span class="n">Clients</span><span class="o">.</span><span class="n">All</span><span class="o">.</span><span class="n">SendCoreAsync</span><span class="p">(</span><span class="s2">"ServerToClientMsg"</span><span class="p">,[</span><span class="o">|</span><span class="n">Json</span><span class="o">.</span><span class="n">serialize</span> <span class="n">x</span><span class="o">|</span><span class="p">])</span>
            
            <span class="n">let</span> <span class="n">server</span> <span class="o">=</span> <span class="n">new_server</span> <span class="p">()</span>

            <span class="n">server</span><span class="o">.</span><span class="n">errors</span>
            <span class="o">|&gt;</span> <span class="n">FSharp</span><span class="o">.</span><span class="n">Control</span><span class="o">.</span><span class="n">AsyncSeq</span><span class="o">.</span><span class="n">mapAsync</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span>
                <span class="n">broadcast</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">Async</span><span class="o">.</span><span class="n">AwaitTask</span>
            <span class="p">)</span>
            <span class="o">|&gt;</span> <span class="n">FSharp</span><span class="o">.</span><span class="n">Control</span><span class="o">.</span><span class="n">AsyncSeq</span><span class="o">.</span><span class="n">iterAsyncParallel</span> <span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="k">async</span> <span class="p">{</span> <span class="p">()</span> <span class="p">})</span>
            <span class="o">|&gt;</span> <span class="n">Async</span><span class="o">.</span><span class="n">StartChild</span>
            <span class="o">|&gt;</span> <span class="n">Async</span><span class="o">.</span><span class="n">RunSynchronously</span>
            <span class="o">|&gt;</span> <span class="n">ignore</span>

            <span class="p">{</span><span class="n">supervisor_ch</span><span class="o">=</span><span class="n">server</span><span class="o">.</span><span class="n">supervisor</span><span class="p">}</span>
            <span class="p">)</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
    <span class="n">builder</span><span class="o">.</span><span class="n">WebHost</span><span class="o">.</span><span class="n">UseUrls</span> <span class="p">[</span><span class="o">|</span><span class="n">uri_server</span><span class="o">|</span><span class="p">]</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
    <span class="n">builder</span><span class="o">.</span><span class="n">Logging</span><span class="o">.</span><span class="n">SetMinimumLevel</span><span class="p">(</span><span class="n">LogLevel</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">ignore</span>

    <span class="n">let</span> <span class="n">app</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">Build</span><span class="p">()</span>
    <span class="n">app</span><span class="o">.</span><span class="n">UseCors</span><span class="p">(</span><span class="n">fun</span> <span class="n">x</span> <span class="o">-&gt;</span>
        <span class="n">x</span><span class="o">.</span><span class="n">SetIsOriginAllowed</span><span class="p">(</span><span class="n">fun</span> <span class="n">_</span> <span class="o">-&gt;</span> <span class="n">true</span><span class="p">)</span>
            <span class="o">.</span><span class="n">AllowAnyHeader</span><span class="p">()</span>
            <span class="o">.</span><span class="n">AllowAnyMethod</span><span class="p">()</span>
            <span class="o">.</span><span class="n">AllowCredentials</span><span class="p">()</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
        <span class="p">)</span> <span class="o">|&gt;</span> <span class="n">ignore</span>
    <span class="n">app</span><span class="o">.</span><span class="n">MapHub</span><span class="o">&lt;</span><span class="n">SpiralHub</span><span class="o">&gt;</span> <span class="s2">""</span> <span class="o">|&gt;</span> <span class="n">ignore</span>

    <span class="o">//</span> <span class="n">use</span> <span class="n">_</span> <span class="o">=</span> <span class="n">Eval</span><span class="o">.</span><span class="n">startTokenRangeWatcher</span> <span class="p">()</span>
    <span class="n">startParentWatcher</span> <span class="p">()</span>
    <span class="o">//</span> <span class="n">use</span> <span class="n">_</span> <span class="o">=</span> <span class="n">Eval</span><span class="o">.</span><span class="n">startCommandsWatcher</span> <span class="n">uri_server</span>

    <span class="n">printfn</span> <span class="err">$</span><span class="s2">"Starting the Spiral Server. It is bound to: </span><span class="si">{uri_server}</span><span class="s2">"</span>
    <span class="n">app</span><span class="o">.</span><span class="n">Run</span><span class="p">()</span>
    <span class="mi">0</span>
</pre></div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=92">
<div class="jp-Cell-inputWrapper" tabindex="0">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In[]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="o">////</span> <span class="n">test</span>

<span class="o">//</span> <span class="n">SpiralHub</span><span class="o">.</span><span class="n">main</span> <span class="p">[</span><span class="o">|</span><span class="s2">"--port"</span><span class="p">;</span> <span class="s2">"13805"</span><span class="o">|</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
</main>
</body>
</html>

